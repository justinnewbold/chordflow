<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v10.2 - Full Band Mode + AI</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 180px);
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-badge { font-size: 10px; background: var(--success); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
        .ai-badge { font-size: 10px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 4px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        
        .band-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            margin: 16px 20px;
            gap: 4px;
        }
        .band-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .band-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        .ai-actions {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .ai-btn:hover, .ai-btn:active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(236, 72, 153, 0.4));
            transform: scale(0.98);
        }
        .ai-btn.loading { opacity: 0.7; pointer-events: none; }
        .ai-btn .sparkle { font-size: 16px; }
        
        .instrument-section { padding: 0 20px; margin-bottom: 20px; }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .dot { width: 8px; height: 8px; border-radius: 50%; }
        
        .instrument-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none;
        }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card {
            min-width: 100px;
            padding: 14px 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-card.active {
            border-color: var(--accent);
            background: rgba(102, 126, 234, 0.15);
        }
        .instrument-card .icon { font-size: 28px; margin-bottom: 6px; }
        .instrument-card .name { font-size: 11px; color: var(--text-secondary); }
        .instrument-card.active .name { color: var(--text-primary); }
        
        .chord-section { padding: 16px 20px; }
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 22px; font-weight: 700; }
        .chord-numeral { font-size: 11px; color: var(--accent-light); margin-top: 4px; }
        
        .controls-row {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 16px;
        }
        .control-group { flex: 1; }
        .control-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .control-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            z-index: 200;
        }
        .playback-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 14px; font-weight: 600; }
        .playback-sub { font-size: 12px; color: var(--text-secondary); }
        .tempo-control { display: flex; align-items: center; gap: 6px; }
        .tempo-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
        }
        .tempo-display { font-size: 14px; font-weight: 600; min-width: 55px; text-align: center; }
        
        .active-instruments {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .active-inst {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
        }
        .active-inst .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }
        
        .toast {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Current instrument indicator */
        .current-sound {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 20px 16px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v10.2</span><span class="ai-badge">AI</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="ai-actions">
        <button class="ai-btn" onclick="aiGenerate('progression')">
            <span class="sparkle">‚ú®</span>
            AI Generate
        </button>
        <button class="ai-btn" onclick="aiGenerate('continue')">
            <span class="sparkle">üîÆ</span>
            Continue
        </button>
        <button class="ai-btn" onclick="aiGenerate('variation')">
            <span class="sparkle">üé≤</span>
            Variation
        </button>
        <button class="ai-btn" onclick="aiGenerate('surprise')">
            <span class="sparkle">üåü</span>
            Surprise Me
        </button>
    </div>

    <div class="band-toggle">
        <button class="active" onclick="setMode('solo')">Solo</button>
        <button onclick="setMode('duo')">Duo</button>
        <button onclick="setMode('band')">Full Band</button>
        <button onclick="setMode('orchestra')">Orchestra</button>
    </div>

    <!-- Current Sound Display -->
    <div class="current-sound" id="currentSound">üéπ Grand Piano</div>

    <!-- Keys Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--keys)"></span>
                üéπ Keys
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card active" onclick="selectInstrument(this, 'grand-piano', 'üéπ Grand Piano')">
                <div class="icon">üéπ</div>
                <div class="name">Grand Piano</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'electric-piano', 'üéπ Electric Piano')">
                <div class="icon">üéπ</div>
                <div class="name">Electric Piano</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'organ', 'üéöÔ∏è Organ')">
                <div class="icon">üéöÔ∏è</div>
                <div class="name">Organ</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'synth-pad', 'üéõÔ∏è Synth Pad')">
                <div class="icon">üéõÔ∏è</div>
                <div class="name">Synth Pad</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'clavinet', 'üéπ Clavinet')">
                <div class="icon">üéπ</div>
                <div class="name">Clavinet</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'harpsichord', 'üéº Harpsichord')">
                <div class="icon">üéº</div>
                <div class="name">Harpsichord</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'music-box', 'üéµ Music Box')">
                <div class="icon">üéµ</div>
                <div class="name">Music Box</div>
            </div>
        </div>
    </div>

    <!-- Guitar Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--guitar)"></span>
                üé∏ Guitars
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" onclick="selectInstrument(this, 'acoustic-guitar', 'üé∏ Acoustic Guitar')">
                <div class="icon">üé∏</div>
                <div class="name">Acoustic</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'electric-clean', 'üé∏ Clean Electric')">
                <div class="icon">üé∏</div>
                <div class="name">Electric Clean</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'electric-overdrive', 'üé∏ Overdrive')">
                <div class="icon">üî•</div>
                <div class="name">Overdrive</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'electric-distorted', 'üî• Distorted')">
                <div class="icon">‚ö°</div>
                <div class="name">Distorted</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'nylon-guitar', 'üé∏ Nylon')">
                <div class="icon">üé∏</div>
                <div class="name">Nylon</div>
            </div>
        </div>
    </div>

    <!-- Strings & Brass Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--strings)"></span>
                üéª Strings & More
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" onclick="selectInstrument(this, 'strings', 'üéª Strings')">
                <div class="icon">üéª</div>
                <div class="name">Strings</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'cello', 'üéª Cello')">
                <div class="icon">üéª</div>
                <div class="name">Cello</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'trumpet', 'üé∫ Trumpet')">
                <div class="icon">üé∫</div>
                <div class="name">Trumpet</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'saxophone', 'üé∑ Saxophone')">
                <div class="icon">üé∑</div>
                <div class="name">Saxophone</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'choir', 'üé§ Choir')">
                <div class="icon">üé§</div>
                <div class="name">Choir</div>
            </div>
            <div class="instrument-card" onclick="selectInstrument(this, 'bell', 'üîî Bells')">
                <div class="icon">üîî</div>
                <div class="name">Bells</div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-row">
        <div class="control-group">
            <div class="control-label">Key</div>
            <select class="control-select" id="keySelect" onchange="updateKey()">
                <option value="C">C Major</option>
                <option value="G">G Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
                <option value="F">F Major</option>
                <option value="Am">A Minor</option>
                <option value="Em">E Minor</option>
                <option value="Dm">D Minor</option>
            </select>
        </div>
        <div class="control-group">
            <div class="control-label">Genre</div>
            <select class="control-select" id="genreSelect" onchange="updateGenre()">
                <option value="pop">Pop</option>
                <option value="rock">Rock</option>
                <option value="jazz">Jazz</option>
                <option value="blues">Blues</option>
                <option value="rnb">R&B</option>
                <option value="lofi">Lo-Fi</option>
                <option value="classical">Classical</option>
            </select>
        </div>
    </div>

    <!-- Chord Display -->
    <div class="chord-section">
        <div class="section-header">
            <div class="section-title">üé∂ Progression</div>
            <div style="display: flex; gap: 8px;">
                <button class="icon-btn" style="width:36px;height:36px;font-size:16px;background:linear-gradient(135deg, var(--ai-purple), #ec4899);" onclick="aiGenerate('progression')">‚ú®</button>
                <button class="icon-btn" style="width:36px;height:36px;font-size:16px;" onclick="generateProgression()">üé≤</button>
            </div>
        </div>
        <div class="chord-grid" id="chordGrid"></div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 16px 0;">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">ChordFlow v10.2 - Fixed Instrument Sounds</p>
                <p style="color: var(--text-secondary);">Select any instrument above to change the sound!</p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // =============================================
        // STATE
        // =============================================
        const state = {
            mode: 'solo',
            tempo: 120,
            key: 'C',
            genre: 'pop',
            isPlaying: false,
            progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano',
            instrumentName: 'üéπ Grand Piano'
        };

        // =============================================
        // AUDIO - INITIALIZE ONCE
        // =============================================
        let audioInitialized = false;
        let mainSynth = null;
        let bassSynth = null;
        let drumKit = null;
        let reverb = null;

        async function initAudio() {
            if (audioInitialized) return;
            
            await Tone.start();
            console.log('Audio context started');
            
            // Create reverb
            reverb = new Tone.Reverb({ decay: 1.5, wet: 0.2 }).toDestination();
            await reverb.generate();
            
            // Create bass synth
            bassSynth = new Tone.MonoSynth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.8, release: 0.3 }
            }).toDestination();
            bassSynth.volume.value = -10;
            
            // Create drum kit
            drumKit = {
                kick: new Tone.MembraneSynth().toDestination(),
                snare: new Tone.NoiseSynth({ 
                    noise: { type: 'pink' }, 
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
                }).toDestination(),
                hihat: new Tone.MetalSynth({
                    frequency: 400,
                    envelope: { attack: 0.001, decay: 0.1, release: 0.01 }
                }).toDestination()
            };
            drumKit.kick.volume.value = -6;
            drumKit.snare.volume.value = -12;
            drumKit.hihat.volume.value = -18;
            
            // Create main synth with current instrument
            createMainSynth();
            
            audioInitialized = true;
            console.log('Audio fully initialized');
        }

        // =============================================
        // INSTRUMENT DEFINITIONS - CREATES NEW SYNTH
        // =============================================
        function createMainSynth() {
            // Dispose old synth
            if (mainSynth) {
                mainSynth.dispose();
                mainSynth = null;
            }
            
            const inst = state.currentInstrument;
            console.log('Creating synth for:', inst);
            
            switch(inst) {
                case 'grand-piano':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.005, decay: 0.3, sustain: 0.3, release: 1.2 }
                    });
                    break;
                    
                case 'electric-piano':
                    mainSynth = new Tone.PolySynth(Tone.FMSynth, {
                        harmonicity: 3,
                        modulationIndex: 10,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 0.4, sustain: 0.2, release: 0.5 },
                        modulation: { type: 'square' },
                        modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 }
                    });
                    break;
                    
                case 'organ':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.9, release: 0.1 }
                    });
                    break;
                    
                case 'synth-pad':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.5, decay: 0.5, sustain: 0.8, release: 2 }
                    });
                    break;
                    
                case 'clavinet':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'pulse', width: 0.4 },
                        envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.2 }
                    });
                    break;
                    
                case 'harpsichord':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 }
                    });
                    break;
                    
                case 'music-box':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 1.5, sustain: 0, release: 1.5 }
                    });
                    break;
                    
                case 'acoustic-guitar':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.002, decay: 0.4, sustain: 0.1, release: 0.8 }
                    });
                    break;
                    
                case 'electric-clean':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 0.5, sustain: 0.3, release: 0.6 }
                    });
                    break;
                    
                case 'electric-overdrive':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0.5, release: 0.4 }
                    });
                    break;
                    
                case 'electric-distorted':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'square' },
                        envelope: { attack: 0.02, decay: 0.2, sustain: 0.6, release: 0.3 }
                    });
                    break;
                    
                case 'nylon-guitar':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.01, decay: 0.6, sustain: 0.1, release: 1 }
                    });
                    break;
                    
                case 'strings':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 1.5 }
                    });
                    break;
                    
                case 'cello':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.2, decay: 0.3, sustain: 0.6, release: 1 }
                    });
                    break;
                    
                case 'trumpet':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'square' },
                        envelope: { attack: 0.05, decay: 0.2, sustain: 0.7, release: 0.4 }
                    });
                    break;
                    
                case 'saxophone':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.1, decay: 0.2, sustain: 0.6, release: 0.5 }
                    });
                    break;
                    
                case 'choir':
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.5, decay: 0.5, sustain: 0.8, release: 2 }
                    });
                    break;
                    
                case 'bell':
                    mainSynth = new Tone.PolySynth(Tone.FMSynth, {
                        harmonicity: 8,
                        modulationIndex: 2,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 2, sustain: 0, release: 2 },
                        modulation: { type: 'sine' },
                        modulationEnvelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 }
                    });
                    break;
                    
                default:
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.005, decay: 0.3, sustain: 0.3, release: 1.2 }
                    });
            }
            
            // Connect to reverb or destination
            if (reverb) {
                mainSynth.connect(reverb);
            } else {
                mainSynth.toDestination();
            }
            mainSynth.volume.value = -6;
            
            console.log('Synth created for:', inst);
        }

        // =============================================
        // CHORD NOTES
        // =============================================
        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'], 
            'C7': ['C4', 'E4', 'G4', 'Bb4'], 'Cmaj7': ['C4', 'E4', 'G4', 'B4'],
            'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'], 
            'Dm7': ['D4', 'F4', 'A4', 'C5'], 'D7': ['D4', 'F#4', 'A4', 'C5'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'], 
            'Em7': ['E4', 'G4', 'B4', 'D5'], 'E7': ['E4', 'G#4', 'B4', 'D5'],
            'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'], 
            'Fmaj7': ['F4', 'A4', 'C5', 'E5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'], 
            'G7': ['G4', 'B4', 'D5', 'F5'],
            'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'], 
            'Am7': ['A4', 'C5', 'E5', 'G5'], 'A7': ['A4', 'C#5', 'E5', 'G5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'], 
            'B7': ['B4', 'D#5', 'F#5', 'A5'],
            'Bb': ['Bb4', 'D5', 'F5'], 'Bbm': ['Bb4', 'Db5', 'F5']
        };

        // =============================================
        // PLAY FUNCTIONS
        // =============================================
        async function playChord(chord) {
            if (!audioInitialized) await initAudio();
            
            const notes = chordNotes[chord] || chordNotes['C'];
            const bassNote = notes[0].replace('4', '2').replace('5', '3');
            
            // Play main chord
            if (mainSynth) {
                mainSynth.triggerAttackRelease(notes, '2n');
            }
            
            // Play bass if duo/band/orchestra mode
            if (state.mode !== 'solo' && bassSynth) {
                bassSynth.triggerAttackRelease(bassNote, '4n');
            }
            
            haptic();
        }

        function playDrumHit(type) {
            if (!drumKit) return;
            if (type === 'kick') drumKit.kick.triggerAttackRelease('C1', '8n');
            if (type === 'snare') drumKit.snare.triggerAttackRelease('8n');
            if (type === 'hihat') drumKit.hihat.triggerAttackRelease('32n');
        }

        // =============================================
        // INSTRUMENT SELECTION - RECREATES SYNTH
        // =============================================
        async function selectInstrument(el, instrument, displayName) {
            // Update UI
            document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            // Update state
            state.currentInstrument = instrument;
            state.instrumentName = displayName;
            
            // Update display
            document.getElementById('currentSound').textContent = displayName;
            
            // Recreate synth with new sound
            if (audioInitialized) {
                createMainSynth();
            }
            
            // Show feedback
            haptic();
            showToast(`${displayName} selected!`);
            
            // Play a preview chord
            if (audioInitialized) {
                setTimeout(() => {
                    mainSynth.triggerAttackRelease(['C4', 'E4', 'G4'], '8n');
                }, 100);
            }
            
            // Update active instruments display
            document.getElementById('activeInstruments').innerHTML = `
                <div class="active-inst"><span class="dot" style="background: var(--accent)"></span> ${displayName.replace(/^[^\s]+\s/, '')}</div>
            `;
        }

        // =============================================
        // PLAYBACK
        // =============================================
        let playbackInterval, beatCount = 0;
        
        async function togglePlayback() {
            if (!audioInitialized) await initAudio();
            state.isPlaying = !state.isPlaying;
            
            const btn = document.getElementById('playBtn');
            const display = document.getElementById('nowPlaying');
            
            if (state.isPlaying) {
                btn.textContent = '‚è∏Ô∏è';
                let chordIdx = 0;
                beatCount = 0;
                
                const beatInterval = (60 / state.tempo) * 1000;
                
                playbackInterval = setInterval(() => {
                    const beatInMeasure = beatCount % 4;
                    
                    // Drums on every beat (band/orchestra mode)
                    if (state.mode === 'band' || state.mode === 'orchestra') {
                        playDrumHit('hihat');
                        if (beatInMeasure === 0) playDrumHit('kick');
                        if (beatInMeasure === 2) playDrumHit('snare');
                    }
                    
                    // Chord on beat 1
                    if (beatInMeasure === 0) {
                        const chord = state.progression[chordIdx % state.progression.length];
                        playChord(chord);
                        display.textContent = `Playing: ${chord}`;
                        
                        document.querySelectorAll('.chord-card').forEach((card, i) => {
                            card.classList.toggle('playing', i === chordIdx % state.progression.length);
                        });
                        
                        chordIdx++;
                    }
                    
                    beatCount++;
                }, beatInterval);
            } else {
                btn.textContent = '‚ñ∂Ô∏è';
                display.textContent = 'Ready to jam';
                clearInterval(playbackInterval);
                document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            }
        }

        // =============================================
        // AI GENERATION
        // =============================================
        async function aiGenerate(type) {
            const btn = event.target.closest('.ai-btn');
            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = '<div class="spinner"></div> Generating...';
            }
            
            try {
                const key = document.getElementById('keySelect').value;
                const genre = document.getElementById('genreSelect').value;
                const currentProg = state.progression.join(' - ');
                
                let prompt = '';
                switch(type) {
                    case 'progression':
                        prompt = `Generate a creative ${genre} chord progression in the key of ${key}. Return ONLY a JSON array of 4-8 chord symbols, like ["C", "Am", "F", "G"]. Use chord extensions like 7, maj7, m7 when appropriate. Only return the JSON array, nothing else.`;
                        break;
                    case 'continue':
                        prompt = `Continue this ${genre} progression: ${currentProg}. Suggest 4 more chords. Return ONLY a JSON array. Nothing else.`;
                        break;
                    case 'variation':
                        prompt = `Create a variation of: ${currentProg}. Substitute some chords with alternatives. Return ONLY a JSON array. Nothing else.`;
                        break;
                    case 'surprise':
                        prompt = `Generate a creative, unexpected chord progression in ${key}. Be creative! Return ONLY a JSON array of 4-6 chords. Nothing else.`;
                        break;
                }
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const data = await response.json();
                
                let newProgression;
                let cleanResponse = data.result || data.response || '';
                cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                try {
                    newProgression = JSON.parse(cleanResponse);
                } catch (e) {
                    const match = cleanResponse.match(/\[.*\]/s);
                    if (match) newProgression = JSON.parse(match[0]);
                    else throw new Error('Could not parse');
                }
                
                if (Array.isArray(newProgression) && newProgression.length > 0) {
                    state.progression = newProgression;
                    renderChords();
                    showToast(`‚ú® ${newProgression.join(' - ')}`);
                }
                
            } catch (error) {
                console.error('AI error:', error);
                generateProgression();
            } finally {
                if (btn) {
                    btn.classList.remove('loading');
                    const icons = { progression: '‚ú®', continue: 'üîÆ', variation: 'üé≤', surprise: 'üåü' };
                    const labels = { progression: 'AI Generate', continue: 'Continue', variation: 'Variation', surprise: 'Surprise Me' };
                    btn.innerHTML = `<span class="sparkle">${icons[type]}</span> ${labels[type]}`;
                }
            }
        }

        // =============================================
        // PROGRESSION GENERATION (Fallback)
        // =============================================
        function generateProgression() {
            const genre = document.getElementById('genreSelect').value;
            
            const progressions = {
                pop: [['C', 'G', 'Am', 'F'], ['G', 'D', 'Em', 'C'], ['Am', 'F', 'C', 'G']],
                rock: [['A', 'D', 'E', 'A'], ['E', 'A', 'D', 'A'], ['G', 'C', 'D', 'G']],
                jazz: [['Cmaj7', 'Am7', 'Dm7', 'G7'], ['Dm7', 'G7', 'Cmaj7', 'A7']],
                blues: [['A7', 'D7', 'A7', 'E7'], ['E7', 'A7', 'B7', 'E7']],
                rnb: [['Am7', 'Dm7', 'G7', 'Cmaj7'], ['Dm7', 'Em7', 'Am7', 'Gm7']],
                lofi: [['Cmaj7', 'Am7', 'Dm7', 'Gmaj7'], ['Fmaj7', 'Em7', 'Am7', 'Dm7']],
                classical: [['C', 'G', 'Am', 'Em', 'F', 'C', 'F', 'G'], ['Dm', 'Gm', 'C', 'F']]
            };
            
            const options = progressions[genre] || progressions.pop;
            state.progression = options[Math.floor(Math.random() * options.length)];
            renderChords();
            haptic();
            showToast(`üé≤ Random ${genre} progression!`);
        }

        function renderChords() {
            document.getElementById('chordGrid').innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}')">
                    <div class="chord-name">${chord}</div>
                </div>
            `).join('');
            updatePlaybackSub();
        }

        // =============================================
        // UI HELPERS
        // =============================================
        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.band-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            const modeNames = { solo: 'Solo', duo: 'Duo', band: 'Full Band', orchestra: 'Orchestra' };
            showToast(`üé∏ ${modeNames[mode]}`);
            updatePlaybackSub();
            haptic();
        }

        function updateKey() { state.key = document.getElementById('keySelect').value; updatePlaybackSub(); }
        function updateGenre() { state.genre = document.getElementById('genreSelect').value; updatePlaybackSub(); }
        
        function updatePlaybackSub() {
            const modeNames = { solo: 'Solo', duo: 'Duo', band: 'Full Band', orchestra: 'Orchestra' };
            document.getElementById('playbackSub').textContent = 
                `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${modeNames[state.mode]}`;
        }

        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(200, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            haptic();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function haptic() { if (navigator.vibrate) navigator.vibrate(10); }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // =============================================
        // INIT
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            renderChords();
            updatePlaybackSub();
            document.querySelectorAll('.modal').forEach(m => {
                m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
            });
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
