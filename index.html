<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v11.7 - MIDI & Audio Export</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --recording: #ef4444;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --export-blue: #3b82f6;
            --export-green: #22c55e;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 200px);
            transition: all 0.3s;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .version-badge { font-size: 9px; background: var(--success); color: white; padding: 2px 5px; border-radius: 6px; }
        .ai-badge { font-size: 9px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        .export-badge { font-size: 9px; background: linear-gradient(135deg, var(--export-blue), var(--export-green)); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        .recording-badge { font-size: 9px; background: var(--recording); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; animation: recordPulse 1s infinite; display: none; }
        .recording-badge.active { display: inline; }
        @keyframes recordPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .header-actions { display: flex; gap: 6px; }
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 10px; 
            background: var(--bg-secondary); border: none; 
            color: var(--text-primary); font-size: 16px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        .icon-btn.recording { background: var(--recording); animation: recordPulse 1s infinite; }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--bg-secondary);
            margin: 12px 16px;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn:active { transform: scale(0.98); }
        .tab-btn .icon { font-size: 16px; }
        
        .tab-content { display: none; padding: 0 16px; }
        .tab-content.active { display: block; }
        
        /* AI Actions */
        .ai-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
            padding: 2px;
        }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(236, 72, 153, 0.8));
            border: 2px solid rgba(168, 85, 247, 0.6);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .ai-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }
        .ai-btn:active { transform: scale(0.98); }
        .ai-btn.loading { opacity: 0.7; pointer-events: none; }
        
        .generate-section { margin-bottom: 12px; }
        .big-generate-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .big-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(168, 85, 247, 0.5); }
        .big-generate-btn:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(168, 85, 247, 0.3); }
        .gen-icon { font-size: 20px; }
        .gen-text { letter-spacing: 0.5px; }
        
        /* Song Arrangement */
        .arrangement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .section-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        .song-sections {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: none;
        }
        .song-sections::-webkit-scrollbar { display: none; }
        
        .song-section {
            min-width: 100px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .song-section.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .song-section:active { transform: scale(0.97); }
        .song-section .icon { font-size: 20px; margin-bottom: 4px; }
        .song-section .name { font-size: 11px; color: var(--text-secondary); }
        .song-section .count { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        .add-section-btn {
            min-width: 60px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-section-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Timeline */
        .timeline-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .timeline-zoom { display: flex; gap: 4px; }
        .zoom-btn {
            width: 28px; height: 28px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .zoom-btn:active { background: var(--accent); }
        
        .timeline {
            display: flex;
            gap: 8px;
            min-height: 80px;
            align-items: center;
            padding: 8px 0;
        }
        .timeline-chord {
            min-width: 70px;
            padding: 12px 8px;
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
            cursor: grab;
            transition: all 0.2s;
        }
        .timeline-chord:active { cursor: grabbing; transform: scale(0.95); }
        .timeline-chord.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .timeline-chord .name { font-size: 18px; font-weight: 700; }
        .timeline-chord .duration { font-size: 10px; color: var(--text-secondary); }
        
        .add-chord-btn {
            min-width: 50px;
            height: 60px;
            border-radius: 10px;
            background: var(--bg-secondary);
            border: 2px dashed rgba(255,255,255,0.2);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-chord-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Recording Studio */
        .studio-panel {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .studio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .studio-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .waveform-container {
            height: 60px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            position: relative;
        }
        .waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }
        .waveform-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.1s;
        }
        
        .recording-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .record-btn {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .record-btn.rec {
            background: var(--recording);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }
        .record-btn.rec.active { animation: recordPulse 0.5s infinite; }
        .record-btn.stop { background: var(--bg-card); color: var(--text-primary); }
        .record-btn.export { background: linear-gradient(135deg, var(--accent), #764ba2); color: white; }
        .record-btn:active { transform: scale(0.95); }
        
        /* Export Panel - NEW */
        .export-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .export-title { 
            font-size: 16px; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--export-blue), var(--export-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .export-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .export-card {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .export-card:active { transform: scale(0.98); }
        .export-card.midi { border-color: rgba(168, 85, 247, 0.5); }
        .export-card.midi:hover { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .export-card.wav { border-color: rgba(59, 130, 246, 0.5); }
        .export-card.wav:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .export-card.mp3 { border-color: rgba(34, 197, 94, 0.5); }
        .export-card.mp3:hover { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .export-card.share { border-color: rgba(249, 115, 22, 0.5); }
        .export-card.share:hover { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }
        .export-card .icon { font-size: 28px; margin-bottom: 8px; }
        .export-card .name { font-size: 14px; font-weight: 600; }
        .export-card .desc { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .export-card.loading { opacity: 0.6; pointer-events: none; }
        .export-card.loading .icon { animation: spin 1s linear infinite; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .export-progress {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            display: none;
        }
        .export-progress.active { display: block; }
        .progress-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--export-blue), var(--export-green));
            border-radius: 3px;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* Lyrics Panel */
        .lyrics-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .lyrics-input {
            width: 100%;
            min-height: 100px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        .lyrics-input:focus { outline: none; border-color: var(--accent); }
        .lyrics-sync {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .sync-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sync-btn:active { background: var(--accent); }
        
        /* Practice Mode */
        .practice-panel {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .practice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .practice-title { font-size: 14px; font-weight: 600; color: var(--success); }
        .practice-toggle {
            width: 50px; height: 28px;
            border-radius: 14px;
            background: var(--bg-card);
            border: none;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .practice-toggle.active { background: var(--success); }
        .practice-toggle::after {
            content: '';
            position: absolute;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: white;
            top: 3px; left: 3px;
            transition: all 0.2s;
        }
        .practice-toggle.active::after { left: 25px; }
        
        .speed-control { display: flex; align-items: center; gap: 12px; }
        .speed-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 3px;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--success);
            cursor: pointer;
        }
        .speed-value { font-size: 14px; font-weight: 600; min-width: 45px; text-align: center; }
        
        /* Instrument Selector */
        .instrument-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px;
            margin-bottom: 16px;
            scrollbar-width: none;
        }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card {
            min-width: 85px;
            padding: 12px 10px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-card.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .instrument-card:active { transform: scale(0.97); }
        .instrument-card .icon { font-size: 24px; margin-bottom: 4px; }
        .instrument-card .name { font-size: 10px; color: var(--text-secondary); }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
            gap: 4px;
        }
        .mode-toggle button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-toggle button.active { background: var(--accent); color: white; }
        .mode-toggle button:active { transform: scale(0.98); }
        
        /* Controls Row */
        .controls-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .control-group { flex: 1; }
        .control-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-select {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        .control-select:focus { outline: none; border-color: var(--accent); }
        
        /* Chord Grid */
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 14px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 20px; font-weight: 700; }
        .chord-numeral { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        /* Modulation Helper */
        .modulation-panel {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(249, 115, 22, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .mod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .mod-title { font-size: 14px; font-weight: 600; color: var(--gold); }
        .mod-keys { display: flex; gap: 6px; flex-wrap: wrap; }
        .mod-key {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mod-key.recommended { border-color: var(--gold); background: rgba(251, 191, 36, 0.15); }
        .mod-key:active { transform: scale(0.95); }
        
        /* Playback Bar */
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0; right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 16px;
            z-index: 200;
        }
        .playback-main {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .play-btn {
            width: 52px; height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.2s;
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 13px; font-weight: 600; }
        .playback-sub { font-size: 11px; color: var(--text-secondary); }
        
        .tempo-control { display: flex; align-items: center; gap: 4px; }
        .tempo-btn {
            width: 30px; height: 30px;
            border-radius: 6px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tempo-btn:active { background: var(--accent); }
        .tempo-display { font-size: 13px; font-weight: 600; min-width: 50px; text-align: center; }
        
        .active-instruments {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .active-inst {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 16px;
            font-size: 11px;
            white-space: nowrap;
        }
        .active-inst .dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-btn:active { background: var(--accent); }
        
        /* Theme Selector */
        .theme-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .theme-option {
            width: 50px; height: 50px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }
        .theme-option.active { border-color: var(--accent); }
        .theme-option:active { transform: scale(0.95); }
        .theme-option.dark { background: #0a0a0f; }
        .theme-option.light { background: #f8fafc; }
        .theme-option.midnight { background: linear-gradient(135deg, #1a1a3e, #2d1b4e); }
        .theme-option.ocean { background: linear-gradient(135deg, #0c4a6e, #164e63); }
        .theme-option.forest { background: linear-gradient(135deg, #14532d, #1e3a1e); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        /* Current Sound Badge */
        .current-sound {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 12px;
        }
        
        /* Mixer Channels */
        .mixer-channel {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .mixer-label { font-size: 12px; min-width: 80px; }
        .mixer-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 2px;
        }
        .mixer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .mixer-value { font-size: 11px; min-width: 35px; text-align: right; color: var(--text-secondary); }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v11.7</span><span class="ai-badge">AI</span><span class="export-badge">EXPORT</span><span class="recording-badge" id="recordingBadge">REC</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="recordBtn" onclick="toggleRecording()">üéôÔ∏è</button>
            <button class="icon-btn" onclick="openModal('themeModal')">üé®</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('compose')">
            <span class="icon">üéπ</span>
            <span>Compose</span>
        </button>
        <button class="tab-btn" onclick="switchTab('arrange')">
            <span class="icon">üé¨</span>
            <span>Arrange</span>
        </button>
        <button class="tab-btn" onclick="switchTab('studio')">
            <span class="icon">üéôÔ∏è</span>
            <span>Studio</span>
        </button>
        <button class="tab-btn" onclick="switchTab('practice')">
            <span class="icon">üìö</span>
            <span>Practice</span>
        </button>
    </div>

    <!-- COMPOSE TAB -->
    <div class="tab-content active" id="compose-tab">
        <div class="generate-section">
            <button class="big-generate-btn" onclick="aiGenerate('progression')">
                <span class="gen-icon">üéµ</span>
                <span class="gen-text">Generate AI Progression</span>
            </button>
        </div>
        <div class="ai-actions">
            <button class="ai-btn" onclick="aiGenerate('progression')">‚ú® AI Generate</button>
            <button class="ai-btn" onclick="aiGenerate('continue')">üîÆ Continue</button>
            <button class="ai-btn" onclick="aiGenerate('variation')">üé≤ Variation</button>
            <button class="ai-btn" onclick="aiGenerate('modulate')">üîÑ Modulate</button>
        </div>
        
        <div class="mode-toggle">
            <button class="active" onclick="setMode('solo')">Solo</button>
            <button onclick="setMode('duo')">Duo</button>
            <button onclick="setMode('band')">Band</button>
            <button onclick="setMode('orchestra')">Orchestra</button>
        </div>
        
        <div class="current-sound" id="currentSound">üéπ Grand Piano</div>
        
        <div class="instrument-scroll" id="instrumentList"></div>
        
        <div class="controls-row">
            <div class="control-group">
                <div class="control-label">Key</div>
                <select class="control-select" id="keySelect" onchange="updateKey()">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                    <option value="Bm">B Minor</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Genre</div>
                <select class="control-select" id="genreSelect" onchange="updateGenre()">
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="blues">Blues</option>
                    <option value="rnb">R&B</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="edm">EDM</option>
                    <option value="classical">Classical</option>
                    <option value="country">Country</option>
                </select>
            </div>
        </div>
        
        <!-- Modulation Helper -->
        <div class="modulation-panel">
            <div class="mod-header">
                <div class="mod-title">üîÑ Key Modulation</div>
            </div>
            <div class="mod-keys" id="modKeys">
                <button class="mod-key recommended" onclick="modulateTo('G')">G (V)</button>
                <button class="mod-key recommended" onclick="modulateTo('Am')">Am (vi)</button>
                <button class="mod-key" onclick="modulateTo('F')">F (IV)</button>
                <button class="mod-key" onclick="modulateTo('Dm')">Dm (ii)</button>
                <button class="mod-key" onclick="modulateTo('Em')">Em (iii)</button>
            </div>
        </div>
        
        <div class="arrangement-header">
            <div class="section-title">üé∂ Progression</div>
            <button class="icon-btn" style="width:32px;height:32px;font-size:14px;" onclick="generateProgression()">üé≤</button>
        </div>
        
        <div class="chord-grid" id="chordGrid"></div>
    </div>

    <!-- ARRANGE TAB -->
    <div class="tab-content" id="arrange-tab">
        <div class="arrangement-header">
            <div class="section-title">üé¨ Song Sections</div>
        </div>
        
        <div class="song-sections" id="songSections">
            <div class="song-section active" onclick="selectSection('intro')">
                <div class="icon">üé¨</div>
                <div class="name">Intro</div>
                <div class="count">4 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('verse1')">
                <div class="icon">üìù</div>
                <div class="name">Verse 1</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('chorus')">
                <div class="icon">üé§</div>
                <div class="name">Chorus</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('verse2')">
                <div class="icon">üìù</div>
                <div class="name">Verse 2</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('bridge')">
                <div class="icon">üåâ</div>
                <div class="name">Bridge</div>
                <div class="count">4 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('outro')">
                <div class="icon">üèÅ</div>
                <div class="name">Outro</div>
                <div class="count">4 bars</div>
            </div>
            <button class="add-section-btn" onclick="addSection()">+</button>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-header">
                <div class="section-title">üìä Chord Timeline</div>
                <div class="timeline-zoom">
                    <button class="zoom-btn" onclick="zoomTimeline(-1)">‚àí</button>
                    <button class="zoom-btn" onclick="zoomTimeline(1)">+</button>
                </div>
            </div>
            <div class="timeline" id="chordTimeline"></div>
        </div>
        
        <div class="lyrics-container">
            <div class="arrangement-header">
                <div class="section-title">üìù Lyrics</div>
            </div>
            <textarea class="lyrics-input" id="lyricsInput" placeholder="Type your lyrics here...&#10;&#10;Each line will sync with a chord..."></textarea>
            <div class="lyrics-sync">
                <button class="sync-btn" onclick="syncLyrics()">üîó Sync to Chords</button>
                <button class="sync-btn" onclick="aiGenerateLyrics()">‚ú® AI Lyrics</button>
            </div>
        </div>
    </div>

    <!-- STUDIO TAB -->
    <div class="tab-content" id="studio-tab">
        <div class="studio-panel">
            <div class="studio-header">
                <div class="studio-title">üéôÔ∏è Recording Studio</div>
                <span id="recordingTime">0:00</span>
            </div>
            
            <div class="waveform-container">
                <div class="waveform" id="waveform"></div>
            </div>
            
            <div class="recording-controls">
                <button class="record-btn stop" onclick="stopRecording()">‚èπÔ∏è</button>
                <button class="record-btn rec" id="recBtn" onclick="toggleRecording()">‚è∫Ô∏è</button>
                <button class="record-btn export" onclick="switchTab('studio'); document.querySelector('.export-panel').scrollIntoView({behavior: 'smooth'})">üíæ</button>
            </div>
        </div>
        
        <!-- NEW: Export Panel -->
        <div class="export-panel">
            <div class="export-header">
                <div class="export-title">üì¶ Export Your Music</div>
            </div>
            
            <div class="export-grid">
                <div class="export-card midi" onclick="exportMIDI()">
                    <div class="icon">üéπ</div>
                    <div class="name">MIDI File</div>
                    <div class="desc">Import into DAWs</div>
                </div>
                <div class="export-card wav" onclick="exportWAV()">
                    <div class="icon">üéµ</div>
                    <div class="name">WAV Audio</div>
                    <div class="desc">Lossless quality</div>
                </div>
                <div class="export-card mp3" onclick="exportMP3()">
                    <div class="icon">üìÑ</div>
                    <div class="name">MP3 Audio</div>
                    <div class="desc">Compressed audio</div>
                </div>
                <div class="export-card share" onclick="shareSong()">
                    <div class="icon">üì§</div>
                    <div class="name">Share Link</div>
                    <div class="desc">Copy progression</div>
                </div>
            </div>
            
            <div class="export-progress" id="exportProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing export...</div>
            </div>
        </div>
        
        <div class="studio-panel">
            <div class="studio-header">
                <div class="studio-title">üéöÔ∏è Mixer</div>
            </div>
            <div id="mixerChannels">
                <div class="mixer-channel">
                    <span class="mixer-label">üéπ Main</span>
                    <input type="range" class="mixer-slider" value="80" min="0" max="100" onchange="setMixerLevel('main', this.value)">
                    <span class="mixer-value">80%</span>
                </div>
                <div class="mixer-channel">
                    <span class="mixer-label">üé∏ Bass</span>
                    <input type="range" class="mixer-slider" value="70" min="0" max="100" onchange="setMixerLevel('bass', this.value)">
                    <span class="mixer-value">70%</span>
                </div>
                <div class="mixer-channel">
                    <span class="mixer-label">ü•Å Drums</span>
                    <input type="range" class="mixer-slider" value="75" min="0" max="100" onchange="setMixerLevel('drums', this.value)">
                    <span class="mixer-value">75%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PRACTICE TAB -->
    <div class="tab-content" id="practice-tab">
        <div class="practice-panel">
            <div class="practice-header">
                <div class="practice-title">üéì Practice Mode</div>
                <button class="practice-toggle" id="practiceToggle" onclick="togglePractice()"></button>
            </div>
            <div class="speed-control">
                <span style="font-size:12px;color:var(--text-secondary);">Speed:</span>
                <input type="range" class="speed-slider" id="speedSlider" min="25" max="100" value="100" oninput="updateSpeed()">
                <div class="speed-value" id="speedValue">100%</div>
            </div>
        </div>
        
        <div class="arrangement-header">
            <div class="section-title">üìñ Chord Learning</div>
        </div>
        
        <div class="chord-grid" id="practiceChords"></div>
        
        <div class="studio-panel" style="margin-top:16px;">
            <div class="studio-title" style="margin-bottom:12px;">üéØ Practice Stats</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                    <div style="font-size:24px;font-weight:700;color:var(--success);" id="practiceAccuracy">0%</div>
                    <div style="font-size:11px;color:var(--text-secondary);">Accuracy</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                    <div style="font-size:24px;font-weight:700;color:var(--accent);" id="practiceStreak">0</div>
                    <div style="font-size:11px;color:var(--text-secondary);">Streak</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Theme</div>
                <button class="close-btn" onclick="closeModal('themeModal')">‚úï</button>
            </div>
            <div class="theme-options">
                <div class="theme-option dark active" onclick="setTheme('dark')">üåô</div>
                <div class="theme-option light" onclick="setTheme('light')">‚òÄÔ∏è</div>
                <div class="theme-option midnight" onclick="setTheme('midnight')">üåå</div>
                <div class="theme-option ocean" onclick="setTheme('ocean')">üåä</div>
                <div class="theme-option forest" onclick="setTheme('forest')">üå≤</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 12px 0;">
                <p style="color: var(--text-secondary); margin-bottom: 12px;">ChordFlow v11.7</p>
                <p style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                    üé¨ Song Arrangement<br>
                    üéôÔ∏è Recording Studio<br>
                    üìä Timeline Editor<br>
                    üîÑ Key Modulation<br>
                    üìö Practice Mode<br>
                    üé® Theme Engine<br>
                    üéöÔ∏è Mixer Controls<br>
                    <strong style="color:var(--export-blue);">üÜï MIDI Export</strong><br>
                    <strong style="color:var(--export-green);">üÜï Audio Export (WAV/MP3)</strong>
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>


    <script>
        // =============================================
        // STATE
        // =============================================
        const state = {
            mode: 'solo',
            tempo: 120,
            key: 'C',
            genre: 'pop',
            isPlaying: false,
            isRecording: false,
            practiceMode: false,
            practiceSpeed: 100,
            progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano',
            instrumentName: 'üéπ Grand Piano',
            currentOctaveShift: 0,
            currentSection: 'intro',
            songSections: {
                intro: ['C', 'G'],
                verse1: ['C', 'G', 'Am', 'F'],
                chorus: ['F', 'G', 'C', 'Am'],
                verse2: ['C', 'G', 'Am', 'F'],
                bridge: ['Dm', 'G'],
                outro: ['C', 'G', 'C']
            },
            recordingData: [],
            practiceStats: { accuracy: 0, streak: 0 },
            mixerLevels: { main: 80, bass: 70, drums: 75 },
            isExporting: false
        };

        // Instruments
        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ', category: 'keys' },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ', category: 'keys' },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è', category: 'keys' },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß', category: 'synth' },
            { id: 'acoustic-guitar', name: 'Acoustic', icon: 'üé∏', category: 'guitar' },
            { id: 'electric-clean', name: 'Electric Clean', icon: 'üé∏', category: 'guitar' },
            { id: 'electric-overdrive', name: 'Overdrive', icon: 'üîä', category: 'guitar' },
            { id: 'strings', name: 'Strings', icon: 'üéª', category: 'strings' },
            { id: 'cello', name: 'Cello', icon: 'üéª', category: 'strings' },
            { id: 'trumpet', name: 'Trumpet', icon: 'üé∫', category: 'brass' },
            { id: 'saxophone', name: 'Saxophone', icon: 'üé∑', category: 'brass' },
            { id: 'choir', name: 'Choir', icon: 'üé§', category: 'vocal' },
            { id: 'bell', name: 'Bell', icon: 'üîî', category: 'synth' },
            { id: 'music-box', name: 'Music Box', icon: 'üì¶', category: 'keys' }
        ];

        // =============================================
        // AUDIO ENGINE v11.7
        // =============================================
        let audioInitialized = false;
        let mainSynth = null;
        let bassSynth = null;
        let drumKit = null;
        let reverb = null;
        let delay = null;
        let filter = null;
        let distortion = null;
        let vibrato = null;
        let chorus = null;

        async function initAudio() {
            if (audioInitialized) return;
            await Tone.start();
            
            reverb = new Tone.Reverb({ decay: 2.5, wet: 0.25 }).toDestination();
            await reverb.generate();
            
            delay = new Tone.FeedbackDelay({ delayTime: '8n', feedback: 0.2, wet: 0 }).connect(reverb);
            chorus = new Tone.Chorus({ frequency: 1.5, delayTime: 3.5, depth: 0.7, wet: 0 }).connect(delay);
            vibrato = new Tone.Vibrato({ frequency: 5, depth: 0.1, wet: 0 }).connect(chorus);
            distortion = new Tone.Distortion({ distortion: 0, wet: 0 }).connect(vibrato);
            filter = new Tone.Filter({ frequency: 5000, type: 'lowpass', rolloff: -12 }).connect(distortion);
            
            bassSynth = new Tone.MonoSynth({
                oscillator: { type: 'sawtooth' },
                filter: { Q: 2, type: 'lowpass', rolloff: -24 },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.4 },
                filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.4, baseFrequency: 100, octaves: 2 }
            }).toDestination();
            bassSynth.volume.value = -8;
            
            drumKit = {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 6,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 1.4 }
                }).toDestination(),
                snare: new Tone.NoiseSynth({ 
                    noise: { type: 'white' }, 
                    envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
                }).toDestination(),
                hihat: new Tone.MetalSynth({
                    frequency: 250,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
                    harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
                }).toDestination()
            };
            drumKit.kick.volume.value = -4;
            drumKit.snare.volume.value = -10;
            drumKit.hihat.volume.value = -16;
            
            createMainSynth();
            audioInitialized = true;
            console.log('üéµ Audio Engine v11.7 initialized');
        }

        const instrumentConfigs = {
            'grand-piano': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'triangle8', partials: [1, 0.5, 0.3, 0.15] }, envelope: { attack: 0.005, decay: 1.2, sustain: 0.3, release: 1.8 } },
                effects: { reverb: 0.3, delay: 0.1, filter: 8000 }, volume: -6, octaveShift: 0
            },
            'electric-piano': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 3.01, modulationIndex: 14, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.5, sustain: 0.3, release: 0.8 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 } },
                effects: { reverb: 0.25, chorus: 0.4, delay: 0.15, filter: 6000 }, volume: -5, octaveShift: 0
            },
            'organ': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'sine', partialCount: 8 }, envelope: { attack: 0.01, decay: 0.01, sustain: 1, release: 0.05 } },
                effects: { reverb: 0.4, chorus: 0.6, vibrato: 0.3, filter: 4000 }, volume: -4, octaveShift: 0
            },
            'synth-pad': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 2, oscillator: { type: 'sawtooth' }, envelope: { attack: 0.8, decay: 0.5, sustain: 0.9, release: 3 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 1 } },
                effects: { reverb: 0.6, chorus: 0.5, delay: 0.3, filter: 3000, vibrato: 0.2 }, volume: -8, octaveShift: 0
            },
            'acoustic-guitar': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'fmsine', modulationIndex: 3, harmonicity: 3.5 }, envelope: { attack: 0.002, decay: 0.6, sustain: 0.1, release: 1.2 } },
                effects: { reverb: 0.3, filter: 4500, delay: 0.1 }, volume: -5, octaveShift: 0
            },
            'electric-clean': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 1, modulationIndex: 1, oscillator: { type: 'triangle' }, envelope: { attack: 0.001, decay: 0.8, sustain: 0.2, release: 0.8 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.1 } },
                effects: { reverb: 0.25, delay: 0.2, chorus: 0.3, filter: 5500 }, volume: -6, octaveShift: 0
            },
            'electric-overdrive': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.6, release: 0.5 } },
                effects: { reverb: 0.3, distortion: 0.6, filter: 3500, delay: 0.15 }, volume: -8, octaveShift: 0
            },
            'strings': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 3, oscillator: { type: 'fatsawtooth', spread: 30, count: 3 }, envelope: { attack: 0.4, decay: 0.3, sustain: 0.8, release: 2 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.3, decay: 0.1, sustain: 1, release: 0.5 } },
                effects: { reverb: 0.5, chorus: 0.4, vibrato: 0.25, filter: 4000 }, volume: -7, octaveShift: 0
            },
            'cello': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'sawtooth' }, filter: { Q: 3, type: 'lowpass', rolloff: -12 }, envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 1.5 }, filterEnvelope: { attack: 0.2, decay: 0.3, sustain: 0.5, release: 1, baseFrequency: 200, octaves: 3 } },
                effects: { reverb: 0.45, vibrato: 0.35, filter: 3500 }, volume: -6, octaveShift: -1
            },
            'trumpet': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'square' }, filter: { Q: 6, type: 'lowpass', rolloff: -24 }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.8, release: 0.3 }, filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 0.3, baseFrequency: 500, octaves: 4 } },
                effects: { reverb: 0.35, delay: 0.1, filter: 5000, vibrato: 0.15 }, volume: -4, octaveShift: 1
            },
            'saxophone': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'sawtooth' }, filter: { Q: 4, type: 'bandpass', rolloff: -12 }, envelope: { attack: 0.1, decay: 0.2, sustain: 0.7, release: 0.4 }, filterEnvelope: { attack: 0.1, decay: 0.15, sustain: 0.4, release: 0.3, baseFrequency: 300, octaves: 3 } },
                effects: { reverb: 0.4, vibrato: 0.3, filter: 4500, delay: 0.1 }, volume: -5, octaveShift: 0
            },
            'choir': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 1.5, oscillator: { type: 'sine' }, envelope: { attack: 0.6, decay: 0.4, sustain: 0.9, release: 2.5 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.5, decay: 0.3, sustain: 0.8, release: 1 } },
                effects: { reverb: 0.65, chorus: 0.5, vibrato: 0.2, filter: 3000 }, volume: -8, octaveShift: 0
            },
            'bell': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 12, modulationIndex: 20, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 1.5, sustain: 0, release: 2 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.5 } },
                effects: { reverb: 0.5, delay: 0.25, filter: 8000 }, volume: -8, octaveShift: 1
            },
            'music-box': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 8, modulationIndex: 2, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 2, sustain: 0, release: 2.5 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 } },
                effects: { reverb: 0.45, delay: 0.2, filter: 7000 }, volume: -6, octaveShift: 1
            }
        };

        function createMainSynth() {
            if (mainSynth) {
                try { mainSynth.disconnect(); } catch(e) {}
                try { mainSynth.dispose(); } catch(e) {}
                mainSynth = null;
            }
            
            const config = instrumentConfigs[state.currentInstrument] || instrumentConfigs['grand-piano'];
            
            if (reverb) reverb.wet.value = 0.2;
            if (delay) delay.wet.value = 0;
            if (chorus) chorus.wet.value = 0;
            if (vibrato) vibrato.wet.value = 0;
            if (distortion) distortion.wet.value = 0;
            if (filter) filter.frequency.value = 10000;
            
            if (config.synthType === 'monoSynth') {
                mainSynth = new Tone.MonoSynth(config.options);
            } else {
                const VoiceClass = config.voiceSynth === 'FMSynth' ? Tone.FMSynth :
                                   config.voiceSynth === 'AMSynth' ? Tone.AMSynth : Tone.Synth;
                mainSynth = new Tone.PolySynth(VoiceClass, config.options);
            }
            
            if (config.effects) {
                if (config.effects.reverb && reverb) reverb.wet.value = config.effects.reverb;
                if (config.effects.delay && delay) delay.wet.value = config.effects.delay;
                if (config.effects.chorus && chorus) chorus.wet.value = config.effects.chorus;
                if (config.effects.vibrato && vibrato) vibrato.wet.value = config.effects.vibrato;
                if (config.effects.distortion && distortion) distortion.wet.value = config.effects.distortion;
                if (config.effects.filter && filter) filter.frequency.value = config.effects.filter;
            }
            
            mainSynth.connect(filter);
            mainSynth.volume.value = config.volume || -6;
            state.currentOctaveShift = config.octaveShift || 0;
        }

        // =============================================
        // CHORD DATA
        // =============================================
        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'],
            'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'],
            'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'],
            'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'],
            'Bb': ['Bb4', 'D5', 'F5'],
            'C7': ['C4', 'E4', 'G4', 'Bb4'], 'Cmaj7': ['C4', 'E4', 'G4', 'B4'],
            'Dm7': ['D4', 'F4', 'A4', 'C5'], 'G7': ['G4', 'B4', 'D5', 'F5'],
            'Am7': ['A4', 'C5', 'E5', 'G5'], 'Fmaj7': ['F4', 'A4', 'C5', 'E5'],
            'A7': ['A4', 'C#5', 'E5', 'G5'], 'D7': ['D4', 'F#4', 'A4', 'C5'],
            'E7': ['E4', 'G#4', 'B4', 'D5'], 'F7': ['F4', 'A4', 'C5', 'Eb5']
        };

        // Note to MIDI conversion
        const noteToMidi = {
            'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
            'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
        };

        function noteNameToMidi(noteName) {
            const match = noteName.match(/([A-G][#b]?)(\d)/);
            if (!match) return 60;
            const note = match[1];
            const octave = parseInt(match[2]);
            return noteToMidi[note] + (octave + 1) * 12;
        }

        const progressions = {
            pop: { C: ['C','G','Am','F'], G: ['G','D','Em','C'], D: ['D','A','Bm','G'], Am: ['Am','F','C','G'], Em: ['Em','C','G','D'] },
            rock: { C: ['C','F','G','C'], G: ['G','C','D','G'], Am: ['Am','G','F','E'], Em: ['Em','D','C','D'] },
            jazz: { C: ['Cmaj7','Dm7','G7','Cmaj7'], Am: ['Am7','Dm7','G7','Cmaj7'], Dm: ['Dm7','G7','Cmaj7','Fmaj7'] },
            blues: { C: ['C7','C7','F7','C7'], G: ['G7','C7','D7','G7'], A: ['A7','D7','E7','A7'] },
            lofi: { C: ['Cmaj7','Am7','Fmaj7','G7'], Am: ['Am7','Fmaj7','Cmaj7','G7'] },
            edm: { C: ['C','G','Am','F'], Am: ['Am','F','C','G'], Em: ['Em','C','G','D'] },
            classical: { C: ['C','G','Am','F','G','C'], Am: ['Am','Dm','E','Am'] },
            country: { C: ['C','G','D','C'], G: ['G','C','D','G'], D: ['D','G','A','D'] },
            rnb: { C: ['Cmaj7','Am7','Dm7','G7'], Am: ['Am7','Dm7','Fmaj7','G7'] }
        };

        const numerals = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bm': 'vii¬∞' };

        // =============================================
        // MIDI EXPORT - Real Implementation
        // =============================================
        function createMIDIFile() {
            // MIDI file structure
            const ticksPerBeat = 480;
            const beatsPerChord = 2;
            const ticksPerChord = ticksPerBeat * beatsPerChord;
            
            // Header chunk
            const header = [
                0x4D, 0x54, 0x68, 0x64, // "MThd"
                0x00, 0x00, 0x00, 0x06, // chunk length
                0x00, 0x00,             // format 0 (single track)
                0x00, 0x01,             // one track
                (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF // ticks per beat
            ];
            
            // Build track data
            let trackData = [];
            
            // Tempo meta event (microseconds per beat for tempo BPM)
            const microsecondsPerBeat = Math.round(60000000 / state.tempo);
            trackData.push(
                0x00,                   // delta time
                0xFF, 0x51, 0x03,       // tempo meta event
                (microsecondsPerBeat >> 16) & 0xFF,
                (microsecondsPerBeat >> 8) & 0xFF,
                microsecondsPerBeat & 0xFF
            );
            
            // Track name
            const trackName = `ChordFlow - ${state.key} ${state.genre}`;
            trackData.push(0x00, 0xFF, 0x03, trackName.length);
            for (let i = 0; i < trackName.length; i++) {
                trackData.push(trackName.charCodeAt(i));
            }
            
            // Add chords
            let currentTick = 0;
            state.progression.forEach((chord, index) => {
                const notes = chordNotes[chord] || chordNotes['C'];
                const midiNotes = notes.map(n => noteNameToMidi(n));
                
                // Note on events
                midiNotes.forEach((midiNote, i) => {
                    trackData.push(...writeVarLength(i === 0 ? 0 : 0)); // delta time
                    trackData.push(0x90, midiNote, 100); // note on, note, velocity
                });
                
                // Note off events
                midiNotes.forEach((midiNote, i) => {
                    trackData.push(...writeVarLength(i === 0 ? ticksPerChord : 0)); // delta time
                    trackData.push(0x80, midiNote, 0); // note off
                });
            });
            
            // End of track
            trackData.push(0x00, 0xFF, 0x2F, 0x00);
            
            // Track chunk
            const trackChunk = [
                0x4D, 0x54, 0x72, 0x6B, // "MTrk"
                (trackData.length >> 24) & 0xFF,
                (trackData.length >> 16) & 0xFF,
                (trackData.length >> 8) & 0xFF,
                trackData.length & 0xFF,
                ...trackData
            ];
            
            return new Uint8Array([...header, ...trackChunk]);
        }
        
        function writeVarLength(value) {
            const result = [];
            let v = value;
            result.push(v & 0x7F);
            v >>= 7;
            while (v > 0) {
                result.unshift((v & 0x7F) | 0x80);
                v >>= 7;
            }
            return result;
        }
        
        async function exportMIDI() {
            if (state.isExporting) return;
            state.isExporting = true;
            
            const card = document.querySelector('.export-card.midi');
            card.classList.add('loading');
            showExportProgress('Generating MIDI file...');
            
            try {
                await updateProgress(30, 'Creating MIDI data...');
                const midiData = createMIDIFile();
                
                await updateProgress(70, 'Preparing download...');
                const blob = new Blob([midiData], { type: 'audio/midi' });
                
                await updateProgress(100, 'Complete!');
                
                // Create download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.mid`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('üéπ MIDI file downloaded!');
            } catch (err) {
                console.error('MIDI export error:', err);
                showToast('‚ùå Export failed');
            }
            
            card.classList.remove('loading');
            hideExportProgress();
            state.isExporting = false;
        }

        // =============================================
        // AUDIO EXPORT - WAV Implementation
        // =============================================
        async function exportWAV() {
            if (state.isExporting) return;
            state.isExporting = true;
            
            const card = document.querySelector('.export-card.wav');
            card.classList.add('loading');
            showExportProgress('Initializing audio...');
            
            try {
                await initAudio();
                await updateProgress(10, 'Setting up recorder...');
                
                // Use MediaRecorder with Tone.js destination
                const dest = Tone.context.createMediaStreamDestination();
                const recorder = new MediaRecorder(dest.stream, { mimeType: 'audio/webm' });
                const chunks = [];
                
                recorder.ondataavailable = (e) => chunks.push(e.data);
                
                // Connect main synth to recorder
                mainSynth.connect(dest);
                
                await updateProgress(20, 'Recording progression...');
                recorder.start();
                
                // Play through progression
                const beatsPerChord = 2;
                const msPerBeat = 60000 / state.tempo;
                const msPerChord = msPerBeat * beatsPerChord;
                
                for (let i = 0; i < state.progression.length; i++) {
                    const chord = state.progression[i];
                    const notes = chordNotes[chord] || chordNotes['C'];
                    const progress = 20 + ((i + 1) / state.progression.length) * 60;
                    await updateProgress(progress, `Recording: ${chord}...`);
                    
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    mainSynth.triggerAttack(notes);
                    
                    await new Promise(r => setTimeout(r, msPerChord - 100));
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    await new Promise(r => setTimeout(r, 100));
                }
                
                await updateProgress(85, 'Finalizing audio...');
                
                // Stop recording
                await new Promise(resolve => {
                    recorder.onstop = resolve;
                    recorder.stop();
                });
                
                await updateProgress(95, 'Creating WAV file...');
                
                // Convert WebM to WAV using AudioContext
                const webmBlob = new Blob(chunks, { type: 'audio/webm' });
                const arrayBuffer = await webmBlob.arrayBuffer();
                const audioContext = new AudioContext();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Convert to WAV
                const wavBlob = audioBufferToWav(audioBuffer);
                
                await updateProgress(100, 'Complete!');
                
                // Download
                const url = URL.createObjectURL(wavBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Reconnect to normal destination
                mainSynth.disconnect(dest);
                mainSynth.connect(filter);
                
                showToast('üéµ WAV file downloaded!');
            } catch (err) {
                console.error('WAV export error:', err);
                showToast('‚ùå Export failed - try again');
            }
            
            card.classList.remove('loading');
            hideExportProgress();
            state.isExporting = false;
        }
        
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const data = interleave(buffer);
            const dataLength = data.length * bytesPerSample;
            const bufferLength = 44 + dataLength;
            
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            // Write audio data
            const offset = 44;
            for (let i = 0; i < data.length; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset + i * 2, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }
        
        function interleave(buffer) {
            const channels = [];
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            const length = channels[0].length;
            const result = new Float32Array(length * channels.length);
            
            for (let i = 0; i < length; i++) {
                for (let c = 0; c < channels.length; c++) {
                    result[i * channels.length + c] = channels[c][i];
                }
            }
            
            return result;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // =============================================
        // MP3 EXPORT
        // =============================================
        async function exportMP3() {
            if (state.isExporting) return;
            state.isExporting = true;
            
            const card = document.querySelector('.export-card.mp3');
            card.classList.add('loading');
            showExportProgress('Initializing audio...');
            
            try {
                await initAudio();
                await updateProgress(10, 'Setting up recorder...');
                
                // Use MediaRecorder
                const dest = Tone.context.createMediaStreamDestination();
                
                // Check for MP3 support, fallback to webm
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/mp3')) {
                    mimeType = 'audio/mp3';
                } else if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                    mimeType = 'audio/mpeg';
                }
                
                const recorder = new MediaRecorder(dest.stream, { mimeType });
                const chunks = [];
                
                recorder.ondataavailable = (e) => chunks.push(e.data);
                
                mainSynth.connect(dest);
                
                await updateProgress(20, 'Recording progression...');
                recorder.start();
                
                const beatsPerChord = 2;
                const msPerBeat = 60000 / state.tempo;
                const msPerChord = msPerBeat * beatsPerChord;
                
                for (let i = 0; i < state.progression.length; i++) {
                    const chord = state.progression[i];
                    const notes = chordNotes[chord] || chordNotes['C'];
                    const progress = 20 + ((i + 1) / state.progression.length) * 60;
                    await updateProgress(progress, `Recording: ${chord}...`);
                    
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    mainSynth.triggerAttack(notes);
                    
                    await new Promise(r => setTimeout(r, msPerChord - 100));
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    await new Promise(r => setTimeout(r, 100));
                }
                
                await updateProgress(90, 'Finalizing...');
                
                await new Promise(resolve => {
                    recorder.onstop = resolve;
                    recorder.stop();
                });
                
                await updateProgress(100, 'Complete!');
                
                const blob = new Blob(chunks, { type: mimeType });
                const ext = mimeType.includes('mp3') || mimeType.includes('mpeg') ? 'mp3' : 'webm';
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mainSynth.disconnect(dest);
                mainSynth.connect(filter);
                
                showToast(`üìÑ ${ext.toUpperCase()} file downloaded!`);
            } catch (err) {
                console.error('MP3 export error:', err);
                showToast('‚ùå Export failed');
            }
            
            card.classList.remove('loading');
            hideExportProgress();
            state.isExporting = false;
        }

        // =============================================
        // EXPORT UI HELPERS
        // =============================================
        function showExportProgress(text) {
            const progress = document.getElementById('exportProgress');
            progress.classList.add('active');
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = '0%';
        }
        
        function hideExportProgress() {
            setTimeout(() => {
                document.getElementById('exportProgress').classList.remove('active');
            }, 1000);
        }
        
        async function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
            await new Promise(r => setTimeout(r, 100));
        }

        // =============================================
        // PLAYBACK
        // =============================================
        let playLoop = null;
        let currentChordIndex = 0;

        async function togglePlayback() {
            await initAudio();
            if (state.isPlaying) { stopPlayback(); } 
            else { startPlayback(); }
        }

        function startPlayback() {
            state.isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è';
            currentChordIndex = 0;
            
            const effectiveTempo = state.practiceMode ? state.tempo * (state.practiceSpeed / 100) : state.tempo;
            const interval = (60 / effectiveTempo) * 2 * 1000;
            
            playCurrentChord();
            playLoop = setInterval(() => {
                currentChordIndex = (currentChordIndex + 1) % state.progression.length;
                playCurrentChord();
            }, interval);
        }

        function stopPlayback() {
            state.isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            if (playLoop) { clearInterval(playLoop); playLoop = null; }
            if (mainSynth && mainSynth.releaseAll) mainSynth.releaseAll();
            document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            document.querySelectorAll('.timeline-chord').forEach(c => c.classList.remove('playing'));
            document.getElementById('nowPlaying').textContent = 'Ready to jam';
        }

        function playCurrentChord() {
            const chord = state.progression[currentChordIndex];
            let notes = chordNotes[chord] || chordNotes['C'];
            
            const shift = state.currentOctaveShift || 0;
            if (shift !== 0) {
                notes = notes.map(note => {
                    const match = note.match(/([A-G][#b]?)(\d)/);
                    return match ? match[1] + (parseInt(match[2]) + shift) : note;
                });
            }
            
            if (mainSynth) {
                if (mainSynth.releaseAll) mainSynth.releaseAll();
                mainSynth.triggerAttack(notes);
            }
            
            if ((state.mode === 'band' || state.mode === 'orchestra') && bassSynth) {
                const bassNote = notes[0].replace('4', '2').replace('5', '3');
                bassSynth.triggerAttackRelease(bassNote, '2n');
            }
            
            document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.querySelectorAll('.timeline-chord').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.getElementById('nowPlaying').textContent = `Playing: ${chord}`;
            
            if (state.isRecording) state.recordingData.push({ chord, time: Date.now() });
        }

        function playChord(chord, index) {
            initAudio().then(() => {
                let notes = chordNotes[chord] || chordNotes['C'];
                const shift = state.currentOctaveShift || 0;
                if (shift !== 0) {
                    notes = notes.map(note => {
                        const match = note.match(/([A-G][#b]?)(\d)/);
                        return match ? match[1] + (parseInt(match[2]) + shift) : note;
                    });
                }
                
                if (mainSynth) {
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    mainSynth.triggerAttackRelease(notes, '1n');
                }
                
                document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === index));
                setTimeout(() => document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing')), 500);
            });
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updatePlaybackInfo();
            updateActiveInstruments();
            showToast(`${mode.charAt(0).toUpperCase() + mode.slice(1)} mode`);
        }

        function selectInstrument(id, name, icon) {
            state.currentInstrument = id;
            state.instrumentName = `${icon} ${name}`;
            document.getElementById('currentSound').textContent = state.instrumentName;
            document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.instrument-card').classList.add('active');
            createMainSynth();
            updateActiveInstruments();
            showToast(state.instrumentName);
        }

        function updateKey() {
            state.key = document.getElementById('keySelect').value;
            generateProgression();
            updateModulationKeys();
        }

        function updateGenre() {
            state.genre = document.getElementById('genreSelect').value;
            generateProgression();
        }

        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(220, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
        }

        function generateProgression() {
            const genreProgs = progressions[state.genre] || progressions.pop;
            const keyProgs = genreProgs[state.key] || genreProgs['C'] || ['C', 'G', 'Am', 'F'];
            state.progression = [...keyProgs];
            renderChords();
            renderTimeline();
            updatePlaybackInfo();
        }

        function renderChords() {
            const grid = document.getElementById('chordGrid');
            grid.innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}', ${i})">
                    <div class="chord-name">${chord}</div>
                    <div class="chord-numeral">${numerals[chord] || ''}</div>
                </div>
            `).join('');
            
            const practiceGrid = document.getElementById('practiceChords');
            if (practiceGrid) practiceGrid.innerHTML = grid.innerHTML;
        }

        function renderTimeline() {
            const timeline = document.getElementById('chordTimeline');
            timeline.innerHTML = state.progression.map((chord, i) => `
                <div class="timeline-chord" draggable="true" ondragstart="dragChord(event, ${i})">
                    <div class="name">${chord}</div>
                    <div class="duration">2 beats</div>
                </div>
            `).join('') + '<button class="add-chord-btn" onclick="addChordToTimeline()">+</button>';
        }

        function renderInstruments() {
            document.getElementById('instrumentList').innerHTML = instruments.map(inst => `
                <div class="instrument-card ${inst.id === state.currentInstrument ? 'active' : ''}" 
                     onclick="selectInstrument('${inst.id}', '${inst.name}', '${inst.icon}')">
                    <div class="icon">${inst.icon}</div>
                    <div class="name">${inst.name}</div>
                </div>
            `).join('');
        }

        function updatePlaybackInfo() {
            document.getElementById('playbackSub').textContent = 
                `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${state.mode.charAt(0).toUpperCase() + state.mode.slice(1)}`;
        }

        function updateActiveInstruments() {
            let html = `<div class="active-inst"><span class="dot" style="background: var(--keys)"></span> ${state.instrumentName.replace(/^./, '')}</div>`;
            if (state.mode === 'band' || state.mode === 'orchestra') {
                html += '<div class="active-inst"><span class="dot" style="background: var(--bass)"></span> Bass</div>';
                html += '<div class="active-inst"><span class="dot" style="background: var(--drums)"></span> Drums</div>';
            }
            if (state.mode === 'orchestra') {
                html += '<div class="active-inst"><span class="dot" style="background: var(--strings)"></span> Strings</div>';
            }
            document.getElementById('activeInstruments').innerHTML = html;
        }

        function updateModulationKeys() {
            const relatedKeys = {
                'C': [{ key: 'G', rel: 'V' }, { key: 'Am', rel: 'vi' }, { key: 'F', rel: 'IV' }, { key: 'Dm', rel: 'ii' }],
                'G': [{ key: 'D', rel: 'V' }, { key: 'Em', rel: 'vi' }, { key: 'C', rel: 'IV' }, { key: 'Am', rel: 'ii' }],
                'Am': [{ key: 'Em', rel: 'v' }, { key: 'C', rel: 'III' }, { key: 'Dm', rel: 'iv' }, { key: 'F', rel: 'VI' }],
                'F': [{ key: 'C', rel: 'V' }, { key: 'Dm', rel: 'vi' }, { key: 'Bb', rel: 'IV' }, { key: 'Gm', rel: 'ii' }]
            };
            const keys = relatedKeys[state.key] || relatedKeys['C'];
            document.getElementById('modKeys').innerHTML = keys.map((k, i) => `
                <button class="mod-key ${i < 2 ? 'recommended' : ''}" onclick="modulateTo('${k.key}')">${k.key} (${k.rel})</button>
            `).join('');
        }

        function modulateTo(newKey) {
            document.getElementById('keySelect').value = newKey;
            state.key = newKey;
            generateProgression();
            showToast(`Modulated to ${newKey}`);
        }

        // =============================================
        // RECORDING
        // =============================================
        let recordingTimer = null;
        let recordingSeconds = 0;

        function toggleRecording() {
            if (state.isRecording) { stopRecordingSession(); } 
            else { startRecordingSession(); }
        }

        function startRecordingSession() {
            state.isRecording = true;
            state.recordingData = [];
            recordingSeconds = 0;
            
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recBtn').classList.add('active');
            document.getElementById('recordingBadge').classList.add('active');
            
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                const mins = Math.floor(recordingSeconds / 60);
                const secs = recordingSeconds % 60;
                document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                updateWaveform();
            }, 1000);
            
            showToast('üî¥ Recording started');
        }

        function stopRecordingSession() {
            state.isRecording = false;
            if (recordingTimer) { clearInterval(recordingTimer); recordingTimer = null; }
            
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recBtn').classList.remove('active');
            document.getElementById('recordingBadge').classList.remove('active');
            
            showToast(`Recording saved (${recordingSeconds}s)`);
        }

        function stopRecording() {
            stopRecordingSession();
            if (state.isPlaying) stopPlayback();
        }

        function updateWaveform() {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = Array(40).fill(0).map(() => {
                const height = state.isRecording ? Math.random() * 40 + 10 : 10;
                return `<div class="waveform-bar" style="height:${height}px;"></div>`;
            }).join('');
        }

        function shareSong() {
            const shareText = `Check out my ChordFlow progression!\n\nüéµ Key: ${state.key}\nüé∏ Genre: ${state.genre}\nüéπ Chords: ${state.progression.join(' ‚Üí ')}\n\nüîó ${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({ 
                    title: 'ChordFlow Progression', 
                    text: shareText,
                    url: window.location.href 
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('üìã Copied to clipboard!');
                });
            }
        }

        function setMixerLevel(channel, value) {
            state.mixerLevels[channel] = parseInt(value);
            event.target.nextElementSibling.textContent = value + '%';
        }

        // =============================================
        // PRACTICE MODE
        // =============================================
        function togglePractice() {
            state.practiceMode = !state.practiceMode;
            document.getElementById('practiceToggle').classList.toggle('active', state.practiceMode);
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
            showToast(state.practiceMode ? 'Practice mode ON' : 'Practice mode OFF');
        }

        function updateSpeed() {
            state.practiceSpeed = parseInt(document.getElementById('speedSlider').value);
            document.getElementById('speedValue').textContent = state.practiceSpeed + '%';
            if (state.isPlaying && state.practiceMode) { stopPlayback(); startPlayback(); }
        }

        // =============================================
        // SECTIONS & LYRICS
        // =============================================
        function selectSection(section) {
            state.currentSection = section;
            document.querySelectorAll('.song-section').forEach(s => s.classList.remove('active'));
            event.target.closest('.song-section').classList.add('active');
            state.progression = state.songSections[section] || ['C', 'G', 'Am', 'F'];
            renderChords();
            renderTimeline();
        }

        function addSection() { showToast('Add section coming soon!'); }
        function addChordToTimeline() { state.progression.push('C'); renderChords(); renderTimeline(); }
        function dragChord(e, index) { e.dataTransfer.setData('text/plain', index); }
        function zoomTimeline(direction) { showToast(direction > 0 ? 'Zoom in' : 'Zoom out'); }

        function syncLyrics() {
            const lyrics = document.getElementById('lyricsInput').value;
            if (lyrics.trim()) {
                showToast('üîó Lyrics synced to chords!');
            } else {
                showToast('Enter lyrics first');
            }
        }

        // =============================================
        // AI FUNCTIONS
        // =============================================
        async function aiGenerate(type) {
            const btn = event?.target?.closest('.ai-btn') || event?.target?.closest('.big-generate-btn');
            const originalText = btn ? btn.innerHTML : "";
            if (btn) { btn.classList.add('loading'); btn.innerHTML = '<div class="spinner"></div> Generating...'; }
            
            try {
                const prompts = {
                    progression: `Generate a ${state.genre} chord progression in the key of ${state.key}. Return ONLY a JSON array of 4 chord names like ["C", "G", "Am", "F"]. No other text.`,
                    continue: `Continue this ${state.genre} chord progression: ${state.progression.join(', ')}. Add 2-4 more chords. Return ONLY a JSON array like ["Em", "Dm", "G", "C"]. No other text.`,
                    variation: `Create a variation of this progression: ${state.progression.join(', ')} in ${state.key}. Return ONLY a JSON array of 4 chord names. No other text.`,
                    modulate: `Suggest a key modulation from ${state.key}. Return ONLY a JSON array of 4 chords in the new key. No other text.`
                };
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompts[type] || prompts.progression, action: type })
                });
                
                const data = await response.json();
                
                if (data.result) {
                    const jsonMatch = data.result.match(/\[[\s\S]*?\]/);
                    if (jsonMatch) {
                        const chords = JSON.parse(jsonMatch[0]);
                        if (Array.isArray(chords) && chords.length > 0) {
                            const validChords = chords.filter(c => chordNotes[c]);
                            if (validChords.length > 0) {
                                state.progression = validChords;
                                renderChords(); renderTimeline(); updatePlaybackInfo();
                                showToast('‚ú® AI progression generated!');
                            } else { throw new Error('Invalid chords'); }
                        }
                    } else { throw new Error('No chords found'); }
                } else if (data.error) { throw new Error(data.error); }
            } catch (err) {
                console.error('AI Generate error:', err);
                generateProgression();
                showToast('üé≤ Random progression generated!');
            }
            
            if (btn) { btn.classList.remove('loading'); btn.innerHTML = originalText; }
        }

        async function aiGenerateLyrics() {
            showToast('‚ú® Generating lyrics...');
            const lyrics = document.getElementById('lyricsInput');
            
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Write short song lyrics for a ${state.genre} song. Chord progression: ${state.progression.join(' - ')}. Key: ${state.key}. Write a verse (4 lines) and chorus (4 lines). Keep it simple.`
                    })
                });
                
                const data = await response.json();
                if (data.result) { lyrics.value = data.result; showToast('‚ú® AI lyrics generated!'); } 
                else { throw new Error('No lyrics'); }
            } catch (err) {
                lyrics.value = `Verse 1:\n${state.progression[0]} - Walking down the road today\n${state.progression[1]} - Feeling like I've found my way\n${state.progression[2]} - Everything is falling into place\n${state.progression[3] || 'C'} - I can see the smile on your face\n\nChorus:\n${state.progression[0]} - This is where I want to be\n${state.progression[1]} - You and me, finally free`;
                showToast('üìù Default lyrics added');
            }
        }

        // =============================================
        // THEME
        // =============================================
        function setTheme(theme) {
            document.querySelectorAll('.theme-option').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.body.classList.remove('theme-light');
            if (theme === 'light') document.body.classList.add('theme-light');
            localStorage.setItem('chordflow-theme', theme);
            closeModal('themeModal');
            showToast(`Theme: ${theme}`);
        }

        // =============================================
        // MODALS & TOAST
        // =============================================
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // =============================================
        // INIT
        // =============================================
        function init() {
            renderInstruments();
            generateProgression();
            renderTimeline();
            updateWaveform();
            updateModulationKeys();
            
            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme === 'light') document.body.classList.add('theme-light');
            
            console.log('üéµ ChordFlow v11.7 - MIDI & Audio Export initialized');
        }

        init();
    </script>
</body>
</html>
