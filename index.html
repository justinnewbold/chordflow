<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v9.0 - AI Chord Progression Generator</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 80px);
        }
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 28px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-badge { font-size: 10px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        
        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .stats-bar::-webkit-scrollbar { display: none; }
        .stat-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: 20px;
            white-space: nowrap;
            font-size: 13px;
        }
        .stat-chip .icon { font-size: 16px; }
        .stat-chip .value { font-weight: 600; color: var(--accent-light); }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px 20px;
        }
        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 16px 8px;
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-btn:active { transform: scale(0.95); border-color: var(--accent); }
        .quick-btn .icon { font-size: 24px; }
        .quick-btn.primary { background: linear-gradient(135deg, var(--accent), #764ba2); border-color: var(--accent); }
        
        /* Main Content */
        .main-content { padding: 16px 20px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        /* Sound Preset Selector */
        .sound-presets {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        .sound-presets::-webkit-scrollbar { display: none; }
        .preset-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }
        .preset-chip.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.2); }
        .preset-chip .icon { font-size: 24px; }
        .preset-chip .name { font-size: 10px; color: var(--text-secondary); white-space: nowrap; }
        
        /* Chord Cards */
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .chord-card:active { transform: scale(0.98); border-color: var(--accent); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .chord-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .chord-numeral { font-size: 12px; color: var(--accent-light); margin-bottom: 8px; }
        .chord-function { font-size: 10px; color: var(--text-secondary); padding: 4px 8px; background: var(--bg-primary); border-radius: 8px; display: inline-block; }
        .chord-badge { position: absolute; top: 8px; right: 8px; font-size: 14px; }
        
        /* Controls */
        .controls-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .control-group { flex: 1; min-width: 140px; }
        .control-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Playback Bar */
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 200;
        }
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.2s;
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 14px; font-weight: 600; }
        .playback-progress { font-size: 12px; color: var(--text-secondary); }
        .tempo-control { display: flex; align-items: center; gap: 8px; }
        .tempo-display { font-size: 14px; font-weight: 600; min-width: 60px; text-align: center; }
        .tempo-btn { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 16px; cursor: pointer; }
        
        /* Modal Base */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; }
        
        /* Learning Mode */
        .lesson-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .lesson-card:active { transform: scale(0.98); }
        .lesson-icon { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), #764ba2); display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .lesson-info { flex: 1; }
        .lesson-title { font-weight: 600; margin-bottom: 4px; }
        .lesson-desc { font-size: 12px; color: var(--text-secondary); }
        .lesson-progress { width: 60px; text-align: right; }
        .lesson-xp { font-size: 12px; color: var(--gold); font-weight: 600; }
        
        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .achievement {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .achievement.unlocked { opacity: 1; border: 2px solid var(--gold); }
        .achievement .icon { font-size: 32px; margin-bottom: 8px; }
        .achievement .name { font-size: 11px; font-weight: 600; }
        .achievement .xp { font-size: 10px; color: var(--gold); }
        
        /* Mic Detection */
        .mic-visualizer {
            height: 120px;
            background: var(--bg-card);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .mic-wave {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1.5s ease-in-out infinite;
            opacity: 0.3;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.3); opacity: 0.6; }
        }
        .detected-chord {
            position: absolute;
            font-size: 36px;
            font-weight: 700;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }
        
        /* Daily Goal */
        .daily-goal {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .goal-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .streak-badge { background: var(--gold); color: #000; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .goal-progress { background: var(--bg-primary); border-radius: 8px; height: 8px; overflow: hidden; }
        .goal-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 8px; transition: width 0.3s; }
        .goal-stats { display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: var(--text-secondary); }
        
        /* Sheet Music Preview */
        .sheet-music {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            min-height: 150px;
            position: relative;
        }
        .staff-line {
            height: 1px;
            background: #333;
            margin: 10px 0;
        }
        .clef { position: absolute; left: 10px; top: 30px; font-size: 48px; color: #333; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">üéµ</span>
            <h1>ChordFlow<span class="version-badge">v9.0</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openModal('learningModal')" title="Learn">üìö</button>
            <button class="icon-btn" onclick="openModal('achievementsModal')" title="Achievements">üèÜ</button>
            <button class="icon-btn" onclick="openModal('settingsModal')" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-chip">
            <span class="icon">üî•</span>
            <span class="value" id="streakCount">3</span>
            <span>day streak</span>
        </div>
        <div class="stat-chip">
            <span class="icon">‚≠ê</span>
            <span class="value" id="xpCount">1,250</span>
            <span>XP</span>
        </div>
        <div class="stat-chip">
            <span class="icon">üéØ</span>
            <span class="value" id="levelDisplay">Level 5</span>
        </div>
        <div class="stat-chip">
            <span class="icon">üéπ</span>
            <span class="value" id="chordsLearned">42</span>
            <span>chords</span>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-btn primary" onclick="generateProgression()">
            <span class="icon">‚ú®</span>
            <span>Generate</span>
        </button>
        <button class="quick-btn" onclick="aiContinue()">
            <span class="icon">ü§ñ</span>
            <span>AI Continue</span>
        </button>
        <button class="quick-btn" onclick="openModal('micModal')">
            <span class="icon">üéôÔ∏è</span>
            <span>Detect</span>
        </button>
        <button class="quick-btn" onclick="openModal('sheetModal')">
            <span class="icon">üéº</span>
            <span>Sheet</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Daily Goal -->
        <div class="daily-goal">
            <div class="goal-header">
                <div class="goal-title">
                    <span>üéØ</span> Daily Goal
                </div>
                <div class="streak-badge">üî• 3 days</div>
            </div>
            <div class="goal-progress">
                <div class="goal-fill" style="width: 65%"></div>
            </div>
            <div class="goal-stats">
                <span>13/20 chords practiced</span>
                <span>+50 XP today</span>
            </div>
        </div>

        <!-- Sound Presets -->
        <div class="section-title">üîä Sound</div>
        <div class="sound-presets">
            <div class="preset-chip active" data-preset="grand-piano" onclick="selectPreset(this)">
                <span class="icon">üéπ</span>
                <span class="name">Grand Piano</span>
            </div>
            <div class="preset-chip" data-preset="electric-piano" onclick="selectPreset(this)">
                <span class="icon">üéπ</span>
                <span class="name">Electric</span>
            </div>
            <div class="preset-chip" data-preset="synth-pad" onclick="selectPreset(this)">
                <span class="icon">üéõÔ∏è</span>
                <span class="name">Synth Pad</span>
            </div>
            <div class="preset-chip" data-preset="organ" onclick="selectPreset(this)">
                <span class="icon">üéöÔ∏è</span>
                <span class="name">Organ</span>
            </div>
            <div class="preset-chip" data-preset="strings" onclick="selectPreset(this)">
                <span class="icon">üéª</span>
                <span class="name">Strings</span>
            </div>
            <div class="preset-chip" data-preset="acoustic" onclick="selectPreset(this)">
                <span class="icon">üé∏</span>
                <span class="name">Acoustic</span>
            </div>
            <div class="preset-chip" data-preset="lofi" onclick="selectPreset(this)">
                <span class="icon">üìª</span>
                <span class="name">Lo-Fi</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-row">
            <div class="control-group">
                <div class="control-label">Key</div>
                <select class="control-select" id="keySelect" onchange="updateProgression()">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="Bb">Bb Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Genre</div>
                <select class="control-select" id="genreSelect" onchange="updateProgression()">
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="blues">Blues</option>
                    <option value="rnb">R&B / Soul</option>
                    <option value="country">Country</option>
                    <option value="folk">Folk</option>
                    <option value="edm">EDM</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="gospel">Gospel</option>
                </select>
            </div>
        </div>

        <!-- Chord Display -->
        <div class="section-title">üé∂ Progression</div>
        <div class="chord-grid" id="chordGrid">
            <div class="chord-card" onclick="playChord('C')">
                <div class="chord-badge">I</div>
                <div class="chord-name">C</div>
                <div class="chord-numeral">I</div>
                <div class="chord-function">Tonic</div>
            </div>
            <div class="chord-card" onclick="playChord('G')">
                <div class="chord-badge">V</div>
                <div class="chord-name">G</div>
                <div class="chord-numeral">V</div>
                <div class="chord-function">Dominant</div>
            </div>
            <div class="chord-card" onclick="playChord('Am')">
                <div class="chord-badge">vi</div>
                <div class="chord-name">Am</div>
                <div class="chord-numeral">vi</div>
                <div class="chord-function">Submediant</div>
            </div>
            <div class="chord-card" onclick="playChord('F')">
                <div class="chord-badge">IV</div>
                <div class="chord-name">F</div>
                <div class="chord-numeral">IV</div>
                <div class="chord-function">Subdominant</div>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
        <div class="playback-info">
            <div class="now-playing" id="nowPlaying">Ready to play</div>
            <div class="playback-progress" id="progressText">4 chords ‚Ä¢ C Major</div>
        </div>
        <div class="tempo-control">
            <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
            <div class="tempo-display" id="tempoDisplay">120 BPM</div>
            <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
        </div>
    </div>

    <!-- Mic Detection Modal -->
    <div class="modal" id="micModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üéôÔ∏è Chord Detection</div>
                <button class="close-btn" onclick="closeModal('micModal')">‚úï</button>
            </div>
            <div class="mic-visualizer">
                <div class="mic-wave"></div>
                <div class="detected-chord" id="detectedChord">--</div>
            </div>
            <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                Play a chord on your instrument and ChordFlow will detect it!
            </p>
            <button class="quick-btn primary" style="width: 100%; flex-direction: row; justify-content: center;" onclick="startMicDetection()">
                <span class="icon">üé§</span>
                <span>Start Listening</span>
            </button>
        </div>
    </div>

    <!-- Learning Modal -->
    <div class="modal" id="learningModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìö Learn Music Theory</div>
                <button class="close-btn" onclick="closeModal('learningModal')">‚úï</button>
            </div>
            <div class="lesson-card" onclick="startLesson('major-scale')">
                <div class="lesson-icon">üéπ</div>
                <div class="lesson-info">
                    <div class="lesson-title">Major Scale Basics</div>
                    <div class="lesson-desc">Learn the foundation of Western music</div>
                </div>
                <div class="lesson-progress">
                    <div class="lesson-xp">+100 XP</div>
                </div>
            </div>
            <div class="lesson-card" onclick="startLesson('chord-construction')">
                <div class="lesson-icon">üéµ</div>
                <div class="lesson-info">
                    <div class="lesson-title">Chord Construction</div>
                    <div class="lesson-desc">Build major, minor, and 7th chords</div>
                </div>
                <div class="lesson-progress">
                    <div class="lesson-xp">+150 XP</div>
                </div>
            </div>
            <div class="lesson-card" onclick="startLesson('progressions')">
                <div class="lesson-icon">üé∂</div>
                <div class="lesson-info">
                    <div class="lesson-title">Common Progressions</div>
                    <div class="lesson-desc">Master I-V-vi-IV and more</div>
                </div>
                <div class="lesson-progress">
                    <div class="lesson-xp">+200 XP</div>
                </div>
            </div>
            <div class="lesson-card" onclick="startLesson('modes')">
                <div class="lesson-icon">üåà</div>
                <div class="lesson-info">
                    <div class="lesson-title">Modes & Scales</div>
                    <div class="lesson-desc">Explore Dorian, Mixolydian, and more</div>
                </div>
                <div class="lesson-progress">
                    <div class="lesson-xp">+250 XP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üèÜ Achievements</div>
                <button class="close-btn" onclick="closeModal('achievementsModal')">‚úï</button>
            </div>
            <div class="achievements-grid">
                <div class="achievement unlocked">
                    <div class="icon">üéµ</div>
                    <div class="name">First Chord</div>
                    <div class="xp">+50 XP</div>
                </div>
                <div class="achievement unlocked">
                    <div class="icon">üî•</div>
                    <div class="name">3 Day Streak</div>
                    <div class="xp">+100 XP</div>
                </div>
                <div class="achievement unlocked">
                    <div class="icon">üéπ</div>
                    <div class="name">10 Chords</div>
                    <div class="xp">+150 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">‚≠ê</div>
                    <div class="name">50 Chords</div>
                    <div class="xp">+300 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">üèÖ</div>
                    <div class="name">7 Day Streak</div>
                    <div class="xp">+500 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">üé∏</div>
                    <div class="name">Jazz Master</div>
                    <div class="xp">+750 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">üëë</div>
                    <div class="name">100 Chords</div>
                    <div class="xp">+1000 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">üöÄ</div>
                    <div class="name">30 Day Streak</div>
                    <div class="xp">+2000 XP</div>
                </div>
                <div class="achievement">
                    <div class="icon">üíé</div>
                    <div class="name">Theory Expert</div>
                    <div class="xp">+5000 XP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sheet Music Modal -->
    <div class="modal" id="sheetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üéº Sheet Music</div>
                <button class="close-btn" onclick="closeModal('sheetModal')">‚úï</button>
            </div>
            <div class="sheet-music">
                <div class="clef">ùÑû</div>
                <div class="staff-line" style="margin-top: 50px;"></div>
                <div class="staff-line"></div>
                <div class="staff-line"></div>
                <div class="staff-line"></div>
                <div class="staff-line"></div>
            </div>
            <p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 16px;">
                Sheet music notation for your progression
            </p>
            <button class="quick-btn primary" style="width: 100%; margin-top: 16px; flex-direction: row; justify-content: center;" onclick="exportPDF()">
                <span class="icon">üìÑ</span>
                <span>Export PDF</span>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div class="lesson-card">
                <div class="lesson-icon">üîä</div>
                <div class="lesson-info">
                    <div class="lesson-title">Sound Volume</div>
                    <div class="lesson-desc">Adjust playback volume</div>
                </div>
            </div>
            <div class="lesson-card">
                <div class="lesson-icon">üì±</div>
                <div class="lesson-info">
                    <div class="lesson-title">Haptic Feedback</div>
                    <div class="lesson-desc">Vibration on interactions</div>
                </div>
            </div>
            <div class="lesson-card">
                <div class="lesson-icon">üåô</div>
                <div class="lesson-info">
                    <div class="lesson-title">Dark Mode</div>
                    <div class="lesson-desc">Always on</div>
                </div>
            </div>
            <div class="lesson-card">
                <div class="lesson-icon">‚òÅÔ∏è</div>
                <div class="lesson-info">
                    <div class="lesson-title">Cloud Sync</div>
                    <div class="lesson-desc">Sync progress across devices</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // App State
        const state = {
            currentKey: 'C',
            currentGenre: 'pop',
            tempo: 120,
            isPlaying: false,
            currentPreset: 'grand-piano',
            progression: ['C', 'G', 'Am', 'F'],
            xp: 1250,
            streak: 3,
            level: 5,
            chordsLearned: 42
        };

        // Initialize Tone.js
        let synth;
        async function initAudio() {
            await Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            synth.set({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.8 }
            });
        }

        // Chord data
        const chordNotes = {
            'C': ['C4', 'E4', 'G4'],
            'Cm': ['C4', 'Eb4', 'G4'],
            'D': ['D4', 'F#4', 'A4'],
            'Dm': ['D4', 'F4', 'A4'],
            'E': ['E4', 'G#4', 'B4'],
            'Em': ['E4', 'G4', 'B4'],
            'F': ['F4', 'A4', 'C5'],
            'Fm': ['F4', 'Ab4', 'C5'],
            'G': ['G4', 'B4', 'D5'],
            'Gm': ['G4', 'Bb4', 'D5'],
            'A': ['A4', 'C#5', 'E5'],
            'Am': ['A4', 'C5', 'E5'],
            'B': ['B4', 'D#5', 'F#5'],
            'Bm': ['B4', 'D5', 'F#5'],
            'Bb': ['Bb4', 'D5', 'F5']
        };

        // Play single chord
        async function playChord(chord) {
            if (!synth) await initAudio();
            const notes = chordNotes[chord] || chordNotes['C'];
            synth.triggerAttackRelease(notes, '2n');
            haptic();
            showToast(`Playing ${chord}`);
            
            // Update XP
            state.xp += 5;
            document.getElementById('xpCount').textContent = state.xp.toLocaleString();
        }

        // Generate progression
        function generateProgression() {
            const progressions = {
                'pop': [['C', 'G', 'Am', 'F'], ['G', 'D', 'Em', 'C'], ['Am', 'F', 'C', 'G']],
                'rock': [['E', 'A', 'D', 'A'], ['G', 'C', 'D', 'G'], ['Am', 'G', 'F', 'E']],
                'jazz': [['Dm', 'G', 'C', 'Am'], ['Cm', 'F', 'Bb', 'Eb'], ['Am', 'D', 'G', 'C']],
                'blues': [['E', 'A', 'E', 'B'], ['G', 'C', 'G', 'D'], ['A', 'D', 'A', 'E']],
                'rnb': [['Fm', 'Bb', 'Eb', 'Cm'], ['Am', 'Dm', 'G', 'C'], ['Em', 'Am', 'D', 'G']],
                'country': [['G', 'C', 'D', 'G'], ['D', 'G', 'A', 'D'], ['C', 'Am', 'F', 'G']],
                'folk': [['G', 'Em', 'C', 'D'], ['Am', 'G', 'C', 'F'], ['D', 'Bm', 'G', 'A']],
                'edm': [['Am', 'F', 'C', 'G'], ['Em', 'C', 'G', 'D'], ['Dm', 'Am', 'F', 'C']],
                'lofi': [['Dm', 'Am', 'F', 'C'], ['Em', 'Am', 'D', 'G'], ['Am', 'Em', 'F', 'G']],
                'gospel': [['C', 'Am', 'F', 'G'], ['G', 'Em', 'C', 'D'], ['F', 'Dm', 'Bb', 'C']]
            };
            
            const genre = state.currentGenre;
            const options = progressions[genre] || progressions['pop'];
            state.progression = options[Math.floor(Math.random() * options.length)];
            
            renderChords();
            haptic();
            showToast('‚ú® New progression generated!');
            
            state.xp += 20;
            document.getElementById('xpCount').textContent = state.xp.toLocaleString();
        }

        // Render chord grid
        function renderChords() {
            const grid = document.getElementById('chordGrid');
            const numerals = ['I', 'V', 'vi', 'IV'];
            const functions = ['Tonic', 'Dominant', 'Submediant', 'Subdominant'];
            
            grid.innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}')">
                    <div class="chord-badge">${numerals[i] || (i+1)}</div>
                    <div class="chord-name">${chord}</div>
                    <div class="chord-numeral">${numerals[i] || ''}</div>
                    <div class="chord-function">${functions[i] || ''}</div>
                </div>
            `).join('');
        }

        // Toggle playback
        let playbackInterval;
        async function togglePlayback() {
            if (!synth) await initAudio();
            state.isPlaying = !state.isPlaying;
            
            const btn = document.getElementById('playBtn');
            const display = document.getElementById('nowPlaying');
            
            if (state.isPlaying) {
                btn.textContent = '‚è∏Ô∏è';
                display.textContent = 'Playing...';
                let idx = 0;
                
                const playNext = () => {
                    const chord = state.progression[idx % state.progression.length];
                    playChord(chord);
                    
                    // Highlight current card
                    document.querySelectorAll('.chord-card').forEach((card, i) => {
                        card.classList.toggle('playing', i === idx % state.progression.length);
                    });
                    
                    display.textContent = `Playing: ${chord}`;
                    idx++;
                };
                
                playNext();
                playbackInterval = setInterval(playNext, (60 / state.tempo) * 2000);
            } else {
                btn.textContent = '‚ñ∂Ô∏è';
                display.textContent = 'Ready to play';
                clearInterval(playbackInterval);
                document.querySelectorAll('.chord-card').forEach(card => card.classList.remove('playing'));
            }
        }

        // Tempo control
        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(200, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = `${state.tempo} BPM`;
            haptic();
        }

        // Sound presets
        function selectPreset(el) {
            document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            state.currentPreset = el.dataset.preset;
            
            // Update synth sound
            const presets = {
                'grand-piano': { type: 'triangle', attack: 0.02 },
                'electric-piano': { type: 'sine', attack: 0.01 },
                'synth-pad': { type: 'sawtooth', attack: 0.3 },
                'organ': { type: 'square', attack: 0.005 },
                'strings': { type: 'sawtooth', attack: 0.5 },
                'acoustic': { type: 'triangle', attack: 0.03 },
                'lofi': { type: 'sine', attack: 0.1 }
            };
            
            const preset = presets[state.currentPreset] || presets['grand-piano'];
            if (synth) {
                synth.set({ oscillator: { type: preset.type }, envelope: { attack: preset.attack } });
            }
            
            haptic();
            showToast(`Sound: ${el.querySelector('.name').textContent}`);
        }

        // AI Continue
        async function aiContinue() {
            showToast('ü§ñ AI analyzing progression...');
            
            // Simulate AI suggestion
            setTimeout(() => {
                const suggestions = ['Dm', 'Em', 'Bdim', 'Am7', 'Fmaj7'];
                const newChord = suggestions[Math.floor(Math.random() * suggestions.length)];
                state.progression.push(newChord);
                renderChords();
                showToast(`‚ú® AI added: ${newChord}`);
                
                state.xp += 30;
                document.getElementById('xpCount').textContent = state.xp.toLocaleString();
            }, 1000);
        }

        // Mic detection
        function startMicDetection() {
            showToast('üéôÔ∏è Listening for chords...');
            const display = document.getElementById('detectedChord');
            
            // Simulate detection
            const chords = ['C', 'G', 'Am', 'F', 'Dm', 'Em'];
            let count = 0;
            const interval = setInterval(() => {
                display.textContent = chords[count % chords.length];
                count++;
                if (count > 5) {
                    clearInterval(interval);
                    display.textContent = chords[Math.floor(Math.random() * chords.length)];
                    showToast('‚úÖ Chord detected!');
                }
            }, 500);
        }

        // Lessons
        function startLesson(id) {
            closeModal('learningModal');
            showToast(`üìö Starting lesson: ${id}`);
            // Would open lesson content
        }

        // Export PDF
        function exportPDF() {
            showToast('üìÑ Generating PDF...');
            setTimeout(() => showToast('‚úÖ PDF ready!'), 1500);
        }

        // Modal controls
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            haptic();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Haptic feedback
        function haptic() {
            if (navigator.vibrate) navigator.vibrate(10);
        }

        // Toast notifications
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Update progression when controls change
        function updateProgression() {
            state.currentKey = document.getElementById('keySelect').value;
            state.currentGenre = document.getElementById('genreSelect').value;
            document.getElementById('progressText').textContent = `${state.progression.length} chords ‚Ä¢ ${state.currentKey}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderChords();
            
            // Close modals on backdrop click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            });
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
