<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChordFlow v0.57</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="AI-powered chord progression generator for musicians">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-elevated: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --accent: #0a84ff;
            --accent-green: #30d158;
            --accent-orange: #ff9f0a;
            --accent-pink: #ff375f;
            --accent-purple: #bf5af2;
            --separator: rgba(84, 84, 88, 0.65);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 100px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        html, body { font-family: var(--font); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; min-height: -webkit-fill-available; overflow: hidden; overscroll-behavior: none; }
        :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        button:focus:not(:focus-visible) { outline: none; }

        .onboarding { position: fixed; inset: 0; background: var(--bg-primary); z-index: 1000; display: flex; flex-direction: column; padding: var(--safe-top) var(--spacing-lg) var(--safe-bottom); opacity: 1; transition: opacity 0.5s ease; }
        .onboarding.hidden { opacity: 0; pointer-events: none; }
        .onboarding-header { text-align: center; padding: var(--spacing-xl) 0; }
        .onboarding-logo { font-size: 64px; margin-bottom: var(--spacing-md); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .onboarding-title { font-size: 32px; font-weight: 800; margin-bottom: var(--spacing-sm); }
        .onboarding-subtitle { font-size: 17px; color: var(--text-secondary); max-width: 300px; margin: 0 auto; line-height: 1.4; }
        .onboarding-modes { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-md); padding: var(--spacing-lg) 0; max-width: 400px; margin: 0 auto; width: 100%; }
        .mode-option { background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); cursor: pointer; transition: all var(--transition-fast); border: 2px solid transparent; display: flex; align-items: center; gap: var(--spacing-md); }
        .mode-option:hover, .mode-option:focus { background: var(--bg-tertiary); }
        .mode-option.selected { border-color: var(--accent); background: rgba(10, 132, 255, 0.1); }
        .mode-option-icon { font-size: 40px; flex-shrink: 0; }
        .mode-option-content { flex: 1; }
        .mode-option-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .mode-option-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.3; }
        .mode-option-check { width: 24px; height: 24px; border-radius: var(--radius-full); border: 2px solid var(--separator); display: flex; align-items: center; justify-content: center; color: transparent; transition: all var(--transition-fast); }
        .mode-option.selected .mode-option-check { background: var(--accent); border-color: var(--accent); color: white; }
        .onboarding-footer { padding: var(--spacing-lg) 0; }
        .onboarding-cta { width: 100%; max-width: 400px; margin: 0 auto; padding: 18px; background: var(--accent); border: none; border-radius: var(--radius-md); color: white; font-size: 17px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
        .onboarding-cta:hover { background: #0077ed; transform: scale(1.02); }
        .onboarding-cta:active { transform: scale(0.98); }
        .onboarding-skip { display: block; text-align: center; margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 15px; cursor: pointer; background: none; border: none; font-family: var(--font); }
        .onboarding-skip:hover { color: var(--text-primary); }

        .ui-container { display: none; min-height: 100vh; min-height: -webkit-fill-available; opacity: 0; transition: opacity 0.3s ease; }
        .ui-container.active { display: flex; flex-direction: column; opacity: 1; }

        #dualModeUI { padding-top: var(--safe-top); padding-bottom: calc(var(--safe-bottom) + 80px); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) var(--spacing-lg); position: sticky; top: 0; z-index: 100; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: var(--spacing-sm); }
        .header-actions { display: flex; gap: var(--spacing-sm); }
        .header-btn { width: 36px; height: 36px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-primary); font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-fast); }
        .header-btn:active { transform: scale(0.92); }
        .mode-toggle { position: fixed; top: calc(var(--safe-top) + 70px); left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border-radius: var(--radius-full); padding: 4px; display: flex; z-index: 200; box-shadow: 0 4px 24px rgba(0,0,0,0.4); }
        .mode-btn { padding: 10px 24px; border: none; border-radius: var(--radius-full); background: transparent; color: var(--text-secondary); font-size: 15px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .mode-btn.active { background: var(--accent); color: white; }
        .main-content { flex: 1; padding: var(--spacing-lg); padding-top: 70px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .mode-view { display: none; animation: fadeSlideIn 0.3s ease; }
        .mode-view.active { display: block; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .settings-row { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); }
        .setting-chip { flex: 1; padding: 14px var(--spacing-md); background: var(--bg-secondary); border: none; border-radius: var(--radius-md); color: var(--text-primary); font-size: 15px; font-weight: 500; font-family: var(--font); display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background var(--transition-fast); }
        .setting-chip:active { background: var(--bg-tertiary); }
        .setting-chip .label { color: var(--text-secondary); font-size: 13px; }
        .section-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-md); }
        .chord-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-xl); }
        .chord-card { aspect-ratio: 1; background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary)); border-radius: var(--radius-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-fast); border: 2px solid transparent; position: relative; }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--accent); box-shadow: 0 0 30px rgba(10,132,255,0.3); }
        .chord-name { font-size: 36px; font-weight: 800; }
        .chord-type { font-size: 13px; color: var(--text-secondary); margin-top: 4px; text-align: center; }
        .chord-index { position: absolute; top: 12px; left: 12px; width: 24px; height: 24px; background: rgba(255,255,255,0.1); border-radius: var(--radius-full); font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .action-btn { padding: 18px; border: none; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; font-family: var(--font); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); transition: all var(--transition-fast); }
        .action-btn.primary { background: var(--accent); color: white; }
        .action-btn.secondary { background: var(--bg-secondary); color: var(--text-primary); }
        .action-btn:active { transform: scale(0.97); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .ai-section { background: linear-gradient(135deg, rgba(191,90,242,0.15), rgba(10,132,255,0.15)); border-radius: var(--radius-lg); padding: var(--spacing-lg); }
        .ai-header { display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .ai-badge { background: linear-gradient(135deg, var(--accent-purple), var(--accent)); padding: 4px 10px; border-radius: var(--radius-full); font-size: 12px; font-weight: 600; }
        .ai-title { font-size: 18px; font-weight: 700; }
        .ai-options { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }
        .ai-chip { padding: 10px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: var(--radius-full); color: white; font-size: 14px; font-weight: 500; font-family: var(--font); cursor: pointer; transition: all var(--transition-fast); }
        .ai-chip:active { transform: scale(0.95); }
        .ai-chip:disabled { opacity: 0.5; cursor: not-allowed; }
        .ai-chip.featured { background: linear-gradient(135deg, var(--accent-purple), var(--accent)); }
        .ai-chip.loading { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .produce-tabs { display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); }
        .produce-tab { flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm); background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 600; font-family: var(--font); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all var(--transition-fast); }
        .produce-tab .icon { font-size: 20px; }
        .produce-tab.active { background: var(--bg-tertiary); color: var(--text-primary); }
        .produce-panel { display: none; animation: fadeSlideIn 0.2s ease; }
        .produce-panel.active { display: block; }
        .mixer-channel { background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); }
        .channel-name { font-weight: 600; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
        .fader-container { display: flex; align-items: center; gap: var(--spacing-md); }
        .fader { flex: 1; height: 6px; -webkit-appearance: none; background: var(--bg-tertiary); border-radius: var(--radius-full); }
        .fader::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: var(--radius-full); background: white; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .fader-value { font-size: 14px; font-weight: 600; color: var(--text-secondary); min-width: 40px; text-align: right; }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
        .export-card { background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; cursor: pointer; border: 2px solid transparent; transition: all var(--transition-fast); }
        .export-card:active { border-color: var(--accent); transform: scale(0.97); }
        .export-icon { font-size: 36px; margin-bottom: var(--spacing-sm); }
        .export-title { font-weight: 600; }
        .export-desc { font-size: 12px; color: var(--text-secondary); }
        .transport { position: fixed; bottom: var(--safe-bottom); left: var(--spacing-md); right: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-md); display: flex; align-items: center; justify-content: space-between; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid var(--separator); }
        .transport-left, .transport-right { display: flex; align-items: center; gap: var(--spacing-sm); }
        .transport-center { display: flex; align-items: center; gap: var(--spacing-md); }
        .play-btn { width: 56px; height: 56px; border-radius: var(--radius-full); background: var(--accent); border: none; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 16px rgba(10,132,255,0.4); transition: all var(--transition-fast); }
        .play-btn:active { transform: scale(0.92); }
        .play-btn.playing { background: var(--accent-orange); box-shadow: 0 4px 16px rgba(255,159,10,0.4); }
        .transport-btn { width: 44px; height: 44px; border-radius: var(--radius-md); background: var(--bg-tertiary); border: none; color: var(--text-primary); font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-fast); }
        .transport-btn:active { transform: scale(0.92); }
        .transport-btn.active { background: var(--accent); }
        .tempo-display { background: var(--bg-tertiary); padding: 8px 14px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .bpm-label { color: var(--text-secondary); font-size: 11px; }

        #sheetFlowUI { position: relative; overflow: hidden; }
        .sf-canvas { flex: 1; display: flex; flex-direction: column; padding: var(--spacing-lg); padding-top: calc(var(--safe-top) + var(--spacing-lg)); padding-bottom: calc(var(--safe-bottom) + 100px); overflow-y: auto; }
        .sf-header { position: fixed; top: var(--safe-top); left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm) var(--spacing-lg); z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .sf-logo { font-size: 18px; font-weight: 700; opacity: 0.7; }
        .sf-header-btn { width: 32px; height: 32px; border-radius: var(--radius-full); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 16px; cursor: pointer; }
        .sf-chord-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 50vh; }
        .sf-current-chord { font-size: 100px; font-weight: 900; letter-spacing: -4px; text-shadow: 0 0 60px rgba(10,132,255,0.3); transition: all 0.3s; }
        .sf-current-chord.playing { text-shadow: 0 0 80px rgba(10,132,255,0.6); transform: scale(1.05); }
        .sf-chord-label { font-size: 18px; color: var(--text-secondary); }
        .sf-chord-strip { display: flex; gap: var(--spacing-md); padding: var(--spacing-lg) 0; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .sf-chord-strip::-webkit-scrollbar { display: none; }
        .sf-strip-chord { flex-shrink: 0; width: 70px; height: 70px; background: var(--bg-secondary); border-radius: var(--radius-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; scroll-snap-align: center; border: 2px solid transparent; transition: all var(--transition-fast); }
        .sf-strip-chord.active { border-color: var(--accent); background: rgba(10,132,255,0.2); transform: scale(1.1); }
        .sf-strip-name { font-size: 20px; font-weight: 700; }
        .sf-strip-num { font-size: 11px; color: var(--text-secondary); }
        .sf-gesture-hint { position: fixed; bottom: calc(var(--safe-bottom) + 90px); left: 50%; transform: translateX(-50%); display: flex; gap: var(--spacing-xl); opacity: 0.4; font-size: 12px; color: var(--text-secondary); }
        .sf-panel { position: fixed; top: 0; bottom: 0; width: 85%; max-width: 320px; background: var(--bg-secondary); z-index: 500; transition: transform var(--transition-smooth); display: flex; flex-direction: column; }
        .sf-panel-left { left: 0; transform: translateX(-100%); border-radius: 0 var(--radius-xl) var(--radius-xl) 0; }
        .sf-panel-left.open { transform: translateX(0); }
        .sf-panel-right { right: 0; transform: translateX(100%); border-radius: var(--radius-xl) 0 0 var(--radius-xl); }
        .sf-panel-right.open { transform: translateX(0); }
        .sf-panel-header { padding: calc(var(--safe-top) + var(--spacing-md)) var(--spacing-lg) var(--spacing-md); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--separator); }
        .sf-panel-title { font-size: 20px; font-weight: 700; }
        .sf-panel-close { width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sf-panel-body { flex: 1; overflow-y: auto; padding: var(--spacing-lg); -webkit-overflow-scrolling: touch; }
        .sf-drawer { position: fixed; left: 0; right: 0; bottom: 0; background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; z-index: 500; transform: translateY(calc(100% - 70px)); transition: transform var(--transition-smooth); max-height: 70vh; }
        .sf-drawer.open { transform: translateY(0); }
        .sf-drawer-handle { width: 36px; height: 5px; background: var(--bg-elevated); border-radius: var(--radius-full); margin: 10px auto; cursor: grab; }
        .sf-drawer-peek { display: flex; align-items: center; justify-content: space-around; padding: var(--spacing-sm) var(--spacing-lg); }
        .sf-drawer-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: var(--spacing-sm); }
        .sf-drawer-btn .icon { font-size: 24px; }
        .sf-drawer-btn .label { font-size: 10px; color: var(--text-secondary); }
        .sf-drawer-content { flex: 1; overflow-y: auto; padding: 0 var(--spacing-lg) var(--spacing-lg); display: none; }
        .sf-drawer.open .sf-drawer-content { display: block; }
        .sf-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 400; backdrop-filter: blur(4px); }
        .sf-overlay.active { opacity: 1; visibility: visible; }
        .sf-instrument-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); cursor: pointer; transition: all var(--transition-fast); }
        .sf-instrument-item.selected { background: var(--accent); }
        .sf-instrument-icon { font-size: 28px; }
        .sf-instrument-name { flex: 1; font-weight: 500; }
        .sf-instrument-check { opacity: 0; }
        .sf-instrument-item.selected .sf-instrument-check { opacity: 1; }
        .sf-quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .sf-quick-btn { padding: var(--spacing-lg); background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: var(--spacing-sm); transition: all var(--transition-fast); }
        .sf-quick-btn:active { transform: scale(0.96); }
        .sf-quick-btn .icon { font-size: 32px; }
        .sf-quick-btn .label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .sf-quick-btn.primary { background: linear-gradient(135deg, var(--accent-purple), var(--accent)); }

        #cardDeckUI { position: relative; overflow: hidden; }
        .cd-header { position: fixed; top: var(--safe-top); left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) var(--spacing-lg); z-index: 100; }
        .cd-logo { font-size: 20px; font-weight: 700; }
        .cd-header-btn { width: 36px; height: 36px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 18px; cursor: pointer; }
        .cd-stack-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: calc(var(--safe-top) + 60px) var(--spacing-lg) calc(var(--safe-bottom) + 100px); perspective: 1000px; }
        .cd-card-stack { position: relative; width: 100%; max-width: 350px; height: 450px; }
        .cd-card { position: absolute; width: 100%; height: 100%; background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-xl); display: flex; flex-direction: column; cursor: pointer; transition: all var(--transition-smooth); transform-origin: center bottom; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--separator); overflow: hidden; }
        .cd-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(145deg, rgba(255,255,255,0.05), transparent); pointer-events: none; }
        .cd-card.main { z-index: 10; transform: translateY(0) scale(1); }
        .cd-card.peek-1 { z-index: 9; transform: translateY(20px) scale(0.95); opacity: 0.7; }
        .cd-card.peek-2 { z-index: 8; transform: translateY(40px) scale(0.9); opacity: 0.4; }
        .cd-card.peek-3 { z-index: 7; transform: translateY(60px) scale(0.85); opacity: 0.2; }
        .cd-card.expanded { z-index: 100; position: fixed; top: var(--safe-top); left: var(--spacing-md); right: var(--spacing-md); bottom: calc(var(--safe-bottom) + 80px); height: auto; max-width: none; transform: none; }
        .cd-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-lg); }
        .cd-card-icon { font-size: 32px; }
        .cd-card-label { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .cd-card-close { display: none; width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 16px; cursor: pointer; align-items: center; justify-content: center; }
        .cd-card.expanded .cd-card-close { display: flex; }
        .cd-card-body { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .cd-progression-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cd-big-chord { font-size: 72px; font-weight: 900; margin-bottom: var(--spacing-sm); }
        .cd-chord-info { font-size: 16px; color: var(--text-secondary); margin-bottom: var(--spacing-lg); }
        .cd-mini-chords { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; justify-content: center; }
        .cd-mini-chord { width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: all var(--transition-fast); }
        .cd-mini-chord.active { border-color: var(--accent); background: rgba(10,132,255,0.2); }
        .cd-tool-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); flex: 1; }
        .cd-tool-item { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--spacing-sm); cursor: pointer; transition: all var(--transition-fast); }
        .cd-tool-item:active { transform: scale(0.95); }
        .cd-tool-item .icon { font-size: 28px; }
        .cd-tool-item .label { font-size: 13px; font-weight: 600; }
        .cd-card[data-type="progression"] { background: linear-gradient(145deg, #1a1a2e, #16213e); }
        .cd-card[data-type="ai"] { background: linear-gradient(145deg, #2d1b4e, #1a1a2e); }
        .cd-card[data-type="mixer"] { background: linear-gradient(145deg, #1b3a4b, #1a1a2e); }
        .cd-card[data-type="export"] { background: linear-gradient(145deg, #2e1a1a, #1a1a2e); }
        .cd-transport { position: fixed; bottom: var(--safe-bottom); left: var(--spacing-md); right: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-md); display: flex; align-items: center; justify-content: center; gap: var(--spacing-lg); z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .cd-transport-btn { width: 50px; height: 50px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 20px; cursor: pointer; transition: all var(--transition-fast); }
        .cd-transport-btn:active { transform: scale(0.92); }
        .cd-transport-btn.play { width: 60px; height: 60px; background: var(--accent); font-size: 24px; box-shadow: 0 4px 16px rgba(10,132,255,0.4); }
        .cd-transport-btn.play.playing { background: var(--accent-orange); }
        .cd-card-stack.fanned .cd-card.main { transform: translateY(-80px) rotateX(10deg); }
        .cd-card-stack.fanned .cd-card.peek-1 { transform: translateY(-20px) rotateX(5deg) scale(0.95); opacity: 1; }
        .cd-card-stack.fanned .cd-card.peek-2 { transform: translateY(40px) rotateX(0deg) scale(0.9); opacity: 1; }
        .cd-card-stack.fanned .cd-card.peek-3 { transform: translateY(100px) rotateX(-5deg) scale(0.85); opacity: 1; }

        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 400; backdrop-filter: blur(4px); }
        .sheet-overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; transform: translateY(100%); transition: transform var(--transition-smooth); z-index: 401; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-handle { width: 36px; height: 5px; background: var(--bg-elevated); border-radius: var(--radius-full); margin: 10px auto; }
        .sheet-header { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm) var(--spacing-lg) var(--spacing-md); }
        .sheet-title { font-size: 18px; font-weight: 700; }
        .sheet-close { width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 0 var(--spacing-lg) var(--spacing-lg); -webkit-overflow-scrolling: touch; }
        .option-list { display: flex; flex-direction: column; gap: var(--spacing-xs); }
        .option-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
        .option-item:active { background: var(--bg-elevated); }
        .option-item.selected { background: var(--accent); }
        .option-icon { font-size: 24px; width: 40px; text-align: center; }
        .option-text { flex: 1; }
        .option-title { font-weight: 600; }
        .option-desc { font-size: 13px; color: var(--text-secondary); }
        .option-item.selected .option-desc { color: rgba(255,255,255,0.7); }
        .option-check { opacity: 0; color: white; }
        .option-item.selected .option-check { opacity: 1; }
        .settings-group { margin-bottom: var(--spacing-lg); }
        .settings-group-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); padding-left: var(--spacing-md); }
        .settings-card { background: var(--bg-tertiary); border-radius: var(--radius-md); overflow: hidden; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); border-bottom: 1px solid var(--separator); cursor: pointer; transition: background var(--transition-fast); }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:active { background: var(--bg-elevated); }
        .settings-label { display: flex; align-items: center; gap: var(--spacing-md); }
        .settings-icon { font-size: 22px; }
        .toast { position: fixed; top: calc(var(--safe-top) + 60px); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--bg-elevated); padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius-full); font-size: 15px; font-weight: 500; z-index: 600; opacity: 0; transition: all var(--transition-smooth); box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        @media (min-width: 768px) {
            .chord-grid { grid-template-columns: repeat(4, 1fr); }
            .transport, .cd-transport { left: 50%; right: auto; transform: translateX(-50%); width: 500px; }
            .sf-current-chord { font-size: 160px; }
            .cd-card-stack { max-width: 400px; height: 500px; }
        }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }
    </style>
</head>
<body>
    <div class="onboarding" id="onboarding" role="dialog" aria-labelledby="onboarding-title">
        <div class="onboarding-header">
            <div class="onboarding-logo">üéµ</div>
            <h1 class="onboarding-title" id="onboarding-title">Welcome to ChordFlow</h1>
            <p class="onboarding-subtitle">AI-powered chord progressions for musicians. Choose your preferred interface.</p>
        </div>
        <div class="onboarding-modes" role="radiogroup" aria-label="Choose interface mode">
            <div class="mode-option selected" data-mode="dual" onclick="selectOnboardingMode('dual')" role="radio" aria-checked="true" tabindex="0">
                <span class="mode-option-icon">üì±</span>
                <div class="mode-option-content"><div class="mode-option-title">Dual Mode</div><div class="mode-option-desc">Simple Create/Produce toggle. Best for beginners.</div></div>
                <div class="mode-option-check">‚úì</div>
            </div>
            <div class="mode-option" data-mode="sheet" onclick="selectOnboardingMode('sheet')" role="radio" aria-checked="false" tabindex="0">
                <span class="mode-option-icon">üìÑ</span>
                <div class="mode-option-content"><div class="mode-option-title">Sheet Flow</div><div class="mode-option-desc">Gesture-based with sliding panels. Great for tablets.</div></div>
                <div class="mode-option-check">‚úì</div>
            </div>
            <div class="mode-option" data-mode="cards" onclick="selectOnboardingMode('cards')" role="radio" aria-checked="false" tabindex="0">
                <span class="mode-option-icon">üÉè</span>
                <div class="mode-option-content"><div class="mode-option-title">Card Deck</div><div class="mode-option-desc">Stacked cards you can flip through. Fun and focused.</div></div>
                <div class="mode-option-check">‚úì</div>
            </div>
        </div>
        <div class="onboarding-footer">
            <button class="onboarding-cta" onclick="completeOnboarding()" aria-label="Get started with ChordFlow">üöÄ Get Started</button>
            <button class="onboarding-skip" onclick="skipOnboarding()">I'll explore later</button>
        </div>
    </div>

    <div id="dualModeUI" class="ui-container" role="main" aria-label="Dual Mode Interface">
        <header class="header"><div class="logo">üéµ ChordFlow</div><div class="header-actions"><button class="header-btn" onclick="openSheet('instrument')" aria-label="Change instrument">üéπ</button><button class="header-btn" onclick="openSheet('settings')" aria-label="Settings">‚öôÔ∏è</button></div></header>
        <div class="mode-toggle" role="tablist"><button class="mode-btn active" onclick="setMode('create')" id="createModeBtn" role="tab" aria-selected="true">‚ú® Create</button><button class="mode-btn" onclick="setMode('produce')" id="produceModeBtn" role="tab" aria-selected="false">üéöÔ∏è Produce</button></div>
        <main class="main-content">
            <div class="mode-view active" id="createView" role="tabpanel">
                <div class="settings-row"><button class="setting-chip" onclick="openSheet('key')"><span class="label">Key</span><span id="keyDisplay">C Major</span></button><button class="setting-chip" onclick="openSheet('genre')"><span class="label">Style</span><span id="genreDisplay">Pop</span></button></div>
                <div class="section-title">Your Progression</div>
                <div class="chord-grid" id="chordGrid" role="list"></div>
                <div class="action-row"><button class="action-btn secondary" onclick="generateProgression()">üé≤ Random</button><button class="action-btn primary" onclick="aiGenerate('smart')" id="aiMagicBtn">‚ú® AI Magic</button></div>
                <section class="ai-section" aria-label="AI Tools"><div class="ai-header"><span class="ai-badge">AI ‚ú®</span><span class="ai-title">Gemini Powered</span></div><div class="ai-options"><button class="ai-chip featured" onclick="aiGenerate('surprise')" id="aiSurpriseBtn">üéÅ Surprise Me</button><button class="ai-chip" onclick="aiGenerate('enhance')" id="aiEnhanceBtn">üíé Enhance</button><button class="ai-chip" onclick="aiGenerate('genre')" id="aiGenreBtn">üé∏ Genre Twist</button></div></section>
            </div>
            <div class="mode-view" id="produceView" role="tabpanel">
                <div class="produce-tabs" role="tablist"><button class="produce-tab active" onclick="setProduceTab('mixer')" role="tab"><span class="icon">üéöÔ∏è</span><span>Mixer</span></button><button class="produce-tab" onclick="setProduceTab('export')" role="tab"><span class="icon">üíæ</span><span>Export</span></button></div>
                <div class="produce-panel active" id="mixerPanel" role="tabpanel">
                    <div class="mixer-channel"><div class="channel-name">üéπ Chords</div><div class="fader-container"><input type="range" class="fader" id="chordVolume" min="0" max="100" value="80" aria-label="Chord volume"><span class="fader-value">80%</span></div></div>
                    <div class="mixer-channel"><div class="channel-name">ü•Å Master</div><div class="fader-container"><input type="range" class="fader" id="masterVolume" min="0" max="100" value="100" aria-label="Master volume"><span class="fader-value">100%</span></div></div>
                </div>
                <div class="produce-panel" id="exportPanel" role="tabpanel"><div class="export-grid"><div class="export-card" onclick="exportFile('midi')" role="button" tabindex="0"><div class="export-icon">üéπ</div><div class="export-title">MIDI</div><div class="export-desc">Universal</div></div><div class="export-card" onclick="exportFile('wav')" role="button" tabindex="0"><div class="export-icon">üéµ</div><div class="export-title">WAV</div><div class="export-desc">Lossless</div></div></div></div>
            </div>
        </main>
        <div class="transport" role="toolbar" aria-label="Playback controls">
            <div class="transport-left"><button class="transport-btn" onclick="openSheet('instrument')" id="instrumentBtn" aria-label="Instrument">üéπ</button></div>
            <div class="transport-center"><button class="transport-btn" onclick="stopPlayback()" aria-label="Stop">‚èπÔ∏è</button><button class="play-btn" onclick="togglePlay()" id="playBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button><div class="tempo-display" onclick="openSheet('tempo')" role="button" tabindex="0" aria-label="Tempo"><span id="tempoValue">120</span><span class="bpm-label">BPM</span></div></div>
            <div class="transport-right"><button class="transport-btn" onclick="toggleLoop()" id="loopBtn" aria-label="Toggle loop">üîÅ</button></div>
        </div>
    </div>

    <div id="sheetFlowUI" class="ui-container" role="main" aria-label="Sheet Flow Interface">
        <div class="sf-header"><div class="sf-logo">üéµ ChordFlow</div><button class="sf-header-btn" onclick="openSheet('settings')" aria-label="Settings">‚öôÔ∏è</button></div>
        <div class="sf-canvas" id="sfCanvas">
            <div class="sf-chord-display"><div class="sf-current-chord" id="sfCurrentChord" aria-live="polite">Am</div><div class="sf-chord-label" id="sfChordLabel">A minor ‚Ä¢ Chord 1 of 4</div></div>
            <div class="sf-chord-strip" id="sfChordStrip" role="list"></div>
        </div>
        <div class="sf-gesture-hint" aria-hidden="true"><span>‚Üê Instruments</span><span>‚Üë Tools</span><span>Sections ‚Üí</span></div>
        <div class="sf-panel sf-panel-left" id="sfLeftPanel" role="dialog" aria-label="Instruments"><div class="sf-panel-header"><div class="sf-panel-title">üéπ Instruments</div><button class="sf-panel-close" onclick="closeSFPanel('left')" aria-label="Close">‚úï</button></div><div class="sf-panel-body" id="sfInstrumentList"></div></div>
        <div class="sf-panel sf-panel-right" id="sfRightPanel" role="dialog" aria-label="Sections"><div class="sf-panel-header"><div class="sf-panel-title">üìë Sections</div><button class="sf-panel-close" onclick="closeSFPanel('right')" aria-label="Close">‚úï</button></div><div class="sf-panel-body"><div class="option-list"><div class="option-item selected"><span class="option-icon">üéµ</span><div class="option-text"><div class="option-title">Verse</div></div></div><div class="option-item"><span class="option-icon">üé§</span><div class="option-text"><div class="option-title">Chorus</div></div></div></div></div></div>
        <div class="sf-drawer" id="sfDrawer"><div class="sf-drawer-handle" onclick="toggleSFDrawer()" role="button" aria-label="Toggle drawer"></div><div class="sf-drawer-peek"><div class="sf-drawer-btn" onclick="togglePlay()"><span class="icon" id="sfPlayIcon">‚ñ∂Ô∏è</span><span class="label">Play</span></div><div class="sf-drawer-btn" onclick="generateProgression()"><span class="icon">üé≤</span><span class="label">Random</span></div><div class="sf-drawer-btn" onclick="aiGenerate('smart')"><span class="icon">‚ú®</span><span class="label">AI</span></div><div class="sf-drawer-btn" onclick="openSFPanel('left')"><span class="icon">üéπ</span><span class="label">Sound</span></div></div><div class="sf-drawer-content"><div class="section-title">Quick Actions</div><div class="sf-quick-actions"><button class="sf-quick-btn primary" onclick="aiGenerate('surprise')"><span class="icon">üéÅ</span><span class="label">Surprise</span></button><button class="sf-quick-btn" onclick="aiGenerate('enhance')"><span class="icon">üíé</span><span class="label">Enhance</span></button></div></div></div>
        <div class="sf-overlay" id="sfOverlay" onclick="closeAllSFPanels()"></div>
    </div>

    <div id="cardDeckUI" class="ui-container" role="main" aria-label="Card Deck Interface">
        <div class="cd-header"><div class="cd-logo">üéµ ChordFlow</div><button class="cd-header-btn" onclick="openSheet('settings')" aria-label="Settings">‚öôÔ∏è</button></div>
        <div class="cd-stack-container">
            <div class="cd-card-stack" id="cdCardStack">
                <div class="cd-card main" data-type="progression" onclick="cdExpandCard(this)"><div class="cd-card-header"><span class="cd-card-icon">üéµ</span><span class="cd-card-label">Progression</span><button class="cd-card-close" onclick="event.stopPropagation(); cdCollapseCard()" aria-label="Close">‚úï</button></div><div class="cd-card-body"><div class="cd-progression-display"><div class="cd-big-chord" id="cdBigChord">Am</div><div class="cd-chord-info" id="cdChordInfo">A minor ‚Ä¢ 1 of 4</div><div class="cd-mini-chords" id="cdMiniChords"></div></div></div></div>
                <div class="cd-card peek-1" data-type="ai" onclick="cdExpandCard(this)"><div class="cd-card-header"><span class="cd-card-icon">‚ú®</span><span class="cd-card-label">AI Tools</span><button class="cd-card-close" onclick="event.stopPropagation(); cdCollapseCard()" aria-label="Close">‚úï</button></div><div class="cd-card-body"><div class="cd-tool-grid"><div class="cd-tool-item" onclick="event.stopPropagation(); aiGenerate('smart')"><span class="icon">‚ú®</span><span class="label">AI Magic</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); aiGenerate('surprise')"><span class="icon">üéÅ</span><span class="label">Surprise</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); aiGenerate('enhance')"><span class="icon">üíé</span><span class="label">Enhance</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); generateProgression()"><span class="icon">üé≤</span><span class="label">Random</span></div></div></div></div>
                <div class="cd-card peek-2" data-type="mixer" onclick="cdExpandCard(this)"><div class="cd-card-header"><span class="cd-card-icon">üéöÔ∏è</span><span class="cd-card-label">Mixer</span><button class="cd-card-close" onclick="event.stopPropagation(); cdCollapseCard()" aria-label="Close">‚úï</button></div><div class="cd-card-body"><div class="mixer-channel"><div class="channel-name">üéπ Chords</div><div class="fader-container"><input type="range" class="fader chord-vol" min="0" max="100" value="80"><span class="fader-value">80%</span></div></div><div class="mixer-channel"><div class="channel-name">ü•Å Master</div><div class="fader-container"><input type="range" class="fader master-vol" min="0" max="100" value="100"><span class="fader-value">100%</span></div></div></div></div>
                <div class="cd-card peek-3" data-type="export" onclick="cdExpandCard(this)"><div class="cd-card-header"><span class="cd-card-icon">üíæ</span><span class="cd-card-label">Export</span><button class="cd-card-close" onclick="event.stopPropagation(); cdCollapseCard()" aria-label="Close">‚úï</button></div><div class="cd-card-body"><div class="cd-tool-grid"><div class="cd-tool-item" onclick="event.stopPropagation(); exportFile('midi')"><span class="icon">üéπ</span><span class="label">MIDI</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); exportFile('wav')"><span class="icon">üéµ</span><span class="label">WAV</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); exportFile('mp3')"><span class="icon">üìÄ</span><span class="label">MP3</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); exportFile('pdf')"><span class="icon">üìÑ</span><span class="label">PDF</span></div></div></div></div>
            </div>
        </div>
        <div class="cd-transport" role="toolbar" aria-label="Playback controls"><button class="cd-transport-btn" onclick="openSheet('instrument')" aria-label="Instrument">üéπ</button><button class="cd-transport-btn" onclick="stopPlayback()" aria-label="Stop">‚èπÔ∏è</button><button class="cd-transport-btn play" onclick="togglePlay()" id="cdPlayBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button><button class="cd-transport-btn" onclick="toggleLoop()" id="cdLoopBtn" aria-label="Toggle loop">üîÅ</button><button class="cd-transport-btn" onclick="openSheet('tempo')" aria-label="Tempo">‚è±Ô∏è</button></div>
    </div>

    <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
    <div class="bottom-sheet" id="instrumentSheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">üéπ Instrument</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div class="option-list" id="instrumentList"></div></div></div>
    <div class="bottom-sheet" id="keySheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">üéµ Key</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div class="settings-group-title">Major Keys</div><div class="option-list" id="majorKeyList"></div><div class="settings-group-title" style="margin-top:16px;">Minor Keys</div><div class="option-list" id="minorKeyList"></div></div></div>
    <div class="bottom-sheet" id="genreSheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">üé® Style</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div class="option-list" id="genreList"></div></div></div>
    <div class="bottom-sheet" id="tempoSheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">‚è±Ô∏è Tempo</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div style="text-align: center; padding: 20px 0;"><div style="font-size: 64px; font-weight: 800;" id="tempoLarge">120</div><div style="color: var(--text-secondary);">BPM</div></div><input type="range" class="fader" min="60" max="200" value="120" id="tempoSlider" style="width: 100%; margin: 20px 0;" aria-label="Tempo"><div style="display: flex; gap: 10px;"><button class="action-btn secondary" onclick="setTempo(80)" style="flex:1;">Slow</button><button class="action-btn secondary" onclick="setTempo(120)" style="flex:1;">Normal</button><button class="action-btn secondary" onclick="setTempo(160)" style="flex:1;">Fast</button></div></div></div>
    <div class="bottom-sheet" id="settingsSheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">‚öôÔ∏è Settings</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div class="settings-group"><div class="settings-group-title">Interface</div><div class="settings-card"><div class="settings-item" onclick="openSheet('uiMode')"><div class="settings-label"><span class="settings-icon">üé®</span><span>UI Mode</span></div><span style="color: var(--text-secondary);" id="currentUILabel">Dual Mode ‚Ä∫</span></div><div class="settings-item" onclick="resetOnboarding()"><div class="settings-label"><span class="settings-icon">üîÑ</span><span>Show Welcome Screen</span></div><span style="color: var(--text-secondary);">‚Ä∫</span></div></div></div><div class="settings-group"><div class="settings-group-title">About</div><div class="settings-card"><div class="settings-item"><div class="settings-label"><span class="settings-icon">‚ÑπÔ∏è</span><span>Version</span></div><span style="color: var(--text-secondary);">0.57</span></div><div class="settings-item"><div class="settings-label"><span class="settings-icon">ü§ñ</span><span>AI</span></div><span style="color: var(--accent);">Gemini</span></div></div></div></div></div>
    <div class="bottom-sheet" id="uiModeSheet"><div class="sheet-handle"></div><div class="sheet-header"><div class="sheet-title">üé® UI Mode</div><button class="sheet-close" onclick="closeSheet()" aria-label="Close">‚úï</button></div><div class="sheet-body"><div class="option-list"><div class="option-item" id="uiModeDual" onclick="switchUIMode('dual')"><span class="option-icon">üì±</span><div class="option-text"><div class="option-title">Dual Mode</div><div class="option-desc">Create & Produce toggle</div></div><span class="option-check">‚úì</span></div><div class="option-item" id="uiModeSheet" onclick="switchUIMode('sheet')"><span class="option-icon">üìÑ</span><div class="option-text"><div class="option-title">Sheet Flow</div><div class="option-desc">Gesture-based panels</div></div><span class="option-check">‚úì</span></div><div class="option-item" id="uiModeCards" onclick="switchUIMode('cards')"><span class="option-icon">üÉè</span><div class="option-text"><div class="option-title">Card Deck</div><div class="option-desc">Stacked cards to flip through</div></div><span class="option-check">‚úì</span></div></div></div></div>
    <div class="toast" id="toast" role="alert" aria-live="polite"></div>

    <script>
        const VERSION = '0.57';
        const GEMINI_API_KEY = 'AIzaSyBR1mD1zdnn39IbaQQs99mL5nFxsoNB9dM';
        
        const state = {
            uiMode: localStorage.getItem('chordflow-ui') || 'dual',
            onboardingComplete: localStorage.getItem('chordflow-onboarding') === 'complete',
            selectedOnboardingMode: 'dual',
            mode: 'create', produceTab: 'mixer', tempo: 120, 
            key: 'C', scale: 'major',
            genre: 'pop',
            isPlaying: false, isLooping: true, 
            progression: ['Am', 'F', 'C', 'G'],
            currentChordIndex: 0, 
            instrument: 'grand-piano', 
            playInterval: null,
            chordVolume: 80,
            masterVolume: 100,
            aiLoading: false
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPANDED MUSIC THEORY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const NOTE_ORDER = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const FLAT_TO_SHARP = { 'Db': 'C#', 'Eb': 'D#', 'Fb': 'E', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B' };
        
        // Major and Minor keys
        const majorKeys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const minorKeys = ['Am', 'A#m', 'Bm', 'Cm', 'C#m', 'Dm', 'D#m', 'Em', 'Fm', 'F#m', 'Gm', 'G#m'];
        
        const genres = [
            { id: 'pop', name: 'Pop', icon: 'üé§' }, 
            { id: 'rock', name: 'Rock', icon: 'üé∏' }, 
            { id: 'jazz', name: 'Jazz', icon: 'üé∑' }, 
            { id: 'electronic', name: 'Electronic', icon: 'üéß' }, 
            { id: 'classical', name: 'Classical', icon: 'üéª' }, 
            { id: 'rnb', name: 'R&B / Soul', icon: 'üé§' },
            { id: 'folk', name: 'Folk / Country', icon: 'ü™ï' },
            { id: 'blues', name: 'Blues', icon: 'üé∫' }
        ];
        
        // EXPANDED PROGRESSIONS (5+ per genre)
        const PROGRESSIONS = {
            pop: [
                ['C', 'G', 'Am', 'F'],
                ['Am', 'F', 'C', 'G'],
                ['G', 'D', 'Em', 'C'],
                ['C', 'Am', 'F', 'G'],
                ['F', 'G', 'Am', 'G'],
                ['C', 'F', 'Am', 'G'],
                ['Am', 'G', 'F', 'G'],
                ['C', 'G', 'F', 'G']
            ],
            rock: [
                ['A', 'D', 'E', 'A'],
                ['G', 'C', 'D', 'G'],
                ['E', 'A', 'D', 'E'],
                ['Am', 'G', 'F', 'E'],
                ['D', 'A', 'Bm', 'G'],
                ['E', 'B', 'C#m', 'A'],
                ['G', 'D', 'C', 'G'],
                ['A', 'E', 'F#m', 'D']
            ],
            jazz: [
                ['Dm7', 'G7', 'Cmaj7', 'Am7'],
                ['Am7', 'D7', 'Gmaj7', 'Cmaj7'],
                ['Cm7', 'F7', 'Bbmaj7', 'Ebmaj7'],
                ['Em7', 'A7', 'Dm7', 'G7'],
                ['Fmaj7', 'Fm7', 'Em7', 'A7'],
                ['Dm7', 'Db7', 'Cmaj7', 'Bmaj7'],
                ['Cmaj7', 'Am7', 'Dm7', 'G7']
            ],
            electronic: [
                ['Am', 'Em', 'F', 'G'],
                ['Cm', 'Gm', 'Ab', 'Bb'],
                ['Dm', 'Am', 'Bb', 'C'],
                ['Em', 'C', 'G', 'D'],
                ['Am', 'F', 'Dm', 'E'],
                ['Fm', 'Cm', 'Ab', 'Eb'],
                ['Bm', 'G', 'D', 'A']
            ],
            classical: [
                ['C', 'Am', 'F', 'G'],
                ['G', 'Em', 'C', 'D'],
                ['Am', 'E', 'Am', 'Dm'],
                ['F', 'Dm', 'G', 'C'],
                ['D', 'G', 'A', 'D'],
                ['C', 'G', 'Am', 'Em', 'F', 'C', 'F', 'G']
            ],
            rnb: [
                ['Dm7', 'G7', 'Cmaj7', 'Am7'],
                ['Em7', 'Am7', 'Dm7', 'G7'],
                ['Gm7', 'C7', 'Fmaj7', 'Dm7'],
                ['Am7', 'Dm7', 'G7', 'Cmaj7'],
                ['Fm7', 'Bb7', 'Ebmaj7', 'Cm7'],
                ['Bm7', 'E7', 'Amaj7', 'F#m7']
            ],
            folk: [
                ['G', 'C', 'D', 'G'],
                ['C', 'F', 'G', 'C'],
                ['D', 'G', 'A', 'D'],
                ['Am', 'C', 'G', 'D'],
                ['E', 'A', 'B', 'E'],
                ['G', 'Em', 'C', 'D'],
                ['A', 'D', 'E', 'A']
            ],
            blues: [
                ['A7', 'D7', 'A7', 'E7'],
                ['E7', 'A7', 'B7', 'E7'],
                ['G7', 'C7', 'G7', 'D7'],
                ['Am', 'Dm', 'Am', 'E7'],
                ['Dm7', 'G7', 'Dm7', 'A7'],
                ['C7', 'F7', 'C7', 'G7']
            ]
        };

        // EXPANDED CHORD NOTES (7ths, maj7, dim, aug, sus)
        const CHORD_NOTES = {
            // Major
            'C': ['C4','E4','G4'], 'D': ['D4','F#4','A4'], 'E': ['E4','G#4','B4'], 
            'F': ['F4','A4','C5'], 'G': ['G4','B4','D5'], 'A': ['A4','C#5','E5'], 'B': ['B4','D#5','F#5'],
            'C#': ['C#4','F4','G#4'], 'D#': ['D#4','G4','A#4'], 'F#': ['F#4','A#4','C#5'], 
            'G#': ['G#4','C5','D#5'], 'A#': ['A#4','D5','F5'],
            'Db': ['C#4','F4','G#4'], 'Eb': ['D#4','G4','A#4'], 'Gb': ['F#4','A#4','C#5'], 
            'Ab': ['G#4','C5','D#5'], 'Bb': ['A#4','D5','F5'],
            
            // Minor
            'Cm': ['C4','Eb4','G4'], 'Dm': ['D4','F4','A4'], 'Em': ['E4','G4','B4'],
            'Fm': ['F4','Ab4','C5'], 'Gm': ['G4','Bb4','D5'], 'Am': ['A4','C5','E5'], 'Bm': ['B4','D5','F#5'],
            'C#m': ['C#4','E4','G#4'], 'D#m': ['D#4','F#4','A#4'], 'F#m': ['F#4','A4','C#5'],
            'G#m': ['G#4','B4','D#5'], 'A#m': ['A#4','C#5','F5'],
            
            // 7ths
            'C7': ['C4','E4','G4','Bb4'], 'D7': ['D4','F#4','A4','C5'], 'E7': ['E4','G#4','B4','D5'],
            'F7': ['F4','A4','C5','Eb5'], 'G7': ['G4','B4','D5','F5'], 'A7': ['A4','C#5','E5','G5'], 'B7': ['B4','D#5','F#5','A5'],
            
            // Minor 7ths
            'Cm7': ['C4','Eb4','G4','Bb4'], 'Dm7': ['D4','F4','A4','C5'], 'Em7': ['E4','G4','B4','D5'],
            'Fm7': ['F4','Ab4','C5','Eb5'], 'Gm7': ['G4','Bb4','D5','F5'], 'Am7': ['A4','C5','E5','G5'], 'Bm7': ['B4','D5','F#5','A5'],
            'F#m7': ['F#4','A4','C#5','E5'],
            
            // Major 7ths
            'Cmaj7': ['C4','E4','G4','B4'], 'Dmaj7': ['D4','F#4','A4','C#5'], 'Emaj7': ['E4','G#4','B4','D#5'],
            'Fmaj7': ['F4','A4','C5','E5'], 'Gmaj7': ['G4','B4','D5','F#5'], 'Amaj7': ['A4','C#5','E5','G#5'], 'Bmaj7': ['B4','D#5','F#5','A#5'],
            'Bbmaj7': ['A#4','D5','F5','A5'], 'Ebmaj7': ['D#4','G4','A#4','D5'],
            
            // Diminished
            'Cdim': ['C4','Eb4','Gb4'], 'Ddim': ['D4','F4','Ab4'], 'Edim': ['E4','G4','Bb4'],
            'Bdim': ['B4','D5','F5'],
            
            // Augmented
            'Caug': ['C4','E4','G#4'], 'Daug': ['D4','F#4','A#4'], 'Eaug': ['E4','G#4','C5'],
            
            // Sus2 & Sus4
            'Csus2': ['C4','D4','G4'], 'Csus4': ['C4','F4','G4'],
            'Dsus2': ['D4','E4','A4'], 'Dsus4': ['D4','G4','A4'],
            'Gsus2': ['G4','A4','D5'], 'Gsus4': ['G4','C5','D5'],
            'Asus2': ['A4','B4','E5'], 'Asus4': ['A4','D5','E5'],
            
            // Additional jazz chords
            'Db7': ['C#4','F4','G#4','B4']
        };
        
        function normalizeNote(note) { return FLAT_TO_SHARP[note] || note; }
        
        function transposeChord(chord, semitones) {
            const match = chord.match(/^([A-G][#b]?)(.*)$/);
            if (!match) return chord;
            let [, root, quality] = match;
            root = normalizeNote(root);
            const rootIndex = NOTE_ORDER.indexOf(root);
            if (rootIndex === -1) return chord;
            const newIndex = (rootIndex + semitones + 12) % 12;
            return NOTE_ORDER[newIndex] + quality;
        }
        
        function getKeyInfo() {
            const isMinor = state.key.includes('m');
            const root = state.key.replace('m', '');
            return { isMinor, root, display: isMinor ? `${root} Minor` : `${state.key} Major` };
        }
        
        function getTransposedProgression() {
            const keyInfo = getKeyInfo();
            const keyRoot = normalizeNote(keyInfo.root);
            const baseRoot = keyInfo.isMinor ? 'A' : 'C';
            const keyIndex = NOTE_ORDER.indexOf(keyRoot);
            const baseIndex = NOTE_ORDER.indexOf(baseRoot);
            const semitones = keyIndex - baseIndex;
            return state.progression.map(chord => transposeChord(chord, semitones));
        }

        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ', type: 'triangle', attack: 0.02, decay: 1.2, sustain: 0.3, release: 1.5 },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ', type: 'sine', attack: 0.01, decay: 0.8, sustain: 0.4, release: 1.0 },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß', type: 'sawtooth', attack: 0.5, decay: 0.3, sustain: 0.8, release: 2.0 },
            { id: 'acoustic-guitar', name: 'Acoustic Guitar', icon: 'üé∏', type: 'triangle', attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.8 },
            { id: 'strings', name: 'Strings', icon: 'üéª', type: 'sawtooth', attack: 0.3, decay: 0.2, sustain: 0.7, release: 1.5 },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è', type: 'square', attack: 0.01, decay: 0.1, sustain: 0.9, release: 0.3 }
        ];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUDIO ENGINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let audioInit = false, mainSynth = null, masterGain = null;
        
        async function initAudio() {
            if (audioInit) return;
            await Tone.start();
            masterGain = new Tone.Gain(state.masterVolume / 100).toDestination();
            createSynth();
            audioInit = true;
        }
        
        function createSynth() {
            if (mainSynth) { mainSynth.disconnect(); mainSynth.dispose(); }
            const inst = instruments.find(i => i.id === state.instrument) || instruments[0];
            mainSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: inst.type },
                envelope: { attack: inst.attack, decay: inst.decay, sustain: inst.sustain, release: inst.release }
            });
            mainSynth.volume.value = Tone.gainToDb(state.chordVolume / 100);
            mainSynth.connect(masterGain);
        }
        
        function updateVolume() {
            if (mainSynth) mainSynth.volume.value = Tone.gainToDb(state.chordVolume / 100);
            if (masterGain) masterGain.gain.value = state.masterVolume / 100;
        }
        
        function getChordNotes(chord) {
            if (CHORD_NOTES[chord]) return CHORD_NOTES[chord];
            const base = chord.replace('7', '').replace('maj', '').replace('dim', '').replace('aug', '').replace('sus2', '').replace('sus4', '');
            if (CHORD_NOTES[base]) return CHORD_NOTES[base];
            return CHORD_NOTES['C'];
        }

        async function playChord(chord, duration = '2n') {
            await initAudio();
            const notes = getChordNotes(chord);
            mainSynth.triggerAttackRelease(notes, duration);
            if (navigator.vibrate) navigator.vibrate(10);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GEMINI AI INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function callGeminiAI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.8, maxOutputTokens: 200 }
                    })
                });
                
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error('Gemini API error:', error);
                return null;
            }
        }
        
        function parseChordResponse(text) {
            // Extract chord symbols from AI response
            const chordPattern = /[A-G][#b]?(m|maj|dim|aug|sus[24])?7?/g;
            const matches = text.match(chordPattern);
            if (matches && matches.length >= 3) {
                // Take first 4-8 unique valid chords
                const validChords = matches.filter(c => CHORD_NOTES[c] || CHORD_NOTES[c.replace('7','')]);
                return validChords.slice(0, Math.min(8, Math.max(4, validChords.length)));
            }
            return null;
        }
        
        async function aiGenerate(type) {
            if (state.aiLoading) return;
            state.aiLoading = true;
            setAIButtonsLoading(true);
            
            const keyInfo = getKeyInfo();
            let prompt = '';
            
            switch(type) {
                case 'smart':
                    prompt = `Generate a ${state.genre} chord progression in ${keyInfo.display}. Give me exactly 4 chords. Just list the chord names separated by spaces, nothing else. Example: Am F C G`;
                    break;
                case 'surprise':
                    const surpriseGenres = ['jazz', 'pop', 'rock', 'electronic', 'classical', 'rnb', 'blues'];
                    const randomGenre = surpriseGenres[Math.floor(Math.random() * surpriseGenres.length)];
                    prompt = `Generate a surprising and creative ${randomGenre} chord progression. Use some unexpected chord changes. Give me 4-6 chords. Just list the chord names separated by spaces. Can include 7ths, maj7, m7 chords.`;
                    break;
                case 'enhance':
                    const currentChords = getTransposedProgression().join(' ');
                    prompt = `Take this chord progression: ${currentChords} and make it more interesting by adding 7ths, substitutions, or passing chords. Give me 4-6 enhanced chords. Just list the chord names separated by spaces.`;
                    break;
                case 'genre':
                    const genres = ['jazz', 'blues', 'electronic', 'classical'];
                    const targetGenre = genres[Math.floor(Math.random() * genres.length)];
                    const original = getTransposedProgression().join(' ');
                    prompt = `Transform this progression: ${original} into ${targetGenre} style. Give me 4-6 chords. Just list the chord names separated by spaces.`;
                    break;
            }
            
            showToast('‚ú® Asking Gemini AI...');
            
            const response = await callGeminiAI(prompt);
            const chords = response ? parseChordResponse(response) : null;
            
            if (chords && chords.length >= 3) {
                state.progression = chords;
                state.currentChordIndex = 0;
                renderAll();
                showToast(`‚ú® AI generated ${chords.length} chords!`);
            } else {
                // Fallback to local generation
                generateProgression();
                showToast('üé≤ Used smart fallback');
            }
            
            state.aiLoading = false;
            setAIButtonsLoading(false);
        }
        
        function setAIButtonsLoading(loading) {
            const buttons = ['aiMagicBtn', 'aiSurpriseBtn', 'aiEnhanceBtn', 'aiGenreBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = loading;
                    btn.classList.toggle('loading', loading);
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ONBOARDING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function selectOnboardingMode(mode) {
            state.selectedOnboardingMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => {
                const isSelected = el.dataset.mode === mode;
                el.classList.toggle('selected', isSelected);
                el.setAttribute('aria-checked', isSelected);
            });
        }

        function completeOnboarding() {
            state.uiMode = state.selectedOnboardingMode;
            localStorage.setItem('chordflow-ui', state.uiMode);
            localStorage.setItem('chordflow-onboarding', 'complete');
            state.onboardingComplete = true;
            document.getElementById('onboarding').classList.add('hidden');
            setTimeout(() => { document.getElementById('onboarding').style.display = 'none'; activateUI(); }, 500);
        }

        function skipOnboarding() {
            localStorage.setItem('chordflow-onboarding', 'complete');
            state.onboardingComplete = true;
            document.getElementById('onboarding').classList.add('hidden');
            setTimeout(() => { document.getElementById('onboarding').style.display = 'none'; activateUI(); }, 500);
        }

        function resetOnboarding() {
            localStorage.removeItem('chordflow-onboarding');
            closeSheet();
            showToast('üîÑ Reloading...');
            setTimeout(() => location.reload(), 500);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI MODES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function activateUI() {
            const uiMap = { dual: 'dualModeUI', sheet: 'sheetFlowUI', cards: 'cardDeckUI' };
            document.querySelectorAll('.ui-container').forEach(c => c.classList.remove('active'));
            document.getElementById(uiMap[state.uiMode]).classList.add('active');
            updateUISelectors();
            renderAll();
        }

        function switchUIMode(mode) {
            state.uiMode = mode;
            localStorage.setItem('chordflow-ui', mode);
            activateUI();
            closeSheet();
            showToast({ dual: 'üì± Dual Mode', sheet: 'üìÑ Sheet Flow', cards: 'üÉè Card Deck' }[mode]);
        }

        function updateUISelectors() {
            document.getElementById('uiModeDual').classList.toggle('selected', state.uiMode === 'dual');
            document.getElementById('uiModeSheet').classList.toggle('selected', state.uiMode === 'sheet');
            document.getElementById('uiModeCards').classList.toggle('selected', state.uiMode === 'cards');
            document.getElementById('currentUILabel').textContent = { dual: 'Dual Mode ‚Ä∫', sheet: 'Sheet Flow ‚Ä∫', cards: 'Card Deck ‚Ä∫' }[state.uiMode];
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DUAL MODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setMode(mode) {
            state.mode = mode;
            document.getElementById('createModeBtn').classList.toggle('active', mode === 'create');
            document.getElementById('produceModeBtn').classList.toggle('active', mode === 'produce');
            document.getElementById('createView').classList.toggle('active', mode === 'create');
            document.getElementById('produceView').classList.toggle('active', mode === 'produce');
        }

        function setProduceTab(tab) {
            state.produceTab = tab;
            document.querySelectorAll('.produce-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.produce-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.produce-tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}Panel`).classList.add('active');
        }

        function getChordTypeLabel(chord) {
            if (chord.includes('maj7')) return 'major 7th';
            if (chord.includes('m7')) return 'minor 7th';
            if (chord.includes('7')) return 'dominant 7th';
            if (chord.includes('dim')) return 'diminished';
            if (chord.includes('aug')) return 'augmented';
            if (chord.includes('sus4')) return 'sus4';
            if (chord.includes('sus2')) return 'sus2';
            if (chord.includes('m')) return 'minor';
            return 'major';
        }

        function renderChords() {
            const grid = document.getElementById('chordGrid');
            if (!grid) return;
            const displayChords = getTransposedProgression();
            grid.innerHTML = displayChords.map((chord, i) => `
                <div class="chord-card ${state.currentChordIndex === i && state.isPlaying ? 'playing' : ''}" onclick="playChordAtIndex(${i})" role="listitem" tabindex="0">
                    <div class="chord-index">${i + 1}</div>
                    <div class="chord-name">${chord}</div>
                    <div class="chord-type">${getChordTypeLabel(chord)}</div>
                </div>
            `).join('');
        }

        async function playChordAtIndex(i) { 
            state.currentChordIndex = i; 
            renderAll(); 
            const displayChords = getTransposedProgression();
            await playChord(displayChords[i], '4n'); 
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SHEET FLOW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderSheetFlowUI() {
            const displayChords = getTransposedProgression();
            const chord = displayChords[state.currentChordIndex] || 'C';
            const el = document.getElementById('sfCurrentChord');
            if (el) { el.textContent = chord; el.classList.toggle('playing', state.isPlaying); }
            const label = document.getElementById('sfChordLabel');
            if (label) label.textContent = `${getChordTypeLabel(chord)} ‚Ä¢ Chord ${state.currentChordIndex+1} of ${displayChords.length}`;
            
            const strip = document.getElementById('sfChordStrip');
            if (strip) strip.innerHTML = displayChords.map((c, i) => `<div class="sf-strip-chord ${i === state.currentChordIndex ? 'active' : ''}" onclick="sfSelectChord(${i})" role="listitem"><div class="sf-strip-name">${c}</div><div class="sf-strip-num">${i+1}</div></div>`).join('');
            
            const list = document.getElementById('sfInstrumentList');
            if (list) list.innerHTML = instruments.map(inst => `<div class="sf-instrument-item ${state.instrument === inst.id ? 'selected' : ''}" onclick="sfSelectInstrument('${inst.id}')"><span class="sf-instrument-icon">${inst.icon}</span><span class="sf-instrument-name">${inst.name}</span><span class="sf-instrument-check">‚úì</span></div>`).join('');
        }

        function sfSelectChord(i) { state.currentChordIndex = i; renderAll(); const displayChords = getTransposedProgression(); playChord(displayChords[i], '4n'); }
        function sfSelectInstrument(id) { state.instrument = id; if (audioInit) createSynth(); renderSheetFlowUI(); closeSFPanel('left'); showToast(`${instruments.find(i=>i.id===id).icon} ${instruments.find(i=>i.id===id).name}`); }
        function openSFPanel(side) { document.getElementById('sfOverlay').classList.add('active'); document.getElementById(side==='left'?'sfLeftPanel':'sfRightPanel').classList.add('open'); }
        function closeSFPanel(side) { document.getElementById('sfOverlay').classList.remove('active'); document.getElementById(side==='left'?'sfLeftPanel':'sfRightPanel').classList.remove('open'); }
        function closeAllSFPanels() { document.getElementById('sfOverlay').classList.remove('active'); document.querySelectorAll('.sf-panel').forEach(p => p.classList.remove('open')); document.getElementById('sfDrawer').classList.remove('open'); }
        function toggleSFDrawer() { document.getElementById('sfDrawer').classList.toggle('open'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CARD DECK
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderCardDeckUI() {
            const displayChords = getTransposedProgression();
            const chord = displayChords[state.currentChordIndex] || 'C';
            const el = document.getElementById('cdBigChord');
            if (el) el.textContent = chord;
            const info = document.getElementById('cdChordInfo');
            if (info) info.textContent = `${getChordTypeLabel(chord)} ‚Ä¢ ${state.currentChordIndex+1} of ${displayChords.length}`;
            const mini = document.getElementById('cdMiniChords');
            if (mini) mini.innerHTML = displayChords.map((c, i) => `<div class="cd-mini-chord ${i === state.currentChordIndex ? 'active' : ''}" onclick="cdSelectChord(${i})">${c}</div>`).join('');
        }

        function cdSelectChord(i) { state.currentChordIndex = i; renderAll(); const displayChords = getTransposedProgression(); playChord(displayChords[i], '4n'); }
        let cdExpandedCard = null;
        function cdExpandCard(card) { if (cdExpandedCard) return; cdExpandedCard = card; card.classList.add('expanded'); }
        function cdCollapseCard() { if (cdExpandedCard) { cdExpandedCard.classList.remove('expanded'); cdExpandedCard = null; } }
        let cdTouchStartY = 0;
        function initCDGestures() {
            const stack = document.getElementById('cdCardStack');
            if (!stack) return;
            stack.addEventListener('touchstart', e => { cdTouchStartY = e.touches[0].clientY; }, { passive: true });
            stack.addEventListener('touchmove', e => { if (e.touches[0].clientY - cdTouchStartY > 50 && !cdExpandedCard) stack.classList.add('fanned'); }, { passive: true });
            stack.addEventListener('touchend', () => { stack.classList.remove('fanned'); }, { passive: true });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PLAYBACK
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function togglePlay() {
            await initAudio();
            state.isPlaying = !state.isPlaying;
            updatePlayButtons();
            if (state.isPlaying) startPlayback(); else stopPlayback();
        }

        function updatePlayButtons() {
            const icon = state.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            ['playBtn', 'sfPlayIcon', 'cdPlayBtn'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = icon; });
            document.getElementById('playBtn')?.classList.toggle('playing', state.isPlaying);
            document.getElementById('cdPlayBtn')?.classList.toggle('playing', state.isPlaying);
        }

        function startPlayback() {
            const interval = (60 / state.tempo) * 2000;
            playCurrentChord();
            state.playInterval = setInterval(() => {
                const displayChords = getTransposedProgression();
                state.currentChordIndex = (state.currentChordIndex + 1) % displayChords.length;
                if (state.currentChordIndex === 0 && !state.isLooping) { stopPlayback(); return; }
                playCurrentChord();
            }, interval);
        }

        function playCurrentChord() { renderAll(); const displayChords = getTransposedProgression(); playChord(displayChords[state.currentChordIndex], '2n'); }
        function stopPlayback() { state.isPlaying = false; clearInterval(state.playInterval); updatePlayButtons(); renderAll(); }
        function toggleLoop() { state.isLooping = !state.isLooping; document.getElementById('loopBtn')?.classList.toggle('active', state.isLooping); document.getElementById('cdLoopBtn')?.classList.toggle('active', state.isLooping); showToast(state.isLooping ? 'üîÅ Loop ON' : 'üîÅ Loop OFF'); }

        function generateProgression() {
            const keyInfo = getKeyInfo();
            let pool = PROGRESSIONS[state.genre] || PROGRESSIONS.pop;
            // Filter for minor key if selected
            if (keyInfo.isMinor) {
                const minorPool = pool.filter(p => p[0].includes('m') || p.some(c => c.includes('m')));
                if (minorPool.length > 0) pool = minorPool;
            }
            state.progression = pool[Math.floor(Math.random() * pool.length)];
            state.currentChordIndex = 0;
            renderAll();
            showToast('üé≤ New progression!');
        }

        function exportFile(format) { showToast(`üì¶ ${format.toUpperCase()} export coming in v1.0!`); }
        function renderAll() { renderChords(); renderSheetFlowUI(); renderCardDeckUI(); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SHEETS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openSheet(type) {
            closeSheet();
            document.getElementById('sheetOverlay').classList.add('active');
            document.getElementById(`${type}Sheet`).classList.add('active');
            if (type === 'instrument') renderInstrumentOptions();
            if (type === 'key') renderKeyOptions();
            if (type === 'genre') renderGenreOptions();
        }

        function closeSheet() {
            document.getElementById('sheetOverlay').classList.remove('active');
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
        }

        function renderInstrumentOptions() {
            document.getElementById('instrumentList').innerHTML = instruments.map(inst => `<div class="option-item ${state.instrument === inst.id ? 'selected' : ''}" onclick="selectInstrument('${inst.id}')"><span class="option-icon">${inst.icon}</span><div class="option-text"><div class="option-title">${inst.name}</div><div class="option-desc">${inst.type} wave</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        
        function selectInstrument(id) { 
            state.instrument = id; 
            if (audioInit) createSynth();
            const inst = instruments.find(i=>i.id===id); 
            document.getElementById('instrumentBtn').textContent = inst.icon; 
            closeSheet(); 
            showToast(`${inst.icon} ${inst.name}`); 
        }

        function renderKeyOptions() {
            // Major keys
            document.getElementById('majorKeyList').innerHTML = majorKeys.map(key => `<div class="option-item ${state.key === key ? 'selected' : ''}" onclick="selectKey('${key}')"><span class="option-icon">üéµ</span><div class="option-text"><div class="option-title">${key} Major</div></div><span class="option-check">‚úì</span></div>`).join('');
            // Minor keys
            document.getElementById('minorKeyList').innerHTML = minorKeys.map(key => `<div class="option-item ${state.key === key ? 'selected' : ''}" onclick="selectKey('${key}')"><span class="option-icon">üé∂</span><div class="option-text"><div class="option-title">${key.replace('m','')} Minor</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        
        function selectKey(key) { 
            state.key = key;
            const keyInfo = getKeyInfo();
            document.getElementById('keyDisplay').textContent = keyInfo.display;
            renderAll();
            closeSheet(); 
            showToast(`üéµ Key: ${keyInfo.display}`);
        }

        function renderGenreOptions() {
            document.getElementById('genreList').innerHTML = genres.map(g => `<div class="option-item ${state.genre === g.id ? 'selected' : ''}" onclick="selectGenre('${g.id}')"><span class="option-icon">${g.icon}</span><div class="option-text"><div class="option-title">${g.name}</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        
        function selectGenre(id) { state.genre = id; document.getElementById('genreDisplay').textContent = genres.find(g=>g.id===id).name; generateProgression(); closeSheet(); }
        function setTempo(bpm) { state.tempo = bpm; ['tempoValue', 'tempoLarge'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = bpm; }); document.getElementById('tempoSlider').value = bpm; }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT LISTENERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.getElementById('tempoSlider')?.addEventListener('input', e => setTempo(parseInt(e.target.value)));
        document.querySelectorAll('.fader').forEach(f => {
            f.addEventListener('input', e => {
                const v = e.target.nextElementSibling;
                if (v?.classList.contains('fader-value')) v.textContent = e.target.value + '%';
                if (e.target.id === 'chordVolume' || e.target.classList.contains('chord-vol')) { state.chordVolume = parseInt(e.target.value); updateVolume(); }
                if (e.target.id === 'masterVolume' || e.target.classList.contains('master-vol')) { state.masterVolume = parseInt(e.target.value); updateVolume(); }
            });
        });
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
            if (e.code === 'KeyG') generateProgression();
            if (e.code === 'KeyA') aiGenerate('smart');
            if (e.code === 'Escape') { closeSheet(); cdCollapseCard(); closeAllSFPanels(); }
        });
        let sfTouchStartX = 0;
        document.getElementById('sfCanvas')?.addEventListener('touchstart', e => sfTouchStartX = e.touches[0].clientX, { passive: true });
        document.getElementById('sfCanvas')?.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - sfTouchStartX;
            if (Math.abs(dx) > 80) { if (dx > 0) openSFPanel('left'); else openSFPanel('right'); }
        }, { passive: true });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function init() {
            if (!state.onboardingComplete) {
                document.getElementById('onboarding').style.display = 'flex';
                selectOnboardingMode(state.uiMode);
            } else {
                document.getElementById('onboarding').style.display = 'none';
                activateUI();
            }
            initCDGestures();
            console.log(`üéµ ChordFlow v${VERSION} - Phase 2 Complete!`);
            console.log('‚úÖ More chord types (7ths, maj7, dim, aug, sus)');
            console.log('‚úÖ More progressions per genre (5-8 each)');
            console.log('‚úÖ Minor key support');
            console.log('‚úÖ Real Gemini AI integration');
        }
        init();
    </script>
</body>
</html>
