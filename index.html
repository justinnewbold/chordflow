<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v10.0 - Full Band Mode</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 160px);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-badge { font-size: 10px; background: var(--success); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        
        /* Band Mode Toggle */
        .band-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            margin: 16px 20px;
            gap: 4px;
        }
        .band-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .band-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        /* Instrument Categories */
        .instrument-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        /* Instrument Grid */
        .instrument-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none;
        }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card {
            min-width: 100px;
            padding: 14px 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-card.active {
            border-color: var(--accent);
            background: rgba(102, 126, 234, 0.15);
        }
        .instrument-card .icon { font-size: 28px; margin-bottom: 6px; }
        .instrument-card .name { font-size: 11px; color: var(--text-secondary); }
        .instrument-card.active .name { color: var(--text-primary); }
        
        /* Mixer Panel */
        .mixer-panel {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            margin: 0 12px;
        }
        .mixer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .mixer-title { font-size: 16px; font-weight: 600; }
        .mixer-tracks {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .mixer-track {
            min-width: 70px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
        }
        .track-icon { font-size: 20px; margin-bottom: 8px; }
        .track-name { font-size: 10px; color: var(--text-secondary); margin-bottom: 10px; }
        .track-fader {
            width: 6px;
            height: 80px;
            background: var(--bg-primary);
            border-radius: 3px;
            margin: 0 auto 10px;
            position: relative;
        }
        .fader-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--accent);
            border-radius: 3px;
            transition: height 0.2s;
        }
        .track-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        .track-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .track-btn.mute { background: var(--bg-primary); color: var(--text-secondary); }
        .track-btn.mute.active { background: var(--danger); color: white; }
        .track-btn.solo { background: var(--bg-primary); color: var(--text-secondary); }
        .track-btn.solo.active { background: var(--warning); color: black; }
        
        /* Chord Display */
        .chord-section {
            padding: 16px 20px;
        }
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 22px; font-weight: 700; }
        .chord-numeral { font-size: 11px; color: var(--accent-light); margin-top: 4px; }
        
        /* Drum Pattern Selector */
        .pattern-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .pattern-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pattern-card.active { border-color: var(--drums); }
        .pattern-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .pattern-icon { font-size: 20px; }
        .pattern-name { font-size: 13px; font-weight: 600; }
        .pattern-viz {
            display: flex;
            gap: 3px;
        }
        .beat {
            flex: 1;
            height: 24px;
            background: var(--bg-primary);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 2px;
        }
        .beat-line {
            flex: 1;
            border-radius: 2px;
            background: var(--bg-secondary);
        }
        .beat-line.active { background: var(--drums); }
        .beat-line.accent { background: var(--warning); }
        
        /* Bass Pattern */
        .bass-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .bass-options {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .bass-option {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .bass-option.active { border-color: var(--bass); background: rgba(239, 68, 68, 0.15); }
        
        /* Controls Row */
        .controls-row {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 16px;
        }
        .control-group { flex: 1; }
        .control-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .control-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        /* Playback Bar */
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            z-index: 200;
        }
        .playback-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 14px; font-weight: 600; }
        .playback-sub { font-size: 12px; color: var(--text-secondary); }
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tempo-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
        }
        .tempo-display { font-size: 14px; font-weight: 600; min-width: 55px; text-align: center; }
        
        /* Active Instruments Bar */
        .active-instruments {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .active-inst {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
        }
        .active-inst .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }
        
        /* All Instruments Grid in Modal */
        .all-instruments-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .inst-item {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .inst-item.active { border-color: var(--accent); }
        .inst-item .icon { font-size: 24px; margin-bottom: 6px; }
        .inst-item .name { font-size: 11px; }
        .inst-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 16px 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span>ğŸµ</span>
            <h1>ChordFlow<span class="version-badge">v10</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openModal('instrumentsModal')">ğŸ¹</button>
            <button class="icon-btn" onclick="openModal('mixerModal')">ğŸšï¸</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">âš™ï¸</button>
        </div>
    </header>

    <!-- Band Mode Toggle -->
    <div class="band-toggle">
        <button class="active" onclick="setMode('solo')">Solo</button>
        <button onclick="setMode('duo')">Duo</button>
        <button onclick="setMode('band')">Full Band</button>
        <button onclick="setMode('orchestra')">Orchestra</button>
    </div>

    <!-- Keys Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--keys)"></span>
                ğŸ¹ Keys
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card active" data-inst="grand-piano" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸ¹</div>
                <div class="name">Grand Piano</div>
            </div>
            <div class="instrument-card" data-inst="electric-piano" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸ¹</div>
                <div class="name">Electric Piano</div>
            </div>
            <div class="instrument-card" data-inst="organ" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸšï¸</div>
                <div class="name">Organ</div>
            </div>
            <div class="instrument-card" data-inst="synth-pad" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸ›ï¸</div>
                <div class="name">Synth Pad</div>
            </div>
            <div class="instrument-card" data-inst="clavinet" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸ¹</div>
                <div class="name">Clavinet</div>
            </div>
            <div class="instrument-card" data-inst="harpsichord" onclick="selectInstrument(this, 'keys')">
                <div class="icon">ğŸ¼</div>
                <div class="name">Harpsichord</div>
            </div>
        </div>
    </div>

    <!-- Guitar Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--guitar)"></span>
                ğŸ¸ Guitars
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="acoustic-guitar" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">ğŸ¸</div>
                <div class="name">Acoustic</div>
            </div>
            <div class="instrument-card" data-inst="electric-clean" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">ğŸ¸</div>
                <div class="name">Electric Clean</div>
            </div>
            <div class="instrument-card" data-inst="electric-overdrive" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">ğŸ¸</div>
                <div class="name">Overdrive</div>
            </div>
            <div class="instrument-card" data-inst="electric-distorted" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">ğŸ”¥</div>
                <div class="name">Distorted</div>
            </div>
            <div class="instrument-card" data-inst="nylon-guitar" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">ğŸ¸</div>
                <div class="name">Nylon</div>
            </div>
            <div class="instrument-card" data-inst="12-string" onclick="selectInstrument(this, 'guitar')">
                <div class="icon">âœ¨</div>
                <div class="name">12-String</div>
            </div>
        </div>
    </div>

    <!-- Bass Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--bass)"></span>
                ğŸ¸ Bass
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="electric-bass" onclick="selectInstrument(this, 'bass')">
                <div class="icon">ğŸ¸</div>
                <div class="name">Electric Bass</div>
            </div>
            <div class="instrument-card" data-inst="synth-bass" onclick="selectInstrument(this, 'bass')">
                <div class="icon">ğŸ›ï¸</div>
                <div class="name">Synth Bass</div>
            </div>
            <div class="instrument-card" data-inst="upright-bass" onclick="selectInstrument(this, 'bass')">
                <div class="icon">ğŸ»</div>
                <div class="name">Upright</div>
            </div>
            <div class="instrument-card" data-inst="slap-bass" onclick="selectInstrument(this, 'bass')">
                <div class="icon">ğŸ‘‹</div>
                <div class="name">Slap Bass</div>
            </div>
            <div class="instrument-card" data-inst="sub-bass" onclick="selectInstrument(this, 'bass')">
                <div class="icon">ğŸ“¢</div>
                <div class="name">Sub Bass</div>
            </div>
        </div>
    </div>

    <!-- Drums Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--drums)"></span>
                ğŸ¥ Drums
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="acoustic-kit" onclick="selectInstrument(this, 'drums')">
                <div class="icon">ğŸ¥</div>
                <div class="name">Acoustic Kit</div>
            </div>
            <div class="instrument-card" data-inst="electronic-kit" onclick="selectInstrument(this, 'drums')">
                <div class="icon">ğŸ›ï¸</div>
                <div class="name">Electronic</div>
            </div>
            <div class="instrument-card" data-inst="lofi-kit" onclick="selectInstrument(this, 'drums')">
                <div class="icon">ğŸ“»</div>
                <div class="name">Lo-Fi</div>
            </div>
            <div class="instrument-card" data-inst="808-kit" onclick="selectInstrument(this, 'drums')">
                <div class="icon">ğŸ’¥</div>
                <div class="name">808 Trap</div>
            </div>
            <div class="instrument-card" data-inst="brushes-kit" onclick="selectInstrument(this, 'drums')">
                <div class="icon">ğŸ–Œï¸</div>
                <div class="name">Jazz Brushes</div>
            </div>
        </div>
    </div>

    <!-- More Instruments (Strings, Brass, Synth) -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--strings)"></span>
                ğŸ» Strings & Brass
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="strings" onclick="selectInstrument(this, 'strings')">
                <div class="icon">ğŸ»</div>
                <div class="name">Strings</div>
            </div>
            <div class="instrument-card" data-inst="cello" onclick="selectInstrument(this, 'strings')">
                <div class="icon">ğŸ»</div>
                <div class="name">Cello</div>
            </div>
            <div class="instrument-card" data-inst="trumpet" onclick="selectInstrument(this, 'brass')">
                <div class="icon">ğŸº</div>
                <div class="name">Trumpet</div>
            </div>
            <div class="instrument-card" data-inst="saxophone" onclick="selectInstrument(this, 'brass')">
                <div class="icon">ğŸ·</div>
                <div class="name">Saxophone</div>
            </div>
            <div class="instrument-card" data-inst="choir" onclick="selectInstrument(this, 'strings')">
                <div class="icon">ğŸ¤</div>
                <div class="name">Choir</div>
            </div>
            <div class="instrument-card" data-inst="ukulele" onclick="selectInstrument(this, 'world')">
                <div class="icon">ğŸª•</div>
                <div class="name">Ukulele</div>
            </div>
        </div>
    </div>

    <!-- Drum Pattern Selection -->
    <div class="pattern-section">
        <div class="section-header">
            <div class="section-title">ğŸ¥ Drum Pattern</div>
        </div>
        <div class="pattern-grid">
            <div class="pattern-card active" onclick="selectPattern(this, 'rock')">
                <div class="pattern-header">
                    <span class="pattern-icon">ğŸ¸</span>
                    <span class="pattern-name">Rock</span>
                </div>
                <div class="pattern-viz">
                    <div class="beat"><div class="beat-line accent"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line accent"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                </div>
            </div>
            <div class="pattern-card" onclick="selectPattern(this, 'pop')">
                <div class="pattern-header">
                    <span class="pattern-icon">ğŸµ</span>
                    <span class="pattern-name">Pop</span>
                </div>
                <div class="pattern-viz">
                    <div class="beat"><div class="beat-line accent"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line accent"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line active"></div></div>
                </div>
            </div>
            <div class="pattern-card" onclick="selectPattern(this, 'jazz')">
                <div class="pattern-header">
                    <span class="pattern-icon">ğŸ·</span>
                    <span class="pattern-name">Jazz Swing</span>
                </div>
                <div class="pattern-viz">
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line active"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                </div>
            </div>
            <div class="pattern-card" onclick="selectPattern(this, 'hiphop')">
                <div class="pattern-header">
                    <span class="pattern-icon">ğŸ¤</span>
                    <span class="pattern-name">Hip-Hop</span>
                </div>
                <div class="pattern-viz">
                    <div class="beat"><div class="beat-line accent"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                    <div class="beat"><div class="beat-line"></div><div class="beat-line accent"></div><div class="beat-line"></div></div>
                    <div class="beat"><div class="beat-line active"></div><div class="beat-line"></div><div class="beat-line active"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bass Line Pattern -->
    <div class="bass-section">
        <div class="section-header">
            <div class="section-title">ğŸ¸ Bass Line</div>
        </div>
        <div class="bass-options">
            <div class="bass-option active" onclick="selectBassPattern(this, 'root')">Root Notes</div>
            <div class="bass-option" onclick="selectBassPattern(this, 'octave')">Octave Jump</div>
            <div class="bass-option" onclick="selectBassPattern(this, 'walking')">Walking Bass</div>
            <div class="bass-option" onclick="selectBassPattern(this, 'arpeggiate')">Arpeggiate</div>
            <div class="bass-option" onclick="selectBassPattern(this, 'syncopated')">Syncopated</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-row">
        <div class="control-group">
            <div class="control-label">Key</div>
            <select class="control-select" id="keySelect">
                <option value="C">C Major</option>
                <option value="G">G Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
                <option value="F">F Major</option>
                <option value="Am">A Minor</option>
                <option value="Em">E Minor</option>
                <option value="Dm">D Minor</option>
            </select>
        </div>
        <div class="control-group">
            <div class="control-label">Genre</div>
            <select class="control-select" id="genreSelect">
                <option value="pop">Pop</option>
                <option value="rock">Rock</option>
                <option value="jazz">Jazz</option>
                <option value="blues">Blues</option>
                <option value="rnb">R&B</option>
                <option value="country">Country</option>
                <option value="edm">EDM</option>
                <option value="lofi">Lo-Fi</option>
            </select>
        </div>
    </div>

    <!-- Chord Display -->
    <div class="chord-section">
        <div class="section-header">
            <div class="section-title">ğŸ¶ Progression</div>
            <button class="icon-btn" style="width:36px;height:36px;font-size:16px;" onclick="generateProgression()">âœ¨</button>
        </div>
        <div class="chord-grid" id="chordGrid">
            <div class="chord-card" onclick="playChord('C')">
                <div class="chord-name">C</div>
                <div class="chord-numeral">I</div>
            </div>
            <div class="chord-card" onclick="playChord('G')">
                <div class="chord-name">G</div>
                <div class="chord-numeral">V</div>
            </div>
            <div class="chord-card" onclick="playChord('Am')">
                <div class="chord-name">Am</div>
                <div class="chord-numeral">vi</div>
            </div>
            <div class="chord-card" onclick="playChord('F')">
                <div class="chord-name">F</div>
                <div class="chord-numeral">IV</div>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">â–¶ï¸</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub">4 chords â€¢ C Major â€¢ Full Band</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">âˆ’</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Mixer Modal -->
    <div class="modal" id="mixerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸšï¸ Mixer</div>
                <button class="close-btn" onclick="closeModal('mixerModal')">âœ•</button>
            </div>
            <div class="mixer-tracks" id="mixerTracks">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <!-- All Instruments Modal -->
    <div class="modal" id="instrumentsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ¹ All Instruments</div>
                <button class="close-btn" onclick="closeModal('instrumentsModal')">âœ•</button>
            </div>
            
            <div class="inst-category">ğŸ¹ Keys</div>
            <div class="all-instruments-grid">
                <div class="inst-item active" onclick="toggleInst(this)"><div class="icon">ğŸ¹</div><div class="name">Grand Piano</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¹</div><div class="name">Electric Piano</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸšï¸</div><div class="name">Organ</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ›ï¸</div><div class="name">Synth Pad</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¼</div><div class="name">Harpsichord</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸµ</div><div class="name">Music Box</div></div>
            </div>
            
            <div class="inst-category">ğŸ¸ Guitars</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¸</div><div class="name">Acoustic</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¸</div><div class="name">Electric Clean</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ”¥</div><div class="name">Distorted</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¸</div><div class="name">Nylon</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">âœ¨</div><div class="name">12-String</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸª•</div><div class="name">Ukulele</div></div>
            </div>
            
            <div class="inst-category">ğŸ¸ Bass</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¸</div><div class="name">Electric Bass</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ›ï¸</div><div class="name">Synth Bass</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ»</div><div class="name">Upright</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ‘‹</div><div class="name">Slap Bass</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ“¢</div><div class="name">Sub Bass</div></div>
            </div>
            
            <div class="inst-category">ğŸ¥ Drums</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¥</div><div class="name">Acoustic Kit</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ›ï¸</div><div class="name">Electronic</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ“»</div><div class="name">Lo-Fi</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ’¥</div><div class="name">808</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ–Œï¸</div><div class="name">Brushes</div></div>
            </div>
            
            <div class="inst-category">ğŸ» Strings & Brass</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ»</div><div class="name">Strings</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ»</div><div class="name">Cello</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸº</div><div class="name">Trumpet</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ·</div><div class="name">Saxophone</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ“¯</div><div class="name">Trombone</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¤</div><div class="name">Choir</div></div>
            </div>
            
            <div class="inst-category">ğŸŒ World & Synth</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸª˜</div><div class="name">Steel Drums</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ¶</div><div class="name">Kalimba</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸª•</div><div class="name">Sitar</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ›ï¸</div><div class="name">Lead Synth</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ”Š</div><div class="name">Wobble</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">ğŸ‘¾</div><div class="name">Chiptune</div></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        const state = {
            mode: 'solo',
            tempo: 120,
            isPlaying: false,
            progression: ['C', 'G', 'Am', 'F'],
            activeInstruments: [
                { name: 'Grand Piano', category: 'keys', color: '#667eea', volume: 80, muted: false, solo: false }
            ],
            drumPattern: 'rock',
            bassPattern: 'root'
        };

        // Synths
        let mainSynth, bassSynth, drumSynth;
        
        async function initAudio() {
            await Tone.start();
            
            // Main synth for chords
            mainSynth = new Tone.PolySynth(Tone.Synth).toDestination();
            mainSynth.set({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.8 }
            });
            
            // Bass synth
            bassSynth = new Tone.MonoSynth().toDestination();
            bassSynth.set({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.8, release: 0.3 },
                filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.2 }
            });
            bassSynth.volume.value = -6;
            
            // Drum synth (noise for hi-hat, membrane for kick/snare)
            drumSynth = {
                kick: new Tone.MembraneSynth().toDestination(),
                snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 }}).toDestination(),
                hihat: new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 }}).toDestination()
            };
            drumSynth.kick.volume.value = -4;
            drumSynth.snare.volume.value = -10;
            drumSynth.hihat.volume.value = -20;
        }

        // Chord notes
        const chordNotes = {
            'C': ['C3', 'E3', 'G3'], 'Cm': ['C3', 'Eb3', 'G3'],
            'D': ['D3', 'F#3', 'A3'], 'Dm': ['D3', 'F3', 'A3'],
            'E': ['E3', 'G#3', 'B3'], 'Em': ['E3', 'G3', 'B3'],
            'F': ['F3', 'A3', 'C4'], 'Fm': ['F3', 'Ab3', 'C4'],
            'G': ['G3', 'B3', 'D4'], 'Gm': ['G3', 'Bb3', 'D4'],
            'A': ['A3', 'C#4', 'E4'], 'Am': ['A3', 'C4', 'E4'],
            'B': ['B3', 'D#4', 'F#4'], 'Bm': ['B3', 'D4', 'F#4'],
            'Bb': ['Bb3', 'D4', 'F4']
        };

        // Play chord with all active instruments
        async function playChord(chord) {
            if (!mainSynth) await initAudio();
            
            const notes = chordNotes[chord] || chordNotes['C'];
            const bassNote = notes[0].replace('3', '2');
            
            // Play chord
            mainSynth.triggerAttackRelease(notes, '2n');
            
            // Play bass if in band mode
            if (state.mode === 'band' || state.mode === 'duo') {
                bassSynth.triggerAttackRelease(bassNote, '4n');
            }
            
            haptic();
            showToast(`ğŸµ ${chord}`);
        }

        // Play drum hit
        function playDrumHit(type) {
            if (!drumSynth) return;
            if (type === 'kick') drumSynth.kick.triggerAttackRelease('C1', '8n');
            if (type === 'snare') drumSynth.snare.triggerAttackRelease('8n');
            if (type === 'hihat') drumSynth.hihat.triggerAttackRelease('16n');
        }

        // Select instrument
        function selectInstrument(el, category) {
            const section = el.closest('.instrument-section');
            section.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            const name = el.querySelector('.name').textContent;
            updateActiveInstruments(name, category);
            haptic();
            showToast(`${el.querySelector('.icon').textContent} ${name}`);
        }

        // Update active instruments display
        function updateActiveInstruments(name, category) {
            const colors = { keys: '#667eea', guitar: '#f59e0b', bass: '#ef4444', drums: '#10b981', strings: '#8b5cf6', brass: '#f97316' };
            
            // Check if category already exists
            const existing = state.activeInstruments.findIndex(i => i.category === category);
            if (existing >= 0) {
                state.activeInstruments[existing] = { name, category, color: colors[category] || '#667eea', volume: 80, muted: false, solo: false };
            } else {
                state.activeInstruments.push({ name, category, color: colors[category] || '#667eea', volume: 80, muted: false, solo: false });
            }
            
            renderActiveInstruments();
        }

        function renderActiveInstruments() {
            const container = document.getElementById('activeInstruments');
            container.innerHTML = state.activeInstruments.map(inst => `
                <div class="active-inst">
                    <span class="dot" style="background: ${inst.color}"></span>
                    ${inst.name}
                </div>
            `).join('');
        }

        // Toggle instrument in modal
        function toggleInst(el) {
            el.classList.toggle('active');
            haptic();
        }

        // Mode selection
        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.band-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const modeNames = { solo: 'Solo Piano', duo: 'Piano + Bass', band: 'Full Band', orchestra: 'Orchestra' };
            showToast(`ğŸ¸ ${modeNames[mode]}`);
            haptic();
        }

        // Pattern selection
        function selectPattern(el, pattern) {
            document.querySelectorAll('.pattern-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            state.drumPattern = pattern;
            haptic();
            showToast(`ğŸ¥ ${pattern.charAt(0).toUpperCase() + pattern.slice(1)} beat`);
        }

        // Bass pattern selection
        function selectBassPattern(el, pattern) {
            document.querySelectorAll('.bass-option').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            state.bassPattern = pattern;
            haptic();
        }

        // Generate progression
        function generateProgression() {
            const progressions = [
                ['C', 'G', 'Am', 'F'],
                ['G', 'D', 'Em', 'C'],
                ['Am', 'F', 'C', 'G'],
                ['Dm', 'G', 'C', 'Am'],
                ['E', 'A', 'D', 'A'],
                ['Em', 'C', 'G', 'D']
            ];
            state.progression = progressions[Math.floor(Math.random() * progressions.length)];
            renderChords();
            haptic();
            showToast('âœ¨ New progression!');
        }

        function renderChords() {
            const numerals = ['I', 'V', 'vi', 'IV'];
            document.getElementById('chordGrid').innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}')">
                    <div class="chord-name">${chord}</div>
                    <div class="chord-numeral">${numerals[i] || ''}</div>
                </div>
            `).join('');
        }

        // Playback
        let playbackInterval, beatCount = 0;
        async function togglePlayback() {
            if (!mainSynth) await initAudio();
            state.isPlaying = !state.isPlaying;
            
            const btn = document.getElementById('playBtn');
            const display = document.getElementById('nowPlaying');
            
            if (state.isPlaying) {
                btn.textContent = 'â¸ï¸';
                let chordIdx = 0;
                beatCount = 0;
                
                const beatInterval = (60 / state.tempo) * 1000;
                
                playbackInterval = setInterval(() => {
                    const beatInMeasure = beatCount % 4;
                    
                    // Drums on every beat (if band mode)
                    if (state.mode === 'band' || state.mode === 'orchestra') {
                        playDrumHit('hihat');
                        if (beatInMeasure === 0) playDrumHit('kick');
                        if (beatInMeasure === 2) playDrumHit('snare');
                    }
                    
                    // Chord on beat 1
                    if (beatInMeasure === 0) {
                        const chord = state.progression[chordIdx % state.progression.length];
                        playChord(chord);
                        display.textContent = `Playing: ${chord}`;
                        
                        document.querySelectorAll('.chord-card').forEach((card, i) => {
                            card.classList.toggle('playing', i === chordIdx % state.progression.length);
                        });
                        
                        chordIdx++;
                    }
                    
                    beatCount++;
                }, beatInterval);
            } else {
                btn.textContent = 'â–¶ï¸';
                display.textContent = 'Ready to jam';
                clearInterval(playbackInterval);
                document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            }
        }

        // Tempo
        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(200, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            haptic();
        }

        // Modals
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            if (id === 'mixerModal') renderMixer();
            haptic();
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Render mixer
        function renderMixer() {
            const container = document.getElementById('mixerTracks');
            container.innerHTML = state.activeInstruments.map((inst, i) => `
                <div class="mixer-track">
                    <div class="track-icon">${getInstIcon(inst.category)}</div>
                    <div class="track-name">${inst.name}</div>
                    <div class="track-fader">
                        <div class="fader-fill" style="height: ${inst.volume}%; background: ${inst.color}"></div>
                    </div>
                    <div class="track-controls">
                        <button class="track-btn mute ${inst.muted ? 'active' : ''}" onclick="toggleMute(${i})">M</button>
                        <button class="track-btn solo ${inst.solo ? 'active' : ''}" onclick="toggleSolo(${i})">S</button>
                    </div>
                </div>
            `).join('');
        }

        function getInstIcon(cat) {
            const icons = { keys: 'ğŸ¹', guitar: 'ğŸ¸', bass: 'ğŸ¸', drums: 'ğŸ¥', strings: 'ğŸ»', brass: 'ğŸº' };
            return icons[cat] || 'ğŸµ';
        }

        function toggleMute(idx) {
            state.activeInstruments[idx].muted = !state.activeInstruments[idx].muted;
            renderMixer();
            haptic();
        }

        function toggleSolo(idx) {
            state.activeInstruments[idx].solo = !state.activeInstruments[idx].solo;
            renderMixer();
            haptic();
        }

        // Utilities
        function haptic() { if (navigator.vibrate) navigator.vibrate(10); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderChords();
            renderActiveInstruments();
            document.querySelectorAll('.modal').forEach(m => {
                m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
            });
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
