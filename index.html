<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="AI-Powered Chord Progression Generator & Songwriting Suite">
    <meta name="theme-color" content="#ff6b35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChordFlow">
    
    <title>ChordFlow Pro | AI Songwriting Suite</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root, [data-theme="dark"] {
            --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-elevated: #1a1a24;
            --accent-primary: #ff6b35; --accent-secondary: #f7c59f; --accent-glow: #ff6b3540;
            --text-primary: #ffffff; --text-secondary: #9ca3af; --border-subtle: #1f1f2e;
            --success: #10b981; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        [data-theme="light"] {
            --bg-dark: #f8f9fa; --bg-card: #ffffff; --bg-elevated: #f0f0f5;
            --accent-primary: #ff6b35; --accent-secondary: #e85a24; --accent-glow: #ff6b3530;
            --text-primary: #1a1a2e; --text-secondary: #6b7280; --border-subtle: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html { height: 100%; }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-primary); 
            min-height: 100%; 
            overflow-x: hidden;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        .bg-pattern { 
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
            background: radial-gradient(ellipse at 20% 20%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(247, 197, 159, 0.05) 0%, transparent 50%); 
        }

        /* ===== MOBILE-FIRST HEADER ===== */
        .header { 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            background: var(--bg-dark); 
            border-bottom: 1px solid var(--border-subtle);
            padding: 0.75rem 1rem;
            padding-top: calc(0.75rem + var(--safe-top));
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 0.5rem;
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
        }
        
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        
        .menu-btn { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.5rem; 
            cursor: pointer; 
            padding: 0.5rem;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .menu-btn:active { background: var(--bg-elevated); }
        
        .logo { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.5rem; 
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .version-badge { 
            font-size: 0.55rem; 
            background: var(--accent-primary); 
            color: white; 
            padding: 0.15rem 0.35rem; 
            border-radius: 6px; 
            margin-left: 0.25rem;
            vertical-align: super;
        }
        
        .header-controls { display: flex; align-items: center; gap: 0.5rem; }
        
        .icon-btn { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary);
            min-width: 44px; 
            min-height: 44px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); background: var(--bg-elevated); }
        .icon-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        /* ===== MAIN CONTENT ===== */
        .main-content { 
            position: relative; 
            z-index: 1; 
            padding: 1rem; 
            padding-bottom: calc(180px + var(--safe-bottom)); 
            max-width: 600px; 
            margin: 0 auto; 
        }

        /* ===== KEY/SCALE SELECTOR - MOBILE OPTIMIZED ===== */
        .key-scale-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
        }
        
        .selector-chip {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-elevated);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .selector-chip:active { background: var(--bg-dark); }
        
        .selector-chip select {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        .selector-chip select:focus { outline: none; }
        
        .selector-chip .icon { font-size: 1.2rem; }

        /* ===== GENRE SCROLL - TOUCH OPTIMIZED ===== */
        .genre-scroll { 
            display: flex; 
            gap: 0.5rem; 
            overflow-x: auto; 
            padding: 0.5rem 0; 
            margin-bottom: 1rem;
            scrollbar-width: none; 
            -ms-overflow-style: none;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .genre-scroll::-webkit-scrollbar { display: none; }
        
        .genre-btn { 
            flex-shrink: 0; 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-secondary);
            padding: 0.75rem 1.25rem; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-size: 0.9rem; 
            font-weight: 500;
            white-space: nowrap;
            scroll-snap-align: start;
            min-height: 44px;
        }
        .genre-btn:active { transform: scale(0.95); }
        .genre-btn:hover, .genre-btn.active { 
            border-color: var(--accent-primary); 
            color: var(--text-primary); 
            background: rgba(255, 107, 53, 0.15); 
        }

        /* ===== SONG STRUCTURE - SWIPE ENABLED ===== */
        .structure-section { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: 20px; 
            padding: 1.25rem; 
            margin-bottom: 1rem; 
        }
        
        .structure-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        
        .structure-title { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .structure-timeline { 
            display: flex; 
            gap: 0.75rem; 
            overflow-x: auto; 
            padding: 0.75rem 0.5rem; 
            scrollbar-width: none;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .structure-timeline::-webkit-scrollbar { display: none; }
        
        .section-block { 
            flex-shrink: 0; 
            min-width: 120px; 
            padding: 1rem; 
            border-radius: 16px; 
            cursor: pointer; 
            border: 2px solid transparent;
            transition: all 0.2s ease; 
            text-align: center; 
            position: relative;
            scroll-snap-align: center;
        }
        .section-block:active { transform: scale(0.98); }
        .section-block.active { border-color: white; transform: scale(1.02); }
        .section-block.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-block.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-block.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-block.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-block.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        .section-block .section-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem; }
        .section-block .section-bars { font-size: 0.7rem; opacity: 0.7; }
        .section-block .section-chords { font-size: 0.65rem; margin-top: 0.5rem; opacity: 0.9; }
        
        .section-block .delete-section { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            width: 24px; 
            height: 24px; 
            background: var(--error);
            border-radius: 50%; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.8rem; 
            color: white; 
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .section-block.active .delete-section { display: flex; }
        
        .add-section-btn { 
            flex-shrink: 0; 
            width: 50px; 
            height: 80px; 
            border: 2px dashed var(--border-subtle); 
            border-radius: 16px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: var(--text-secondary); 
            font-size: 1.5rem;
            transition: all 0.2s;
        }
        .add-section-btn:active { border-color: var(--accent-primary); color: var(--accent-primary); }

        /* ===== GENERATE BUTTONS - LARGE TOUCH TARGETS ===== */
        .generate-section { 
            display: flex; 
            gap: 0.75rem; 
            justify-content: center; 
            margin: 1.5rem 0; 
        }
        
        .btn { 
            background: linear-gradient(135deg, var(--accent-primary), #ff8c5a); 
            color: white; 
            border: none;
            padding: 1rem 2rem; 
            border-radius: 25px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-size: 1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:active { transform: scale(0.96); }
        .btn-secondary { background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #a855f7); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; min-height: 40px; }

        /* ===== CHORD DISPLAY - TOUCH FRIENDLY ===== */
        .chord-section { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: 20px; 
            padding: 1.25rem; 
            margin: 1rem 0; 
        }
        
        .chord-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        
        .chord-title { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--text-secondary); 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        .current-section-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }

        .chord-display { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
            gap: 0.75rem; 
            margin: 1rem 0; 
        }
        
        .chord-card { 
            background: linear-gradient(145deg, var(--bg-elevated), var(--bg-dark)); 
            border: 2px solid var(--border-subtle);
            border-radius: 18px; 
            padding: 1rem; 
            text-align: center; 
            transition: all 0.2s ease; 
            cursor: pointer; 
            position: relative;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chord-card:active { transform: scale(0.95); }
        .chord-card.active { border-color: var(--accent-primary); box-shadow: 0 0 25px var(--accent-glow); }
        .chord-card.playing { animation: pulse-glow 0.5s ease; }
        
        @keyframes pulse-glow { 
            0%, 100% { box-shadow: 0 0 25px var(--accent-glow); } 
            50% { box-shadow: 0 0 40px var(--accent-primary); } 
        }
        
        .chord-name { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--text-primary); }
        .chord-numeral { color: var(--accent-secondary); font-size: 0.85rem; margin-top: 0.2rem; }
        .chord-function { color: var(--text-secondary); font-size: 0.65rem; }
        
        .chord-card .chord-delete { 
            position: absolute; 
            top: -6px; 
            right: -6px; 
            width: 22px; 
            height: 22px; 
            background: var(--error);
            border-radius: 50%; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.7rem; 
            color: white; 
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .chord-card.active .chord-delete { display: flex; }

        /* ===== PLAYBACK CONTROLS - MOBILE OPTIMIZED ===== */
        .playback-section { 
            background: var(--bg-elevated); 
            border-radius: 20px; 
            padding: 1.25rem; 
            margin-top: 1rem; 
        }
        
        .playback-controls { 
            display: flex; 
            gap: 0.75rem; 
            justify-content: center; 
            align-items: center; 
        }
        
        .play-btn { 
            width: 64px; 
            height: 64px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--accent-primary), #ff8c5a);
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            color: white;
            transition: all 0.2s ease; 
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        .play-btn:active { transform: scale(0.9); }
        
        .control-btn { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary);
            min-width: 48px;
            min-height: 48px;
            padding: 0 1rem;
            border-radius: 24px; 
            cursor: pointer; 
            font-size: 1rem; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }
        .control-btn:active { transform: scale(0.95); background: var(--bg-elevated); }
        .control-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        /* ===== TEMPO CONTROL - TOUCH FRIENDLY ===== */
        .tempo-control { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            background: var(--bg-card); 
            padding: 0.75rem 1rem; 
            border-radius: 24px;
            margin-top: 1rem;
        }
        
        .tempo-control input[type="range"] { 
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
        }
        .tempo-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .tempo-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.9rem; 
            min-width: 55px;
            text-align: center;
            font-weight: 600;
        }
        
        .metronome-light { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--border-subtle); 
            transition: all 0.1s; 
        }
        .metronome-light.beat { 
            background: var(--accent-primary); 
            box-shadow: 0 0 15px var(--accent-primary); 
        }

        /* ===== BACKING TRACK TOGGLES ===== */
        .backing-controls { 
            display: flex; 
            gap: 0.5rem; 
            justify-content: center; 
            margin-top: 1rem; 
            flex-wrap: wrap; 
        }
        
        .backing-btn { 
            display: flex; 
            align-items: center; 
            gap: 0.4rem; 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle);
            padding: 0.6rem 1rem; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            cursor: pointer;
            min-height: 44px;
            transition: all 0.2s;
        }
        .backing-btn:active { transform: scale(0.95); }
        .backing-btn.active { 
            background: rgba(255, 107, 53, 0.2); 
            border-color: var(--accent-primary); 
            color: var(--accent-primary); 
        }
        
        .backing-btn .indicator { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: var(--text-secondary); 
        }
        .backing-btn.active .indicator { background: var(--accent-primary); }

        /* ===== VISUALIZER ===== */
        .visualizer { 
            height: 45px; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            gap: 3px; 
            margin-top: 1rem; 
        }
        
        .viz-bar { 
            width: 6px; 
            background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary)); 
            border-radius: 3px; 
            transition: height 0.1s ease; 
        }

        /* ===== BOTTOM DRAWER - MOBILE NATIVE FEEL ===== */
        .bottom-drawer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 200; 
            background: var(--bg-card);
            border-top: 1px solid var(--border-subtle); 
            border-radius: 24px 24px 0 0;
            transform: translateY(calc(100% - 75px - var(--safe-bottom))); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh; 
            overflow: hidden;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
            padding-bottom: var(--safe-bottom);
        }
        .bottom-drawer.open { transform: translateY(0); }
        
        .drawer-handle { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 0.75rem; 
            cursor: pointer;
            touch-action: none;
        }
        
        .drawer-handle-bar { 
            width: 40px; 
            height: 5px; 
            background: var(--border-subtle); 
            border-radius: 3px; 
            margin-bottom: 0.75rem; 
        }
        
        .drawer-tabs { 
            display: flex; 
            gap: 0.5rem; 
            justify-content: center; 
            padding: 0 0.75rem;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .drawer-tabs::-webkit-scrollbar { display: none; }
        
        .drawer-tab { 
            padding: 0.6rem 1rem; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            background: transparent; 
            border: none;
            color: var(--text-secondary); 
            cursor: pointer; 
            white-space: nowrap;
            min-height: 40px;
            transition: all 0.2s;
        }
        .drawer-tab:active { transform: scale(0.95); }
        .drawer-tab.active { background: rgba(255, 107, 53, 0.15); color: var(--accent-primary); }
        
        .drawer-content { 
            padding: 1rem; 
            overflow-y: auto; 
            max-height: calc(70vh - 100px); 
            -webkit-overflow-scrolling: touch;
        }
        
        .drawer-panel { display: none; }
        .drawer-panel.active { display: block; }

        /* ===== GUITAR DIAGRAMS - LARGER FOR MOBILE ===== */
        .instrument-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 1rem; 
            justify-content: center; 
        }
        
        .instrument-chord { 
            background: var(--bg-dark); 
            border-radius: 16px; 
            padding: 0.75rem; 
            text-align: center; 
            cursor: pointer; 
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .instrument-chord:active { transform: scale(0.95); border-color: var(--accent-primary); }
        
        .instrument-chord-name { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.3rem; 
            color: var(--accent-primary); 
            margin-bottom: 0.5rem; 
        }
        
        .chord-diagram { 
            width: 85px; 
            height: 100px; 
            margin: 0 auto; 
        }
        
        .fret-info { 
            font-size: 0.65rem; 
            color: var(--text-secondary); 
            margin-top: 0.25rem; 
            font-family: 'JetBrains Mono', monospace; 
        }

        /* ===== PIANO - LARGER KEYS FOR MOBILE ===== */
        .piano-container { 
            overflow-x: auto; 
            padding: 1rem 0; 
            -webkit-overflow-scrolling: touch;
        }
        
        .piano-roll { 
            display: flex; 
            justify-content: center; 
            gap: 1px; 
            min-width: fit-content; 
        }
        
        .piano-key { 
            width: 36px; 
            height: 120px; 
            background: white; 
            border-radius: 0 0 6px 6px; 
            cursor: pointer; 
            border: 1px solid #ccc;
            transition: all 0.1s;
        }
        .piano-key:active { background: var(--accent-secondary); }
        
        .piano-key.black { 
            width: 24px; 
            height: 75px; 
            background: #1a1a25; 
            margin: 0 -12px; 
            z-index: 2; 
            border-radius: 0 0 4px 4px; 
            border: none; 
        }
        .piano-key.black:active { background: var(--accent-primary); }
        
        .piano-key.active { background: var(--accent-primary) !important; }

        /* ===== TAB NOTATION ===== */
        .tab-notation { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.8rem; 
            background: var(--bg-dark); 
            padding: 1rem; 
            border-radius: 12px; 
            overflow-x: auto; 
            white-space: pre;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== STRUM PATTERN ===== */
        .strum-pattern { 
            display: flex; 
            justify-content: center; 
            gap: 1rem; 
            padding: 1rem; 
        }
        
        .strum-beat { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.3rem; 
        }
        
        .strum-arrow { 
            font-size: 2rem; 
            color: var(--accent-primary); 
        }
        .strum-arrow.down { transform: rotate(180deg); }
        .strum-arrow.muted { color: var(--text-secondary); opacity: 0.5; }
        
        .strum-count { font-size: 0.75rem; color: var(--text-secondary); }

        /* ===== SIDE PANELS ===== */
        .side-panel { 
            position: fixed; 
            top: 0; 
            bottom: 0; 
            width: 320px; 
            max-width: 90vw; 
            z-index: 300;
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle);
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow-y: auto;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        .side-panel.right { right: 0; left: auto; transform: translateX(100%); }
        .side-panel.open { transform: translateX(0); }
        
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            border-bottom: 1px solid var(--border-subtle);
            position: sticky; 
            top: 0; 
            background: var(--bg-card); 
            z-index: 10; 
        }
        
        .panel-title { font-size: 1rem; font-weight: 600; }
        
        .close-btn { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.75rem; 
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panel-content { padding: 1rem; }

        /* ===== HISTORY ITEMS ===== */
        .history-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background: var(--bg-dark);
            border-radius: 12px; 
            margin-bottom: 0.5rem; 
            cursor: pointer;
            min-height: 60px;
            transition: all 0.2s;
        }
        .history-item:active { background: rgba(255, 107, 53, 0.1); }
        
        .history-prog { font-weight: 500; font-size: 0.9rem; }
        .history-meta { font-size: 0.75rem; color: var(--text-secondary); }

        /* ===== LYRICS EDITOR ===== */
        .lyrics-editor { 
            background: var(--bg-dark); 
            border-radius: 12px; 
            padding: 1rem; 
        }
        
        .lyrics-line { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 0.75rem; 
            align-items: flex-start; 
        }
        
        .lyrics-chord { 
            background: var(--accent-primary); 
            color: white; 
            padding: 0.4rem 0.6rem; 
            border-radius: 8px; 
            font-size: 0.8rem; 
            font-weight: 600; 
            min-width: 50px; 
            text-align: center; 
        }
        
        .lyrics-text { 
            flex: 1; 
            background: transparent; 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary); 
            padding: 0.5rem; 
            border-radius: 8px; 
            font-size: 0.9rem;
            min-height: 44px;
        }
        .lyrics-text:focus { border-color: var(--accent-primary); outline: none; }

        /* ===== EXPORT BUTTONS ===== */
        .export-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.5rem; 
        }
        
        .export-btn { 
            background: var(--bg-dark); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary);
            padding: 0.75rem; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
            min-height: 50px;
            transition: all 0.2s;
        }
        .export-btn:active { background: rgba(255, 107, 53, 0.1); border-color: var(--accent-primary); }

        /* ===== SECTION LABELS ===== */
        .section-label { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; }
        .section-label.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-label.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-label.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-label.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-label.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* ===== OVERLAY ===== */
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.6); 
            z-index: 250; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* ===== FAB - SPEED DIAL ===== */
        .fab-container { 
            position: fixed; 
            bottom: calc(100px + var(--safe-bottom)); 
            right: 1rem; 
            z-index: 150; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 0.75rem; 
        }
        
        .fab { 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 1.3rem; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); 
            transition: all 0.3s ease; 
        }
        .fab:active { transform: scale(0.9); }
        
        .fab-primary { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
        
        .fab-secondary { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary); 
            width: 48px; 
            height: 48px; 
            font-size: 1.1rem; 
        }
        
        .fab-menu { 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem; 
            transform: scale(0); 
            opacity: 0; 
            transform-origin: bottom right; 
            transition: all 0.3s ease; 
        }
        .fab-menu.open { transform: scale(1); opacity: 1; }

        /* ===== TOAST ===== */
        .toast { 
            position: fixed; 
            bottom: calc(120px + var(--safe-bottom)); 
            left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: var(--bg-card);
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary); 
            padding: 0.75rem 1.5rem; 
            border-radius: 24px; 
            z-index: 1000;
            opacity: 0; 
            transition: all 0.3s ease; 
            font-size: 0.9rem; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 90vw;
            text-align: center;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ===== MODAL ===== */
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.7); 
            display: none; 
            align-items: flex-end; 
            justify-content: center; 
            z-index: 400; 
            padding: 0;
        }
        .modal.show { display: flex; }
        
        .modal-content { 
            background: var(--bg-card); 
            border-radius: 24px 24px 0 0; 
            padding: 1.5rem; 
            padding-bottom: calc(1.5rem + var(--safe-bottom));
            width: 100%; 
            max-width: 500px;
            max-height: 80vh; 
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }

        /* ===== SECTION OPTIONS ===== */
        .section-options { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.75rem; 
        }
        
        .section-option { 
            padding: 1rem; 
            border-radius: 16px; 
            cursor: pointer; 
            text-align: center; 
            border: 2px solid transparent;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .section-option:active { transform: scale(0.95); border-color: white; }
        .section-option.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-option.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-option.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-option.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-option.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* ===== INFO GRID ===== */
        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 0.75rem; 
            margin: 0.75rem 0; 
        }
        
        .info-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: 16px; 
            padding: 1rem; 
        }
        .info-card h3 { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--text-secondary); 
            margin-bottom: 0.75rem; 
        }
        .info-card p { font-size: 0.9rem; margin-bottom: 0.5rem; }
        
        .tag { 
            display: inline-block; 
            background: rgba(255, 107, 53, 0.2); 
            color: var(--accent-secondary); 
            padding: 0.25rem 0.6rem; 
            border-radius: 10px; 
            font-size: 0.75rem; 
            margin: 0.1rem; 
        }

        /* ===== PULL TO REFRESH INDICATOR ===== */
        .pull-indicator {
            position: fixed;
            top: calc(var(--safe-top) + 60px);
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .pull-indicator.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== HAPTIC FEEDBACK INDICATOR ===== */
        @keyframes haptic {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }
        
        .haptic-feedback {
            animation: haptic 0.1s ease;
        }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 380px) {
            .chord-display { grid-template-columns: repeat(2, 1fr); }
            .chord-name { font-size: 1.75rem; }
            .btn { padding: 0.75rem 1.25rem; font-size: 0.9rem; }
        }
        
        @media (min-width: 768px) {
            .main-content { max-width: 700px; padding: 1.5rem; }
            .info-grid { grid-template-columns: repeat(2, 1fr); }
            .chord-display { grid-template-columns: repeat(4, 1fr); }
            .modal-content { border-radius: 24px; margin: auto; }
            .modal { align-items: center; padding: 1rem; }
        }

        /* ===== INSTALL BANNER ===== */
        .install-banner { 
            display: none; 
            background: linear-gradient(135deg, var(--accent-primary), #ff8c5a); 
            color: white;
            padding: 1rem; 
            margin: 0 1rem 1rem; 
            border-radius: 16px; 
            align-items: center; 
            justify-content: space-between;
            gap: 1rem;
        }
        .install-banner.show { display: flex; }
        .install-banner button { 
            background: white; 
            color: var(--accent-primary); 
            border: none; 
            padding: 0.6rem 1.25rem; 
            border-radius: 20px; 
            font-weight: 600; 
            cursor: pointer;
            white-space: nowrap;
            min-height: 44px;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pullIndicator">‚Üì Pull to refresh</div>

    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
        <span>üì± Install ChordFlow for the best experience!</span>
        <button id="installBtn">Install</button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
            <h1 class="logo">CHORDFLOW<span class="version-badge">v6</span></h1>
        </div>
        <div class="header-controls">
            <button class="icon-btn" id="themeToggle" title="Theme">üåô</button>
            <button class="icon-btn" id="lyricsBtn" title="Export">üíæ</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Key/Scale Selector -->
        <div class="key-scale-bar">
            <div class="selector-chip">
                <span class="icon">üéµ</span>
                <select id="keySelect">
                    <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option>
                    <option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option>
                    <option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
                </select>
            </div>
            <div class="selector-chip">
                <span class="icon">üéº</span>
                <select id="scaleSelect">
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                    <option value="dorian">Dorian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="blues">Blues</option>
                </select>
            </div>
        </div>

        <!-- Genre Scroll -->
        <div class="genre-scroll" id="genreScroll">
            <button class="genre-btn active" data-genre="pop">üé§ Pop</button>
            <button class="genre-btn" data-genre="rock">üé∏ Rock</button>
            <button class="genre-btn" data-genre="jazz">üé∑ Jazz</button>
            <button class="genre-btn" data-genre="blues">üé∫ Blues</button>
            <button class="genre-btn" data-genre="rnb">üíú R&B</button>
            <button class="genre-btn" data-genre="edm">‚ö° EDM</button>
            <button class="genre-btn" data-genre="country">ü§† Country</button>
            <button class="genre-btn" data-genre="folk">üåø Folk</button>
            <button class="genre-btn" data-genre="hiphop">üé§ Hip-Hop</button>
            <button class="genre-btn" data-genre="lofi">‚òï Lo-Fi</button>
            <button class="genre-btn" data-genre="cinematic">üé¨ Cinematic</button>
            <button class="genre-btn" data-genre="random">üé≤ Random</button>
        </div>

        <!-- Song Structure Builder -->
        <div class="structure-section">
            <div class="structure-header">
                <span class="structure-title">üéº Song Structure</span>
                <button class="btn btn-secondary btn-sm" id="autoStructureBtn">‚ú® Auto</button>
            </div>
            <div class="structure-timeline" id="structureTimeline">
                <div class="section-block verse active" data-section="0" data-type="verse">
                    <div class="section-name">Verse</div>
                    <div class="section-bars">4 bars</div>
                    <div class="section-chords">Tap Generate</div>
                    <span class="delete-section" onclick="deleteSection(0)">√ó</span>
                </div>
                <div class="add-section-btn" onclick="showAddSectionModal()">+</div>
            </div>
        </div>

        <!-- Generate Buttons -->
        <div class="generate-section">
            <button class="btn" id="generateBtn">‚ú® Generate</button>
            <button class="btn btn-ai" id="aiContinueBtn">ü§ñ AI Extend</button>
        </div>

        <!-- Chord Section -->
        <div class="chord-section">
            <div class="chord-header">
                <span class="chord-title">
                    üéπ Chords
                    <span class="current-section-badge section-label verse" id="currentSectionBadge">Verse</span>
                </span>
                <button class="btn btn-secondary btn-sm" id="addChordBtn">+ Add</button>
            </div>
            
            <div class="chord-display" id="chordDisplay">
                <p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">Tap Generate to create chords</p>
            </div>

            <!-- Playback -->
            <div class="playback-section">
                <div class="playback-controls">
                    <button class="control-btn" id="stopBtn">‚èπÔ∏è</button>
                    <button class="play-btn" id="playBtn">‚ñ∂Ô∏è</button>
                    <button class="control-btn" id="loopBtn">üîÅ</button>
                </div>

                <!-- Tempo Control -->
                <div class="tempo-control">
                    <div class="metronome-light" id="metronomeLight"></div>
                    <span style="font-size: 0.85rem;">BPM</span>
                    <input type="range" id="tempoSlider" min="60" max="180" value="120">
                    <span class="tempo-value" id="tempoValue">120</span>
                </div>

                <!-- Backing Track Controls -->
                <div class="backing-controls">
                    <button class="backing-btn active" id="pianoToggle"><span class="indicator"></span>üéπ Piano</button>
                    <button class="backing-btn" id="bassToggle"><span class="indicator"></span>üé∏ Bass</button>
                    <button class="backing-btn" id="drumsToggle"><span class="indicator"></span>ü•Å Drums</button>
                    <button class="backing-btn" id="metronomeToggle"><span class="indicator"></span>üìç Click</button>
                </div>

                <!-- Visualizer -->
                <div class="visualizer" id="visualizer">
                    <div class="viz-bar" style="height: 12px;"></div>
                    <div class="viz-bar" style="height: 20px;"></div>
                    <div class="viz-bar" style="height: 32px;"></div>
                    <div class="viz-bar" style="height: 18px;"></div>
                    <div class="viz-bar" style="height: 28px;"></div>
                    <div class="viz-bar" style="height: 15px;"></div>
                    <div class="viz-bar" style="height: 25px;"></div>
                    <div class="viz-bar" style="height: 35px;"></div>
                    <div class="viz-bar" style="height: 22px;"></div>
                    <div class="viz-bar" style="height: 30px;"></div>
                    <div class="viz-bar" style="height: 14px;"></div>
                    <div class="viz-bar" style="height: 26px;"></div>
                </div>
            </div>
        </div>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <h3>üìã Progression Info</h3>
                <p><strong>Pattern:</strong> <span id="patternName">‚Äî</span></p>
                <p><strong>Mood:</strong> <span id="moodName">‚Äî</span></p>
                <div id="famousSongs" style="margin-top: 0.5rem;"></div>
            </div>
            <div class="info-card">
                <h3>üîÑ Try Instead</h3>
                <div id="substitutions"><span class="tag">Generate chords first</span></div>
            </div>
        </div>
    </main>

    <!-- Bottom Drawer -->
    <div class="bottom-drawer" id="bottomDrawer">
        <div class="drawer-handle" id="drawerHandle">
            <div class="drawer-handle-bar"></div>
            <div class="drawer-tabs">
                <button class="drawer-tab active" data-panel="guitar">üé∏ Guitar</button>
                <button class="drawer-tab" data-panel="piano">üéπ Piano</button>
                <button class="drawer-tab" data-panel="tab">üìù Tab</button>
                <button class="drawer-tab" data-panel="strum">üëã Strum</button>
            </div>
        </div>
        <div class="drawer-content">
            <div class="drawer-panel active" id="panel-guitar">
                <div class="instrument-grid" id="guitarDiagrams">
                    <p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">Generate chords to see diagrams</p>
                </div>
            </div>
            <div class="drawer-panel" id="panel-piano">
                <div class="piano-container">
                    <div class="piano-roll" id="pianoRoll"></div>
                </div>
            </div>
            <div class="drawer-panel" id="panel-tab">
                <pre class="tab-notation" id="tabNotation">Generate chords to see tab</pre>
            </div>
            <div class="drawer-panel" id="panel-strum">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <select id="strumSelect" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.9rem; min-width: 200px;">
                        <option value="basic">Basic (D-D-D-D)</option>
                        <option value="folk">Folk (D-DU-UDU)</option>
                        <option value="pop">Pop (D-DU-D-DU)</option>
                        <option value="rock">Rock (D-D-DU-D)</option>
                    </select>
                </div>
                <div class="strum-pattern" id="strumPattern"></div>
            </div>
        </div>
    </div>

    <!-- Left Panel (History) -->
    <div class="side-panel" id="historyPanel">
        <div class="panel-header">
            <span class="panel-title">üìú History</span>
            <button class="close-btn" id="closeHistory">√ó</button>
        </div>
        <div class="panel-content">
            <div id="historyList">
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem 0;">Generate progressions to see history</p>
            </div>
        </div>
    </div>

    <!-- Right Panel (Export) -->
    <div class="side-panel right" id="lyricsPanel">
        <div class="panel-header">
            <span class="panel-title">‚úçÔ∏è Lyrics & Export</span>
            <button class="close-btn" id="closeLyrics">√ó</button>
        </div>
        <div class="panel-content">
            <h4 style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">LYRICS</h4>
            <div class="lyrics-editor" id="lyricsEditor">
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord0">C</span><input type="text" class="lyrics-text" placeholder="Write lyrics..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord1">G</span><input type="text" class="lyrics-text" placeholder="Continue..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord2">Am</span><input type="text" class="lyrics-text" placeholder="Add more..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord3">F</span><input type="text" class="lyrics-text" placeholder="Finish..."></div>
            </div>
            <div style="margin: 0.75rem 0; display: flex; gap: 0.5rem;">
                <button class="export-btn" style="flex: 1;" onclick="addLyricLine()">+ Line</button>
                <button class="export-btn" style="flex: 1;" id="aiLyricsBtn">ü§ñ AI Lyrics</button>
            </div>

            <h4 style="font-size: 0.75rem; color: var(--text-secondary); margin: 1.5rem 0 0.75rem;">EXPORT</h4>
            <div class="export-grid">
                <button class="export-btn" id="exportMidi">üéµ MIDI</button>
                <button class="export-btn" id="exportPdf">üìÑ PDF</button>
                <button class="export-btn" id="copyChords">üìã Copy</button>
                <button class="export-btn" id="shareLink">üîó Share</button>
            </div>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div class="modal" id="addSectionModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="modal-title">Add Section</h2>
                <button class="close-btn" onclick="document.getElementById('addSectionModal').classList.remove('show')">√ó</button>
            </div>
            <div class="section-options">
                <div class="section-option intro" onclick="addSection('intro')">üé¨<br>Intro</div>
                <div class="section-option verse" onclick="addSection('verse')">üìù<br>Verse</div>
                <div class="section-option chorus" onclick="addSection('chorus')">üé§<br>Chorus</div>
                <div class="section-option bridge" onclick="addSection('bridge')">üåâ<br>Bridge</div>
                <div class="section-option outro" onclick="addSection('outro')">üèÅ<br>Outro</div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- FAB -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <button class="fab fab-secondary" id="analyzeBtn" title="AI Analyze">üß†</button>
            <button class="fab fab-secondary" id="practiceBtn" title="Practice Mode">üéì</button>
        </div>
        <button class="fab fab-primary" id="fabMain">ü§ñ</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== CONSTANTS =====
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALES = { major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10], dorian: [0, 2, 3, 5, 7, 9, 10], mixolydian: [0, 2, 4, 5, 7, 9, 10], blues: [0, 3, 5, 6, 7, 10] };
        const CHORD_QUALITIES = { major: { intervals: [0, 4, 7], symbol: '' }, minor: { intervals: [0, 3, 7], symbol: 'm' }, diminished: { intervals: [0, 3, 6], symbol: 'dim' }, major7: { intervals: [0, 4, 7, 11], symbol: 'maj7' }, minor7: { intervals: [0, 3, 7, 10], symbol: 'm7' }, dominant7: { intervals: [0, 4, 7, 10], symbol: '7' } };
        const NUMERALS = { major: ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'], minor: ['i', 'ii¬∞', 'III', 'iv', 'v', 'VI', 'VII'] };
        const FUNCTIONS = ['Tonic', 'Supertonic', 'Mediant', 'Subdominant', 'Dominant', 'Submediant', 'Leading'];
        const GUITAR_CHORDS = { 'C': [-1, 3, 2, 0, 1, 0], 'D': [-1, -1, 0, 2, 3, 2], 'E': [0, 2, 2, 1, 0, 0], 'F': [1, 3, 3, 2, 1, 1], 'G': [3, 2, 0, 0, 0, 3], 'A': [-1, 0, 2, 2, 2, 0], 'B': [-1, 2, 4, 4, 4, 2], 'Cm': [-1, 3, 5, 5, 4, 3], 'Dm': [-1, -1, 0, 2, 3, 1], 'Em': [0, 2, 2, 0, 0, 0], 'Fm': [1, 3, 3, 1, 1, 1], 'Gm': [3, 5, 5, 3, 3, 3], 'Am': [-1, 0, 2, 2, 1, 0], 'Bm': [-1, 2, 4, 4, 3, 2] };
        const STRUM_PATTERNS = { basic: ['D', 'D', 'D', 'D'], folk: ['D', '-', 'D', 'U', '-', 'U', 'D', 'U'], pop: ['D', '-', 'D', 'U', 'D', '-', 'D', 'U'], rock: ['D', '-', 'D', '-', 'D', 'U', '-', 'D'] };
        const GENRE_PROGRESSIONS = {
            pop: { patterns: [[0, 4, 5, 3], [0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Uplifting & Catchy', songs: ['Let It Be', 'No Woman No Cry'] },
            rock: { patterns: [[0, 3, 4, 4], [0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'major'], mood: 'Powerful & Driving', songs: ['Back in Black', 'Sweet Child'] },
            jazz: { patterns: [[1, 4, 0, 0], [0, 5, 1, 4]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Sophisticated', songs: ['Autumn Leaves'] },
            blues: { patterns: [[0, 0, 0, 3]], qualities: ['dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7'], mood: 'Soulful', songs: ['Sweet Home Chicago'] },
            rnb: { patterns: [[0, 4, 3, 5]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Smooth', songs: ['No Scrubs'] },
            edm: { patterns: [[0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'minor'], mood: 'Energetic', songs: ['Titanium'] },
            country: { patterns: [[0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Warm & Heartfelt', songs: ['Wagon Wheel'] },
            folk: { patterns: [[0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Intimate', songs: ['Blowin In The Wind'] },
            hiphop: { patterns: [[0, 5, 3, 4]], qualities: ['minor7', 'minor7', 'minor7', 'minor7', 'minor7', 'minor7', 'minor7'], mood: 'Groovy', songs: ['Still D.R.E.'] },
            lofi: { patterns: [[1, 4, 0, 5]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Chill & Relaxing', songs: ['Lofi Beats'] },
            cinematic: { patterns: [[0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Epic & Emotional', songs: ['Time'] }
        };

        // ===== STATE =====
        let state = {
            key: 'C', scale: 'major', genre: 'pop', tempo: 120,
            song: { sections: [{ type: 'verse', chords: [], bars: 4 }], activeSection: 0 },
            isPlaying: false, isLooping: false,
            backing: { piano: true, bass: false, drums: false, metronome: false },
            history: [], theme: 'dark',
            synth: null, bassSynth: null, drumSynths: null, metronome: null,
            currentChordIndex: -1, currentBeat: 0,
            fabOpen: false, drawerOpen: false
        };

        // ===== HAPTIC FEEDBACK =====
        function haptic(type = 'light') {
            if ('vibrate' in navigator) {
                navigator.vibrate(type === 'light' ? 10 : type === 'medium' ? 20 : 30);
            }
        }

        // ===== AUDIO INITIALIZATION =====
        function initAudio() {
            if (!state.synth) {
                state.synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'triangle8' },
                    envelope: { attack: 0.02, decay: 0.4, sustain: 0.3, release: 1.2 }
                }).toDestination();
                state.synth.volume.value = -8;

                state.bassSynth = new Tone.MonoSynth({
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 },
                    filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 0.8, baseFrequency: 200, octaves: 3 }
                }).toDestination();
                state.bassSynth.volume.value = -12;

                state.drumSynths = {
                    kick: new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 6, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01 } }).toDestination(),
                    snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
                    hihat: new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.08, release: 0.01 }, harmonicity: 5.1, modulationIndex: 40, resonance: 4000, octaves: 1.5 }).toDestination()
                };
                state.drumSynths.kick.volume.value = -10;
                state.drumSynths.snare.volume.value = -14;
                state.drumSynths.hihat.volume.value = -20;

                state.metronome = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                state.metronome.volume.value = -15;
            }
        }

        // ===== CHORD FUNCTIONS =====
        function getNote(rootIndex, interval) { return NOTES[(rootIndex + interval) % 12]; }
        function buildChord(root, quality) { return CHORD_QUALITIES[quality].intervals.map(i => getNote(NOTES.indexOf(root), i)); }
        function getScaleNote(key, scale, degree) { return NOTES[(NOTES.indexOf(key) + (SCALES[scale] || SCALES.major)[degree % 7]) % 12]; }

        function generateProgression() {
            haptic('medium');
            const genre = GENRE_PROGRESSIONS[state.genre] || GENRE_PROGRESSIONS.pop;
            const pattern = genre.patterns[Math.floor(Math.random() * genre.patterns.length)];
            const chords = pattern.slice(0, 4).map((degree) => {
                const root = getScaleNote(state.key, state.scale, degree);
                const quality = genre.qualities[degree] || 'major';
                const notes = buildChord(root, quality);
                return {
                    root, quality,
                    symbol: root + CHORD_QUALITIES[quality].symbol,
                    notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                    bassNote: root + '2',
                    degree,
                    numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                    function: FUNCTIONS[degree]
                };
            });
            
            state.song.sections[state.song.activeSection].chords = chords;
            updateAllDisplays();
            saveToHistory();
            showToast('‚ú® Chords generated!');
        }

        function generateFullSong() {
            haptic('heavy');
            const structures = [
                ['intro', 'verse', 'chorus', 'verse', 'chorus', 'bridge', 'chorus', 'outro'],
                ['verse', 'chorus', 'verse', 'chorus', 'outro'],
                ['intro', 'verse', 'verse', 'chorus', 'verse', 'chorus', 'chorus']
            ];
            const structure = structures[Math.floor(Math.random() * structures.length)];
            
            state.song.sections = structure.map((type) => {
                const genre = GENRE_PROGRESSIONS[state.genre];
                const pattern = genre.patterns[Math.floor(Math.random() * genre.patterns.length)];
                const chords = pattern.slice(0, type === 'intro' || type === 'outro' ? 2 : 4).map(degree => {
                    const root = getScaleNote(state.key, state.scale, degree);
                    const quality = genre.qualities[degree] || 'major';
                    const notes = buildChord(root, quality);
                    return {
                        root, quality, symbol: root + CHORD_QUALITIES[quality].symbol,
                        notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                        bassNote: root + '2', degree,
                        numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                        function: FUNCTIONS[degree]
                    };
                });
                return { type, chords, bars: type === 'intro' || type === 'outro' ? 2 : 4 };
            });
            
            state.song.activeSection = 0;
            updateStructureTimeline();
            updateAllDisplays();
            showToast('üéº Full song generated!');
        }

        // ===== PLAYBACK =====
        async function playChord(chord) {
            await Tone.start();
            initAudio();
            if (state.backing.piano) {
                state.synth.triggerAttackRelease(chord.notes, '2n');
            }
            if (state.backing.bass) {
                state.bassSynth.triggerAttackRelease(chord.bassNote, '2n');
            }
        }

        async function playProgression() {
            if (state.isPlaying) { stopPlayback(); return; }
            await Tone.start();
            initAudio();
            
            state.isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è';
            haptic('medium');
            
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); stopPlayback(); return; }
            
            const beatDur = (60 / state.tempo) * 1000;
            let chordIdx = 0;
            state.currentBeat = 0;

            const playBeat = () => {
                if (!state.isPlaying) return;
                
                if (state.backing.metronome) {
                    state.metronome.triggerAttackRelease(state.currentBeat % 4 === 0 ? 'G5' : 'C5', '32n');
                }
                
                const light = document.getElementById('metronomeLight');
                light.classList.add('beat');
                setTimeout(() => light.classList.remove('beat'), 100);
                
                if (state.backing.drums) {
                    const beat = state.currentBeat % 8;
                    if (beat === 0 || beat === 4) state.drumSynths.kick.triggerAttackRelease('C1', '8n');
                    if (beat === 2 || beat === 6) state.drumSynths.snare.triggerAttackRelease('8n');
                    state.drumSynths.hihat.triggerAttackRelease('C6', '32n');
                }
                
                if (state.currentBeat % 4 === 0) {
                    chordIdx = Math.floor(state.currentBeat / 4) % section.chords.length;
                    highlightChord(chordIdx);
                    animateVisualizer();
                    playChord(section.chords[chordIdx]);
                }
                
                state.currentBeat++;
                
                if (state.currentBeat >= section.chords.length * 4) {
                    if (state.isLooping) {
                        state.currentBeat = 0;
                    } else {
                        stopPlayback();
                        return;
                    }
                }
                
                if (state.isPlaying) {
                    state.playbackTimeout = setTimeout(playBeat, beatDur);
                }
            };
            
            playBeat();
        }

        function stopPlayback() {
            state.isPlaying = false;
            state.currentBeat = 0;
            clearTimeout(state.playbackTimeout);
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            highlightChord(-1);
            haptic('light');
        }

        async function playChordAtIndex(i) {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords[i]) return;
            await Tone.start();
            initAudio();
            haptic('light');
            highlightChord(i);
            animateVisualizer();
            playChord(section.chords[i]);
            document.querySelectorAll('.chord-card')[i]?.classList.add('playing');
            setTimeout(() => {
                document.querySelectorAll('.chord-card')[i]?.classList.remove('playing');
                if (state.currentChordIndex === i && !state.isPlaying) highlightChord(-1);
            }, 800);
        }

        async function playNote(note) {
            await Tone.start();
            initAudio();
            haptic('light');
            state.synth.triggerAttackRelease(note, '8n');
        }

        function highlightChord(i) {
            document.querySelectorAll('.chord-card').forEach((c, idx) => c.classList.toggle('active', idx === i));
            state.currentChordIndex = i;
        }

        function animateVisualizer() {
            document.querySelectorAll('.viz-bar').forEach(b => {
                b.style.height = Math.random() * 35 + 10 + 'px';
            });
        }

        // ===== UI UPDATES =====
        function updateAllDisplays() {
            const section = state.song.sections[state.song.activeSection];
            const genre = GENRE_PROGRESSIONS[state.genre] || GENRE_PROGRESSIONS.pop;
            
            updateChordDisplay();
            updateStructureTimeline();
            updateGuitarDiagrams();
            updatePianoRoll();
            updateTabNotation();
            updateStrumPattern();
            updateLyricChords();
            updateSubstitutions();
            
            document.getElementById('patternName').textContent = section.chords.map(c => c.numeral).join(' - ') || '‚Äî';
            document.getElementById('moodName').textContent = genre.mood;
            document.getElementById('famousSongs').innerHTML = genre.songs.map(s => `<span class="tag">${s}</span>`).join('');
            
            const badge = document.getElementById('currentSectionBadge');
            badge.textContent = section.type.charAt(0).toUpperCase() + section.type.slice(1);
            badge.className = `current-section-badge section-label ${section.type}`;
        }

        function updateChordDisplay() {
            const section = state.song.sections[state.song.activeSection];
            document.getElementById('chordDisplay').innerHTML = section.chords.length ? section.chords.map((chord, i) => `
                <div class="chord-card" onclick="playChordAtIndex(${i})">
                    <div class="chord-name">${chord.symbol}</div>
                    <div class="chord-numeral">${chord.numeral}</div>
                    <div class="chord-function">${chord.function}</div>
                    <span class="chord-delete" onclick="event.stopPropagation(); deleteChord(${i})">√ó</span>
                </div>
            `).join('') : '<p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">Tap Generate to create chords</p>';
        }

        function updateStructureTimeline() {
            const timeline = document.getElementById('structureTimeline');
            timeline.innerHTML = state.song.sections.map((section, i) => `
                <div class="section-block ${section.type} ${i === state.song.activeSection ? 'active' : ''}" 
                     data-section="${i}" onclick="selectSection(${i})">
                    <div class="section-name">${section.type.charAt(0).toUpperCase() + section.type.slice(1)}</div>
                    <div class="section-bars">${section.bars} bars</div>
                    <div class="section-chords">${section.chords.map(c => c.symbol).join(' - ') || 'Empty'}</div>
                    ${state.song.sections.length > 1 ? `<span class="delete-section" onclick="event.stopPropagation(); deleteSection(${i})">√ó</span>` : ''}
                </div>
            `).join('') + '<div class="add-section-btn" onclick="showAddSectionModal()">+</div>';
        }

        function updateGuitarDiagrams() {
            const section = state.song.sections[state.song.activeSection];
            document.getElementById('guitarDiagrams').innerHTML = section.chords.map((chord, i) => {
                const frets = GUITAR_CHORDS[chord.symbol] || GUITAR_CHORDS[chord.root] || GUITAR_CHORDS['C'];
                return `<div class="instrument-chord" onclick="playChordAtIndex(${i})">
                    <div class="instrument-chord-name">${chord.symbol}</div>
                    <div class="chord-diagram">${createGuitarSVG(frets)}</div>
                    <div class="fret-info">${frets.map(f => f === -1 ? 'x' : f).join(' ')}</div>
                </div>`;
            }).join('') || '<p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">Generate chords to see diagrams</p>';
        }

        function createGuitarSVG(frets) {
            const stringX = [8, 19, 30, 41, 52, 63];
            let svg = `<svg viewBox="0 0 75 100"><rect x="8" y="12" width="55" height="3" fill="#f7c59f"/>`;
            for (let y = 15; y <= 80; y += 16) svg += `<line x1="8" y1="${y}" x2="63" y2="${y}" stroke="#444" stroke-width="1"/>`;
            stringX.forEach(x => svg += `<line x1="${x}" y1="15" x2="${x}" y2="80" stroke="#666" stroke-width="1.5"/>`);
            frets.forEach((fret, i) => {
                const x = stringX[i];
                if (fret === -1) svg += `<text x="${x}" y="8" text-anchor="middle" font-size="8" fill="#ff6b35">√ó</text>`;
                else if (fret === 0) svg += `<circle cx="${x}" cy="6" r="3" fill="none" stroke="#f7c59f" stroke-width="1.5"/>`;
                else if (fret <= 4) svg += `<circle cx="${x}" cy="${15 + (fret - 0.5) * 16}}" r="5" fill="#ff6b35"/>`;
            });
            return svg + '</svg>';
        }

        function updatePianoRoll() {
            const keys = [{ n: 'C', b: false }, { n: 'C#', b: true }, { n: 'D', b: false }, { n: 'D#', b: true }, { n: 'E', b: false }, { n: 'F', b: false }, { n: 'F#', b: true }, { n: 'G', b: false }, { n: 'G#', b: true }, { n: 'A', b: false }, { n: 'A#', b: true }, { n: 'B', b: false }];
            let html = '';
            for (let oct = 3; oct <= 5; oct++) {
                keys.forEach(k => {
                    html += `<div class="piano-key ${k.b ? 'black' : ''}" onclick="playNote('${k.n + oct}')"></div>`;
                });
            }
            document.getElementById('pianoRoll').innerHTML = html;
        }

        function updateTabNotation() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) {
                document.getElementById('tabNotation').innerHTML = 'Generate chords to see tab';
                return;
            }
            const strings = ['e', 'B', 'G', 'D', 'A', 'E'];
            let lines = strings.map(s => `${s}|`);
            section.chords.forEach(chord => {
                const frets = [...(GUITAR_CHORDS[chord.symbol] || GUITAR_CHORDS[chord.root] || GUITAR_CHORDS['C'])].reverse();
                frets.forEach((f, i) => { lines[i] += (f === -1 ? '-' : f.toString().padStart(2, '-').padEnd(3, '-')) + '-'; });
                lines = lines.map(l => l + '|');
            });
            document.getElementById('tabNotation').innerHTML = `<span style="color: var(--accent-secondary);">${section.chords.map(c => c.symbol.padEnd(5)).join('  ')}</span>\n${lines.join('\n')}`;
        }

        function updateStrumPattern() {
            const pattern = STRUM_PATTERNS[document.getElementById('strumSelect')?.value || 'basic'];
            document.getElementById('strumPattern').innerHTML = pattern.map((s, i) => `
                <div class="strum-beat">
                    <div class="strum-arrow ${s === 'D' ? 'down' : ''} ${s === '-' ? 'muted' : ''}">${s === '-' ? '‚Ä¢' : '‚Üë'}</div>
                    <div class="strum-count">${i + 1}</div>
                </div>
            `).join('');
        }

        function updateLyricChords() {
            const section = state.song.sections[state.song.activeSection];
            section.chords.forEach((c, i) => {
                const el = document.getElementById(`lyricChord${i}`);
                if (el) el.textContent = c.symbol;
            });
        }

        function updateSubstitutions() {
            const section = state.song.sections[state.song.activeSection];
            const subs = { 'I': ['iii', 'vi'], 'ii': ['IV'], 'IV': ['ii'], 'V': ['vii¬∞'], 'vi': ['I', 'IV'] };
            document.getElementById('substitutions').innerHTML = section.chords.slice(0, 4).map(c => {
                const alt = subs[c.numeral.replace('¬∞', '')] || [];
                return alt.length ? `<span class="tag">${c.symbol} ‚Üí ${alt.join(', ')}</span>` : '';
            }).filter(Boolean).join('') || '<span class="tag">Generate chords first</span>';
        }

        // ===== SECTION MANAGEMENT =====
        function selectSection(idx) {
            haptic('light');
            state.song.activeSection = idx;
            updateAllDisplays();
        }

        function showAddSectionModal() {
            haptic('light');
            document.getElementById('addSectionModal').classList.add('show');
        }

        function addSection(type) {
            haptic('medium');
            state.song.sections.push({ type, chords: [], bars: type === 'intro' || type === 'outro' ? 2 : 4 });
            state.song.activeSection = state.song.sections.length - 1;
            document.getElementById('addSectionModal').classList.remove('show');
            updateAllDisplays();
            showToast(`Added ${type}!`);
        }

        function deleteSection(idx) {
            if (state.song.sections.length <= 1) { showToast('Need at least one section'); return; }
            haptic('medium');
            state.song.sections.splice(idx, 1);
            if (state.song.activeSection >= state.song.sections.length) {
                state.song.activeSection = state.song.sections.length - 1;
            }
            updateAllDisplays();
        }

        function deleteChord(idx) {
            haptic('light');
            state.song.sections[state.song.activeSection].chords.splice(idx, 1);
            updateAllDisplays();
        }

        // ===== EXPORT FUNCTIONS =====
        function exportMidi() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            const NOTE_MAP = { 'C': 60, 'C#': 61, 'D': 62, 'D#': 63, 'E': 64, 'F': 65, 'F#': 66, 'G': 67, 'G#': 68, 'A': 69, 'A#': 70, 'B': 71 };
            const ticksPerBeat = 480;
            let track = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF];
            let trackData = [];
            const tempo = Math.round(60000000 / state.tempo);
            trackData.push(0, 0xFF, 0x51, 3, (tempo >> 16) & 0xFF, (tempo >> 8) & 0xFF, tempo & 0xFF);
            section.chords.forEach(chord => {
                const notes = chord.notes.map(n => { const note = n.replace(/\d/, ''); const oct = parseInt(n.match(/\d/)?.[0] || '4'); return NOTE_MAP[note] + (oct - 4) * 12; });
                notes.forEach((note, i) => trackData.push(i === 0 ? 0 : 0, 0x90, note, 100));
                trackData.push(0x87, 0x40);
                notes.forEach((note, i) => trackData.push(i === 0 ? 0 : 0, 0x80, note, 0));
            });
            trackData.push(0, 0xFF, 0x2F, 0);
            track.push(0x4D, 0x54, 0x72, 0x6B, (trackData.length >> 24) & 0xFF, (trackData.length >> 16) & 0xFF, (trackData.length >> 8) & 0xFF, trackData.length & 0xFF, ...trackData);
            const blob = new Blob([new Uint8Array(track)], { type: 'audio/midi' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `chordflow-${state.key}-${state.genre}.mid`; a.click();
            showToast('üéµ MIDI exported!');
        }

        function exportPdf() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(24); doc.setTextColor(255, 107, 53);
            doc.text('ChordFlow Lead Sheet', 105, 20, { align: 'center' });
            doc.setFontSize(12); doc.setTextColor(100);
            doc.text(`Key: ${state.key} ${state.scale} | Tempo: ${state.tempo} BPM | Genre: ${state.genre}`, 105, 30, { align: 'center' });
            doc.setFontSize(28); doc.setTextColor(0);
            doc.text(section.chords.map(c => c.symbol).join('   '), 105, 55, { align: 'center' });
            doc.save(`chordflow-${state.key}-${state.genre}.pdf`);
            showToast('üìÑ PDF exported!');
        }

        function copyChords() {
            const section = state.song.sections[state.song.activeSection];
            navigator.clipboard.writeText(section.chords.map(c => c.symbol).join(' | '));
            haptic('light');
            showToast('üìã Copied!');
        }

        function shareLink() {
            const params = new URLSearchParams({ key: state.key, scale: state.scale, genre: state.genre, tempo: state.tempo });
            navigator.clipboard.writeText(location.href.split('?')[0] + '?' + params);
            haptic('light');
            showToast('üîó Link copied!');
        }

        // ===== HISTORY =====
        function saveToHistory() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) return;
            state.history.unshift({
                id: Date.now(),
                key: state.key,
                scale: state.scale,
                genre: state.genre,
                progression: section.chords.map(c => c.symbol).join(' - '),
                timestamp: new Date().toLocaleTimeString()
            });
            if (state.history.length > 15) state.history.pop();
            updateHistoryDisplay();
            localStorage.setItem('chordflow-history', JSON.stringify(state.history));
        }

        function updateHistoryDisplay() {
            const list = document.getElementById('historyList');
            list.innerHTML = state.history.length ? state.history.map(h => `
                <div class="history-item" onclick="loadFromHistory(${h.id})">
                    <div>
                        <div class="history-prog">${h.progression}</div>
                        <div class="history-meta">${h.key} ${h.scale} ‚Ä¢ ${h.genre}</div>
                    </div>
                    <span class="history-meta">${h.timestamp}</span>
                </div>
            `).join('') : '<p style="color: var(--text-secondary); text-align: center; padding: 2rem 0;">Generate progressions to see history</p>';
        }

        function loadFromHistory(id) {
            const h = state.history.find(x => x.id === id);
            if (h) {
                haptic('medium');
                state.key = h.key;
                state.scale = h.scale;
                state.genre = h.genre;
                document.getElementById('keySelect').value = h.key;
                document.getElementById('scaleSelect').value = h.scale;
                generateProgression();
                closeAllPanels();
            }
        }

        // ===== LYRICS =====
        function addLyricLine() {
            const editor = document.getElementById('lyricsEditor');
            const section = state.song.sections[state.song.activeSection];
            const i = editor.children.length;
            const chord = section.chords[i % section.chords.length]?.symbol || 'C';
            editor.innerHTML += `<div class="lyrics-line"><span class="lyrics-chord">${chord}</span><input type="text" class="lyrics-text" placeholder="Add lyrics..."></div>`;
        }

        // ===== PANELS & UI =====
        function toggleDrawer() {
            state.drawerOpen = !state.drawerOpen;
            document.getElementById('bottomDrawer').classList.toggle('open', state.drawerOpen);
            haptic('light');
        }

        function openHistoryPanel() {
            haptic('light');
            document.getElementById('historyPanel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function openLyricsPanel() {
            haptic('light');
            document.getElementById('lyricsPanel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function closeAllPanels() {
            document.getElementById('historyPanel').classList.remove('open');
            document.getElementById('lyricsPanel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleFab() {
            state.fabOpen = !state.fabOpen;
            document.getElementById('fabMenu').classList.toggle('open', state.fabOpen);
            document.getElementById('fabMain').textContent = state.fabOpen ? '‚úï' : 'ü§ñ';
            haptic('light');
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.theme);
            document.getElementById('themeToggle').textContent = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('chordflow-theme', state.theme);
            haptic('light');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ===== AI EXTEND =====
        function aiContinue() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate first!'); return; }
            
            haptic('medium');
            const lastChord = section.chords[section.chords.length - 1];
            const suggestions = { 'I': [4, 3], 'ii': [4], 'IV': [4, 0], 'V': [0, 5], 'vi': [3, 1] };
            const nextDegrees = suggestions[lastChord.numeral.replace('¬∞', '')] || [0, 4];
            
            nextDegrees.slice(0, 2).forEach(degree => {
                const genre = GENRE_PROGRESSIONS[state.genre];
                const root = getScaleNote(state.key, state.scale, degree);
                const quality = genre.qualities[degree] || 'major';
                const notes = buildChord(root, quality);
                section.chords.push({
                    root, quality, symbol: root + CHORD_QUALITIES[quality].symbol,
                    notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                    bassNote: root + '2', degree,
                    numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                    function: FUNCTIONS[degree]
                });
            });
            
            updateAllDisplays();
            showToast('ü§ñ Added 2 chords!');
            if (state.fabOpen) toggleFab();
        }

        // ===== TOUCH GESTURES =====
        let touchStartY = 0;
        let touchStartX = 0;

        document.getElementById('drawerHandle').addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.getElementById('drawerHandle').addEventListener('touchmove', e => {
            const diff = touchStartY - e.touches[0].clientY;
            if (diff > 50 && !state.drawerOpen) {
                toggleDrawer();
            } else if (diff < -50 && state.drawerOpen) {
                toggleDrawer();
            }
        }, { passive: true });

        // ===== INIT =====
        function init() {
            // Load saved settings
            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme) { 
                state.theme = savedTheme; 
                document.documentElement.setAttribute('data-theme', savedTheme); 
                document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; 
            }
            
            const savedHistory = localStorage.getItem('chordflow-history');
            if (savedHistory) { 
                state.history = JSON.parse(savedHistory); 
                updateHistoryDisplay(); 
            }

            // Event listeners
            document.getElementById('generateBtn').addEventListener('click', generateProgression);
            document.getElementById('aiContinueBtn').addEventListener('click', aiContinue);
            document.getElementById('autoStructureBtn').addEventListener('click', generateFullSong);
            document.getElementById('playBtn').addEventListener('click', playProgression);
            document.getElementById('stopBtn').addEventListener('click', stopPlayback);
            document.getElementById('loopBtn').addEventListener('click', () => { 
                state.isLooping = !state.isLooping; 
                document.getElementById('loopBtn').classList.toggle('active', state.isLooping); 
                haptic('light');
                showToast(state.isLooping ? 'üîÅ Loop on' : 'üîÅ Loop off'); 
            });
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('menuBtn').addEventListener('click', openHistoryPanel);
            document.getElementById('lyricsBtn').addEventListener('click', openLyricsPanel);
            document.getElementById('closeHistory').addEventListener('click', closeAllPanels);
            document.getElementById('closeLyrics').addEventListener('click', closeAllPanels);
            document.getElementById('overlay').addEventListener('click', closeAllPanels);
            document.getElementById('drawerHandle').addEventListener('click', toggleDrawer);
            
            document.getElementById('fabMain').addEventListener('click', () => { 
                if (state.fabOpen) toggleFab(); 
                else toggleFab(); 
            });
            
            document.getElementById('analyzeBtn').addEventListener('click', () => {
                const section = state.song.sections[state.song.activeSection];
                if (!section.chords.length) { showToast('Generate first!'); return; }
                haptic('medium');
                showToast('üß† Coming soon: AI analysis!');
                toggleFab();
            });
            
            document.getElementById('practiceBtn').addEventListener('click', () => { 
                haptic('light');
                showToast('üéì Practice mode coming soon!'); 
                toggleFab(); 
            });

            // Tempo slider
            document.getElementById('tempoSlider').addEventListener('input', e => {
                state.tempo = parseInt(e.target.value);
                document.getElementById('tempoValue').textContent = state.tempo;
            });

            // Backing track toggles
            ['piano', 'bass', 'drums', 'metronome'].forEach(type => {
                document.getElementById(`${type}Toggle`).addEventListener('click', e => {
                    state.backing[type] = !state.backing[type];
                    e.currentTarget.classList.toggle('active', state.backing[type]);
                    haptic('light');
                });
            });

            // Selects
            document.getElementById('keySelect').addEventListener('change', e => state.key = e.target.value);
            document.getElementById('scaleSelect').addEventListener('change', e => state.scale = e.target.value);
            document.getElementById('strumSelect').addEventListener('change', updateStrumPattern);

            // Genre buttons
            document.querySelectorAll('.genre-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    haptic('light');
                    document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.genre = btn.dataset.genre === 'random' ? 
                        Object.keys(GENRE_PROGRESSIONS)[Math.floor(Math.random() * Object.keys(GENRE_PROGRESSIONS).length)] : 
                        btn.dataset.genre;
                });
            });

            // Drawer tabs
            document.querySelectorAll('.drawer-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    haptic('light');
                    document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.drawer-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`panel-${tab.dataset.panel}`).classList.add('active');
                });
            });

            // Exports
            document.getElementById('exportMidi').addEventListener('click', exportMidi);
            document.getElementById('exportPdf').addEventListener('click', exportPdf);
            document.getElementById('copyChords').addEventListener('click', copyChords);
            document.getElementById('shareLink').addEventListener('click', shareLink);

            // URL params
            const params = new URLSearchParams(location.search);
            if (params.has('key')) { state.key = params.get('key'); document.getElementById('keySelect').value = state.key; }
            if (params.has('scale')) { state.scale = params.get('scale'); document.getElementById('scaleSelect').value = state.scale; }
            if (params.has('genre')) { state.genre = params.get('genre'); }
            if (params.has('tempo')) { state.tempo = parseInt(params.get('tempo')); document.getElementById('tempoSlider').value = state.tempo; document.getElementById('tempoValue').textContent = state.tempo; }

            // Initial display
            updateAllDisplays();
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }

            // PWA Install
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', e => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBanner').classList.add('show');
            });

            document.getElementById('installBtn')?.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    document.getElementById('installBanner').classList.remove('show');
                }
            });

            // Visualizer animation
            setInterval(() => { if (state.isPlaying) animateVisualizer(); }, 150);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
