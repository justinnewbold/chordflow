<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AI-Powered Chord Progression Generator & Songwriting Suite">
    <meta name="theme-color" content="#ff6b35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChordFlow">
    
    <title>ChordFlow Pro | AI Songwriting Suite</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root, [data-theme="dark"] {
            --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-elevated: #1a1a24;
            --accent-primary: #ff6b35; --accent-secondary: #f7c59f; --accent-glow: #ff6b3540;
            --text-primary: #ffffff; --text-secondary: #9ca3af; --border-subtle: #1f1f2e;
            --success: #10b981; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
        }
        [data-theme="light"] {
            --bg-dark: #f8f9fa; --bg-card: #ffffff; --bg-elevated: #f0f0f5;
            --accent-primary: #ff6b35; --accent-secondary: #e85a24; --accent-glow: #ff6b3530;
            --text-primary: #1a1a2e; --text-secondary: #6b7280; --border-subtle: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        
        .bg-pattern { position: fixed; inset: 0; pointer-events: none; z-index: 0;
            background: radial-gradient(ellipse at 20% 20%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(247, 197, 159, 0.05) 0%, transparent 50%); }

        /* ===== HEADER ===== */
        .header { position: sticky; top: 0; z-index: 100; background: var(--bg-dark); border-bottom: 1px solid var(--border-subtle);
            padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .header-left { display: flex; align-items: center; gap: 0.5rem; }
        .menu-btn { background: none; border: none; color: var(--text-primary); font-size: 1.25rem; cursor: pointer; padding: 0.5rem; }
        .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-badge { font-size: 0.6rem; background: var(--accent-primary); color: white; padding: 0.15rem 0.4rem; border-radius: 8px; margin-left: 0.25rem; }
        .header-controls { display: flex; align-items: center; gap: 0.4rem; }
        .control-chip { display: flex; align-items: center; gap: 0.2rem; background: var(--bg-card); border: 1px solid var(--border-subtle);
            padding: 0.3rem 0.5rem; border-radius: 16px; font-size: 0.75rem; }
        .control-chip select { background: transparent; border: none; color: var(--text-primary); font-size: 0.75rem; cursor: pointer; max-width: 50px; }
        .control-chip select:focus { outline: none; }
        .icon-btn { background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-primary);
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; }
        .icon-btn:hover { border-color: var(--accent-primary); }
        .icon-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        /* ===== MAIN CONTENT ===== */
        .main-content { position: relative; z-index: 1; padding: 0.75rem; padding-bottom: 200px; max-width: 1000px; margin: 0 auto; }

        /* Install Banner */
        .install-banner { display: none; background: linear-gradient(135deg, var(--accent-primary), #ff8c5a); color: white;
            padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 0.75rem; align-items: center; justify-content: space-between; }
        .install-banner.show { display: flex; }
        .install-banner button { background: white; color: var(--accent-primary); border: none; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 600; cursor: pointer; }

        /* Genre Scroll */
        .genre-scroll { display: flex; gap: 0.4rem; overflow-x: auto; padding: 0.5rem 0; margin-bottom: 0.75rem;
            scrollbar-width: none; -ms-overflow-style: none; }
        .genre-scroll::-webkit-scrollbar { display: none; }
        .genre-btn { flex-shrink: 0; background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-secondary);
            padding: 0.4rem 0.8rem; border-radius: 16px; cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; white-space: nowrap; }
        .genre-btn:hover, .genre-btn.active { border-color: var(--accent-primary); color: var(--text-primary); background: rgba(255, 107, 53, 0.15); }

        /* Song Structure Builder */
        .structure-section { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 1rem; margin-bottom: 0.75rem; }
        .structure-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .structure-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); }
        .structure-timeline { display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem 0; scrollbar-width: none; }
        .structure-timeline::-webkit-scrollbar { display: none; }
        .section-block { flex-shrink: 0; min-width: 100px; padding: 0.6rem; border-radius: 10px; cursor: pointer; border: 2px solid transparent;
            transition: all 0.2s ease; text-align: center; position: relative; }
        .section-block.active { border-color: white; transform: scale(1.05); }
        .section-block.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-block.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-block.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-block.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-block.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .section-block .section-name { font-weight: 600; font-size: 0.8rem; }
        .section-block .section-bars { font-size: 0.65rem; opacity: 0.7; }
        .section-block .section-chords { font-size: 0.6rem; margin-top: 0.25rem; opacity: 0.8; }
        .section-block .delete-section { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--error);
            border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 0.7rem; color: white; cursor: pointer; }
        .section-block:hover .delete-section { display: flex; }
        .add-section-btn { flex-shrink: 0; width: 40px; height: 60px; border: 2px dashed var(--border-subtle); border-radius: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); font-size: 1.2rem; }
        .add-section-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

        /* Generate Section */
        .generate-section { display: flex; gap: 0.5rem; justify-content: center; margin: 1rem 0; flex-wrap: wrap; }
        .btn { background: linear-gradient(135deg, var(--accent-primary), #ff8c5a); color: white; border: none;
            padding: 0.6rem 1.5rem; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--accent-glow); }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #a855f7); }

        /* Chord Section */
        .chord-section { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 1rem; margin: 0.75rem 0; }
        .chord-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .chord-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; }
        .current-section-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }

        .chord-display { display: flex; flex-wrap: wrap; gap: 0.6rem; justify-content: center; margin: 1rem 0; }
        .chord-card { background: linear-gradient(145deg, var(--bg-elevated), var(--bg-dark)); border: 2px solid var(--border-subtle);
            border-radius: 14px; padding: 0.75rem 1rem; text-align: center; min-width: 70px; transition: all 0.3s ease; cursor: pointer; position: relative; }
        .chord-card:hover, .chord-card.active { border-color: var(--accent-primary); box-shadow: 0 0 25px var(--accent-glow); transform: scale(1.05); }
        .chord-card.playing { animation: pulse-glow 0.5s ease; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 25px var(--accent-glow); } 50% { box-shadow: 0 0 40px var(--accent-primary); } }
        .chord-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.75rem; color: var(--text-primary); }
        .chord-numeral { color: var(--accent-secondary); font-size: 0.75rem; margin-top: 0.15rem; }
        .chord-function { color: var(--text-secondary); font-size: 0.6rem; }
        .chord-card .chord-delete { position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: var(--error);
            border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 0.6rem; color: white; cursor: pointer; }
        .chord-card:hover .chord-delete { display: flex; }

        /* Playback Controls */
        .playback-section { background: var(--bg-elevated); border-radius: 12px; padding: 0.75rem; margin-top: 1rem; }
        .playback-controls { display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: wrap; }
        .play-btn { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), #ff8c5a);
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white;
            transition: all 0.3s ease; box-shadow: 0 4px 15px var(--accent-glow); }
        .play-btn:hover { transform: scale(1.1); }
        .control-btn { background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-primary);
            padding: 0.4rem 0.8rem; border-radius: 16px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem; }
        .control-btn:hover { border-color: var(--accent-primary); }
        .control-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        /* Metronome & Tempo */
        .tempo-control { display: flex; align-items: center; gap: 0.5rem; background: var(--bg-card); padding: 0.4rem 0.75rem; border-radius: 20px; }
        .tempo-control input[type="range"] { width: 80px; accent-color: var(--accent-primary); }
        .tempo-value { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; min-width: 45px; }
        .metronome-light { width: 10px; height: 10px; border-radius: 50%; background: var(--border-subtle); transition: all 0.1s; }
        .metronome-light.beat { background: var(--accent-primary); box-shadow: 0 0 10px var(--accent-primary); }

        /* Visualizer */
        .visualizer { height: 35px; display: flex; align-items: flex-end; justify-content: center; gap: 2px; margin-top: 0.75rem; }
        .viz-bar { width: 4px; background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary)); border-radius: 2px; transition: height 0.1s ease; }

        /* Backing Track Controls */
        .backing-controls { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.75rem; flex-wrap: wrap; }
        .backing-btn { display: flex; align-items: center; gap: 0.3rem; background: var(--bg-card); border: 1px solid var(--border-subtle);
            padding: 0.35rem 0.7rem; border-radius: 16px; font-size: 0.75rem; cursor: pointer; }
        .backing-btn:hover { border-color: var(--accent-primary); }
        .backing-btn.active { background: rgba(255, 107, 53, 0.2); border-color: var(--accent-primary); color: var(--accent-primary); }
        .backing-btn .indicator { width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); }
        .backing-btn.active .indicator { background: var(--accent-primary); }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin: 0.75rem 0; }
        .info-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 0.75rem; }
        .info-card h3 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .info-card p { font-size: 0.85rem; margin-bottom: 0.25rem; }
        .tag { display: inline-block; background: rgba(255, 107, 53, 0.2); color: var(--accent-secondary); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin: 0.1rem; }

        /* ===== BOTTOM DRAWER ===== */
        .bottom-drawer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; background: var(--bg-card);
            border-top: 1px solid var(--border-subtle); border-radius: 20px 20px 0 0;
            transform: translateY(calc(100% - 60px)); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 65vh; overflow: hidden; }
        .bottom-drawer.open { transform: translateY(0); }
        .drawer-handle { display: flex; flex-direction: column; align-items: center; padding: 0.5rem; cursor: pointer; }
        .drawer-handle-bar { width: 36px; height: 4px; background: var(--border-subtle); border-radius: 2px; margin-bottom: 0.4rem; }
        .drawer-tabs { display: flex; gap: 0.3rem; justify-content: center; padding: 0 0.5rem; overflow-x: auto; }
        .drawer-tab { padding: 0.4rem 0.75rem; border-radius: 16px; font-size: 0.75rem; background: transparent; border: none;
            color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
        .drawer-tab:hover { color: var(--text-primary); }
        .drawer-tab.active { background: rgba(255, 107, 53, 0.15); color: var(--accent-primary); }
        .drawer-content { padding: 0.75rem; overflow-y: auto; max-height: calc(65vh - 80px); }
        .drawer-panel { display: none; }
        .drawer-panel.active { display: block; }

        /* Instrument Grids */
        .instrument-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
        .instrument-chord { background: var(--bg-dark); border-radius: 10px; padding: 0.5rem; min-width: 90px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .instrument-chord:hover { border-color: var(--accent-primary); }
        .instrument-chord-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; color: var(--accent-primary); margin-bottom: 0.25rem; }
        .chord-diagram { width: 75px; height: 85px; margin: 0 auto; }
        .fret-info { font-size: 0.55rem; color: var(--text-secondary); margin-top: 0.15rem; font-family: 'JetBrains Mono', monospace; }

        /* Piano */
        .piano-container { overflow-x: auto; padding: 0.5rem 0; }
        .piano-roll { display: flex; justify-content: center; gap: 1px; min-width: fit-content; }
        .piano-key { width: 26px; height: 90px; background: white; border-radius: 0 0 4px 4px; cursor: pointer; border: 1px solid #ccc; }
        .piano-key.black { width: 18px; height: 58px; background: #1a1a25; margin: 0 -9px; z-index: 2; border-radius: 0 0 3px 3px; border: none; }
        .piano-key:hover { background: var(--accent-secondary); }
        .piano-key.black:hover { background: var(--accent-primary); }
        .piano-key.active { background: var(--accent-primary) !important; }

        /* Tab */
        .tab-notation { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--bg-dark); padding: 0.75rem; border-radius: 10px; overflow-x: auto; white-space: pre; }

        /* Strum */
        .strum-pattern { display: flex; justify-content: center; gap: 0.6rem; padding: 0.75rem; }
        .strum-beat { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; }
        .strum-arrow { font-size: 1.4rem; color: var(--accent-primary); }
        .strum-arrow.down { transform: rotate(180deg); }
        .strum-arrow.muted { color: var(--text-secondary); opacity: 0.5; }
        .strum-count { font-size: 0.65rem; color: var(--text-secondary); }

        /* ===== SIDE PANELS ===== */
        .side-panel { position: fixed; top: 0; bottom: 0; width: 300px; max-width: 85vw; z-index: 300;
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; }
        .side-panel.right { right: 0; left: auto; transform: translateX(100%); }
        .side-panel.open { transform: translateX(0); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-subtle);
            position: sticky; top: 0; background: var(--bg-card); z-index: 10; }
        .panel-title { font-size: 0.9rem; font-weight: 600; }
        .close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; cursor: pointer; }
        .panel-content { padding: 0.75rem; }

        /* History */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem; background: var(--bg-dark);
            border-radius: 8px; margin-bottom: 0.4rem; cursor: pointer; }
        .history-item:hover { background: rgba(255, 107, 53, 0.1); }
        .history-prog { font-weight: 500; font-size: 0.8rem; }
        .history-meta { font-size: 0.65rem; color: var(--text-secondary); }

        /* Lyrics */
        .lyrics-editor { background: var(--bg-dark); border-radius: 10px; padding: 0.75rem; }
        .lyrics-line { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; align-items: flex-start; }
        .lyrics-chord { background: var(--accent-primary); color: white; padding: 0.2rem 0.4rem; border-radius: 5px; font-size: 0.7rem; font-weight: 600; min-width: 40px; text-align: center; }
        .lyrics-text { flex: 1; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.3rem 0.4rem; border-radius: 5px; font-size: 0.8rem; }
        .lyrics-text:focus { border-color: var(--accent-primary); outline: none; }

        /* Export */
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
        .export-btn { background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary);
            padding: 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .export-btn:hover { border-color: var(--accent-primary); background: rgba(255, 107, 53, 0.1); }

        /* Section Labels */
        .section-label { font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 8px; }
        .section-label.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-label.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-label.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-label.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-label.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Overlay */
        .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 250; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* FAB */
        .fab-container { position: fixed; bottom: 80px; right: 0.75rem; z-index: 150; display: flex; flex-direction: column; align-items: flex-end; gap: 0.4rem; }
        .fab { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; }
        .fab:hover { transform: scale(1.1); }
        .fab-primary { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
        .fab-secondary { background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-primary); width: 42px; height: 42px; font-size: 1rem; }
        .fab-menu { display: flex; flex-direction: column; gap: 0.4rem; transform: scale(0); opacity: 0; transform-origin: bottom right; transition: all 0.3s ease; }
        .fab-menu.open { transform: scale(1); opacity: 1; }

        /* Toast */
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card);
            border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.6rem 1.25rem; border-radius: 20px; z-index: 1000;
            opacity: 0; transition: all 0.3s ease; font-size: 0.85rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 400; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; padding: 1.25rem; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; }

        /* Genre filters */
        .genre-filter { padding: 0.4rem 0.8rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 20px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .genre-filter:hover, .genre-filter.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        
        /* Song cards */
        .song-card { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .song-card:hover { border-color: var(--accent-primary); transform: translateY(-2px); }
        .song-card-title { font-weight: 600; margin-bottom: 0.25rem; }
        .song-card-meta { font-size: 0.8rem; color: var(--text-secondary); display: flex; gap: 1rem; flex-wrap: wrap; }
        .song-card-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .song-card-btn { padding: 0.4rem 0.75rem; font-size: 0.75rem; border-radius: 6px; border: none; cursor: pointer; }
        .song-card-btn.primary { background: var(--accent-primary); color: white; }
        .song-card-btn.secondary { background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-subtle); }
        .song-card-btn.danger { background: transparent; color: var(--error); border: 1px solid var(--error); }
        
        /* User button indicator */
        .user-btn.logged-in { background: var(--success); color: white; }
        .user-btn.logged-in::after { content: '‚úì'; position: absolute; bottom: -2px; right: -2px; font-size: 0.6rem; background: var(--success); border-radius: 50%; width: 12px; height: 12px; display: flex; align-items: center; justify-content: center; }

        /* Add Section Modal */
        .section-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .section-option { padding: 0.75rem; border-radius: 10px; cursor: pointer; text-align: center; border: 2px solid transparent; }
        .section-option:hover { border-color: white; }
        .section-option.intro { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .section-option.verse { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .section-option.chorus { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .section-option.bridge { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .section-option.outro { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Recording */
        .recording-indicator { position: fixed; top: 55px; left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 0.4rem;
            background: var(--error); color: white; padding: 0.4rem 0.8rem; border-radius: 16px; font-size: 0.8rem; z-index: 100; }
        .recording-indicator.active { display: flex; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Responsive */
        @media (max-width: 500px) {
            .header { padding: 0.4rem 0.5rem; }
            .logo { font-size: 1.2rem; }
            .control-chip { padding: 0.25rem 0.4rem; font-size: 0.7rem; }
            .chord-card { padding: 0.6rem 0.8rem; min-width: 60px; }
            .chord-name { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
        <span>üì± Install ChordFlow for offline use!</span>
        <button id="installBtn">Install</button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
            <h1 class="logo">CHORDFLOW<span class="version-badge">v5</span></h1>
        </div>
        <div class="header-controls">
            <div class="control-chip">
                <span>üéµ</span>
                <select id="keySelect">
                    <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option>
                    <option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option>
                    <option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
                </select>
            </div>
            <div class="control-chip">
                <select id="scaleSelect">
                    <option value="major">Maj</option><option value="minor">Min</option><option value="dorian">Dor</option>
                    <option value="mixolydian">Mix</option><option value="blues">Blu</option>
                </select>
            </div>
            <button class="icon-btn" id="metronomeBtn" title="Metronome">üéöÔ∏è</button>
            <button class="icon-btn" id="themeToggle" title="Theme">üåô</button>
            <button class="icon-btn" id="lyricsBtn" title="Lyrics & Export">üíæ</button>
            <button class="icon-btn" id="communityBtn" title="Community">üåê</button>
            <button class="icon-btn user-btn" id="userBtn" title="Account">üë§</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Genre Scroll -->
        <div class="genre-scroll" id="genreScroll">
            <button class="genre-btn active" data-genre="pop">Pop</button>
            <button class="genre-btn" data-genre="rock">Rock</button>
            <button class="genre-btn" data-genre="jazz">Jazz</button>
            <button class="genre-btn" data-genre="blues">Blues</button>
            <button class="genre-btn" data-genre="rnb">R&B</button>
            <button class="genre-btn" data-genre="edm">EDM</button>
            <button class="genre-btn" data-genre="country">Country</button>
            <button class="genre-btn" data-genre="folk">Folk</button>
            <button class="genre-btn" data-genre="hiphop">Hip-Hop</button>
            <button class="genre-btn" data-genre="latin">Latin</button>
            <button class="genre-btn" data-genre="gospel">Gospel</button>
            <button class="genre-btn" data-genre="lofi">Lo-Fi</button>
            <button class="genre-btn" data-genre="cinematic">Cinematic</button>
            <button class="genre-btn" data-genre="random">üé≤</button>
        </div>

        <!-- Song Structure Builder -->
        <div class="structure-section">
            <div class="structure-header">
                <span class="structure-title">üéº Song Structure</span>
                <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" id="autoStructureBtn">‚ú® Auto</button>
            </div>
            <div class="structure-timeline" id="structureTimeline">
                <div class="section-block verse active" data-section="0" data-type="verse">
                    <div class="section-name">Verse</div>
                    <div class="section-bars">4 bars</div>
                    <div class="section-chords">C - G - Am - F</div>
                    <span class="delete-section" onclick="deleteSection(0)">√ó</span>
                </div>
                <div class="add-section-btn" id="addSectionBtn">+</div>
            </div>
        </div>

        <!-- Generate Section -->
        <div class="generate-section">
            <button class="btn" id="generateBtn">‚ú® Generate</button>
            <button class="btn btn-ai" id="aiContinueBtn">ü§ñ AI Continue</button>
        </div>

        <!-- Chord Section -->
        <div class="chord-section">
            <div class="chord-header">
                <span class="chord-title">
                    üéπ Chords
                    <span class="current-section-badge section-label verse" id="currentSectionBadge">Verse</span>
                </span>
                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" id="addChordBtn">+ Add</button>
            </div>
            
            <div class="chord-display" id="chordDisplay"></div>

            <!-- Playback -->
            <div class="playback-section">
                <div class="playback-controls">
                    <button class="control-btn" id="stopBtn">‚èπÔ∏è</button>
                    <button class="play-btn" id="playBtn">‚ñ∂Ô∏è</button>
                    <button class="control-btn" id="loopBtn">üîÅ</button>
                    <div class="tempo-control">
                        <div class="metronome-light" id="metronomeLight"></div>
                        <input type="range" id="tempoSlider" min="60" max="180" value="120">
                        <span class="tempo-value" id="tempoValue">120</span>
                    </div>
                </div>

                <!-- Backing Track Controls -->
                <div class="backing-controls">
                    <button class="backing-btn active" id="pianoToggle"><span class="indicator"></span>üéπ Piano</button>
                    <button class="backing-btn" id="bassToggle"><span class="indicator"></span>üé∏ Bass</button>
                    <button class="backing-btn" id="drumsToggle"><span class="indicator"></span>ü•Å Drums</button>
                    <button class="backing-btn" id="metronomeToggle"><span class="indicator"></span>üìç Click</button>
                </div>

                <!-- Visualizer -->
                <div class="visualizer" id="visualizer">
                    <div class="viz-bar" style="height: 12px;"></div>
                    <div class="viz-bar" style="height: 20px;"></div>
                    <div class="viz-bar" style="height: 32px;"></div>
                    <div class="viz-bar" style="height: 18px;"></div>
                    <div class="viz-bar" style="height: 28px;"></div>
                    <div class="viz-bar" style="height: 15px;"></div>
                    <div class="viz-bar" style="height: 25px;"></div>
                    <div class="viz-bar" style="height: 35px;"></div>
                    <div class="viz-bar" style="height: 22px;"></div>
                    <div class="viz-bar" style="height: 30px;"></div>
                </div>
            </div>
        </div>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <h3>üìã Info</h3>
                <p><strong>Pattern:</strong> <span id="patternName">I - V - vi - IV</span></p>
                <p><strong>Mood:</strong> <span id="moodName">Uplifting</span></p>
                <div id="famousSongs" style="margin-top: 0.25rem;"></div>
            </div>
            <div class="info-card">
                <h3>üîÑ Substitutions</h3>
                <div id="substitutions"><span class="tag">Generate first</span></div>
            </div>
        </div>
    </main>

    <!-- Bottom Drawer -->
    <div class="bottom-drawer" id="bottomDrawer">
        <div class="drawer-handle" id="drawerHandle">
            <div class="drawer-handle-bar"></div>
            <div class="drawer-tabs">
                <button class="drawer-tab active" data-panel="guitar">üé∏ Guitar</button>
                <button class="drawer-tab" data-panel="piano">üéπ Piano</button>
                <button class="drawer-tab" data-panel="tab">üìù Tab</button>
                <button class="drawer-tab" data-panel="strum">üëã Strum</button>
            </div>
        </div>
        <div class="drawer-content">
            <div class="drawer-panel active" id="panel-guitar">
                <div class="instrument-grid" id="guitarDiagrams"></div>
            </div>
            <div class="drawer-panel" id="panel-piano">
                <div class="piano-container">
                    <div class="piano-roll" id="pianoRoll"></div>
                </div>
            </div>
            <div class="drawer-panel" id="panel-tab">
                <pre class="tab-notation" id="tabNotation"></pre>
            </div>
            <div class="drawer-panel" id="panel-strum">
                <div style="text-align: center; margin-bottom: 0.75rem;">
                    <select id="strumSelect" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.4rem; border-radius: 8px; font-size: 0.8rem;">
                        <option value="basic">Basic (D-D-D-D)</option>
                        <option value="folk">Folk (D-DU-UDU)</option>
                        <option value="pop">Pop (D-DU-D-DU)</option>
                        <option value="rock">Rock (D-D-DU-D)</option>
                    </select>
                </div>
                <div class="strum-pattern" id="strumPattern"></div>
            </div>
        </div>
    </div>

    <!-- Left Panel (History) -->
    <div class="side-panel" id="historyPanel">
        <div class="panel-header">
            <span class="panel-title">üìú History & Songs</span>
            <button class="close-btn" id="closeHistory">√ó</button>
        </div>
        <div class="panel-content">
            <h4 style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">SAVED SONGS</h4>
            <div id="savedSongs" style="margin-bottom: 1rem;">
                <p style="color: var(--text-secondary); font-size: 0.8rem; text-align: center;">No saved songs yet</p>
            </div>
            <h4 style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">RECENT</h4>
            <div id="historyList">
                <p style="color: var(--text-secondary); text-align: center; font-size: 0.8rem;">Generate to see history</p>
            </div>
        </div>
    </div>

    <!-- Right Panel (Lyrics & Export) -->
    <div class="side-panel right" id="lyricsPanel">
        <div class="panel-header">
            <span class="panel-title">‚úçÔ∏è Lyrics & Export</span>
            <button class="close-btn" id="closeLyrics">√ó</button>
        </div>
        <div class="panel-content">
            <h4 style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">LYRICS</h4>
            <div class="lyrics-editor" id="lyricsEditor">
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord0">C</span><input type="text" class="lyrics-text" placeholder="Write lyrics..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord1">G</span><input type="text" class="lyrics-text" placeholder="Continue..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord2">Am</span><input type="text" class="lyrics-text" placeholder="Add more..."></div>
                <div class="lyrics-line"><span class="lyrics-chord" id="lyricChord3">F</span><input type="text" class="lyrics-text" placeholder="Finish..."></div>
            </div>
            <div style="margin: 0.5rem 0; display: flex; gap: 0.4rem;">
                <button class="export-btn" style="flex: 1;" onclick="addLyricLine()">+ Line</button>
                <button class="export-btn" style="flex: 1;" id="aiLyricsBtn">ü§ñ AI Lyrics</button>
            </div>

            <h4 style="font-size: 0.7rem; color: var(--text-secondary); margin: 1rem 0 0.5rem;">EXPORT</h4>
            <div class="export-grid">
                <button class="export-btn" id="exportMidi">üéµ MIDI</button>
                <button class="export-btn" id="exportPdf">üìÑ PDF</button>
                <button class="export-btn" id="exportWav">üîä WAV</button>
                <button class="export-btn" id="exportTab">üìù Tab</button>
                <button class="export-btn" id="copyChords">üìã Copy</button>
                <button class="export-btn" id="shareLink">üîó Share</button>
            </div>
            <button class="export-btn" style="width: 100%; margin-top: 0.4rem;" id="saveSongBtn">üíæ Save Song</button>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div class="modal" id="addSectionModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h2 class="modal-title">Add Section</h2>
                <button class="close-btn" onclick="document.getElementById('addSectionModal').classList.remove('show')">√ó</button>
            </div>
            <div class="section-options">
                <div class="section-option intro" onclick="addSection('intro')">üé¨ Intro</div>
                <div class="section-option verse" onclick="addSection('verse')">üìù Verse</div>
                <div class="section-option chorus" onclick="addSection('chorus')">üé§ Chorus</div>
                <div class="section-option bridge" onclick="addSection('bridge')">üåâ Bridge</div>
                <div class="section-option outro" onclick="addSection('outro')">üèÅ Outro</div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content" style="max-width: 360px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="modal-title" id="authTitle">Sign In</h2>
                <button class="close-btn" onclick="document.getElementById('authModal').classList.remove('show')">√ó</button>
            </div>
            <div id="authForm">
                <input type="email" id="authEmail" placeholder="Email" style="width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                <input type="password" id="authPassword" placeholder="Password" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                <button onclick="handleAuth()" class="btn-primary" style="width: 100%; padding: 0.75rem; background: var(--accent-primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Sign In</button>
                <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <span id="authToggleText">Don't have an account?</span>
                    <a href="#" onclick="toggleAuthMode()" style="color: var(--accent-primary); text-decoration: none;"> <span id="authToggleLink">Sign Up</span></a>
                </p>
            </div>
            <div id="userProfile" style="display: none; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üë§</div>
                <div id="userEmail" style="font-weight: 600; margin-bottom: 0.5rem;"></div>
                <div id="userSongCount" style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">0 songs saved</div>
                <button onclick="cloudSave()" class="btn-primary" style="width: 100%; padding: 0.75rem; background: var(--success); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-bottom: 0.5rem;">‚òÅÔ∏è Save Current Song</button>
                <button onclick="showMySongs()" class="btn-secondary" style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-weight: 500; cursor: pointer; margin-bottom: 0.5rem;">üìÅ My Songs</button>
                <button onclick="handleLogout()" style="width: 100%; padding: 0.75rem; background: transparent; border: 1px solid var(--error); border-radius: 8px; color: var(--error); font-weight: 500; cursor: pointer;">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Community Modal -->
    <div class="modal" id="communityModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="modal-title">üåê Community Songs</h2>
                <button class="close-btn" onclick="document.getElementById('communityModal').classList.remove('show')">√ó</button>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <button onclick="loadCommunity('all')" class="genre-filter active" data-genre="all">All</button>
                <button onclick="loadCommunity('pop')" class="genre-filter" data-genre="pop">Pop</button>
                <button onclick="loadCommunity('rock')" class="genre-filter" data-genre="rock">Rock</button>
                <button onclick="loadCommunity('jazz')" class="genre-filter" data-genre="jazz">Jazz</button>
                <button onclick="loadCommunity('blues')" class="genre-filter" data-genre="blues">Blues</button>
                <button onclick="loadCommunity('edm')" class="genre-filter" data-genre="edm">EDM</button>
            </div>
            <div id="communityList" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Loading community songs...
                </div>
            </div>
        </div>
    </div>

    <!-- My Songs Modal -->
    <div class="modal" id="mySongsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="modal-title">üìÅ My Songs</h2>
                <button class="close-btn" onclick="document.getElementById('mySongsModal').classList.remove('show')">√ó</button>
            </div>
            <div id="mySongsList" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Loading your songs...
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content" style="max-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="modal-title">üîó Share Song</h2>
                <button class="close-btn" onclick="document.getElementById('shareModal').classList.remove('show')">√ó</button>
            </div>
            <input type="text" id="songTitleInput" placeholder="Song Title" style="width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="makePublic" checked> Make Public
                </label>
            </div>
            <button onclick="shareSong()" class="btn-primary" style="width: 100%; padding: 0.75rem; background: var(--accent-primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Generate Share Link</button>
            <div id="shareResult" style="display: none; margin-top: 1rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px;">
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Share this link:</p>
                <input type="text" id="shareLink" readonly style="width: 100%; padding: 0.5rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem;">
                <button onclick="copyShareLink()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--success); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.85rem;">üìã Copy Link</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- FAB -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <button class="fab fab-secondary" id="recordBtn" title="Record">üî¥</button>
            <button class="fab fab-secondary" id="analyzeBtn" title="AI Analyze">üß†</button>
            <button class="fab fab-secondary" id="practiceBtn" title="Practice">üéì</button>
        </div>
        <button class="fab fab-primary" id="fabMain">ü§ñ</button>
    </div>

    <!-- Recording Indicator -->
    <div class="recording-indicator" id="recordingIndicator">
        <span style="width: 8px; height: 8px; background: white; border-radius: 50%;"></span>
        Recording...
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== CONSTANTS =====
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALES = { major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10], dorian: [0, 2, 3, 5, 7, 9, 10], mixolydian: [0, 2, 4, 5, 7, 9, 10], blues: [0, 3, 5, 6, 7, 10] };
        const CHORD_QUALITIES = { major: { intervals: [0, 4, 7], symbol: '' }, minor: { intervals: [0, 3, 7], symbol: 'm' }, diminished: { intervals: [0, 3, 6], symbol: 'dim' }, major7: { intervals: [0, 4, 7, 11], symbol: 'maj7' }, minor7: { intervals: [0, 3, 7, 10], symbol: 'm7' }, dominant7: { intervals: [0, 4, 7, 10], symbol: '7' } };
        const NUMERALS = { major: ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'], minor: ['i', 'ii¬∞', 'III', 'iv', 'v', 'VI', 'VII'] };
        const FUNCTIONS = ['Tonic', 'Supertonic', 'Mediant', 'Subdominant', 'Dominant', 'Submediant', 'Leading'];
        const GUITAR_CHORDS = { 'C': [-1, 3, 2, 0, 1, 0], 'D': [-1, -1, 0, 2, 3, 2], 'E': [0, 2, 2, 1, 0, 0], 'F': [1, 3, 3, 2, 1, 1], 'G': [3, 2, 0, 0, 0, 3], 'A': [-1, 0, 2, 2, 2, 0], 'B': [-1, 2, 4, 4, 4, 2], 'Cm': [-1, 3, 5, 5, 4, 3], 'Dm': [-1, -1, 0, 2, 3, 1], 'Em': [0, 2, 2, 0, 0, 0], 'Fm': [1, 3, 3, 1, 1, 1], 'Gm': [3, 5, 5, 3, 3, 3], 'Am': [-1, 0, 2, 2, 1, 0], 'Bm': [-1, 2, 4, 4, 3, 2] };
        const STRUM_PATTERNS = { basic: ['D', 'D', 'D', 'D'], folk: ['D', '-', 'D', 'U', '-', 'U', 'D', 'U'], pop: ['D', '-', 'D', 'U', 'D', '-', 'D', 'U'], rock: ['D', '-', 'D', '-', 'D', 'U', '-', 'D'] };
        const GENRE_PROGRESSIONS = {
            pop: { patterns: [[0, 4, 5, 3], [0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Uplifting, Catchy', songs: ['Let It Be', 'No Woman No Cry'] },
            rock: { patterns: [[0, 3, 4, 4], [0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'major'], mood: 'Powerful, Driving', songs: ['Back in Black', 'Sweet Child'] },
            jazz: { patterns: [[1, 4, 0, 0], [0, 5, 1, 4]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Sophisticated', songs: ['Autumn Leaves'] },
            blues: { patterns: [[0, 0, 0, 3]], qualities: ['dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7', 'dominant7'], mood: 'Soulful', songs: ['Sweet Home Chicago'] },
            rnb: { patterns: [[0, 4, 3, 5]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Smooth', songs: ['No Scrubs'] },
            edm: { patterns: [[0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'minor'], mood: 'Energetic', songs: ['Titanium'] },
            country: { patterns: [[0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Warm', songs: ['Wagon Wheel'] },
            folk: { patterns: [[0, 4, 0, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Intimate', songs: ['Blowin In The Wind'] },
            hiphop: { patterns: [[0, 5, 3, 4]], qualities: ['minor7', 'minor7', 'minor7', 'minor7', 'minor7', 'minor7', 'minor7'], mood: 'Groovy', songs: ['Still D.R.E.'] },
            latin: { patterns: [[0, 3, 4, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Passionate', songs: ['Despacito'] },
            gospel: { patterns: [[0, 4, 3, 4, 0]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Uplifting', songs: ['Oh Happy Day'] },
            lofi: { patterns: [[1, 4, 0, 5]], qualities: ['major7', 'minor7', 'minor7', 'major7', 'dominant7', 'minor7', 'minor7'], mood: 'Chill', songs: ['Lofi Beats'] },
            cinematic: { patterns: [[0, 5, 3, 4]], qualities: ['major', 'minor', 'minor', 'major', 'major', 'minor', 'diminished'], mood: 'Epic', songs: ['Time'] }
        };
        const SECTION_COLORS = { intro: '#fbbf24', verse: '#60a5fa', chorus: '#c084fc', bridge: '#4ade80', outro: '#f87171' };

        // ===== STATE =====
        let state = {
            key: 'C', scale: 'major', genre: 'pop', tempo: 120,
            song: {
                sections: [{ type: 'verse', chords: [], bars: 4 }],
                activeSection: 0
            },
            isPlaying: false, isLooping: false, isRecording: false,
            backing: { piano: true, bass: false, drums: false, metronome: false },
            history: [], theme: 'dark',
            synth: null, bassSynth: null, drumSynths: null, metronome: null,
            currentChordIndex: -1, currentBeat: 0,
            fabOpen: false, drawerOpen: false
        };

        // ===== AUDIO INITIALIZATION =====
        function initAudio() {
            if (!state.synth) {
                // Main Piano Synth - warmer sound
                state.synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'triangle8' },
                    envelope: { attack: 0.02, decay: 0.4, sustain: 0.3, release: 1.2 }
                }).toDestination();
                state.synth.volume.value = -8;

                // Bass Synth
                state.bassSynth = new Tone.MonoSynth({
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 },
                    filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 0.8, baseFrequency: 200, octaves: 3 }
                }).toDestination();
                state.bassSynth.volume.value = -12;

                // Drum Synths
                state.drumSynths = {
                    kick: new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 6, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01 } }).toDestination(),
                    snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
                    hihat: new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.08, release: 0.01 }, harmonicity: 5.1, modulationIndex: 40, resonance: 4000, octaves: 1.5 }).toDestination()
                };
                state.drumSynths.kick.volume.value = -10;
                state.drumSynths.snare.volume.value = -14;
                state.drumSynths.hihat.volume.value = -20;

                // Metronome
                state.metronome = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                state.metronome.volume.value = -15;
            }
        }

        // ===== CHORD FUNCTIONS =====
        function getNote(rootIndex, interval) { return NOTES[(rootIndex + interval) % 12]; }
        function buildChord(root, quality) { return CHORD_QUALITIES[quality].intervals.map(i => getNote(NOTES.indexOf(root), i)); }
        function getScaleNote(key, scale, degree) { return NOTES[(NOTES.indexOf(key) + (SCALES[scale] || SCALES.major)[degree % 7]) % 12]; }

        function generateProgression() {
            const genre = GENRE_PROGRESSIONS[state.genre] || GENRE_PROGRESSIONS.pop;
            const pattern = genre.patterns[Math.floor(Math.random() * genre.patterns.length)];
            const chords = pattern.slice(0, 4).map((degree) => {
                const root = getScaleNote(state.key, state.scale, degree);
                const quality = genre.qualities[degree] || 'major';
                const notes = buildChord(root, quality);
                return {
                    root, quality,
                    symbol: root + CHORD_QUALITIES[quality].symbol,
                    notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                    bassNote: root + '2',
                    degree,
                    numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                    function: FUNCTIONS[degree]
                };
            });
            
            state.song.sections[state.song.activeSection].chords = chords;
            updateAllDisplays();
            saveToHistory();
            showToast('‚ú® Generated!');
        }

        function generateFullSong() {
            const structures = [
                ['intro', 'verse', 'chorus', 'verse', 'chorus', 'bridge', 'chorus', 'outro'],
                ['verse', 'chorus', 'verse', 'chorus', 'outro'],
                ['intro', 'verse', 'verse', 'chorus', 'verse', 'chorus', 'chorus']
            ];
            const structure = structures[Math.floor(Math.random() * structures.length)];
            
            state.song.sections = structure.map((type, i) => {
                const genre = GENRE_PROGRESSIONS[state.genre];
                const pattern = genre.patterns[Math.floor(Math.random() * genre.patterns.length)];
                const chords = pattern.slice(0, type === 'intro' || type === 'outro' ? 2 : 4).map(degree => {
                    const root = getScaleNote(state.key, state.scale, degree);
                    const quality = genre.qualities[degree] || 'major';
                    const notes = buildChord(root, quality);
                    return {
                        root, quality, symbol: root + CHORD_QUALITIES[quality].symbol,
                        notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                        bassNote: root + '2', degree,
                        numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                        function: FUNCTIONS[degree]
                    };
                });
                return { type, chords, bars: type === 'intro' || type === 'outro' ? 2 : 4 };
            });
            
            state.song.activeSection = 0;
            updateStructureTimeline();
            updateAllDisplays();
            showToast('üéº Full song generated!');
        }

        // ===== PLAYBACK =====
        async function playChord(chord) {
            await Tone.start();
            initAudio();
            if (state.backing.piano) {
                state.synth.triggerAttackRelease(chord.notes, '2n');
            }
            if (state.backing.bass) {
                state.bassSynth.triggerAttackRelease(chord.bassNote, '2n');
            }
        }

        async function playProgression() {
            if (state.isPlaying) { stopPlayback(); return; }
            await Tone.start();
            initAudio();
            
            state.isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è';
            
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); stopPlayback(); return; }
            
            const beatDur = (60 / state.tempo) * 1000;
            const chordDur = beatDur * 4;
            let chordIdx = 0;
            state.currentBeat = 0;

            const playBeat = () => {
                if (!state.isPlaying) return;
                
                // Metronome click
                if (state.backing.metronome) {
                    state.metronome.triggerAttackRelease(state.currentBeat % 4 === 0 ? 'G5' : 'C5', '32n');
                }
                
                // Visual metronome
                const light = document.getElementById('metronomeLight');
                light.classList.add('beat');
                setTimeout(() => light.classList.remove('beat'), 100);
                
                // Drums
                if (state.backing.drums) {
                    const beat = state.currentBeat % 8;
                    if (beat === 0 || beat === 4) state.drumSynths.kick.triggerAttackRelease('C1', '8n');
                    if (beat === 2 || beat === 6) state.drumSynths.snare.triggerAttackRelease('8n');
                    state.drumSynths.hihat.triggerAttackRelease('C6', '32n');
                }
                
                // Play chord on beat 0 of each measure
                if (state.currentBeat % 4 === 0) {
                    chordIdx = Math.floor(state.currentBeat / 4) % section.chords.length;
                    highlightChord(chordIdx);
                    animateVisualizer();
                    playChord(section.chords[chordIdx]);
                }
                
                state.currentBeat++;
                
                // Check for loop/end
                if (state.currentBeat >= section.chords.length * 4) {
                    if (state.isLooping) {
                        state.currentBeat = 0;
                    } else {
                        stopPlayback();
                        return;
                    }
                }
                
                if (state.isPlaying) {
                    state.playbackTimeout = setTimeout(playBeat, beatDur);
                }
            };
            
            playBeat();
        }

        function stopPlayback() {
            state.isPlaying = false;
            state.currentBeat = 0;
            clearTimeout(state.playbackTimeout);
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            highlightChord(-1);
        }

        async function playChordAtIndex(i) {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords[i]) return;
            await Tone.start();
            initAudio();
            highlightChord(i);
            animateVisualizer();
            playChord(section.chords[i]);
            document.querySelectorAll('.chord-card')[i]?.classList.add('playing');
            setTimeout(() => {
                document.querySelectorAll('.chord-card')[i]?.classList.remove('playing');
                if (state.currentChordIndex === i && !state.isPlaying) highlightChord(-1);
            }, 800);
        }

        async function playNote(note) {
            await Tone.start();
            initAudio();
            state.synth.triggerAttackRelease(note, '8n');
        }

        function highlightChord(i) {
            document.querySelectorAll('.chord-card').forEach((c, idx) => c.classList.toggle('active', idx === i));
            state.currentChordIndex = i;
        }

        function animateVisualizer() {
            document.querySelectorAll('.viz-bar').forEach(b => {
                b.style.height = Math.random() * 30 + 8 + 'px';
            });
        }

        // ===== UI UPDATES =====
        function updateAllDisplays() {
            const section = state.song.sections[state.song.activeSection];
            const genre = GENRE_PROGRESSIONS[state.genre] || GENRE_PROGRESSIONS.pop;
            
            updateChordDisplay();
            updateStructureTimeline();
            updateGuitarDiagrams();
            updatePianoRoll();
            updateTabNotation();
            updateStrumPattern();
            updateLyricChords();
            updateSubstitutions();
            
            document.getElementById('patternName').textContent = section.chords.map(c => c.numeral).join(' - ') || '-';
            document.getElementById('moodName').textContent = genre.mood;
            document.getElementById('famousSongs').innerHTML = genre.songs.map(s => `<span class="tag">${s}</span>`).join('');
            
            // Update section badge
            const badge = document.getElementById('currentSectionBadge');
            badge.textContent = section.type.charAt(0).toUpperCase() + section.type.slice(1);
            badge.className = `current-section-badge section-label ${section.type}`;
        }

        function updateChordDisplay() {
            const section = state.song.sections[state.song.activeSection];
            document.getElementById('chordDisplay').innerHTML = section.chords.length ? section.chords.map((chord, i) => `
                <div class="chord-card" onclick="playChordAtIndex(${i})">
                    <div class="chord-name">${chord.symbol}</div>
                    <div class="chord-numeral">${chord.numeral}</div>
                    <div class="chord-function">${chord.function}</div>
                    <span class="chord-delete" onclick="event.stopPropagation(); deleteChord(${i})">√ó</span>
                </div>
            `).join('') : '<p style="color: var(--text-secondary); text-align: center; width: 100%;">Click Generate to create chords</p>';
        }

        function updateStructureTimeline() {
            const timeline = document.getElementById('structureTimeline');
            timeline.innerHTML = state.song.sections.map((section, i) => `
                <div class="section-block ${section.type} ${i === state.song.activeSection ? 'active' : ''}" 
                     data-section="${i}" onclick="selectSection(${i})">
                    <div class="section-name">${section.type.charAt(0).toUpperCase() + section.type.slice(1)}</div>
                    <div class="section-bars">${section.bars} bars</div>
                    <div class="section-chords">${section.chords.map(c => c.symbol).join(' - ') || 'Empty'}</div>
                    ${state.song.sections.length > 1 ? `<span class="delete-section" onclick="event.stopPropagation(); deleteSection(${i})">√ó</span>` : ''}
                </div>
            `).join('') + '<div class="add-section-btn" onclick="showAddSectionModal()">+</div>';
        }

        function updateGuitarDiagrams() {
            const section = state.song.sections[state.song.activeSection];
            document.getElementById('guitarDiagrams').innerHTML = section.chords.map((chord, i) => {
                const frets = GUITAR_CHORDS[chord.symbol] || GUITAR_CHORDS[chord.root] || GUITAR_CHORDS['C'];
                return `<div class="instrument-chord" onclick="playChordAtIndex(${i})">
                    <div class="instrument-chord-name">${chord.symbol}</div>
                    <div class="chord-diagram">${createGuitarSVG(frets)}</div>
                    <div class="fret-info">${frets.map(f => f === -1 ? 'x' : f).join(' ')}</div>
                </div>`;
            }).join('') || '<p style="color: var(--text-secondary); text-align: center; width: 100%;">Generate chords to see diagrams</p>';
        }

        function createGuitarSVG(frets) {
            const stringX = [8, 17, 26, 35, 44, 53];
            let svg = `<svg viewBox="0 0 65 85"><rect x="8" y="10" width="45" height="2.5" fill="#f7c59f"/>`;
            for (let y = 12; y <= 66; y += 13.5) svg += `<line x1="8" y1="${y}" x2="53" y2="${y}" stroke="#444"/>`;
            stringX.forEach(x => svg += `<line x1="${x}" y1="12" x2="${x}" y2="66" stroke="#666"/>`);
            frets.forEach((fret, i) => {
                const x = stringX[i];
                if (fret === -1) svg += `<text x="${x}" y="7" text-anchor="middle" font-size="7" fill="#ff6b35">√ó</text>`;
                else if (fret === 0) svg += `<circle cx="${x}" cy="5" r="2.5" fill="none" stroke="#f7c59f" stroke-width="1.5"/>`;
                else if (fret <= 4) svg += `<circle cx="${x}" cy="${12 + (fret - 0.5) * 13.5}" r="3.5" fill="#ff6b35"/>`;
            });
            return svg + '</svg>';
        }

        function updatePianoRoll() {
            const keys = [{ n: 'C', b: false }, { n: 'C#', b: true }, { n: 'D', b: false }, { n: 'D#', b: true }, { n: 'E', b: false }, { n: 'F', b: false }, { n: 'F#', b: true }, { n: 'G', b: false }, { n: 'G#', b: true }, { n: 'A', b: false }, { n: 'A#', b: true }, { n: 'B', b: false }];
            let html = '';
            for (let oct = 3; oct <= 5; oct++) {
                keys.forEach(k => {
                    html += `<div class="piano-key ${k.b ? 'black' : ''}" onclick="playNote('${k.n + oct}')"></div>`;
                });
            }
            document.getElementById('pianoRoll').innerHTML = html;
        }

        function updateTabNotation() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) {
                document.getElementById('tabNotation').innerHTML = 'Generate chords to see tab';
                return;
            }
            const strings = ['e', 'B', 'G', 'D', 'A', 'E'];
            let lines = strings.map(s => `${s}|`);
            section.chords.forEach(chord => {
                const frets = [...(GUITAR_CHORDS[chord.symbol] || GUITAR_CHORDS[chord.root] || GUITAR_CHORDS['C'])].reverse();
                frets.forEach((f, i) => { lines[i] += (f === -1 ? '-' : f.toString().padStart(2, '-').padEnd(3, '-')) + '-'; });
                lines = lines.map(l => l + '|');
            });
            document.getElementById('tabNotation').innerHTML = `<span style="color: var(--accent-secondary);">${section.chords.map(c => c.symbol.padEnd(5)).join('  ')}</span>\n${lines.join('\n')}`;
        }

        function updateStrumPattern() {
            const pattern = STRUM_PATTERNS[document.getElementById('strumSelect')?.value || 'basic'];
            document.getElementById('strumPattern').innerHTML = pattern.map((s, i) => `
                <div class="strum-beat">
                    <div class="strum-arrow ${s === 'D' ? 'down' : ''} ${s === '-' ? 'muted' : ''}">${s === '-' ? '‚Ä¢' : '‚Üë'}</div>
                    <div class="strum-count">${i + 1}</div>
                </div>
            `).join('');
        }

        function updateLyricChords() {
            const section = state.song.sections[state.song.activeSection];
            section.chords.forEach((c, i) => {
                const el = document.getElementById(`lyricChord${i}`);
                if (el) el.textContent = c.symbol;
            });
        }

        function updateSubstitutions() {
            const section = state.song.sections[state.song.activeSection];
            const subs = { 'I': ['iii', 'vi'], 'ii': ['IV'], 'IV': ['ii'], 'V': ['vii¬∞'], 'vi': ['I', 'IV'] };
            document.getElementById('substitutions').innerHTML = section.chords.slice(0, 4).map(c => {
                const alt = subs[c.numeral.replace('¬∞', '')] || [];
                return alt.length ? `<span class="tag">${c.symbol} ‚Üí ${alt.join(', ')}</span>` : '';
            }).filter(Boolean).join('') || '<span class="tag">No subs available</span>';
        }

        // ===== SECTION MANAGEMENT =====
        function selectSection(idx) {
            state.song.activeSection = idx;
            updateAllDisplays();
        }

        function showAddSectionModal() {
            document.getElementById('addSectionModal').classList.add('show');
        }

        function addSection(type) {
            state.song.sections.push({ type, chords: [], bars: type === 'intro' || type === 'outro' ? 2 : 4 });
            state.song.activeSection = state.song.sections.length - 1;
            document.getElementById('addSectionModal').classList.remove('show');
            updateAllDisplays();
            showToast(`Added ${type}`);
        }

        function deleteSection(idx) {
            if (state.song.sections.length <= 1) { showToast('Need at least one section'); return; }
            state.song.sections.splice(idx, 1);
            if (state.song.activeSection >= state.song.sections.length) {
                state.song.activeSection = state.song.sections.length - 1;
            }
            updateAllDisplays();
        }

        function deleteChord(idx) {
            state.song.sections[state.song.activeSection].chords.splice(idx, 1);
            updateAllDisplays();
        }

        // ===== EXPORT FUNCTIONS =====
        function exportMidi() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            const NOTE_MAP = { 'C': 60, 'C#': 61, 'D': 62, 'D#': 63, 'E': 64, 'F': 65, 'F#': 66, 'G': 67, 'G#': 68, 'A': 69, 'A#': 70, 'B': 71 };
            const ticksPerBeat = 480;
            let track = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF];
            let trackData = [];
            const tempo = Math.round(60000000 / state.tempo);
            trackData.push(0, 0xFF, 0x51, 3, (tempo >> 16) & 0xFF, (tempo >> 8) & 0xFF, tempo & 0xFF);
            section.chords.forEach(chord => {
                const notes = chord.notes.map(n => { const note = n.replace(/\d/, ''); const oct = parseInt(n.match(/\d/)?.[0] || '4'); return NOTE_MAP[note] + (oct - 4) * 12; });
                notes.forEach((note, i) => trackData.push(i === 0 ? 0 : 0, 0x90, note, 100));
                trackData.push(0x87, 0x40);
                notes.forEach((note, i) => trackData.push(i === 0 ? 0 : 0, 0x80, note, 0));
            });
            trackData.push(0, 0xFF, 0x2F, 0);
            track.push(0x4D, 0x54, 0x72, 0x6B, (trackData.length >> 24) & 0xFF, (trackData.length >> 16) & 0xFF, (trackData.length >> 8) & 0xFF, trackData.length & 0xFF, ...trackData);
            const blob = new Blob([new Uint8Array(track)], { type: 'audio/midi' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `chordflow-${state.key}-${state.genre}.mid`; a.click();
            showToast('üéµ MIDI exported!');
        }

        function exportPdf() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(24); doc.setTextColor(255, 107, 53);
            doc.text('ChordFlow Lead Sheet', 105, 20, { align: 'center' });
            doc.setFontSize(12); doc.setTextColor(100);
            doc.text(`Key: ${state.key} ${state.scale} | Tempo: ${state.tempo} BPM | Genre: ${state.genre}`, 105, 30, { align: 'center' });
            doc.setFontSize(28); doc.setTextColor(0);
            doc.text(section.chords.map(c => c.symbol).join('   '), 105, 55, { align: 'center' });
            doc.save(`chordflow-${state.key}-${state.genre}.pdf`);
            showToast('üìÑ PDF exported!');
        }

        async function exportWav() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            showToast('üîä Rendering...');
            // Simplified WAV export - in production use OfflineContext
            showToast('WAV export coming soon!');
        }

        function copyChords() {
            const section = state.song.sections[state.song.activeSection];
            navigator.clipboard.writeText(section.chords.map(c => c.symbol).join(' | '));
            showToast('üìã Copied!');
        }

        function shareLink() {
            const params = new URLSearchParams({ key: state.key, scale: state.scale, genre: state.genre, tempo: state.tempo });
            navigator.clipboard.writeText(location.href.split('?')[0] + '?' + params);
            showToast('üîó Link copied!');
        }

        // ===== HISTORY =====
        function saveToHistory() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) return;
            state.history.unshift({
                id: Date.now(),
                key: state.key,
                scale: state.scale,
                genre: state.genre,
                progression: section.chords.map(c => c.symbol).join(' - '),
                timestamp: new Date().toLocaleTimeString()
            });
            if (state.history.length > 15) state.history.pop();
            updateHistoryDisplay();
            localStorage.setItem('chordflow-history', JSON.stringify(state.history));
        }

        function updateHistoryDisplay() {
            const list = document.getElementById('historyList');
            list.innerHTML = state.history.length ? state.history.map(h => `
                <div class="history-item" onclick="loadFromHistory(${h.id})">
                    <div>
                        <div class="history-prog">${h.progression}</div>
                        <div class="history-meta">${h.key} ${h.scale}</div>
                    </div>
                    <span class="history-meta">${h.timestamp}</span>
                </div>
            `).join('') : '<p style="color: var(--text-secondary); text-align: center; font-size: 0.8rem;">Generate to see history</p>';
        }

        function loadFromHistory(id) {
            const h = state.history.find(x => x.id === id);
            if (h) {
                state.key = h.key;
                state.scale = h.scale;
                state.genre = h.genre;
                document.getElementById('keySelect').value = h.key;
                document.getElementById('scaleSelect').value = h.scale;
                generateProgression();
                closeAllPanels();
            }
        }

        // ===== LYRICS =====
        function addLyricLine() {
            const editor = document.getElementById('lyricsEditor');
            const section = state.song.sections[state.song.activeSection];
            const i = editor.children.length;
            const chord = section.chords[i % section.chords.length]?.symbol || 'C';
            editor.innerHTML += `<div class="lyrics-line"><span class="lyrics-chord">${chord}</span><input type="text" class="lyrics-text" placeholder="Add lyrics..."></div>`;
        }

        async function generateAILyrics() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate chords first!'); return; }
            
            showToast('ü§ñ Generating lyrics...');
            
            try {
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'lyrics',
                        chords: section.chords.map(c => c.symbol),
                        genre: state.genre,
                        mood: GENRE_PROGRESSIONS[state.genre]?.mood || 'emotional',
                        theme: 'love and life'
                    })
                });
                
                const data = await response.json();
                if (data.lyrics && Array.isArray(data.lyrics)) {
                    // Update lyrics editor
                    const inputs = document.querySelectorAll('.lyrics-text');
                    data.lyrics.forEach((line, i) => {
                        if (inputs[i]) inputs[i].value = line;
                    });
                    showToast('‚ú® Lyrics generated!');
                } else {
                    throw new Error('Invalid response');
                }
            } catch (error) {
                console.error('AI Lyrics error:', error);
                // Fallback: generate simple lyrics locally
                const moods = { pop: 'feeling alive', rock: 'breaking free', jazz: 'in the night', blues: 'feeling low' };
                const fallbackLyrics = [
                    `When I hear these chords, I'm ${moods[state.genre] || 'feeling something'}`,
                    `The melody takes me somewhere far away`,
                    `Every note reminds me of you`,
                    `And I know this feeling won't fade`
                ];
                const inputs = document.querySelectorAll('.lyrics-text');
                fallbackLyrics.forEach((line, i) => { if (inputs[i]) inputs[i].value = line; });
                showToast('‚ú® Lyrics generated (offline)');
            }
        }

        // ===== PANELS & UI =====
        function toggleDrawer() {
            state.drawerOpen = !state.drawerOpen;
            document.getElementById('bottomDrawer').classList.toggle('open', state.drawerOpen);
        }

        function openHistoryPanel() {
            document.getElementById('historyPanel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function openLyricsPanel() {
            document.getElementById('lyricsPanel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function closeAllPanels() {
            document.getElementById('historyPanel').classList.remove('open');
            document.getElementById('lyricsPanel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleFab() {
            state.fabOpen = !state.fabOpen;
            document.getElementById('fabMenu').classList.toggle('open', state.fabOpen);
            document.getElementById('fabMain').textContent = state.fabOpen ? '‚úï' : 'ü§ñ';
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.theme);
            document.getElementById('themeToggle').textContent = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('chordflow-theme', state.theme);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // ===== AI FUNCTIONS =====
        async function aiContinue() {
            const section = state.song.sections[state.song.activeSection];
            if (!section.chords.length) { showToast('Generate first!'); return; }
            
            showToast('ü§ñ AI thinking...');
            
            try {
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'continue',
                        chords: section.chords.map(c => c.symbol),
                        key: state.key,
                        scale: state.scale,
                        genre: state.genre
                    })
                });
                
                const data = await response.json();
                if (data.continue && Array.isArray(data.continue)) {
                    // Add new chords from AI
                    data.continue.forEach(symbol => {
                        const root = symbol.replace(/m|7|maj|dim|aug/g, '');
                        const hasMinor = symbol.includes('m') && !symbol.includes('maj');
                        const has7 = symbol.includes('7');
                        let quality = 'major';
                        if (hasMinor && has7) quality = 'minor7';
                        else if (hasMinor) quality = 'minor';
                        else if (has7) quality = 'dominant7';
                        else if (symbol.includes('maj7')) quality = 'major7';
                        else if (symbol.includes('dim')) quality = 'diminished';
                        
                        const notes = buildChord(root, quality);
                        section.chords.push({
                            root, quality, symbol,
                            notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                            bassNote: root + '2',
                            degree: NOTES.indexOf(root),
                            numeral: symbol,
                            function: 'AI Suggested'
                        });
                    });
                    updateAllDisplays();
                    showToast(`ü§ñ Added ${data.continue.length} chords!`);
                } else {
                    throw new Error('Invalid response');
                }
            } catch (error) {
                console.error('AI Continue error:', error);
                // Fallback: use theory rules
                const lastChord = section.chords[section.chords.length - 1];
                const suggestions = { 'I': [4, 3], 'ii': [4], 'IV': [4, 0], 'V': [0, 5], 'vi': [3, 1] };
                const nextDegrees = suggestions[lastChord.numeral.replace('¬∞', '')] || [0, 4];
                
                nextDegrees.slice(0, 2).forEach(degree => {
                    const genre = GENRE_PROGRESSIONS[state.genre];
                    const root = getScaleNote(state.key, state.scale, degree);
                    const quality = genre.qualities[degree] || 'major';
                    const notes = buildChord(root, quality);
                    section.chords.push({
                        root, quality, symbol: root + CHORD_QUALITIES[quality].symbol,
                        notes: notes.map((n, i) => n + (i === 0 ? '3' : '4')),
                        bassNote: root + '2', degree,
                        numeral: (state.scale === 'minor' ? NUMERALS.minor : NUMERALS.major)[degree],
                        function: FUNCTIONS[degree]
                    });
                });
                
                updateAllDisplays();
                showToast('ü§ñ Added chords (offline)');
            }
            toggleFab();
        }

        // ===== PWA INSTALL =====
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.add('show');
        });

        document.getElementById('installBtn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') showToast('üì± Installed!');
                deferredPrompt = null;
                document.getElementById('installBanner').classList.remove('show');
            }
        });

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            switch(e.key.toLowerCase()) {
                case 'g': generateProgression(); break;
                case ' ': e.preventDefault(); state.isPlaying ? stopPlayback() : playProgression(); break;
                case 's': stopPlayback(); break;
                case 'l': state.isLooping = !state.isLooping; document.getElementById('loopBtn').classList.toggle('active', state.isLooping); showToast(state.isLooping ? 'üîÅ Loop on' : 'üîÅ Loop off'); break;
                case 't': toggleTheme(); break;
                case 'a': aiContinue(); break;
                case 'c': copyChords(); break;
            }
        });

        // ===== INIT =====
        // ===== USER AUTH & CLOUD =====
        let authMode = 'login';
        let currentUser = null;

        function showAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.add('show');
            updateAuthUI();
        }

        function updateAuthUI() {
            const authForm = document.getElementById('authForm');
            const userProfile = document.getElementById('userProfile');
            
            if (currentUser) {
                authForm.style.display = 'none';
                userProfile.style.display = 'block';
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userBtn').classList.add('logged-in');
                loadUserSongCount();
            } else {
                authForm.style.display = 'block';
                userProfile.style.display = 'none';
                document.getElementById('userBtn').classList.remove('logged-in');
            }
        }

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            document.getElementById('authTitle').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
            document.getElementById('authToggleText').textContent = authMode === 'login' ? "Don't have an account?" : 'Already have an account?';
            document.getElementById('authToggleLink').textContent = authMode === 'login' ? 'Sign Up' : 'Sign In';
            document.querySelector('#authForm .btn-primary').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
        }

        async function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }

            showToast(authMode === 'login' ? 'üîÑ Signing in...' : 'üîÑ Creating account...');

            // For now, use localStorage-based mock auth (Supabase integration ready)
            try {
                // Mock auth - replace with Supabase when configured
                currentUser = { email, id: 'user_' + btoa(email).slice(0, 12) };
                localStorage.setItem('chordflow_user', JSON.stringify(currentUser));
                
                showToast(authMode === 'login' ? '‚úÖ Signed in!' : '‚úÖ Account created!');
                updateAuthUI();
            } catch (error) {
                showToast('‚ùå Auth failed: ' + error.message);
            }
        }

        async function handleLogout() {
            currentUser = null;
            localStorage.removeItem('chordflow_user');
            showToast('üëã Signed out');
            updateAuthUI();
        }

        function loadUserSongCount() {
            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const userSongs = currentUser ? songs.filter(s => s.userId === currentUser.id) : [];
            document.getElementById('userSongCount').textContent = userSongs.length + ' songs saved';
        }

        async function cloudSave() {
            if (!currentUser) {
                showToast('Please sign in first');
                return;
            }

            const title = prompt('Song title:', 'My Song ' + new Date().toLocaleDateString());
            if (!title) return;

            const songData = {
                id: 'song_' + Date.now(),
                userId: currentUser.id,
                title,
                song: state.song,
                key: state.key,
                scale: state.scale,
                genre: state.genre,
                tempo: state.tempo,
                isPublic: false,
                createdAt: new Date().toISOString()
            };

            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            songs.unshift(songData);
            localStorage.setItem('chordflow_cloud_songs', JSON.stringify(songs));

            showToast('‚òÅÔ∏è Song saved!');
            loadUserSongCount();
        }

        function showMySongs() {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('mySongsModal').classList.add('show');
            loadMySongs();
        }

        function loadMySongs() {
            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const userSongs = currentUser ? songs.filter(s => s.userId === currentUser.id) : [];
            
            const container = document.getElementById('mySongsList');
            
            if (userSongs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No songs saved yet. Create a progression and save it!</div>';
                return;
            }

            container.innerHTML = userSongs.map(song => `
                <div class="song-card">
                    <div class="song-card-title">${song.title}</div>
                    <div class="song-card-meta">
                        <span>üéµ ${song.key} ${song.scale}</span>
                        <span>üé∏ ${song.genre}</span>
                        <span>üìÖ ${new Date(song.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="song-card-actions">
                        <button class="song-card-btn primary" onclick="loadSong('${song.id}')">Load</button>
                        <button class="song-card-btn secondary" onclick="showShareModal('${song.id}')">${song.isPublic ? 'üîó Shared' : 'üîí Share'}</button>
                        <button class="song-card-btn danger" onclick="deleteSong('${song.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function loadSong(songId) {
            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const song = songs.find(s => s.id === songId);
            
            if (song) {
                state.song = song.song;
                state.key = song.key;
                state.scale = song.scale;
                state.genre = song.genre;
                state.tempo = song.tempo || 120;
                
                document.getElementById('keySelect').value = state.key;
                document.getElementById('scaleSelect').value = state.scale;
                document.getElementById('genreSelect').value = state.genre;
                document.getElementById('tempoSlider').value = state.tempo;
                
                updateAllDisplays();
                document.getElementById('mySongsModal').classList.remove('show');
                showToast('‚úÖ Loaded: ' + song.title);
            }
        }

        function deleteSong(songId) {
            if (!confirm('Delete this song?')) return;
            
            let songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            songs = songs.filter(s => s.id !== songId);
            localStorage.setItem('chordflow_cloud_songs', JSON.stringify(songs));
            
            loadMySongs();
            loadUserSongCount();
            showToast('üóëÔ∏è Song deleted');
        }

        function showShareModal(songId) {
            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const song = songs.find(s => s.id === songId);
            
            if (song) {
                document.getElementById('songTitleInput').value = song.title;
                document.getElementById('makePublic').checked = song.isPublic;
                document.getElementById('shareModal').dataset.songId = songId;
                document.getElementById('shareResult').style.display = 'none';
                document.getElementById('mySongsModal').classList.remove('show');
                document.getElementById('shareModal').classList.add('show');
            }
        }

        function shareSong() {
            const songId = document.getElementById('shareModal').dataset.songId;
            const title = document.getElementById('songTitleInput').value;
            const isPublic = document.getElementById('makePublic').checked;
            
            let songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const songIndex = songs.findIndex(s => s.id === songId);
            
            if (songIndex >= 0) {
                songs[songIndex].title = title;
                songs[songIndex].isPublic = isPublic;
                localStorage.setItem('chordflow_cloud_songs', JSON.stringify(songs));
                
                const shareUrl = window.location.origin + '?song=' + songId;
                document.getElementById('shareLink').value = shareUrl;
                document.getElementById('shareResult').style.display = 'block';
                
                showToast(isPublic ? 'üåê Song is now public!' : 'üîí Song is private');
            }
        }

        function copyShareLink() {
            const link = document.getElementById('shareLink');
            link.select();
            document.execCommand('copy');
            showToast('üìã Link copied!');
        }

        // ===== COMMUNITY =====
        function showCommunityModal() {
            document.getElementById('communityModal').classList.add('show');
            loadCommunity('all');
        }

        function loadCommunity(genre) {
            // Update active filter
            document.querySelectorAll('.genre-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.genre === genre);
            });

            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            let publicSongs = songs.filter(s => s.isPublic);
            
            if (genre !== 'all') {
                publicSongs = publicSongs.filter(s => s.genre === genre);
            }

            const container = document.getElementById('communityList');
            
            if (publicSongs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No public songs yet. Be the first to share!</div>';
                return;
            }

            container.innerHTML = publicSongs.map(song => `
                <div class="song-card" onclick="loadCommunitySong('${song.id}')">
                    <div class="song-card-title">${song.title}</div>
                    <div class="song-card-meta">
                        <span>üéµ ${song.key} ${song.scale}</span>
                        <span>üé∏ ${song.genre}</span>
                        <span>üéº ${song.song?.sections?.length || 0} sections</span>
                    </div>
                </div>
            `).join('');
        }

        function loadCommunitySong(songId) {
            const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
            const song = songs.find(s => s.id === songId);
            
            if (song) {
                state.song = JSON.parse(JSON.stringify(song.song)); // Deep copy
                state.key = song.key;
                state.scale = song.scale;
                state.genre = song.genre;
                state.tempo = song.tempo || 120;
                
                document.getElementById('keySelect').value = state.key;
                document.getElementById('scaleSelect').value = state.scale;
                document.getElementById('genreSelect').value = state.genre;
                document.getElementById('tempoSlider').value = state.tempo;
                
                updateAllDisplays();
                document.getElementById('communityModal').classList.remove('show');
                showToast('‚úÖ Loaded: ' + song.title);
            }
        }

        // Check URL for shared song
        function checkSharedSong() {
            const params = new URLSearchParams(window.location.search);
            const songId = params.get('song');
            
            if (songId) {
                setTimeout(() => {
                    const songs = JSON.parse(localStorage.getItem('chordflow_cloud_songs') || '[]');
                    const song = songs.find(s => s.id === songId && s.isPublic);
                    
                    if (song) {
                        loadCommunitySong(songId);
                    } else {
                        showToast('Song not found or is private');
                    }
                }, 500);
            }
        }

        // Restore user session
        function restoreSession() {
            const savedUser = localStorage.getItem('chordflow_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateAuthUI();
            }
        }

        function init() {
            // Load saved settings
            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme) { state.theme = savedTheme; document.documentElement.setAttribute('data-theme', savedTheme); document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; }
            const savedHistory = localStorage.getItem('chordflow-history');
            if (savedHistory) { state.history = JSON.parse(savedHistory); updateHistoryDisplay(); }

            // Event listeners
            document.getElementById('generateBtn').addEventListener('click', generateProgression);
            document.getElementById('aiContinueBtn').addEventListener('click', aiContinue);
            document.getElementById('autoStructureBtn').addEventListener('click', generateFullSong);
            document.getElementById('playBtn').addEventListener('click', playProgression);
            document.getElementById('stopBtn').addEventListener('click', stopPlayback);
            document.getElementById('loopBtn').addEventListener('click', () => { state.isLooping = !state.isLooping; document.getElementById('loopBtn').classList.toggle('active', state.isLooping); showToast(state.isLooping ? 'üîÅ Loop on' : 'üîÅ Loop off'); });
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('menuBtn').addEventListener('click', openHistoryPanel);
            document.getElementById('lyricsBtn').addEventListener('click', openLyricsPanel);
            document.getElementById('closeHistory').addEventListener('click', closeAllPanels);
            document.getElementById('closeLyrics').addEventListener('click', closeAllPanels);
            document.getElementById('overlay').addEventListener('click', closeAllPanels);
            document.getElementById('drawerHandle').addEventListener('click', toggleDrawer);
            document.getElementById('fabMain').addEventListener('click', () => { if (state.fabOpen) aiContinue(); else toggleFab(); });
            document.getElementById('analyzeBtn').addEventListener('click', async () => { 
                const section = state.song.sections[state.song.activeSection];
                if (!section.chords.length) { showToast('Generate chords first!'); toggleFab(); return; }
                
                showToast('üß† Analyzing...');
                toggleFab();
                
                try {
                    const response = await fetch('/api/ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyze',
                            chords: section.chords.map(c => c.symbol),
                            key: state.key,
                            scale: state.scale,
                            genre: state.genre
                        })
                    });
                    
                    const data = await response.json();
                    if (data.analyze) {
                        // Show analysis in a modal
                        const modal = document.createElement('div');
                        modal.className = 'modal show';
                        modal.innerHTML = `
                            <div class="modal-content" style="max-width: 500px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <h2 class="modal-title">üß† AI Analysis</h2>
                                    <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                                </div>
                                <div style="background: var(--bg-dark); padding: 1rem; border-radius: 10px; font-size: 0.9rem; line-height: 1.6;">
                                    ${data.analyze.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                    } else {
                        showToast('Analysis unavailable');
                    }
                } catch (error) {
                    console.error('AI Analyze error:', error);
                    showToast('üß† Analysis offline - check your connection');
                }
            });
            document.getElementById('practiceBtn').addEventListener('click', () => { showToast('üéì Practice mode coming soon!'); toggleFab(); });
            document.getElementById('recordBtn').addEventListener('click', () => { showToast('üî¥ Recording coming soon!'); toggleFab(); });
            document.getElementById('userBtn').addEventListener('click', showAuthModal);
            document.getElementById('communityBtn').addEventListener('click', showCommunityModal);
            
            // Initialize user session and check for shared songs
            restoreSession();
            checkSharedSong();
            document.getElementById('aiLyricsBtn').addEventListener('click', generateAILyrics);
            document.getElementById('saveSongBtn').addEventListener('click', () => showToast('üíæ Cloud save coming in Phase 3!'));

            // Tempo slider
            document.getElementById('tempoSlider').addEventListener('input', (e) => {
                state.tempo = parseInt(e.target.value);
                document.getElementById('tempoValue').textContent = state.tempo;
            });

            // Backing track toggles
            ['piano', 'bass', 'drums', 'metronome'].forEach(type => {
                document.getElementById(`${type}Toggle`).addEventListener('click', (e) => {
                    state.backing[type] = !state.backing[type];
                    e.currentTarget.classList.toggle('active', state.backing[type]);
                });
            });

            // Selects
            document.getElementById('keySelect').addEventListener('change', e => state.key = e.target.value);
            document.getElementById('scaleSelect').addEventListener('change', e => state.scale = e.target.value);
            document.getElementById('strumSelect').addEventListener('change', updateStrumPattern);

            // Genre buttons
            document.querySelectorAll('.genre-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.genre = btn.dataset.genre === 'random' ? Object.keys(GENRE_PROGRESSIONS)[Math.floor(Math.random() * Object.keys(GENRE_PROGRESSIONS).length)] : btn.dataset.genre;
                });
            });

            // Drawer tabs
            document.querySelectorAll('.drawer-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.drawer-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`panel-${tab.dataset.panel}`).classList.add('active');
                });
            });

            // Exports
            document.getElementById('exportMidi').addEventListener('click', exportMidi);
            document.getElementById('exportPdf').addEventListener('click', exportPdf);
            document.getElementById('exportWav').addEventListener('click', exportWav);
            document.getElementById('exportTab').addEventListener('click', () => showToast('üìù Tab export coming soon!'));
            document.getElementById('copyChords').addEventListener('click', copyChords);
            document.getElementById('shareLink').addEventListener('click', shareLink);

            // URL params
            const params = new URLSearchParams(location.search);
            if (params.has('key')) { state.key = params.get('key'); document.getElementById('keySelect').value = state.key; }
            if (params.has('scale')) { state.scale = params.get('scale'); document.getElementById('scaleSelect').value = state.scale; }
            if (params.has('genre')) { state.genre = params.get('genre'); }
            if (params.has('tempo')) { state.tempo = parseInt(params.get('tempo')); document.getElementById('tempoSlider').value = state.tempo; document.getElementById('tempoValue').textContent = state.tempo; }

            // Initial display
            updateAllDisplays();
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(() => console.log('SW registered')).catch(e => console.log('SW failed', e));
            }

            // Visualizer animation
            setInterval(() => { if (state.isPlaying) animateVisualizer(); }, 150);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
