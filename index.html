<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChordFlow v0.61</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000; --bg-secondary: #1c1c1e; --bg-tertiary: #2c2c2e; --bg-elevated: #3a3a3c;
            --text-primary: #ffffff; --text-secondary: #8e8e93; --text-tertiary: #636366;
            --accent: #0a84ff; --accent-green: #30d158; --accent-orange: #ff9f0a; --accent-pink: #ff375f; --accent-purple: #bf5af2;
            --separator: rgba(84, 84, 88, 0.65);
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 24px; --spacing-xl: 32px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px; --radius-full: 100px;
            --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1); --transition-smooth: 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { font-family: var(--font); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; min-height: 100dvh; overflow: hidden; overscroll-behavior: none; }
        button { font-family: var(--font); }

        /* Onboarding */
        .onboarding { position: fixed; inset: 0; background: var(--bg-primary); z-index: 1000; display: flex; flex-direction: column; padding: var(--safe-top) var(--spacing-lg) var(--safe-bottom); opacity: 1; transition: opacity 0.5s ease; }
        .onboarding.hidden { opacity: 0; pointer-events: none; }
        .onboarding-header { text-align: center; padding: var(--spacing-xl) 0; }
        .onboarding-logo { font-size: 64px; margin-bottom: var(--spacing-md); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .onboarding-title { font-size: 32px; font-weight: 800; margin-bottom: var(--spacing-sm); }
        .onboarding-subtitle { font-size: 17px; color: var(--text-secondary); max-width: 300px; margin: 0 auto; line-height: 1.4; }
        .onboarding-modes { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-md); padding: var(--spacing-lg) 0; max-width: 400px; margin: 0 auto; width: 100%; overflow-y: auto; }
        .mode-option { background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); cursor: pointer; transition: all var(--transition-fast); border: 2px solid transparent; display: flex; align-items: center; gap: var(--spacing-md); }
        .mode-option.selected { border-color: var(--accent); background: rgba(10, 132, 255, 0.1); }
        .mode-option-icon { font-size: 40px; flex-shrink: 0; }
        .mode-option-content { flex: 1; }
        .mode-option-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .mode-option-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.3; }
        .mode-option-check { width: 24px; height: 24px; border-radius: var(--radius-full); border: 2px solid var(--separator); display: flex; align-items: center; justify-content: center; color: transparent; transition: all var(--transition-fast); flex-shrink: 0; }
        .mode-option.selected .mode-option-check { background: var(--accent); border-color: var(--accent); color: white; }
        .onboarding-footer { padding: var(--spacing-lg) 0; flex-shrink: 0; }
        .onboarding-cta { width: 100%; max-width: 400px; margin: 0 auto; padding: 18px; background: var(--accent); border: none; border-radius: var(--radius-md); color: white; font-size: 17px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
        .onboarding-skip { display: block; text-align: center; margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 15px; cursor: pointer; background: none; border: none; }

        /* UI Container */
        .ui-container { display: none; min-height: 100vh; min-height: 100dvh; opacity: 0; transition: opacity 0.3s ease; }
        .ui-container.active { display: flex; flex-direction: column; opacity: 1; }

        /* DUAL MODE */
        #dualModeUI { padding-top: var(--safe-top); padding-bottom: calc(var(--safe-bottom) + 90px); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) var(--spacing-lg); position: sticky; top: 0; z-index: 100; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: var(--spacing-sm); }
        .header-actions { display: flex; gap: var(--spacing-sm); }
        .header-btn { width: 36px; height: 36px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-primary); font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-fast); }
        .header-btn:active { transform: scale(0.92); }
        .header-btn.active { background: var(--accent); }
        .mode-toggle { position: fixed; top: calc(var(--safe-top) + 70px); left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border-radius: var(--radius-full); padding: 4px; display: flex; z-index: 200; box-shadow: 0 4px 24px rgba(0,0,0,0.4); }
        .mode-btn { padding: 10px 24px; border: none; border-radius: var(--radius-full); background: transparent; color: var(--text-secondary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .mode-btn.active { background: var(--accent); color: white; }
        .main-content { flex: 1; overflow-y: auto; padding: var(--spacing-lg); padding-top: 80px; }

        .mode-view { display: none; }
        .mode-view.active { display: block; }
        .settings-row { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); }
        .setting-chip { flex: 1; background: var(--bg-secondary); border: none; border-radius: var(--radius-md); padding: var(--spacing-md); cursor: pointer; text-align: left; transition: all var(--transition-fast); }
        .setting-chip:active { transform: scale(0.97); background: var(--bg-tertiary); }
        .setting-chip .label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .setting-chip span:last-child { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        /* Progress Bar */
        .progress-container { margin-bottom: var(--spacing-md); }
        .progress-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-bottom: var(--spacing-sm); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-purple)); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
        .beat-dots { display: flex; justify-content: center; gap: var(--spacing-sm); }
        .beat-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--bg-tertiary); transition: all 0.15s ease; }
        .beat-dot.active { background: var(--accent); transform: scale(1.3); }
        .beat-dot.accent { background: var(--accent-orange); }

        /* Practice Mode */
        .practice-controls { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-sm); }
        .speed-btn { flex: 1; padding: 10px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); }
        .speed-btn.active { background: var(--accent); }
        .speed-btn:active { transform: scale(0.95); }
        .count-in-btn { padding: 10px 16px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px; cursor: pointer; }
        .count-in-btn.active { background: var(--accent-green); }

        .undo-redo-row { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .undo-btn { flex: 1; padding: 10px; background: var(--bg-secondary); border: none; border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; cursor: pointer; transition: all var(--transition-fast); }
        .undo-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .undo-btn:not(:disabled):active { transform: scale(0.97); }
        .sections-strip { display: flex; gap: var(--spacing-sm); overflow-x: auto; padding-bottom: var(--spacing-md); margin-bottom: var(--spacing-md); scrollbar-width: none; }
        .sections-strip::-webkit-scrollbar { display: none; }
        .section-pill { background: var(--bg-secondary); border: none; border-radius: var(--radius-full); padding: 10px 18px; font-size: 14px; font-weight: 600; color: var(--text-primary); cursor: pointer; white-space: nowrap; transition: all var(--transition-fast); display: flex; align-items: center; gap: 6px; position: relative; }
        .section-pill:active { transform: scale(0.95); }
        .section-pill.active { background: var(--accent); }
        .section-pill .section-icon { font-size: 16px; }
        .section-delete { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: var(--accent-pink); border: 2px solid var(--bg-primary); border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .section-pill.editing .section-delete { display: flex; }
        .add-section-btn { background: var(--bg-tertiary); border: 1px dashed var(--separator); border-radius: var(--radius-full); padding: 10px 18px; font-size: 14px; color: var(--text-secondary); cursor: pointer; white-space: nowrap; }

        /* Chord Grid */
        .chord-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .chord-card { background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-lg); text-align: center; cursor: pointer; transition: all var(--transition-fast); position: relative; border: 2px solid transparent; }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--accent); background: rgba(10,132,255,0.15); animation: chordPulse 0.5s ease; }
        @keyframes chordPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .chord-card.major { border-left: 4px solid var(--accent); }
        .chord-card.minor { border-left: 4px solid var(--accent-purple); }
        .chord-card.seventh { border-left: 4px solid var(--accent-orange); }
        .chord-card.diminished { border-left: 4px solid var(--accent-pink); }
        .chord-index { position: absolute; top: 8px; left: 10px; font-size: 11px; color: var(--text-tertiary); font-weight: 600; }
        .chord-diagram-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-sm); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chord-name { font-size: 32px; font-weight: 800; margin: var(--spacing-sm) 0; }
        .chord-type { font-size: 13px; color: var(--text-secondary); }
        .generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--accent-purple), var(--accent)); border: none; border-radius: var(--radius-lg); color: white; font-size: 17px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); transition: all var(--transition-fast); margin-bottom: var(--spacing-md); }
        .generate-btn:active { transform: scale(0.98); }
        .ai-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }
        .ai-btn { padding: var(--spacing-md); background: var(--bg-secondary); border: none; border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); transition: all var(--transition-fast); }
        .ai-btn:active { transform: scale(0.96); }
        .ai-btn.loading { opacity: 0.6; pointer-events: none; }
        .ai-btn .icon { font-size: 18px; }

        /* Produce View */
        .produce-tabs { display: flex; gap: var(--spacing-xs); background: var(--bg-secondary); border-radius: var(--radius-md); padding: 4px; margin-bottom: var(--spacing-lg); }
        .produce-tab { flex: 1; padding: 12px; background: transparent; border: none; border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); }
        .produce-tab.active { background: var(--bg-tertiary); color: var(--text-primary); }
        .produce-panel { display: none; }
        .produce-panel.active { display: block; }
        .mixer-channel { background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-sm); }
        .channel-name { font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm); }
        .fader-container { display: flex; align-items: center; gap: var(--spacing-md); }
        .fader { flex: 1; -webkit-appearance: none; appearance: none; height: 8px; background: var(--bg-tertiary); border-radius: 4px; outline: none; }
        .fader::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: white; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .fader-value { font-size: 14px; font-weight: 600; min-width: 45px; text-align: right; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); }
        .toggle-label { font-weight: 600; }
        .toggle-desc { font-size: 13px; color: var(--text-secondary); }
        .toggle-switch { width: 51px; height: 31px; background: var(--bg-tertiary); border-radius: 16px; position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
        .toggle-switch.active { background: var(--accent-green); }
        .toggle-switch::after { content: ''; position: absolute; width: 27px; height: 27px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.active::after { transform: translateX(20px); }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
        .export-card { background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; cursor: pointer; border: 2px solid transparent; transition: all var(--transition-fast); }
        .export-card:active { border-color: var(--accent); transform: scale(0.97); }
        .export-card.new { border-color: var(--accent-green); }
        .export-icon { font-size: 36px; margin-bottom: var(--spacing-sm); }
        .export-title { font-weight: 600; }
        .export-desc { font-size: 12px; color: var(--text-secondary); }
        .export-badge { display: inline-block; background: var(--accent-green); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 4px; }
        .save-load-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .save-btn, .load-btn { padding: 16px; border: none; border-radius: var(--radius-md); font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .save-btn { background: var(--accent); color: white; }
        .load-btn { background: var(--bg-secondary); color: var(--text-primary); }
        .saved-song-item { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); cursor: pointer; }
        .saved-song-name { font-weight: 600; }
        .saved-song-meta { font-size: 12px; color: var(--text-secondary); }
        .saved-song-delete { width: 32px; height: 32px; background: var(--accent-pink); border: none; border-radius: var(--radius-full); color: white; cursor: pointer; flex-shrink: 0; }

        /* Tap Tempo */
        .tempo-display { background: var(--bg-tertiary); padding: 8px 14px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all var(--transition-fast); user-select: none; }
        .tempo-display:active { background: var(--accent); transform: scale(0.95); }
        .tempo-display.tapping { background: var(--accent-orange); animation: tapPulse 0.2s ease; }
        @keyframes tapPulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .bpm-label { color: var(--text-secondary); font-size: 11px; }

        /* Transport */
        .transport { position: fixed; bottom: calc(var(--safe-bottom) + 10px); left: var(--spacing-md); right: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-md); display: flex; align-items: center; justify-content: space-between; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid var(--separator); }
        .transport-left, .transport-right { display: flex; align-items: center; gap: var(--spacing-sm); }
        .transport-center { display: flex; align-items: center; gap: var(--spacing-md); }
        .play-btn { width: 56px; height: 56px; border-radius: var(--radius-full); background: var(--accent); border: none; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 16px rgba(10,132,255,0.4); transition: all var(--transition-fast); }
        .play-btn:active { transform: scale(0.92); }
        .play-btn.playing { background: var(--accent-orange); box-shadow: 0 4px 16px rgba(255,159,10,0.4); }
        .transport-btn { width: 44px; height: 44px; border-radius: var(--radius-md); background: var(--bg-tertiary); border: none; color: var(--text-primary); font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-fast); }
        .transport-btn:active { transform: scale(0.92); }
        .transport-btn.active { background: var(--accent); }

        /* SHEET FLOW UI */
        #sheetFlowUI { position: relative; overflow: hidden; }
        .sf-canvas { flex: 1; display: flex; flex-direction: column; padding: var(--spacing-lg); padding-top: calc(var(--safe-top) + 60px); padding-bottom: calc(var(--safe-bottom) + 110px); overflow-y: auto; }
        .sf-header { position: fixed; top: var(--safe-top); left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm) var(--spacing-lg); z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .sf-logo { font-size: 18px; font-weight: 700; opacity: 0.7; }
        .sf-header-btn { width: 32px; height: 32px; border-radius: var(--radius-full); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 16px; cursor: pointer; }
        .sf-chord-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 40vh; }
        .sf-current-chord { font-size: 100px; font-weight: 900; letter-spacing: -4px; text-shadow: 0 0 60px rgba(10,132,255,0.3); transition: all 0.3s; }
        .sf-current-chord.playing { text-shadow: 0 0 80px rgba(10,132,255,0.6); transform: scale(1.05); }
        .sf-chord-label { font-size: 18px; color: var(--text-secondary); margin-top: var(--spacing-md); }
        .sf-progress { margin-top: var(--spacing-md); width: 200px; }
        .sf-chord-strip { display: flex; gap: var(--spacing-md); padding: var(--spacing-lg) 0; overflow-x: auto; scroll-snap-type: x mandatory; }
        .sf-chord-strip::-webkit-scrollbar { display: none; }
        .sf-strip-chord { flex-shrink: 0; width: 70px; height: 70px; background: var(--bg-secondary); border-radius: var(--radius-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; scroll-snap-align: center; border: 2px solid transparent; transition: all var(--transition-fast); }
        .sf-strip-chord.active { border-color: var(--accent); background: rgba(10,132,255,0.2); transform: scale(1.1); }
        .sf-strip-name { font-size: 20px; font-weight: 700; }
        .sf-strip-num { font-size: 11px; color: var(--text-secondary); }
        .sf-gesture-hint { position: fixed; bottom: calc(var(--safe-bottom) + 100px); left: 50%; transform: translateX(-50%); display: flex; gap: var(--spacing-xl); opacity: 0.4; font-size: 12px; color: var(--text-secondary); }
        .sf-panel { position: fixed; top: 0; bottom: 0; width: 85%; max-width: 320px; background: var(--bg-secondary); z-index: 500; transition: transform var(--transition-smooth); display: flex; flex-direction: column; }
        .sf-panel-left { left: 0; transform: translateX(-100%); border-radius: 0 var(--radius-xl) var(--radius-xl) 0; }
        .sf-panel-left.open { transform: translateX(0); }
        .sf-panel-right { right: 0; transform: translateX(100%); border-radius: var(--radius-xl) 0 0 var(--radius-xl); }
        .sf-panel-right.open { transform: translateX(0); }
        .sf-panel-header { padding: calc(var(--safe-top) + var(--spacing-md)) var(--spacing-lg) var(--spacing-md); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--separator); flex-shrink: 0; }
        .sf-panel-title { font-size: 20px; font-weight: 700; }
        .sf-panel-close { width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; }
        .sf-panel-body { flex: 1; overflow-y: auto; padding: var(--spacing-lg); }
        .sf-drawer { position: fixed; left: 0; right: 0; bottom: 0; background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; z-index: 500; transform: translateY(calc(100% - 80px)); transition: transform var(--transition-smooth); max-height: 70vh; }
        .sf-drawer.open { transform: translateY(0); }
        .sf-drawer-handle { width: 36px; height: 5px; background: var(--bg-elevated); border-radius: var(--radius-full); margin: 10px auto; cursor: grab; }
        .sf-drawer-peek { display: flex; align-items: center; justify-content: space-around; padding: var(--spacing-sm) var(--spacing-lg) var(--spacing-md); }
        .sf-drawer-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: var(--spacing-sm); background: none; border: none; color: var(--text-primary); }
        .sf-drawer-btn .icon { font-size: 24px; }
        .sf-drawer-btn .label { font-size: 10px; color: var(--text-secondary); }
        .sf-drawer-content { flex: 1; overflow-y: auto; padding: 0 var(--spacing-lg) var(--spacing-lg); display: none; }
        .sf-drawer.open .sf-drawer-content { display: block; }
        .sf-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 400; backdrop-filter: blur(4px); }
        .sf-overlay.active { opacity: 1; visibility: visible; }
        .sf-instrument-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm); cursor: pointer; transition: all var(--transition-fast); }
        .sf-instrument-item.selected { background: var(--accent); }
        .sf-instrument-icon { font-size: 28px; }
        .sf-instrument-name { flex: 1; font-weight: 500; }
        .sf-instrument-check { opacity: 0; }
        .sf-instrument-item.selected .sf-instrument-check { opacity: 1; }
        .sf-quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .sf-quick-btn { padding: var(--spacing-lg); background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: var(--spacing-sm); transition: all var(--transition-fast); }
        .sf-quick-btn:active { transform: scale(0.96); }
        .sf-quick-btn .icon { font-size: 32px; }
        .sf-quick-btn .label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .sf-quick-btn.primary { background: linear-gradient(135deg, var(--accent-purple), var(--accent)); }

        /* CARD DECK UI */
        #cardDeckUI { position: relative; overflow: hidden; }
        .cd-header { position: fixed; top: var(--safe-top); left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) var(--spacing-lg); z-index: 100; }
        .cd-logo { font-size: 20px; font-weight: 700; }
        .cd-header-btn { width: 36px; height: 36px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 18px; cursor: pointer; }
        .cd-stack-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: calc(var(--safe-top) + 70px) var(--spacing-lg) calc(var(--safe-bottom) + 110px); perspective: 1000px; touch-action: pan-y; }
        .cd-card-stack { position: relative; width: 100%; max-width: 350px; height: 420px; }
        .cd-card { position: absolute; width: 100%; height: 100%; background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-xl); display: flex; flex-direction: column; cursor: pointer; transition: all var(--transition-smooth); transform-origin: center bottom; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--separator); overflow: hidden; }
        .cd-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(145deg, rgba(255,255,255,0.05), transparent); pointer-events: none; }
        .cd-card.active { z-index: 10; transform: translateY(0) scale(1); opacity: 1; }
        .cd-card.next { z-index: 9; transform: translateY(20px) scale(0.95); opacity: 0.7; pointer-events: none; }
        .cd-card.behind { z-index: 8; transform: translateY(40px) scale(0.9); opacity: 0.4; pointer-events: none; }
        .cd-card.hidden-card { z-index: 7; transform: translateY(60px) scale(0.85); opacity: 0.2; pointer-events: none; }
        .cd-card.expanded { z-index: 100; position: fixed; top: calc(var(--safe-top) + 10px); left: var(--spacing-md); right: var(--spacing-md); bottom: calc(var(--safe-bottom) + 90px); height: auto; max-width: none; transform: none; opacity: 1; }
        .cd-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-lg); position: relative; z-index: 1; }
        .cd-card-icon { font-size: 32px; }
        .cd-card-label { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .cd-card-close { display: none; width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 16px; cursor: pointer; align-items: center; justify-content: center; }
        .cd-card.expanded .cd-card-close { display: flex; }
        .cd-card-body { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; z-index: 1; }
        .cd-progression-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cd-big-chord { font-size: 72px; font-weight: 900; margin-bottom: var(--spacing-sm); transition: all 0.3s; }
        .cd-big-chord.playing { transform: scale(1.1); text-shadow: 0 0 40px rgba(10,132,255,0.5); }
        .cd-chord-info { font-size: 16px; color: var(--text-secondary); margin-bottom: var(--spacing-lg); }
        .cd-mini-chords { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; justify-content: center; }
        .cd-mini-chord { width: 50px; height: 50px; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: all var(--transition-fast); }
        .cd-mini-chord.active { border-color: var(--accent); background: rgba(10,132,255,0.2); }
        .cd-tool-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); flex: 1; }
        .cd-tool-item { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--spacing-sm); cursor: pointer; transition: all var(--transition-fast); }
        .cd-tool-item:active { transform: scale(0.95); background: var(--bg-elevated); }
        .cd-tool-item.loading { opacity: 0.5; pointer-events: none; }
        .cd-tool-item .icon { font-size: 28px; }
        .cd-tool-item .label { font-size: 13px; font-weight: 600; }
        .cd-card[data-type="progression"] { background: linear-gradient(145deg, #1a1a2e, #16213e); }
        .cd-card[data-type="ai"] { background: linear-gradient(145deg, #2d1b4e, #1a1a2e); }
        .cd-card[data-type="mixer"] { background: linear-gradient(145deg, #1b3a4b, #1a1a2e); }
        .cd-card[data-type="export"] { background: linear-gradient(145deg, #2e1a1a, #1a1a2e); }
        .cd-nav-dots { display: flex; gap: 8px; justify-content: center; margin-top: var(--spacing-md); }
        .cd-nav-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--bg-tertiary); transition: all 0.3s; cursor: pointer; }
        .cd-nav-dot.active { background: var(--accent); width: 24px; border-radius: 4px; }
        .cd-transport { position: fixed; bottom: calc(var(--safe-bottom) + 10px); left: var(--spacing-md); right: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-md); display: flex; align-items: center; justify-content: center; gap: var(--spacing-lg); z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .cd-transport-btn { width: 50px; height: 50px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: white; font-size: 20px; cursor: pointer; transition: all var(--transition-fast); }
        .cd-transport-btn:active { transform: scale(0.92); }
        .cd-transport-btn.active { background: var(--accent); }
        .cd-transport-btn.play { width: 60px; height: 60px; background: var(--accent); font-size: 24px; box-shadow: 0 4px 16px rgba(10,132,255,0.4); }
        .cd-transport-btn.play.playing { background: var(--accent-orange); }
        .cd-tempo { font-size: 14px; font-weight: 600; color: var(--text-secondary); }

        /* Bottom Sheets */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 400; backdrop-filter: blur(4px); }
        .sheet-overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--bg-secondary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; transform: translateY(100%); transition: transform var(--transition-smooth); z-index: 500; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-handle { width: 36px; height: 5px; background: var(--bg-elevated); border-radius: var(--radius-full); margin: 10px auto; flex-shrink: 0; }
        .sheet-header { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-sm) var(--spacing-lg) var(--spacing-md); flex-shrink: 0; }
        .sheet-title { font-size: 18px; font-weight: 700; }
        .sheet-close { width: 30px; height: 30px; border-radius: var(--radius-full); background: var(--bg-tertiary); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 0 var(--spacing-lg) var(--spacing-lg); padding-bottom: calc(var(--spacing-lg) + var(--safe-bottom)); }
        .option-list { display: flex; flex-direction: column; gap: var(--spacing-xs); }
        .option-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
        .option-item:active { background: var(--bg-elevated); }
        .option-item.selected { background: var(--accent); }
        .option-icon { font-size: 24px; width: 40px; text-align: center; flex-shrink: 0; }
        .option-text { flex: 1; min-width: 0; }
        .option-title { font-weight: 600; }
        .option-desc { font-size: 13px; color: var(--text-secondary); }
        .option-item.selected .option-desc { color: rgba(255,255,255,0.7); }
        .option-check { opacity: 0; color: white; flex-shrink: 0; }
        .option-item.selected .option-check { opacity: 1; }
        .settings-group { margin-bottom: var(--spacing-lg); }
        .settings-group-title { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); padding-left: var(--spacing-sm); }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--spacing-xs); cursor: pointer; }
        .settings-label { display: flex; align-items: center; gap: var(--spacing-sm); }
        .settings-icon { font-size: 20px; }

        /* Chord Diagram Modal */
        .chord-diagram-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(8px); }
        .chord-diagram-modal.active { opacity: 1; visibility: visible; }
        .chord-diagram-content { background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-xl); text-align: center; max-width: 300px; width: 90%; }
        .chord-diagram-title { font-size: 36px; font-weight: 800; margin-bottom: var(--spacing-md); }
        .chord-diagram-svg { width: 100%; max-width: 200px; margin: 0 auto var(--spacing-md); }
        .chord-diagram-notes { font-size: 18px; color: var(--text-secondary); margin-bottom: var(--spacing-lg); }
        .chord-diagram-close { width: 100%; padding: 14px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer; }

        /* Save Modal */
        .save-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(8px); }
        .save-modal.active { opacity: 1; visibility: visible; }
        .save-modal-content { background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-xl); max-width: 350px; width: 90%; }
        .save-modal-title { font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-lg); text-align: center; }
        .save-modal-input { width: 100%; padding: 14px; background: var(--bg-tertiary); border: 2px solid var(--separator); border-radius: var(--radius-md); color: var(--text-primary); font-size: 16px; margin-bottom: var(--spacing-lg); }
        .save-modal-input:focus { outline: none; border-color: var(--accent); }
        .save-modal-buttons { display: flex; gap: var(--spacing-md); }
        .save-modal-btn { flex: 1; padding: 14px; border: none; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; }
        .save-modal-btn.cancel { background: var(--bg-tertiary); color: var(--text-primary); }
        .save-modal-btn.confirm { background: var(--accent); color: white; }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(8px); }
        .shortcuts-modal.active { opacity: 1; visibility: visible; }
        .shortcuts-content { background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--spacing-xl); max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .shortcuts-title { font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-lg); text-align: center; }
        .shortcut-row { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--separator); }
        .shortcut-row:last-child { border-bottom: none; }
        .shortcut-key { background: var(--bg-tertiary); padding: 6px 12px; border-radius: var(--radius-sm); font-family: monospace; font-weight: 600; }
        .shortcuts-close { width: 100%; padding: 14px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer; margin-top: var(--spacing-lg); }

        /* Count-in Overlay */
        .count-in-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 700; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .count-in-overlay.active { opacity: 1; visibility: visible; }
        .count-in-number { font-size: 150px; font-weight: 900; color: var(--accent); animation: countPop 0.5s ease; }
        @keyframes countPop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }

        /* Toast */
        .toast { position: fixed; top: calc(var(--safe-top) + 60px); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--bg-elevated); padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius-full); font-size: 15px; font-weight: 500; z-index: 700; opacity: 0; transition: all var(--transition-smooth); box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @media (min-width: 768px) {
            .chord-grid { grid-template-columns: repeat(4, 1fr); }
            .transport, .cd-transport { left: 50%; right: auto; transform: translateX(-50%); width: 500px; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body>
    <!-- Onboarding -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-header">
            <div class="onboarding-logo">üéµ</div>
            <h1 class="onboarding-title">Welcome to ChordFlow</h1>
            <p class="onboarding-subtitle">AI-powered chord progressions. Choose your interface.</p>
        </div>
        <div class="onboarding-modes">
            <div class="mode-option selected" data-mode="dual" onclick="selectOnboardingMode('dual')">
                <span class="mode-option-icon">üì±</span>
                <div class="mode-option-content">
                    <div class="mode-option-title">Dual Mode</div>
                    <div class="mode-option-desc">Simple Create/Produce toggle. Best for beginners.</div>
                </div>
                <div class="mode-option-check">‚úì</div>
            </div>
            <div class="mode-option" data-mode="sheet" onclick="selectOnboardingMode('sheet')">
                <span class="mode-option-icon">üìÑ</span>
                <div class="mode-option-content">
                    <div class="mode-option-title">Sheet Flow</div>
                    <div class="mode-option-desc">Gesture-based with sliding panels.</div>
                </div>
                <div class="mode-option-check">‚úì</div>
            </div>
            <div class="mode-option" data-mode="cards" onclick="selectOnboardingMode('cards')">
                <span class="mode-option-icon">üÉè</span>
                <div class="mode-option-content">
                    <div class="mode-option-title">Card Deck</div>
                    <div class="mode-option-desc">Swipeable cards for different tools.</div>
                </div>
                <div class="mode-option-check">‚úì</div>
            </div>
        </div>
        <div class="onboarding-footer">
            <button class="onboarding-cta" onclick="completeOnboarding()">üöÄ Get Started</button>
            <button class="onboarding-skip" onclick="skipOnboarding()">I'll explore later</button>
        </div>
    </div>

    <!-- Dual Mode UI -->
    <div id="dualModeUI" class="ui-container">
        <header class="header">
            <div class="logo">üéµ ChordFlow</div>
            <div class="header-actions">
                <button class="header-btn" onclick="toggleMetronome()" id="metronomeHeaderBtn" title="Metronome">ü•Å</button>
                <button class="header-btn" onclick="openSheet('instrument')" id="instrumentBtn">üéπ</button>
                <button class="header-btn" onclick="openSheet('settings')">‚öôÔ∏è</button>
            </div>
        </header>
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="setMode('create')" id="createModeBtn">‚ú® Create</button>
            <button class="mode-btn" onclick="setMode('produce')" id="produceModeBtn">üéöÔ∏è Produce</button>
        </div>
        <main class="main-content">
            <div class="mode-view active" id="createView">
                <div class="settings-row">
                    <button class="setting-chip" onclick="openSheet('key')">
                        <span class="label">Key</span>
                        <span id="keyDisplay">C Major</span>
                    </button>
                    <button class="setting-chip" onclick="openSheet('genre')">
                        <span class="label">Style</span>
                        <span id="genreDisplay">Pop</span>
                    </button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="beat-dots" id="beatDots">
                        <div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div>
                    </div>
                </div>

                <div class="practice-controls">
                    <button class="speed-btn" onclick="setSpeed(0.5)" id="speed50">50%</button>
                    <button class="speed-btn" onclick="setSpeed(0.75)" id="speed75">75%</button>
                    <button class="speed-btn active" onclick="setSpeed(1)" id="speed100">100%</button>
                    <button class="count-in-btn" onclick="toggleCountIn()" id="countInBtn">üì¢ Count</button>
                </div>

                <div class="undo-redo-row">
                    <button class="undo-btn" onclick="undo()" id="undoBtn" disabled>‚Ü©Ô∏è Undo</button>
                    <button class="undo-btn" onclick="redo()" id="redoBtn" disabled>‚Ü™Ô∏è Redo</button>
                </div>
                <div class="sections-strip" id="sectionsStrip"></div>
                <div class="chord-grid" id="chordGrid"></div>
                <button class="generate-btn" onclick="generateProgression()">üé≤ Generate New Progression</button>
                <div class="ai-grid">
                    <button class="ai-btn" onclick="aiGenerate('smart')" id="aiMagicBtn"><span class="icon">‚ú®</span> AI Magic</button>
                    <button class="ai-btn" onclick="aiGenerate('surprise')" id="aiSurpriseBtn"><span class="icon">üéÅ</span> Surprise</button>
                    <button class="ai-btn" onclick="aiGenerate('enhance')" id="aiEnhanceBtn"><span class="icon">üíé</span> Enhance</button>
                    <button class="ai-btn" onclick="aiGenerate('genre')" id="aiGenreBtn"><span class="icon">üé∑</span> Jazzify</button>
                </div>
            </div>
            <div class="mode-view" id="produceView">
                <div class="produce-tabs">
                    <button class="produce-tab active" onclick="setProduceTab('mixer')">üéöÔ∏è Mixer</button>
                    <button class="produce-tab" onclick="setProduceTab('export')">üì§ Export</button>
                    <button class="produce-tab" onclick="setProduceTab('songs')">üíæ Songs</button>
                </div>
                <div class="produce-panel active" id="mixerPanel">
                    <div class="mixer-channel">
                        <div class="channel-name">üéπ Chords</div>
                        <div class="fader-container">
                            <input type="range" class="fader" id="chordVolume" min="0" max="100" value="80" oninput="updateFader('chord', this.value)">
                            <span class="fader-value" id="chordVolumeDisplay">80%</span>
                        </div>
                    </div>
                    <div class="mixer-channel">
                        <div class="channel-name">üé∏ Bass</div>
                        <div class="fader-container">
                            <input type="range" class="fader" id="bassVolume" min="0" max="100" value="70" oninput="updateFader('bass', this.value)">
                            <span class="fader-value" id="bassVolumeDisplay">70%</span>
                        </div>
                    </div>
                    <div class="mixer-channel">
                        <div class="channel-name">üîä Master</div>
                        <div class="fader-container">
                            <input type="range" class="fader" id="masterVolume" min="0" max="100" value="100" oninput="updateFader('master', this.value)">
                            <span class="fader-value" id="masterVolumeDisplay">100%</span>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <div><div class="toggle-label">üé∏ Bass Notes</div><div class="toggle-desc">Play root on beat 1</div></div>
                        <div class="toggle-switch active" id="bassToggle" onclick="toggleBass()"></div>
                    </div>
                    <div class="toggle-row">
                        <div><div class="toggle-label">ü•Å Metronome</div><div class="toggle-desc">Click on every beat</div></div>
                        <div class="toggle-switch" id="metronomeToggle" onclick="toggleMetronome()"></div>
                    </div>
                </div>
                <div class="produce-panel" id="exportPanel">
                    <div class="export-grid">
                        <div class="export-card new" onclick="exportMIDI()">
                            <div class="export-icon">üéπ</div>
                            <div class="export-title">MIDI</div>
                            <div class="export-desc">Universal</div>
                            <div class="export-badge">WORKS!</div>
                        </div>
                        <div class="export-card new" onclick="exportPDF()">
                            <div class="export-icon">üìÑ</div>
                            <div class="export-title">PDF</div>
                            <div class="export-desc">Lead Sheet</div>
                            <div class="export-badge">WORKS!</div>
                        </div>
                        <div class="export-card" onclick="exportFile('wav')">
                            <div class="export-icon">üéµ</div>
                            <div class="export-title">WAV</div>
                            <div class="export-desc">Coming Soon</div>
                        </div>
                        <div class="export-card" onclick="exportFile('mp3')">
                            <div class="export-icon">üìÄ</div>
                            <div class="export-title">MP3</div>
                            <div class="export-desc">Coming Soon</div>
                        </div>
                    </div>
                </div>
                <div class="produce-panel" id="songsPanel">
                    <div class="save-load-grid">
                        <button class="save-btn" onclick="openSaveModal()">üíæ Save Song</button>
                        <button class="load-btn" onclick="document.getElementById('loadFileInput').click()">üìÇ Load File</button>
                    </div>
                    <input type="file" id="loadFileInput" accept=".json" style="display:none" onchange="loadSongFile(event)">
                    <div class="saved-songs" id="savedSongsList"></div>
                </div>
            </div>
        </main>
        <div class="transport">
            <div class="transport-left">
                <button class="transport-btn" onclick="openSheet('instrument')">üéπ</button>
            </div>
            <div class="transport-center">
                <button class="transport-btn" onclick="stopPlayback()">‚èπÔ∏è</button>
                <button class="play-btn" onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è</button>
                <div class="tempo-display" id="tempoTap" onclick="handleTempoTap()">
                    <span id="tempoValue">120</span>
                    <span class="bpm-label">BPM</span>
                </div>
            </div>
            <div class="transport-right">
                <button class="transport-btn active" onclick="toggleLoop()" id="loopBtn">üîÅ</button>
            </div>
        </div>
    </div>

    <!-- Sheet Flow UI -->
    <div id="sheetFlowUI" class="ui-container">
        <div class="sf-header">
            <div class="sf-logo">üéµ ChordFlow</div>
            <button class="sf-header-btn" onclick="openSheet('settings')">‚öôÔ∏è</button>
        </div>
        <div class="sf-canvas" id="sfCanvas">
            <div class="sf-chord-display">
                <div class="sf-current-chord" id="sfCurrentChord">Am</div>
                <div class="sf-chord-label" id="sfChordLabel">A minor ‚Ä¢ Chord 1 of 4</div>
                <div class="sf-progress">
                    <div class="progress-bar"><div class="progress-fill" id="sfProgressFill"></div></div>
                    <div class="beat-dots" id="sfBeatDots">
                        <div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div>
                    </div>
                </div>
            </div>
            <div class="sf-chord-strip" id="sfChordStrip"></div>
        </div>
        <div class="sf-gesture-hint"><span>‚Üê Instruments</span><span>‚Üë Tools</span><span>Sections ‚Üí</span></div>
        <div class="sf-panel sf-panel-left" id="sfLeftPanel">
            <div class="sf-panel-header">
                <div class="sf-panel-title">üéπ Instruments</div>
                <button class="sf-panel-close" onclick="closeSFPanel('left')">‚úï</button>
            </div>
            <div class="sf-panel-body" id="sfInstrumentList"></div>
        </div>
        <div class="sf-panel sf-panel-right" id="sfRightPanel">
            <div class="sf-panel-header">
                <div class="sf-panel-title">üìë Sections</div>
                <button class="sf-panel-close" onclick="closeSFPanel('right')">‚úï</button>
            </div>
            <div class="sf-panel-body" id="sfSectionsList"></div>
        </div>
        <div class="sf-drawer" id="sfDrawer">
            <div class="sf-drawer-handle" onclick="toggleSFDrawer()"></div>
            <div class="sf-drawer-peek">
                <button class="sf-drawer-btn" onclick="togglePlay()"><span class="icon" id="sfPlayIcon">‚ñ∂Ô∏è</span><span class="label">Play</span></button>
                <button class="sf-drawer-btn" onclick="generateProgression()"><span class="icon">üé≤</span><span class="label">Generate</span></button>
                <button class="sf-drawer-btn" onclick="aiGenerate('smart')"><span class="icon">‚ú®</span><span class="label">AI</span></button>
                <button class="sf-drawer-btn" onclick="openSheet('settings')"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></button>
            </div>
            <div class="sf-drawer-content">
                <div class="sf-quick-actions">
                    <button class="sf-quick-btn primary" onclick="aiGenerate('smart')"><span class="icon">‚ú®</span><span class="label">AI Generate</span></button>
                    <button class="sf-quick-btn" onclick="aiGenerate('surprise')"><span class="icon">üéÅ</span><span class="label">Surprise Me</span></button>
                    <button class="sf-quick-btn" onclick="exportMIDI()"><span class="icon">üéπ</span><span class="label">Export MIDI</span></button>
                    <button class="sf-quick-btn" onclick="exportPDF()"><span class="icon">üìÑ</span><span class="label">Export PDF</span></button>
                </div>
            </div>
        </div>
        <div class="sf-overlay" id="sfOverlay" onclick="closeAllSFPanels()"></div>
    </div>

    <!-- Card Deck UI -->
    <div id="cardDeckUI" class="ui-container">
        <div class="cd-header">
            <div class="cd-logo">üéµ ChordFlow</div>
            <button class="cd-header-btn" onclick="openSheet('settings')">‚öôÔ∏è</button>
        </div>
        <div class="cd-stack-container" id="cdStackContainer">
            <div class="cd-card-stack" id="cdCardStack"></div>
        </div>
        <div class="cd-nav-dots" id="cdNavDots"></div>
        <div class="cd-transport">
            <button class="cd-transport-btn active" onclick="toggleLoop()" id="cdLoopBtn">üîÅ</button>
            <button class="cd-transport-btn play" onclick="togglePlay()" id="cdPlayBtn">‚ñ∂Ô∏è</button>
            <span class="cd-tempo" id="cdTempo">120 BPM</span>
        </div>
    </div>

    <!-- Bottom Sheets -->
    <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
    
    <div class="bottom-sheet" id="instrumentSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">üéπ Instrument</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body"><div class="option-list" id="instrumentList"></div></div>
    </div>
    
    <div class="bottom-sheet" id="keySheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">üéµ Key</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body">
            <div class="settings-group-title">Major Keys</div>
            <div class="option-list" id="majorKeyList"></div>
            <div class="settings-group-title" style="margin-top: var(--spacing-lg);">Minor Keys</div>
            <div class="option-list" id="minorKeyList"></div>
        </div>
    </div>
    
    <div class="bottom-sheet" id="genreSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">üé® Genre</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body"><div class="option-list" id="genreList"></div></div>
    </div>
    
    <div class="bottom-sheet" id="settingsSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">‚öôÔ∏è Settings</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body">
            <div class="settings-group">
                <div class="settings-group-title">Interface</div>
                <div class="settings-item" onclick="openSheet('uiMode')">
                    <div class="settings-label"><span class="settings-icon">üé®</span><span>UI Mode</span></div>
                    <span id="currentUILabel" style="color: var(--text-secondary);">Dual Mode ‚Ä∫</span>
                </div>
                <div class="settings-item" onclick="showShortcuts()">
                    <div class="settings-label"><span class="settings-icon">‚å®Ô∏è</span><span>Keyboard Shortcuts</span></div>
                    <span style="color: var(--text-secondary);">?</span>
                </div>
                <div class="settings-item" onclick="resetOnboarding()">
                    <div class="settings-label"><span class="settings-icon">üîÑ</span><span>Reset Onboarding</span></div>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">About</div>
                <div class="settings-item">
                    <div class="settings-label"><span class="settings-icon">üì±</span><span>Version</span></div>
                    <span style="color: var(--text-secondary);">0.61</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-sheet" id="uiModeSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">üé® UI Mode</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body">
            <div class="option-list">
                <div class="option-item" id="uiOptDual" onclick="switchUIMode('dual')">
                    <span class="option-icon">üì±</span>
                    <div class="option-text"><div class="option-title">Dual Mode</div><div class="option-desc">Create & Produce toggle</div></div>
                    <span class="option-check">‚úì</span>
                </div>
                <div class="option-item" id="uiOptSheet" onclick="switchUIMode('sheet')">
                    <span class="option-icon">üìÑ</span>
                    <div class="option-text"><div class="option-title">Sheet Flow</div><div class="option-desc">Gesture-based panels</div></div>
                    <span class="option-check">‚úì</span>
                </div>
                <div class="option-item" id="uiOptCards" onclick="switchUIMode('cards')">
                    <span class="option-icon">üÉè</span>
                    <div class="option-text"><div class="option-title">Card Deck</div><div class="option-desc">Swipeable cards</div></div>
                    <span class="option-check">‚úì</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-sheet" id="songsSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><div class="sheet-title">üìÅ Saved Songs</div><button class="sheet-close" onclick="closeSheet()">‚úï</button></div>
        <div class="sheet-body" id="songsSheetBody"></div>
    </div>

    <!-- Chord Diagram Modal -->
    <div class="chord-diagram-modal" id="chordDiagramModal" onclick="closeChordDiagram()">
        <div class="chord-diagram-content" onclick="event.stopPropagation()">
            <div class="chord-diagram-title" id="diagramChordName">C</div>
            <svg class="chord-diagram-svg" id="chordDiagramSvg" viewBox="0 0 100 120"></svg>
            <div class="chord-diagram-notes" id="diagramNotes">C - E - G</div>
            <button class="chord-diagram-close" onclick="closeChordDiagram()">Close</button>
        </div>
    </div>

    <!-- Save Modal -->
    <div class="save-modal" id="saveModal" onclick="closeSaveModal()">
        <div class="save-modal-content" onclick="event.stopPropagation()">
            <div class="save-modal-title">üíæ Save Song</div>
            <input type="text" class="save-modal-input" id="songNameInput" placeholder="Enter song name..." maxlength="50">
            <div class="save-modal-buttons">
                <button class="save-modal-btn cancel" onclick="closeSaveModal()">Cancel</button>
                <button class="save-modal-btn confirm" onclick="confirmSaveSong()">Save</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal" onclick="closeShortcuts()">
        <div class="shortcuts-content" onclick="event.stopPropagation()">
            <div class="shortcuts-title">‚å®Ô∏è Keyboard Shortcuts</div>
            <div class="shortcut-row"><span>Play / Pause</span><span class="shortcut-key">Space</span></div>
            <div class="shortcut-row"><span>Generate Random</span><span class="shortcut-key">G</span></div>
            <div class="shortcut-row"><span>AI Generate</span><span class="shortcut-key">A</span></div>
            <div class="shortcut-row"><span>Export MIDI</span><span class="shortcut-key">Ctrl+M</span></div>
            <div class="shortcut-row"><span>Export PDF</span><span class="shortcut-key">Ctrl+P</span></div>
            <div class="shortcut-row"><span>Save Song</span><span class="shortcut-key">Ctrl+S</span></div>
            <div class="shortcut-row"><span>Undo</span><span class="shortcut-key">Ctrl+Z</span></div>
            <div class="shortcut-row"><span>Redo</span><span class="shortcut-key">Ctrl+Shift+Z</span></div>
            <div class="shortcut-row"><span>Show Shortcuts</span><span class="shortcut-key">?</span></div>
            <button class="shortcuts-close" onclick="closeShortcuts()">Close</button>
        </div>
    </div>

    <!-- Count-in Overlay -->
    <div class="count-in-overlay" id="countInOverlay">
        <div class="count-in-number" id="countInNumber">4</div>
    </div>

    <div class="toast" id="toast"></div>


    <script>
        const VERSION = '0.61';
        const GEMINI_API_KEY = 'AIzaSyBR1mD1zdnn39IbaQQs99mL5nFxsoNB9dM';
        
        const state = {
            uiMode: localStorage.getItem('chordflow-ui') || 'dual',
            onboardingComplete: localStorage.getItem('chordflow-onboarding') === 'complete',
            selectedOnboardingMode: 'dual',
            mode: 'create', produceTab: 'mixer',
            tempo: 120, baseTempo: 120, speedMultiplier: 1,
            key: 'C', scale: 'major', genre: 'pop',
            isPlaying: false, isLooping: true, metronomeEnabled: false, countInEnabled: false,
            currentChordIndex: 0, currentBeat: 0, instrument: 'grand-piano',
            playInterval: null, metronomeInterval: null,
            chordVolume: 80, bassVolume: 70, masterVolume: 100, bassEnabled: true,
            aiLoading: false, currentSection: 0, currentCardIndex: 0,
            sections: [
                { name: 'Verse', icon: 'üéµ', progression: ['Am', 'F', 'C', 'G'] },
                { name: 'Chorus', icon: 'üé§', progression: ['C', 'G', 'Am', 'F'] },
                { name: 'Bridge', icon: 'üåâ', progression: ['F', 'G', 'Am', 'Em'] }
            ],
            undoStack: [], redoStack: [], maxUndoSteps: 20, editingSections: false
        };

        let tapTimes = [];
        const TAP_TIMEOUT = 2000;

        const NOTE_ORDER = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const FLAT_TO_SHARP = { 'Db': 'C#', 'Eb': 'D#', 'Fb': 'E', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B' };
        const majorKeys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const minorKeys = ['Am', 'A#m', 'Bm', 'Cm', 'C#m', 'Dm', 'D#m', 'Em', 'Fm', 'F#m', 'Gm', 'G#m'];
        
        const genres = [
            { id: 'pop', name: 'Pop', icon: 'üé§' }, { id: 'rock', name: 'Rock', icon: 'üé∏' },
            { id: 'jazz', name: 'Jazz', icon: 'üé∑' }, { id: 'electronic', name: 'Electronic', icon: 'üéß' },
            { id: 'classical', name: 'Classical', icon: 'üéª' }, { id: 'rnb', name: 'R&B', icon: 'üé§' },
            { id: 'folk', name: 'Folk', icon: 'ü™ï' }, { id: 'blues', name: 'Blues', icon: 'üé∫' }
        ];

        const PROGRESSIONS = {
            pop: [['C', 'G', 'Am', 'F'], ['Am', 'F', 'C', 'G'], ['G', 'D', 'Em', 'C']],
            rock: [['A', 'D', 'E', 'A'], ['G', 'C', 'D', 'G'], ['E', 'A', 'D', 'E']],
            jazz: [['Dm7', 'G7', 'Cmaj7', 'Am7'], ['Am7', 'D7', 'Gmaj7', 'Cmaj7']],
            electronic: [['Am', 'Em', 'F', 'G'], ['Cm', 'Gm', 'Ab', 'Bb']],
            classical: [['C', 'Am', 'F', 'G'], ['G', 'Em', 'C', 'D']],
            rnb: [['Dm7', 'G7', 'Cmaj7', 'Am7'], ['Em7', 'Am7', 'Dm7', 'G7']],
            folk: [['G', 'C', 'D', 'G'], ['C', 'F', 'G', 'C']],
            blues: [['A7', 'D7', 'A7', 'E7'], ['E7', 'A7', 'B7', 'E7']]
        };

        const CHORD_NOTES = {
            'C': ['C4','E4','G4'], 'D': ['D4','F#4','A4'], 'E': ['E4','G#4','B4'], 'F': ['F4','A4','C5'], 
            'G': ['G4','B4','D5'], 'A': ['A4','C#5','E5'], 'B': ['B4','D#5','F#5'],
            'C#': ['C#4','F4','G#4'], 'D#': ['D#4','G4','A#4'], 'F#': ['F#4','A#4','C#5'], 
            'G#': ['G#4','C5','D#5'], 'A#': ['A#4','D5','F5'],
            'Cm': ['C4','Eb4','G4'], 'Dm': ['D4','F4','A4'], 'Em': ['E4','G4','B4'], 
            'Fm': ['F4','Ab4','C5'], 'Gm': ['G4','Bb4','D5'], 'Am': ['A4','C5','E5'], 'Bm': ['B4','D5','F#5'],
            'C#m': ['C#4','E4','G#4'], 'D#m': ['D#4','F#4','A#4'], 'F#m': ['F#4','A4','C#5'], 
            'G#m': ['G#4','B4','D#5'], 'A#m': ['A#4','C#5','F5'],
            'C7': ['C4','E4','G4','Bb4'], 'D7': ['D4','F#4','A4','C5'], 'E7': ['E4','G#4','B4','D5'], 
            'G7': ['G4','B4','D5','F5'], 'A7': ['A4','C#5','E5','G5'], 'B7': ['B4','D#5','F#5','A5'],
            'Dm7': ['D4','F4','A4','C5'], 'Em7': ['E4','G4','B4','D5'], 'Am7': ['A4','C5','E5','G5'],
            'Cmaj7': ['C4','E4','G4','B4'], 'Gmaj7': ['G4','B4','D5','F#5'],
            'Ab': ['G#4','C5','D#5'], 'Bb': ['A#4','D5','F5'], 'Eb': ['D#4','G4','A#4']
        };

        const BASS_NOTES = { 'C': 'C2', 'D': 'D2', 'E': 'E2', 'F': 'F2', 'G': 'G2', 'A': 'A2', 'B': 'B2', 
            'C#': 'C#2', 'D#': 'D#2', 'F#': 'F#2', 'G#': 'G#2', 'A#': 'A#2' };

        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ', type: 'triangle', attack: 0.02, decay: 1.2, sustain: 0.3, release: 1.5 },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ', type: 'sine', attack: 0.01, decay: 0.8, sustain: 0.4, release: 1.0 },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß', type: 'sawtooth', attack: 0.5, decay: 0.3, sustain: 0.8, release: 2.0 },
            { id: 'acoustic-guitar', name: 'Acoustic Guitar', icon: 'üé∏', type: 'triangle', attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.8 },
            { id: 'strings', name: 'Strings', icon: 'üéª', type: 'sawtooth', attack: 0.3, decay: 0.2, sustain: 0.7, release: 1.5 },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è', type: 'square', attack: 0.01, decay: 0.1, sustain: 0.9, release: 0.3 }
        ];

        const cardTypes = [
            { type: 'progression', icon: 'üéµ', label: 'Progression' },
            { type: 'ai', icon: '‚ú®', label: 'AI Tools' },
            { type: 'mixer', icon: 'üéöÔ∏è', label: 'Mixer' },
            { type: 'export', icon: 'üíæ', label: 'Export' }
        ];

        // Helpers
        function normalizeNote(note) { return FLAT_TO_SHARP[note] || note; }
        function transposeChord(chord, semitones) {
            const match = chord.match(/^([A-G][#b]?)(.*)$/);
            if (!match) return chord;
            let [, root, quality] = match;
            root = normalizeNote(root);
            const rootIndex = NOTE_ORDER.indexOf(root);
            if (rootIndex === -1) return chord;
            return NOTE_ORDER[(rootIndex + semitones + 12) % 12] + quality;
        }
        function getKeyInfo() {
            const isMinor = state.key.includes('m');
            const root = state.key.replace('m', '');
            return { root, isMinor, display: `${root} ${isMinor ? 'Minor' : 'Major'}` };
        }
        function getTransposedProgression() {
            const keyInfo = getKeyInfo();
            const keyIndex = NOTE_ORDER.indexOf(normalizeNote(keyInfo.root));
            const baseIndex = keyInfo.isMinor ? NOTE_ORDER.indexOf('A') : NOTE_ORDER.indexOf('C');
            return state.sections[state.currentSection].progression.map(c => transposeChord(c, keyIndex - baseIndex));
        }
        function getChordRoot(chord) {
            const match = chord.match(/^([A-G][#b]?)/);
            return match ? normalizeNote(match[1]) : 'C';
        }
        function getChordType(chord) {
            if (chord.includes('maj7')) return 'major7';
            if (chord.includes('m7')) return 'minor7';
            if (chord.includes('7')) return 'dominant7';
            if (chord.includes('m')) return 'minor';
            return 'major';
        }
        function getChordTypeLabel(chord) {
            const types = { 'major': 'Major', 'minor': 'Minor', 'major7': 'Major 7th', 'minor7': 'Minor 7th', 'dominant7': 'Dominant 7th' };
            return types[getChordType(chord)] || 'Major';
        }
        function getChordColorClass(chord) {
            const type = getChordType(chord);
            if (type === 'minor' || type === 'minor7') return 'minor';
            if (type.includes('7')) return 'seventh';
            return 'major';
        }

        // Undo/Redo
        function saveStateForUndo() {
            state.undoStack.push(JSON.stringify(state.sections));
            if (state.undoStack.length > state.maxUndoSteps) state.undoStack.shift();
            state.redoStack = [];
            updateUndoButtons();
        }
        function undo() {
            if (state.undoStack.length === 0) return;
            state.redoStack.push(JSON.stringify(state.sections));
            state.sections = JSON.parse(state.undoStack.pop());
            state.currentChordIndex = 0;
            renderAll();
            showToast('‚Ü©Ô∏è Undone');
        }
        function redo() {
            if (state.redoStack.length === 0) return;
            state.undoStack.push(JSON.stringify(state.sections));
            state.sections = JSON.parse(state.redoStack.pop());
            state.currentChordIndex = 0;
            renderAll();
            showToast('‚Ü™Ô∏è Redone');
        }
        function updateUndoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = state.undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = state.redoStack.length === 0;
        }

        // Save/Load
        function openSaveModal() {
            document.getElementById('songNameInput').value = `Song ${new Date().toLocaleDateString()}`;
            document.getElementById('saveModal').classList.add('active');
            setTimeout(() => document.getElementById('songNameInput').focus(), 100);
        }
        function closeSaveModal() { document.getElementById('saveModal').classList.remove('active'); }
        function confirmSaveSong() {
            const name = document.getElementById('songNameInput').value.trim();
            if (!name) { showToast('‚ö†Ô∏è Enter a name'); return; }
            const songs = JSON.parse(localStorage.getItem('chordflow-songs') || '[]');
            songs.unshift({ name, date: new Date().toISOString(), sections: state.sections, key: state.key, genre: state.genre, tempo: state.tempo });
            localStorage.setItem('chordflow-songs', JSON.stringify(songs));
            closeSaveModal();
            renderSavedSongs();
            showToast(`üíæ Saved: ${name}`);
        }
        function loadSong(i) {
            const songs = JSON.parse(localStorage.getItem('chordflow-songs') || '[]');
            if (songs[i]) {
                saveStateForUndo();
                Object.assign(state, { sections: songs[i].sections, key: songs[i].key || 'C', genre: songs[i].genre || 'pop', tempo: songs[i].tempo || 120, baseTempo: songs[i].tempo || 120, currentSection: 0, currentChordIndex: 0 });
                updateTempoDisplay();
                renderAll();
                closeSheet();
                showToast(`üìÇ Loaded: ${songs[i].name}`);
            }
        }
        function deleteSong(i, e) {
            e.stopPropagation();
            const songs = JSON.parse(localStorage.getItem('chordflow-songs') || '[]');
            const name = songs[i]?.name;
            songs.splice(i, 1);
            localStorage.setItem('chordflow-songs', JSON.stringify(songs));
            renderSavedSongs();
            showToast(`üóëÔ∏è Deleted: ${name}`);
        }
        function renderSavedSongs() {
            const songs = JSON.parse(localStorage.getItem('chordflow-songs') || '[]');
            const html = songs.length === 0 
                ? '<div style="text-align:center;color:var(--text-secondary);padding:var(--spacing-xl);">No saved songs yet. üéµ</div>'
                : songs.map((s, i) => `<div class="saved-song-item" onclick="loadSong(${i})"><div><div class="saved-song-name">${s.name}</div><div class="saved-song-meta">${new Date(s.date).toLocaleDateString()}</div></div><button class="saved-song-delete" onclick="deleteSong(${i}, event)">‚úï</button></div>`).join('');
            ['savedSongsList', 'songsSheetBody'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
        }
        function loadSongFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.sections) {
                        saveStateForUndo();
                        Object.assign(state, { sections: data.sections, key: data.key || 'C', genre: data.genre || 'pop', tempo: data.tempo || 120, baseTempo: data.tempo || 120, currentSection: 0, currentChordIndex: 0 });
                        updateTempoDisplay();
                        renderAll();
                        showToast('üìÇ Loaded from file');
                    }
                } catch { showToast('‚ùå Invalid file'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // Chord Diagram
        function showChordDiagram(chord) {
            const notes = getChordNotes(chord);
            document.getElementById('diagramChordName').textContent = chord;
            document.getElementById('diagramNotes').textContent = notes.map(n => n.replace(/\d/, '')).join(' - ');
            drawChordDiagram(chord);
            document.getElementById('chordDiagramModal').classList.add('active');
        }
        function closeChordDiagram() { document.getElementById('chordDiagramModal').classList.remove('active'); }
        function drawChordDiagram(chord) {
            const svg = document.getElementById('chordDiagramSvg');
            const root = getChordRoot(chord), isMinor = chord.includes('m') && !chord.includes('maj');
            let html = '<rect x="15" y="25" width="70" height="4" fill="#444"/>';
            for (let f = 0; f <= 4; f++) html += `<line x1="15" y1="${25+f*22}" x2="85" y2="${25+f*22}" stroke="#555"/>`;
            for (let s = 0; s < 6; s++) html += `<line x1="${15+s*14}" y1="25" x2="${15+s*14}" y2="113" stroke="#888"/>`;
            const shapes = {
                'C': [[0,0],[3,1],[2,2],[0,3],[1,4],[0,5]], 'Am': [[-1,0],[0,1],[2,2],[2,3],[1,4],[0,5]],
                'G': [[3,0],[2,1],[0,2],[0,3],[0,4],[3,5]], 'Em': [[0,0],[2,1],[2,2],[0,3],[0,4],[0,5]],
                'D': [[-1,0],[-1,1],[0,2],[2,3],[3,4],[2,5]], 'Dm': [[-1,0],[-1,1],[0,2],[2,3],[3,4],[1,5]]
            };
            const shape = shapes[chord] || shapes[root] || shapes[isMinor ? 'Am' : 'C'];
            shape.forEach(([fret, string]) => {
                const x = 15 + string * 14;
                if (fret === -1) html += `<text x="${x}" y="17" text-anchor="middle" fill="#ff375f" font-size="12" font-weight="bold">‚úï</text>`;
                else if (fret === 0) html += `<circle cx="${x}" cy="17" r="5" fill="none" stroke="white" stroke-width="2"/>`;
                else html += `<circle cx="${x}" cy="${25+(fret-0.5)*22}" r="7" fill="white"/>`;
            });
            svg.innerHTML = html;
        }

        // Audio
        let audioInit = false, mainSynth = null, bassSynth = null, metronomeSynth = null, masterGain = null;
        async function initAudio() {
            if (audioInit) return;
            try {
                await Tone.start();
                masterGain = new Tone.Gain(state.masterVolume / 100).toDestination();
                createSynth(); createBassSynth(); createMetronomeSynth();
                audioInit = true;
            } catch (err) { console.error('Audio init failed:', err); showToast('‚ö†Ô∏è Audio failed'); }
        }
        function createSynth() {
            if (mainSynth) { mainSynth.disconnect(); mainSynth.dispose(); }
            const inst = instruments.find(i => i.id === state.instrument) || instruments[0];
            mainSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: inst.type },
                envelope: { attack: inst.attack, decay: inst.decay, sustain: inst.sustain, release: inst.release }
            });
            mainSynth.volume.value = Tone.gainToDb(state.chordVolume / 100);
            mainSynth.connect(masterGain);
        }
        function createBassSynth() {
            if (bassSynth) { bassSynth.disconnect(); bassSynth.dispose(); }
            bassSynth = new Tone.MonoSynth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.5 } });
            bassSynth.volume.value = Tone.gainToDb(state.bassVolume / 100);
            bassSynth.connect(masterGain);
        }
        function createMetronomeSynth() {
            if (metronomeSynth) { metronomeSynth.disconnect(); metronomeSynth.dispose(); }
            metronomeSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.1 } });
            metronomeSynth.volume.value = -10;
            metronomeSynth.connect(masterGain);
        }
        function playMetronomeTick(accent = false) { if (metronomeSynth && state.metronomeEnabled) metronomeSynth.triggerAttackRelease(accent ? 'C3' : 'C2', '32n'); }
        function toggleMetronome() {
            state.metronomeEnabled = !state.metronomeEnabled;
            document.getElementById('metronomeToggle')?.classList.toggle('active', state.metronomeEnabled);
            document.getElementById('metronomeHeaderBtn')?.classList.toggle('active', state.metronomeEnabled);
            if (state.isPlaying) restartPlayback();
            showToast(state.metronomeEnabled ? 'ü•Å Metronome ON' : 'ü•Å Metronome OFF');
        }
        function updateVolume() {
            if (mainSynth) mainSynth.volume.value = Tone.gainToDb(state.chordVolume / 100);
            if (bassSynth) bassSynth.volume.value = Tone.gainToDb(state.bassVolume / 100);
            if (masterGain) masterGain.gain.value = state.masterVolume / 100;
        }
        function updateFader(type, val) {
            val = parseInt(val);
            if (type === 'chord') { state.chordVolume = val; document.querySelectorAll('#chordVolumeDisplay, .cd-chord-vol').forEach(el => el.textContent = val + '%'); }
            else if (type === 'bass') { state.bassVolume = val; document.querySelectorAll('#bassVolumeDisplay, .cd-bass-vol').forEach(el => el.textContent = val + '%'); }
            else if (type === 'master') { state.masterVolume = val; document.querySelectorAll('#masterVolumeDisplay, .cd-master-vol').forEach(el => el.textContent = val + '%'); }
            updateVolume();
        }
        function getChordNotes(chord) { return CHORD_NOTES[chord] || CHORD_NOTES[chord.replace(/7|maj/g, '')] || CHORD_NOTES['C']; }
        function getBassNote(chord) { return BASS_NOTES[getChordRoot(chord)] || 'C2'; }
        async function playChord(chord, duration = '2n') {
            await initAudio();
            mainSynth.triggerAttackRelease(getChordNotes(chord), duration);
            if (state.bassEnabled) bassSynth.triggerAttackRelease(getBassNote(chord), duration);
            if (navigator.vibrate) navigator.vibrate(10);
        }
        function toggleBass() {
            state.bassEnabled = !state.bassEnabled;
            document.getElementById('bassToggle')?.classList.toggle('active', state.bassEnabled);
            showToast(state.bassEnabled ? 'üé∏ Bass ON' : 'üé∏ Bass OFF');
        }

        // Speed / Practice
        function setSpeed(mult) {
            state.speedMultiplier = mult;
            state.tempo = Math.round(state.baseTempo * mult);
            updateTempoDisplay();
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`speed${mult * 100}`)?.classList.add('active');
            if (state.isPlaying) restartPlayback();
            showToast(`‚è±Ô∏è Speed: ${mult * 100}%`);
        }
        function toggleCountIn() {
            state.countInEnabled = !state.countInEnabled;
            document.getElementById('countInBtn')?.classList.toggle('active', state.countInEnabled);
            showToast(state.countInEnabled ? 'üì¢ Count-in ON' : 'üì¢ Count-in OFF');
        }
        async function doCountIn() {
            const overlay = document.getElementById('countInOverlay'), number = document.getElementById('countInNumber');
            const beatMs = (60 / state.tempo) * 1000;
            overlay.classList.add('active');
            for (let i = 4; i >= 1; i--) {
                number.textContent = i;
                number.style.animation = 'none'; number.offsetHeight; number.style.animation = 'countPop 0.5s ease';
                playMetronomeTick(i === 1);
                await new Promise(r => setTimeout(r, beatMs));
            }
            overlay.classList.remove('active');
        }

        // Tap Tempo
        function handleTempoTap() {
            const now = Date.now();
            tapTimes = tapTimes.filter(t => now - t < TAP_TIMEOUT);
            tapTimes.push(now);
            const tempoTap = document.getElementById('tempoTap');
            tempoTap.classList.add('tapping');
            setTimeout(() => tempoTap.classList.remove('tapping'), 200);
            if (tapTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < tapTimes.length; i++) intervals.push(tapTimes[i] - tapTimes[i-1]);
                const avgInterval = intervals.reduce((a,b) => a+b, 0) / intervals.length;
                const newTempo = Math.round(60000 / avgInterval);
                if (newTempo >= 40 && newTempo <= 200) {
                    state.baseTempo = newTempo;
                    state.tempo = Math.round(newTempo * state.speedMultiplier);
                    updateTempoDisplay();
                    if (state.isPlaying) restartPlayback();
                }
            }
        }
        function updateTempoDisplay() {
            ['tempoValue', 'tempoLarge'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = state.tempo; });
            const cdTempo = document.getElementById('cdTempo'); if (cdTempo) cdTempo.textContent = `${state.tempo} BPM`;
        }

        // AI
        async function callGeminiAI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.8, maxOutputTokens: 200 } }) });
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch { return null; }
        }
        function parseChordResponse(text) {
            const matches = text.match(/[A-G][#b]?(m|maj|dim|aug)?7?/g);
            if (matches && matches.length >= 3) return matches.filter(c => CHORD_NOTES[c] || CHORD_NOTES[c.replace('7', '')]).slice(0, 8);
            return null;
        }
        async function aiGenerate(type) {
            if (state.aiLoading) return;
            state.aiLoading = true;
            setAIButtonsLoading(true);
            saveStateForUndo();
            const keyInfo = getKeyInfo();
            let prompt = '';
            switch (type) {
                case 'smart': prompt = `Generate a ${state.genre} chord progression in ${keyInfo.display}. Give exactly 4 chords. Just list chord names.`; break;
                case 'surprise': prompt = `Generate a surprising unique chord progression. Use unexpected changes. Give 4-6 chords. Just list chord names.`; break;
                case 'enhance': prompt = `Take these chords: ${getTransposedProgression().join(' ')} and make them more interesting with 7ths. Give 4-6 enhanced chords.`; break;
                case 'genre': prompt = `Transform these chords: ${getTransposedProgression().join(' ')} into jazz style with 7ths. Give 4-6 chords.`; break;
            }
            showToast('‚ú® Asking AI...');
            const response = await callGeminiAI(prompt);
            const chords = response ? parseChordResponse(response) : null;
            if (chords && chords.length >= 3) {
                state.sections[state.currentSection].progression = chords;
                state.currentChordIndex = 0;
                renderAll();
                showToast(`‚ú® AI generated ${chords.length} chords!`);
            } else {
                generateProgression();
                showToast('üé≤ Used smart fallback');
            }
            state.aiLoading = false;
            setAIButtonsLoading(false);
        }
        function setAIButtonsLoading(loading) {
            ['aiMagicBtn', 'aiSurpriseBtn', 'aiEnhanceBtn', 'aiGenreBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) { btn.disabled = loading; btn.classList.toggle('loading', loading); }
            });
            document.querySelectorAll('.cd-tool-item[data-ai]').forEach(el => el.classList.toggle('loading', loading));
        }

        // Export
        function exportMIDI() {
            const chords = getTransposedProgression();
            const ticksPerBeat = 480, beatsPerChord = 2;
            const header = [0x4D, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF];
            const trackEvents = [[0x00, 0xFF, 0x51, 0x03, 0x07, 0xA1, 0x20], [0x00, 0xC0, 0x00]];
            const noteMap = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
            const noteToMidi = n => { const m = n.match(/([A-G]#?)(\d)/); return m ? noteMap[m[1]] + (parseInt(m[2]) + 1) * 12 : 60; };
            const varLength = v => { if (v < 128) return [v]; const b = []; b.unshift(v & 0x7F); v >>= 7; while (v > 0) { b.unshift((v & 0x7F) | 0x80); v >>= 7; } return b; };
            chords.forEach(chord => {
                const midiNotes = getChordNotes(chord).map(noteToMidi);
                midiNotes.forEach(n => trackEvents.push([0x00, 0x90, n, 100]));
                trackEvents.push([...varLength(ticksPerBeat * beatsPerChord)]);
                midiNotes.forEach((n, j) => trackEvents.push([...(j === 0 ? [] : [0x00]), 0x80, n, 0]));
            });
            trackEvents.push([0x00, 0xFF, 0x2F, 0x00]);
            const trackData = trackEvents.flat();
            const midi = new Uint8Array([...header, 0x4D, 0x54, 0x72, 0x6B, (trackData.length >> 24) & 0xFF, (trackData.length >> 16) & 0xFF, (trackData.length >> 8) & 0xFF, trackData.length & 0xFF, ...trackData]);
            downloadFile(midi, 'chordflow.mid', 'audio/midi');
            showToast('üéπ MIDI exported!');
        }
        function exportPDF() {
            const chords = getTransposedProgression(), keyInfo = getKeyInfo();
            const pdf = `%PDF-1.4\n1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj\n2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj\n3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj\n4 0 obj << /Length 400 >> stream\nBT\n/F1 28 Tf 72 720 Td (ChordFlow Lead Sheet) Tj\n/F1 14 Tf 0 -35 Td (Key: ${keyInfo.display} | Tempo: ${state.tempo} BPM) Tj\n/F1 36 Tf 0 -80 Td (${chords.join('  -  ')}) Tj\n/F1 12 Tf 0 -60 Td (Generated by ChordFlow v${VERSION}) Tj\nET\nendstream\nendobj\n5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj\nxref\n0 6\ntrailer << /Size 6 /Root 1 0 R >>\nstartxref\n700\n%%EOF`;
            downloadFile(new Blob([pdf], { type: 'application/pdf' }), 'chordflow.pdf', 'application/pdf');
            showToast('üìÑ PDF exported!');
        }
        function downloadFile(data, filename, mimeType) {
            const blob = data instanceof Blob ? data : new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function exportFile(format) { showToast(`üì¶ ${format.toUpperCase()} coming in v1.0!`); }

        // Onboarding
        function selectOnboardingMode(mode) {
            state.selectedOnboardingMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.toggle('selected', el.dataset.mode === mode));
        }
        function completeOnboarding() {
            state.uiMode = state.selectedOnboardingMode;
            localStorage.setItem('chordflow-ui', state.uiMode);
            localStorage.setItem('chordflow-onboarding', 'complete');
            state.onboardingComplete = true;
            document.getElementById('onboarding').classList.add('hidden');
            setTimeout(() => { document.getElementById('onboarding').style.display = 'none'; activateUI(); }, 500);
        }
        function skipOnboarding() {
            localStorage.setItem('chordflow-onboarding', 'complete');
            state.onboardingComplete = true;
            document.getElementById('onboarding').classList.add('hidden');
            setTimeout(() => { document.getElementById('onboarding').style.display = 'none'; activateUI(); }, 500);
        }
        function resetOnboarding() {
            localStorage.removeItem('chordflow-onboarding');
            closeSheet();
            showToast('üîÑ Reloading...');
            setTimeout(() => location.reload(), 500);
        }

        // UI Modes
        function activateUI() {
            const uiMap = { dual: 'dualModeUI', sheet: 'sheetFlowUI', cards: 'cardDeckUI' };
            document.querySelectorAll('.ui-container').forEach(c => c.classList.remove('active'));
            document.getElementById(uiMap[state.uiMode])?.classList.add('active');
            updateUISelectors(); syncUIState(); renderAll(); renderSavedSongs();
            if (state.uiMode === 'cards') initCardDeck();
        }
        function switchUIMode(mode) {
            state.uiMode = mode;
            localStorage.setItem('chordflow-ui', mode);
            activateUI(); closeSheet();
            showToast({ dual: 'üì± Dual Mode', sheet: 'üìÑ Sheet Flow', cards: 'üÉè Card Deck' }[mode]);
        }
        function updateUISelectors() {
            document.getElementById('uiOptDual')?.classList.toggle('selected', state.uiMode === 'dual');
            document.getElementById('uiOptSheet')?.classList.toggle('selected', state.uiMode === 'sheet');
            document.getElementById('uiOptCards')?.classList.toggle('selected', state.uiMode === 'cards');
            const label = document.getElementById('currentUILabel');
            if (label) label.textContent = { dual: 'Dual Mode ‚Ä∫', sheet: 'Sheet Flow ‚Ä∫', cards: 'Card Deck ‚Ä∫' }[state.uiMode];
        }
        function syncUIState() {
            document.getElementById('bassToggle')?.classList.toggle('active', state.bassEnabled);
            document.getElementById('metronomeToggle')?.classList.toggle('active', state.metronomeEnabled);
            document.getElementById('metronomeHeaderBtn')?.classList.toggle('active', state.metronomeEnabled);
            document.getElementById('loopBtn')?.classList.toggle('active', state.isLooping);
            document.getElementById('cdLoopBtn')?.classList.toggle('active', state.isLooping);
            document.getElementById('chordVolume').value = state.chordVolume;
            document.getElementById('bassVolume').value = state.bassVolume;
            document.getElementById('masterVolume').value = state.masterVolume;
            document.getElementById('chordVolumeDisplay').textContent = state.chordVolume + '%';
            document.getElementById('bassVolumeDisplay').textContent = state.bassVolume + '%';
            document.getElementById('masterVolumeDisplay').textContent = state.masterVolume + '%';
            updateTempoDisplay();
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`speed${state.speedMultiplier * 100}`)?.classList.add('active');
        }

        // Dual Mode
        function setMode(mode) {
            state.mode = mode;
            document.getElementById('createModeBtn')?.classList.toggle('active', mode === 'create');
            document.getElementById('produceModeBtn')?.classList.toggle('active', mode === 'produce');
            document.getElementById('createView')?.classList.toggle('active', mode === 'create');
            document.getElementById('produceView')?.classList.toggle('active', mode === 'produce');
        }
        function setProduceTab(tab) {
            state.produceTab = tab;
            document.querySelectorAll('.produce-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.produce-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.produce-tab[onclick*="${tab}"]`)?.classList.add('active');
            document.getElementById(`${tab}Panel`)?.classList.add('active');
        }

        // Sections
        function renderSections() {
            const strip = document.getElementById('sectionsStrip');
            if (!strip) return;
            strip.innerHTML = state.sections.map((s, i) => `
                <button class="section-pill ${state.currentSection === i ? 'active' : ''} ${state.editingSections ? 'editing' : ''}" onclick="selectSection(${i})" oncontextmenu="event.preventDefault(); toggleSectionEdit()">
                    <span class="section-icon">${s.icon}</span>${s.name}
                    <span class="section-delete" onclick="event.stopPropagation(); deleteSection(${i})">‚úï</span>
                </button>
            `).join('') + `<button class="add-section-btn" onclick="addSection()">+ Add</button>`;
        }
        function selectSection(i) { state.currentSection = i; state.currentChordIndex = 0; renderAll(); showToast(`${state.sections[i].icon} ${state.sections[i].name}`); }
        function addSection() {
            saveStateForUndo();
            const names = ['Intro', 'Verse 2', 'Pre-Chorus', 'Outro', 'Solo'];
            const icons = ['üéº', 'üéµ', 'üé∂', 'üèÅ', 'üé∏'];
            const idx = state.sections.length % names.length;
            state.sections.push({ name: names[idx], icon: icons[idx], progression: ['Am', 'F', 'C', 'G'] });
            state.currentSection = state.sections.length - 1;
            renderAll();
            showToast(`‚ûï Added ${names[idx]}`);
        }
        function deleteSection(i) {
            if (state.sections.length <= 1) { showToast('‚ö†Ô∏è Need at least one section'); return; }
            saveStateForUndo();
            const name = state.sections[i].name;
            state.sections.splice(i, 1);
            if (state.currentSection >= state.sections.length) state.currentSection = state.sections.length - 1;
            state.currentChordIndex = 0;
            renderAll();
            showToast(`üóëÔ∏è Deleted ${name}`);
        }
        function toggleSectionEdit() { state.editingSections = !state.editingSections; renderSections(); showToast(state.editingSections ? '‚úèÔ∏è Tap ‚úï to delete' : '‚úÖ Done'); }

        // Progress
        function updateProgress() {
            const displayChords = getTransposedProgression();
            const progress = ((state.currentChordIndex + 1) / displayChords.length) * 100;
            document.querySelectorAll('.progress-fill, #sfProgressFill').forEach(el => el.style.width = progress + '%');
        }
        function updateBeatDots(beat) {
            document.querySelectorAll('.beat-dots, #sfBeatDots').forEach(container => {
                container.querySelectorAll('.beat-dot').forEach((dot, i) => {
                    dot.classList.remove('active', 'accent');
                    if (i === beat) { dot.classList.add('active'); if (beat === 0) dot.classList.add('accent'); }
                });
            });
        }

        // Chord Grid
        function renderChords() {
            const grid = document.getElementById('chordGrid');
            if (!grid) return;
            const displayChords = getTransposedProgression();
            grid.innerHTML = displayChords.map((chord, i) => `
                <div class="chord-card ${getChordColorClass(chord)} ${state.currentChordIndex === i && state.isPlaying ? 'playing' : ''}" onclick="playChordAtIndex(${i})">
                    <div class="chord-index">${i + 1}</div>
                    <button class="chord-diagram-btn" onclick="event.stopPropagation(); showChordDiagram('${chord}')">üé∏</button>
                    <div class="chord-name">${chord}</div>
                    <div class="chord-type">${getChordTypeLabel(chord)}</div>
                </div>
            `).join('');
        }
        async function playChordAtIndex(i) { state.currentChordIndex = i; renderAll(); await playChord(getTransposedProgression()[i], '4n'); }

        // Sheet Flow
        function renderSheetFlowUI() {
            const displayChords = getTransposedProgression();
            const chord = displayChords[state.currentChordIndex] || 'C';
            const el = document.getElementById('sfCurrentChord');
            if (el) { el.textContent = chord; el.classList.toggle('playing', state.isPlaying); }
            const label = document.getElementById('sfChordLabel');
            if (label) label.textContent = `${getChordTypeLabel(chord)} ‚Ä¢ Chord ${state.currentChordIndex + 1} of ${displayChords.length}`;
            const strip = document.getElementById('sfChordStrip');
            if (strip) strip.innerHTML = displayChords.map((c, i) => `<div class="sf-strip-chord ${i === state.currentChordIndex ? 'active' : ''}" onclick="sfSelectChord(${i})"><div class="sf-strip-name">${c}</div><div class="sf-strip-num">${i + 1}</div></div>`).join('');
            const instList = document.getElementById('sfInstrumentList');
            if (instList) instList.innerHTML = instruments.map(inst => `<div class="sf-instrument-item ${state.instrument === inst.id ? 'selected' : ''}" onclick="sfSelectInstrument('${inst.id}')"><span class="sf-instrument-icon">${inst.icon}</span><span class="sf-instrument-name">${inst.name}</span><span class="sf-instrument-check">‚úì</span></div>`).join('');
            const secList = document.getElementById('sfSectionsList');
            if (secList) secList.innerHTML = '<div class="option-list">' + state.sections.map((s, i) => `<div class="option-item ${state.currentSection === i ? 'selected' : ''}" onclick="selectSection(${i}); closeSFPanel('right')"><span class="option-icon">${s.icon}</span><div class="option-text"><div class="option-title">${s.name}</div></div></div>`).join('') + '</div>';
        }
        function sfSelectChord(i) { state.currentChordIndex = i; renderAll(); playChord(getTransposedProgression()[i], '4n'); }
        function sfSelectInstrument(id) { state.instrument = id; if (audioInit) createSynth(); renderSheetFlowUI(); closeSFPanel('left'); showToast(`${instruments.find(i => i.id === id).icon} ${instruments.find(i => i.id === id).name}`); }
        function openSFPanel(side) { document.getElementById('sfOverlay').classList.add('active'); document.getElementById(side === 'left' ? 'sfLeftPanel' : 'sfRightPanel').classList.add('open'); }
        function closeSFPanel(side) { document.getElementById('sfOverlay').classList.remove('active'); document.getElementById(side === 'left' ? 'sfLeftPanel' : 'sfRightPanel').classList.remove('open'); }
        function closeAllSFPanels() { document.getElementById('sfOverlay').classList.remove('active'); document.querySelectorAll('.sf-panel').forEach(p => p.classList.remove('open')); document.getElementById('sfDrawer').classList.remove('open'); }
        function toggleSFDrawer() { document.getElementById('sfDrawer').classList.toggle('open'); }

        // Card Deck
        let cdExpandedCard = null;
        function initCardDeck() { renderCardStack(); setupCardSwipe(); }
        function renderCardStack() {
            const stack = document.getElementById('cdCardStack'), dots = document.getElementById('cdNavDots');
            if (!stack) return;
            const displayChords = getTransposedProgression(), chord = displayChords[state.currentChordIndex] || 'C';
            stack.innerHTML = cardTypes.map((card, i) => {
                const offset = (i - state.currentCardIndex + cardTypes.length) % cardTypes.length;
                const cardClass = offset === 0 ? 'active' : offset === 1 ? 'next' : offset === 2 ? 'behind' : 'hidden-card';
                let body = '';
                if (card.type === 'progression') body = `<div class="cd-progression-display"><div class="cd-big-chord ${state.isPlaying ? 'playing' : ''}">${chord}</div><div class="cd-chord-info">${getChordTypeLabel(chord)} ‚Ä¢ ${state.currentChordIndex + 1} of ${displayChords.length}</div><div class="cd-mini-chords">${displayChords.map((c, j) => `<div class="cd-mini-chord ${j === state.currentChordIndex ? 'active' : ''}" onclick="event.stopPropagation(); cdSelectChord(${j})">${c}</div>`).join('')}</div></div>`;
                else if (card.type === 'ai') body = `<div class="cd-tool-grid"><div class="cd-tool-item ${state.aiLoading ? 'loading' : ''}" data-ai="true" onclick="event.stopPropagation(); aiGenerate('smart')"><span class="icon">‚ú®</span><span class="label">AI Magic</span></div><div class="cd-tool-item ${state.aiLoading ? 'loading' : ''}" data-ai="true" onclick="event.stopPropagation(); aiGenerate('surprise')"><span class="icon">üéÅ</span><span class="label">Surprise</span></div><div class="cd-tool-item ${state.aiLoading ? 'loading' : ''}" data-ai="true" onclick="event.stopPropagation(); aiGenerate('enhance')"><span class="icon">üíé</span><span class="label">Enhance</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); generateProgression()"><span class="icon">üé≤</span><span class="label">Random</span></div></div>`;
                else if (card.type === 'mixer') body = `<div class="mixer-channel"><div class="channel-name">üéπ Chords</div><div class="fader-container"><input type="range" class="fader" min="0" max="100" value="${state.chordVolume}" oninput="updateFader('chord', this.value)"><span class="fader-value cd-chord-vol">${state.chordVolume}%</span></div></div><div class="mixer-channel"><div class="channel-name">üé∏ Bass</div><div class="fader-container"><input type="range" class="fader" min="0" max="100" value="${state.bassVolume}" oninput="updateFader('bass', this.value)"><span class="fader-value cd-bass-vol">${state.bassVolume}%</span></div></div><div class="mixer-channel"><div class="channel-name">üîä Master</div><div class="fader-container"><input type="range" class="fader" min="0" max="100" value="${state.masterVolume}" oninput="updateFader('master', this.value)"><span class="fader-value cd-master-vol">${state.masterVolume}%</span></div></div>`;
                else body = `<div class="cd-tool-grid"><div class="cd-tool-item" onclick="event.stopPropagation(); exportMIDI()"><span class="icon">üéπ</span><span class="label">MIDI</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); exportPDF()"><span class="icon">üìÑ</span><span class="label">PDF</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); openSaveModal()"><span class="icon">üíæ</span><span class="label">Save</span></div><div class="cd-tool-item" onclick="event.stopPropagation(); openSheet('songs')"><span class="icon">üìÇ</span><span class="label">Load</span></div></div>`;
                return `<div class="cd-card ${cardClass}" data-type="${card.type}" data-index="${i}"><div class="cd-card-header"><span class="cd-card-icon">${card.icon}</span><span class="cd-card-label">${card.label}</span><button class="cd-card-close" onclick="event.stopPropagation(); cdCollapseCard()">‚úï</button></div><div class="cd-card-body">${body}</div></div>`;
            }).join('');
            if (dots) dots.innerHTML = cardTypes.map((_, i) => `<div class="cd-nav-dot ${i === state.currentCardIndex ? 'active' : ''}" onclick="cdGoToCard(${i})"></div>`).join('');
            const cdTempo = document.getElementById('cdTempo'); if (cdTempo) cdTempo.textContent = `${state.tempo} BPM`;
        }
        let cdTouchStartX = 0, cdIsSwiping = false;
        function setupCardSwipe() {
            const container = document.getElementById('cdStackContainer');
            if (!container) return;
            container.addEventListener('touchstart', e => { if (cdExpandedCard) return; cdTouchStartX = e.touches[0].clientX; cdIsSwiping = false; }, { passive: true });
            container.addEventListener('touchmove', e => { if (cdExpandedCard) return; if (Math.abs(e.touches[0].clientX - cdTouchStartX) > 20) cdIsSwiping = true; }, { passive: true });
            container.addEventListener('touchend', e => { if (cdExpandedCard) return; const dx = e.changedTouches[0].clientX - cdTouchStartX; if (cdIsSwiping && Math.abs(dx) > 50) { if (dx < 0) cdNextCard(); else cdPrevCard(); } cdIsSwiping = false; }, { passive: true });
            container.addEventListener('click', e => { const card = e.target.closest('.cd-card'); if (card && !cdExpandedCard && card.classList.contains('active')) cdExpandCard(card); });
        }
        function cdNextCard() { state.currentCardIndex = (state.currentCardIndex + 1) % cardTypes.length; renderCardStack(); }
        function cdPrevCard() { state.currentCardIndex = (state.currentCardIndex - 1 + cardTypes.length) % cardTypes.length; renderCardStack(); }
        function cdGoToCard(i) { state.currentCardIndex = i; renderCardStack(); }
        function cdExpandCard(card) { if (cdExpandedCard) return; cdExpandedCard = card; card.classList.add('expanded'); }
        function cdCollapseCard() { if (cdExpandedCard) { cdExpandedCard.classList.remove('expanded'); cdExpandedCard = null; } }
        function cdSelectChord(i) { state.currentChordIndex = i; renderAll(); playChord(getTransposedProgression()[i], '4n'); }
        function renderCardDeckUI() { if (state.uiMode === 'cards') renderCardStack(); }

        // Playback
        async function togglePlay() {
            await initAudio();
            if (!state.isPlaying && state.countInEnabled) await doCountIn();
            state.isPlaying = !state.isPlaying;
            updatePlayButtons();
            if (state.isPlaying) startPlayback(); else stopPlayback();
        }
        function updatePlayButtons() {
            const icon = state.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            ['playBtn', 'sfPlayIcon', 'cdPlayBtn'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = icon; });
            document.getElementById('playBtn')?.classList.toggle('playing', state.isPlaying);
            document.getElementById('cdPlayBtn')?.classList.toggle('playing', state.isPlaying);
        }
        function startPlayback() {
            const beatInterval = (60 / state.tempo) * 1000, chordInterval = beatInterval * 2;
            state.currentBeat = 0;
            playCurrentChord();
            updateBeatDots(0);
            if (state.metronomeEnabled) playMetronomeTick(true);
            state.metronomeInterval = setInterval(() => {
                state.currentBeat = (state.currentBeat + 1) % 4;
                updateBeatDots(state.currentBeat);
                if (state.metronomeEnabled) playMetronomeTick(state.currentBeat === 0);
            }, beatInterval);
            state.playInterval = setInterval(() => {
                const displayChords = getTransposedProgression();
                state.currentChordIndex = (state.currentChordIndex + 1) % displayChords.length;
                if (state.currentChordIndex === 0 && !state.isLooping) { stopPlayback(); return; }
                playCurrentChord();
            }, chordInterval);
        }
        function playCurrentChord() { renderAll(); updateProgress(); playChord(getTransposedProgression()[state.currentChordIndex], '2n'); }
        function stopPlayback() {
            state.isPlaying = false;
            clearInterval(state.playInterval); clearInterval(state.metronomeInterval);
            state.playInterval = null; state.metronomeInterval = null; state.currentBeat = 0;
            updateBeatDots(-1); updatePlayButtons(); renderAll();
        }
        function restartPlayback() { if (state.isPlaying) { clearInterval(state.playInterval); clearInterval(state.metronomeInterval); startPlayback(); } }
        function toggleLoop() {
            state.isLooping = !state.isLooping;
            document.getElementById('loopBtn')?.classList.toggle('active', state.isLooping);
            document.getElementById('cdLoopBtn')?.classList.toggle('active', state.isLooping);
            showToast(state.isLooping ? 'üîÅ Loop ON' : 'üîÅ Loop OFF');
        }
        function generateProgression() {
            saveStateForUndo();
            const pool = PROGRESSIONS[state.genre] || PROGRESSIONS.pop;
            state.sections[state.currentSection].progression = pool[Math.floor(Math.random() * pool.length)];
            state.currentChordIndex = 0;
            renderAll();
            showToast('üé≤ New progression!');
        }

        // Render All
        function renderAll() {
            renderSections(); renderChords(); renderSheetFlowUI(); renderCardDeckUI(); updateProgress();
            const keyDisplay = document.getElementById('keyDisplay'); if (keyDisplay) keyDisplay.textContent = getKeyInfo().display;
            const genreDisplay = document.getElementById('genreDisplay'); if (genreDisplay) genreDisplay.textContent = genres.find(g => g.id === state.genre)?.name || 'Pop';
            updateUndoButtons();
        }

        // Bottom Sheets
        function openSheet(type) {
            closeSheet();
            document.getElementById('sheetOverlay').classList.add('active');
            document.getElementById(`${type}Sheet`)?.classList.add('active');
            if (type === 'instrument') renderInstrumentOptions();
            if (type === 'key') renderKeyOptions();
            if (type === 'genre') renderGenreOptions();
            if (type === 'songs') renderSavedSongs();
        }
        function closeSheet() { document.getElementById('sheetOverlay').classList.remove('active'); document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active')); }
        function renderInstrumentOptions() {
            const list = document.getElementById('instrumentList'); if (!list) return;
            list.innerHTML = instruments.map(inst => `<div class="option-item ${state.instrument === inst.id ? 'selected' : ''}" onclick="selectInstrument('${inst.id}')"><span class="option-icon">${inst.icon}</span><div class="option-text"><div class="option-title">${inst.name}</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        function selectInstrument(id) { state.instrument = id; if (audioInit) createSynth(); document.getElementById('instrumentBtn').textContent = instruments.find(i => i.id === id).icon; closeSheet(); showToast(`${instruments.find(i => i.id === id).icon} ${instruments.find(i => i.id === id).name}`); }
        function renderKeyOptions() {
            const majorList = document.getElementById('majorKeyList'), minorList = document.getElementById('minorKeyList');
            if (majorList) majorList.innerHTML = majorKeys.map(k => `<div class="option-item ${state.key === k ? 'selected' : ''}" onclick="selectKey('${k}')"><span class="option-icon">üéµ</span><div class="option-text"><div class="option-title">${k} Major</div></div><span class="option-check">‚úì</span></div>`).join('');
            if (minorList) minorList.innerHTML = minorKeys.map(k => `<div class="option-item ${state.key === k ? 'selected' : ''}" onclick="selectKey('${k}')"><span class="option-icon">üé∂</span><div class="option-text"><div class="option-title">${k.replace('m', '')} Minor</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        function selectKey(key) { saveStateForUndo(); state.key = key; renderAll(); closeSheet(); showToast(`üéµ Key: ${getKeyInfo().display}`); }
        function renderGenreOptions() {
            const list = document.getElementById('genreList'); if (!list) return;
            list.innerHTML = genres.map(g => `<div class="option-item ${state.genre === g.id ? 'selected' : ''}" onclick="selectGenre('${g.id}')"><span class="option-icon">${g.icon}</span><div class="option-text"><div class="option-title">${g.name}</div></div><span class="option-check">‚úì</span></div>`).join('');
        }
        function selectGenre(id) { saveStateForUndo(); state.genre = id; generateProgression(); closeSheet(); }

        // Modals
        function showShortcuts() { closeSheet(); document.getElementById('shortcutsModal').classList.add('active'); }
        function closeShortcuts() { document.getElementById('shortcutsModal').classList.remove('active'); }

        // Toast
        function showToast(msg) { const t = document.getElementById('toast'); if (!t) return; t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

        // Event Listeners
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
            if (e.code === 'KeyG' && !e.ctrlKey && !e.metaKey) generateProgression();
            if (e.code === 'KeyA' && !e.ctrlKey && !e.metaKey) aiGenerate('smart');
            if (e.code === 'KeyM' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); exportMIDI(); }
            if (e.code === 'KeyP' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); exportPDF(); }
            if (e.code === 'KeyS' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openSaveModal(); }
            if (e.code === 'KeyZ' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); if (e.shiftKey) redo(); else undo(); }
            if (e.code === 'Slash' && e.shiftKey) showShortcuts();
            if (e.code === 'Escape') { closeSheet(); cdCollapseCard(); closeAllSFPanels(); closeChordDiagram(); closeSaveModal(); closeShortcuts(); }
            if (e.code === 'ArrowLeft' && state.uiMode === 'cards') cdPrevCard();
            if (e.code === 'ArrowRight' && state.uiMode === 'cards') cdNextCard();
        });

        let sfTouchStartX = 0;
        document.getElementById('sfCanvas')?.addEventListener('touchstart', e => { sfTouchStartX = e.touches[0].clientX; }, { passive: true });
        document.getElementById('sfCanvas')?.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - sfTouchStartX;
            if (Math.abs(dx) > 100) { if (dx > 0) openSFPanel('left'); else openSFPanel('right'); }
        }, { passive: true });

        // Init
        function init() {
            if (!state.onboardingComplete) { document.getElementById('onboarding').style.display = 'flex'; selectOnboardingMode(state.uiMode); }
            else { document.getElementById('onboarding').style.display = 'none'; activateUI(); }
            console.log(`üéµ ChordFlow v${VERSION} loaded`);
        }
        init();
    </script>
</body>
</html>
