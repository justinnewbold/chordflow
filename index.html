<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v12.2 - AI Studio</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --recording: #ef4444;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --export-blue: #3b82f6;
            --export-green: #22c55e;
            --piano-white: #ffffff;
            --piano-black: #1a1a2e;
            --metronome: #f59e0b;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .theme-light { --bg-primary: #f8fafc; --bg-secondary: #e2e8f0; --bg-card: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b; --piano-black: #374151; }
        .theme-midnight { --bg-primary: #0f0f23; --bg-secondary: #1a1a3e; --bg-card: #2d1b4e; --accent: #8b5cf6; --accent-light: #a78bfa; }
        .theme-ocean { --bg-primary: #0c1929; --bg-secondary: #0c4a6e; --bg-card: #164e63; --accent: #06b6d4; --accent-light: #22d3ee; }
        .theme-forest { --bg-primary: #0a1f0a; --bg-secondary: #14532d; --bg-card: #1e3a1e; --accent: #22c55e; --accent-light: #4ade80; }
        .theme-sunset { --bg-primary: #1f0a0a; --bg-secondary: #7f1d1d; --bg-card: #991b1b; --accent: #f97316; --accent-light: #fb923c; }
        .theme-candy { --bg-primary: #1a0a1f; --bg-secondary: #581c87; --bg-card: #7c3aed; --accent: #ec4899; --accent-light: #f472b6; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; padding-top: var(--safe-top); padding-bottom: calc(var(--safe-bottom) + 200px); transition: all 0.3s; }
        
        .header { background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .version-badge { font-size: 9px; background: var(--success); color: white; padding: 2px 5px; border-radius: 6px; }
        .pro-badge { font-size: 9px; background: linear-gradient(135deg, var(--gold), #f97316); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        .ai-badge { font-size: 9px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        
        .header-actions { display: flex; gap: 6px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        .icon-btn.metronome-active { background: var(--metronome); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .tab-nav { display: flex; background: var(--bg-secondary); margin: 12px 16px; border-radius: 12px; padding: 4px; gap: 4px; overflow-x: auto; }
        .tab-nav::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 1; min-width: 65px; padding: 10px 6px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 10px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn .icon { font-size: 16px; }
        
        .tab-content { display: none; padding: 0 16px; }
        .tab-content.active { display: block; }
        
        .section-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 12px; }
        .panel { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* AI Actions */
        .ai-actions { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding: 2px; }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn { display: flex; align-items: center; gap: 6px; padding: 10px 14px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(236, 72, 153, 0.8)); border: 2px solid rgba(168, 85, 247, 0.6); border-radius: 10px; color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .ai-btn:active { transform: scale(0.98); }
        .ai-btn.loading { opacity: 0.7; pointer-events: none; }
        
        .big-generate-btn { width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #a855f7, #ec4899); border: none; border-radius: 14px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); margin-bottom: 12px; }
        .big-generate-btn:active { transform: scale(0.98); }
        
        /* Mode Toggle */
        .mode-toggle { display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px; margin-bottom: 16px; gap: 4px; }
        .mode-toggle button { flex: 1; padding: 10px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; }
        .mode-toggle button.active { background: var(--accent); color: white; }
        
        /* Controls */
        .controls-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .control-group { flex: 1; }
        .control-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .control-select { width: 100%; padding: 10px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 13px; }
        
        /* Chord Grid */
        .chord-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .chord-card { background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary)); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px 6px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 20px; font-weight: 700; }
        .chord-numeral { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        /* Instrument Selector */
        .instrument-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px; margin-bottom: 16px; }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card { min-width: 80px; padding: 12px 8px; background: var(--bg-card); border: 2px solid transparent; border-radius: 12px; text-align: center; cursor: pointer; }
        .instrument-card.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .instrument-card .icon { font-size: 24px; margin-bottom: 4px; }
        .instrument-card .name { font-size: 10px; color: var(--text-secondary); }
        
        .current-sound { background: linear-gradient(135deg, var(--accent), #764ba2); padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 600; display: inline-block; margin-bottom: 12px; }
        
        /* METRONOME */
        .metronome-panel { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .metronome-display { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 16px; }
        .metronome-visual { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-card); border: 4px solid var(--metronome); display: flex; align-items: center; justify-content: center; position: relative; }
        .metronome-pendulum { width: 4px; height: 30px; background: var(--metronome); border-radius: 2px; transform-origin: bottom center; transition: transform 0.1s; }
        .metronome-visual.tick .metronome-pendulum { transform: rotate(-25deg); }
        .metronome-visual.tock .metronome-pendulum { transform: rotate(25deg); }
        .beat-indicator { display: flex; gap: 6px; margin-top: 8px; justify-content: center; }
        .beat-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--bg-secondary); transition: all 0.1s; }
        .beat-dot.active { background: var(--metronome); transform: scale(1.3); }
        .beat-dot.downbeat.active { background: var(--danger); }
        .tempo-big { font-size: 42px; font-weight: 700; color: var(--metronome); }
        .tempo-label { font-size: 12px; color: var(--text-secondary); }
        .metronome-controls { display: flex; gap: 8px; justify-content: center; align-items: center; }
        .metro-btn { width: 44px; height: 44px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; background: var(--bg-card); color: var(--text-primary); }
        .metro-btn.play { background: var(--metronome); color: white; width: 56px; height: 56px; }
        .metro-btn:active { transform: scale(0.95); }
        .time-sig-btns { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
        .time-sig-btn { padding: 8px 16px; background: var(--bg-card); border: 2px solid transparent; border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; }
        .time-sig-btn.active { border-color: var(--metronome); background: rgba(245, 158, 11, 0.2); }
        
        /* PIANO ROLL */
        .piano-roll-container { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; overflow: hidden; }
        .piano-roll-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .piano-roll-controls { display: flex; gap: 8px; }
        .pr-btn { padding: 6px 12px; background: var(--bg-secondary); border: none; border-radius: 6px; color: var(--text-primary); font-size: 11px; cursor: pointer; }
        .pr-btn.active { background: var(--accent); }
        .piano-roll { display: flex; background: var(--bg-primary); border-radius: 8px; overflow: hidden; height: 280px; }
        .piano-keys { width: 45px; flex-shrink: 0; display: flex; flex-direction: column; }
        .piano-key { height: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 4px; font-size: 8px; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .piano-key.white { background: var(--piano-white); color: #333; }
        .piano-key.black { background: var(--piano-black); color: #fff; }
        .piano-key:active { background: var(--accent) !important; }
        .piano-grid { flex: 1; overflow-x: auto; overflow-y: hidden; }
        .piano-grid-inner { display: flex; flex-direction: column; min-width: 100%; }
        .piano-row { height: 20px; display: flex; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .piano-row.black-row { background: rgba(0,0,0,0.2); }
        .piano-cell { width: 35px; min-width: 35px; border-right: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .piano-cell:hover { background: rgba(102, 126, 234, 0.2); }
        .piano-cell.active { background: var(--accent); border-radius: 2px; }
        .piano-cell.beat-start { border-right: 2px solid rgba(255,255,255,0.15); }
        
        /* MIXER */
        .mixer-panel { background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary)); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .mixer-channels { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
        .mixer-channel { min-width: 70px; background: var(--bg-primary); border-radius: 12px; padding: 12px 8px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .mixer-icon { font-size: 20px; }
        .mixer-name { font-size: 10px; color: var(--text-secondary); }
        .mixer-fader-wrap { height: 100px; width: 24px; background: var(--bg-card); border-radius: 12px; position: relative; display: flex; align-items: flex-end; justify-content: center; padding: 4px; }
        .mixer-fader { width: 100%; height: 100%; -webkit-appearance: none; writing-mode: bt-lr; -webkit-writing-mode: vertical-lr; background: transparent; cursor: pointer; }
        .mixer-fader::-webkit-slider-track { width: 6px; background: linear-gradient(to top, var(--success), var(--warning), var(--danger)); border-radius: 3px; }
        .mixer-fader::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 10px; background: var(--text-primary); border-radius: 3px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .mixer-value { font-size: 11px; font-weight: 600; color: var(--accent-light); }
        
        /* EQ */
        .eq-section { background: var(--bg-primary); border-radius: 12px; padding: 12px; margin-top: 12px; }
        .eq-title { font-size: 12px; font-weight: 600; margin-bottom: 12px; }
        .eq-bands { display: flex; justify-content: space-around; gap: 8px; }
        .eq-band { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .eq-slider { width: 24px; height: 70px; -webkit-appearance: none; writing-mode: bt-lr; -webkit-writing-mode: vertical-lr; background: var(--bg-card); border-radius: 12px; }
        .eq-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 8px; background: var(--accent); border-radius: 4px; }
        .eq-label { font-size: 9px; color: var(--text-secondary); }
        .eq-val { font-size: 10px; color: var(--accent-light); }
        
        /* COMPRESSOR */
        .comp-section { background: var(--bg-primary); border-radius: 12px; padding: 12px; margin-top: 12px; }
        .comp-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .comp-control { text-align: center; }
        .comp-knob { width: 44px; height: 44px; border-radius: 50%; background: conic-gradient(var(--accent) var(--val, 50%), var(--bg-card) 0); display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; cursor: pointer; }
        .comp-knob-inner { width: 34px; height: 34px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; }
        .comp-label { font-size: 9px; color: var(--text-secondary); }
        
        /* SHEET MUSIC */
        .sheet-panel { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .sheet-preview { background: white; border-radius: 8px; padding: 20px; margin-bottom: 12px; min-height: 180px; overflow: hidden; }
        .sheet-preview canvas { width: 100%; height: 180px; display: block; }
        .staff-line { height: 1px; background: #333; margin: 8px 0; }
        .notation-area { display: flex; align-items: center; gap: 15px; padding: 15px 0; overflow-x: auto; }
        .clef { font-size: 40px; color: #333; }
        .time-sig-display { font-size: 20px; font-weight: 700; color: #333; display: flex; flex-direction: column; align-items: center; line-height: 1; }
        .chord-symbol { font-size: 16px; font-weight: 700; color: #333; padding: 6px 12px; border-bottom: 2px solid #333; text-align: center; }
        .chord-symbol .roman { font-size: 10px; color: #666; display: block; }
        .sheet-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .sheet-btn { flex: 1; min-width: 90px; padding: 12px; background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sheet-btn:active { border-color: var(--accent); transform: scale(0.98); }
        .sheet-btn .icon { font-size: 20px; }
        
        /* EXPORT */
        .export-panel { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        
        /* AI Studio Styles */
        .ai-studio-header { text-align: center; margin-bottom: 16px; }
        .ai-subtitle { color: var(--text-secondary); font-size: 12px; margin-top: 4px; }
        .ai-panel { background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3); }
        .ai-feature-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .ai-icon { font-size: 28px; }
        .ai-feature-title { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .ai-feature-desc { font-size: 11px; color: var(--text-secondary); }
        .ai-options { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .ai-options .control-select { flex: 1; min-width: 120px; }
        .ai-input { width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 13px; margin-bottom: 12px; }
        .ai-input::placeholder { color: var(--text-secondary); }
        .ai-generate-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #a855f7, #ec4899); border: none; border-radius: 12px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .ai-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        .ai-generate-btn:active { transform: scale(0.98); }
        .ai-generate-btn.loading { opacity: 0.7; pointer-events: none; }
        .ai-generate-btn.loading::after { content: '...'; animation: dots 1s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .analyze-btn { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .surprise-btn { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .surprise-panel { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-color: rgba(245, 158, 11, 0.3); }
        .ai-result { margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; font-size: 13px; line-height: 1.6; display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .ai-result.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-result .result-title { font-weight: 700; color: var(--accent); margin-bottom: 8px; display: block; }
        .ai-result .chord-tag { display: inline-block; background: var(--accent); color: white; padding: 4px 10px; border-radius: 6px; margin: 2px; font-weight: 600; cursor: pointer; }
        .ai-result .chord-tag:hover { background: var(--accent-light); }
        .ai-result .melody-note { display: inline-block; background: var(--success); color: white; padding: 3px 8px; border-radius: 4px; margin: 2px; font-size: 12px; }
        .style-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .style-btn { padding: 12px 8px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .style-btn:hover { background: var(--accent); transform: scale(1.05); }
        .style-btn:active { transform: scale(0.95); }
        .style-btn.loading { opacity: 0.7; pointer-events: none; }
        .enhance-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .enhance-btn { padding: 14px 10px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .enhance-btn small { display: block; font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .enhance-btn:hover { background: var(--accent); }
        .enhance-btn:active { transform: scale(0.95); }
        .enhance-btn.loading { opacity: 0.7; pointer-events: none; }
        .lyrics-result { font-style: italic; }
        .structure-result .section-label { display: inline-block; background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 11px; margin-right: 8px; }
        .analysis-result .analysis-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .analysis-result .analysis-label { color: var(--accent); font-weight: 600; }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .export-card { padding: 16px; background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .export-card:active { border-color: var(--accent); transform: scale(0.98); }
        .export-card .icon { font-size: 28px; margin-bottom: 8px; }
        .export-card .name { font-size: 14px; font-weight: 600; }
        .export-card .desc { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .export-card.loading { opacity: 0.6; pointer-events: none; }
        .export-progress { margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; display: none; }
        .export-progress.active { display: block; }
        .progress-bar { height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--export-blue), var(--export-green)); border-radius: 3px; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: var(--text-secondary); text-align: center; }
        
        /* THEME */
        .theme-presets { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .theme-preset { aspect-ratio: 1; border-radius: 12px; border: 3px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .theme-preset.active { border-color: var(--accent); transform: scale(1.05); }
        .theme-preset.dark { background: linear-gradient(135deg, #0a0a0f, #1a1a2e); }
        .theme-preset.light { background: linear-gradient(135deg, #f8fafc, #e2e8f0); }
        .theme-preset.midnight { background: linear-gradient(135deg, #0f0f23, #2d1b4e); }
        .theme-preset.ocean { background: linear-gradient(135deg, #0c1929, #164e63); }
        .theme-preset.forest { background: linear-gradient(135deg, #0a1f0a, #1e3a1e); }
        .theme-preset.sunset { background: linear-gradient(135deg, #1f0a0a, #991b1b); }
        .theme-preset.candy { background: linear-gradient(135deg, #1a0a1f, #7c3aed); }
        .theme-preset.custom { background: linear-gradient(135deg, var(--bg-primary), var(--accent)); }
        .color-section { background: var(--bg-card); border-radius: 12px; padding: 16px; }
        .color-pickers { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .color-item { display: flex; align-items: center; gap: 10px; }
        .color-label { font-size: 12px; color: var(--text-secondary); flex: 1; }
        .color-input { width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer; padding: 0; }
        .color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .color-input::-webkit-color-swatch { border: none; border-radius: 8px; }
        
        /* PLAYBACK */
        .playback-bar { position: fixed; bottom: var(--safe-bottom); left: 0; right: 0; background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary)); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; z-index: 200; }
        .playback-main { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .play-btn { width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #764ba2); border: none; color: white; font-size: 22px; cursor: pointer; box-shadow: 0 4px 20px var(--accent-glow); }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 13px; font-weight: 600; }
        .playback-sub { font-size: 11px; color: var(--text-secondary); }
        .tempo-control { display: flex; align-items: center; gap: 4px; }
        .tempo-btn { width: 30px; height: 30px; border-radius: 6px; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 14px; cursor: pointer; }
        .tempo-display { font-size: 13px; font-weight: 600; min-width: 45px; text-align: center; }
        .active-instruments { display: flex; gap: 6px; overflow-x: auto; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        .active-inst { display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--bg-card); border-radius: 16px; font-size: 11px; white-space: nowrap; }
        .active-inst .dot { width: 6px; height: 6px; border-radius: 50%; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border-radius: 20px; width: 100%; max-width: 420px; max-height: 85vh; overflow-y: auto; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 16px; cursor: pointer; }
        
        .toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--accent); padding: 10px 20px; border-radius: 10px; font-size: 13px; z-index: 2000; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v12</span><span class="pro-badge">PRO</span><span class="ai-badge">AI</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="metronomeBtn" onclick="toggleMetronome()">‚è±Ô∏è</button>
            <button class="icon-btn" onclick="openModal('themeModal')">üé®</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('compose')"><span class="icon">üéπ</span><span>Compose</span></button>
        <button class="tab-btn" onclick="switchTab('ai')"><span class="icon">ü§ñ</span><span>AI Studio</span></button>
        <button class="tab-btn" onclick="switchTab('piano')"><span class="icon">üéº</span><span>Piano</span></button>
        <button class="tab-btn" onclick="switchTab('mixer')"><span class="icon">üéöÔ∏è</span><span>Mixer</span></button>
        <button class="tab-btn" onclick="switchTab('sheet')"><span class="icon">üìú</span><span>Sheet</span></button>
        <button class="tab-btn" onclick="switchTab('export')"><span class="icon">üíæ</span><span>Export</span></button>
    </div>

    <!-- COMPOSE TAB -->
    <div class="tab-content active" id="compose-tab">
        <button class="big-generate-btn" onclick="aiGenerate('progression')">üéµ Generate AI Progression</button>
        
        <div class="ai-actions">
            <button class="ai-btn" onclick="aiGenerate('progression')">‚ú® AI Generate</button>
            <button class="ai-btn" onclick="aiGenerate('continue')">üîÆ Continue</button>
            <button class="ai-btn" onclick="aiGenerate('variation')">üé≤ Variation</button>
        </div>
        
        <!-- Metronome Panel -->
        <div class="metronome-panel">
            <div class="section-title">‚è±Ô∏è Metronome</div>
            <div class="metronome-display">
                <div class="metronome-visual" id="metronomeVisual">
                    <div class="metronome-pendulum" id="metronomePendulum"></div>
                </div>
                <div style="text-align:center;">
                    <div class="tempo-big" id="metronomeTempoValue">120</div>
                    <div class="tempo-label">BPM</div>
                </div>
            </div>
            <div class="beat-indicator" id="beatIndicator">
                <div class="beat-dot downbeat"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
            </div>
            <div class="metronome-controls">
                <button class="metro-btn" onclick="adjustMetronomeTempo(-5)">‚àí5</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(-1)">‚àí</button>
                <button class="metro-btn play" id="metronomePlayBtn" onclick="toggleMetronome()">‚ñ∂Ô∏è</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(1)">+</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(5)">+5</button>
            </div>
            <div class="time-sig-btns">
                <button class="time-sig-btn active" onclick="setTimeSignature(4, this)">4/4</button>
                <button class="time-sig-btn" onclick="setTimeSignature(3, this)">3/4</button>
                <button class="time-sig-btn" onclick="setTimeSignature(6, this)">6/8</button>
            </div>
        </div>
        
        <div class="mode-toggle">
            <button class="active" onclick="setMode('solo', this)">Solo</button>
            <button onclick="setMode('duo', this)">Duo</button>
            <button onclick="setMode('band', this)">Band</button>
            <button onclick="setMode('orchestra', this)">Orchestra</button>
        </div>
        
        <div class="current-sound" id="currentSound">üéπ Grand Piano</div>
        <div class="instrument-scroll" id="instrumentList"></div>
        
        <div class="controls-row">
            <div class="control-group">
                <div class="control-label">Key</div>
                <select class="control-select" id="keySelect" onchange="updateKey()">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Genre</div>
                <select class="control-select" id="genreSelect" onchange="updateGenre()">
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="blues">Blues</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="edm">EDM</option>
                    <option value="classical">Classical</option>
                </select>
            </div>
        </div>
        
        <div class="section-title">üé∂ Progression</div>
        <div class="chord-grid" id="chordGrid"></div>
    </div>

    <!-- AI STUDIO TAB -->
    <div class="tab-content" id="ai-tab">
        <div class="ai-studio-header">
            <div class="section-title">ü§ñ AI Studio <span class="ai-badge">Powered by Gemini</span></div>
            <p class="ai-subtitle">Advanced AI tools for music creation</p>
        </div>

        <!-- AI Melody Generator -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üéµ</span>
                <div>
                    <div class="ai-feature-title">Melody Generator</div>
                    <div class="ai-feature-desc">Create melodies that fit your chord progression</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="melodyStyle">
                    <option value="simple">Simple & Singable</option>
                    <option value="complex">Complex & Intricate</option>
                    <option value="jazzy">Jazzy Improv</option>
                    <option value="classical">Classical Motif</option>
                    <option value="catchy">Catchy Hook</option>
                </select>
                <select class="control-select" id="melodyRange">
                    <option value="low">Low Range</option>
                    <option value="mid" selected>Mid Range</option>
                    <option value="high">High Range</option>
                    <option value="wide">Wide Range</option>
                </select>
            </div>
            <button class="ai-generate-btn" onclick="generateMelody(this)">
                <span class="icon">‚ú®</span> Generate Melody
            </button>
            <div class="ai-result" id="melodyResult"></div>
        </div>

        <!-- AI Lyrics Writer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">‚úçÔ∏è</span>
                <div>
                    <div class="ai-feature-title">Lyrics Writer</div>
                    <div class="ai-feature-desc">Generate lyrics with themes and emotions</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="lyricsTheme">
                    <option value="love">Love & Romance</option>
                    <option value="heartbreak">Heartbreak</option>
                    <option value="party">Party & Fun</option>
                    <option value="inspiration">Inspiration</option>
                    <option value="nostalgia">Nostalgia</option>
                    <option value="nature">Nature & Peace</option>
                    <option value="rebellion">Rebellion</option>
                    <option value="journey">Life Journey</option>
                </select>
                <select class="control-select" id="lyricsMood">
                    <option value="happy">Happy</option>
                    <option value="sad">Sad</option>
                    <option value="energetic">Energetic</option>
                    <option value="chill">Chill</option>
                    <option value="dark">Dark</option>
                    <option value="hopeful">Hopeful</option>
                </select>
            </div>
            <input type="text" class="ai-input" id="lyricsKeywords" placeholder="Optional keywords (e.g., sunset, dreams, city)">
            <button class="ai-generate-btn" onclick="generateLyrics(this)">
                <span class="icon">‚ú®</span> Write Lyrics
            </button>
            <div class="ai-result lyrics-result" id="lyricsResult"></div>
        </div>

        <!-- AI Style Transfer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé≠</span>
                <div>
                    <div class="ai-feature-title">Style Transfer</div>
                    <div class="ai-feature-desc">Transform your progression to a new genre</div>
                </div>
            </div>
            <div class="style-grid">
                <button class="style-btn" onclick="transferStyle('jazz', this)">üé∑ Jazz</button>
                <button class="style-btn" onclick="transferStyle('classical', this)">üéª Classical</button>
                <button class="style-btn" onclick="transferStyle('edm', this)">üéß EDM</button>
                <button class="style-btn" onclick="transferStyle('rnb', this)">üé§ R&B</button>
                <button class="style-btn" onclick="transferStyle('country', this)">ü§† Country</button>
                <button class="style-btn" onclick="transferStyle('metal', this)">ü§ò Metal</button>
                <button class="style-btn" onclick="transferStyle('bossa', this)">üå¥ Bossa Nova</button>
                <button class="style-btn" onclick="transferStyle('gospel', this)">‚õ™ Gospel</button>
            </div>
            <div class="ai-result" id="styleResult"></div>
        </div>

        <!-- AI Chord Enhancer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üéπ</span>
                <div>
                    <div class="ai-feature-title">Chord Enhancer</div>
                    <div class="ai-feature-desc">Add extensions, substitutions, and color</div>
                </div>
            </div>
            <div class="enhance-grid">
                <button class="enhance-btn" onclick="enhanceChords('extensions', this)">‚ûï Add Extensions<br><small>7ths, 9ths, 11ths</small></button>
                <button class="enhance-btn" onclick="enhanceChords('substitutions', this)">üîÑ Substitutions<br><small>Tritone, relative</small></button>
                <button class="enhance-btn" onclick="enhanceChords('passing', this)">üö∂ Passing Chords<br><small>Chromatic movement</small></button>
                <button class="enhance-btn" onclick="enhanceChords('reharmonize', this)">üé® Reharmonize<br><small>New harmonic approach</small></button>
            </div>
            <div class="ai-result" id="enhanceResult"></div>
        </div>

        <!-- AI Song Structure -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé¨</span>
                <div>
                    <div class="ai-feature-title">Song Structure Generator</div>
                    <div class="ai-feature-desc">Create full song arrangements</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="structureType">
                    <option value="pop">Pop (Verse-Chorus-Verse)</option>
                    <option value="aaba">AABA (Jazz Standard)</option>
                    <option value="blues">12-Bar Blues</option>
                    <option value="edm">EDM (Build-Drop)</option>
                    <option value="ballad">Ballad (Intro-Verse-Bridge)</option>
                    <option value="progressive">Progressive (Through-composed)</option>
                </select>
            </div>
            <button class="ai-generate-btn" onclick="generateStructure(this)">
                <span class="icon">‚ú®</span> Generate Full Song
            </button>
            <div class="ai-result structure-result" id="structureResult"></div>
        </div>

        <!-- AI Analysis -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üîç</span>
                <div>
                    <div class="ai-feature-title">Progression Analysis</div>
                    <div class="ai-feature-desc">Understand your chord progression</div>
                </div>
            </div>
            <button class="ai-generate-btn analyze-btn" onclick="analyzeProgression(this)">
                <span class="icon">üî¨</span> Analyze My Progression
            </button>
            <div class="ai-result analysis-result" id="analysisResult"></div>
        </div>

        <!-- AI Surprise Me -->
        <div class="panel ai-panel surprise-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé≤</span>
                <div>
                    <div class="ai-feature-title">Surprise Me!</div>
                    <div class="ai-feature-desc">Let AI create something unexpected</div>
                </div>
            </div>
            <button class="ai-generate-btn surprise-btn" onclick="surpriseMe(this)">
                <span class="icon">üé∞</span> Generate Random Creation
            </button>
            <div class="ai-result" id="surpriseResult"></div>
        </div>
    </div>

    <!-- PIANO ROLL TAB -->
    <div class="tab-content" id="piano-tab">
        <div class="piano-roll-container">
            <div class="piano-roll-header">
                <div class="section-title">üéº Piano Roll Editor</div>
                <div class="piano-roll-controls">
                    <button class="pr-btn" onclick="clearPianoRoll()">Clear</button>
                    <button class="pr-btn" onclick="loadChordsToPianoRoll()">Load Chords</button>
                    <button class="pr-btn active" id="pianoSnapBtn" onclick="toggleSnap()">Snap</button>
                </div>
            </div>
            <div class="piano-roll" id="pianoRoll">
                <div class="piano-keys" id="pianoKeys"></div>
                <div class="piano-grid" id="pianoGrid">
                    <div class="piano-grid-inner" id="pianoGridInner"></div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">üéπ Quick Keys</div>
            <div class="instrument-scroll" id="quickPianoKeys"></div>
        </div>
    </div>

    <!-- MIXER TAB -->
    <div class="tab-content" id="mixer-tab">
        <div class="mixer-panel">
            <div class="section-title">üéöÔ∏è Channel Mixer</div>
            <div class="mixer-channels" id="mixerChannels"></div>
        </div>
        
        <div class="eq-section">
            <div class="eq-title">üìä Master EQ</div>
            <div class="eq-bands">
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('low', this.value)">
                    <div class="eq-label">Low</div>
                    <div class="eq-val" id="eqLow">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('lowMid', this.value)">
                    <div class="eq-label">Lo-Mid</div>
                    <div class="eq-val" id="eqLowMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('mid', this.value)">
                    <div class="eq-label">Mid</div>
                    <div class="eq-val" id="eqMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('highMid', this.value)">
                    <div class="eq-label">Hi-Mid</div>
                    <div class="eq-val" id="eqHighMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('high', this.value)">
                    <div class="eq-label">High</div>
                    <div class="eq-val" id="eqHigh">0dB</div>
                </div>
            </div>
        </div>
        
        <div class="comp-section">
            <div class="eq-title">üîä Compressor</div>
            <div class="comp-controls">
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 50%;" onclick="adjustCompressor('threshold')">
                        <div class="comp-knob-inner" id="compThreshold">-24</div>
                    </div>
                    <div class="comp-label">Threshold</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 30%;" onclick="adjustCompressor('ratio')">
                        <div class="comp-knob-inner" id="compRatio">4:1</div>
                    </div>
                    <div class="comp-label">Ratio</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 20%;" onclick="adjustCompressor('attack')">
                        <div class="comp-knob-inner" id="compAttack">10ms</div>
                    </div>
                    <div class="comp-label">Attack</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 40%;" onclick="adjustCompressor('release')">
                        <div class="comp-knob-inner" id="compRelease">100ms</div>
                    </div>
                    <div class="comp-label">Release</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SHEET MUSIC TAB -->
    <div class="tab-content" id="sheet-tab">
        <div class="sheet-panel">
            <div class="section-title">üìú Sheet Music Preview</div>
            <div class="sheet-preview" id="sheetPreview">
                <canvas id="sheetCanvas" width="600" height="200"></canvas>
            </div>
            
            <div class="sheet-btns">
                <button class="sheet-btn" onclick="exportSheetPDF()"><span class="icon">üìÑ</span><span>PDF</span></button>
                <button class="sheet-btn" onclick="exportSheetPNG()"><span class="icon">üñºÔ∏è</span><span>PNG</span></button>
                <button class="sheet-btn" onclick="printSheet()"><span class="icon">üñ®Ô∏è</span><span>Print</span></button>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">‚öôÔ∏è Options</div>
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">Display</div>
                    <select class="control-select" id="notationDisplay" onchange="renderSheetMusic()">
                        <option value="chords">Chord Symbols</option>
                        <option value="roman">Roman Numerals</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">Size</div>
                    <select class="control-select" id="notationSize" onchange="renderSheetMusic()">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT TAB -->
    <div class="tab-content" id="export-tab">
        <div class="export-panel">
            <div class="section-title">üì¶ Export Your Music</div>
            <div class="export-grid">
                <div class="export-card" onclick="exportMIDI()"><div class="icon">üéπ</div><div class="name">MIDI</div><div class="desc">For DAWs</div></div>
                <div class="export-card" onclick="exportWAV()"><div class="icon">üéµ</div><div class="name">WAV</div><div class="desc">Lossless</div></div>
                <div class="export-card" onclick="exportMP3()"><div class="icon">üìÑ</div><div class="name">MP3</div><div class="desc">Compressed</div></div>
                <div class="export-card" onclick="exportSheetPDF()"><div class="icon">üìú</div><div class="name">PDF</div><div class="desc">Sheet music</div></div>
            </div>
            <div class="export-progress" id="exportProgress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">Preparing...</div>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">üì§ Share</div>
            <div class="export-grid">
                <div class="export-card" onclick="shareSong()"><div class="icon">üîó</div><div class="name">Copy</div><div class="desc">To clipboard</div></div>
                <div class="export-card" onclick="shareNative()"><div class="icon">üì≤</div><div class="name">Share</div><div class="desc">Native</div></div>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Themes</div>
                <button class="close-btn" onclick="closeModal('themeModal')">‚úï</button>
            </div>
            <div class="theme-presets">
                <div class="theme-preset dark active" onclick="setTheme('dark', this)">üåô</div>
                <div class="theme-preset light" onclick="setTheme('light', this)">‚òÄÔ∏è</div>
                <div class="theme-preset midnight" onclick="setTheme('midnight', this)">üåå</div>
                <div class="theme-preset ocean" onclick="setTheme('ocean', this)">üåä</div>
                <div class="theme-preset forest" onclick="setTheme('forest', this)">üå≤</div>
                <div class="theme-preset sunset" onclick="setTheme('sunset', this)">üåÖ</div>
                <div class="theme-preset candy" onclick="setTheme('candy', this)">üç¨</div>
                <div class="theme-preset custom" onclick="setTheme('custom', this)">‚ú®</div>
            </div>
            <div class="color-section">
                <div class="section-title">üé® Custom Colors</div>
                <div class="color-pickers">
                    <div class="color-item"><span class="color-label">Background</span><input type="color" class="color-input" id="customBg" value="#0a0a0f" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Accent</span><input type="color" class="color-input" id="customAccent" value="#667eea" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Card</span><input type="color" class="color-input" id="customCard" value="#1a1a2e" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Text</span><input type="color" class="color-input" id="customText" value="#f1f5f9" onchange="updateCustomTheme()"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 12px 0;">
                <p style="color: var(--gold); font-weight:600; margin-bottom: 8px;">‚ú® ChordFlow v12.0 Pro Studio</p>
                <p style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                    üéº Piano Roll Editor<br>
                    üìú Sheet Music + PDF Export<br>
                    üéöÔ∏è Advanced Mixer & EQ<br>
                    ‚è±Ô∏è Visual Metronome<br>
                    üé® 8 Themes + Custom Colors<br>
                    üîä Compressor Controls<br>
                    üéπ MIDI/WAV/MP3 Export<br>
                    ü§ñ AI Chord Generation
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // STATE
        const state = {
            mode: 'solo', tempo: 120, key: 'C', genre: 'pop',
            isPlaying: false, progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano', instrumentName: 'üéπ Grand Piano',
            timeSignature: 4, metronomeActive: false, metronomeBeat: 0, metronomeInterval: null,
            mixerLevels: { main: 80, bass: 70, drums: 75, strings: 60 },
            eq: { low: 0, lowMid: 0, mid: 0, highMid: 0, high: 0 },
            compressor: { threshold: -24, ratio: 4, attack: 10, release: 100 },
            pianoRollNotes: [], pianoSnap: true, isExporting: false, currentTheme: 'dark',
            customColors: { bg: '#0a0a0f', accent: '#667eea', card: '#1a1a2e', text: '#f1f5f9' }
        };

        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ' },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ' },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è' },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß' },
            { id: 'acoustic-guitar', name: 'Acoustic', icon: 'üé∏' },
            { id: 'strings', name: 'Strings', icon: 'üéª' },
            { id: 'trumpet', name: 'Trumpet', icon: 'üé∫' },
            { id: 'saxophone', name: 'Saxophone', icon: 'üé∑' },
            { id: 'bell', name: 'Bell', icon: 'üîî' }
        ];

        const pianoNotes = ['C5', 'B4', 'A#4', 'A4', 'G#4', 'G4', 'F#4', 'F4', 'E4', 'D#4', 'D4', 'C#4', 'C4', 'B3'];
        const blackKeys = ['A#4', 'G#4', 'F#4', 'D#4', 'C#4'];

        // AUDIO
        let audioInit = false, mainSynth = null, bassSynth = null, metronomeClick = null, reverb = null, filter = null, eq3 = null, compressor = null;

        async function initAudio() {
            if (audioInit) return;
            await Tone.start();
            compressor = new Tone.Compressor({ threshold: -24, ratio: 4, attack: 0.01, release: 0.1 }).toDestination();
            eq3 = new Tone.EQ3({ low: 0, mid: 0, high: 0 }).connect(compressor);
            reverb = new Tone.Reverb({ decay: 2.5, wet: 0.25 }).connect(eq3);
            await reverb.generate();
            filter = new Tone.Filter({ frequency: 5000, type: 'lowpass' }).connect(reverb);
            mainSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, envelope: { attack: 0.005, decay: 1.2, sustain: 0.3, release: 1.8 } }).connect(filter);
            mainSynth.volume.value = -6;
            bassSynth = new Tone.MonoSynth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.4 } }).toDestination();
            bassSynth.volume.value = -8;
            metronomeClick = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            metronomeClick.volume.value = -10;
            audioInit = true;
        }

        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'], 'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'], 'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'], 'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'], 'Cmaj7': ['C4', 'E4', 'G4', 'B4'],
            'Dm7': ['D4', 'F4', 'A4', 'C5'], 'G7': ['G4', 'B4', 'D5', 'F5'], 'Am7': ['A4', 'C5', 'E5', 'G5']
        };
        const progressions = {
            pop: { C: ['C','G','Am','F'], G: ['G','D','Em','C'], Am: ['Am','F','C','G'] },
            rock: { C: ['C','F','G','C'], G: ['G','C','D','G'], Am: ['Am','G','F','E'] },
            jazz: { C: ['Cmaj7','Dm7','G7','Cmaj7'], Am: ['Am7','Dm7','G7','Cmaj7'] },
            blues: { C: ['C','C','F','C'], G: ['G','C','D','G'] },
            lofi: { C: ['Cmaj7','Am7','Dm7','G7'], Am: ['Am7','Dm7','Cmaj7','G7'] },
            edm: { C: ['C','G','Am','F'], Am: ['Am','F','C','G'] },
            classical: { C: ['C','G','Am','F','G','C'], Am: ['Am','Dm','E','Am'] }
        };
        const numerals = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bm': 'vii¬∞', 'Cmaj7': 'Imaj7', 'Dm7': 'ii7', 'G7': 'V7', 'Am7': 'vi7' };

        // METRONOME
        function toggleMetronome() {
            initAudio();
            state.metronomeActive = !state.metronomeActive;
            if (state.metronomeActive) { startMetronome(); document.getElementById('metronomeBtn').classList.add('metronome-active'); document.getElementById('metronomePlayBtn').textContent = '‚è∏Ô∏è'; }
            else { stopMetronome(); document.getElementById('metronomeBtn').classList.remove('metronome-active'); document.getElementById('metronomePlayBtn').textContent = '‚ñ∂Ô∏è'; }
        }
        function startMetronome() {
            const interval = 60000 / state.tempo;
            state.metronomeBeat = 0;
            playMetronomeTick();
            state.metronomeInterval = setInterval(playMetronomeTick, interval);
        }
        function stopMetronome() {
            if (state.metronomeInterval) { clearInterval(state.metronomeInterval); state.metronomeInterval = null; }
            document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
        }
        function playMetronomeTick() {
            if (metronomeClick) metronomeClick.triggerAttackRelease(state.metronomeBeat === 0 ? 'C5' : 'G4', '32n');
            const visual = document.getElementById('metronomeVisual');
            visual.classList.remove('tick', 'tock');
            visual.classList.add(state.metronomeBeat % 2 === 0 ? 'tick' : 'tock');
            document.querySelectorAll('.beat-dot').forEach((dot, i) => dot.classList.toggle('active', i === state.metronomeBeat));
            state.metronomeBeat = (state.metronomeBeat + 1) % state.timeSignature;
        }
        function adjustMetronomeTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('metronomeTempoValue').textContent = state.tempo;
            document.getElementById('tempoDisplay').textContent = state.tempo;
            if (state.metronomeActive) { stopMetronome(); startMetronome(); }
        }
        function setTimeSignature(beats, btn) {
            state.timeSignature = beats;
            document.querySelectorAll('.time-sig-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('beatIndicator').innerHTML = Array(beats).fill(0).map((_, i) => `<div class="beat-dot ${i === 0 ? 'downbeat' : ''}"></div>`).join('');
            if (state.metronomeActive) { stopMetronome(); state.metronomeBeat = 0; startMetronome(); }
            showToast(`Time: ${beats}/4`);
        }

        // MIXER
        function renderMixer() {
            const channels = [{ id: 'main', name: 'Main', icon: 'üéπ', level: 80 }, { id: 'bass', name: 'Bass', icon: 'üé∏', level: 70 }, { id: 'drums', name: 'Drums', icon: 'ü•Å', level: 75 }, { id: 'strings', name: 'Strings', icon: 'üéª', level: 60 }];
            document.getElementById('mixerChannels').innerHTML = channels.map(ch => `
                <div class="mixer-channel">
                    <div class="mixer-icon">${ch.icon}</div>
                    <div class="mixer-name">${ch.name}</div>
                    <div class="mixer-fader-wrap"><input type="range" class="mixer-fader" min="0" max="100" value="${ch.level}" orient="vertical" oninput="setMixerLevel('${ch.id}', this.value, this)"></div>
                    <div class="mixer-value">${ch.level}%</div>
                </div>
            `).join('');
        }
        function setMixerLevel(channel, value, el) {
            state.mixerLevels[channel] = parseInt(value);
            if (channel === 'main' && mainSynth) mainSynth.volume.value = -30 + (value * 0.3);
            el.parentElement.nextElementSibling.textContent = value + '%';
        }
        function updateEQ(band, value) {
            state.eq[band] = parseInt(value);
            document.getElementById(`eq${band.charAt(0).toUpperCase() + band.slice(1).replace('Mid', 'Mid')}`).textContent = value + 'dB';
            if (eq3) { if (band === 'low') eq3.low.value = value; else if (band === 'mid') eq3.mid.value = value; else if (band === 'high') eq3.high.value = value; }
        }
        function adjustCompressor(param) {
            const presets = { threshold: [-12, -18, -24, -30, -36], ratio: [2, 4, 8, 12, 20], attack: [1, 5, 10, 20, 50], release: [50, 100, 200, 500, 1000] };
            const values = presets[param];
            const idx = (values.indexOf(state.compressor[param]) + 1) % values.length;
            state.compressor[param] = values[idx];
            const display = param === 'ratio' ? `${values[idx]}:1` : param === 'threshold' ? values[idx] : `${values[idx]}ms`;
            document.getElementById(`comp${param.charAt(0).toUpperCase() + param.slice(1)}`).textContent = display;
            showToast(`${param}: ${display}`);
        }

        // PIANO ROLL
        function renderPianoRoll() {
            const beats = 16;
            document.getElementById('pianoKeys').innerHTML = pianoNotes.map(note => `<div class="piano-key ${blackKeys.includes(note) ? 'black' : 'white'}" onclick="playPianoKey('${note}')">${note}</div>`).join('');
            document.getElementById('pianoGridInner').innerHTML = pianoNotes.map(note => `<div class="piano-row ${blackKeys.includes(note) ? 'black-row' : ''}">${Array(beats).fill(0).map((_, col) => `<div class="piano-cell ${col % 4 === 0 ? 'beat-start' : ''}" data-note="${note}" data-beat="${col}" onclick="togglePianoCell(this, '${note}', ${col})"></div>`).join('')}</div>`).join('');
        }
        function playPianoKey(note) { initAudio().then(() => { if (mainSynth) mainSynth.triggerAttackRelease(note, '8n'); }); }
        function togglePianoCell(cell, note, beat) { cell.classList.toggle('active'); if (cell.classList.contains('active')) playPianoKey(note); }
        function clearPianoRoll() { document.querySelectorAll('.piano-cell.active').forEach(c => c.classList.remove('active')); showToast('Piano roll cleared'); }
        function loadChordsToPianoRoll() {
            clearPianoRoll();
            state.progression.forEach((chord, chordIdx) => {
                const notes = chordNotes[chord] || ['C4', 'E4', 'G4'];
                notes.forEach(note => { const cell = document.querySelector(`.piano-cell[data-note="${note}"][data-beat="${chordIdx * 4}"]`); if (cell) cell.classList.add('active'); });
            });
            showToast('Chords loaded');
        }
        function toggleSnap() { state.pianoSnap = !state.pianoSnap; document.getElementById('pianoSnapBtn').classList.toggle('active', state.pianoSnap); showToast(`Snap: ${state.pianoSnap ? 'ON' : 'OFF'}`); }
        function renderQuickPianoKeys() {
            const quickNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
            document.getElementById('quickPianoKeys').innerHTML = quickNotes.map(note => `<div class="instrument-card" onclick="playPianoKey('${note}')"><div class="icon">üéπ</div><div class="name">${note}</div></div>`).join('');
        }

        // SHEET MUSIC - Canvas Rendering
        function renderSheetMusic() {
            const canvas = document.getElementById('sheetCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const display = document.getElementById('notationDisplay')?.value || 'chords';
            const size = document.getElementById('notationSize')?.value || 'medium';
            const sizeMap = { small: 16, medium: 22, large: 28 };
            const fontSize = sizeMap[size];
            
            // Set canvas size based on container
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth - 40 || 560;
            canvas.height = 180;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw staff lines
            const staffY = 90;
            const lineSpacing = 10;
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(20, staffY + i * lineSpacing);
                ctx.lineTo(canvas.width - 20, staffY + i * lineSpacing);
                ctx.stroke();
            }
            
            // Draw treble clef
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 60px serif';
            ctx.fillText('ùÑû', 25, staffY + 38);
            
            // Draw time signature
            ctx.font = 'bold 24px Arial';
            ctx.fillText(state.timeSignature.toString(), 80, staffY + 15);
            ctx.fillText('4', 80, staffY + 38);
            
            // Draw bar line after time signature
            ctx.beginPath();
            ctx.moveTo(105, staffY);
            ctx.lineTo(105, staffY + 40);
            ctx.stroke();
            
            // Draw chord symbols
            const startX = 120;
            const chordSpacing = (canvas.width - startX - 40) / state.progression.length;
            
            ctx.font = `bold ${fontSize}px Arial`;
            state.progression.forEach((chord, i) => {
                const x = startX + i * chordSpacing + chordSpacing / 2;
                const roman = numerals[chord] || '';
                
                // Draw chord name above staff
                ctx.fillStyle = '#1a1a2e';
                if (display === 'chords' || display === 'both') {
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(chord, x, staffY - 20);
                }
                
                // Draw roman numeral
                if (display === 'roman' || display === 'both') {
                    ctx.font = `${fontSize - 6}px Arial`;
                    ctx.fillStyle = '#666666';
                    const romanY = display === 'both' ? staffY - 5 : staffY - 20;
                    ctx.fillText(roman, x, romanY);
                }
                
                // Draw whole note on staff
                ctx.fillStyle = '#333333';
                ctx.beginPath();
                ctx.ellipse(x, staffY + 20, 8, 6, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Draw bar line after each chord (except last)
                if (i < state.progression.length - 1) {
                    ctx.beginPath();
                    ctx.moveTo(x + chordSpacing / 2 - 10, staffY);
                    ctx.lineTo(x + chordSpacing / 2 - 10, staffY + 40);
                    ctx.stroke();
                }
            });
            
            // Draw final double bar line
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(canvas.width - 30, staffY);
            ctx.lineTo(canvas.width - 30, staffY + 40);
            ctx.stroke();
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(canvas.width - 25, staffY);
            ctx.lineTo(canvas.width - 25, staffY + 40);
            ctx.stroke();
            
            // Draw title
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Key: ${state.key} | ${state.genre.charAt(0).toUpperCase() + state.genre.slice(1)} | ${state.tempo} BPM`, 20, 25);
        }
        
        function exportSheetPNG() {
            const canvas = document.getElementById('sheetCanvas');
            if (!canvas) { showToast('‚ùå Canvas not found'); return; }
            const link = document.createElement('a');
            link.download = `ChordFlow_${state.key}_${state.genre}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('üñºÔ∏è PNG downloaded!');
        }
        async function exportSheetPDF() {
            showToast('Generating PDF...');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(24); doc.text('ChordFlow', 105, 20, { align: 'center' });
                doc.setFontSize(14); doc.text(`Key: ${state.key} | Genre: ${state.genre} | Tempo: ${state.tempo} BPM`, 105, 30, { align: 'center' });
                const staffY = 60; doc.setLineWidth(0.3);
                for (let i = 0; i < 5; i++) doc.line(20, staffY + i * 6, 190, staffY + i * 6);
                doc.setFontSize(40); doc.text('G', 25, staffY + 20);
                doc.setFontSize(20); doc.text(state.timeSignature.toString(), 45, staffY + 10); doc.text('4', 45, staffY + 22);
                doc.setFontSize(18); let x = 65;
                state.progression.forEach(chord => { doc.text(chord, x, staffY - 10); doc.setFontSize(12); doc.text(numerals[chord] || '', x, staffY - 2); doc.setFontSize(18); x += 30; });
                doc.setFontSize(10); doc.text('Generated by ChordFlow v12.0', 105, 280, { align: 'center' });
                doc.save(`ChordFlow_${state.key}_${state.genre}.pdf`);
                showToast('üìÑ PDF downloaded!');
            } catch (err) { showToast('‚ùå PDF export failed'); }
        }
        function printSheet() { window.print(); showToast('üñ®Ô∏è Print dialog opened'); }

        // THEMES
        function setTheme(theme, btn) {
            document.body.classList.remove('theme-light', 'theme-midnight', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-candy', 'theme-custom');
            document.querySelectorAll('.theme-preset').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            if (theme !== 'dark' && theme !== 'custom') document.body.classList.add(`theme-${theme}`);
            else if (theme === 'custom') applyCustomTheme();
            state.currentTheme = theme;
            localStorage.setItem('chordflow-theme', theme);
            showToast(`Theme: ${theme}`);
        }
        function updateCustomTheme() {
            state.customColors = { bg: document.getElementById('customBg').value, accent: document.getElementById('customAccent').value, card: document.getElementById('customCard').value, text: document.getElementById('customText').value };
            if (state.currentTheme === 'custom') applyCustomTheme();
            localStorage.setItem('chordflow-custom-colors', JSON.stringify(state.customColors));
        }
        function applyCustomTheme() {
            document.body.classList.add('theme-custom');
            document.documentElement.style.setProperty('--bg-primary', state.customColors.bg);
            document.documentElement.style.setProperty('--accent', state.customColors.accent);
            document.documentElement.style.setProperty('--bg-card', state.customColors.card);
            document.documentElement.style.setProperty('--text-primary', state.customColors.text);
        }

        // PLAYBACK
        let playLoop = null, currentChordIndex = 0;
        async function togglePlayback() { await initAudio(); if (state.isPlaying) stopPlayback(); else startPlayback(); }
        function startPlayback() {
            state.isPlaying = true; document.getElementById('playBtn').textContent = '‚è∏Ô∏è'; currentChordIndex = 0;
            playCurrentChord(); playLoop = setInterval(() => { currentChordIndex = (currentChordIndex + 1) % state.progression.length; playCurrentChord(); }, (60 / state.tempo) * 2 * 1000);
        }
        function stopPlayback() {
            state.isPlaying = false; document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            if (playLoop) { clearInterval(playLoop); playLoop = null; }
            if (mainSynth && mainSynth.releaseAll) mainSynth.releaseAll();
            document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            document.getElementById('nowPlaying').textContent = 'Ready to jam';
        }
        function playCurrentChord() {
            const chord = state.progression[currentChordIndex];
            const notes = chordNotes[chord] || chordNotes['C'];
            if (mainSynth) { if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttack(notes); }
            if ((state.mode === 'band' || state.mode === 'orchestra') && bassSynth) bassSynth.triggerAttackRelease(notes[0].replace('4', '2').replace('5', '3'), '2n');
            document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.getElementById('nowPlaying').textContent = `Playing: ${chord}`;
        }
        function playChord(chord, index) {
            initAudio().then(() => {
                const notes = chordNotes[chord] || chordNotes['C'];
                if (mainSynth) { if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttackRelease(notes, '1n'); }
                document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === index));
                setTimeout(() => document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing')), 500);
            });
        }
        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            document.getElementById('metronomeTempoValue').textContent = state.tempo;
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
            if (state.metronomeActive) { stopMetronome(); startMetronome(); }
        }

        // UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            if (tabId === 'sheet') setTimeout(renderSheetMusic, 50);
        }
        function setMode(mode, btn) {
            state.mode = mode;
            document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updatePlaybackInfo(); updateActiveInstruments();
            showToast(`${mode.charAt(0).toUpperCase() + mode.slice(1)} mode`);
        }
        function selectInstrument(id, name, icon) {
            state.currentInstrument = id; state.instrumentName = `${icon} ${name}`;
            document.getElementById('currentSound').textContent = state.instrumentName;
            document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.instrument-card').classList.add('active');
            updateActiveInstruments(); showToast(state.instrumentName);
        }
        function updateKey() { state.key = document.getElementById('keySelect').value; generateProgression(); }
        function updateGenre() { state.genre = document.getElementById('genreSelect').value; generateProgression(); }
        function generateProgression() {
            const genreProgs = progressions[state.genre] || progressions.pop;
            state.progression = genreProgs[state.key] || genreProgs['C'] || ['C', 'G', 'Am', 'F'];
            renderChords(); updatePlaybackInfo(); renderSheetMusic();
        }
        function renderChords() { document.getElementById('chordGrid').innerHTML = state.progression.map((chord, i) => `<div class="chord-card" onclick="playChord('${chord}', ${i})"><div class="chord-name">${chord}</div><div class="chord-numeral">${numerals[chord] || ''}</div></div>`).join(''); }
        function renderInstruments() { document.getElementById('instrumentList').innerHTML = instruments.map(inst => `<div class="instrument-card ${inst.id === state.currentInstrument ? 'active' : ''}" onclick="selectInstrument('${inst.id}', '${inst.name}', '${inst.icon}')"><div class="icon">${inst.icon}</div><div class="name">${inst.name}</div></div>`).join(''); }
        function updatePlaybackInfo() { document.getElementById('playbackSub').textContent = `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${state.mode.charAt(0).toUpperCase() + state.mode.slice(1)}`; }
        function updateActiveInstruments() {
            let html = `<div class="active-inst"><span class="dot" style="background: var(--keys)"></span> ${state.instrumentName.replace(/^./, '')}</div>`;
            if (state.mode === 'band' || state.mode === 'orchestra') { html += '<div class="active-inst"><span class="dot" style="background: var(--bass)"></span> Bass</div><div class="active-inst"><span class="dot" style="background: var(--drums)"></span> Drums</div>'; }
            document.getElementById('activeInstruments').innerHTML = html;
        }

        // EXPORT
        const noteToMidi = { 'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11 };
        function noteNameToMidi(n) { const m = n.match(/([A-G][#b]?)(\d)/); return m ? noteToMidi[m[1]] + (parseInt(m[2]) + 1) * 12 : 60; }
        function writeVarLength(v) { const r = [v & 0x7F]; v >>= 7; while (v > 0) { r.unshift((v & 0x7F) | 0x80); v >>= 7; } return r; }
        function createMIDIFile() {
            const tpb = 480, header = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (tpb >> 8) & 0xFF, tpb & 0xFF];
            let td = []; const mpb = Math.round(60000000 / state.tempo);
            td.push(0, 0xFF, 0x51, 3, (mpb >> 16) & 0xFF, (mpb >> 8) & 0xFF, mpb & 0xFF);
            state.progression.forEach(chord => {
                const notes = chordNotes[chord] || chordNotes['C'];
                notes.forEach((n, i) => td.push(...writeVarLength(i === 0 ? 0 : 0), 0x90, noteNameToMidi(n), 100));
                notes.forEach((n, i) => td.push(...writeVarLength(i === 0 ? tpb * 2 : 0), 0x80, noteNameToMidi(n), 0));
            });
            td.push(0, 0xFF, 0x2F, 0);
            return new Uint8Array([...header, 0x4D, 0x54, 0x72, 0x6B, (td.length >> 24) & 0xFF, (td.length >> 16) & 0xFF, (td.length >> 8) & 0xFF, td.length & 0xFF, ...td]);
        }
        async function exportMIDI() {
            if (state.isExporting) return; state.isExporting = true;
            showExportProgress('Generating MIDI...');
            await updateProgress(50, 'Creating MIDI...'); const midi = createMIDIFile();
            await updateProgress(100, 'Complete!');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([midi], { type: 'audio/midi' }));
            a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.mid`; a.click();
            showToast('üéπ MIDI downloaded!'); hideExportProgress(); state.isExporting = false;
        }
        async function exportWAV() {
            if (state.isExporting) return; state.isExporting = true;
            showExportProgress('Recording audio...'); await initAudio();
            const dest = Tone.context.createMediaStreamDestination();
            const recorder = new MediaRecorder(dest.stream, { mimeType: 'audio/webm' });
            const chunks = []; recorder.ondataavailable = e => chunks.push(e.data);
            mainSynth.connect(dest); recorder.start();
            const mspc = (60000 / state.tempo) * 2;
            for (let i = 0; i < state.progression.length; i++) {
                await updateProgress(20 + (i / state.progression.length) * 60, `Recording: ${state.progression[i]}`);
                const notes = chordNotes[state.progression[i]] || chordNotes['C'];
                if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttack(notes);
                await new Promise(r => setTimeout(r, mspc - 100)); if (mainSynth.releaseAll) mainSynth.releaseAll(); await new Promise(r => setTimeout(r, 100));
            }
            await new Promise(res => { recorder.onstop = res; recorder.stop(); });
            await updateProgress(100, 'Complete!');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, { type: 'audio/webm' }));
            a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.webm`; a.click();
            mainSynth.disconnect(dest); mainSynth.connect(filter);
            showToast('üéµ Audio downloaded!'); hideExportProgress(); state.isExporting = false;
        }
        async function exportMP3() { await exportWAV(); }
        function showExportProgress(text) { document.getElementById('exportProgress').classList.add('active'); document.getElementById('progressText').textContent = text; document.getElementById('progressFill').style.width = '0%'; }
        function hideExportProgress() { setTimeout(() => document.getElementById('exportProgress').classList.remove('active'), 1000); }
        async function updateProgress(pct, text) { document.getElementById('progressFill').style.width = pct + '%'; document.getElementById('progressText').textContent = text; await new Promise(r => setTimeout(r, 100)); }
        function shareSong() { navigator.clipboard.writeText(`üéµ ChordFlow\nKey: ${state.key}\nGenre: ${state.genre}\nChords: ${state.progression.join(' ‚Üí ')}\n${window.location.href}`).then(() => showToast('üìã Copied!')); }
        function shareNative() { if (navigator.share) navigator.share({ title: 'ChordFlow', text: `Chord progression: ${state.progression.join(' ‚Üí ')}`, url: window.location.href }); else shareSong(); }

        // AI
        async function aiGenerate(type) {
            const btn = event?.target?.closest('.ai-btn') || event?.target?.closest('.big-generate-btn');
            if (btn) btn.classList.add('loading');
            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: `Generate a ${state.genre} chord progression in ${state.key}. Return ONLY a JSON array like ["C", "G", "Am", "F"].`, action: type }) });
                const data = await res.json();
                if (data.result) { const m = data.result.match(/\[[\s\S]*?\]/); if (m) { const chords = JSON.parse(m[0]).filter(c => chordNotes[c]); if (chords.length) { state.progression = chords; renderChords(); renderSheetMusic(); showToast('‚ú® AI generated!'); } } }
            } catch (err) { generateProgression(); showToast('üé≤ Random progression'); }
            if (btn) btn.classList.remove('loading');
        }

        // ADVANCED AI FEATURES
        const GEMINI_KEY = 'AIzaSyBR1mD1zdnn39IbaQQs99mL5nFxsoNB9dM';
        
        async function callGeminiAI(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.9, maxOutputTokens: 1024 } })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (err) {
                console.error('Gemini error:', err);
                return null;
            }
        }

        async function generateMelody(btn) {
            btn.classList.add('loading');
            const style = document.getElementById('melodyStyle').value;
            const range = document.getElementById('melodyRange').value;
            const prompt = `You are a music composition AI. Generate a melody for these chords: ${state.progression.join(' - ')} in ${state.key} ${state.genre}.
Style: ${style}, Range: ${range}.
Return ONLY a JSON object like: {"notes": ["C4", "E4", "G4", "E4", "D4", "C4"], "rhythm": ["quarter", "quarter", "half", "quarter", "quarter", "whole"], "description": "A simple ascending melody"}
Use standard note names with octave numbers (C4 is middle C). Keep it 8-16 notes.`;
            
            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('melodyResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const melody = JSON.parse(jsonMatch[0]);
                        state.generatedMelody = melody;
                        let html = `<span class="result-title">üéµ Generated Melody</span>`;
                        html += `<div style="margin: 8px 0;">${melody.notes.map(n => `<span class="melody-note">${n}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px;">${melody.description || 'AI-generated melody'}</div>`;
                        html += `<button onclick="playMelody()" style="margin-top: 10px; padding: 8px 16px; background: var(--success); border: none; border-radius: 8px; color: white; cursor: pointer;">‚ñ∂Ô∏è Play Melody</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üéµ Melody generated!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üéµ Melody Suggestion</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallbackMelody = generateFallbackMelody();
                resultDiv.innerHTML = `<span class="result-title">üéµ Generated Melody</span>\n${fallbackMelody.map(n => `<span class="melody-note">${n}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackMelody() {
            const scaleNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
            const melody = [];
            for (let i = 0; i < 8; i++) {
                melody.push(scaleNotes[Math.floor(Math.random() * scaleNotes.length)]);
            }
            state.generatedMelody = { notes: melody };
            return melody;
        }

        async function playMelody() {
            if (!state.generatedMelody?.notes) return;
            await initAudio();
            const now = Tone.now();
            state.generatedMelody.notes.forEach((note, i) => {
                mainSynth.triggerAttackRelease(note, '8n', now + i * 0.3);
            });
            showToast('üéµ Playing melody...');
        }

        async function generateLyrics(btn) {
            btn.classList.add('loading');
            const theme = document.getElementById('lyricsTheme').value;
            const mood = document.getElementById('lyricsMood').value;
            const keywords = document.getElementById('lyricsKeywords').value;
            
            const prompt = `You are a professional songwriter. Write lyrics for a ${state.genre} song.
Theme: ${theme}, Mood: ${mood}
Chord progression: ${state.progression.join(' - ')} in ${state.key}
${keywords ? `Include these concepts: ${keywords}` : ''}

Write a verse and chorus. Format:
[Verse]
(4 lines)

[Chorus]
(4 lines)

Make it emotional, poetic, and fitting for the ${state.genre} genre. Keep lines short and singable.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('lyricsResult');
            
            if (result) {
                state.generatedLyrics = result;
                resultDiv.innerHTML = `<span class="result-title">‚úçÔ∏è Generated Lyrics</span>\n${result}`;
                resultDiv.classList.add('active');
                showToast('‚úçÔ∏è Lyrics written!');
            } else {
                const fallback = generateFallbackLyrics(theme, mood);
                resultDiv.innerHTML = `<span class="result-title">‚úçÔ∏è Generated Lyrics</span>\n${fallback}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackLyrics(theme, mood) {
            const templates = {
                love: `[Verse]\nIn your eyes I see the stars tonight\nEvery moment feels so right\nHolding on to what we've found\nLove that keeps us on the ground\n\n[Chorus]\nYou're the one I've waited for\nOpen up another door\nTogether we will find our way\nStarting from today`,
                heartbreak: `[Verse]\nEmpty rooms and memories\nFading photos on the wall\nI remember how we used to be\nBefore the silence took it all\n\n[Chorus]\nNow I'm learning how to breathe\nWithout you here with me\nPicking up the pieces of my heart\nMaking a brand new start`,
                party: `[Verse]\nLights are flashing, bass is pumping\nEverybody's jumping high\nFeeling like we own the night\nReaching for the sky\n\n[Chorus]\nLet's go, let's go, let's go tonight\nEverything's gonna be alright\nDance until the morning light\nWe're feeling so alive`
            };
            return templates[theme] || templates.love;
        }

        async function transferStyle(targetGenre, btn) {
            document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('loading'));
            btn.classList.add('loading');
            
            const prompt = `You are a music theory expert. Transform this chord progression from ${state.genre} to ${targetGenre}:
Current: ${state.progression.join(' - ')} in ${state.key}

Return ONLY a JSON object like: {"chords": ["Cmaj7", "G7", "Am9", "Fmaj7"], "explanation": "Added jazz extensions"}
Use chords that exist in standard notation. Keep similar harmonic function but with ${targetGenre} flavor.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('styleResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const transfer = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üé≠ ${targetGenre.toUpperCase()} Style</span>\n`;
                        html += `<div style="margin: 8px 0;">${transfer.chords.map(c => `<span class="chord-tag" onclick="applyTransferChords(['${transfer.chords.join("','")}'])">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${transfer.explanation || ''}</div>`;
                        html += `<button onclick="applyTransferChords(['${transfer.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer;">‚úÖ Apply These Chords</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast(`üé≠ ${targetGenre} style ready!`);
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé≠ Style Transfer</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallback = generateStyleFallback(targetGenre);
                resultDiv.innerHTML = `<span class="result-title">üé≠ ${targetGenre.toUpperCase()} Style</span>\n${fallback.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function applyTransferChords(chords) {
            const validChords = chords.filter(c => {
                const base = c.replace(/maj7|m7|7|9|11|13|dim|aug|sus[24]?|add\d+/gi, '').replace(/[#b]$/, '');
                return ['C','D','E','F','G','A','B'].includes(base.charAt(0).toUpperCase());
            });
            if (validChords.length > 0) {
                state.progression = validChords;
                renderChords();
                renderSheetMusic();
                showToast('‚úÖ Chords applied!');
            }
        }

        function generateStyleFallback(genre) {
            const styles = {
                jazz: ['Cmaj7', 'Am7', 'Dm7', 'G7'],
                classical: ['C', 'F', 'G', 'C'],
                edm: ['Am', 'F', 'C', 'G'],
                rnb: ['Fmaj7', 'Em7', 'Dm7', 'Cmaj7'],
                country: ['G', 'C', 'D', 'G'],
                metal: ['E5', 'C5', 'G5', 'D5'],
                bossa: ['Dm7', 'G7', 'Cmaj7', 'A7'],
                gospel: ['C', 'C/E', 'F', 'G']
            };
            return styles[genre] || ['C', 'G', 'Am', 'F'];
        }

        async function enhanceChords(enhanceType, btn) {
            document.querySelectorAll('.enhance-btn').forEach(b => b.classList.remove('loading'));
            btn.classList.add('loading');
            
            const prompts = {
                extensions: `Add 7ths, 9ths, or other extensions to: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": ["Cmaj7", "G9", "Am7", "Fmaj9"], "explanation": "..."}`,
                substitutions: `Apply tritone or relative substitutions to: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`,
                passing: `Add chromatic passing chords between: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`,
                reharmonize: `Completely reharmonize with different approach: ${state.progression.join(' - ')} in ${state.key}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`
            };

            const result = await callGeminiAI(prompts[enhanceType]);
            const resultDiv = document.getElementById('enhanceResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const enhanced = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üéπ Enhanced Chords</span>\n`;
                        html += `<div style="margin: 8px 0;">${enhanced.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${enhanced.explanation || ''}</div>`;
                        html += `<button onclick="applyTransferChords(['${enhanced.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer;">‚úÖ Apply Enhanced Chords</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üéπ Chords enhanced!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üéπ Enhancement</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallback = enhanceFallback(enhanceType);
                resultDiv.innerHTML = `<span class="result-title">üéπ Enhanced</span>\n${fallback.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function enhanceFallback(type) {
            const base = state.progression.map(c => c.replace(/[0-9]/g, ''));
            if (type === 'extensions') return base.map(c => c + (c.includes('m') ? '7' : 'maj7'));
            if (type === 'substitutions') return base.map((c, i) => i === 1 ? 'Dm7' : c);
            return base;
        }

        async function generateStructure(btn) {
            btn.classList.add('loading');
            const structureType = document.getElementById('structureType').value;
            
            const prompt = `You are a professional songwriter. Create a complete ${structureType} song structure using this progression: ${state.progression.join(' - ')} in ${state.key} ${state.genre}.

Return a JSON object like:
{
  "structure": [
    {"section": "Intro", "chords": ["C", "Am"], "bars": 4},
    {"section": "Verse 1", "chords": ["C", "G", "Am", "F"], "bars": 8},
    {"section": "Chorus", "chords": ["F", "G", "C", "Am"], "bars": 8}
  ],
  "tips": "Build energy through the verse into the chorus"
}

Create a realistic song structure with Intro, Verses, Chorus, Bridge as appropriate for ${structureType}.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('structureResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const structure = JSON.parse(jsonMatch[0]);
                        state.songStructure = structure;
                        let html = `<span class="result-title">üé¨ Song Structure</span>\n\n`;
                        structure.structure.forEach(section => {
                            html += `<div style="margin-bottom: 12px;"><span class="section-label">${section.section}</span> (${section.bars} bars)\n`;
                            html += section.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ');
                            html += `</div>`;
                        });
                        if (structure.tips) html += `\n<div style="color: var(--text-secondary); font-size: 12px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 8px;">üí° ${structure.tips}</div>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üé¨ Song structure created!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé¨ Structure</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                resultDiv.innerHTML = generateFallbackStructure(structureType);
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackStructure(type) {
            const p = state.progression;
            return `<span class="result-title">üé¨ ${type.toUpperCase()} Structure</span>\n\n` +
                `<span class="section-label">Intro</span> ${p.slice(0,2).join(' ')} (4 bars)\n` +
                `<span class="section-label">Verse</span> ${p.join(' ')} (8 bars)\n` +
                `<span class="section-label">Chorus</span> ${[...p].reverse().join(' ')} (8 bars)\n` +
                `<span class="section-label">Outro</span> ${p[0]} (4 bars)`;
        }

        async function analyzeProgression(btn) {
            btn.classList.add('loading');
            
            const prompt = `You are a music theory expert. Analyze this chord progression in detail:
Chords: ${state.progression.join(' - ')}
Key: ${state.key}
Genre: ${state.genre}

Provide analysis in this JSON format:
{
  "romanNumerals": "I - V - vi - IV",
  "key": "C Major",
  "mood": "Uplifting and nostalgic",
  "famousUsage": ["Let It Be - Beatles", "No Woman No Cry - Bob Marley"],
  "characteristics": ["Strong resolution", "Emotional minor chord"],
  "suggestions": "Try adding a vi before the IV for more tension"
}`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('analysisResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const analysis = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üîç Progression Analysis</span>\n\n`;
                        html += `<div class="analysis-item"><span class="analysis-label">Roman Numerals:</span> ${analysis.romanNumerals}</div>`;
                        html += `<div class="analysis-item"><span class="analysis-label">Key:</span> ${analysis.key}</div>`;
                        html += `<div class="analysis-item"><span class="analysis-label">Mood:</span> ${analysis.mood}</div>`;
                        if (analysis.famousUsage?.length) html += `<div class="analysis-item"><span class="analysis-label">Famous Songs:</span> ${analysis.famousUsage.join(', ')}</div>`;
                        if (analysis.characteristics?.length) html += `<div class="analysis-item"><span class="analysis-label">Characteristics:</span> ${analysis.characteristics.join(', ')}</div>`;
                        if (analysis.suggestions) html += `<div class="analysis-item"><span class="analysis-label">üí° Suggestion:</span> ${analysis.suggestions}</div>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üîç Analysis complete!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üîç Analysis</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                resultDiv.innerHTML = generateFallbackAnalysis();
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackAnalysis() {
            const romanMap = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bdim': 'vii¬∞' };
            const romans = state.progression.map(c => romanMap[c] || '?').join(' - ');
            return `<span class="result-title">üîç Analysis</span>\n\n` +
                `<div class="analysis-item"><span class="analysis-label">Roman Numerals:</span> ${romans}</div>` +
                `<div class="analysis-item"><span class="analysis-label">Key:</span> ${state.key}</div>` +
                `<div class="analysis-item"><span class="analysis-label">Chords:</span> ${state.progression.length} total</div>`;
        }

        async function surpriseMe(btn) {
            btn.classList.add('loading');
            
            const surprises = [
                `Generate a unique, unexpected ${state.genre} chord progression that sounds fresh. Return JSON: {"chords": [...], "name": "Surprise name", "description": "Why it's interesting"}`,
                `Create a chord progression that combines ${state.genre} with jazz elements. Return JSON: {"chords": [...], "name": "...", "description": "..."}`,
                `Generate a progression using unusual chord voicings for ${state.genre}. Return JSON: {"chords": [...], "name": "...", "description": "..."}`,
                `Create a progression with an unexpected twist or modulation. Return JSON: {"chords": [...], "name": "...", "description": "..."}`
            ];
            
            const prompt = surprises[Math.floor(Math.random() * surprises.length)];
            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('surpriseResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const surprise = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üé≤ ${surprise.name || 'Surprise!'}</span>\n`;
                        html += `<div style="margin: 8px 0;">${surprise.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${surprise.description || 'Try something new!'}</div>`;
                        html += `<button onclick="applyTransferChords(['${surprise.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--warning); border: none; border-radius: 8px; color: #000; cursor: pointer; font-weight: 700;">üé∞ Use This Progression</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üé≤ Surprise ready!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé≤ Surprise</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const surprise = ['Dm7', 'G7', 'Cmaj7', 'A7b9'];
                resultDiv.innerHTML = `<span class="result-title">üé≤ Jazz Surprise!</span>\n${surprise.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        // MODALS & TOAST
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // INIT
        function init() {
            renderInstruments(); generateProgression(); renderMixer(); renderPianoRoll(); renderQuickPianoKeys(); setTimeout(renderSheetMusic, 100);
            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme && savedTheme !== 'dark') document.body.classList.add(`theme-${savedTheme}`);
            const savedColors = localStorage.getItem('chordflow-custom-colors');
            if (savedColors) { state.customColors = JSON.parse(savedColors); document.getElementById('customBg').value = state.customColors.bg; document.getElementById('customAccent').value = state.customColors.accent; document.getElementById('customCard').value = state.customColors.card; document.getElementById('customText').value = state.customColors.text; }
            console.log('üéµ ChordFlow v12.2 AI Studio initialized');
        }
        init();
    </script>
</body>
</html>
