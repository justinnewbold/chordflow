<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordFlow Pro v4.0 - AI-Powered Chord Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #8b5cf6; --secondary: #06b6d4; --accent: #f59e0b; }
        [data-theme="dark"] {
            --bg: #0f0f23; --surface: #1a1a2e; --card: #16213e;
            --text: #e2e8f0; --muted: #94a3b8; --border: #334155;
        }
        [data-theme="light"] {
            --bg: #f8fafc; --surface: #ffffff; --card: #f1f5f9;
            --text: #1e293b; --muted: #64748b; --border: #e2e8f0;
        }
        * { font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; }
        .glass { background: var(--surface); border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
        .btn { transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139,92,246,0.3); }
        .chord-card { cursor: grab; transition: all 0.3s; }
        .chord-card:hover { transform: scale(1.02); border-color: var(--primary); }
        .chord-card.dragging { opacity: 0.5; cursor: grabbing; }
        .chord-card.playing { animation: pulse 0.5s ease-in-out; border-color: var(--accent); }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .recording { animation: recordPulse 1s infinite; }
        @keyframes recordPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .piano-key { transition: all 0.1s; }
        .piano-key.active { background: var(--primary) !important; }
        .tab-btn.active { background: var(--primary); color: white; }
        select, input { background: var(--surface); color: var(--text); border-color: var(--border); }
        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.1s; }
        .cloud-indicator { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .bass-note { font-family: monospace; font-size: 14px; }
        .mode-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .analysis-tooltip { position: absolute; background: var(--card); padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .gemini-glow { animation: geminiGlow 2s ease-in-out infinite; }
        @keyframes geminiGlow { 0%,100% { box-shadow: 0 0 5px rgba(139,92,246,0.3); } 50% { box-shadow: 0 0 20px rgba(139,92,246,0.6); } }
    </style>
</head>
<body>
    <!-- Cloud Sync Indicator -->
    <div id="cloudStatus" class="cloud-indicator hidden">
        <div class="glass px-4 py-2 rounded-full flex items-center gap-2">
            <span id="cloudIcon">‚òÅÔ∏è</span>
            <span id="cloudText" class="text-sm">Synced</span>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-cyan-400 bg-clip-text text-transparent">üéµ ChordFlow Pro</h1>
                <span class="text-xs px-2 py-1 rounded-full bg-gradient-to-r from-purple-500 to-cyan-500 text-white font-medium">v4.0</span>
                <span class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    <span id="aiStatusText">Gemini AI</span>
                </span>
            </div>
            <div class="flex items-center gap-3">
                <button id="cloudLoginBtn" onclick="toggleCloudSync()" class="btn px-4 py-2 rounded-lg bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 flex items-center gap-2">
                    <span>‚òÅÔ∏è</span> <span id="cloudBtnText">Cloud Sync</span>
                </button>
                <button onclick="toggleTheme()" class="btn p-2 rounded-lg bg-white/5 hover:bg-white/10">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 space-y-6">
        <!-- Controls Panel -->
        <div class="glass rounded-2xl p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Genre</label>
                    <select id="genre" onchange="generateProgression()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="pop">üé§ Pop</option>
                        <option value="rock">üé∏ Rock</option>
                        <option value="jazz">üé∑ Jazz</option>
                        <option value="blues">üé∫ Blues</option>
                        <option value="rnb">üéπ R&B</option>
                        <option value="edm">üéß EDM</option>
                        <option value="country">ü§† Country</option>
                        <option value="folk">ü™ï Folk</option>
                        <option value="classical">üéª Classical</option>
                        <option value="hiphop">üé§ Hip-Hop</option>
                        <option value="latin">üíÉ Latin</option>
                        <option value="gospel">‚õ™ Gospel</option>
                        <option value="metal">ü§ò Metal</option>
                        <option value="lofi">üåô Lo-Fi</option>
                        <option value="cinematic">üé¨ Cinematic</option>
                        <option value="neosoul">‚ú® Neo-Soul</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Key</label>
                    <select id="key" onchange="generateProgression()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="C">C</option><option value="C#">C#/Db</option>
                        <option value="D">D</option><option value="D#">D#/Eb</option>
                        <option value="E">E</option><option value="F">F</option>
                        <option value="F#">F#/Gb</option><option value="G">G</option>
                        <option value="G#">G#/Ab</option><option value="A">A</option>
                        <option value="A#">A#/Bb</option><option value="B">B</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Scale/Mode</label>
                    <select id="scale" onchange="generateProgression()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="major">Major (Ionian)</option>
                        <option value="minor">Minor (Aeolian)</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="locrian">Locrian</option>
                        <option value="harmonicMinor">Harmonic Minor</option>
                        <option value="melodicMinor">Melodic Minor</option>
                        <option value="pentatonicMajor">Pentatonic Major</option>
                        <option value="pentatonicMinor">Pentatonic Minor</option>
                        <option value="blues">Blues Scale</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Tempo</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="tempo" min="40" max="200" value="120" oninput="updateTempo()" class="flex-1">
                        <span id="tempoValue" class="text-sm w-12">120</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Instrument</label>
                    <select id="instrument" onchange="changeInstrument()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="synth">üéπ Synth</option>
                        <option value="piano">üéπ Piano</option>
                        <option value="acoustic">üé∏ Acoustic</option>
                        <option value="organ">üéπ Organ</option>
                        <option value="strings">üéª Strings</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Capo</label>
                    <select id="capo" onchange="updateDisplay()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="0">No Capo</option>
                        <option value="1">Capo 1</option>
                        <option value="2">Capo 2</option>
                        <option value="3">Capo 3</option>
                        <option value="4">Capo 4</option>
                        <option value="5">Capo 5</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Chords</label>
                    <select id="chordCount" onchange="generateProgression()" class="w-full px-3 py-2 rounded-lg border">
                        <option value="4">4 Chords</option>
                        <option value="6">6 Chords</option>
                        <option value="8">8 Chords</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Loop</label>
                    <button id="loopBtn" onclick="toggleLoop()" class="w-full px-3 py-2 rounded-lg border bg-transparent hover:bg-white/5">
                        üîÅ Off
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>

        <!-- Main Grid -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Chord Display -->
            <div class="lg:col-span-2 space-y-4">
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="generateProgression()" class="btn px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium">üé≤ Generate</button>
                    <button onclick="playProgression()" class="btn px-4 py-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white font-medium">‚ñ∂Ô∏è Play</button>
                    <button onclick="stopPlayback()" class="btn px-4 py-2 rounded-lg bg-red-500/20 text-red-300 hover:bg-red-500/30">‚èπÔ∏è Stop</button>
                    <button onclick="aiContinue()" class="btn px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-medium gemini-glow">ü§ñ AI Continue</button>
                    <button onclick="aiAnalyze()" class="btn px-4 py-2 rounded-lg bg-purple-500/20 text-purple-300 hover:bg-purple-500/30">üß† AI Analyze</button>
                    <button onclick="toggleRecording()" id="recordBtn" class="btn px-4 py-2 rounded-lg bg-orange-500/20 text-orange-300 hover:bg-orange-500/30">üî¥ Record</button>
                    <button onclick="saveToCloud()" class="btn px-4 py-2 rounded-lg bg-blue-500/20 text-blue-300 hover:bg-blue-500/30">‚òÅÔ∏è Save</button>
                </div>

                <!-- Chord Cards -->
                <div id="chordContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Chords will be rendered here -->
                </div>

                <!-- Bass Line Display -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-2 flex items-center gap-2">
                        <span>üé∏ Bass Line</span>
                        <button onclick="regenerateBass()" class="text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-300 hover:bg-purple-500/30">Regenerate</button>
                    </h3>
                    <div id="bassLineDisplay" class="bass-note text-cyan-400 whitespace-pre-wrap"></div>
                </div>

                <!-- Tab View Selector -->
                <div class="flex gap-2 mb-4">
                    <button onclick="setView('guitar')" class="tab-btn px-4 py-2 rounded-lg active" data-view="guitar">üé∏ Guitar</button>
                    <button onclick="setView('ukulele')" class="tab-btn px-4 py-2 rounded-lg" data-view="ukulele">ü™ï Ukulele</button>
                    <button onclick="setView('piano')" class="tab-btn px-4 py-2 rounded-lg" data-view="piano">üéπ Piano</button>
                    <button onclick="setView('tab')" class="tab-btn px-4 py-2 rounded-lg" data-view="tab">üìù Tab</button>
                </div>

                <!-- Instrument Display -->
                <div id="instrumentDisplay" class="card p-4 min-h-[200px]">
                    <!-- Instrument diagrams render here -->
                </div>

                <!-- Piano Roll -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">üéπ Piano Roll</h3>
                    <div id="pianoRoll" class="flex justify-center">
                        <!-- Piano keys render here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-4">
                <!-- AI Analysis Panel -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
                        <span>üß† AI Analysis</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-gradient-to-r from-purple-500 to-cyan-500 text-white">Gemini</span>
                    </h3>
                    <div id="aiAnalysisPanel" class="text-sm space-y-2">
                        <p class="text-gray-400">Generate a progression to see AI analysis...</p>
                    </div>
                </div>

                <!-- Theory Analysis -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">üìö Music Theory</h3>
                    <div id="theoryAnalysis" class="text-sm space-y-2">
                        <p class="text-gray-400">Generate a progression to see analysis...</p>
                    </div>
                </div>

                <!-- Song Sections -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">üéº Song Section</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setSection('intro')" class="px-3 py-2 rounded-lg bg-purple-500/20 text-purple-300 text-sm hover:bg-purple-500/30">Intro</button>
                        <button onclick="setSection('verse')" class="px-3 py-2 rounded-lg bg-blue-500/20 text-blue-300 text-sm hover:bg-blue-500/30">Verse</button>
                        <button onclick="setSection('chorus')" class="px-3 py-2 rounded-lg bg-pink-500/20 text-pink-300 text-sm hover:bg-pink-500/30">Chorus</button>
                        <button onclick="setSection('bridge')" class="px-3 py-2 rounded-lg bg-cyan-500/20 text-cyan-300 text-sm hover:bg-cyan-500/30">Bridge</button>
                        <button onclick="setSection('outro')" class="px-3 py-2 rounded-lg bg-orange-500/20 text-orange-300 text-sm hover:bg-orange-500/30">Outro</button>
                        <button onclick="setSection('prechorus')" class="px-3 py-2 rounded-lg bg-green-500/20 text-green-300 text-sm hover:bg-green-500/30">Pre-Chorus</button>
                    </div>
                    <p id="currentSection" class="mt-2 text-sm text-gray-400">Current: <span class="text-white">Verse</span></p>
                </div>

                <!-- Lyrics Editor -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">‚úçÔ∏è Lyrics</h3>
                    <textarea id="lyricsEditor" placeholder="Write your lyrics here..." class="w-full h-32 bg-transparent border border-gray-600 rounded-lg p-3 text-sm resize-none focus:border-purple-500 focus:outline-none"></textarea>
                </div>

                <!-- Export Options -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">üíæ Export</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportMIDI()" class="btn px-3 py-2 rounded-lg bg-purple-500/20 text-purple-300 text-sm hover:bg-purple-500/30">üìÅ MIDI</button>
                        <button onclick="exportPDF()" class="btn px-3 py-2 rounded-lg bg-red-500/20 text-red-300 text-sm hover:bg-red-500/30">üìÑ PDF</button>
                        <button onclick="exportAudio()" class="btn px-3 py-2 rounded-lg bg-green-500/20 text-green-300 text-sm hover:bg-green-500/30">üéµ Audio</button>
                        <button onclick="exportTab()" class="btn px-3 py-2 rounded-lg bg-cyan-500/20 text-cyan-300 text-sm hover:bg-cyan-500/30">üìù Tab</button>
                        <button onclick="copyToClipboard()" class="btn px-3 py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm hover:bg-yellow-500/30">üìã Copy</button>
                        <button onclick="shareURL()" class="btn px-3 py-2 rounded-lg bg-pink-500/20 text-pink-300 text-sm hover:bg-pink-500/30">üîó Share</button>
                    </div>
                </div>

                <!-- History -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">üìú History</h3>
                    <div id="historyList" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- History items render here -->
                    </div>
                </div>

                <!-- Cloud Progressions -->
                <div class="card p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
                        <span>‚òÅÔ∏è Cloud Library</span>
                        <button onclick="loadCloudProgressions()" class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30">Refresh</button>
                    </h3>
                    <div id="cloudList" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-gray-400 text-sm">Connect to cloud to see saved progressions</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // =============================================
        // CONFIGURATION & STATE
        // =============================================
        const SUPABASE_URL = 'https://mupqfsxpppobihdbpocr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cHFmc3hwcHBvYmloZGJwb2NyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5MDg1MDcsImV4cCI6MjA1MDQ4NDUwN30.X5hHl_YOgTTmn0G3qqLvMqvnHi7yjsXAf8LKZ3D0Wlo';
        const GEMINI_API_KEY = 'AIzaSyDK7nXB51ZmdrOUw69nKD0zIEPrugHzftw';

        let supabase = null;
        let currentUser = null;
        let cloudSyncEnabled = false;

        let state = {
            progression: [],
            bassLine: [],
            currentChordIndex: -1,
            isPlaying: false,
            isLooping: false,
            isRecording: false,
            tempo: 120,
            currentView: 'guitar',
            currentSection: 'verse',
            history: JSON.parse(localStorage.getItem('chordflow_history') || '[]'),
            theme: localStorage.getItem('chordflow_theme') || 'dark',
            mediaRecorder: null,
            audioChunks: []
        };

        // Initialize Tone.js
        let synth = new Tone.PolySynth(Tone.Synth).toDestination();
        let bassSynth = new Tone.MonoSynth({
            oscillator: { type: 'triangle' },
            envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.8 }
        }).toDestination();
        bassSynth.volume.value = -6;

        // =============================================
        // MUSIC THEORY DATA
        // =============================================
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const scaleIntervals = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            melodicMinor: [0, 2, 3, 5, 7, 9, 11],
            pentatonicMajor: [0, 2, 4, 7, 9],
            pentatonicMinor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10]
        };

        const scaleQualities = {
            major: ['', 'm', 'm', '', '', 'm', 'dim'],
            minor: ['m', 'dim', '', 'm', 'm', '', ''],
            dorian: ['m', 'm', '', '', 'm', 'dim', ''],
            phrygian: ['m', '', '', 'm', 'dim', '', 'm'],
            lydian: ['', '', 'm', 'dim', '', 'm', 'm'],
            mixolydian: ['', 'm', 'dim', '', 'm', 'm', ''],
            locrian: ['dim', '', 'm', 'm', '', '', 'm'],
            harmonicMinor: ['m', 'dim', 'aug', 'm', '', '', 'dim'],
            melodicMinor: ['m', 'm', 'aug', '', '', 'dim', 'dim'],
            pentatonicMajor: ['', 'm', 'm', '', 'm'],
            pentatonicMinor: ['m', '', '', 'm', ''],
            blues: ['7', 'm', '', '7', '7', 'm']
        };

        const romanNumerals = {
            major: ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'],
            minor: ['i', 'ii¬∞', 'III', 'iv', 'v', 'VI', 'VII'],
            dorian: ['i', 'ii', 'III', 'IV', 'v', 'vi¬∞', 'VII'],
            phrygian: ['i', 'II', 'III', 'iv', 'v¬∞', 'VI', 'vii'],
            lydian: ['I', 'II', 'iii', '#iv¬∞', 'V', 'vi', 'vii'],
            mixolydian: ['I', 'ii', 'iii¬∞', 'IV', 'v', 'vi', 'VII'],
            locrian: ['i¬∞', 'II', 'iii', 'iv', 'V', 'VI', 'vii'],
            harmonicMinor: ['i', 'ii¬∞', 'III+', 'iv', 'V', 'VI', 'vii¬∞'],
            melodicMinor: ['i', 'ii', 'III+', 'IV', 'V', 'vi¬∞', 'vii¬∞'],
            pentatonicMajor: ['I', 'ii', 'iii', 'V', 'vi'],
            pentatonicMinor: ['i', 'III', 'IV', 'v', 'VII'],
            blues: ['I7', 'ii', 'III', 'IV7', 'V7', 'vi']
        };

        const chordFunctions = {
            'I': { name: 'Tonic', function: 'Home/Resolution', tension: 'Low', color: '#22c55e' },
            'i': { name: 'Tonic', function: 'Home/Resolution', tension: 'Low', color: '#22c55e' },
            'ii': { name: 'Supertonic', function: 'Pre-Dominant', tension: 'Medium', color: '#f59e0b' },
            'ii¬∞': { name: 'Supertonic', function: 'Pre-Dominant', tension: 'Medium-High', color: '#f59e0b' },
            'II': { name: 'Supertonic', function: 'Pre-Dominant', tension: 'Medium', color: '#f59e0b' },
            'iii': { name: 'Mediant', function: 'Tonic Substitute', tension: 'Low-Medium', color: '#3b82f6' },
            'III': { name: 'Mediant', function: 'Tonic Substitute', tension: 'Low-Medium', color: '#3b82f6' },
            'III+': { name: 'Augmented Mediant', function: 'Tension', tension: 'High', color: '#ef4444' },
            'IV': { name: 'Subdominant', function: 'Pre-Dominant', tension: 'Medium', color: '#f59e0b' },
            'iv': { name: 'Subdominant', function: 'Pre-Dominant', tension: 'Medium', color: '#f59e0b' },
            '#iv¬∞': { name: 'Raised Subdominant', function: 'Passing', tension: 'High', color: '#ef4444' },
            'V': { name: 'Dominant', function: 'Creates Tension', tension: 'High', color: '#ef4444' },
            'v': { name: 'Minor Dominant', function: 'Weak Tension', tension: 'Medium', color: '#f59e0b' },
            'v¬∞': { name: 'Diminished Dominant', function: 'Tension', tension: 'High', color: '#ef4444' },
            'vi': { name: 'Submediant', function: 'Tonic Substitute', tension: 'Low-Medium', color: '#3b82f6' },
            'VI': { name: 'Submediant', function: 'Tonic Substitute', tension: 'Low-Medium', color: '#3b82f6' },
            'vi¬∞': { name: 'Diminished Submediant', function: 'Passing', tension: 'High', color: '#ef4444' },
            'vii¬∞': { name: 'Leading Tone', function: 'Dominant Substitute', tension: 'Very High', color: '#dc2626' },
            'VII': { name: 'Subtonic', function: 'Passing', tension: 'Medium', color: '#f59e0b' },
            'vii': { name: 'Subtonic', function: 'Passing', tension: 'Medium', color: '#f59e0b' },
            'i¬∞': { name: 'Diminished Tonic', function: 'Unstable', tension: 'Very High', color: '#dc2626' }
        };

        const genreProgressions = {
            pop: [[0, 4, 5, 3], [0, 5, 3, 4], [0, 3, 4, 4], [5, 3, 0, 4]],
            rock: [[0, 3, 4, 4], [0, 4, 0, 4], [0, 6, 3, 4], [0, 5, 6, 4]],
            jazz: [[1, 4, 0, 0], [0, 5, 1, 4], [2, 5, 0, 3], [0, 6, 1, 4]],
            blues: [[0, 0, 3, 3], [4, 4, 0, 0], [0, 3, 0, 4], [0, 0, 0, 4]],
            rnb: [[0, 5, 3, 4], [1, 4, 0, 0], [5, 3, 0, 0], [0, 2, 3, 4]],
            edm: [[0, 4, 5, 3], [5, 3, 0, 4], [0, 0, 4, 4], [5, 5, 0, 3]],
            country: [[0, 4, 0, 4], [0, 3, 4, 0], [0, 0, 3, 4], [4, 0, 4, 0]],
            folk: [[0, 3, 0, 4], [0, 5, 4, 0], [0, 2, 3, 0], [0, 4, 5, 3]],
            classical: [[0, 3, 4, 0], [0, 4, 1, 4], [0, 5, 1, 0], [3, 0, 4, 0]],
            hiphop: [[5, 3, 0, 0], [0, 5, 0, 3], [5, 0, 3, 4], [0, 5, 3, 0]],
            latin: [[0, 3, 4, 4], [0, 4, 5, 0], [0, 3, 0, 4], [5, 0, 5, 0]],
            gospel: [[0, 3, 4, 0], [0, 4, 1, 4], [0, 2, 5, 0], [3, 5, 0, 4]],
            metal: [[0, 6, 5, 4], [0, 5, 6, 0], [0, 4, 5, 6], [0, 3, 0, 6]],
            lofi: [[1, 4, 0, 5], [0, 5, 2, 3], [5, 0, 3, 2], [0, 2, 5, 3]],
            cinematic: [[0, 3, 5, 4], [0, 5, 3, 0], [5, 0, 3, 4], [0, 3, 0, 5]],
            neosoul: [[1, 4, 0, 5], [0, 5, 2, 4], [5, 2, 3, 0], [0, 2, 5, 3]]
        };

        // =============================================
        // GUITAR CHORD DIAGRAMS (Extended)
        // =============================================
        const guitarChords = {
            'C': { frets: [0, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0], barre: 0 },
            'C#': { frets: [1, 4, 3, 1, 2, 1], fingers: [1, 4, 3, 1, 2, 1], barre: 1 },
            'D': { frets: [-1, 0, 0, 2, 3, 2], fingers: [0, 0, 0, 1, 3, 2], barre: 0 },
            'D#': { frets: [-1, 1, 1, 3, 4, 3], fingers: [0, 1, 1, 3, 4, 3], barre: 1 },
            'E': { frets: [0, 2, 2, 1, 0, 0], fingers: [0, 2, 3, 1, 0, 0], barre: 0 },
            'F': { frets: [1, 3, 3, 2, 1, 1], fingers: [1, 3, 4, 2, 1, 1], barre: 1 },
            'F#': { frets: [2, 4, 4, 3, 2, 2], fingers: [1, 3, 4, 2, 1, 1], barre: 2 },
            'G': { frets: [3, 2, 0, 0, 0, 3], fingers: [2, 1, 0, 0, 0, 3], barre: 0 },
            'G#': { frets: [4, 3, 1, 1, 1, 4], fingers: [3, 2, 1, 1, 1, 4], barre: 1 },
            'A': { frets: [0, 0, 2, 2, 2, 0], fingers: [0, 0, 1, 2, 3, 0], barre: 0 },
            'A#': { frets: [1, 1, 3, 3, 3, 1], fingers: [1, 1, 2, 3, 4, 1], barre: 1 },
            'B': { frets: [2, 2, 4, 4, 4, 2], fingers: [1, 1, 2, 3, 4, 1], barre: 2 },
            'Cm': { frets: [3, 3, 5, 5, 4, 3], fingers: [1, 1, 3, 4, 2, 1], barre: 3 },
            'C#m': { frets: [4, 4, 6, 6, 5, 4], fingers: [1, 1, 3, 4, 2, 1], barre: 4 },
            'Dm': { frets: [-1, 0, 0, 2, 3, 1], fingers: [0, 0, 0, 2, 3, 1], barre: 0 },
            'D#m': { frets: [-1, 1, 1, 3, 4, 2], fingers: [0, 1, 1, 3, 4, 2], barre: 1 },
            'Em': { frets: [0, 2, 2, 0, 0, 0], fingers: [0, 2, 3, 0, 0, 0], barre: 0 },
            'Fm': { frets: [1, 3, 3, 1, 1, 1], fingers: [1, 3, 4, 1, 1, 1], barre: 1 },
            'F#m': { frets: [2, 4, 4, 2, 2, 2], fingers: [1, 3, 4, 1, 1, 1], barre: 2 },
            'Gm': { frets: [3, 5, 5, 3, 3, 3], fingers: [1, 3, 4, 1, 1, 1], barre: 3 },
            'G#m': { frets: [4, 6, 6, 4, 4, 4], fingers: [1, 3, 4, 1, 1, 1], barre: 4 },
            'Am': { frets: [0, 0, 2, 2, 1, 0], fingers: [0, 0, 2, 3, 1, 0], barre: 0 },
            'A#m': { frets: [1, 1, 3, 3, 2, 1], fingers: [1, 1, 3, 4, 2, 1], barre: 1 },
            'Bm': { frets: [2, 2, 4, 4, 3, 2], fingers: [1, 1, 3, 4, 2, 1], barre: 2 },
            'Cdim': { frets: [-1, 3, 4, 2, 4, -1], fingers: [0, 2, 3, 1, 4, 0], barre: 0 },
            'Ddim': { frets: [-1, 0, 1, 2, 1, -1], fingers: [0, 0, 1, 3, 2, 0], barre: 0 },
            'Edim': { frets: [0, 1, 2, 0, 2, 0], fingers: [0, 1, 2, 0, 3, 0], barre: 0 },
            'Fdim': { frets: [1, 2, 3, 1, 3, 1], fingers: [1, 2, 3, 1, 4, 1], barre: 1 },
            'Gdim': { frets: [3, 4, 5, 3, 5, 3], fingers: [1, 2, 3, 1, 4, 1], barre: 3 },
            'Adim': { frets: [-1, 0, 1, 2, 1, -1], fingers: [0, 0, 1, 3, 2, 0], barre: 0 },
            'Bdim': { frets: [-1, 2, 3, 4, 3, -1], fingers: [0, 1, 2, 4, 3, 0], barre: 0 },
            'C7': { frets: [0, 3, 2, 3, 1, 0], fingers: [0, 3, 2, 4, 1, 0], barre: 0 },
            'D7': { frets: [-1, 0, 0, 2, 1, 2], fingers: [0, 0, 0, 2, 1, 3], barre: 0 },
            'E7': { frets: [0, 2, 0, 1, 0, 0], fingers: [0, 2, 0, 1, 0, 0], barre: 0 },
            'F7': { frets: [1, 3, 1, 2, 1, 1], fingers: [1, 3, 1, 2, 1, 1], barre: 1 },
            'G7': { frets: [3, 2, 0, 0, 0, 1], fingers: [3, 2, 0, 0, 0, 1], barre: 0 },
            'A7': { frets: [0, 0, 2, 0, 2, 0], fingers: [0, 0, 2, 0, 3, 0], barre: 0 },
            'B7': { frets: [-1, 2, 1, 2, 0, 2], fingers: [0, 2, 1, 3, 0, 4], barre: 0 },
            'Caug': { frets: [-1, 3, 2, 1, 1, 0], fingers: [0, 4, 3, 1, 2, 0], barre: 0 },
            'Eaug': { frets: [0, 3, 2, 1, 1, 0], fingers: [0, 4, 3, 1, 2, 0], barre: 0 },
            'Gaug': { frets: [3, 2, 1, 0, 0, 3], fingers: [3, 2, 1, 0, 0, 4], barre: 0 }
        };

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initSupabase();
            generateProgression();
            renderPianoRoll();
            loadHistory();
            checkURLParams();
        });

        function initTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            document.getElementById('themeIcon').textContent = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('chordflow_theme', state.theme);
            initTheme();
        }

        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    cloudSyncEnabled = true;
                    updateCloudUI(true);
                    loadCloudProgressions();
                }
            } catch (e) {
                console.log('Supabase init skipped:', e);
            }
        }

        async function toggleCloudSync() {
            if (cloudSyncEnabled) {
                await supabase.auth.signOut();
                currentUser = null;
                cloudSyncEnabled = false;
                updateCloudUI(false);
                showToast('Signed out from cloud');
            } else {
                const email = prompt('Enter email for cloud sync:');
                if (!email) return;
                const { error } = await supabase.auth.signInWithOtp({ email });
                if (error) {
                    showToast('Error: ' + error.message);
                } else {
                    showToast('Check your email for login link!');
                }
            }
        }

        function updateCloudUI(connected) {
            const btn = document.getElementById('cloudLoginBtn');
            const btnText = document.getElementById('cloudBtnText');
            const status = document.getElementById('cloudStatus');
            
            if (connected) {
                btnText.textContent = 'Connected';
                btn.classList.add('bg-green-500/20', 'text-green-300');
                btn.classList.remove('bg-purple-500/20', 'text-purple-300');
                status.classList.remove('hidden');
            } else {
                btnText.textContent = 'Cloud Sync';
                btn.classList.remove('bg-green-500/20', 'text-green-300');
                btn.classList.add('bg-purple-500/20', 'text-purple-300');
                status.classList.add('hidden');
            }
        }

        // =============================================
        // CHORD GENERATION
        // =============================================
        function generateProgression() {
            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            const genre = document.getElementById('genre').value;
            const count = parseInt(document.getElementById('chordCount').value);

            const keyIndex = notes.indexOf(key);
            const intervals = scaleIntervals[scale];
            const qualities = scaleQualities[scale];
            const numerals = romanNumerals[scale];

            // Get genre-specific progression pattern
            const patterns = genreProgressions[genre] || genreProgressions.pop;
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];

            // Build progression
            state.progression = [];
            for (let i = 0; i < count; i++) {
                const degreeIndex = pattern[i % pattern.length];
                const actualDegree = degreeIndex % intervals.length;
                const noteIndex = (keyIndex + intervals[actualDegree]) % 12;
                const note = notes[noteIndex];
                const quality = qualities[actualDegree] || '';
                const roman = numerals[actualDegree] || 'I';

                state.progression.push({
                    name: note + quality,
                    root: note,
                    quality: quality,
                    roman: roman,
                    degree: actualDegree + 1,
                    interval: intervals[actualDegree]
                });
            }

            // Generate bass line
            generateBassLine();
            
            // Update displays
            renderChords();
            updateInstrumentDisplay();
            updateTheoryAnalysis();
            addToHistory();
            
            showToast('Generated ' + genre + ' progression in ' + key + ' ' + scale);
        }

        function generateBassLine() {
            state.bassLine = state.progression.map((chord, i) => {
                const root = chord.root;
                const patterns = [
                    [root, root, root, root],
                    [root, notes[(notes.indexOf(root) + 7) % 12], root, notes[(notes.indexOf(root) + 5) % 12]],
                    [root, root, notes[(notes.indexOf(root) + 7) % 12], root],
                    [root, notes[(notes.indexOf(root) + 4) % 12], notes[(notes.indexOf(root) + 7) % 12], root]
                ];
                return patterns[Math.floor(Math.random() * patterns.length)];
            });
            renderBassLine();
        }

        function regenerateBass() {
            generateBassLine();
            showToast('Bass line regenerated');
        }

        function renderBassLine() {
            const container = document.getElementById('bassLineDisplay');
            let bassText = 'e|' + '-'.repeat(state.progression.length * 8) + '|\n';
            bassText += 'B|' + '-'.repeat(state.progression.length * 8) + '|\n';
            bassText += 'G|' + '-'.repeat(state.progression.length * 8) + '|\n';
            bassText += 'D|' + '-'.repeat(state.progression.length * 8) + '|\n';
            
            let aString = 'A|';
            let eString = 'E|';
            
            state.bassLine.forEach((pattern, i) => {
                pattern.forEach((note, j) => {
                    const fret = notes.indexOf(note);
                    if (fret <= 4) {
                        eString += fret.toString().padEnd(2, '-');
                        aString += '--';
                    } else {
                        aString += (fret - 5).toString().padEnd(2, '-');
                        eString += '--';
                    }
                });
            });
            
            bassText += aString + '|\n' + eString + '|';
            container.textContent = bassText;
        }

        // =============================================
        // AI FEATURES
        // =============================================
        async function aiContinue() {
            const aiStatus = document.getElementById('aiStatusText');
            aiStatus.textContent = 'Thinking...';
            
            const currentChords = state.progression.map(c => c.name).join(' ‚Üí ');
            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            
            const prompt = `As a music theory expert, suggest the next 2 chords to continue this progression in ${key} ${scale}:
Current: ${currentChords}

Respond with ONLY the chord names separated by comma, like: Am, G
No explanation, just the chords.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 50 }
                    })
                });

                const data = await response.json();
                const suggestion = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'C, G';
                
                // Parse suggestions and add to progression
                const newChords = suggestion.split(',').map(c => c.trim()).slice(0, 2);
                newChords.forEach(chordName => {
                    const root = chordName.replace(/m|dim|aug|7|maj7|min7/g, '');
                    const quality = chordName.replace(root, '');
                    state.progression.push({
                        name: chordName,
                        root: root,
                        quality: quality,
                        roman: '?',
                        degree: 0,
                        interval: 0,
                        aiGenerated: true
                    });
                });

                generateBassLine();
                renderChords();
                updateInstrumentDisplay();
                aiStatus.textContent = 'Gemini AI';
                showToast('AI added: ' + newChords.join(', '));
            } catch (error) {
                console.error('AI Error:', error);
                aiStatus.textContent = 'AI Error';
                showToast('AI suggestion failed');
                
                // Fallback suggestion
                const fallbacks = ['Am', 'G', 'F', 'Em', 'Dm'];
                const randomChord = fallbacks[Math.floor(Math.random() * fallbacks.length)];
                state.progression.push({
                    name: randomChord,
                    root: randomChord.replace(/m/g, ''),
                    quality: randomChord.includes('m') ? 'm' : '',
                    roman: '?',
                    degree: 0,
                    interval: 0
                });
                renderChords();
            }
        }

        async function aiAnalyze() {
            const panel = document.getElementById('aiAnalysisPanel');
            panel.innerHTML = '<p class="text-cyan-400 animate-pulse">ü§ñ Analyzing with Gemini AI...</p>';
            
            const chords = state.progression.map(c => c.name).join(' ‚Üí ');
            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            const genre = document.getElementById('genre').value;

            const prompt = `Analyze this chord progression briefly (3-4 sentences max):
Key: ${key} ${scale}
Genre: ${genre}
Progression: ${chords}

Cover: emotional feel, tension/resolution, and one similar famous song. Be concise.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 200 }
                    })
                });

                const data = await response.json();
                const analysis = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Analysis unavailable';
                
                panel.innerHTML = `
                    <div class="space-y-2">
                        <p class="text-sm leading-relaxed">${analysis}</p>
                        <p class="text-xs text-gray-500 mt-2">Powered by Gemini AI</p>
                    </div>
                `;
            } catch (error) {
                panel.innerHTML = '<p class="text-red-400">Analysis failed. Try again.</p>';
            }
        }

        // =============================================
        // CHORD RENDERING
        // =============================================
        function renderChords() {
            const container = document.getElementById('chordContainer');
            container.innerHTML = '';

            state.progression.forEach((chord, index) => {
                const functionData = chordFunctions[chord.roman] || { name: 'Unknown', function: 'N/A', tension: 'N/A', color: '#888' };
                
                const card = document.createElement('div');
                card.className = 'chord-card card p-4 relative';
                card.draggable = true;
                card.dataset.index = index;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-2xl font-bold">${chord.name}</span>
                        ${chord.aiGenerated ? '<span class="text-xs px-2 py-0.5 rounded bg-purple-500/30 text-purple-300">AI</span>' : ''}
                    </div>
                    <div class="text-lg text-purple-400 font-mono">${chord.roman}</div>
                    <div class="mt-2 space-y-1">
                        <div class="text-xs text-gray-400">${functionData.name}</div>
                        <div class="text-xs" style="color: ${functionData.color}">${functionData.function}</div>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="text-xs text-gray-500">Tension:</span>
                            <span class="mode-badge" style="background: ${functionData.color}20; color: ${functionData.color}">${functionData.tension}</span>
                        </div>
                    </div>
                    <div class="absolute top-2 right-2 flex gap-1">
                        <button onclick="playChord(${index})" class="p-1 rounded hover:bg-white/10">‚ñ∂Ô∏è</button>
                        <button onclick="removeChord(${index})" class="p-1 rounded hover:bg-red-500/20 text-red-400">√ó</button>
                    </div>
                `;

                // Drag events
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);

                container.appendChild(card);
            });
        }

        function removeChord(index) {
            state.progression.splice(index, 1);
            generateBassLine();
            renderChords();
            updateInstrumentDisplay();
        }

        // Drag and drop
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.target.closest('.chord-card').dataset.index);
            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                const [removed] = state.progression.splice(draggedIndex, 1);
                state.progression.splice(dropIndex, 0, removed);
                generateBassLine();
                renderChords();
                updateInstrumentDisplay();
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        // =============================================
        // INSTRUMENT DISPLAYS
        // =============================================
        function setView(view) {
            state.currentView = view;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            updateInstrumentDisplay();
        }

        function updateInstrumentDisplay() {
            const container = document.getElementById('instrumentDisplay');
            
            switch (state.currentView) {
                case 'guitar':
                    renderGuitarDiagrams(container);
                    break;
                case 'ukulele':
                    renderUkuleleDiagrams(container);
                    break;
                case 'piano':
                    renderPianoDiagrams(container);
                    break;
                case 'tab':
                    renderTabNotation(container);
                    break;
            }
        }

        function renderGuitarDiagrams(container) {
            const capo = parseInt(document.getElementById('capo').value);
            
            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${state.progression.map((chord, i) => {
                        let chordName = chord.name;
                        if (capo > 0) {
                            const rootIndex = notes.indexOf(chord.root);
                            const newRoot = notes[(rootIndex - capo + 12) % 12];
                            chordName = newRoot + chord.quality;
                        }
                        
                        const chordData = guitarChords[chordName] || guitarChords[chord.root] || guitarChords['C'];
                        return `
                            <div class="text-center">
                                <div class="text-sm font-medium mb-2">${chord.name}${capo > 0 ? ` (${chordName})` : ''}</div>
                                ${renderGuitarSVG(chordData, chordName)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderGuitarSVG(chordData, name) {
            const { frets, barre } = chordData;
            const width = 80, height = 100;
            const stringSpacing = 12, fretSpacing = 18;
            const startX = 15, startY = 20;
            
            let svg = `<svg width="${width}" height="${height}" class="mx-auto">`;
            
            // Nut or fret indicator
            if (barre === 0) {
                svg += `<rect x="${startX}" y="${startY - 3}" width="${stringSpacing * 5}" height="3" fill="currentColor"/>`;
            } else {
                svg += `<text x="5" y="${startY + 10}" font-size="10" fill="currentColor">${barre}fr</text>`;
            }
            
            // Frets
            for (let i = 0; i <= 4; i++) {
                svg += `<line x1="${startX}" y1="${startY + i * fretSpacing}" x2="${startX + stringSpacing * 5}" y2="${startY + i * fretSpacing}" stroke="currentColor" stroke-opacity="0.3"/>`;
            }
            
            // Strings
            for (let i = 0; i <= 5; i++) {
                svg += `<line x1="${startX + i * stringSpacing}" y1="${startY}" x2="${startX + i * stringSpacing}" y2="${startY + fretSpacing * 4}" stroke="currentColor" stroke-opacity="0.5"/>`;
            }
            
            // Finger positions
            frets.forEach((fret, string) => {
                const x = startX + string * stringSpacing;
                if (fret === -1) {
                    svg += `<text x="${x - 3}" y="${startY - 6}" font-size="10" fill="#ef4444">√ó</text>`;
                } else if (fret === 0) {
                    svg += `<circle cx="${x}" cy="${startY - 8}" r="3" fill="none" stroke="currentColor"/>`;
                } else {
                    const y = startY + (fret - 0.5) * fretSpacing;
                    svg += `<circle cx="${x}" cy="${y}" r="5" fill="var(--primary)"/>`;
                }
            });
            
            // Barre indicator
            if (barre > 0) {
                const barreY = startY + 0.5 * fretSpacing;
                svg += `<rect x="${startX}" y="${barreY - 4}" width="${stringSpacing * 5}" height="8" rx="4" fill="var(--primary)" opacity="0.7"/>`;
            }
            
            svg += '</svg>';
            return svg;
        }

        function renderUkuleleDiagrams(container) {
            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${state.progression.map((chord, i) => {
                        const ukeFrets = getUkuleleChord(chord.name);
                        return `
                            <div class="text-center">
                                <div class="text-sm font-medium mb-2">${chord.name}</div>
                                ${renderUkuleleSVG(ukeFrets)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function getUkuleleChord(name) {
            const ukeChords = {
                'C': [0, 0, 0, 3], 'D': [2, 2, 2, 0], 'E': [1, 4, 0, 2], 'F': [2, 0, 1, 0],
                'G': [0, 2, 3, 2], 'A': [2, 1, 0, 0], 'B': [4, 3, 2, 2],
                'Cm': [0, 3, 3, 3], 'Dm': [2, 2, 1, 0], 'Em': [0, 4, 3, 2], 'Fm': [1, 0, 1, 3],
                'Gm': [0, 2, 3, 1], 'Am': [2, 0, 0, 0], 'Bm': [4, 2, 2, 2]
            };
            return ukeChords[name] || [0, 0, 0, 0];
        }

        function renderUkuleleSVG(frets) {
            let svg = '<svg width="60" height="80" class="mx-auto">';
            const startX = 10, startY = 15, stringSpacing = 12, fretSpacing = 15;
            
            // Nut
            svg += `<rect x="${startX}" y="${startY - 2}" width="${stringSpacing * 3}" height="2" fill="currentColor"/>`;
            
            // Frets
            for (let i = 0; i <= 4; i++) {
                svg += `<line x1="${startX}" y1="${startY + i * fretSpacing}" x2="${startX + stringSpacing * 3}" y2="${startY + i * fretSpacing}" stroke="currentColor" stroke-opacity="0.3"/>`;
            }
            
            // Strings
            for (let i = 0; i < 4; i++) {
                svg += `<line x1="${startX + i * stringSpacing}" y1="${startY}" x2="${startX + i * stringSpacing}" y2="${startY + fretSpacing * 4}" stroke="currentColor" stroke-opacity="0.5"/>`;
            }
            
            // Fingers
            frets.forEach((fret, string) => {
                const x = startX + string * stringSpacing;
                if (fret === 0) {
                    svg += `<circle cx="${x}" cy="${startY - 6}" r="2" fill="none" stroke="currentColor"/>`;
                } else {
                    const y = startY + (fret - 0.5) * fretSpacing;
                    svg += `<circle cx="${x}" cy="${y}" r="4" fill="var(--primary)"/>`;
                }
            });
            
            svg += '</svg>';
            return svg;
        }

        function renderPianoDiagrams(container) {
            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${state.progression.map((chord, i) => {
                        return `
                            <div class="text-center">
                                <div class="text-sm font-medium mb-2">${chord.name}</div>
                                ${renderPianoSVG(chord)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPianoSVG(chord) {
            const chordNotes = getChordNotes(chord.root, chord.quality);
            const keyWidth = 14, blackKeyWidth = 10;
            
            let svg = '<svg width="100" height="50" class="mx-auto">';
            
            // White keys
            ['C', 'D', 'E', 'F', 'G', 'A', 'B'].forEach((note, i) => {
                const isActive = chordNotes.includes(note);
                svg += `<rect x="${i * keyWidth}" y="0" width="${keyWidth - 1}" height="45" rx="2" fill="${isActive ? 'var(--primary)' : '#e5e7eb'}" stroke="#ccc"/>`;
            });
            
            // Black keys
            [1, 2, 4, 5, 6].forEach((i, idx) => {
                const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
                const isActive = chordNotes.includes(blackNotes[idx]);
                const x = i * keyWidth - blackKeyWidth / 2;
                svg += `<rect x="${x}" y="0" width="${blackKeyWidth}" height="28" rx="1" fill="${isActive ? 'var(--secondary)' : '#1f2937'}"/>`;
            });
            
            svg += '</svg>';
            return svg;
        }

        function getChordNotes(root, quality) {
            const rootIndex = notes.indexOf(root);
            let intervals;
            
            switch (quality) {
                case 'm': intervals = [0, 3, 7]; break;
                case 'dim': intervals = [0, 3, 6]; break;
                case 'aug': intervals = [0, 4, 8]; break;
                case '7': intervals = [0, 4, 7, 10]; break;
                case 'maj7': intervals = [0, 4, 7, 11]; break;
                case 'min7': intervals = [0, 3, 7, 10]; break;
                default: intervals = [0, 4, 7]; // Major
            }
            
            return intervals.map(i => notes[(rootIndex + i) % 12]);
        }

        function renderTabNotation(container) {
            let tabLines = ['e|', 'B|', 'G|', 'D|', 'A|', 'E|'];
            
            state.progression.forEach((chord, i) => {
                const chordData = guitarChords[chord.name] || guitarChords[chord.root] || guitarChords['C'];
                const frets = chordData.frets;
                
                tabLines[0] += (frets[5] === -1 ? 'x' : frets[5]) + '---';
                tabLines[1] += (frets[4] === -1 ? 'x' : frets[4]) + '---';
                tabLines[2] += (frets[3] === -1 ? 'x' : frets[3]) + '---';
                tabLines[3] += (frets[2] === -1 ? 'x' : frets[2]) + '---';
                tabLines[4] += (frets[1] === -1 ? 'x' : frets[1]) + '---';
                tabLines[5] += (frets[0] === -1 ? 'x' : frets[0]) + '---';
            });
            
            const chordLabels = state.progression.map(c => c.name.padEnd(4, ' ')).join('');
            
            container.innerHTML = `
                <pre class="font-mono text-sm text-cyan-400 overflow-x-auto">
   ${chordLabels}
${tabLines.join('\n')}
                </pre>
            `;
        }

        // =============================================
        // PIANO ROLL
        // =============================================
        function renderPianoRoll() {
            const container = document.getElementById('pianoRoll');
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = ['C#', 'D#', null, 'F#', 'G#', 'A#', null];
            
            let html = '<div class="relative inline-flex">';
            
            // White keys
            whiteKeys.forEach((note, i) => {
                html += `<div class="piano-key w-8 h-24 bg-white border border-gray-300 rounded-b cursor-pointer" data-note="${note}4" onclick="playNote('${note}4')"></div>`;
            });
            
            // Black keys
            html += '<div class="absolute top-0 left-0 flex">';
            blackKeys.forEach((note, i) => {
                if (note) {
                    const offset = (i * 32) + 22;
                    html += `<div class="piano-key absolute w-5 h-14 bg-gray-800 rounded-b cursor-pointer" style="left: ${offset}px" data-note="${note}4" onclick="playNote('${note}4')"></div>`;
                }
            });
            html += '</div></div>';
            
            container.innerHTML = html;
        }

        function playNote(note) {
            synth.triggerAttackRelease(note, '8n');
            const key = document.querySelector(`[data-note="${note}"]`);
            if (key) {
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 200);
            }
        }

        // =============================================
        // PLAYBACK
        // =============================================
        let playbackTimeout = null;
        let currentPlayIndex = 0;

        async function playProgression() {
            if (state.isPlaying) return;
            
            await Tone.start();
            state.isPlaying = true;
            currentPlayIndex = 0;
            
            playNextChord();
        }

        function playNextChord() {
            if (!state.isPlaying || currentPlayIndex >= state.progression.length) {
                if (state.isLooping && state.isPlaying) {
                    currentPlayIndex = 0;
                    playNextChord();
                } else {
                    stopPlayback();
                }
                return;
            }

            const chord = state.progression[currentPlayIndex];
            const chordNotes = getChordNotes(chord.root, chord.quality).map(n => n + '4');
            
            // Play chord
            synth.triggerAttackRelease(chordNotes, '2n');
            
            // Play bass
            if (state.bassLine[currentPlayIndex]) {
                const bassNote = state.bassLine[currentPlayIndex][0] + '2';
                bassSynth.triggerAttackRelease(bassNote, '2n');
            }
            
            // Update progress bar
            const progress = ((currentPlayIndex + 1) / state.progression.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Highlight current chord
            const cards = document.querySelectorAll('.chord-card');
            cards.forEach((card, i) => {
                card.classList.toggle('playing', i === currentPlayIndex);
            });
            
            currentPlayIndex++;
            
            const beatDuration = (60 / state.tempo) * 2000;
            playbackTimeout = setTimeout(playNextChord, beatDuration);
        }

        function playChord(index) {
            Tone.start().then(() => {
                const chord = state.progression[index];
                const chordNotes = getChordNotes(chord.root, chord.quality).map(n => n + '4');
                synth.triggerAttackRelease(chordNotes, '2n');
            });
        }

        function stopPlayback() {
            state.isPlaying = false;
            if (playbackTimeout) {
                clearTimeout(playbackTimeout);
                playbackTimeout = null;
            }
            document.getElementById('progressFill').style.width = '0%';
            document.querySelectorAll('.chord-card').forEach(card => {
                card.classList.remove('playing');
            });
        }

        function toggleLoop() {
            state.isLooping = !state.isLooping;
            const btn = document.getElementById('loopBtn');
            btn.textContent = state.isLooping ? 'üîÅ On' : 'üîÅ Off';
            btn.classList.toggle('bg-purple-500/20', state.isLooping);
        }

        function updateTempo() {
            state.tempo = parseInt(document.getElementById('tempo').value);
            document.getElementById('tempoValue').textContent = state.tempo;
        }

        function changeInstrument() {
            const instrument = document.getElementById('instrument').value;
            synth.dispose();
            
            switch (instrument) {
                case 'piano':
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
                    }).toDestination();
                    break;
                case 'acoustic':
                    synth = new Tone.PolySynth(Tone.FMSynth, {
                        modulationIndex: 3,
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.8 }
                    }).toDestination();
                    break;
                case 'organ':
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.05, decay: 0.3, sustain: 0.8, release: 0.5 }
                    }).toDestination();
                    break;
                case 'strings':
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.3, decay: 0.1, sustain: 0.8, release: 1.5 }
                    }).toDestination();
                    break;
                default:
                    synth = new Tone.PolySynth(Tone.Synth).toDestination();
            }
            synth.volume.value = -6;
        }

        // =============================================
        // RECORDING
        // =============================================
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (!state.isRecording) {
                try {
                    const dest = Tone.getDestination();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    state.mediaRecorder = new MediaRecorder(stream);
                    state.audioChunks = [];
                    
                    state.mediaRecorder.ondataavailable = (e) => {
                        state.audioChunks.push(e.data);
                    };
                    
                    state.mediaRecorder.onstop = () => {
                        const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'chordflow-recording.webm';
                        a.click();
                        showToast('Recording saved!');
                    };
                    
                    state.mediaRecorder.start();
                    state.isRecording = true;
                    btn.textContent = '‚èπÔ∏è Stop';
                    btn.classList.add('recording', 'bg-red-500/30');
                    showToast('Recording started');
                } catch (e) {
                    showToast('Microphone access denied');
                }
            } else {
                state.mediaRecorder.stop();
                state.isRecording = false;
                btn.textContent = 'üî¥ Record';
                btn.classList.remove('recording', 'bg-red-500/30');
            }
        }

        // =============================================
        // EXPORT FUNCTIONS
        // =============================================
        function exportMIDI() {
            // Create a simple MIDI file
            const header = [0x4D, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x00, 0x60];
            const trackHeader = [0x4D, 0x54, 0x72, 0x6B];
            
            let trackData = [];
            const tempo = Math.round(60000000 / state.tempo);
            trackData.push(0x00, 0xFF, 0x51, 0x03, (tempo >> 16) & 0xFF, (tempo >> 8) & 0xFF, tempo & 0xFF);
            
            state.progression.forEach((chord, i) => {
                const chordNotes = getChordNotes(chord.root, chord.quality);
                chordNotes.forEach(note => {
                    const midiNote = notes.indexOf(note) + 60;
                    trackData.push(0x00, 0x90, midiNote, 0x64);
                });
                trackData.push(0x60);
                chordNotes.forEach(note => {
                    const midiNote = notes.indexOf(note) + 60;
                    trackData.push(0x00, 0x80, midiNote, 0x00);
                });
            });
            
            trackData.push(0x00, 0xFF, 0x2F, 0x00);
            
            const trackLength = trackData.length;
            const fullTrack = [...trackHeader, (trackLength >> 24) & 0xFF, (trackLength >> 16) & 0xFF, (trackLength >> 8) & 0xFF, trackLength & 0xFF, ...trackData];
            
            const midiData = new Uint8Array([...header, ...fullTrack]);
            const blob = new Blob([midiData], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chordflow-progression.mid';
            a.click();
            showToast('MIDI exported!');
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            const genre = document.getElementById('genre').value;
            const lyrics = document.getElementById('lyricsEditor').value;
            
            // Title
            doc.setFontSize(24);
            doc.setTextColor(139, 92, 246);
            doc.text('ChordFlow Pro - Lead Sheet', 20, 25);
            
            // Info
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Key: ${key} ${scale} | Genre: ${genre} | Tempo: ${state.tempo} BPM`, 20, 35);
            doc.text(`Section: ${state.currentSection}`, 20, 42);
            
            // Chord progression
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('Chord Progression:', 20, 55);
            
            let x = 20, y = 65;
            state.progression.forEach((chord, i) => {
                doc.setFontSize(16);
                doc.setTextColor(139, 92, 246);
                doc.text(chord.name, x, y);
                
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(chord.roman, x, y + 6);
                
                x += 35;
                if (x > 180) { x = 20; y += 25; }
            });
            
            // Lyrics
            if (lyrics) {
                y += 30;
                doc.setFontSize(12);
                doc.setTextColor(0);
                doc.text('Lyrics:', 20, y);
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(lyrics, 170);
                doc.text(lines, 20, y + 10);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generated by ChordFlow Pro v4.0', 20, 285);
            
            doc.save('chordflow-leadsheet.pdf');
            showToast('PDF exported!');
        }

        function exportAudio() {
            if (state.audioChunks.length > 0) {
                const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'chordflow-recording.webm';
                a.click();
            } else {
                showToast('Record a progression first!');
            }
        }

        function exportTab() {
            let tabLines = ['e|', 'B|', 'G|', 'D|', 'A|', 'E|'];
            
            state.progression.forEach((chord) => {
                const chordData = guitarChords[chord.name] || guitarChords[chord.root] || guitarChords['C'];
                const frets = chordData.frets;
                
                tabLines[0] += (frets[5] === -1 ? 'x' : frets[5]) + '---';
                tabLines[1] += (frets[4] === -1 ? 'x' : frets[4]) + '---';
                tabLines[2] += (frets[3] === -1 ? 'x' : frets[3]) + '---';
                tabLines[3] += (frets[2] === -1 ? 'x' : frets[2]) + '---';
                tabLines[4] += (frets[1] === -1 ? 'x' : frets[1]) + '---';
                tabLines[5] += (frets[0] === -1 ? 'x' : frets[0]) + '---';
            });
            
            const content = `ChordFlow Pro - Tab Export
Key: ${document.getElementById('key').value} ${document.getElementById('scale').value}
Tempo: ${state.tempo} BPM

Progression: ${state.progression.map(c => c.name).join(' - ')}

${tabLines.join('\n')}

Generated by ChordFlow Pro v4.0`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chordflow-tab.txt';
            a.click();
            showToast('Tab exported!');
        }

        function copyToClipboard() {
            const text = state.progression.map(c => `${c.name} (${c.roman})`).join(' ‚Üí ');
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        function shareURL() {
            const data = {
                p: state.progression.map(c => c.name),
                k: document.getElementById('key').value,
                s: document.getElementById('scale').value,
                g: document.getElementById('genre').value,
                t: state.tempo
            };
            const encoded = btoa(JSON.stringify(data));
            const url = window.location.origin + window.location.pathname + '?d=' + encoded;
            navigator.clipboard.writeText(url);
            showToast('Share URL copied!');
        }

        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('d');
            if (data) {
                try {
                    const decoded = JSON.parse(atob(data));
                    document.getElementById('key').value = decoded.k || 'C';
                    document.getElementById('scale').value = decoded.s || 'major';
                    document.getElementById('genre').value = decoded.g || 'pop';
                    state.tempo = decoded.t || 120;
                    document.getElementById('tempo').value = state.tempo;
                    document.getElementById('tempoValue').textContent = state.tempo;
                    
                    // Reconstruct progression
                    if (decoded.p) {
                        state.progression = decoded.p.map(name => ({
                            name: name,
                            root: name.replace(/m|dim|aug|7/g, ''),
                            quality: name.replace(/[A-G]#?/g, ''),
                            roman: '?',
                            degree: 0,
                            interval: 0
                        }));
                        generateBassLine();
                        renderChords();
                        updateInstrumentDisplay();
                        showToast('Loaded shared progression!');
                    }
                } catch (e) {
                    console.log('Invalid share data');
                }
            }
        }

        // =============================================
        // CLOUD SYNC (SUPABASE)
        // =============================================
        async function saveToCloud() {
            if (!cloudSyncEnabled || !currentUser) {
                showToast('Connect to cloud first');
                return;
            }

            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            const genre = document.getElementById('genre').value;
            const lyrics = document.getElementById('lyricsEditor').value;
            
            const progressionData = {
                user_id: currentUser.id,
                name: `${key} ${scale} - ${genre}`,
                key: key,
                scale: scale,
                genre: genre,
                tempo: state.tempo,
                section: state.currentSection,
                chords: JSON.stringify(state.progression),
                bass_line: JSON.stringify(state.bassLine),
                lyrics: lyrics,
                created_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from('progressions')
                    .insert([progressionData]);

                if (error) throw error;
                
                showToast('Saved to cloud!');
                updateCloudStatus('synced');
                loadCloudProgressions();
            } catch (e) {
                showToast('Save failed: ' + e.message);
                updateCloudStatus('error');
            }
        }

        async function loadCloudProgressions() {
            if (!cloudSyncEnabled || !currentUser) return;

            const container = document.getElementById('cloudList');
            container.innerHTML = '<p class="text-gray-400 text-sm animate-pulse">Loading...</p>';

            try {
                const { data, error } = await supabase
                    .from('progressions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    container.innerHTML = data.map(prog => `
                        <div class="flex justify-between items-center p-2 rounded bg-white/5 hover:bg-white/10 cursor-pointer" onclick="loadCloudProgression('${prog.id}')">
                            <div>
                                <div class="text-sm font-medium">${prog.name}</div>
                                <div class="text-xs text-gray-400">${new Date(prog.created_at).toLocaleDateString()}</div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteCloudProgression('${prog.id}')" class="p-1 text-red-400 hover:bg-red-500/20 rounded">√ó</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-sm">No saved progressions</p>';
                }
            } catch (e) {
                container.innerHTML = '<p class="text-red-400 text-sm">Error loading</p>';
            }
        }

        async function loadCloudProgression(id) {
            try {
                const { data, error } = await supabase
                    .from('progressions')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                document.getElementById('key').value = data.key;
                document.getElementById('scale').value = data.scale;
                document.getElementById('genre').value = data.genre;
                document.getElementById('tempo').value = data.tempo;
                document.getElementById('tempoValue').textContent = data.tempo;
                document.getElementById('lyricsEditor').value = data.lyrics || '';
                
                state.tempo = data.tempo;
                state.currentSection = data.section;
                state.progression = JSON.parse(data.chords);
                state.bassLine = JSON.parse(data.bass_line);

                renderChords();
                renderBassLine();
                updateInstrumentDisplay();
                updateTheoryAnalysis();
                
                showToast('Loaded from cloud!');
            } catch (e) {
                showToast('Load failed');
            }
        }

        async function deleteCloudProgression(id) {
            if (!confirm('Delete this progression?')) return;

            try {
                const { error } = await supabase
                    .from('progressions')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                
                showToast('Deleted');
                loadCloudProgressions();
            } catch (e) {
                showToast('Delete failed');
            }
        }

        function updateCloudStatus(status) {
            const icon = document.getElementById('cloudIcon');
            const text = document.getElementById('cloudText');
            
            switch (status) {
                case 'synced':
                    icon.textContent = '‚úÖ';
                    text.textContent = 'Synced';
                    break;
                case 'syncing':
                    icon.textContent = 'üîÑ';
                    text.textContent = 'Syncing...';
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    text.textContent = 'Error';
                    break;
                default:
                    icon.textContent = '‚òÅÔ∏è';
                    text.textContent = 'Cloud';
            }
        }

        // =============================================
        // LOCAL HISTORY
        // =============================================
        function addToHistory() {
            const entry = {
                id: Date.now(),
                chords: state.progression.map(c => c.name).join(' ‚Üí '),
                key: document.getElementById('key').value,
                scale: document.getElementById('scale').value,
                genre: document.getElementById('genre').value,
                data: JSON.stringify(state.progression),
                timestamp: new Date().toISOString()
            };

            state.history.unshift(entry);
            if (state.history.length > 20) state.history.pop();
            
            localStorage.setItem('chordflow_history', JSON.stringify(state.history));
            renderHistory();
        }

        function loadHistory() {
            state.history = JSON.parse(localStorage.getItem('chordflow_history') || '[]');
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (state.history.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No history yet</p>';
                return;
            }

            container.innerHTML = state.history.slice(0, 10).map((entry, i) => `
                <div class="flex justify-between items-center p-2 rounded bg-white/5 hover:bg-white/10 cursor-pointer" onclick="loadFromHistory(${i})">
                    <div class="truncate flex-1 mr-2">
                        <div class="text-sm truncate">${entry.chords}</div>
                        <div class="text-xs text-gray-400">${entry.key} ${entry.scale}</div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteFromHistory(${i})" class="p-1 text-red-400 hover:bg-red-500/20 rounded shrink-0">√ó</button>
                </div>
            `).join('');
        }

        function loadFromHistory(index) {
            const entry = state.history[index];
            if (!entry) return;

            document.getElementById('key').value = entry.key;
            document.getElementById('scale').value = entry.scale;
            document.getElementById('genre').value = entry.genre;
            
            state.progression = JSON.parse(entry.data);
            generateBassLine();
            renderChords();
            updateInstrumentDisplay();
            updateTheoryAnalysis();
            
            showToast('Loaded from history');
        }

        function deleteFromHistory(index) {
            state.history.splice(index, 1);
            localStorage.setItem('chordflow_history', JSON.stringify(state.history));
            renderHistory();
        }

        // =============================================
        // THEORY ANALYSIS
        // =============================================
        function updateTheoryAnalysis() {
            const container = document.getElementById('theoryAnalysis');
            const key = document.getElementById('key').value;
            const scale = document.getElementById('scale').value;
            
            const analysis = analyzeProgression();
            
            container.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <span class="text-gray-400">Key:</span>
                        <span class="ml-2 font-medium">${key} ${scale}</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Roman Numerals:</span>
                        <div class="mt-1 font-mono text-purple-400">
                            ${state.progression.map(c => c.roman).join(' ‚Üí ')}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-400">Functional Analysis:</span>
                        <div class="mt-1 flex flex-wrap gap-1">
                            ${analysis.functions.map(f => `
                                <span class="text-xs px-2 py-0.5 rounded" style="background: ${f.color}20; color: ${f.color}">${f.type}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-400">Tension Profile:</span>
                        <div class="mt-1 h-2 bg-gray-700 rounded-full overflow-hidden flex">
                            ${analysis.tensions.map((t, i) => `
                                <div class="h-full" style="width: ${100/analysis.tensions.length}%; background: ${t.color}"></div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-400">Cadences:</span>
                        <div class="mt-1 text-sm">
                            ${analysis.cadences.length > 0 ? analysis.cadences.join(', ') : 'None detected'}
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeProgression() {
            const functions = [];
            const tensions = [];
            const cadences = [];

            state.progression.forEach((chord, i) => {
                const func = chordFunctions[chord.roman] || { name: 'Unknown', function: 'N/A', color: '#888' };
                
                let type = 'Tonic';
                if (func.function.includes('Dominant')) type = 'Dominant';
                else if (func.function.includes('Pre-Dominant') || func.function.includes('Subdominant')) type = 'Pre-Dom';
                else if (func.function.includes('Substitute')) type = 'Subst';
                
                functions.push({ type, color: func.color });
                
                const tensionColors = {
                    'Low': '#22c55e',
                    'Low-Medium': '#84cc16',
                    'Medium': '#f59e0b',
                    'Medium-High': '#f97316',
                    'High': '#ef4444',
                    'Very High': '#dc2626'
                };
                tensions.push({ level: func.tension, color: tensionColors[func.tension] || '#888' });

                // Detect cadences
                if (i > 0) {
                    const prev = state.progression[i - 1].roman;
                    const curr = chord.roman;
                    
                    if ((prev === 'V' || prev === 'V7') && (curr === 'I' || curr === 'i')) {
                        cadences.push('Authentic (V‚ÜíI)');
                    } else if ((prev === 'IV' || prev === 'iv') && (curr === 'I' || curr === 'i')) {
                        cadences.push('Plagal (IV‚ÜíI)');
                    } else if (curr === 'V') {
                        cadences.push('Half (‚ÜíV)');
                    } else if ((prev === 'V' || prev === 'V7') && curr === 'vi') {
                        cadences.push('Deceptive (V‚Üívi)');
                    }
                }
            });

            return { functions, tensions, cadences: [...new Set(cadences)] };
        }

        // =============================================
        // SONG SECTIONS
        // =============================================
        function setSection(section) {
            state.currentSection = section;
            document.getElementById('currentSection').innerHTML = `Current: <span class="text-white capitalize">${section}</span>`;
            showToast(`Section: ${section}`);
        }

        // =============================================
        // UI UTILITIES
        // =============================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2500);
        }

        function updateDisplay() {
            renderChords();
            updateInstrumentDisplay();
        }
    </script>
</body>
</html>
