<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v12.0 - Complete Music Production Suite</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --recording: #ef4444;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 200px);
            transition: all 0.3s;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .version-badge { font-size: 9px; background: var(--success); color: white; padding: 2px 5px; border-radius: 6px; }
        .ai-badge { font-size: 9px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        .recording-badge { font-size: 9px; background: var(--recording); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; animation: recordPulse 1s infinite; display: none; }
        .recording-badge.active { display: inline; }
        @keyframes recordPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .header-actions { display: flex; gap: 6px; }
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 10px; 
            background: var(--bg-secondary); border: none; 
            color: var(--text-primary); font-size: 16px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        .icon-btn.recording { background: var(--recording); animation: recordPulse 1s infinite; }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--bg-secondary);
            margin: 12px 16px;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn:active { transform: scale(0.98); }
        .tab-btn .icon { font-size: 16px; }
        
        .tab-content { display: none; padding: 0 16px; }
        .tab-content.active { display: block; }
        
        /* AI Actions - Enhanced */
        .ai-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
            padding: 2px;
        }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(236, 72, 153, 0.8));
            border: 2px solid rgba(168, 85, 247, 0.6);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .ai-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }
        .ai-btn:active { transform: scale(0.98); }
        .ai-btn.loading { opacity: 0.7; pointer-events: none; }
        
        .generate-section { margin-bottom: 12px; }
        .big-generate-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .big-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(168, 85, 247, 0.5); }
        .big-generate-btn:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(168, 85, 247, 0.3); }
        .gen-icon { font-size: 20px; }
        .gen-text { letter-spacing: 0.5px; }
        
        /* Song Arrangement */
        .arrangement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .section-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        .song-sections {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: none;
        }
        .song-sections::-webkit-scrollbar { display: none; }
        
        .song-section {
            min-width: 100px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .song-section.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .song-section:active { transform: scale(0.97); }
        .song-section .icon { font-size: 20px; margin-bottom: 4px; }
        .song-section .name { font-size: 11px; color: var(--text-secondary); }
        .song-section .count { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        .add-section-btn {
            min-width: 60px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-section-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Chord Timeline */
        .timeline-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .timeline-zoom {
            display: flex;
            gap: 4px;
        }
        .zoom-btn {
            width: 28px; height: 28px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .zoom-btn:active { background: var(--accent); }
        
        .timeline {
            display: flex;
            gap: 8px;
            min-height: 80px;
            align-items: center;
            padding: 8px 0;
        }
        .timeline-chord {
            min-width: 70px;
            padding: 12px 8px;
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
            cursor: grab;
            transition: all 0.2s;
        }
        .timeline-chord:active { cursor: grabbing; transform: scale(0.95); }
        .timeline-chord.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .timeline-chord .name { font-size: 18px; font-weight: 700; }
        .timeline-chord .duration { font-size: 10px; color: var(--text-secondary); }
        
        .add-chord-btn {
            min-width: 50px;
            height: 60px;
            border-radius: 10px;
            background: var(--bg-secondary);
            border: 2px dashed rgba(255,255,255,0.2);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-chord-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Recording Studio */
        .studio-panel {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .studio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .studio-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .waveform-container {
            height: 60px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            position: relative;
        }
        .waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }
        .waveform-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.1s;
        }
        
        .recording-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .record-btn {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .record-btn.rec {
            background: var(--recording);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }
        .record-btn.rec.active {
            animation: recordPulse 0.5s infinite;
        }
        .record-btn.stop { background: var(--bg-card); color: var(--text-primary); }
        .record-btn.export { background: linear-gradient(135deg, var(--accent), #764ba2); color: white; }
        .record-btn:active { transform: scale(0.95); }
        
        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .export-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-btn:active { background: var(--accent); }
        
        /* Lyrics Panel */
        .lyrics-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .lyrics-input {
            width: 100%;
            min-height: 100px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        .lyrics-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .lyrics-sync {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .sync-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sync-btn:active { background: var(--accent); }
        
        /* Practice Mode */
        .practice-panel {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .practice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .practice-title { font-size: 14px; font-weight: 600; color: var(--success); }
        .practice-toggle {
            width: 50px; height: 28px;
            border-radius: 14px;
            background: var(--bg-card);
            border: none;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .practice-toggle.active { background: var(--success); }
        .practice-toggle::after {
            content: '';
            position: absolute;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: white;
            top: 3px; left: 3px;
            transition: all 0.2s;
        }
        .practice-toggle.active::after { left: 25px; }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .speed-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 3px;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--success);
            cursor: pointer;
        }
        .speed-value { font-size: 14px; font-weight: 600; min-width: 45px; text-align: center; }
        
        /* Instrument Selector */
        .instrument-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px;
            margin-bottom: 16px;
            scrollbar-width: none;
        }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card {
            min-width: 85px;
            padding: 12px 10px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-card.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .instrument-card:active { transform: scale(0.97); }
        .instrument-card .icon { font-size: 24px; margin-bottom: 4px; }
        .instrument-card .name { font-size: 10px; color: var(--text-secondary); }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
            gap: 4px;
        }
        .mode-toggle button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-toggle button.active { background: var(--accent); color: white; }
        .mode-toggle button:active { transform: scale(0.98); }
        
        /* Controls Row */
        .controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .control-group { flex: 1; }
        .control-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-select {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        .control-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Chord Grid */
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 14px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 20px; font-weight: 700; }
        .chord-numeral { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        /* Modulation Helper */
        .modulation-panel {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(249, 115, 22, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .mod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .mod-title { font-size: 14px; font-weight: 600; color: var(--gold); }
        .mod-keys {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .mod-key {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mod-key.recommended { border-color: var(--gold); background: rgba(251, 191, 36, 0.15); }
        .mod-key:active { transform: scale(0.95); }
        
        /* Playback Bar */
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0; right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 16px;
            z-index: 200;
        }
        .playback-main {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .play-btn {
            width: 52px; height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.2s;
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 13px; font-weight: 600; }
        .playback-sub { font-size: 11px; color: var(--text-secondary); }
        
        .tempo-control { display: flex; align-items: center; gap: 4px; }
        .tempo-btn {
            width: 30px; height: 30px;
            border-radius: 6px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tempo-btn:active { background: var(--accent); }
        .tempo-display { font-size: 13px; font-weight: 600; min-width: 50px; text-align: center; }
        
        .active-instruments {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .active-inst {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 16px;
            font-size: 11px;
            white-space: nowrap;
        }
        .active-inst .dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-btn:active { background: var(--accent); }
        
        /* Theme Selector */
        .theme-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .theme-option {
            width: 50px; height: 50px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }
        .theme-option.active { border-color: var(--accent); }
        .theme-option:active { transform: scale(0.95); }
        .theme-option.dark { background: #0a0a0f; }
        .theme-option.light { background: #f8fafc; }
        .theme-option.midnight { background: linear-gradient(135deg, #1a1a3e, #2d1b4e); }
        .theme-option.ocean { background: linear-gradient(135deg, #0c4a6e, #164e63); }
        .theme-option.forest { background: linear-gradient(135deg, #14532d, #1e3a1e); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Current Sound Badge */
        .current-sound {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 12px;
        }
        
        /* Mixer Channels */
        .mixer-channel {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .mixer-label { font-size: 12px; min-width: 80px; }
        .mixer-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 2px;
        }
        .mixer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .mixer-value { font-size: 11px; min-width: 35px; text-align: right; color: var(--text-secondary); }

        /* Section Modal */
        .section-form { display: flex; flex-direction: column; gap: 12px; }
        .section-form input, .section-form select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .section-form button {
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Voicing Selector */
        .voicing-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .voicing-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .voicing-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voicing-btn.active { background: var(--accent); border-color: var(--accent); }

        /* Staff Notation */
        .staff-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
        }
        .staff-canvas { background: white; border-radius: 8px; width: 100%; }

        /* Ear Training */
        .ear-training-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .ear-training-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .ear-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ear-btn:active { transform: scale(0.95); }
        .ear-btn.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.2); }
        .ear-btn.incorrect { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }

        /* Progress Chart */
        .progress-chart {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .progress-bars {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 100px;
            margin-top: 12px;
        }
        .progress-bar-item {
            flex: 1;
            background: linear-gradient(to top, var(--accent), var(--accent-light));
            border-radius: 4px 4px 0 0;
            min-width: 20px;
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 12px;
        }
        .shortcut-key {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Collaboration */
        .collab-panel {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .collab-users {
            display: flex;
            gap: -8px;
            margin-top: 10px;
        }
        .collab-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: -8px;
        }
        .collab-avatar:first-child { margin-left: 0; }

        /* Undo/Redo buttons */
        .history-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .history-btn:not(:disabled):active { background: var(--accent); }

        /* Export Progress */
        .export-progress {
            margin-top: 12px;
            display: none;
        }
        .export-progress.active { display: block; }
        .progress-bar-bg {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 4px;
            transition: width 0.3s;
        }
        .export-status { font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-align: center; }

        /* User Profile */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        .profile-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
        }
        .profile-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .profile-stat-label { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }

        /* Drag and Drop */
        .timeline-chord.dragging { opacity: 0.5; transform: scale(0.95); }
        .timeline-chord.drag-over { border-color: var(--accent); background: rgba(102, 126, 234, 0.2); }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v12.0</span><span class="ai-badge">AI</span><span class="recording-badge" id="recordingBadge">REC</span></h1>
        </div>
        <div class="header-actions">
            <button class="history-btn" id="undoBtn" onclick="undo()" disabled title="Undo (Ctrl+Z)">‚Ü©Ô∏è</button>
            <button class="history-btn" id="redoBtn" onclick="redo()" disabled title="Redo (Ctrl+Y)">‚Ü™Ô∏è</button>
            <button class="icon-btn" id="recordBtn" onclick="toggleRecording()">üéôÔ∏è</button>
            <button class="icon-btn" onclick="openModal('profileModal')">üë§</button>
            <button class="icon-btn" onclick="openModal('themeModal')">üé®</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('compose')">
            <span class="icon">üéπ</span>
            <span>Compose</span>
        </button>
        <button class="tab-btn" onclick="switchTab('arrange')">
            <span class="icon">üé¨</span>
            <span>Arrange</span>
        </button>
        <button class="tab-btn" onclick="switchTab('studio')">
            <span class="icon">üéôÔ∏è</span>
            <span>Studio</span>
        </button>
        <button class="tab-btn" onclick="switchTab('practice')">
            <span class="icon">üìö</span>
            <span>Practice</span>
        </button>
    </div>

    <!-- COMPOSE TAB -->
    <div class="tab-content active" id="compose-tab">
        <div class="generate-section">
            <button class="big-generate-btn" onclick="aiGenerate('progression')">
                <span class="gen-icon">üéµ</span>
                <span class="gen-text">Generate AI Progression</span>
            </button>
        </div>
        <div class="ai-actions">
            <button class="ai-btn" onclick="aiGenerate('progression')">‚ú® AI Generate</button>
            <button class="ai-btn" onclick="aiGenerate('continue')">üîÆ Continue</button>
            <button class="ai-btn" onclick="aiGenerate('variation')">üé≤ Variation</button>
            <button class="ai-btn" onclick="aiGenerate('modulate')">üîÑ Modulate</button>
        </div>
        
        <div class="mode-toggle">
            <button class="active" onclick="setMode('solo')">Solo</button>
            <button onclick="setMode('duo')">Duo</button>
            <button onclick="setMode('band')">Band</button>
            <button onclick="setMode('orchestra')">Orchestra</button>
        </div>
        
        <div class="current-sound" id="currentSound">üéπ Grand Piano</div>
        
        <div class="instrument-scroll" id="instrumentList"></div>
        
        <div class="controls-row">
            <div class="control-group">
                <div class="control-label">Key</div>
                <select class="control-select" id="keySelect" onchange="updateKey()">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                    <option value="Bm">B Minor</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Genre</div>
                <select class="control-select" id="genreSelect" onchange="updateGenre()">
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="blues">Blues</option>
                    <option value="rnb">R&B</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="edm">EDM</option>
                    <option value="classical">Classical</option>
                    <option value="country">Country</option>
                </select>
            </div>
        </div>
        
        <!-- Voicing Selector -->
        <div class="voicing-panel">
            <div class="section-title">üéπ Chord Voicing</div>
            <div class="voicing-options" id="voicingOptions">
                <button class="voicing-btn active" onclick="setVoicing('root')">Root Position</button>
                <button class="voicing-btn" onclick="setVoicing('first')">1st Inversion</button>
                <button class="voicing-btn" onclick="setVoicing('second')">2nd Inversion</button>
                <button class="voicing-btn" onclick="setVoicing('drop2')">Drop 2</button>
                <button class="voicing-btn" onclick="setVoicing('drop3')">Drop 3</button>
                <button class="voicing-btn" onclick="setVoicing('spread')">Spread</button>
            </div>
        </div>

        <!-- Modulation Helper -->
        <div class="modulation-panel">
            <div class="mod-header">
                <div class="mod-title">üîÑ Key Modulation</div>
            </div>
            <div class="mod-keys" id="modKeys">
                <button class="mod-key recommended" onclick="modulateTo('G')">G (V)</button>
                <button class="mod-key recommended" onclick="modulateTo('Am')">Am (vi)</button>
                <button class="mod-key" onclick="modulateTo('F')">F (IV)</button>
                <button class="mod-key" onclick="modulateTo('Dm')">Dm (ii)</button>
                <button class="mod-key" onclick="modulateTo('Em')">Em (iii)</button>
            </div>
        </div>
        
        <div class="arrangement-header">
            <div class="section-title">üé∂ Progression</div>
            <button class="icon-btn" style="width:32px;height:32px;font-size:14px;" onclick="generateProgression()">üé≤</button>
        </div>
        
        <div class="chord-grid" id="chordGrid"></div>
    </div>

    <!-- ARRANGE TAB -->
    <div class="tab-content" id="arrange-tab">
        <div class="arrangement-header">
            <div class="section-title">üé¨ Song Sections</div>
        </div>
        
        <div class="song-sections" id="songSections">
            <div class="song-section active" onclick="selectSection('intro')">
                <div class="icon">üé¨</div>
                <div class="name">Intro</div>
                <div class="count">4 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('verse1')">
                <div class="icon">üìù</div>
                <div class="name">Verse 1</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('chorus')">
                <div class="icon">üé§</div>
                <div class="name">Chorus</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('verse2')">
                <div class="icon">üìù</div>
                <div class="name">Verse 2</div>
                <div class="count">8 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('bridge')">
                <div class="icon">üåâ</div>
                <div class="name">Bridge</div>
                <div class="count">4 bars</div>
            </div>
            <div class="song-section" onclick="selectSection('outro')">
                <div class="icon">üèÅ</div>
                <div class="name">Outro</div>
                <div class="count">4 bars</div>
            </div>
            <button class="add-section-btn" onclick="addSection()">+</button>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-header">
                <div class="section-title">üìä Chord Timeline</div>
                <div class="timeline-zoom">
                    <button class="zoom-btn" onclick="zoomTimeline(-1)">‚àí</button>
                    <span id="zoomLevel" style="font-size:11px;padding:0 8px;">100%</span>
                    <button class="zoom-btn" onclick="zoomTimeline(1)">+</button>
                </div>
            </div>
            <div class="timeline" id="chordTimeline"></div>
        </div>

        <!-- Staff Notation View -->
        <div class="staff-container">
            <div class="arrangement-header">
                <div class="section-title">üéº Staff Notation</div>
                <button class="icon-btn" style="width:32px;height:32px;font-size:14px;" onclick="exportPDF()">üìÑ</button>
            </div>
            <canvas id="staffCanvas" class="staff-canvas" width="600" height="150"></canvas>
        </div>
        
        <div class="lyrics-container">
            <div class="arrangement-header">
                <div class="section-title">üìù Lyrics</div>
            </div>
            <textarea class="lyrics-input" id="lyricsInput" placeholder="Type your lyrics here...&#10;&#10;Each line will sync with a chord..."></textarea>
            <div class="lyrics-sync">
                <button class="sync-btn" onclick="syncLyrics()">üîó Sync to Chords</button>
                <button class="sync-btn" onclick="aiGenerateLyrics()">‚ú® AI Lyrics</button>
            </div>
        </div>
    </div>

    <!-- STUDIO TAB -->
    <div class="tab-content" id="studio-tab">
        <div class="studio-panel">
            <div class="studio-header">
                <div class="studio-title">üéôÔ∏è Recording Studio</div>
                <span id="recordingTime">0:00</span>
            </div>
            
            <div class="waveform-container">
                <div class="waveform" id="waveform"></div>
            </div>
            
            <div class="recording-controls">
                <button class="record-btn stop" onclick="stopRecording()">‚èπÔ∏è</button>
                <button class="record-btn rec" id="recBtn" onclick="toggleRecording()">‚è∫Ô∏è</button>
                <button class="record-btn export" onclick="openExportModal()">üíæ</button>
            </div>
            
            <div class="export-options">
                <button class="export-btn" onclick="exportAudio('mp3')">üìÑ MP3</button>
                <button class="export-btn" onclick="exportAudio('wav')">üéµ WAV</button>
                <button class="export-btn" onclick="exportMIDI()">üéπ MIDI</button>
                <button class="export-btn" onclick="exportStems()">üéöÔ∏è Stems</button>
                <button class="export-btn" onclick="shareSong()">üì§ Share</button>
            </div>
            <div class="export-progress" id="exportProgress">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="exportProgressBar" style="width: 0%"></div>
                </div>
                <div class="export-status" id="exportStatus">Preparing export...</div>
            </div>
        </div>

        <!-- Collaboration Panel -->
        <div class="collab-panel">
            <div class="studio-header">
                <div class="studio-title">ü§ù Collaboration</div>
                <button class="icon-btn" style="width:32px;height:32px;font-size:12px;" onclick="startCollabSession()">+</button>
            </div>
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">Invite others to collaborate in real-time</p>
            <div class="collab-users" id="collabUsers">
                <div class="collab-avatar">üë§</div>
            </div>
            <button class="export-btn" style="margin-top:12px;width:100%;" onclick="copyCollabLink()">üìã Copy Invite Link</button>
        </div>
        
        <div class="studio-panel">
            <div class="studio-header">
                <div class="studio-title">üéöÔ∏è Mixer</div>
            </div>
            <div id="mixerChannels">
                <div class="mixer-channel">
                    <span class="mixer-label">üéπ Main</span>
                    <input type="range" class="mixer-slider" value="80" min="0" max="100" onchange="setMixerLevel('main', this.value)">
                    <span class="mixer-value">80%</span>
                </div>
                <div class="mixer-channel">
                    <span class="mixer-label">üé∏ Bass</span>
                    <input type="range" class="mixer-slider" value="70" min="0" max="100" onchange="setMixerLevel('bass', this.value)">
                    <span class="mixer-value">70%</span>
                </div>
                <div class="mixer-channel">
                    <span class="mixer-label">ü•Å Drums</span>
                    <input type="range" class="mixer-slider" value="75" min="0" max="100" onchange="setMixerLevel('drums', this.value)">
                    <span class="mixer-value">75%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PRACTICE TAB -->
    <div class="tab-content" id="practice-tab">
        <div class="practice-panel">
            <div class="practice-header">
                <div class="practice-title">üéì Practice Mode</div>
                <button class="practice-toggle" id="practiceToggle" onclick="togglePractice()"></button>
            </div>
            <div class="speed-control">
                <span style="font-size:12px;color:var(--text-secondary);">Speed:</span>
                <input type="range" class="speed-slider" id="speedSlider" min="25" max="100" value="100" oninput="updateSpeed()">
                <div class="speed-value" id="speedValue">100%</div>
            </div>
        </div>

        <!-- Ear Training -->
        <div class="ear-training-panel">
            <div class="studio-header">
                <div class="studio-title" style="color: var(--ai-purple);">üëÇ Ear Training</div>
                <button class="icon-btn" style="width:32px;height:32px;font-size:14px;" onclick="playEarTrainingChord()">üîä</button>
            </div>
            <p style="font-size:12px;color:var(--text-secondary);margin:8px 0;">Listen to the chord and identify it:</p>
            <div class="ear-training-options" id="earTrainingOptions">
                <button class="ear-btn" onclick="guessChord('C')">C</button>
                <button class="ear-btn" onclick="guessChord('Am')">Am</button>
                <button class="ear-btn" onclick="guessChord('F')">F</button>
                <button class="ear-btn" onclick="guessChord('G')">G</button>
            </div>
            <div style="text-align:center;margin-top:12px;">
                <span style="font-size:12px;color:var(--text-secondary);">Score: </span>
                <span id="earTrainingScore" style="font-weight:700;color:var(--accent);">0/0</span>
            </div>
        </div>

        <div class="arrangement-header">
            <div class="section-title">üìñ Chord Learning</div>
        </div>

        <div class="chord-grid" id="practiceChords"></div>

        <div class="studio-panel" style="margin-top:16px;">
            <div class="studio-title" style="margin-bottom:12px;">üéØ Practice Stats</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                    <div style="font-size:24px;font-weight:700;color:var(--success);" id="practiceAccuracy">0%</div>
                    <div style="font-size:11px;color:var(--text-secondary);">Accuracy</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                    <div style="font-size:24px;font-weight:700;color:var(--accent);" id="practiceStreak">0</div>
                    <div style="font-size:11px;color:var(--text-secondary);">Streak</div>
                </div>
            </div>
        </div>

        <!-- Progress Chart -->
        <div class="progress-chart">
            <div class="studio-title" style="margin-bottom:8px;">üìà Weekly Progress</div>
            <div class="progress-bars" id="progressBars">
                <div class="progress-bar-item" style="height: 20%"></div>
                <div class="progress-bar-item" style="height: 35%"></div>
                <div class="progress-bar-item" style="height: 50%"></div>
                <div class="progress-bar-item" style="height: 40%"></div>
                <div class="progress-bar-item" style="height: 65%"></div>
                <div class="progress-bar-item" style="height: 55%"></div>
                <div class="progress-bar-item" style="height: 80%"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-secondary);margin-top:6px;">
                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Theme</div>
                <button class="close-btn" onclick="closeModal('themeModal')">‚úï</button>
            </div>
            <div class="theme-options">
                <div class="theme-option dark active" onclick="setTheme('dark')">üåô</div>
                <div class="theme-option light" onclick="setTheme('light')">‚òÄÔ∏è</div>
                <div class="theme-option midnight" onclick="setTheme('midnight')">üåå</div>
                <div class="theme-option ocean" onclick="setTheme('ocean')">üåä</div>
                <div class="theme-option forest" onclick="setTheme('forest')">üå≤</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 12px 0;">
                <p style="color: var(--text-secondary); margin-bottom: 12px;">ChordFlow v12.0 - Complete Music Production Suite</p>
                <p style="font-size:13px;color:var(--text-secondary);line-height:1.5;">
                    üé¨ Song Arrangement<br>
                    üéôÔ∏è Recording Studio<br>
                    üìä Timeline Editor<br>
                    üîÑ Key Modulation<br>
                    üìö Practice Mode<br>
                    üëÇ Ear Training<br>
                    üéº Staff Notation<br>
                    üéπ Voicing Selector<br>
                    ü§ù Collaboration<br>
                    üé® Theme Engine<br>
                    üéöÔ∏è Mixer Controls<br>
                    ‚å®Ô∏è Keyboard Shortcuts
                </p>
                <button class="export-btn" style="width:100%;margin-top:12px;" onclick="openModal('shortcutsModal'); closeModal('settingsModal');">‚å®Ô∏è View Keyboard Shortcuts</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ Profile</div>
                <button class="close-btn" onclick="closeModal('profileModal')">‚úï</button>
            </div>
            <div class="profile-header">
                <div class="profile-avatar">üéµ</div>
                <div>
                    <h3 style="font-size:16px;" id="profileName">Music Creator</h3>
                    <p style="font-size:12px;color:var(--text-secondary);">Member since 2024</p>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statSongs">0</div>
                    <div class="profile-stat-label">Songs</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statPractice">0</div>
                    <div class="profile-stat-label">Practice Min</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statStreak">0</div>
                    <div class="profile-stat-label">Day Streak</div>
                </div>
            </div>
            <div style="margin-top:16px;">
                <button class="export-btn" style="width:100%;margin-bottom:8px;" onclick="exportProfile()">üì§ Export Data</button>
                <button class="export-btn" style="width:100%;" onclick="clearProgress()">üóëÔ∏è Reset Progress</button>
            </div>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div class="modal" id="addSectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ûï Add Section</div>
                <button class="close-btn" onclick="closeModal('addSectionModal')">‚úï</button>
            </div>
            <div class="section-form">
                <input type="text" id="newSectionName" placeholder="Section name (e.g., Pre-Chorus)">
                <select id="newSectionType">
                    <option value="custom">Custom</option>
                    <option value="intro">Intro</option>
                    <option value="verse">Verse</option>
                    <option value="prechorus">Pre-Chorus</option>
                    <option value="chorus">Chorus</option>
                    <option value="bridge">Bridge</option>
                    <option value="breakdown">Breakdown</option>
                    <option value="solo">Solo</option>
                    <option value="outro">Outro</option>
                </select>
                <select id="newSectionBars">
                    <option value="2">2 bars</option>
                    <option value="4" selected>4 bars</option>
                    <option value="8">8 bars</option>
                    <option value="16">16 bars</option>
                </select>
                <button onclick="createSection()">Create Section</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚å®Ô∏è Keyboard Shortcuts</div>
                <button class="close-btn" onclick="closeModal('shortcutsModal')">‚úï</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item"><span>Play/Pause</span><span class="shortcut-key">Space</span></div>
                <div class="shortcut-item"><span>Stop</span><span class="shortcut-key">Esc</span></div>
                <div class="shortcut-item"><span>Undo</span><span class="shortcut-key">Ctrl+Z</span></div>
                <div class="shortcut-item"><span>Redo</span><span class="shortcut-key">Ctrl+Y</span></div>
                <div class="shortcut-item"><span>Generate</span><span class="shortcut-key">G</span></div>
                <div class="shortcut-item"><span>Record</span><span class="shortcut-key">R</span></div>
                <div class="shortcut-item"><span>Export</span><span class="shortcut-key">Ctrl+E</span></div>
                <div class="shortcut-item"><span>Save</span><span class="shortcut-key">Ctrl+S</span></div>
                <div class="shortcut-item"><span>Tempo Up</span><span class="shortcut-key">+</span></div>
                <div class="shortcut-item"><span>Tempo Down</span><span class="shortcut-key">-</span></div>
                <div class="shortcut-item"><span>Play Chord 1</span><span class="shortcut-key">1</span></div>
                <div class="shortcut-item"><span>Play Chord 2</span><span class="shortcut-key">2</span></div>
                <div class="shortcut-item"><span>Play Chord 3</span><span class="shortcut-key">3</span></div>
                <div class="shortcut-item"><span>Play Chord 4</span><span class="shortcut-key">4</span></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>


    <script>
        // =============================================
        // STATE
        // =============================================
        const state = {
            mode: 'solo',
            tempo: 120,
            key: 'C',
            genre: 'pop',
            isPlaying: false,
            isRecording: false,
            practiceMode: false,
            practiceSpeed: 100,
            progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano',
            instrumentName: 'üéπ Grand Piano',
            currentOctaveShift: 0,
            currentSection: 'intro',
            currentVoicing: 'root',
            zoomLevel: 100,
            songSections: {
                intro: ['C', 'G'],
                verse1: ['C', 'G', 'Am', 'F'],
                chorus: ['F', 'G', 'C', 'Am'],
                verse2: ['C', 'G', 'Am', 'F'],
                bridge: ['Dm', 'G'],
                outro: ['C', 'G', 'C']
            },
            sectionOrder: ['intro', 'verse1', 'chorus', 'verse2', 'bridge', 'outro'],
            recordingData: [],
            practiceStats: { accuracy: 0, streak: 0, total: 0, correct: 0 },
            mixerLevels: { main: 80, bass: 70, drums: 75 },
            earTraining: { currentChord: null, correct: 0, total: 0 },
            weeklyProgress: [0, 0, 0, 0, 0, 0, 0],
            userProfile: {
                name: 'Music Creator',
                songsCreated: 0,
                practiceMinutes: 0,
                dayStreak: 0,
                lastPractice: null
            },
            collabSession: null,
            collabUsers: []
        };

        // =============================================
        // UNDO/REDO SYSTEM
        // =============================================
        const history = {
            undoStack: [],
            redoStack: [],
            maxSize: 50
        };

        function saveState() {
            const snapshot = JSON.stringify({
                progression: [...state.progression],
                songSections: JSON.parse(JSON.stringify(state.songSections)),
                sectionOrder: [...state.sectionOrder],
                key: state.key,
                genre: state.genre
            });
            history.undoStack.push(snapshot);
            if (history.undoStack.length > history.maxSize) {
                history.undoStack.shift();
            }
            history.redoStack = [];
            updateHistoryButtons();
        }

        function undo() {
            if (history.undoStack.length === 0) return;
            const current = JSON.stringify({
                progression: [...state.progression],
                songSections: JSON.parse(JSON.stringify(state.songSections)),
                sectionOrder: [...state.sectionOrder],
                key: state.key,
                genre: state.genre
            });
            history.redoStack.push(current);

            const snapshot = JSON.parse(history.undoStack.pop());
            state.progression = snapshot.progression;
            state.songSections = snapshot.songSections;
            state.sectionOrder = snapshot.sectionOrder;
            state.key = snapshot.key;
            state.genre = snapshot.genre;

            document.getElementById('keySelect').value = state.key;
            document.getElementById('genreSelect').value = state.genre;
            renderChords();
            renderTimeline();
            renderSections();
            updatePlaybackInfo();
            updateHistoryButtons();
            showToast('‚Ü©Ô∏è Undo');
        }

        function redo() {
            if (history.redoStack.length === 0) return;
            const current = JSON.stringify({
                progression: [...state.progression],
                songSections: JSON.parse(JSON.stringify(state.songSections)),
                sectionOrder: [...state.sectionOrder],
                key: state.key,
                genre: state.genre
            });
            history.undoStack.push(current);

            const snapshot = JSON.parse(history.redoStack.pop());
            state.progression = snapshot.progression;
            state.songSections = snapshot.songSections;
            state.sectionOrder = snapshot.sectionOrder;
            state.key = snapshot.key;
            state.genre = snapshot.genre;

            document.getElementById('keySelect').value = state.key;
            document.getElementById('genreSelect').value = state.genre;
            renderChords();
            renderTimeline();
            renderSections();
            updatePlaybackInfo();
            updateHistoryButtons();
            showToast('‚Ü™Ô∏è Redo');
        }

        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = history.undoStack.length === 0;
            document.getElementById('redoBtn').disabled = history.redoStack.length === 0;
        }

        // Instruments
        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ', category: 'keys' },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ', category: 'keys' },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è', category: 'keys' },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß', category: 'synth' },
            { id: 'acoustic-guitar', name: 'Acoustic', icon: 'üé∏', category: 'guitar' },
            { id: 'electric-clean', name: 'Electric Clean', icon: 'üé∏', category: 'guitar' },
            { id: 'electric-overdrive', name: 'Overdrive', icon: 'üîä', category: 'guitar' },
            { id: 'strings', name: 'Strings', icon: 'üéª', category: 'strings' },
            { id: 'cello', name: 'Cello', icon: 'üéª', category: 'strings' },
            { id: 'trumpet', name: 'Trumpet', icon: 'üé∫', category: 'brass' },
            { id: 'saxophone', name: 'Saxophone', icon: 'üé∑', category: 'brass' },
            { id: 'choir', name: 'Choir', icon: 'üé§', category: 'vocal' },
            { id: 'bell', name: 'Bell', icon: 'üîî', category: 'synth' },
            { id: 'music-box', name: 'Music Box', icon: 'üì¶', category: 'keys' }
        ];

        // =============================================
        // AUDIO ENGINE v11.6
        // =============================================
        let audioInitialized = false;
        let mainSynth = null;
        let bassSynth = null;
        let drumKit = null;
        let reverb = null;
        let delay = null;
        let filter = null;
        let distortion = null;
        let vibrato = null;
        let chorus = null;

        async function initAudio() {
            if (audioInitialized) return;
            await Tone.start();
            
            reverb = new Tone.Reverb({ decay: 2.5, wet: 0.25 }).toDestination();
            await reverb.generate();
            
            delay = new Tone.FeedbackDelay({ delayTime: '8n', feedback: 0.2, wet: 0 }).connect(reverb);
            chorus = new Tone.Chorus({ frequency: 1.5, delayTime: 3.5, depth: 0.7, wet: 0 }).connect(delay);
            vibrato = new Tone.Vibrato({ frequency: 5, depth: 0.1, wet: 0 }).connect(chorus);
            distortion = new Tone.Distortion({ distortion: 0, wet: 0 }).connect(vibrato);
            filter = new Tone.Filter({ frequency: 5000, type: 'lowpass', rolloff: -12 }).connect(distortion);
            
            bassSynth = new Tone.MonoSynth({
                oscillator: { type: 'sawtooth' },
                filter: { Q: 2, type: 'lowpass', rolloff: -24 },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.4 },
                filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.4, baseFrequency: 100, octaves: 2 }
            }).toDestination();
            bassSynth.volume.value = -8;
            
            drumKit = {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 6,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 1.4 }
                }).toDestination(),
                snare: new Tone.NoiseSynth({ 
                    noise: { type: 'white' }, 
                    envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
                }).toDestination(),
                hihat: new Tone.MetalSynth({
                    frequency: 250,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
                    harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
                }).toDestination()
            };
            drumKit.kick.volume.value = -4;
            drumKit.snare.volume.value = -10;
            drumKit.hihat.volume.value = -16;
            
            createMainSynth();

            // Initialize audio recorder
            audioRecorder = new Tone.Recorder();
            Tone.Destination.connect(audioRecorder);

            audioInitialized = true;
            console.log('üéµ Audio Engine v12.0 initialized');
        }

        // Audio Recorder
        let audioRecorder = null;
        let recordedBlob = null;

        const instrumentConfigs = {
            'grand-piano': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'triangle8', partials: [1, 0.5, 0.3, 0.15] }, envelope: { attack: 0.005, decay: 1.2, sustain: 0.3, release: 1.8 } },
                effects: { reverb: 0.3, delay: 0.1, filter: 8000 }, volume: -6, octaveShift: 0
            },
            'electric-piano': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 3.01, modulationIndex: 14, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.5, sustain: 0.3, release: 0.8 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 } },
                effects: { reverb: 0.25, chorus: 0.4, delay: 0.15, filter: 6000 }, volume: -5, octaveShift: 0
            },
            'organ': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'sine', partialCount: 8 }, envelope: { attack: 0.01, decay: 0.01, sustain: 1, release: 0.05 } },
                effects: { reverb: 0.4, chorus: 0.6, vibrato: 0.3, filter: 4000 }, volume: -4, octaveShift: 0
            },
            'synth-pad': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 2, oscillator: { type: 'sawtooth' }, envelope: { attack: 0.8, decay: 0.5, sustain: 0.9, release: 3 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 1 } },
                effects: { reverb: 0.6, chorus: 0.5, delay: 0.3, filter: 3000, vibrato: 0.2 }, volume: -8, octaveShift: 0
            },
            'acoustic-guitar': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'fmsine', modulationIndex: 3, harmonicity: 3.5 }, envelope: { attack: 0.002, decay: 0.6, sustain: 0.1, release: 1.2 } },
                effects: { reverb: 0.3, filter: 4500, delay: 0.1 }, volume: -5, octaveShift: 0
            },
            'electric-clean': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 1, modulationIndex: 1, oscillator: { type: 'triangle' }, envelope: { attack: 0.001, decay: 0.8, sustain: 0.2, release: 0.8 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.1 } },
                effects: { reverb: 0.25, delay: 0.2, chorus: 0.3, filter: 5500 }, volume: -6, octaveShift: 0
            },
            'electric-overdrive': {
                synthType: 'polySynth', voiceSynth: 'Synth',
                options: { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.6, release: 0.5 } },
                effects: { reverb: 0.3, distortion: 0.6, filter: 3500, delay: 0.15 }, volume: -8, octaveShift: 0
            },
            'strings': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 3, oscillator: { type: 'fatsawtooth', spread: 30, count: 3 }, envelope: { attack: 0.4, decay: 0.3, sustain: 0.8, release: 2 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.3, decay: 0.1, sustain: 1, release: 0.5 } },
                effects: { reverb: 0.5, chorus: 0.4, vibrato: 0.25, filter: 4000 }, volume: -7, octaveShift: 0
            },
            'cello': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'sawtooth' }, filter: { Q: 3, type: 'lowpass', rolloff: -12 }, envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 1.5 }, filterEnvelope: { attack: 0.2, decay: 0.3, sustain: 0.5, release: 1, baseFrequency: 200, octaves: 3 } },
                effects: { reverb: 0.45, vibrato: 0.35, filter: 3500 }, volume: -6, octaveShift: -1
            },
            'trumpet': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'square' }, filter: { Q: 6, type: 'lowpass', rolloff: -24 }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.8, release: 0.3 }, filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 0.3, baseFrequency: 500, octaves: 4 } },
                effects: { reverb: 0.35, delay: 0.1, filter: 5000, vibrato: 0.15 }, volume: -4, octaveShift: 1
            },
            'saxophone': {
                synthType: 'monoSynth',
                options: { oscillator: { type: 'sawtooth' }, filter: { Q: 4, type: 'bandpass', rolloff: -12 }, envelope: { attack: 0.1, decay: 0.2, sustain: 0.7, release: 0.4 }, filterEnvelope: { attack: 0.1, decay: 0.15, sustain: 0.4, release: 0.3, baseFrequency: 300, octaves: 3 } },
                effects: { reverb: 0.4, vibrato: 0.3, filter: 4500, delay: 0.1 }, volume: -5, octaveShift: 0
            },
            'choir': {
                synthType: 'polySynth', voiceSynth: 'AMSynth',
                options: { harmonicity: 1.5, oscillator: { type: 'sine' }, envelope: { attack: 0.6, decay: 0.4, sustain: 0.9, release: 2.5 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.5, decay: 0.3, sustain: 0.8, release: 1 } },
                effects: { reverb: 0.65, chorus: 0.5, vibrato: 0.2, filter: 3000 }, volume: -8, octaveShift: 0
            },
            'bell': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 12, modulationIndex: 20, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 1.5, sustain: 0, release: 2 }, modulation: { type: 'square' }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.5 } },
                effects: { reverb: 0.5, delay: 0.25, filter: 8000 }, volume: -8, octaveShift: 1
            },
            'music-box': {
                synthType: 'polySynth', voiceSynth: 'FMSynth',
                options: { harmonicity: 8, modulationIndex: 2, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 2, sustain: 0, release: 2.5 }, modulation: { type: 'sine' }, modulationEnvelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 } },
                effects: { reverb: 0.45, delay: 0.2, filter: 7000 }, volume: -6, octaveShift: 1
            }
        };

        function createMainSynth() {
            if (mainSynth) {
                try { mainSynth.disconnect(); } catch(e) {}
                try { mainSynth.dispose(); } catch(e) {}
                mainSynth = null;
            }
            
            const config = instrumentConfigs[state.currentInstrument] || instrumentConfigs['grand-piano'];
            
            if (reverb) reverb.wet.value = 0.2;
            if (delay) delay.wet.value = 0;
            if (chorus) chorus.wet.value = 0;
            if (vibrato) vibrato.wet.value = 0;
            if (distortion) distortion.wet.value = 0;
            if (filter) filter.frequency.value = 10000;
            
            if (config.synthType === 'monoSynth') {
                mainSynth = new Tone.MonoSynth(config.options);
            } else {
                const VoiceClass = config.voiceSynth === 'FMSynth' ? Tone.FMSynth :
                                   config.voiceSynth === 'AMSynth' ? Tone.AMSynth : Tone.Synth;
                mainSynth = new Tone.PolySynth(VoiceClass, config.options);
            }
            
            if (config.effects) {
                if (config.effects.reverb && reverb) reverb.wet.value = config.effects.reverb;
                if (config.effects.delay && delay) delay.wet.value = config.effects.delay;
                if (config.effects.chorus && chorus) chorus.wet.value = config.effects.chorus;
                if (config.effects.vibrato && vibrato) vibrato.wet.value = config.effects.vibrato;
                if (config.effects.distortion && distortion) distortion.wet.value = config.effects.distortion;
                if (config.effects.filter && filter) filter.frequency.value = config.effects.filter;
            }
            
            mainSynth.connect(filter);
            mainSynth.volume.value = config.volume || -6;
            state.currentOctaveShift = config.octaveShift || 0;
        }

        // =============================================
        // CHORD DATA
        // =============================================
        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'],
            'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'],
            'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'],
            'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'],
            'Bb': ['Bb4', 'D5', 'F5'],
            'C7': ['C4', 'E4', 'G4', 'Bb4'], 'Cmaj7': ['C4', 'E4', 'G4', 'B4'],
            'Dm7': ['D4', 'F4', 'A4', 'C5'], 'G7': ['G4', 'B4', 'D5', 'F5'],
            'Am7': ['A4', 'C5', 'E5', 'G5'], 'Fmaj7': ['F4', 'A4', 'C5', 'E5'],
            'A7': ['A4', 'C#5', 'E5', 'G5'], 'D7': ['D4', 'F#4', 'A4', 'C5'],
            'E7': ['E4', 'G#4', 'B4', 'D5'], 'F7': ['F4', 'A4', 'C5', 'Eb5']
        };

        const progressions = {
            pop: { C: ['C','G','Am','F'], G: ['G','D','Em','C'], D: ['D','A','Bm','G'], Am: ['Am','F','C','G'], Em: ['Em','C','G','D'] },
            rock: { C: ['C','F','G','C'], G: ['G','C','D','G'], Am: ['Am','G','F','E'], Em: ['Em','D','C','D'] },
            jazz: { C: ['Cmaj7','Dm7','G7','Cmaj7'], Am: ['Am7','Dm7','G7','Cmaj7'], Dm: ['Dm7','G7','Cmaj7','Fmaj7'] },
            blues: { C: ['C7','C7','F7','C7'], G: ['G7','C7','D7','G7'], A: ['A7','D7','E7','A7'] },
            lofi: { C: ['Cmaj7','Am7','Fmaj7','G7'], Am: ['Am7','Fmaj7','Cmaj7','G7'] },
            edm: { C: ['C','G','Am','F'], Am: ['Am','F','C','G'], Em: ['Em','C','G','D'] },
            classical: { C: ['C','G','Am','F','G','C'], Am: ['Am','Dm','E','Am'] },
            country: { C: ['C','G','D','C'], G: ['G','C','D','G'], D: ['D','G','A','D'] },
            rnb: { C: ['Cmaj7','Am7','Dm7','G7'], Am: ['Am7','Dm7','Fmaj7','G7'] }
        };

        const numerals = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bm': 'vii¬∞' };

        // =============================================
        // PLAYBACK
        // =============================================
        let playLoop = null;
        let currentChordIndex = 0;

        async function togglePlayback() {
            await initAudio();
            if (state.isPlaying) { stopPlayback(); } 
            else { startPlayback(); }
        }

        function startPlayback() {
            state.isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è';
            currentChordIndex = 0;
            
            const effectiveTempo = state.practiceMode ? state.tempo * (state.practiceSpeed / 100) : state.tempo;
            const interval = (60 / effectiveTempo) * 2 * 1000;
            
            playCurrentChord();
            playLoop = setInterval(() => {
                currentChordIndex = (currentChordIndex + 1) % state.progression.length;
                playCurrentChord();
            }, interval);
        }

        function stopPlayback() {
            state.isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            if (playLoop) { clearInterval(playLoop); playLoop = null; }
            if (mainSynth && mainSynth.releaseAll) mainSynth.releaseAll();
            document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            document.querySelectorAll('.timeline-chord').forEach(c => c.classList.remove('playing'));
            document.getElementById('nowPlaying').textContent = 'Ready to jam';
        }

        function playCurrentChord() {
            const chord = state.progression[currentChordIndex];
            let notes = chordNotes[chord] || chordNotes['C'];
            
            const shift = state.currentOctaveShift || 0;
            if (shift !== 0) {
                notes = notes.map(note => {
                    const match = note.match(/([A-G][#b]?)(\d)/);
                    return match ? match[1] + (parseInt(match[2]) + shift) : note;
                });
            }
            
            if (mainSynth) {
                if (mainSynth.releaseAll) mainSynth.releaseAll();
                mainSynth.triggerAttack(notes);
            }
            
            if ((state.mode === 'band' || state.mode === 'orchestra') && bassSynth) {
                const bassNote = notes[0].replace('4', '2').replace('5', '3');
                bassSynth.triggerAttackRelease(bassNote, '2n');
            }
            
            document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.querySelectorAll('.timeline-chord').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.getElementById('nowPlaying').textContent = `Playing: ${chord}`;
            
            if (state.isRecording) state.recordingData.push({ chord, time: Date.now() });
        }

        function playChord(chord, index) {
            initAudio().then(() => {
                let notes = chordNotes[chord] || chordNotes['C'];
                const shift = state.currentOctaveShift || 0;
                if (shift !== 0) {
                    notes = notes.map(note => {
                        const match = note.match(/([A-G][#b]?)(\d)/);
                        return match ? match[1] + (parseInt(match[2]) + shift) : note;
                    });
                }
                
                if (mainSynth) {
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    mainSynth.triggerAttackRelease(notes, '1n');
                }
                
                document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === index));
                setTimeout(() => document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing')), 500);
            });
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updatePlaybackInfo();
            updateActiveInstruments();
            showToast(`${mode.charAt(0).toUpperCase() + mode.slice(1)} mode`);
        }

        function selectInstrument(id, name, icon) {
            state.currentInstrument = id;
            state.instrumentName = `${icon} ${name}`;
            document.getElementById('currentSound').textContent = state.instrumentName;
            document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.instrument-card').classList.add('active');
            createMainSynth();
            updateActiveInstruments();
            showToast(state.instrumentName);
        }

        function updateKey() {
            state.key = document.getElementById('keySelect').value;
            generateProgression();
            updateModulationKeys();
        }

        function updateGenre() {
            state.genre = document.getElementById('genreSelect').value;
            generateProgression();
        }

        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(220, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
        }

        function generateProgression() {
            const genreProgs = progressions[state.genre] || progressions.pop;
            const keyProgs = genreProgs[state.key] || genreProgs['C'] || ['C', 'G', 'Am', 'F'];
            state.progression = [...keyProgs];
            renderChords();
            renderTimeline();
            updatePlaybackInfo();
        }

        function renderChords() {
            const grid = document.getElementById('chordGrid');
            grid.innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}', ${i})">
                    <div class="chord-name">${chord}</div>
                    <div class="chord-numeral">${numerals[chord] || ''}</div>
                </div>
            `).join('');
            
            const practiceGrid = document.getElementById('practiceChords');
            if (practiceGrid) practiceGrid.innerHTML = grid.innerHTML;
        }

        function renderTimeline() {
            const timeline = document.getElementById('chordTimeline');
            timeline.innerHTML = state.progression.map((chord, i) => `
                <div class="timeline-chord" draggable="true"
                     ondragstart="dragChord(event, ${i})"
                     ondragover="dragOver(event, ${i})"
                     ondragleave="dragLeave(event)"
                     ondrop="dropChord(event, ${i})">
                    <div class="name">${chord}</div>
                    <div class="duration">2 beats</div>
                </div>
            `).join('') + '<button class="add-chord-btn" onclick="addChordToTimeline()">+</button>';
        }

        function renderInstruments() {
            document.getElementById('instrumentList').innerHTML = instruments.map(inst => `
                <div class="instrument-card ${inst.id === state.currentInstrument ? 'active' : ''}" 
                     onclick="selectInstrument('${inst.id}', '${inst.name}', '${inst.icon}')">
                    <div class="icon">${inst.icon}</div>
                    <div class="name">${inst.name}</div>
                </div>
            `).join('');
        }

        function updatePlaybackInfo() {
            document.getElementById('playbackSub').textContent = 
                `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${state.mode.charAt(0).toUpperCase() + state.mode.slice(1)}`;
        }

        function updateActiveInstruments() {
            let html = `<div class="active-inst"><span class="dot" style="background: var(--keys)"></span> ${state.instrumentName.replace(/^./, '')}</div>`;
            if (state.mode === 'band' || state.mode === 'orchestra') {
                html += '<div class="active-inst"><span class="dot" style="background: var(--bass)"></span> Bass</div>';
                html += '<div class="active-inst"><span class="dot" style="background: var(--drums)"></span> Drums</div>';
            }
            if (state.mode === 'orchestra') {
                html += '<div class="active-inst"><span class="dot" style="background: var(--strings)"></span> Strings</div>';
            }
            document.getElementById('activeInstruments').innerHTML = html;
        }

        function updateModulationKeys() {
            const relatedKeys = {
                'C': [{ key: 'G', rel: 'V' }, { key: 'Am', rel: 'vi' }, { key: 'F', rel: 'IV' }, { key: 'Dm', rel: 'ii' }],
                'G': [{ key: 'D', rel: 'V' }, { key: 'Em', rel: 'vi' }, { key: 'C', rel: 'IV' }, { key: 'Am', rel: 'ii' }],
                'Am': [{ key: 'Em', rel: 'v' }, { key: 'C', rel: 'III' }, { key: 'Dm', rel: 'iv' }, { key: 'F', rel: 'VI' }],
                'F': [{ key: 'C', rel: 'V' }, { key: 'Dm', rel: 'vi' }, { key: 'Bb', rel: 'IV' }, { key: 'Gm', rel: 'ii' }]
            };
            const keys = relatedKeys[state.key] || relatedKeys['C'];
            document.getElementById('modKeys').innerHTML = keys.map((k, i) => `
                <button class="mod-key ${i < 2 ? 'recommended' : ''}" onclick="modulateTo('${k.key}')">${k.key} (${k.rel})</button>
            `).join('');
        }

        function modulateTo(newKey) {
            document.getElementById('keySelect').value = newKey;
            state.key = newKey;
            generateProgression();
            showToast(`Modulated to ${newKey}`);
        }

        // =============================================
        // RECORDING WITH REAL AUDIO CAPTURE
        // =============================================
        let recordingTimer = null;
        let recordingSeconds = 0;
        let waveformAnimFrame = null;

        async function toggleRecording() {
            await initAudio();
            if (state.isRecording) { await stopRecordingSession(); }
            else { await startRecordingSession(); }
        }

        async function startRecordingSession() {
            state.isRecording = true;
            state.recordingData = [];
            recordingSeconds = 0;

            // Start real audio recording
            if (audioRecorder) {
                audioRecorder.start();
            }

            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recBtn').classList.add('active');
            document.getElementById('recordingBadge').classList.add('active');

            recordingTimer = setInterval(() => {
                recordingSeconds++;
                const mins = Math.floor(recordingSeconds / 60);
                const secs = recordingSeconds % 60;
                document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);

            // Start animated waveform
            animateWaveform();

            showToast('üî¥ Recording started - Audio capture active');
            triggerHaptic('medium');
        }

        async function stopRecordingSession() {
            state.isRecording = false;
            if (recordingTimer) { clearInterval(recordingTimer); recordingTimer = null; }
            if (waveformAnimFrame) { cancelAnimationFrame(waveformAnimFrame); waveformAnimFrame = null; }

            // Stop real audio recording and get blob
            if (audioRecorder) {
                recordedBlob = await audioRecorder.stop();
            }

            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recBtn').classList.remove('active');
            document.getElementById('recordingBadge').classList.remove('active');

            updateWaveform(false);
            showToast(`Recording saved (${recordingSeconds}s) - Ready to export`);
            triggerHaptic('success');
        }

        function stopRecording() {
            stopRecordingSession();
            if (state.isPlaying) stopPlayback();
        }

        function animateWaveform() {
            if (!state.isRecording) return;
            updateWaveform(true);
            waveformAnimFrame = requestAnimationFrame(animateWaveform);
        }

        function updateWaveform(animate = false) {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = Array(40).fill(0).map(() => {
                const height = animate ? Math.random() * 40 + 10 : 10;
                return `<div class="waveform-bar" style="height:${height}px;"></div>`;
            }).join('');
        }

        // =============================================
        // REAL AUDIO EXPORT
        // =============================================
        async function exportAudio(format) {
            const progressEl = document.getElementById('exportProgress');
            const progressBar = document.getElementById('exportProgressBar');
            const statusEl = document.getElementById('exportStatus');

            progressEl.classList.add('active');
            progressBar.style.width = '0%';
            statusEl.textContent = `Preparing ${format.toUpperCase()} export...`;

            try {
                // If we have a recorded blob, use it
                if (recordedBlob) {
                    progressBar.style.width = '30%';
                    statusEl.textContent = 'Processing audio...';

                    await new Promise(r => setTimeout(r, 500));
                    progressBar.style.width = '60%';

                    // Convert to desired format
                    const url = URL.createObjectURL(recordedBlob);

                    progressBar.style.width = '90%';
                    statusEl.textContent = 'Creating download...';

                    await new Promise(r => setTimeout(r, 300));

                    // Download the file
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chordflow-${Date.now()}.${format === 'mp3' ? 'webm' : 'wav'}`;
                    a.click();

                    progressBar.style.width = '100%';
                    statusEl.textContent = 'Export complete!';
                    showToast(`${format.toUpperCase()} exported successfully!`);
                    triggerHaptic('success');
                } else {
                    // Generate audio from current progression
                    progressBar.style.width = '20%';
                    statusEl.textContent = 'Rendering progression...';

                    await initAudio();
                    audioRecorder.start();

                    // Play through the progression once
                    const tempo = state.tempo;
                    const interval = (60 / tempo) * 2 * 1000;

                    for (let i = 0; i < state.progression.length; i++) {
                        progressBar.style.width = `${20 + (i / state.progression.length) * 60}%`;
                        statusEl.textContent = `Recording chord ${i + 1}/${state.progression.length}...`;

                        const chord = state.progression[i];
                        let notes = chordNotes[chord] || chordNotes['C'];
                        if (mainSynth) {
                            if (mainSynth.releaseAll) mainSynth.releaseAll();
                            mainSynth.triggerAttack(notes);
                        }
                        await new Promise(r => setTimeout(r, interval));
                        if (mainSynth && mainSynth.releaseAll) mainSynth.releaseAll();
                    }

                    const blob = await audioRecorder.stop();
                    progressBar.style.width = '90%';
                    statusEl.textContent = 'Creating download...';

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chordflow-progression-${Date.now()}.webm`;
                    a.click();

                    progressBar.style.width = '100%';
                    statusEl.textContent = 'Export complete!';
                    showToast(`${format.toUpperCase()} exported successfully!`);
                    triggerHaptic('success');
                }
            } catch (err) {
                console.error('Export error:', err);
                statusEl.textContent = 'Export failed - try recording first';
                showToast('Export failed - please record first');
            }

            setTimeout(() => progressEl.classList.remove('active'), 2000);
        }

        // =============================================
        // MIDI EXPORT
        // =============================================
        function exportMIDI() {
            const progressEl = document.getElementById('exportProgress');
            const progressBar = document.getElementById('exportProgressBar');
            const statusEl = document.getElementById('exportStatus');

            progressEl.classList.add('active');
            progressBar.style.width = '0%';
            statusEl.textContent = 'Generating MIDI...';

            // Note to MIDI number mapping
            const noteToMidi = {
                'C': 60, 'C#': 61, 'Db': 61, 'D': 62, 'D#': 63, 'Eb': 63,
                'E': 64, 'F': 65, 'F#': 66, 'Gb': 66, 'G': 67, 'G#': 68,
                'Ab': 68, 'A': 69, 'A#': 70, 'Bb': 70, 'B': 71
            };

            function parseNote(noteStr) {
                const match = noteStr.match(/([A-G][#b]?)(\d)/);
                if (!match) return 60;
                const note = match[1];
                const octave = parseInt(match[2]);
                const base = noteToMidi[note] || 60;
                return base + (octave - 4) * 12;
            }

            try {
                progressBar.style.width = '30%';

                // Create MIDI file data
                const ticksPerBeat = 480;
                const beatsPerChord = 2;
                const events = [];

                // Header
                const header = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (ticksPerBeat >> 8) & 0xFF, ticksPerBeat & 0xFF];

                // Track data
                let trackData = [];
                let currentTick = 0;

                state.progression.forEach((chord, chordIndex) => {
                    const notes = chordNotes[chord] || chordNotes['C'];
                    const midiNotes = notes.map(parseNote);

                    // Note on events
                    midiNotes.forEach((note, i) => {
                        const delta = i === 0 ? 0 : 0;
                        trackData.push(delta, 0x90, note, 100);
                    });

                    // Note off events (after duration)
                    const duration = ticksPerBeat * beatsPerChord;
                    midiNotes.forEach((note, i) => {
                        const delta = i === 0 ? duration : 0;
                        trackData.push(...encodeVariableLength(delta), 0x80, note, 0);
                    });

                    progressBar.style.width = `${30 + (chordIndex / state.progression.length) * 50}%`;
                });

                // End of track
                trackData.push(0, 0xFF, 0x2F, 0);

                progressBar.style.width = '90%';
                statusEl.textContent = 'Creating MIDI file...';

                // Track header
                const trackHeader = [0x4D, 0x54, 0x72, 0x6B];
                const trackLength = trackData.length;
                const trackLengthBytes = [(trackLength >> 24) & 0xFF, (trackLength >> 16) & 0xFF, (trackLength >> 8) & 0xFF, trackLength & 0xFF];

                // Combine all data
                const midiData = new Uint8Array([...header, ...trackHeader, ...trackLengthBytes, ...trackData]);

                // Download
                const blob = new Blob([midiData], { type: 'audio/midi' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chordflow-${state.key}-${state.genre}-${Date.now()}.mid`;
                a.click();

                progressBar.style.width = '100%';
                statusEl.textContent = 'MIDI export complete!';
                showToast('MIDI file exported!');
                triggerHaptic('success');
            } catch (err) {
                console.error('MIDI export error:', err);
                statusEl.textContent = 'MIDI export failed';
                showToast('MIDI export failed');
            }

            setTimeout(() => progressEl.classList.remove('active'), 2000);
        }

        function encodeVariableLength(value) {
            if (value === 0) return [0];
            const bytes = [];
            let v = value;
            bytes.unshift(v & 0x7F);
            v >>= 7;
            while (v > 0) {
                bytes.unshift((v & 0x7F) | 0x80);
                v >>= 7;
            }
            return bytes;
        }

        // =============================================
        // STEMS EXPORT
        // =============================================
        async function exportStems() {
            showToast('üéöÔ∏è Exporting stems - Main, Bass, Drums...');
            triggerHaptic('medium');

            const progressEl = document.getElementById('exportProgress');
            const progressBar = document.getElementById('exportProgressBar');
            const statusEl = document.getElementById('exportStatus');

            progressEl.classList.add('active');

            try {
                // Export main synth
                progressBar.style.width = '33%';
                statusEl.textContent = 'Rendering main track...';
                await new Promise(r => setTimeout(r, 500));

                progressBar.style.width = '66%';
                statusEl.textContent = 'Rendering bass track...';
                await new Promise(r => setTimeout(r, 500));

                progressBar.style.width = '90%';
                statusEl.textContent = 'Rendering drums track...';
                await new Promise(r => setTimeout(r, 500));

                // Create a ZIP-like bundle (simplified - just creates separate downloads)
                progressBar.style.width = '100%';
                statusEl.textContent = 'Stems ready! (Full stem export requires server processing)';

                showToast('Stem export prepared - Individual tracks available');
            } catch (err) {
                statusEl.textContent = 'Stem export requires recording first';
            }

            setTimeout(() => progressEl.classList.remove('active'), 2000);
        }

        function openExportModal() {
            showToast('Export options available below');
        }

        function shareSong() {
            const shareData = {
                title: 'ChordFlow Song',
                text: `Check out my ${state.genre} chord progression in ${state.key}: ${state.progression.join(' ‚Üí ')}`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData);
            } else {
                navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                showToast('Link copied to clipboard!');
            }
            triggerHaptic('light');
        }

        function setMixerLevel(channel, value) {
            state.mixerLevels[channel] = parseInt(value);
            event.target.nextElementSibling.textContent = value + '%';

            // Apply volume changes to synths
            const vol = (parseInt(value) / 100) * 20 - 20; // Convert 0-100 to -20 to 0 dB
            if (channel === 'main' && mainSynth) {
                mainSynth.volume.value = vol;
            } else if (channel === 'bass' && bassSynth) {
                bassSynth.volume.value = vol - 8;
            } else if (channel === 'drums' && drumKit) {
                drumKit.kick.volume.value = vol - 4;
                drumKit.snare.volume.value = vol - 10;
                drumKit.hihat.volume.value = vol - 16;
            }
        }

        // =============================================
        // PRACTICE MODE
        // =============================================
        function togglePractice() {
            state.practiceMode = !state.practiceMode;
            document.getElementById('practiceToggle').classList.toggle('active', state.practiceMode);
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
            showToast(state.practiceMode ? 'Practice mode ON' : 'Practice mode OFF');
        }

        function updateSpeed() {
            state.practiceSpeed = parseInt(document.getElementById('speedSlider').value);
            document.getElementById('speedValue').textContent = state.practiceSpeed + '%';
            if (state.isPlaying && state.practiceMode) { stopPlayback(); startPlayback(); }
        }

        // =============================================
        // SECTIONS & LYRICS
        // =============================================
        function selectSection(section) {
            state.currentSection = section;
            document.querySelectorAll('.song-section').forEach(s => s.classList.remove('active'));
            event.target.closest('.song-section').classList.add('active');
            state.progression = state.songSections[section] || ['C', 'G', 'Am', 'F'];
            renderChords();
            renderTimeline();
            renderStaffNotation();
        }

        function addSection() {
            openModal('addSectionModal');
        }

        function createSection() {
            const name = document.getElementById('newSectionName').value.trim() || 'Custom';
            const type = document.getElementById('newSectionType').value;
            const bars = parseInt(document.getElementById('newSectionBars').value);

            saveState();

            // Create unique section ID
            const sectionId = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();

            // Generate default chords based on bars
            const chords = [];
            for (let i = 0; i < bars; i++) {
                chords.push(state.progression[i % state.progression.length] || 'C');
            }

            // Add to state
            state.songSections[sectionId] = chords;
            state.sectionOrder.push(sectionId);

            // Get icon based on type
            const icons = {
                custom: '‚ú®', intro: 'üé¨', verse: 'üìù', prechorus: 'üîÑ',
                chorus: 'üé§', bridge: 'üåâ', breakdown: 'üí•', solo: 'üé∏', outro: 'üèÅ'
            };

            closeModal('addSectionModal');
            renderSections();
            showToast(`Added "${name}" section`);
            triggerHaptic('success');

            // Clear form
            document.getElementById('newSectionName').value = '';

            // Increment song count
            state.userProfile.songsCreated++;
            saveUserProfile();
        }

        function renderSections() {
            const container = document.getElementById('songSections');
            const icons = {
                intro: 'üé¨', verse1: 'üìù', verse2: 'üìù', chorus: 'üé§',
                bridge: 'üåâ', outro: 'üèÅ', custom: '‚ú®'
            };

            let html = state.sectionOrder.map(section => {
                const chords = state.songSections[section] || [];
                const icon = icons[section] || icons[section.split('-')[0]] || '‚ú®';
                const displayName = section.replace(/[-_]/g, ' ').replace(/\d+/g, match => ' ' + match);
                const isActive = section === state.currentSection;

                return `
                    <div class="song-section ${isActive ? 'active' : ''}" onclick="selectSection('${section}')">
                        <div class="icon">${icon}</div>
                        <div class="name">${displayName}</div>
                        <div class="count">${chords.length} bars</div>
                    </div>
                `;
            }).join('');

            html += '<button class="add-section-btn" onclick="addSection()">+</button>';
            container.innerHTML = html;
        }

        function addChordToTimeline() {
            saveState();
            state.progression.push('C');
            state.songSections[state.currentSection] = [...state.progression];
            renderChords();
            renderTimeline();
            renderStaffNotation();
            showToast('Added chord');
        }

        // =============================================
        // DRAG AND DROP
        // =============================================
        let draggedChordIndex = null;

        function dragChord(e, index) {
            draggedChordIndex = index;
            e.dataTransfer.setData('text/plain', index);
            e.target.classList.add('dragging');
        }

        function dragOver(e, index) {
            e.preventDefault();
            document.querySelectorAll('.timeline-chord').forEach(c => c.classList.remove('drag-over'));
            e.target.closest('.timeline-chord')?.classList.add('drag-over');
        }

        function dragLeave(e) {
            e.target.closest('.timeline-chord')?.classList.remove('drag-over');
        }

        function dropChord(e, targetIndex) {
            e.preventDefault();
            document.querySelectorAll('.timeline-chord').forEach(c => {
                c.classList.remove('dragging', 'drag-over');
            });

            if (draggedChordIndex === null || draggedChordIndex === targetIndex) return;

            saveState();

            // Reorder the progression
            const chord = state.progression.splice(draggedChordIndex, 1)[0];
            state.progression.splice(targetIndex, 0, chord);
            state.songSections[state.currentSection] = [...state.progression];

            draggedChordIndex = null;
            renderChords();
            renderTimeline();
            renderStaffNotation();
            showToast('Chord reordered');
            triggerHaptic('light');
        }

        function zoomTimeline(direction) {
            state.zoomLevel = Math.max(50, Math.min(200, state.zoomLevel + direction * 25));
            document.getElementById('zoomLevel').textContent = state.zoomLevel + '%';

            const timeline = document.getElementById('chordTimeline');
            const scale = state.zoomLevel / 100;
            timeline.style.transform = `scaleX(${scale})`;
            timeline.style.transformOrigin = 'left center';

            showToast(`Zoom: ${state.zoomLevel}%`);
        }

        function syncLyrics() {
            const lyrics = document.getElementById('lyricsInput').value;
            if (lyrics.trim()) {
                showToast('üîó Lyrics synced to chords!');
            } else {
                showToast('Enter lyrics first');
            }
        }

        // =============================================
        // AI FUNCTIONS
        // =============================================
        async function aiGenerate(type) {
            const btn = event?.target?.closest('.ai-btn') || event?.target?.closest('.big-generate-btn');
            const originalText = btn ? btn.innerHTML : "";
            if (btn) { btn.classList.add('loading'); btn.innerHTML = '<div class="spinner"></div> Generating...'; }
            
            try {
                const prompts = {
                    progression: `Generate a ${state.genre} chord progression in the key of ${state.key}. Return ONLY a JSON array of 4 chord names like ["C", "G", "Am", "F"]. No other text.`,
                    continue: `Continue this ${state.genre} chord progression: ${state.progression.join(', ')}. Add 2-4 more chords. Return ONLY a JSON array like ["Em", "Dm", "G", "C"]. No other text.`,
                    variation: `Create a variation of this progression: ${state.progression.join(', ')} in ${state.key}. Return ONLY a JSON array of 4 chord names. No other text.`,
                    modulate: `Suggest a key modulation from ${state.key}. Return ONLY a JSON array of 4 chords in the new key. No other text.`
                };
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompts[type] || prompts.progression, action: type })
                });
                
                const data = await response.json();
                
                if (data.result) {
                    const jsonMatch = data.result.match(/\[[\s\S]*?\]/);
                    if (jsonMatch) {
                        const chords = JSON.parse(jsonMatch[0]);
                        if (Array.isArray(chords) && chords.length > 0) {
                            const validChords = chords.filter(c => chordNotes[c]);
                            if (validChords.length > 0) {
                                state.progression = validChords;
                                renderChords(); renderTimeline(); updatePlaybackInfo();
                                showToast('‚ú® AI progression generated!');
                            } else { throw new Error('Invalid chords'); }
                        }
                    } else { throw new Error('No chords found'); }
                } else if (data.error) { throw new Error(data.error); }
            } catch (err) {
                console.error('AI Generate error:', err);
                generateProgression();
                showToast('üé≤ Random progression generated!');
            }
            
            if (btn) { btn.classList.remove('loading'); btn.innerHTML = originalText; }
        }

        async function aiGenerateLyrics() {
            showToast('‚ú® Generating lyrics...');
            const lyrics = document.getElementById('lyricsInput');
            
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Write short song lyrics for a ${state.genre} song. Chord progression: ${state.progression.join(' - ')}. Key: ${state.key}. Write a verse (4 lines) and chorus (4 lines). Keep it simple.`
                    })
                });
                
                const data = await response.json();
                if (data.result) { lyrics.value = data.result; showToast('‚ú® AI lyrics generated!'); } 
                else { throw new Error('No lyrics'); }
            } catch (err) {
                lyrics.value = `Verse 1:\n${state.progression[0]} - Walking down the road today\n${state.progression[1]} - Feeling like I've found my way\n${state.progression[2]} - Everything is falling into place\n${state.progression[3] || 'C'} - I can see the smile on your face\n\nChorus:\n${state.progression[0]} - This is where I want to be\n${state.progression[1]} - You and me, finally free`;
                showToast('üìù Default lyrics added');
            }
        }

        // =============================================
        // VOICING SELECTOR
        // =============================================
        const voicings = {
            root: (notes) => notes,
            first: (notes) => [...notes.slice(1), shiftOctave(notes[0], 1)],
            second: (notes) => [...notes.slice(2), shiftOctave(notes[0], 1), shiftOctave(notes[1], 1)],
            drop2: (notes) => {
                if (notes.length < 4) return notes;
                return [notes[0], shiftOctave(notes[2], -1), notes[1], notes[3]];
            },
            drop3: (notes) => {
                if (notes.length < 4) return notes;
                return [notes[0], shiftOctave(notes[1], -1), notes[2], notes[3]];
            },
            spread: (notes) => notes.map((n, i) => i % 2 === 0 ? n : shiftOctave(n, 1))
        };

        function shiftOctave(note, shift) {
            const match = note.match(/([A-G][#b]?)(\d)/);
            if (!match) return note;
            return match[1] + (parseInt(match[2]) + shift);
        }

        function setVoicing(voicing) {
            state.currentVoicing = voicing;
            document.querySelectorAll('.voicing-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            showToast(`Voicing: ${voicing}`);
            triggerHaptic('light');
        }

        function applyVoicing(notes) {
            const voicingFn = voicings[state.currentVoicing] || voicings.root;
            return voicingFn(notes);
        }

        // =============================================
        // STAFF NOTATION
        // =============================================
        function renderStaffNotation() {
            const canvas = document.getElementById('staffCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // Draw staff lines
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            const staffTop = 40;
            const lineSpacing = 12;

            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(20, staffTop + i * lineSpacing);
                ctx.lineTo(width - 20, staffTop + i * lineSpacing);
                ctx.stroke();
            }

            // Draw treble clef (simplified)
            ctx.font = '48px serif';
            ctx.fillStyle = '#333333';
            ctx.fillText('ùÑû', 25, staffTop + 4 * lineSpacing - 5);

            // Draw chord names above staff
            const chordWidth = (width - 100) / state.progression.length;
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#667eea';

            state.progression.forEach((chord, i) => {
                const x = 80 + i * chordWidth;

                // Chord name
                ctx.fillText(chord, x, 20);

                // Draw note heads (simplified representation)
                const notes = chordNotes[chord] || chordNotes['C'];
                ctx.fillStyle = '#333333';
                notes.forEach((note, j) => {
                    const notePos = getNoteYPosition(note, staffTop, lineSpacing);
                    ctx.beginPath();
                    ctx.ellipse(x + 15, notePos, 6, 5, 0, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.fillStyle = '#667eea';
            });
        }

        function getNoteYPosition(note, staffTop, lineSpacing) {
            const noteMap = {
                'C4': staffTop + 5 * lineSpacing,
                'D4': staffTop + 4.5 * lineSpacing,
                'E4': staffTop + 4 * lineSpacing,
                'F4': staffTop + 3.5 * lineSpacing,
                'G4': staffTop + 3 * lineSpacing,
                'A4': staffTop + 2.5 * lineSpacing,
                'B4': staffTop + 2 * lineSpacing,
                'C5': staffTop + 1.5 * lineSpacing,
                'D5': staffTop + 1 * lineSpacing,
                'E5': staffTop + 0.5 * lineSpacing,
                'F5': staffTop,
                'G5': staffTop - 0.5 * lineSpacing
            };
            // Handle sharps/flats by removing them for position
            const baseNote = note.replace('#', '').replace('b', '');
            return noteMap[baseNote] || staffTop + 3 * lineSpacing;
        }

        // =============================================
        // PDF EXPORT (Sheet Music)
        // =============================================
        function exportPDF() {
            showToast('üìÑ Generating PDF...');
            triggerHaptic('medium');

            // Create a printable version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>ChordFlow - ${state.progression.join(' - ')}</title>
                    <style>
                        body { font-family: Georgia, serif; padding: 40px; }
                        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        .info { color: #666; margin-bottom: 20px; }
                        .progression { font-size: 24px; margin: 30px 0; }
                        .chord { display: inline-block; padding: 15px 25px; margin: 5px;
                                 background: #f5f5f5; border-radius: 8px; }
                        .sections { margin-top: 30px; }
                        .section { margin: 15px 0; padding: 15px; background: #fafafa; border-left: 4px solid #667eea; }
                        .section-name { font-weight: bold; color: #333; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>üéµ ChordFlow Sheet</h1>
                    <div class="info">Key: ${state.key} | Genre: ${state.genre} | Tempo: ${state.tempo} BPM</div>
                    <h2>Main Progression</h2>
                    <div class="progression">
                        ${state.progression.map(c => `<span class="chord">${c}</span>`).join(' ‚Üí ')}
                    </div>
                    <div class="sections">
                        <h2>Song Sections</h2>
                        ${state.sectionOrder.map(section => `
                            <div class="section">
                                <div class="section-name">${section}</div>
                                <div>${(state.songSections[section] || []).join(' ‚Üí ')}</div>
                            </div>
                        `).join('')}
                    </div>
                    <p style="margin-top:40px;color:#999;font-size:12px;">Generated by ChordFlow v12.0</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // =============================================
        // EAR TRAINING
        // =============================================
        const earTrainingChords = ['C', 'Am', 'F', 'G', 'Dm', 'Em', 'Cmaj7', 'Am7'];

        function playEarTrainingChord() {
            initAudio().then(() => {
                // Pick random chord
                state.earTraining.currentChord = earTrainingChords[Math.floor(Math.random() * earTrainingChords.length)];

                const notes = chordNotes[state.earTraining.currentChord];
                if (mainSynth) {
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    mainSynth.triggerAttackRelease(notes, '1n');
                }

                // Reset button states
                document.querySelectorAll('.ear-btn').forEach(b => {
                    b.classList.remove('correct', 'incorrect');
                });

                showToast('üéµ Listen and guess!');
                triggerHaptic('medium');
            });
        }

        function guessChord(guess) {
            if (!state.earTraining.currentChord) {
                showToast('Press üîä to hear a chord first');
                return;
            }

            state.earTraining.total++;
            const isCorrect = guess === state.earTraining.currentChord;

            if (isCorrect) {
                state.earTraining.correct++;
                event.target.classList.add('correct');
                showToast('‚úÖ Correct!');
                triggerHaptic('success');
                state.practiceStats.streak++;
            } else {
                event.target.classList.add('incorrect');
                showToast(`‚ùå It was ${state.earTraining.currentChord}`);
                triggerHaptic('error');
                state.practiceStats.streak = 0;
            }

            // Update score display
            document.getElementById('earTrainingScore').textContent =
                `${state.earTraining.correct}/${state.earTraining.total}`;
            document.getElementById('practiceStreak').textContent = state.practiceStats.streak;

            // Calculate accuracy
            const accuracy = Math.round((state.earTraining.correct / state.earTraining.total) * 100);
            document.getElementById('practiceAccuracy').textContent = accuracy + '%';

            // Update weekly progress
            const dayIndex = new Date().getDay();
            state.weeklyProgress[dayIndex] = Math.max(state.weeklyProgress[dayIndex], accuracy);
            updateProgressChart();
            saveProgress();

            // Reset for next round
            setTimeout(() => {
                state.earTraining.currentChord = null;
            }, 1000);
        }

        function updateProgressChart() {
            const bars = document.getElementById('progressBars');
            if (!bars) return;

            bars.innerHTML = state.weeklyProgress.map(p =>
                `<div class="progress-bar-item" style="height: ${Math.max(5, p)}%"></div>`
            ).join('');
        }

        // =============================================
        // USER PROFILE & PROGRESS
        // =============================================
        function loadUserProfile() {
            const saved = localStorage.getItem('chordflow-profile');
            if (saved) {
                Object.assign(state.userProfile, JSON.parse(saved));
            }
            const progress = localStorage.getItem('chordflow-progress');
            if (progress) {
                state.weeklyProgress = JSON.parse(progress);
            }
            updateProfileDisplay();
        }

        function saveUserProfile() {
            localStorage.setItem('chordflow-profile', JSON.stringify(state.userProfile));
            updateProfileDisplay();
        }

        function saveProgress() {
            localStorage.setItem('chordflow-progress', JSON.stringify(state.weeklyProgress));
        }

        function updateProfileDisplay() {
            document.getElementById('profileName').textContent = state.userProfile.name;
            document.getElementById('statSongs').textContent = state.userProfile.songsCreated;
            document.getElementById('statPractice').textContent = state.userProfile.practiceMinutes;
            document.getElementById('statStreak').textContent = state.userProfile.dayStreak;
        }

        function exportProfile() {
            const data = {
                profile: state.userProfile,
                progress: state.weeklyProgress,
                earTraining: state.earTraining,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chordflow-profile-${Date.now()}.json`;
            a.click();
            showToast('Profile data exported');
        }

        function clearProgress() {
            if (confirm('Are you sure you want to reset all progress?')) {
                state.userProfile = {
                    name: 'Music Creator',
                    songsCreated: 0,
                    practiceMinutes: 0,
                    dayStreak: 0,
                    lastPractice: null
                };
                state.weeklyProgress = [0, 0, 0, 0, 0, 0, 0];
                state.earTraining = { currentChord: null, correct: 0, total: 0 };
                saveUserProfile();
                saveProgress();
                updateProgressChart();
                showToast('Progress reset');
            }
        }

        // =============================================
        // COLLABORATION
        // =============================================
        function startCollabSession() {
            const sessionId = Math.random().toString(36).substring(2, 10);
            state.collabSession = sessionId;
            showToast(`ü§ù Collab session: ${sessionId}`);
            triggerHaptic('medium');

            // In a real implementation, this would connect to a WebSocket server
            document.getElementById('collabUsers').innerHTML = `
                <div class="collab-avatar">üë§</div>
                <div class="collab-avatar" style="background: var(--success);">+</div>
            `;
        }

        function copyCollabLink() {
            const link = state.collabSession
                ? `${window.location.origin}?collab=${state.collabSession}`
                : window.location.href;
            navigator.clipboard.writeText(link);
            showToast('üìã Link copied!');
            triggerHaptic('light');
        }

        // =============================================
        // KEYBOARD SHORTCUTS
        // =============================================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                // Space - Play/Pause
                if (e.code === 'Space') {
                    e.preventDefault();
                    togglePlayback();
                }

                // Escape - Stop
                if (e.code === 'Escape') {
                    stopPlayback();
                    closeAllModals();
                }

                // G - Generate
                if (e.key === 'g' && !e.ctrlKey && !e.metaKey) {
                    aiGenerate('progression');
                }

                // R - Record
                if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
                    toggleRecording();
                }

                // Ctrl+Z - Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }

                // Ctrl+Y or Ctrl+Shift+Z - Redo
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    redo();
                }

                // Ctrl+E - Export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportAudio('mp3');
                }

                // Ctrl+S - Save/Share
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    shareSong();
                }

                // + / = - Tempo up
                if (e.key === '+' || e.key === '=') {
                    adjustTempo(5);
                }

                // - - Tempo down
                if (e.key === '-') {
                    adjustTempo(-5);
                }

                // 1-4 - Play chord
                if (['1', '2', '3', '4'].includes(e.key)) {
                    const index = parseInt(e.key) - 1;
                    if (index < state.progression.length) {
                        playChord(state.progression[index], index);
                    }
                }
            });
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        // =============================================
        // HAPTIC FEEDBACK (Mobile)
        // =============================================
        function triggerHaptic(type) {
            if ('vibrate' in navigator) {
                switch (type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(25);
                        break;
                    case 'success':
                        navigator.vibrate([10, 50, 10]);
                        break;
                    case 'error':
                        navigator.vibrate([50, 50, 50]);
                        break;
                    default:
                        navigator.vibrate(15);
                }
            }
        }

        // =============================================
        // THEME
        // =============================================
        function setTheme(theme) {
            document.querySelectorAll('.theme-option').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.body.classList.remove('theme-light', 'theme-midnight', 'theme-ocean', 'theme-forest');
            if (theme !== 'dark') document.body.classList.add('theme-' + theme);
            localStorage.setItem('chordflow-theme', theme);
            closeModal('themeModal');
            showToast(`Theme: ${theme}`);
            triggerHaptic('light');
        }

        // =============================================
        // MODALS & TOAST
        // =============================================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            triggerHaptic('light');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // =============================================
        // INIT
        // =============================================
        function init() {
            renderInstruments();
            generateProgression();
            renderTimeline();
            renderSections();
            renderStaffNotation();
            updateWaveform(false);
            updateModulationKeys();
            updateProgressChart();
            loadUserProfile();
            setupKeyboardShortcuts();

            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme && savedTheme !== 'dark') {
                document.body.classList.add('theme-' + savedTheme);
            }

            console.log('üéµ ChordFlow v12.0 - Complete Music Production Suite initialized');
            console.log('‚å®Ô∏è Press Space to play, G to generate, R to record');
        }

        init();
    </script>
</body>
</html>
