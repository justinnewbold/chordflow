<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v10.1 - Full Band Mode + AI</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--safe-bottom) + 180px);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-badge { font-size: 10px; background: var(--success); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
        .ai-badge { font-size: 10px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 4px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        
        /* Band Mode Toggle */
        .band-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            margin: 16px 20px;
            gap: 4px;
        }
        .band-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .band-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        /* AI Actions Bar */
        .ai-actions {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .ai-btn:hover, .ai-btn:active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(236, 72, 153, 0.4));
            transform: scale(0.98);
        }
        .ai-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .ai-btn .sparkle { font-size: 16px; }
        
        /* Instrument Categories */
        .instrument-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        /* Instrument Grid */
        .instrument-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none;
        }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card {
            min-width: 100px;
            padding: 14px 12px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .instrument-card.active {
            border-color: var(--accent);
            background: rgba(102, 126, 234, 0.15);
        }
        .instrument-card .icon { font-size: 28px; margin-bottom: 6px; }
        .instrument-card .name { font-size: 11px; color: var(--text-secondary); }
        .instrument-card.active .name { color: var(--text-primary); }
        
        /* Chord Display */
        .chord-section {
            padding: 16px 20px;
        }
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .chord-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 22px; font-weight: 700; }
        .chord-numeral { font-size: 11px; color: var(--accent-light); margin-top: 4px; }
        
        /* Drum Pattern Selector */
        .pattern-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .pattern-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pattern-card.active { border-color: var(--drums); }
        .pattern-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .pattern-icon { font-size: 20px; }
        .pattern-name { font-size: 13px; font-weight: 600; }
        .pattern-viz { display: flex; gap: 3px; }
        .beat { flex: 1; height: 24px; background: var(--bg-primary); border-radius: 4px; display: flex; flex-direction: column; gap: 2px; padding: 2px; }
        .beat-line { flex: 1; border-radius: 2px; background: var(--bg-secondary); }
        .beat-line.active { background: var(--drums); }
        .beat-line.accent { background: var(--warning); }
        
        /* Bass Pattern */
        .bass-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .bass-options {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .bass-option {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .bass-option.active { border-color: var(--bass); background: rgba(239, 68, 68, 0.15); }
        
        /* Controls Row */
        .controls-row {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 16px;
        }
        .control-group { flex: 1; }
        .control-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .control-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        /* Playback Bar */
        .playback-bar {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary));
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 12px 20px;
            z-index: 200;
        }
        .playback-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 14px; font-weight: 600; }
        .playback-sub { font-size: 12px; color: var(--text-secondary); }
        .tempo-control { display: flex; align-items: center; gap: 6px; }
        .tempo-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
        }
        .tempo-display { font-size: 14px; font-weight: 600; min-width: 55px; text-align: center; }
        
        /* Active Instruments Bar */
        .active-instruments {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .active-inst {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
        }
        .active-inst .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }
        
        /* All Instruments Grid in Modal */
        .all-instruments-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .inst-item {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .inst-item.active { border-color: var(--accent); }
        .inst-item .icon { font-size: 24px; margin-bottom: 6px; }
        .inst-item .name { font-size: 11px; }
        .inst-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 16px 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* AI Response Modal */
        .ai-response {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        .ai-response h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--ai-purple);
        }
        .ai-suggestions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .ai-suggestion-btn {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .ai-suggestion-btn:hover {
            background: var(--accent);
        }
        
        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v10.1</span><span class="ai-badge">AI</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openModal('instrumentsModal')">üéπ</button>
            <button class="icon-btn" onclick="openModal('mixerModal')">üéöÔ∏è</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- AI Actions Bar -->
    <div class="ai-actions">
        <button class="ai-btn" onclick="aiGenerate('progression')">
            <span class="sparkle">‚ú®</span>
            AI Generate
        </button>
        <button class="ai-btn" onclick="aiGenerate('continue')">
            <span class="sparkle">üîÆ</span>
            Continue
        </button>
        <button class="ai-btn" onclick="aiGenerate('variation')">
            <span class="sparkle">üé≤</span>
            Variation
        </button>
        <button class="ai-btn" onclick="aiGenerate('style')">
            <span class="sparkle">üé≠</span>
            Style Match
        </button>
        <button class="ai-btn" onclick="aiGenerate('surprise')">
            <span class="sparkle">üåü</span>
            Surprise Me
        </button>
    </div>

    <!-- Band Mode Toggle -->
    <div class="band-toggle">
        <button class="active" onclick="setMode('solo')">Solo</button>
        <button onclick="setMode('duo')">Duo</button>
        <button onclick="setMode('band')">Full Band</button>
        <button onclick="setMode('orchestra')">Orchestra</button>
    </div>

    <!-- Keys Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--keys)"></span>
                üéπ Keys
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card active" data-inst="grand-piano" onclick="selectInstrument(this, 'keys', 'grand-piano')">
                <div class="icon">üéπ</div>
                <div class="name">Grand Piano</div>
            </div>
            <div class="instrument-card" data-inst="electric-piano" onclick="selectInstrument(this, 'keys', 'electric-piano')">
                <div class="icon">üéπ</div>
                <div class="name">Electric Piano</div>
            </div>
            <div class="instrument-card" data-inst="organ" onclick="selectInstrument(this, 'keys', 'organ')">
                <div class="icon">üéöÔ∏è</div>
                <div class="name">Organ</div>
            </div>
            <div class="instrument-card" data-inst="synth-pad" onclick="selectInstrument(this, 'keys', 'synth-pad')">
                <div class="icon">üéõÔ∏è</div>
                <div class="name">Synth Pad</div>
            </div>
            <div class="instrument-card" data-inst="clavinet" onclick="selectInstrument(this, 'keys', 'clavinet')">
                <div class="icon">üéπ</div>
                <div class="name">Clavinet</div>
            </div>
            <div class="instrument-card" data-inst="harpsichord" onclick="selectInstrument(this, 'keys', 'harpsichord')">
                <div class="icon">üéº</div>
                <div class="name">Harpsichord</div>
            </div>
        </div>
    </div>

    <!-- Guitar Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--guitar)"></span>
                üé∏ Guitars
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="acoustic-guitar" onclick="selectInstrument(this, 'guitar', 'acoustic-guitar')">
                <div class="icon">üé∏</div>
                <div class="name">Acoustic</div>
            </div>
            <div class="instrument-card" data-inst="electric-clean" onclick="selectInstrument(this, 'guitar', 'electric-clean')">
                <div class="icon">üé∏</div>
                <div class="name">Electric Clean</div>
            </div>
            <div class="instrument-card" data-inst="electric-overdrive" onclick="selectInstrument(this, 'guitar', 'electric-overdrive')">
                <div class="icon">üé∏</div>
                <div class="name">Overdrive</div>
            </div>
            <div class="instrument-card" data-inst="electric-distorted" onclick="selectInstrument(this, 'guitar', 'electric-distorted')">
                <div class="icon">üî•</div>
                <div class="name">Distorted</div>
            </div>
            <div class="instrument-card" data-inst="nylon-guitar" onclick="selectInstrument(this, 'guitar', 'nylon-guitar')">
                <div class="icon">üé∏</div>
                <div class="name">Nylon</div>
            </div>
        </div>
    </div>

    <!-- Bass Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--bass)"></span>
                üé∏ Bass
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card active" data-inst="electric-bass" onclick="selectInstrument(this, 'bass', 'electric-bass')">
                <div class="icon">üé∏</div>
                <div class="name">Electric Bass</div>
            </div>
            <div class="instrument-card" data-inst="synth-bass" onclick="selectInstrument(this, 'bass', 'synth-bass')">
                <div class="icon">üéõÔ∏è</div>
                <div class="name">Synth Bass</div>
            </div>
            <div class="instrument-card" data-inst="upright-bass" onclick="selectInstrument(this, 'bass', 'upright-bass')">
                <div class="icon">üéª</div>
                <div class="name">Upright</div>
            </div>
            <div class="instrument-card" data-inst="slap-bass" onclick="selectInstrument(this, 'bass', 'slap-bass')">
                <div class="icon">üëã</div>
                <div class="name">Slap Bass</div>
            </div>
            <div class="instrument-card" data-inst="sub-bass" onclick="selectInstrument(this, 'bass', 'sub-bass')">
                <div class="icon">üì¢</div>
                <div class="name">Sub Bass</div>
            </div>
        </div>
    </div>

    <!-- Drums Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--drums)"></span>
                ü•Å Drums
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card active" data-inst="acoustic-kit" onclick="selectInstrument(this, 'drums', 'acoustic-kit')">
                <div class="icon">ü•Å</div>
                <div class="name">Acoustic Kit</div>
            </div>
            <div class="instrument-card" data-inst="electronic-kit" onclick="selectInstrument(this, 'drums', 'electronic-kit')">
                <div class="icon">üéõÔ∏è</div>
                <div class="name">Electronic</div>
            </div>
            <div class="instrument-card" data-inst="lofi-kit" onclick="selectInstrument(this, 'drums', 'lofi-kit')">
                <div class="icon">üìª</div>
                <div class="name">Lo-Fi</div>
            </div>
            <div class="instrument-card" data-inst="808-kit" onclick="selectInstrument(this, 'drums', '808-kit')">
                <div class="icon">üí•</div>
                <div class="name">808 Trap</div>
            </div>
            <div class="instrument-card" data-inst="brushes-kit" onclick="selectInstrument(this, 'drums', 'brushes-kit')">
                <div class="icon">üñåÔ∏è</div>
                <div class="name">Jazz Brushes</div>
            </div>
        </div>
    </div>

    <!-- Strings & Brass Section -->
    <div class="instrument-section">
        <div class="section-header">
            <div class="section-title">
                <span class="dot" style="background: var(--strings)"></span>
                üéª Strings & Brass
            </div>
        </div>
        <div class="instrument-scroll">
            <div class="instrument-card" data-inst="strings" onclick="selectInstrument(this, 'strings', 'strings')">
                <div class="icon">üéª</div>
                <div class="name">Strings</div>
            </div>
            <div class="instrument-card" data-inst="cello" onclick="selectInstrument(this, 'strings', 'cello')">
                <div class="icon">üéª</div>
                <div class="name">Cello</div>
            </div>
            <div class="instrument-card" data-inst="trumpet" onclick="selectInstrument(this, 'brass', 'trumpet')">
                <div class="icon">üé∫</div>
                <div class="name">Trumpet</div>
            </div>
            <div class="instrument-card" data-inst="saxophone" onclick="selectInstrument(this, 'brass', 'saxophone')">
                <div class="icon">üé∑</div>
                <div class="name">Saxophone</div>
            </div>
            <div class="instrument-card" data-inst="choir" onclick="selectInstrument(this, 'strings', 'choir')">
                <div class="icon">üé§</div>
                <div class="name">Choir</div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-row">
        <div class="control-group">
            <div class="control-label">Key</div>
            <select class="control-select" id="keySelect" onchange="updateKey()">
                <option value="C">C Major</option>
                <option value="G">G Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
                <option value="F">F Major</option>
                <option value="Bb">Bb Major</option>
                <option value="Am">A Minor</option>
                <option value="Em">E Minor</option>
                <option value="Dm">D Minor</option>
            </select>
        </div>
        <div class="control-group">
            <div class="control-label">Genre</div>
            <select class="control-select" id="genreSelect" onchange="updateGenre()">
                <option value="pop">Pop</option>
                <option value="rock">Rock</option>
                <option value="jazz">Jazz</option>
                <option value="blues">Blues</option>
                <option value="rnb">R&B</option>
                <option value="country">Country</option>
                <option value="edm">EDM</option>
                <option value="lofi">Lo-Fi</option>
                <option value="classical">Classical</option>
                <option value="gospel">Gospel</option>
            </select>
        </div>
    </div>

    <!-- Chord Display -->
    <div class="chord-section">
        <div class="section-header">
            <div class="section-title">üé∂ Progression</div>
            <div style="display: flex; gap: 8px;">
                <button class="icon-btn" style="width:36px;height:36px;font-size:16px;background:linear-gradient(135deg, var(--ai-purple), #ec4899);" onclick="aiGenerate('progression')">‚ú®</button>
                <button class="icon-btn" style="width:36px;height:36px;font-size:16px;" onclick="generateProgression()">üé≤</button>
            </div>
        </div>
        <div class="chord-grid" id="chordGrid">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Mixer Modal -->
    <div class="modal" id="mixerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üéöÔ∏è Mixer</div>
                <button class="close-btn" onclick="closeModal('mixerModal')">‚úï</button>
            </div>
            <div class="mixer-tracks" id="mixerTracks">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 16px 0;">
                <div style="margin-bottom: 16px;">
                    <div class="control-label">Master Volume</div>
                    <input type="range" min="0" max="100" value="80" style="width: 100%;" onchange="setMasterVolume(this.value)">
                </div>
                <div style="margin-bottom: 16px;">
                    <div class="control-label">Swing Amount</div>
                    <input type="range" min="0" max="100" value="0" style="width: 100%;" onchange="setSwing(this.value)">
                </div>
            </div>
        </div>
    </div>

    <!-- Instruments Modal -->
    <div class="modal" id="instrumentsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üéπ All Instruments</div>
                <button class="close-btn" onclick="closeModal('instrumentsModal')">‚úï</button>
            </div>
            
            <div class="inst-category">üéπ Keys</div>
            <div class="all-instruments-grid">
                <div class="inst-item active" onclick="toggleInst(this)"><div class="icon">üéπ</div><div class="name">Grand Piano</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéπ</div><div class="name">Electric Piano</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéöÔ∏è</div><div class="name">Organ</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéõÔ∏è</div><div class="name">Synth Pad</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéº</div><div class="name">Harpsichord</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéµ</div><div class="name">Music Box</div></div>
            </div>
            
            <div class="inst-category">üé∏ Guitars</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üé∏</div><div class="name">Acoustic</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üé∏</div><div class="name">Electric Clean</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üî•</div><div class="name">Distorted</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üé∏</div><div class="name">Nylon</div></div>
            </div>
            
            <div class="inst-category">üé∏ Bass</div>
            <div class="all-instruments-grid">
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üé∏</div><div class="name">Electric Bass</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéõÔ∏è</div><div class="name">Synth Bass</div></div>
                <div class="inst-item" onclick="toggleInst(this)"><div class="icon">üéª</div><div class="name">Upright</div></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // =============================================
        // STATE
        // =============================================
        const state = {
            mode: 'solo',
            tempo: 120,
            key: 'C',
            genre: 'pop',
            isPlaying: false,
            progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano',
            currentBass: 'electric-bass',
            currentDrums: 'acoustic-kit',
            activeInstruments: [
                { name: 'Grand Piano', category: 'keys', color: '#667eea', volume: 80, muted: false, solo: false }
            ],
            drumPattern: 'rock',
            bassPattern: 'root',
            masterVolume: 0.8
        };

        // =============================================
        // INSTRUMENT SOUND DEFINITIONS
        // =============================================
        const instrumentConfigs = {
            // Keys
            'grand-piano': {
                oscillator: { type: 'triangle8' },
                envelope: { attack: 0.005, decay: 0.3, sustain: 0.3, release: 1.2 }
            },
            'electric-piano': {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.5, sustain: 0.2, release: 0.8 },
                modulation: { type: 'square' },
                modulationIndex: 2
            },
            'organ': {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.9, release: 0.1 }
            },
            'synth-pad': {
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.5, decay: 0.5, sustain: 0.8, release: 2 },
                filterEnvelope: { attack: 0.5, decay: 0.2, sustain: 0.5, release: 2 }
            },
            'clavinet': {
                oscillator: { type: 'pulse' },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.3 }
            },
            'harpsichord': {
                oscillator: { type: 'sawtooth8' },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.4 }
            },
            // Guitars
            'acoustic-guitar': {
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.002, decay: 0.3, sustain: 0.2, release: 0.8 }
            },
            'electric-clean': {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.3, release: 0.6 }
            },
            'electric-overdrive': {
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.5, release: 0.4 }
            },
            'electric-distorted': {
                oscillator: { type: 'fatsquare' },
                envelope: { attack: 0.02, decay: 0.2, sustain: 0.6, release: 0.3 }
            },
            'nylon-guitar': {
                oscillator: { type: 'sine4' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            },
            // Bass
            'electric-bass': {
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.8, release: 0.3 },
                filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.2, baseFrequency: 200, octaves: 2.5 }
            },
            'synth-bass': {
                oscillator: { type: 'square' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0.9, release: 0.1 },
                filterEnvelope: { attack: 0.05, decay: 0.3, sustain: 0.3, release: 0.2, baseFrequency: 150, octaves: 3 }
            },
            'upright-bass': {
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.05, decay: 0.4, sustain: 0.3, release: 0.8 }
            },
            'slap-bass': {
                oscillator: { type: 'fatsawtooth' },
                envelope: { attack: 0.001, decay: 0.15, sustain: 0.4, release: 0.2 }
            },
            'sub-bass': {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.9, release: 0.5 }
            },
            // Strings
            'strings': {
                oscillator: { type: 'fatsawtooth' },
                envelope: { attack: 0.3, decay: 0.4, sustain: 0.7, release: 1.5 }
            },
            'cello': {
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.2, decay: 0.3, sustain: 0.6, release: 1 }
            },
            'choir': {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.5, decay: 0.5, sustain: 0.8, release: 2 }
            },
            // Brass
            'trumpet': {
                oscillator: { type: 'square' },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.7, release: 0.4 }
            },
            'saxophone': {
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.1, decay: 0.2, sustain: 0.6, release: 0.5 }
            }
        };

        const drumConfigs = {
            'acoustic-kit': { kickFreq: 60, snareDecay: 0.2, hihatDecay: 0.1 },
            'electronic-kit': { kickFreq: 50, snareDecay: 0.15, hihatDecay: 0.08 },
            'lofi-kit': { kickFreq: 55, snareDecay: 0.25, hihatDecay: 0.15 },
            '808-kit': { kickFreq: 40, snareDecay: 0.3, hihatDecay: 0.05 },
            'brushes-kit': { kickFreq: 70, snareDecay: 0.35, hihatDecay: 0.2 }
        };

        // =============================================
        // AUDIO ENGINE
        // =============================================
        let mainSynth, bassSynth, drumSynth, stringSynth, brassSynth;
        let reverb, delay;
        
        async function initAudio() {
            await Tone.start();
            
            // Effects
            reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).toDestination();
            delay = new Tone.FeedbackDelay({ delayTime: '8n', feedback: 0.2, wet: 0.15 }).connect(reverb);
            
            // Main synth for chords - uses current instrument config
            updateMainSynth();
            
            // Bass synth
            updateBassSynth();
            
            // Drum synth
            updateDrumSynth();
            
            // String synth for orchestra mode
            stringSynth = new Tone.PolySynth(Tone.Synth).connect(reverb);
            stringSynth.set(instrumentConfigs['strings']);
            stringSynth.volume.value = -10;
            
            // Brass synth
            brassSynth = new Tone.PolySynth(Tone.Synth).connect(reverb);
            brassSynth.set(instrumentConfigs['trumpet']);
            brassSynth.volume.value = -12;
        }

        function updateMainSynth() {
            if (mainSynth) mainSynth.dispose();
            
            const config = instrumentConfigs[state.currentInstrument] || instrumentConfigs['grand-piano'];
            mainSynth = new Tone.PolySynth(Tone.Synth).connect(delay);
            mainSynth.set(config);
            mainSynth.volume.value = -6;
        }

        function updateBassSynth() {
            if (bassSynth) bassSynth.dispose();
            
            const config = instrumentConfigs[state.currentBass] || instrumentConfigs['electric-bass'];
            bassSynth = new Tone.MonoSynth().connect(reverb);
            bassSynth.set({
                oscillator: config.oscillator,
                envelope: config.envelope
            });
            if (config.filterEnvelope) {
                bassSynth.filterEnvelope.set(config.filterEnvelope);
            }
            bassSynth.volume.value = -8;
        }

        function updateDrumSynth() {
            if (drumSynth) {
                if (drumSynth.kick) drumSynth.kick.dispose();
                if (drumSynth.snare) drumSynth.snare.dispose();
                if (drumSynth.hihat) drumSynth.hihat.dispose();
            }
            
            const config = drumConfigs[state.currentDrums] || drumConfigs['acoustic-kit'];
            
            drumSynth = {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 6,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.4 }
                }).toDestination(),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.001, decay: config.snareDecay, sustain: 0, release: 0.1 }
                }).toDestination(),
                hihat: new Tone.MetalSynth({
                    frequency: 300,
                    envelope: { attack: 0.001, decay: config.hihatDecay, release: 0.01 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).toDestination()
            };
            
            drumSynth.kick.volume.value = -4;
            drumSynth.snare.volume.value = -10;
            drumSynth.hihat.volume.value = -20;
        }

        // =============================================
        // CHORD DEFINITIONS
        // =============================================
        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'], 'C7': ['C4', 'E4', 'G4', 'Bb4'],
            'Cmaj7': ['C4', 'E4', 'G4', 'B4'], 'Cm7': ['C4', 'Eb4', 'G4', 'Bb4'],
            'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'], 'D7': ['D4', 'F#4', 'A4', 'C5'],
            'Dm7': ['D4', 'F4', 'A4', 'C5'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'], 'E7': ['E4', 'G#4', 'B4', 'D5'],
            'Em7': ['E4', 'G4', 'B4', 'D5'],
            'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'], 'Fmaj7': ['F4', 'A4', 'C5', 'E5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'], 'G7': ['G4', 'B4', 'D5', 'F5'],
            'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'], 'A7': ['A4', 'C#5', 'E5', 'G5'],
            'Am7': ['A4', 'C5', 'E5', 'G5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'], 'B7': ['B4', 'D#5', 'F#5', 'A5'],
            'Bb': ['Bb4', 'D5', 'F5'], 'Bbm': ['Bb4', 'Db5', 'F5'],
            'Bdim': ['B4', 'D5', 'F5'], 'Ddim': ['D4', 'F4', 'Ab4']
        };

        // =============================================
        // PLAYBACK FUNCTIONS
        // =============================================
        async function playChord(chord) {
            if (!mainSynth) await initAudio();
            
            const notes = chordNotes[chord] || chordNotes['C'];
            const bassNote = notes[0].replace('4', '2').replace('5', '3');
            
            // Play main instrument chord
            mainSynth.triggerAttackRelease(notes, '2n');
            
            // Play bass if in duo/band/orchestra mode
            if (state.mode !== 'solo') {
                bassSynth.triggerAttackRelease(bassNote, '4n');
            }
            
            // Play strings/brass in orchestra mode
            if (state.mode === 'orchestra') {
                const padNotes = notes.map(n => n.replace('4', '3').replace('5', '4'));
                stringSynth.triggerAttackRelease(padNotes, '1n');
            }
            
            haptic();
        }

        function playDrumHit(type) {
            if (!drumSynth) return;
            if (type === 'kick') drumSynth.kick.triggerAttackRelease('C1', '8n');
            if (type === 'snare') drumSynth.snare.triggerAttackRelease('8n');
            if (type === 'hihat') drumSynth.hihat.triggerAttackRelease('32n');
        }

        let playbackInterval, beatCount = 0;
        async function togglePlayback() {
            if (!mainSynth) await initAudio();
            state.isPlaying = !state.isPlaying;
            
            const btn = document.getElementById('playBtn');
            const display = document.getElementById('nowPlaying');
            
            if (state.isPlaying) {
                btn.textContent = '‚è∏Ô∏è';
                let chordIdx = 0;
                beatCount = 0;
                
                const beatInterval = (60 / state.tempo) * 1000;
                
                playbackInterval = setInterval(() => {
                    const beatInMeasure = beatCount % 4;
                    
                    // Drums on every beat (if band/orchestra mode)
                    if (state.mode === 'band' || state.mode === 'orchestra') {
                        playDrumHit('hihat');
                        if (beatInMeasure === 0) playDrumHit('kick');
                        if (beatInMeasure === 2) playDrumHit('snare');
                    }
                    
                    // Chord on beat 1
                    if (beatInMeasure === 0) {
                        const chord = state.progression[chordIdx % state.progression.length];
                        playChord(chord);
                        display.textContent = `Playing: ${chord}`;
                        
                        document.querySelectorAll('.chord-card').forEach((card, i) => {
                            card.classList.toggle('playing', i === chordIdx % state.progression.length);
                        });
                        
                        chordIdx++;
                    }
                    
                    beatCount++;
                }, beatInterval);
            } else {
                btn.textContent = '‚ñ∂Ô∏è';
                display.textContent = 'Ready to jam';
                clearInterval(playbackInterval);
                document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            }
        }

        // =============================================
        // INSTRUMENT SELECTION
        // =============================================
        function selectInstrument(el, category, instrument) {
            const section = el.closest('.instrument-section');
            section.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            const name = el.querySelector('.name').textContent;
            
            // Update the appropriate synth based on category
            if (category === 'keys' || category === 'guitar' || category === 'strings' || category === 'brass') {
                state.currentInstrument = instrument;
                if (mainSynth) updateMainSynth();
            } else if (category === 'bass') {
                state.currentBass = instrument;
                if (bassSynth) updateBassSynth();
            } else if (category === 'drums') {
                state.currentDrums = instrument;
                if (drumSynth) updateDrumSynth();
            }
            
            updateActiveInstruments(name, category);
            haptic();
            showToast(`${el.querySelector('.icon').textContent} ${name} selected`);
        }

        function updateActiveInstruments(name, category) {
            const colors = { keys: '#667eea', guitar: '#f59e0b', bass: '#ef4444', drums: '#10b981', strings: '#8b5cf6', brass: '#f97316' };
            
            const existing = state.activeInstruments.findIndex(i => i.category === category);
            if (existing >= 0) {
                state.activeInstruments[existing] = { name, category, color: colors[category] || '#667eea', volume: 80, muted: false, solo: false };
            } else {
                state.activeInstruments.push({ name, category, color: colors[category] || '#667eea', volume: 80, muted: false, solo: false });
            }
            
            renderActiveInstruments();
        }

        function renderActiveInstruments() {
            const container = document.getElementById('activeInstruments');
            container.innerHTML = state.activeInstruments.map(inst => `
                <div class="active-inst">
                    <span class="dot" style="background: ${inst.color}"></span>
                    ${inst.name}
                </div>
            `).join('');
        }

        // =============================================
        // AI GENERATION
        // =============================================
        async function aiGenerate(type) {
            const btn = event.target.closest('.ai-btn');
            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = '<div class="spinner"></div> Generating...';
            }
            
            try {
                const key = document.getElementById('keySelect').value;
                const genre = document.getElementById('genreSelect').value;
                const currentProg = state.progression.join(' - ');
                
                let prompt = '';
                switch(type) {
                    case 'progression':
                        prompt = `Generate a creative ${genre} chord progression in the key of ${key}. Return ONLY a JSON array of 4-8 chord symbols, like ["C", "Am", "F", "G"]. Use chord extensions like 7, maj7, m7 when appropriate for the genre. Only return the JSON array, nothing else.`;
                        break;
                    case 'continue':
                        prompt = `The current chord progression is: ${currentProg}. Suggest the next 4 chords that would naturally continue this progression in the ${genre} style. Return ONLY a JSON array like ["Em", "Am", "D", "G"]. Only return the JSON array, nothing else.`;
                        break;
                    case 'variation':
                        prompt = `Create a variation of this progression: ${currentProg}. Keep the same feel but substitute some chords with more interesting alternatives (like using Am7 instead of Am, or a tritone substitution). Return ONLY a JSON array. Only return the JSON array, nothing else.`;
                        break;
                    case 'style':
                        prompt = `Convert this progression to ${genre} style: ${currentProg}. Add genre-appropriate extensions and substitutions. Return ONLY a JSON array. Only return the JSON array, nothing else.`;
                        break;
                    case 'surprise':
                        prompt = `Generate an unexpected but musically satisfying chord progression that's creative and interesting. Mix genres, use borrowed chords, or try something unusual. Key of ${key}. Return ONLY a JSON array of 4-6 chords. Only return the JSON array, nothing else.`;
                        break;
                }
                
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Parse the AI response
                let newProgression;
                try {
                    // Clean up the response - remove markdown code blocks if present
                    let cleanResponse = data.result || data.response || data.text || '';
                    cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    newProgression = JSON.parse(cleanResponse);
                } catch (e) {
                    // Try to extract array from text
                    const match = (data.result || data.response || data.text || '').match(/\[.*\]/s);
                    if (match) {
                        newProgression = JSON.parse(match[0]);
                    } else {
                        throw new Error('Could not parse AI response');
                    }
                }
                
                if (Array.isArray(newProgression) && newProgression.length > 0) {
                    state.progression = newProgression;
                    renderChords();
                    showToast(`‚ú® AI generated: ${newProgression.join(' - ')}`);
                }
                
            } catch (error) {
                console.error('AI Generation error:', error);
                showToast('‚ö†Ô∏è AI generation failed, using random');
                generateProgression();
            } finally {
                if (btn) {
                    btn.classList.remove('loading');
                    const icons = { progression: '‚ú®', continue: 'üîÆ', variation: 'üé≤', style: 'üé≠', surprise: 'üåü' };
                    const labels = { progression: 'AI Generate', continue: 'Continue', variation: 'Variation', style: 'Style Match', surprise: 'Surprise Me' };
                    btn.innerHTML = `<span class="sparkle">${icons[type]}</span> ${labels[type]}`;
                }
            }
        }

        // =============================================
        // PROGRESSION GENERATION (Fallback)
        // =============================================
        function generateProgression() {
            const key = document.getElementById('keySelect').value;
            const genre = document.getElementById('genreSelect').value;
            
            const progressionsByGenre = {
                pop: [
                    ['C', 'G', 'Am', 'F'],
                    ['G', 'D', 'Em', 'C'],
                    ['Am', 'F', 'C', 'G'],
                    ['C', 'Am', 'F', 'G']
                ],
                rock: [
                    ['A', 'D', 'E', 'A'],
                    ['E', 'A', 'D', 'A'],
                    ['G', 'C', 'D', 'G'],
                    ['Am', 'G', 'F', 'E']
                ],
                jazz: [
                    ['Cmaj7', 'Am7', 'Dm7', 'G7'],
                    ['Dm7', 'G7', 'Cmaj7', 'A7'],
                    ['Fmaj7', 'Em7', 'Dm7', 'Cmaj7'],
                    ['Am7', 'D7', 'Gmaj7', 'Cmaj7']
                ],
                blues: [
                    ['A7', 'D7', 'A7', 'E7'],
                    ['E7', 'A7', 'B7', 'E7'],
                    ['G7', 'C7', 'G7', 'D7']
                ],
                rnb: [
                    ['Am7', 'Dm7', 'G7', 'Cmaj7'],
                    ['Dm7', 'Em7', 'Am7', 'Gm7'],
                    ['Fm7', 'Bb7', 'Ebmaj7', 'Abmaj7']
                ],
                country: [
                    ['G', 'C', 'D', 'G'],
                    ['D', 'G', 'A', 'D'],
                    ['C', 'F', 'G', 'C']
                ],
                edm: [
                    ['Am', 'F', 'C', 'G'],
                    ['Dm', 'Bb', 'F', 'C'],
                    ['Em', 'C', 'G', 'D']
                ],
                lofi: [
                    ['Cmaj7', 'Am7', 'Dm7', 'Gmaj7'],
                    ['Fmaj7', 'Em7', 'Am7', 'Dm7'],
                    ['Am7', 'Dm7', 'Gmaj7', 'Cmaj7']
                ],
                classical: [
                    ['C', 'G', 'Am', 'Em', 'F', 'C', 'F', 'G'],
                    ['Dm', 'Gm', 'C', 'F'],
                    ['Am', 'E', 'Am', 'Dm']
                ],
                gospel: [
                    ['C', 'F', 'G', 'Am'],
                    ['G', 'C', 'D', 'Em'],
                    ['Bb', 'F', 'C', 'Gm']
                ]
            };
            
            const options = progressionsByGenre[genre] || progressionsByGenre.pop;
            state.progression = options[Math.floor(Math.random() * options.length)];
            renderChords();
            haptic();
            showToast(`üé≤ Random ${genre} progression!`);
        }

        function renderChords() {
            const numeralMap = {
                'C': 'I', 'Cmaj7': 'Imaj7', 'Dm': 'ii', 'Dm7': 'ii7', 'Em': 'iii', 'Em7': 'iii7',
                'F': 'IV', 'Fmaj7': 'IVmaj7', 'G': 'V', 'G7': 'V7', 'Am': 'vi', 'Am7': 'vi7',
                'Bm': 'vii¬∞', 'Bdim': 'vii¬∞'
            };
            
            document.getElementById('chordGrid').innerHTML = state.progression.map((chord, i) => `
                <div class="chord-card" onclick="playChord('${chord}')">
                    <div class="chord-name">${chord}</div>
                    <div class="chord-numeral">${numeralMap[chord] || ''}</div>
                </div>
            `).join('');
            
            updatePlaybackSub();
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================
        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.band-toggle button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const modeNames = { solo: 'Solo Piano', duo: 'Piano + Bass', band: 'Full Band', orchestra: 'Orchestra' };
            showToast(`üé∏ ${modeNames[mode]}`);
            updatePlaybackSub();
            haptic();
        }

        function updateKey() {
            state.key = document.getElementById('keySelect').value;
            updatePlaybackSub();
        }

        function updateGenre() {
            state.genre = document.getElementById('genreSelect').value;
            updatePlaybackSub();
        }

        function updatePlaybackSub() {
            const modeNames = { solo: 'Solo', duo: 'Duo', band: 'Full Band', orchestra: 'Orchestra' };
            document.getElementById('playbackSub').textContent = 
                `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${modeNames[state.mode]}`;
        }

        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(200, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            haptic();
        }

        function setMasterVolume(value) {
            state.masterVolume = value / 100;
            if (Tone.Destination) {
                Tone.Destination.volume.value = Tone.gainToDb(state.masterVolume);
            }
        }

        function setSwing(value) {
            // Swing implementation
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
            haptic();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleInst(el) {
            el.classList.toggle('active');
            haptic();
        }

        function haptic() {
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            renderChords();
            renderActiveInstruments();
            updatePlaybackSub();
            
            document.querySelectorAll('.modal').forEach(m => {
                m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
            });
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
