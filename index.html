<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>ChordFlow v12.5 - Pro UX</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent: #667eea;
            --accent-light: #818cf8;
            --accent-glow: rgba(102, 126, 234, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --ai-purple: #a855f7;
            --recording: #ef4444;
            --keys: #667eea;
            --guitar: #f59e0b;
            --bass: #ef4444;
            --drums: #10b981;
            --strings: #8b5cf6;
            --brass: #f97316;
            --synth: #06b6d4;
            --export-blue: #3b82f6;
            --export-green: #22c55e;
            --piano-white: #ffffff;
            --piano-black: #1a1a2e;
            --metronome: #f59e0b;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .theme-light { --bg-primary: #f8fafc; --bg-secondary: #e2e8f0; --bg-card: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b; --piano-black: #374151; }
        .theme-midnight { --bg-primary: #0f0f23; --bg-secondary: #1a1a3e; --bg-card: #2d1b4e; --accent: #8b5cf6; --accent-light: #a78bfa; }
        .theme-ocean { --bg-primary: #0c1929; --bg-secondary: #0c4a6e; --bg-card: #164e63; --accent: #06b6d4; --accent-light: #22d3ee; }
        .theme-forest { --bg-primary: #0a1f0a; --bg-secondary: #14532d; --bg-card: #1e3a1e; --accent: #22c55e; --accent-light: #4ade80; }
        .theme-sunset { --bg-primary: #1f0a0a; --bg-secondary: #7f1d1d; --bg-card: #991b1b; --accent: #f97316; --accent-light: #fb923c; }
        .theme-candy { --bg-primary: #1a0a1f; --bg-secondary: #581c87; --bg-card: #7c3aed; --accent: #ec4899; --accent-light: #f472b6; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; padding-top: var(--safe-top); padding-bottom: calc(var(--safe-bottom) + 200px); transition: all 0.3s; }
        
        .header { background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .version-badge { font-size: 9px; background: var(--success); color: white; padding: 2px 5px; border-radius: 6px; }
        .pro-badge { font-size: 9px; background: linear-gradient(135deg, var(--gold), #f97316); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        .ai-badge { font-size: 9px; background: linear-gradient(135deg, var(--ai-purple), #ec4899); color: white; padding: 2px 5px; border-radius: 6px; margin-left: 3px; }
        
        .header-actions { display: flex; gap: 6px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-secondary); border: none; color: var(--text-primary); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:active { transform: scale(0.95); background: var(--accent); }
        .icon-btn.metronome-active { background: var(--metronome); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .tab-nav { display: flex; background: var(--bg-secondary); margin: 12px 16px; border-radius: 12px; padding: 4px; gap: 4px; overflow-x: auto; }
        .tab-nav::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 0 0 auto; min-width: 52px; padding: 8px 6px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 9px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn .icon { font-size: 18px; }
        .tabs { display: flex; gap: 4px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; padding: 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab-content { display: none; padding: 0 16px; }
        .tab-content.active { display: block; }
        
        .section-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 12px; }
        .panel { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* AI Actions */
        .ai-actions { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding: 2px; }
        .ai-actions::-webkit-scrollbar { display: none; }
        .ai-btn { display: flex; align-items: center; gap: 6px; padding: 10px 14px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(236, 72, 153, 0.8)); border: 2px solid rgba(168, 85, 247, 0.6); border-radius: 10px; color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .ai-btn:active { transform: scale(0.98); }
        .ai-btn.loading { opacity: 0.7; pointer-events: none; }
        
        .big-generate-btn { width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #a855f7, #ec4899); border: none; border-radius: 14px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); margin-bottom: 12px; }
        .big-generate-btn:active { transform: scale(0.98); }
        
        /* Mode Toggle */
        .mode-toggle { display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px; margin-bottom: 16px; gap: 4px; }
        .mode-toggle button { flex: 1; padding: 10px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; }
        .mode-toggle button.active { background: var(--accent); color: white; }
        
        /* Controls */
        .controls-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .control-group { flex: 1; }
        .control-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .control-select { width: 100%; padding: 10px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 13px; }
        
        /* Chord Grid */
        .chord-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .chord-card { background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary)); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px 6px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .chord-card:active { transform: scale(0.96); }
        .chord-card.playing { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .chord-name { font-size: 20px; font-weight: 700; }
        .chord-numeral { font-size: 10px; color: var(--accent-light); margin-top: 2px; }
        
        /* Instrument Selector */
        .instrument-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px; margin-bottom: 16px; }
        .instrument-scroll::-webkit-scrollbar { display: none; }
        .instrument-card { min-width: 80px; padding: 12px 8px; background: var(--bg-card); border: 2px solid transparent; border-radius: 12px; text-align: center; cursor: pointer; }
        .instrument-card.active { border-color: var(--accent); background: rgba(102, 126, 234, 0.15); }
        .instrument-card .icon { font-size: 24px; margin-bottom: 4px; }
        .instrument-card .name { font-size: 10px; color: var(--text-secondary); }
        
        .current-sound { background: linear-gradient(135deg, var(--accent), #764ba2); padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 600; display: inline-block; margin-bottom: 12px; }
        
        /* METRONOME */
        .metronome-panel { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .metronome-display { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 16px; }
        .metronome-visual { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-card); border: 4px solid var(--metronome); display: flex; align-items: center; justify-content: center; position: relative; }
        .metronome-pendulum { width: 4px; height: 30px; background: var(--metronome); border-radius: 2px; transform-origin: bottom center; transition: transform 0.1s; }
        .metronome-visual.tick .metronome-pendulum { transform: rotate(-25deg); }
        .metronome-visual.tock .metronome-pendulum { transform: rotate(25deg); }
        .beat-indicator { display: flex; gap: 6px; margin-top: 8px; justify-content: center; }
        .beat-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--bg-secondary); transition: all 0.1s; }
        .beat-dot.active { background: var(--metronome); transform: scale(1.3); }
        .beat-dot.downbeat.active { background: var(--danger); }
        .tempo-big { font-size: 42px; font-weight: 700; color: var(--metronome); }
        .tempo-label { font-size: 12px; color: var(--text-secondary); }
        .metronome-controls { display: flex; gap: 8px; justify-content: center; align-items: center; }
        .metro-btn { width: 44px; height: 44px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; background: var(--bg-card); color: var(--text-primary); }
        .metro-btn.play { background: var(--metronome); color: white; width: 56px; height: 56px; }
        .metro-btn:active { transform: scale(0.95); }
        .time-sig-btns { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
        .time-sig-btn { padding: 8px 16px; background: var(--bg-card); border: 2px solid transparent; border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; }
        .time-sig-btn.active { border-color: var(--metronome); background: rgba(245, 158, 11, 0.2); }
        
        /* PIANO ROLL */
        .piano-roll-container { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; overflow: hidden; }
        .piano-roll-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .piano-roll-controls { display: flex; gap: 8px; }
        .pr-btn { padding: 6px 12px; background: var(--bg-secondary); border: none; border-radius: 6px; color: var(--text-primary); font-size: 11px; cursor: pointer; }
        .pr-btn.active { background: var(--accent); }
        .piano-roll { display: flex; background: var(--bg-primary); border-radius: 8px; overflow: hidden; height: 280px; }
        .piano-keys { width: 45px; flex-shrink: 0; display: flex; flex-direction: column; }
        .piano-key { height: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 4px; font-size: 8px; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .piano-key.white { background: var(--piano-white); color: #333; }
        .piano-key.black { background: var(--piano-black); color: #fff; }
        .piano-key:active { background: var(--accent) !important; }
        .piano-grid { flex: 1; overflow-x: auto; overflow-y: hidden; }
        .piano-grid-inner { display: flex; flex-direction: column; min-width: 100%; }
        .piano-row { height: 20px; display: flex; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .piano-row.black-row { background: rgba(0,0,0,0.2); }
        .piano-cell { width: 35px; min-width: 35px; border-right: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .piano-cell:hover { background: rgba(102, 126, 234, 0.2); }
        .piano-cell.active { background: var(--accent); border-radius: 2px; }
        .piano-cell.beat-start { border-right: 2px solid rgba(255,255,255,0.15); }
        
        /* MIXER */
        .mixer-panel { background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary)); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .mixer-channels { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
        .mixer-channel { min-width: 70px; background: var(--bg-primary); border-radius: 12px; padding: 12px 8px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .mixer-icon { font-size: 20px; }
        .mixer-name { font-size: 10px; color: var(--text-secondary); }
        .mixer-fader-wrap { height: 100px; width: 24px; background: var(--bg-card); border-radius: 12px; position: relative; display: flex; align-items: flex-end; justify-content: center; padding: 4px; }
        .mixer-fader { width: 100%; height: 100%; -webkit-appearance: none; writing-mode: bt-lr; -webkit-writing-mode: vertical-lr; background: transparent; cursor: pointer; }
        .mixer-fader::-webkit-slider-track { width: 6px; background: linear-gradient(to top, var(--success), var(--warning), var(--danger)); border-radius: 3px; }
        .mixer-fader::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 10px; background: var(--text-primary); border-radius: 3px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .mixer-value { font-size: 11px; font-weight: 600; color: var(--accent-light); }
        
        /* EQ */
        .eq-section { background: var(--bg-primary); border-radius: 12px; padding: 12px; margin-top: 12px; }
        .eq-title { font-size: 12px; font-weight: 600; margin-bottom: 12px; }
        .eq-bands { display: flex; justify-content: space-around; gap: 8px; }
        .eq-band { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .eq-slider { width: 24px; height: 70px; -webkit-appearance: none; writing-mode: bt-lr; -webkit-writing-mode: vertical-lr; background: var(--bg-card); border-radius: 12px; }
        .eq-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 8px; background: var(--accent); border-radius: 4px; }
        .eq-label { font-size: 9px; color: var(--text-secondary); }
        .eq-val { font-size: 10px; color: var(--accent-light); }
        
        /* COMPRESSOR */
        .comp-section { background: var(--bg-primary); border-radius: 12px; padding: 12px; margin-top: 12px; }
        .comp-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .comp-control { text-align: center; }
        .comp-knob { width: 44px; height: 44px; border-radius: 50%; background: conic-gradient(var(--accent) var(--val, 50%), var(--bg-card) 0); display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; cursor: pointer; }
        .comp-knob-inner { width: 34px; height: 34px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; }
        .comp-label { font-size: 9px; color: var(--text-secondary); }
        
        /* SHEET MUSIC */
        .sheet-panel { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .sheet-preview { background: white; border-radius: 8px; padding: 20px; margin-bottom: 12px; min-height: 180px; overflow: hidden; }
        .sheet-preview canvas { width: 100%; height: 180px; display: block; }
        .staff-line { height: 1px; background: #333; margin: 8px 0; }
        .notation-area { display: flex; align-items: center; gap: 15px; padding: 15px 0; overflow-x: auto; }
        .clef { font-size: 40px; color: #333; }
        .time-sig-display { font-size: 20px; font-weight: 700; color: #333; display: flex; flex-direction: column; align-items: center; line-height: 1; }
        .chord-symbol { font-size: 16px; font-weight: 700; color: #333; padding: 6px 12px; border-bottom: 2px solid #333; text-align: center; }
        .chord-symbol .roman { font-size: 10px; color: #666; display: block; }
        .sheet-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .sheet-btn { flex: 1; min-width: 90px; padding: 12px; background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sheet-btn:active { border-color: var(--accent); transform: scale(0.98); }
        .sheet-btn .icon { font-size: 20px; }
        
        /* EXPORT */
        .export-panel { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        
        /* AI Studio Styles */
        .ai-studio-header { text-align: center; margin-bottom: 16px; }
        .ai-subtitle { color: var(--text-secondary); font-size: 12px; margin-top: 4px; }
        .ai-panel { background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3); }
        .ai-feature-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .ai-icon { font-size: 28px; }
        .ai-feature-title { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .ai-feature-desc { font-size: 11px; color: var(--text-secondary); }
        .ai-options { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .ai-options .control-select { flex: 1; min-width: 120px; }
        .ai-input { width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 13px; margin-bottom: 12px; }
        .ai-input::placeholder { color: var(--text-secondary); }
        .ai-generate-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #a855f7, #ec4899); border: none; border-radius: 12px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .ai-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        .ai-generate-btn:active { transform: scale(0.98); }
        .ai-generate-btn.loading { opacity: 0.7; pointer-events: none; }
        .ai-generate-btn.loading::after { content: '...'; animation: dots 1s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .analyze-btn { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .surprise-btn { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .surprise-panel { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-color: rgba(245, 158, 11, 0.3); }
        .ai-result { margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; font-size: 13px; line-height: 1.6; display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .ai-result.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-result .result-title { font-weight: 700; color: var(--accent); margin-bottom: 8px; display: block; }
        .ai-result .chord-tag { display: inline-block; background: var(--accent); color: white; padding: 4px 10px; border-radius: 6px; margin: 2px; font-weight: 600; cursor: pointer; }
        .ai-result .chord-tag:hover { background: var(--accent-light); }
        .ai-result .melody-note { display: inline-block; background: var(--success); color: white; padding: 3px 8px; border-radius: 4px; margin: 2px; font-size: 12px; }
        .style-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .style-btn { padding: 12px 8px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .style-btn:hover { background: var(--accent); transform: scale(1.05); }
        .style-btn:active { transform: scale(0.95); }
        .style-btn.loading { opacity: 0.7; pointer-events: none; }
        .enhance-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .enhance-btn { padding: 14px 10px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .enhance-btn small { display: block; font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .enhance-btn:hover { background: var(--accent); }
        .enhance-btn:active { transform: scale(0.95); }
        .enhance-btn.loading { opacity: 0.7; pointer-events: none; }
        .lyrics-result { font-style: italic; }
        .structure-result .section-label { display: inline-block; background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 11px; margin-right: 8px; }
        .analysis-result .analysis-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .analysis-result .analysis-label { color: var(--accent); font-weight: 600; }
        
        /* Beats Tab - Melody & Drum Sequencer */
        .sequencer-panel, .drum-panel { background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(34, 197, 94, 0.3); }
        .sequencer-controls, .drum-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center; }
        .seq-btn { padding: 8px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .seq-btn:hover { background: var(--accent); }
        .seq-btn:active { transform: scale(0.95); }
        .ai-melody-btn, .ai-drum-btn { background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; }
        .ai-melody-btn:hover, .ai-drum-btn:hover { opacity: 0.9; }
        
        /* Melody Grid */
        .melody-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; background: var(--bg-secondary); padding: 8px; border-radius: 10px; margin-bottom: 12px; overflow-x: auto; }
        .melody-column { display: flex; flex-direction: column; gap: 2px; }
        .melody-cell { width: 100%; min-width: 20px; aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; }
        .melody-cell:hover { background: rgba(34, 197, 94, 0.3); border-color: var(--success); }
        .melody-cell.active { background: var(--success); box-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
        .melody-cell.playing { background: #fbbf24; transform: scale(1.1); }
        .melody-labels { display: flex; flex-direction: column; gap: 2px; margin-right: 4px; }
        .melody-label { height: 20px; display: flex; align-items: center; font-size: 9px; color: var(--text-secondary); padding-right: 4px; }
        .melody-playback { display: flex; gap: 8px; flex-wrap: wrap; }
        .play-seq-btn { flex: 1; min-width: 120px; padding: 12px; background: var(--success); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .play-seq-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
        .play-seq-btn:active { transform: scale(0.98); }
        .stop-btn { background: var(--error); }
        .stop-btn:hover { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
        
        /* Drum Grid */
        .drum-grid { background: var(--bg-secondary); padding: 10px; border-radius: 10px; margin-bottom: 12px; overflow-x: auto; }
        .drum-row { display: flex; align-items: center; margin-bottom: 6px; }
        .drum-row:last-child { margin-bottom: 0; }
        .drum-label { min-width: 70px; font-size: 11px; color: var(--text-secondary); padding-right: 8px; white-space: nowrap; }
        .drum-steps { display: flex; gap: 3px; flex: 1; }
        .drum-step { width: 100%; min-width: 18px; height: 28px; background: rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; }
        .drum-step:nth-child(4n+1) { background: rgba(255,255,255,0.08); }
        .drum-step:hover { background: rgba(239, 68, 68, 0.3); border-color: var(--error); }
        .drum-step.active { background: var(--error); box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
        .drum-step.kick.active { background: #ef4444; }
        .drum-step.snare.active { background: #f97316; }
        .drum-step.hihat.active { background: #eab308; }
        .drum-step.openhat.active { background: #84cc16; }
        .drum-step.clap.active { background: #22c55e; }
        .drum-step.tom.active { background: #06b6d4; }
        .drum-step.crash.active { background: #8b5cf6; }
        .drum-step.rim.active { background: #ec4899; }
        .drum-step.playing { transform: scale(1.15); filter: brightness(1.3); }
        .drum-playback { display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* Combined Panel */
        .combined-panel { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3); }
        .arrangement-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px; }
        .tempo-section { display: flex; align-items: center; gap: 8px; }
        .tempo-section button { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 16px; }
        .tempo-section button:hover { background: var(--accent); }
        #beatTempoDisplay { font-size: 18px; font-weight: 700; color: var(--accent); min-width: 40px; text-align: center; }
        .loop-toggle { display: flex; align-items: center; gap: 8px; }
        .loop-toggle input { width: 18px; height: 18px; accent-color: var(--accent); }
        .play-all-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .play-all-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4); }
        .play-all-btn:active { transform: scale(0.98); }
        .play-all-btn .icon { font-size: 24px; }
        
        /* RESPONSIVE & SCREEN OPTIMIZATION */
        /* Collapsible Header */
        .header { transition: all 0.3s ease; }
        .header.collapsed { padding: 8px 16px; }
        .header.collapsed .logo { font-size: 18px; }
        .header.collapsed .tagline { display: none; }
        .header-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 12px; }
        
        /* Collapsible Panels */
        .panel { position: relative; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-toggle { background: none; border: none; color: var(--text-secondary); font-size: 16px; cursor: pointer; padding: 4px; transition: transform 0.3s; }
        .panel.collapsed .panel-toggle { transform: rotate(-90deg); }
        .panel.collapsed .panel-content { display: none; }
        .panel.collapsed { padding: 12px 16px; }
        .section-title { display: flex; align-items: center; gap: 8px; flex: 1; }
        
        /* Floating Transport Bar */
        .transport-bar { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, var(--bg-primary) 90%, transparent); padding: 12px 16px 20px; display: flex; gap: 8px; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(10px); }
        .transport-bar.hidden { transform: translateY(100%); }
        .transport-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .transport-play { background: var(--success); color: white; }
        .transport-play.playing { background: var(--warning); }
        .transport-stop { background: var(--error); color: white; }
        .transport-btn:hover { transform: scale(1.1); }
        .transport-btn:active { transform: scale(0.95); }
        .transport-info { text-align: center; min-width: 80px; }
        .transport-tempo { font-size: 18px; font-weight: 700; color: var(--accent); }
        .transport-status { font-size: 10px; color: var(--text-secondary); }
        .main-content { padding-bottom: 90px; }
        
        /* Quick Actions FAB */
        .fab-container { position: fixed; right: 16px; bottom: 90px; z-index: 99; }
        .fab { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #ec4899); border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        .fab-menu { position: absolute; bottom: 65px; right: 0; display: flex; flex-direction: column; gap: 8px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .fab-container.open .fab-menu { opacity: 1; visibility: visible; }
        .fab-container.open .fab { transform: rotate(45deg); background: var(--error); }
        .fab-item { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.2s; }
        .fab-item:hover { background: var(--accent); transform: scale(1.1); }
        
        /* Full Screen Mode */
        .fullscreen-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.5); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 14px; z-index: 10; }
        body.fullscreen-mode .header, body.fullscreen-mode .tabs, body.fullscreen-mode .transport-bar, body.fullscreen-mode .fab-container { display: none; }
        body.fullscreen-mode .main-content { padding: 0; }
        body.fullscreen-mode .tab-content.active { position: fixed; inset: 0; z-index: 1000; background: var(--bg-primary); overflow-y: auto; padding: 16px; }
        .exit-fullscreen { position: fixed; top: 16px; right: 16px; background: var(--error); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; z-index: 1001; display: none; }
        body.fullscreen-mode .exit-fullscreen { display: block; }
        
        /* Desktop/Tablet Layout */
        @media (min-width: 768px) {
            .container { max-width: 1200px; margin: 0 auto; }
            .tabs { justify-content: center; }
            .tab-btn { min-width: 80px; padding: 10px 12px; font-size: 11px; }
            .tab-btn .icon { font-size: 20px; }
            .panel { margin-bottom: 20px; }
            
            /* Two-column layout for some tabs */
            .compose-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
            .ai-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .ai-grid .panel { margin-bottom: 0; }
            
            /* Larger controls */
            .chord-btn { min-width: 70px; height: 70px; font-size: 18px; }
            .drum-step { height: 36px; min-width: 24px; }
            .melody-cell { min-width: 28px; }
            
            /* Side transport on desktop */
            .transport-bar { left: auto; right: 20px; bottom: 20px; width: auto; padding: 12px 20px; border-radius: 30px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); }
        }
        
        @media (min-width: 1024px) {
            .ai-grid { grid-template-columns: repeat(3, 1fr); }
            .style-grid { grid-template-columns: repeat(4, 1fr); }
            .enhance-grid { grid-template-columns: repeat(4, 1fr); }
        }
        
        /* Compact Mode */
        body.compact-mode .panel { padding: 10px 12px; margin-bottom: 10px; }
        body.compact-mode .section-title { font-size: 13px; margin-bottom: 8px; }
        body.compact-mode .chord-btn { min-width: 50px; height: 50px; font-size: 13px; }
        body.compact-mode .control-select { padding: 6px 8px; font-size: 11px; }
        body.compact-mode .ai-generate-btn { padding: 10px; font-size: 12px; }
        
        /* Swipe indicator */
        .swipe-hint { text-align: center; font-size: 10px; color: var(--text-secondary); padding: 4px; opacity: 0.7; }
        .swipe-hint::before { content: '‚Üê swipe tabs ‚Üí'; }
        
        /* 1. COLLAPSIBLE ACCORDION PANELS */
        .accordion-panel { border-radius: 12px; overflow: hidden; margin-bottom: 10px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); }
        .accordion-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; background: rgba(255,255,255,0.03); transition: background 0.2s; }
        .accordion-header:hover { background: rgba(255,255,255,0.06); }
        .accordion-header:active { background: rgba(255,255,255,0.1); }
        .accordion-title { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; }
        .accordion-title .icon { font-size: 18px; }
        .accordion-chevron { font-size: 12px; color: var(--text-secondary); transition: transform 0.3s ease; }
        .accordion-panel.open .accordion-chevron { transform: rotate(180deg); }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; }
        .accordion-panel.open .accordion-body { max-height: 2000px; }
        .accordion-content { padding: 16px; }
        .accordion-badge { background: var(--accent); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; }
        
        /* 2. TAB GROUPS - Dropdown/Mega Menu Style */
        .tab-group { position: relative; }
        .tab-group-btn { flex: 0 0 auto; min-width: 52px; padding: 8px 6px; border: none; border-radius: 8px; background: transparent; color: var(--text-secondary); font-size: 9px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: all 0.2s; }
        .tab-group-btn.active { background: var(--accent); color: white; }
        .tab-group-btn .icon { font-size: 18px; }
        .tab-group-btn .chevron { font-size: 8px; margin-left: 2px; transition: transform 0.2s; }
        .tab-group.open .tab-group-btn .chevron { transform: rotate(180deg); }
        .tab-group-menu { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 8px; min-width: 140px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .tab-group.open .tab-group-menu { opacity: 1; visibility: visible; }
        .tab-group-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; font-size: 13px; white-space: nowrap; }
        .tab-group-item:hover { background: rgba(255,255,255,0.1); }
        .tab-group-item.active { background: var(--accent); color: white; }
        .tab-group-item .icon { font-size: 16px; }
        
        /* 3. BOTTOM SHEET MODALS */
        .bottom-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 500; backdrop-filter: blur(4px); }
        .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--bg-card); border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); z-index: 501; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet-handle { width: 36px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 10px auto; flex-shrink: 0; }
        .bottom-sheet-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .bottom-sheet-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .bottom-sheet-close { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .bottom-sheet-close:hover { background: var(--error); color: white; }
        .bottom-sheet-body { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .bottom-sheet-actions { display: flex; gap: 10px; padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; background: var(--bg-secondary); }
        .bottom-sheet-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .bottom-sheet-btn.primary { background: var(--accent); color: white; }
        .bottom-sheet-btn.secondary { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        
        /* 4. CUSTOMIZABLE QUICK TOOLBAR */
        .quick-toolbar { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 8px; display: flex; gap: 4px; z-index: 90; box-shadow: 0 4px 20px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: all 0.3s; }
        .quick-toolbar.visible { opacity: 1; visibility: visible; }
        .quick-toolbar.editing { animation: toolbar-shake 0.5s ease; }
        @keyframes toolbar-shake { 0%, 100% { transform: translateX(-50%) rotate(0); } 25% { transform: translateX(-50%) rotate(-1deg); } 75% { transform: translateX(-50%) rotate(1deg); } }
        .toolbar-item { width: 44px; height: 44px; border-radius: 12px; border: none; background: transparent; color: var(--text-primary); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; position: relative; }
        .toolbar-item:hover { background: rgba(255,255,255,0.1); }
        .toolbar-item:active { transform: scale(0.9); }
        .toolbar-item.active { background: var(--accent); color: white; }
        .toolbar-item .remove-btn { position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; border-radius: 50%; background: var(--error); color: white; font-size: 12px; border: none; cursor: pointer; display: none; align-items: center; justify-content: center; }
        .quick-toolbar.editing .toolbar-item .remove-btn { display: flex; }
        .toolbar-add { border: 2px dashed rgba(255,255,255,0.3); background: transparent; }
        .toolbar-add:hover { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }
        .toolbar-divider { width: 1px; height: 30px; background: rgba(255,255,255,0.1); margin: 7px 4px; }
        
        /* Toolbar Customization Bottom Sheet */
        .toolbar-option { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .toolbar-option:hover { background: rgba(255,255,255,0.1); }
        .toolbar-option.selected { background: var(--accent); }
        .toolbar-option .icon { font-size: 24px; width: 40px; text-align: center; }
        .toolbar-option-info { flex: 1; }
        .toolbar-option-name { font-weight: 600; font-size: 14px; }
        .toolbar-option-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .toolbar-option.selected .toolbar-option-desc { color: rgba(255,255,255,0.7); }
        
        /* Mini player in toolbar */
        .toolbar-mini-player { display: flex; align-items: center; gap: 4px; padding: 0 8px; }
        .mini-tempo { font-size: 12px; font-weight: 700; color: var(--accent); min-width: 35px; text-align: center; }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .export-card { padding: 16px; background: var(--bg-card); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .export-card:active { border-color: var(--accent); transform: scale(0.98); }
        .export-card .icon { font-size: 28px; margin-bottom: 8px; }
        .export-card .name { font-size: 14px; font-weight: 600; }
        .export-card .desc { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .export-card.loading { opacity: 0.6; pointer-events: none; }
        .export-progress { margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; display: none; }
        .export-progress.active { display: block; }
        .progress-bar { height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--export-blue), var(--export-green)); border-radius: 3px; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: var(--text-secondary); text-align: center; }
        
        /* THEME */
        .theme-presets { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .theme-preset { aspect-ratio: 1; border-radius: 12px; border: 3px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .theme-preset.active { border-color: var(--accent); transform: scale(1.05); }
        .theme-preset.dark { background: linear-gradient(135deg, #0a0a0f, #1a1a2e); }
        .theme-preset.light { background: linear-gradient(135deg, #f8fafc, #e2e8f0); }
        .theme-preset.midnight { background: linear-gradient(135deg, #0f0f23, #2d1b4e); }
        .theme-preset.ocean { background: linear-gradient(135deg, #0c1929, #164e63); }
        .theme-preset.forest { background: linear-gradient(135deg, #0a1f0a, #1e3a1e); }
        .theme-preset.sunset { background: linear-gradient(135deg, #1f0a0a, #991b1b); }
        .theme-preset.candy { background: linear-gradient(135deg, #1a0a1f, #7c3aed); }
        .theme-preset.custom { background: linear-gradient(135deg, var(--bg-primary), var(--accent)); }
        .color-section { background: var(--bg-card); border-radius: 12px; padding: 16px; }
        .color-pickers { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .color-item { display: flex; align-items: center; gap: 10px; }
        .color-label { font-size: 12px; color: var(--text-secondary); flex: 1; }
        .color-input { width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer; padding: 0; }
        .color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .color-input::-webkit-color-swatch { border: none; border-radius: 8px; }
        
        /* PLAYBACK */
        .playback-bar { position: fixed; bottom: var(--safe-bottom); left: 0; right: 0; background: linear-gradient(to top, var(--bg-primary), var(--bg-secondary)); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; z-index: 200; }
        .playback-main { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .play-btn { width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #764ba2); border: none; color: white; font-size: 22px; cursor: pointer; box-shadow: 0 4px 20px var(--accent-glow); }
        .play-btn:active { transform: scale(0.95); }
        .playback-info { flex: 1; }
        .now-playing { font-size: 13px; font-weight: 600; }
        .playback-sub { font-size: 11px; color: var(--text-secondary); }
        .tempo-control { display: flex; align-items: center; gap: 4px; }
        .tempo-btn { width: 30px; height: 30px; border-radius: 6px; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 14px; cursor: pointer; }
        .tempo-display { font-size: 13px; font-weight: 600; min-width: 45px; text-align: center; }
        .active-instruments { display: flex; gap: 6px; overflow-x: auto; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        .active-inst { display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--bg-card); border-radius: 16px; font-size: 11px; white-space: nowrap; }
        .active-inst .dot { width: 6px; height: 6px; border-radius: 50%; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border-radius: 20px; width: 100%; max-width: 420px; max-height: 85vh; overflow-y: auto; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); border: none; color: var(--text-primary); font-size: 16px; cursor: pointer; }
        
        .toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--accent); padding: 10px 20px; border-radius: 10px; font-size: 13px; z-index: 2000; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span>üéµ</span>
            <h1>ChordFlow<span class="version-badge">v12</span><span class="pro-badge">PRO</span><span class="ai-badge">AI</span></h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="metronomeBtn" onclick="toggleMetronome()">‚è±Ô∏è</button>
            <button class="icon-btn" onclick="openModal('themeModal')">üé®</button>
            <button class="icon-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="tab-nav tabs">
        <!-- Main Tab: Compose -->
        <button class="tab-btn active" onclick="switchTab('compose')"><span class="icon">üéπ</span><span>Compose</span></button>
        
        <!-- Group: Create (AI features) -->
        <div class="tab-group" id="createGroup">
            <button class="tab-group-btn" onclick="toggleTabGroup('createGroup')">
                <span class="icon">‚ú®</span><span>Create<span class="chevron">‚ñº</span></span>
            </button>
            <div class="tab-group-menu">
                <div class="tab-group-item" onclick="switchTab('ai'); closeTabGroups();"><span class="icon">ü§ñ</span>AI Studio</div>
                <div class="tab-group-item" onclick="switchTab('beats'); closeTabGroups();"><span class="icon">ü•Å</span>Beats</div>
            </div>
        </div>
        
        <!-- Group: Studio (Production tools) -->
        <div class="tab-group" id="studioGroup">
            <button class="tab-group-btn" onclick="toggleTabGroup('studioGroup')">
                <span class="icon">üéöÔ∏è</span><span>Studio<span class="chevron">‚ñº</span></span>
            </button>
            <div class="tab-group-menu">
                <div class="tab-group-item" onclick="switchTab('piano'); closeTabGroups();"><span class="icon">üéº</span>Piano Roll</div>
                <div class="tab-group-item" onclick="switchTab('mixer'); closeTabGroups();"><span class="icon">üéöÔ∏è</span>Mixer</div>
            </div>
        </div>
        
        <!-- Group: Output (Export features) -->
        <div class="tab-group" id="outputGroup">
            <button class="tab-group-btn" onclick="toggleTabGroup('outputGroup')">
                <span class="icon">üíæ</span><span>Output<span class="chevron">‚ñº</span></span>
            </button>
            <div class="tab-group-menu">
                <div class="tab-group-item" onclick="switchTab('sheet'); closeTabGroups();"><span class="icon">üìú</span>Sheet Music</div>
                <div class="tab-group-item" onclick="switchTab('export'); closeTabGroups();"><span class="icon">üíæ</span>Export</div>
            </div>
        </div>
        
        <!-- Settings Button -->
        <button class="tab-btn" onclick="openBottomSheet('settings')"><span class="icon">‚öôÔ∏è</span><span>More</span></button>
    </div>

    <div class="main-content">
    <!-- COMPOSE TAB -->
    <div class="tab-content active" id="compose-tab">
        <button class="big-generate-btn" onclick="aiGenerate('progression')">üéµ Generate AI Progression</button>
        
        <div class="ai-actions">
            <button class="ai-btn" onclick="aiGenerate('progression')">‚ú® AI Generate</button>
            <button class="ai-btn" onclick="aiGenerate('continue')">üîÆ Continue</button>
            <button class="ai-btn" onclick="aiGenerate('variation')">üé≤ Variation</button>
        </div>
        
        <!-- Metronome Panel -->
        <div class="metronome-panel">
            <div class="section-title">‚è±Ô∏è Metronome</div>
            <div class="metronome-display">
                <div class="metronome-visual" id="metronomeVisual">
                    <div class="metronome-pendulum" id="metronomePendulum"></div>
                </div>
                <div style="text-align:center;">
                    <div class="tempo-big" id="metronomeTempoValue">120</div>
                    <div class="tempo-label">BPM</div>
                </div>
            </div>
            <div class="beat-indicator" id="beatIndicator">
                <div class="beat-dot downbeat"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
                <div class="beat-dot"></div>
            </div>
            <div class="metronome-controls">
                <button class="metro-btn" onclick="adjustMetronomeTempo(-5)">‚àí5</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(-1)">‚àí</button>
                <button class="metro-btn play" id="metronomePlayBtn" onclick="toggleMetronome()">‚ñ∂Ô∏è</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(1)">+</button>
                <button class="metro-btn" onclick="adjustMetronomeTempo(5)">+5</button>
            </div>
            <div class="time-sig-btns">
                <button class="time-sig-btn active" onclick="setTimeSignature(4, this)">4/4</button>
                <button class="time-sig-btn" onclick="setTimeSignature(3, this)">3/4</button>
                <button class="time-sig-btn" onclick="setTimeSignature(6, this)">6/8</button>
            </div>
        </div>
        
        <div class="mode-toggle">
            <button class="active" onclick="setMode('solo', this)">Solo</button>
            <button onclick="setMode('duo', this)">Duo</button>
            <button onclick="setMode('band', this)">Band</button>
            <button onclick="setMode('orchestra', this)">Orchestra</button>
        </div>
        
        <div class="current-sound" id="currentSound">üéπ Grand Piano</div>
        <div class="instrument-scroll" id="instrumentList"></div>
        
        <div class="controls-row">
            <div class="control-group">
                <div class="control-label">Key</div>
                <select class="control-select" id="keySelect" onchange="updateKey()">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Genre</div>
                <select class="control-select" id="genreSelect" onchange="updateGenre()">
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="blues">Blues</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="edm">EDM</option>
                    <option value="classical">Classical</option>
                </select>
            </div>
        </div>
        
        <div class="section-title">üé∂ Progression</div>
        <div class="chord-grid" id="chordGrid"></div>
    </div>

    <!-- AI STUDIO TAB -->
    <div class="tab-content" id="ai-tab">
        <div class="ai-studio-header">
            <div class="section-title">ü§ñ AI Studio <span class="ai-badge">Powered by Gemini</span></div>
            <p class="ai-subtitle">Advanced AI tools for music creation</p>
        </div>

        <!-- AI Melody Generator -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üéµ</span>
                <div>
                    <div class="ai-feature-title">Melody Generator</div>
                    <div class="ai-feature-desc">Create melodies that fit your chord progression</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="melodyStyle">
                    <option value="simple">Simple & Singable</option>
                    <option value="complex">Complex & Intricate</option>
                    <option value="jazzy">Jazzy Improv</option>
                    <option value="classical">Classical Motif</option>
                    <option value="catchy">Catchy Hook</option>
                </select>
                <select class="control-select" id="melodyRange">
                    <option value="low">Low Range</option>
                    <option value="mid" selected>Mid Range</option>
                    <option value="high">High Range</option>
                    <option value="wide">Wide Range</option>
                </select>
            </div>
            <button class="ai-generate-btn" onclick="generateMelody(this)">
                <span class="icon">‚ú®</span> Generate Melody
            </button>
            <div class="ai-result" id="melodyResult"></div>
        </div>

        <!-- AI Lyrics Writer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">‚úçÔ∏è</span>
                <div>
                    <div class="ai-feature-title">Lyrics Writer</div>
                    <div class="ai-feature-desc">Generate lyrics with themes and emotions</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="lyricsTheme">
                    <option value="love">Love & Romance</option>
                    <option value="heartbreak">Heartbreak</option>
                    <option value="party">Party & Fun</option>
                    <option value="inspiration">Inspiration</option>
                    <option value="nostalgia">Nostalgia</option>
                    <option value="nature">Nature & Peace</option>
                    <option value="rebellion">Rebellion</option>
                    <option value="journey">Life Journey</option>
                </select>
                <select class="control-select" id="lyricsMood">
                    <option value="happy">Happy</option>
                    <option value="sad">Sad</option>
                    <option value="energetic">Energetic</option>
                    <option value="chill">Chill</option>
                    <option value="dark">Dark</option>
                    <option value="hopeful">Hopeful</option>
                </select>
            </div>
            <input type="text" class="ai-input" id="lyricsKeywords" placeholder="Optional keywords (e.g., sunset, dreams, city)">
            <button class="ai-generate-btn" onclick="generateLyrics(this)">
                <span class="icon">‚ú®</span> Write Lyrics
            </button>
            <div class="ai-result lyrics-result" id="lyricsResult"></div>
        </div>

        <!-- AI Style Transfer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé≠</span>
                <div>
                    <div class="ai-feature-title">Style Transfer</div>
                    <div class="ai-feature-desc">Transform your progression to a new genre</div>
                </div>
            </div>
            <div class="style-grid">
                <button class="style-btn" onclick="transferStyle('jazz', this)">üé∑ Jazz</button>
                <button class="style-btn" onclick="transferStyle('classical', this)">üéª Classical</button>
                <button class="style-btn" onclick="transferStyle('edm', this)">üéß EDM</button>
                <button class="style-btn" onclick="transferStyle('rnb', this)">üé§ R&B</button>
                <button class="style-btn" onclick="transferStyle('country', this)">ü§† Country</button>
                <button class="style-btn" onclick="transferStyle('metal', this)">ü§ò Metal</button>
                <button class="style-btn" onclick="transferStyle('bossa', this)">üå¥ Bossa Nova</button>
                <button class="style-btn" onclick="transferStyle('gospel', this)">‚õ™ Gospel</button>
            </div>
            <div class="ai-result" id="styleResult"></div>
        </div>

        <!-- AI Chord Enhancer -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üéπ</span>
                <div>
                    <div class="ai-feature-title">Chord Enhancer</div>
                    <div class="ai-feature-desc">Add extensions, substitutions, and color</div>
                </div>
            </div>
            <div class="enhance-grid">
                <button class="enhance-btn" onclick="enhanceChords('extensions', this)">‚ûï Add Extensions<br><small>7ths, 9ths, 11ths</small></button>
                <button class="enhance-btn" onclick="enhanceChords('substitutions', this)">üîÑ Substitutions<br><small>Tritone, relative</small></button>
                <button class="enhance-btn" onclick="enhanceChords('passing', this)">üö∂ Passing Chords<br><small>Chromatic movement</small></button>
                <button class="enhance-btn" onclick="enhanceChords('reharmonize', this)">üé® Reharmonize<br><small>New harmonic approach</small></button>
            </div>
            <div class="ai-result" id="enhanceResult"></div>
        </div>

        <!-- AI Song Structure -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé¨</span>
                <div>
                    <div class="ai-feature-title">Song Structure Generator</div>
                    <div class="ai-feature-desc">Create full song arrangements</div>
                </div>
            </div>
            <div class="ai-options">
                <select class="control-select" id="structureType">
                    <option value="pop">Pop (Verse-Chorus-Verse)</option>
                    <option value="aaba">AABA (Jazz Standard)</option>
                    <option value="blues">12-Bar Blues</option>
                    <option value="edm">EDM (Build-Drop)</option>
                    <option value="ballad">Ballad (Intro-Verse-Bridge)</option>
                    <option value="progressive">Progressive (Through-composed)</option>
                </select>
            </div>
            <button class="ai-generate-btn" onclick="generateStructure(this)">
                <span class="icon">‚ú®</span> Generate Full Song
            </button>
            <div class="ai-result structure-result" id="structureResult"></div>
        </div>

        <!-- AI Analysis -->
        <div class="panel ai-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üîç</span>
                <div>
                    <div class="ai-feature-title">Progression Analysis</div>
                    <div class="ai-feature-desc">Understand your chord progression</div>
                </div>
            </div>
            <button class="ai-generate-btn analyze-btn" onclick="analyzeProgression(this)">
                <span class="icon">üî¨</span> Analyze My Progression
            </button>
            <div class="ai-result analysis-result" id="analysisResult"></div>
        </div>

        <!-- AI Surprise Me -->
        <div class="panel ai-panel surprise-panel">
            <div class="ai-feature-header">
                <span class="ai-icon">üé≤</span>
                <div>
                    <div class="ai-feature-title">Surprise Me!</div>
                    <div class="ai-feature-desc">Let AI create something unexpected</div>
                </div>
            </div>
            <button class="ai-generate-btn surprise-btn" onclick="surpriseMe(this)">
                <span class="icon">üé∞</span> Generate Random Creation
            </button>
            <div class="ai-result" id="surpriseResult"></div>
        </div>
    </div>

    <!-- BEATS TAB - Melody & Drums -->
    <div class="tab-content" id="beats-tab">
        <!-- Melody Sequencer -->
        <div class="panel sequencer-panel">
            <div class="section-title">üéµ Melody Sequencer</div>
            <div class="sequencer-controls">
                <select class="control-select" id="melodyScale" onchange="updateMelodyScale()">
                    <option value="major">Major Scale</option>
                    <option value="minor">Minor Scale</option>
                    <option value="pentatonic">Pentatonic</option>
                    <option value="blues">Blues Scale</option>
                    <option value="dorian">Dorian Mode</option>
                    <option value="chromatic">Chromatic</option>
                </select>
                <select class="control-select" id="melodyOctave">
                    <option value="3">Octave 3</option>
                    <option value="4" selected>Octave 4</option>
                    <option value="5">Octave 5</option>
                </select>
                <button class="seq-btn" onclick="clearMelody()">üóëÔ∏è Clear</button>
                <button class="seq-btn" onclick="randomMelody()">üé≤ Random</button>
                <button class="seq-btn ai-melody-btn" onclick="aiGenerateMelodyPattern(this)">‚ú® AI</button>
            </div>
            <div class="melody-grid" id="melodyGrid"></div>
            <div class="melody-playback">
                <button class="play-seq-btn" onclick="playMelodySequence()">‚ñ∂Ô∏è Play Melody</button>
                <button class="play-seq-btn" onclick="playMelodyWithChords()">üéπ Play with Chords</button>
            </div>
        </div>

        <!-- Drum Machine -->
        <div class="panel drum-panel">
            <div class="section-title">ü•Å Drum Machine</div>
            <div class="drum-controls">
                <select class="control-select" id="drumKit" onchange="changeDrumKit()">
                    <option value="acoustic">Acoustic Kit</option>
                    <option value="electronic">Electronic</option>
                    <option value="808">808 Hip Hop</option>
                    <option value="jazz">Jazz Brushes</option>
                </select>
                <button class="seq-btn" onclick="clearDrums()">üóëÔ∏è Clear</button>
                <button class="seq-btn" onclick="loadDrumPreset('rock')">üé∏ Rock</button>
                <button class="seq-btn" onclick="loadDrumPreset('hiphop')">üé§ Hip Hop</button>
                <button class="seq-btn" onclick="loadDrumPreset('edm')">üéß EDM</button>
                <button class="seq-btn ai-drum-btn" onclick="aiGenerateDrumPattern(this)">‚ú® AI</button>
            </div>
            <div class="drum-grid" id="drumGrid">
                <div class="drum-row" data-drum="kick">
                    <div class="drum-label">üîä Kick</div>
                    <div class="drum-steps" id="kick-steps"></div>
                </div>
                <div class="drum-row" data-drum="snare">
                    <div class="drum-label">ü•Å Snare</div>
                    <div class="drum-steps" id="snare-steps"></div>
                </div>
                <div class="drum-row" data-drum="hihat">
                    <div class="drum-label">üé© Hi-Hat</div>
                    <div class="drum-steps" id="hihat-steps"></div>
                </div>
                <div class="drum-row" data-drum="openhat">
                    <div class="drum-label">üí® Open HH</div>
                    <div class="drum-steps" id="openhat-steps"></div>
                </div>
                <div class="drum-row" data-drum="clap">
                    <div class="drum-label">üëè Clap</div>
                    <div class="drum-steps" id="clap-steps"></div>
                </div>
                <div class="drum-row" data-drum="tom">
                    <div class="drum-label">ü™ò Tom</div>
                    <div class="drum-steps" id="tom-steps"></div>
                </div>
                <div class="drum-row" data-drum="crash">
                    <div class="drum-label">üí• Crash</div>
                    <div class="drum-steps" id="crash-steps"></div>
                </div>
                <div class="drum-row" data-drum="rim">
                    <div class="drum-label">üîî Rim</div>
                    <div class="drum-steps" id="rim-steps"></div>
                </div>
            </div>
            <div class="drum-playback">
                <button class="play-seq-btn" onclick="playDrumSequence()">‚ñ∂Ô∏è Play Drums</button>
                <button class="play-seq-btn" onclick="playFullBeat()">üé∂ Play Full Beat</button>
                <button class="play-seq-btn stop-btn" onclick="stopAllSequences()">‚èπÔ∏è Stop</button>
            </div>
        </div>

        <!-- Combined Playback -->
        <div class="panel combined-panel">
            <div class="section-title">üéº Full Arrangement</div>
            <div class="arrangement-controls">
                <div class="tempo-section">
                    <span>Tempo:</span>
                    <button onclick="adjustBeatTempo(-5)">‚àí</button>
                    <span id="beatTempoDisplay">120</span>
                    <button onclick="adjustBeatTempo(5)">+</button>
                    <span>BPM</span>
                </div>
                <div class="loop-toggle">
                    <label><input type="checkbox" id="loopBeats" checked> Loop</label>
                </div>
            </div>
            <button class="play-all-btn" onclick="playEverything()">
                <span class="icon">üéµ</span>
                <span>Play Chords + Melody + Drums</span>
            </button>
        </div>
    </div>

    <!-- PIANO ROLL TAB -->
    <div class="tab-content" id="piano-tab">
        <div class="piano-roll-container">
            <div class="piano-roll-header">
                <div class="section-title">üéº Piano Roll Editor</div>
                <div class="piano-roll-controls">
                    <button class="pr-btn" onclick="clearPianoRoll()">Clear</button>
                    <button class="pr-btn" onclick="loadChordsToPianoRoll()">Load Chords</button>
                    <button class="pr-btn active" id="pianoSnapBtn" onclick="toggleSnap()">Snap</button>
                </div>
            </div>
            <div class="piano-roll" id="pianoRoll">
                <div class="piano-keys" id="pianoKeys"></div>
                <div class="piano-grid" id="pianoGrid">
                    <div class="piano-grid-inner" id="pianoGridInner"></div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">üéπ Quick Keys</div>
            <div class="instrument-scroll" id="quickPianoKeys"></div>
        </div>
    </div>

    <!-- MIXER TAB -->
    <div class="tab-content" id="mixer-tab">
        <div class="mixer-panel">
            <div class="section-title">üéöÔ∏è Channel Mixer</div>
            <div class="mixer-channels" id="mixerChannels"></div>
        </div>
        
        <div class="eq-section">
            <div class="eq-title">üìä Master EQ</div>
            <div class="eq-bands">
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('low', this.value)">
                    <div class="eq-label">Low</div>
                    <div class="eq-val" id="eqLow">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('lowMid', this.value)">
                    <div class="eq-label">Lo-Mid</div>
                    <div class="eq-val" id="eqLowMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('mid', this.value)">
                    <div class="eq-label">Mid</div>
                    <div class="eq-val" id="eqMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('highMid', this.value)">
                    <div class="eq-label">Hi-Mid</div>
                    <div class="eq-val" id="eqHighMid">0dB</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical" oninput="updateEQ('high', this.value)">
                    <div class="eq-label">High</div>
                    <div class="eq-val" id="eqHigh">0dB</div>
                </div>
            </div>
        </div>
        
        <div class="comp-section">
            <div class="eq-title">üîä Compressor</div>
            <div class="comp-controls">
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 50%;" onclick="adjustCompressor('threshold')">
                        <div class="comp-knob-inner" id="compThreshold">-24</div>
                    </div>
                    <div class="comp-label">Threshold</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 30%;" onclick="adjustCompressor('ratio')">
                        <div class="comp-knob-inner" id="compRatio">4:1</div>
                    </div>
                    <div class="comp-label">Ratio</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 20%;" onclick="adjustCompressor('attack')">
                        <div class="comp-knob-inner" id="compAttack">10ms</div>
                    </div>
                    <div class="comp-label">Attack</div>
                </div>
                <div class="comp-control">
                    <div class="comp-knob" style="--val: 40%;" onclick="adjustCompressor('release')">
                        <div class="comp-knob-inner" id="compRelease">100ms</div>
                    </div>
                    <div class="comp-label">Release</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SHEET MUSIC TAB -->
    <div class="tab-content" id="sheet-tab">
        <div class="sheet-panel">
            <div class="section-title">üìú Sheet Music Preview</div>
            <div class="sheet-preview" id="sheetPreview">
                <canvas id="sheetCanvas" width="600" height="200"></canvas>
            </div>
            
            <div class="sheet-btns">
                <button class="sheet-btn" onclick="exportSheetPDF()"><span class="icon">üìÑ</span><span>PDF</span></button>
                <button class="sheet-btn" onclick="exportSheetPNG()"><span class="icon">üñºÔ∏è</span><span>PNG</span></button>
                <button class="sheet-btn" onclick="printSheet()"><span class="icon">üñ®Ô∏è</span><span>Print</span></button>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">‚öôÔ∏è Options</div>
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">Display</div>
                    <select class="control-select" id="notationDisplay" onchange="renderSheetMusic()">
                        <option value="chords">Chord Symbols</option>
                        <option value="roman">Roman Numerals</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">Size</div>
                    <select class="control-select" id="notationSize" onchange="renderSheetMusic()">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT TAB -->
    <div class="tab-content" id="export-tab">
        <div class="export-panel">
            <div class="section-title">üì¶ Export Your Music</div>
            <div class="export-grid">
                <div class="export-card" onclick="exportMIDI()"><div class="icon">üéπ</div><div class="name">MIDI</div><div class="desc">For DAWs</div></div>
                <div class="export-card" onclick="exportWAV()"><div class="icon">üéµ</div><div class="name">WAV</div><div class="desc">Lossless</div></div>
                <div class="export-card" onclick="exportMP3()"><div class="icon">üìÑ</div><div class="name">MP3</div><div class="desc">Compressed</div></div>
                <div class="export-card" onclick="exportSheetPDF()"><div class="icon">üìú</div><div class="name">PDF</div><div class="desc">Sheet music</div></div>
            </div>
            <div class="export-progress" id="exportProgress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">Preparing...</div>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">üì§ Share</div>
            <div class="export-grid">
                <div class="export-card" onclick="shareSong()"><div class="icon">üîó</div><div class="name">Copy</div><div class="desc">To clipboard</div></div>
                <div class="export-card" onclick="shareNative()"><div class="icon">üì≤</div><div class="name">Share</div><div class="desc">Native</div></div>
            </div>
        </div>
    </div>

    <!-- Playback Bar -->
    <div class="playback-bar">
        <div class="playback-main">
            <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
            <div class="playback-info">
                <div class="now-playing" id="nowPlaying">Ready to jam</div>
                <div class="playback-sub" id="playbackSub">4 chords ‚Ä¢ C Major ‚Ä¢ Solo</div>
            </div>
            <div class="tempo-control">
                <button class="tempo-btn" onclick="adjustTempo(-5)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
            </div>
        </div>
        <div class="active-instruments" id="activeInstruments">
            <div class="active-inst"><span class="dot" style="background: var(--keys)"></span> Grand Piano</div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Themes</div>
                <button class="close-btn" onclick="closeModal('themeModal')">‚úï</button>
            </div>
            <div class="theme-presets">
                <div class="theme-preset dark active" onclick="setTheme('dark', this)">üåô</div>
                <div class="theme-preset light" onclick="setTheme('light', this)">‚òÄÔ∏è</div>
                <div class="theme-preset midnight" onclick="setTheme('midnight', this)">üåå</div>
                <div class="theme-preset ocean" onclick="setTheme('ocean', this)">üåä</div>
                <div class="theme-preset forest" onclick="setTheme('forest', this)">üå≤</div>
                <div class="theme-preset sunset" onclick="setTheme('sunset', this)">üåÖ</div>
                <div class="theme-preset candy" onclick="setTheme('candy', this)">üç¨</div>
                <div class="theme-preset custom" onclick="setTheme('custom', this)">‚ú®</div>
            </div>
            <div class="color-section">
                <div class="section-title">üé® Custom Colors</div>
                <div class="color-pickers">
                    <div class="color-item"><span class="color-label">Background</span><input type="color" class="color-input" id="customBg" value="#0a0a0f" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Accent</span><input type="color" class="color-input" id="customAccent" value="#667eea" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Card</span><input type="color" class="color-input" id="customCard" value="#1a1a2e" onchange="updateCustomTheme()"></div>
                    <div class="color-item"><span class="color-label">Text</span><input type="color" class="color-input" id="customText" value="#f1f5f9" onchange="updateCustomTheme()"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="close-btn" onclick="closeModal('settingsModal')">‚úï</button>
            </div>
            <div style="padding: 12px 0;">
                <p style="color: var(--gold); font-weight:600; margin-bottom: 8px;">‚ú® ChordFlow v12.0 Pro Studio</p>
                <p style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                    üéº Piano Roll Editor<br>
                    üìú Sheet Music + PDF Export<br>
                    üéöÔ∏è Advanced Mixer & EQ<br>
                    ‚è±Ô∏è Visual Metronome<br>
                    üé® 8 Themes + Custom Colors<br>
                    üîä Compressor Controls<br>
                    üéπ MIDI/WAV/MP3 Export<br>
                    ü§ñ AI Chord Generation
                </p>
            </div>
        </div>
    </div>
    </div><!-- end main-content -->

    <div class="toast" id="toast"></div>
    
    <!-- Floating Transport Bar -->
    <div class="transport-bar" id="transportBar">
        <button class="transport-btn transport-stop" onclick="stopAllPlayback()" title="Stop">‚èπÔ∏è</button>
        <div class="transport-info">
            <div class="transport-tempo" id="transportTempo">120</div>
            <div class="transport-status" id="transportStatus">Ready</div>
        </div>
        <button class="transport-btn transport-play" id="transportPlay" onclick="toggleGlobalPlayback()" title="Play/Pause">‚ñ∂Ô∏è</button>
    </div>
    
    <!-- Quick Actions FAB -->
    <div class="fab-container" id="fabContainer">
        <div class="fab-menu">
            <button class="fab-item" onclick="toggleCompactMode()" title="Compact Mode">üìê</button>
            <button class="fab-item" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
            <button class="fab-item" onclick="quickRandomize()" title="Randomize">üé≤</button>
            <button class="fab-item" onclick="quickAI()" title="AI Generate">‚ú®</button>
        </div>
        <button class="fab" onclick="toggleFab()">+</button>
    </div>
    
    <!-- Exit Fullscreen Button -->
    <button class="exit-fullscreen" onclick="exitFullscreen()">‚úï Exit Fullscreen</button>
    
    <!-- Swipe hint for tabs -->
    <div class="swipe-hint" id="swipeHint"></div>
    
    <!-- Quick Toolbar -->
    <div class="quick-toolbar visible" id="quickToolbar">
        <button class="toolbar-item" onclick="toggleGlobalPlayback()" id="toolbarPlay" title="Play/Stop">‚ñ∂Ô∏è</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-item" onclick="generateProgression()" title="New Progression">üé≤</button>
        <button class="toolbar-item" onclick="aiGenerate('smart')" title="AI Generate">‚ú®</button>
        <button class="toolbar-item" onclick="openBottomSheet('instruments')" title="Instruments">üé∏</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-item toolbar-add" onclick="openBottomSheet('toolbar-customize')" title="Customize">+</button>
    </div>
    
    <!-- Bottom Sheet Overlay -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay" onclick="closeBottomSheet()"></div>
    
    <!-- Settings Bottom Sheet -->
    <div class="bottom-sheet" id="settingsSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">‚öôÔ∏è Settings & More</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">‚úï</button>
        </div>
        <div class="bottom-sheet-body">
            <div class="accordion-panel open" data-accordion="display">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span class="icon">üé®</span>Display</div>
                    <span class="accordion-chevron">‚ñº</span>
                </div>
                <div class="accordion-body"><div class="accordion-content">
                    <div class="toolbar-option" onclick="toggleCompactMode(); closeBottomSheet();">
                        <span class="icon">üìê</span>
                        <div class="toolbar-option-info">
                            <div class="toolbar-option-name">Compact Mode</div>
                            <div class="toolbar-option-desc">Smaller controls & panels</div>
                        </div>
                    </div>
                    <div class="toolbar-option" onclick="toggleFullscreen(); closeBottomSheet();">
                        <span class="icon">‚õ∂</span>
                        <div class="toolbar-option-info">
                            <div class="toolbar-option-name">Fullscreen</div>
                            <div class="toolbar-option-desc">Hide header & navigation</div>
                        </div>
                    </div>
                    <div class="toolbar-option" onclick="openBottomSheet('themes');">
                        <span class="icon">üåà</span>
                        <div class="toolbar-option-info">
                            <div class="toolbar-option-name">Themes</div>
                            <div class="toolbar-option-desc">Change app colors</div>
                        </div>
                    </div>
                </div></div>
            </div>
            <div class="accordion-panel" data-accordion="quick-nav">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span class="icon">üß≠</span>Quick Navigation</div>
                    <span class="accordion-chevron">‚ñº</span>
                </div>
                <div class="accordion-body"><div class="accordion-content">
                    <div class="toolbar-option" onclick="switchTab('ai'); closeBottomSheet();"><span class="icon">ü§ñ</span><div class="toolbar-option-info"><div class="toolbar-option-name">AI Studio</div><div class="toolbar-option-desc">7 AI-powered tools</div></div></div>
                    <div class="toolbar-option" onclick="switchTab('beats'); closeBottomSheet();"><span class="icon">ü•Å</span><div class="toolbar-option-info"><div class="toolbar-option-name">Beats</div><div class="toolbar-option-desc">Melody & drum sequencer</div></div></div>
                    <div class="toolbar-option" onclick="switchTab('piano'); closeBottomSheet();"><span class="icon">üéº</span><div class="toolbar-option-info"><div class="toolbar-option-name">Piano Roll</div><div class="toolbar-option-desc">Visual note editor</div></div></div>
                    <div class="toolbar-option" onclick="switchTab('mixer'); closeBottomSheet();"><span class="icon">üéöÔ∏è</span><div class="toolbar-option-info"><div class="toolbar-option-name">Mixer</div><div class="toolbar-option-desc">EQ, compressor & effects</div></div></div>
                    <div class="toolbar-option" onclick="switchTab('sheet'); closeBottomSheet();"><span class="icon">üìú</span><div class="toolbar-option-info"><div class="toolbar-option-name">Sheet Music</div><div class="toolbar-option-desc">Staff notation view</div></div></div>
                    <div class="toolbar-option" onclick="switchTab('export'); closeBottomSheet();"><span class="icon">üíæ</span><div class="toolbar-option-info"><div class="toolbar-option-name">Export</div><div class="toolbar-option-desc">MIDI, WAV, MP3, PDF</div></div></div>
                </div></div>
            </div>
            <div class="accordion-panel" data-accordion="keyboard">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span class="icon">‚å®Ô∏è</span>Keyboard Shortcuts</div>
                    <span class="accordion-chevron">‚ñº</span>
                </div>
                <div class="accordion-body"><div class="accordion-content" style="font-size:13px; line-height:2;">
                    <div><b>Space</b> ‚Äî Play/Pause</div>
                    <div><b>Escape</b> ‚Äî Exit fullscreen</div>
                    <div><b>1-7</b> ‚Äî Switch tabs</div>
                    <div><b>G</b> ‚Äî Generate new progression</div>
                    <div><b>R</b> ‚Äî Randomize everything</div>
                </div></div>
            </div>
        </div>
    </div>
    
    <!-- Instruments Bottom Sheet -->
    <div class="bottom-sheet" id="instrumentsSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">üé∏ Instruments</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">‚úï</button>
        </div>
        <div class="bottom-sheet-body" id="instrumentsSheetBody">
            <!-- Populated dynamically -->
        </div>
    </div>
    
    <!-- Themes Bottom Sheet -->
    <div class="bottom-sheet" id="themesSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">üåà Themes</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">‚úï</button>
        </div>
        <div class="bottom-sheet-body">
            <div class="toolbar-option" onclick="setTheme('dark'); closeBottomSheet();"><span class="icon">üåô</span><div class="toolbar-option-info"><div class="toolbar-option-name">Dark</div><div class="toolbar-option-desc">Default dark theme</div></div></div>
            <div class="toolbar-option" onclick="setTheme('midnight'); closeBottomSheet();"><span class="icon">üåå</span><div class="toolbar-option-info"><div class="toolbar-option-name">Midnight</div><div class="toolbar-option-desc">Deep blue tones</div></div></div>
            <div class="toolbar-option" onclick="setTheme('sunset'); closeBottomSheet();"><span class="icon">üåÖ</span><div class="toolbar-option-info"><div class="toolbar-option-name">Sunset</div><div class="toolbar-option-desc">Warm orange & purple</div></div></div>
            <div class="toolbar-option" onclick="setTheme('forest'); closeBottomSheet();"><span class="icon">üå≤</span><div class="toolbar-option-info"><div class="toolbar-option-name">Forest</div><div class="toolbar-option-desc">Natural greens</div></div></div>
            <div class="toolbar-option" onclick="setTheme('ocean'); closeBottomSheet();"><span class="icon">üåä</span><div class="toolbar-option-info"><div class="toolbar-option-name">Ocean</div><div class="toolbar-option-desc">Cool blue waves</div></div></div>
            <div class="toolbar-option" onclick="setTheme('candy'); closeBottomSheet();"><span class="icon">üç¨</span><div class="toolbar-option-info"><div class="toolbar-option-name">Candy</div><div class="toolbar-option-desc">Pink & purple pastels</div></div></div>
            <div class="toolbar-option" onclick="setTheme('monochrome'); closeBottomSheet();"><span class="icon">‚¨õ</span><div class="toolbar-option-info"><div class="toolbar-option-name">Monochrome</div><div class="toolbar-option-desc">Black & white</div></div></div>
            <div class="toolbar-option" onclick="setTheme('light'); closeBottomSheet();"><span class="icon">‚òÄÔ∏è</span><div class="toolbar-option-info"><div class="toolbar-option-name">Light</div><div class="toolbar-option-desc">Bright light mode</div></div></div>
        </div>
    </div>
    
    <!-- Toolbar Customize Bottom Sheet -->
    <div class="bottom-sheet" id="toolbar-customizeSheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">üîß Customize Toolbar</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">‚úï</button>
        </div>
        <div class="bottom-sheet-body">
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:16px;">Select actions to show in your quick toolbar:</p>
            <div class="toolbar-option" onclick="toggleToolbarItem('play', this)"><span class="icon">‚ñ∂Ô∏è</span><div class="toolbar-option-info"><div class="toolbar-option-name">Play/Stop</div><div class="toolbar-option-desc">Playback controls</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('random', this)"><span class="icon">üé≤</span><div class="toolbar-option-info"><div class="toolbar-option-name">Randomize</div><div class="toolbar-option-desc">New random progression</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('ai', this)"><span class="icon">‚ú®</span><div class="toolbar-option-info"><div class="toolbar-option-name">AI Generate</div><div class="toolbar-option-desc">Smart AI creation</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('instrument', this)"><span class="icon">üé∏</span><div class="toolbar-option-info"><div class="toolbar-option-name">Instruments</div><div class="toolbar-option-desc">Quick instrument picker</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('tempo', this)"><span class="icon">‚è±Ô∏è</span><div class="toolbar-option-info"><div class="toolbar-option-name">Tempo</div><div class="toolbar-option-desc">Quick tempo adjust</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('record', this)"><span class="icon">üî¥</span><div class="toolbar-option-info"><div class="toolbar-option-name">Record</div><div class="toolbar-option-desc">Start recording</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('metronome', this)"><span class="icon">üéµ</span><div class="toolbar-option-info"><div class="toolbar-option-name">Metronome</div><div class="toolbar-option-desc">Toggle click track</div></div></div>
            <div class="toolbar-option" onclick="toggleToolbarItem('fullscreen', this)"><span class="icon">‚õ∂</span><div class="toolbar-option-info"><div class="toolbar-option-name">Fullscreen</div><div class="toolbar-option-desc">Toggle fullscreen mode</div></div></div>
        </div>
        <div class="bottom-sheet-actions">
            <button class="bottom-sheet-btn secondary" onclick="resetToolbar()">Reset Default</button>
            <button class="bottom-sheet-btn primary" onclick="closeBottomSheet()">Done</button>
        </div>
    </div>

    <script>
        // STATE
        const state = {
            mode: 'solo', tempo: 120, key: 'C', genre: 'pop',
            isPlaying: false, progression: ['C', 'G', 'Am', 'F'],
            currentInstrument: 'grand-piano', instrumentName: 'üéπ Grand Piano',
            timeSignature: 4, metronomeActive: false, metronomeBeat: 0, metronomeInterval: null,
            mixerLevels: { main: 80, bass: 70, drums: 75, strings: 60 },
            eq: { low: 0, lowMid: 0, mid: 0, highMid: 0, high: 0 },
            compressor: { threshold: -24, ratio: 4, attack: 10, release: 100 },
            pianoRollNotes: [], pianoSnap: true, isExporting: false, currentTheme: 'dark',
            customColors: { bg: '#0a0a0f', accent: '#667eea', card: '#1a1a2e', text: '#f1f5f9' }
        };

        const instruments = [
            { id: 'grand-piano', name: 'Grand Piano', icon: 'üéπ' },
            { id: 'electric-piano', name: 'Electric Piano', icon: 'üéπ' },
            { id: 'organ', name: 'Organ', icon: 'üéõÔ∏è' },
            { id: 'synth-pad', name: 'Synth Pad', icon: 'üéß' },
            { id: 'acoustic-guitar', name: 'Acoustic', icon: 'üé∏' },
            { id: 'strings', name: 'Strings', icon: 'üéª' },
            { id: 'trumpet', name: 'Trumpet', icon: 'üé∫' },
            { id: 'saxophone', name: 'Saxophone', icon: 'üé∑' },
            { id: 'bell', name: 'Bell', icon: 'üîî' }
        ];

        const pianoNotes = ['C5', 'B4', 'A#4', 'A4', 'G#4', 'G4', 'F#4', 'F4', 'E4', 'D#4', 'D4', 'C#4', 'C4', 'B3'];
        const blackKeys = ['A#4', 'G#4', 'F#4', 'D#4', 'C#4'];

        // AUDIO
        let audioInit = false, mainSynth = null, bassSynth = null, metronomeClick = null, reverb = null, filter = null, eq3 = null, compressor = null;

        async function initAudio() {
            if (audioInit) return;
            await Tone.start();
            compressor = new Tone.Compressor({ threshold: -24, ratio: 4, attack: 0.01, release: 0.1 }).toDestination();
            eq3 = new Tone.EQ3({ low: 0, mid: 0, high: 0 }).connect(compressor);
            reverb = new Tone.Reverb({ decay: 2.5, wet: 0.25 }).connect(eq3);
            await reverb.generate();
            filter = new Tone.Filter({ frequency: 5000, type: 'lowpass' }).connect(reverb);
            mainSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, envelope: { attack: 0.005, decay: 1.2, sustain: 0.3, release: 1.8 } }).connect(filter);
            mainSynth.volume.value = -6;
            bassSynth = new Tone.MonoSynth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.4 } }).toDestination();
            bassSynth.volume.value = -8;
            metronomeClick = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            metronomeClick.volume.value = -10;
            audioInit = true;
        }

        const chordNotes = {
            'C': ['C4', 'E4', 'G4'], 'Cm': ['C4', 'Eb4', 'G4'], 'D': ['D4', 'F#4', 'A4'], 'Dm': ['D4', 'F4', 'A4'],
            'E': ['E4', 'G#4', 'B4'], 'Em': ['E4', 'G4', 'B4'], 'F': ['F4', 'A4', 'C5'], 'Fm': ['F4', 'Ab4', 'C5'],
            'G': ['G4', 'B4', 'D5'], 'Gm': ['G4', 'Bb4', 'D5'], 'A': ['A4', 'C#5', 'E5'], 'Am': ['A4', 'C5', 'E5'],
            'B': ['B4', 'D#5', 'F#5'], 'Bm': ['B4', 'D5', 'F#5'], 'Cmaj7': ['C4', 'E4', 'G4', 'B4'],
            'Dm7': ['D4', 'F4', 'A4', 'C5'], 'G7': ['G4', 'B4', 'D5', 'F5'], 'Am7': ['A4', 'C5', 'E5', 'G5']
        };
        const progressions = {
            pop: { C: ['C','G','Am','F'], G: ['G','D','Em','C'], Am: ['Am','F','C','G'] },
            rock: { C: ['C','F','G','C'], G: ['G','C','D','G'], Am: ['Am','G','F','E'] },
            jazz: { C: ['Cmaj7','Dm7','G7','Cmaj7'], Am: ['Am7','Dm7','G7','Cmaj7'] },
            blues: { C: ['C','C','F','C'], G: ['G','C','D','G'] },
            lofi: { C: ['Cmaj7','Am7','Dm7','G7'], Am: ['Am7','Dm7','Cmaj7','G7'] },
            edm: { C: ['C','G','Am','F'], Am: ['Am','F','C','G'] },
            classical: { C: ['C','G','Am','F','G','C'], Am: ['Am','Dm','E','Am'] }
        };
        const numerals = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bm': 'vii¬∞', 'Cmaj7': 'Imaj7', 'Dm7': 'ii7', 'G7': 'V7', 'Am7': 'vi7' };

        // METRONOME
        function toggleMetronome() {
            initAudio();
            state.metronomeActive = !state.metronomeActive;
            if (state.metronomeActive) { startMetronome(); document.getElementById('metronomeBtn').classList.add('metronome-active'); document.getElementById('metronomePlayBtn').textContent = '‚è∏Ô∏è'; }
            else { stopMetronome(); document.getElementById('metronomeBtn').classList.remove('metronome-active'); document.getElementById('metronomePlayBtn').textContent = '‚ñ∂Ô∏è'; }
        }
        function startMetronome() {
            const interval = 60000 / state.tempo;
            state.metronomeBeat = 0;
            playMetronomeTick();
            state.metronomeInterval = setInterval(playMetronomeTick, interval);
        }
        function stopMetronome() {
            if (state.metronomeInterval) { clearInterval(state.metronomeInterval); state.metronomeInterval = null; }
            document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
        }
        function playMetronomeTick() {
            if (metronomeClick) metronomeClick.triggerAttackRelease(state.metronomeBeat === 0 ? 'C5' : 'G4', '32n');
            const visual = document.getElementById('metronomeVisual');
            visual.classList.remove('tick', 'tock');
            visual.classList.add(state.metronomeBeat % 2 === 0 ? 'tick' : 'tock');
            document.querySelectorAll('.beat-dot').forEach((dot, i) => dot.classList.toggle('active', i === state.metronomeBeat));
            state.metronomeBeat = (state.metronomeBeat + 1) % state.timeSignature;
        }
        function adjustMetronomeTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('metronomeTempoValue').textContent = state.tempo;
            document.getElementById('tempoDisplay').textContent = state.tempo;
            if (state.metronomeActive) { stopMetronome(); startMetronome(); }
        }
        function setTimeSignature(beats, btn) {
            state.timeSignature = beats;
            document.querySelectorAll('.time-sig-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('beatIndicator').innerHTML = Array(beats).fill(0).map((_, i) => `<div class="beat-dot ${i === 0 ? 'downbeat' : ''}"></div>`).join('');
            if (state.metronomeActive) { stopMetronome(); state.metronomeBeat = 0; startMetronome(); }
            showToast(`Time: ${beats}/4`);
        }

        // MIXER
        function renderMixer() {
            const channels = [{ id: 'main', name: 'Main', icon: 'üéπ', level: 80 }, { id: 'bass', name: 'Bass', icon: 'üé∏', level: 70 }, { id: 'drums', name: 'Drums', icon: 'ü•Å', level: 75 }, { id: 'strings', name: 'Strings', icon: 'üéª', level: 60 }];
            document.getElementById('mixerChannels').innerHTML = channels.map(ch => `
                <div class="mixer-channel">
                    <div class="mixer-icon">${ch.icon}</div>
                    <div class="mixer-name">${ch.name}</div>
                    <div class="mixer-fader-wrap"><input type="range" class="mixer-fader" min="0" max="100" value="${ch.level}" orient="vertical" oninput="setMixerLevel('${ch.id}', this.value, this)"></div>
                    <div class="mixer-value">${ch.level}%</div>
                </div>
            `).join('');
        }
        function setMixerLevel(channel, value, el) {
            state.mixerLevels[channel] = parseInt(value);
            if (channel === 'main' && mainSynth) mainSynth.volume.value = -30 + (value * 0.3);
            el.parentElement.nextElementSibling.textContent = value + '%';
        }
        function updateEQ(band, value) {
            state.eq[band] = parseInt(value);
            document.getElementById(`eq${band.charAt(0).toUpperCase() + band.slice(1).replace('Mid', 'Mid')}`).textContent = value + 'dB';
            if (eq3) { if (band === 'low') eq3.low.value = value; else if (band === 'mid') eq3.mid.value = value; else if (band === 'high') eq3.high.value = value; }
        }
        function adjustCompressor(param) {
            const presets = { threshold: [-12, -18, -24, -30, -36], ratio: [2, 4, 8, 12, 20], attack: [1, 5, 10, 20, 50], release: [50, 100, 200, 500, 1000] };
            const values = presets[param];
            const idx = (values.indexOf(state.compressor[param]) + 1) % values.length;
            state.compressor[param] = values[idx];
            const display = param === 'ratio' ? `${values[idx]}:1` : param === 'threshold' ? values[idx] : `${values[idx]}ms`;
            document.getElementById(`comp${param.charAt(0).toUpperCase() + param.slice(1)}`).textContent = display;
            showToast(`${param}: ${display}`);
        }

        // PIANO ROLL
        function renderPianoRoll() {
            const beats = 16;
            document.getElementById('pianoKeys').innerHTML = pianoNotes.map(note => `<div class="piano-key ${blackKeys.includes(note) ? 'black' : 'white'}" onclick="playPianoKey('${note}')">${note}</div>`).join('');
            document.getElementById('pianoGridInner').innerHTML = pianoNotes.map(note => `<div class="piano-row ${blackKeys.includes(note) ? 'black-row' : ''}">${Array(beats).fill(0).map((_, col) => `<div class="piano-cell ${col % 4 === 0 ? 'beat-start' : ''}" data-note="${note}" data-beat="${col}" onclick="togglePianoCell(this, '${note}', ${col})"></div>`).join('')}</div>`).join('');
        }
        function playPianoKey(note) { initAudio().then(() => { if (mainSynth) mainSynth.triggerAttackRelease(note, '8n'); }); }
        function togglePianoCell(cell, note, beat) { cell.classList.toggle('active'); if (cell.classList.contains('active')) playPianoKey(note); }
        function clearPianoRoll() { document.querySelectorAll('.piano-cell.active').forEach(c => c.classList.remove('active')); showToast('Piano roll cleared'); }
        function loadChordsToPianoRoll() {
            clearPianoRoll();
            state.progression.forEach((chord, chordIdx) => {
                const notes = chordNotes[chord] || ['C4', 'E4', 'G4'];
                notes.forEach(note => { const cell = document.querySelector(`.piano-cell[data-note="${note}"][data-beat="${chordIdx * 4}"]`); if (cell) cell.classList.add('active'); });
            });
            showToast('Chords loaded');
        }
        function toggleSnap() { state.pianoSnap = !state.pianoSnap; document.getElementById('pianoSnapBtn').classList.toggle('active', state.pianoSnap); showToast(`Snap: ${state.pianoSnap ? 'ON' : 'OFF'}`); }
        function renderQuickPianoKeys() {
            const quickNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
            document.getElementById('quickPianoKeys').innerHTML = quickNotes.map(note => `<div class="instrument-card" onclick="playPianoKey('${note}')"><div class="icon">üéπ</div><div class="name">${note}</div></div>`).join('');
        }

        // SHEET MUSIC - Canvas Rendering
        function renderSheetMusic() {
            const canvas = document.getElementById('sheetCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const display = document.getElementById('notationDisplay')?.value || 'chords';
            const size = document.getElementById('notationSize')?.value || 'medium';
            const sizeMap = { small: 16, medium: 22, large: 28 };
            const fontSize = sizeMap[size];
            
            // Set canvas size based on container
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth - 40 || 560;
            canvas.height = 180;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw staff lines
            const staffY = 90;
            const lineSpacing = 10;
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(20, staffY + i * lineSpacing);
                ctx.lineTo(canvas.width - 20, staffY + i * lineSpacing);
                ctx.stroke();
            }
            
            // Draw treble clef
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 60px serif';
            ctx.fillText('ùÑû', 25, staffY + 38);
            
            // Draw time signature
            ctx.font = 'bold 24px Arial';
            ctx.fillText(state.timeSignature.toString(), 80, staffY + 15);
            ctx.fillText('4', 80, staffY + 38);
            
            // Draw bar line after time signature
            ctx.beginPath();
            ctx.moveTo(105, staffY);
            ctx.lineTo(105, staffY + 40);
            ctx.stroke();
            
            // Draw chord symbols
            const startX = 120;
            const chordSpacing = (canvas.width - startX - 40) / state.progression.length;
            
            ctx.font = `bold ${fontSize}px Arial`;
            state.progression.forEach((chord, i) => {
                const x = startX + i * chordSpacing + chordSpacing / 2;
                const roman = numerals[chord] || '';
                
                // Draw chord name above staff
                ctx.fillStyle = '#1a1a2e';
                if (display === 'chords' || display === 'both') {
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(chord, x, staffY - 20);
                }
                
                // Draw roman numeral
                if (display === 'roman' || display === 'both') {
                    ctx.font = `${fontSize - 6}px Arial`;
                    ctx.fillStyle = '#666666';
                    const romanY = display === 'both' ? staffY - 5 : staffY - 20;
                    ctx.fillText(roman, x, romanY);
                }
                
                // Draw whole note on staff
                ctx.fillStyle = '#333333';
                ctx.beginPath();
                ctx.ellipse(x, staffY + 20, 8, 6, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Draw bar line after each chord (except last)
                if (i < state.progression.length - 1) {
                    ctx.beginPath();
                    ctx.moveTo(x + chordSpacing / 2 - 10, staffY);
                    ctx.lineTo(x + chordSpacing / 2 - 10, staffY + 40);
                    ctx.stroke();
                }
            });
            
            // Draw final double bar line
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(canvas.width - 30, staffY);
            ctx.lineTo(canvas.width - 30, staffY + 40);
            ctx.stroke();
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(canvas.width - 25, staffY);
            ctx.lineTo(canvas.width - 25, staffY + 40);
            ctx.stroke();
            
            // Draw title
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Key: ${state.key} | ${state.genre.charAt(0).toUpperCase() + state.genre.slice(1)} | ${state.tempo} BPM`, 20, 25);
        }
        
        function exportSheetPNG() {
            const canvas = document.getElementById('sheetCanvas');
            if (!canvas) { showToast('‚ùå Canvas not found'); return; }
            const link = document.createElement('a');
            link.download = `ChordFlow_${state.key}_${state.genre}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('üñºÔ∏è PNG downloaded!');
        }
        async function exportSheetPDF() {
            showToast('Generating PDF...');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(24); doc.text('ChordFlow', 105, 20, { align: 'center' });
                doc.setFontSize(14); doc.text(`Key: ${state.key} | Genre: ${state.genre} | Tempo: ${state.tempo} BPM`, 105, 30, { align: 'center' });
                const staffY = 60; doc.setLineWidth(0.3);
                for (let i = 0; i < 5; i++) doc.line(20, staffY + i * 6, 190, staffY + i * 6);
                doc.setFontSize(40); doc.text('G', 25, staffY + 20);
                doc.setFontSize(20); doc.text(state.timeSignature.toString(), 45, staffY + 10); doc.text('4', 45, staffY + 22);
                doc.setFontSize(18); let x = 65;
                state.progression.forEach(chord => { doc.text(chord, x, staffY - 10); doc.setFontSize(12); doc.text(numerals[chord] || '', x, staffY - 2); doc.setFontSize(18); x += 30; });
                doc.setFontSize(10); doc.text('Generated by ChordFlow v12.0', 105, 280, { align: 'center' });
                doc.save(`ChordFlow_${state.key}_${state.genre}.pdf`);
                showToast('üìÑ PDF downloaded!');
            } catch (err) { showToast('‚ùå PDF export failed'); }
        }
        function printSheet() { window.print(); showToast('üñ®Ô∏è Print dialog opened'); }

        // THEMES
        function setTheme(theme, btn) {
            document.body.classList.remove('theme-light', 'theme-midnight', 'theme-ocean', 'theme-forest', 'theme-sunset', 'theme-candy', 'theme-custom');
            document.querySelectorAll('.theme-preset').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            if (theme !== 'dark' && theme !== 'custom') document.body.classList.add(`theme-${theme}`);
            else if (theme === 'custom') applyCustomTheme();
            state.currentTheme = theme;
            localStorage.setItem('chordflow-theme', theme);
            showToast(`Theme: ${theme}`);
        }
        function updateCustomTheme() {
            state.customColors = { bg: document.getElementById('customBg').value, accent: document.getElementById('customAccent').value, card: document.getElementById('customCard').value, text: document.getElementById('customText').value };
            if (state.currentTheme === 'custom') applyCustomTheme();
            localStorage.setItem('chordflow-custom-colors', JSON.stringify(state.customColors));
        }
        function applyCustomTheme() {
            document.body.classList.add('theme-custom');
            document.documentElement.style.setProperty('--bg-primary', state.customColors.bg);
            document.documentElement.style.setProperty('--accent', state.customColors.accent);
            document.documentElement.style.setProperty('--bg-card', state.customColors.card);
            document.documentElement.style.setProperty('--text-primary', state.customColors.text);
        }

        // PLAYBACK
        let playLoop = null, currentChordIndex = 0;
        async function togglePlayback() { await initAudio(); if (state.isPlaying) stopPlayback(); else startPlayback(); }
        function startPlayback() {
            state.isPlaying = true; document.getElementById('playBtn').textContent = '‚è∏Ô∏è'; currentChordIndex = 0;
            playCurrentChord(); playLoop = setInterval(() => { currentChordIndex = (currentChordIndex + 1) % state.progression.length; playCurrentChord(); }, (60 / state.tempo) * 2 * 1000);
        }
        function stopPlayback() {
            state.isPlaying = false; document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
            if (playLoop) { clearInterval(playLoop); playLoop = null; }
            if (mainSynth && mainSynth.releaseAll) mainSynth.releaseAll();
            document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing'));
            document.getElementById('nowPlaying').textContent = 'Ready to jam';
        }
        function playCurrentChord() {
            const chord = state.progression[currentChordIndex];
            const notes = chordNotes[chord] || chordNotes['C'];
            if (mainSynth) { if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttack(notes); }
            if ((state.mode === 'band' || state.mode === 'orchestra') && bassSynth) bassSynth.triggerAttackRelease(notes[0].replace('4', '2').replace('5', '3'), '2n');
            document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === currentChordIndex));
            document.getElementById('nowPlaying').textContent = `Playing: ${chord}`;
        }
        function playChord(chord, index) {
            initAudio().then(() => {
                const notes = chordNotes[chord] || chordNotes['C'];
                if (mainSynth) { if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttackRelease(notes, '1n'); }
                document.querySelectorAll('.chord-card').forEach((c, i) => c.classList.toggle('playing', i === index));
                setTimeout(() => document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing')), 500);
            });
        }
        function adjustTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
            document.getElementById('metronomeTempoValue').textContent = state.tempo;
            if (state.isPlaying) { stopPlayback(); startPlayback(); }
            if (state.metronomeActive) { stopMetronome(); startMetronome(); }
        }

        // UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            if (tabId === 'sheet') setTimeout(renderSheetMusic, 50);
            if (tabId === 'beats') setTimeout(initBeatsTab, 50);
        }
        function setMode(mode, btn) {
            state.mode = mode;
            document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updatePlaybackInfo(); updateActiveInstruments();
            showToast(`${mode.charAt(0).toUpperCase() + mode.slice(1)} mode`);
        }
        function selectInstrument(id, name, icon) {
            state.currentInstrument = id; state.instrumentName = `${icon} ${name}`;
            document.getElementById('currentSound').textContent = state.instrumentName;
            document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.instrument-card').classList.add('active');
            updateActiveInstruments(); showToast(state.instrumentName);
        }
        function updateKey() { state.key = document.getElementById('keySelect').value; generateProgression(); }
        function updateGenre() { state.genre = document.getElementById('genreSelect').value; generateProgression(); }
        function generateProgression() {
            const genreProgs = progressions[state.genre] || progressions.pop;
            state.progression = genreProgs[state.key] || genreProgs['C'] || ['C', 'G', 'Am', 'F'];
            renderChords(); updatePlaybackInfo(); renderSheetMusic();
        }
        function renderChords() { document.getElementById('chordGrid').innerHTML = state.progression.map((chord, i) => `<div class="chord-card" onclick="playChord('${chord}', ${i})"><div class="chord-name">${chord}</div><div class="chord-numeral">${numerals[chord] || ''}</div></div>`).join(''); }
        function renderInstruments() { document.getElementById('instrumentList').innerHTML = instruments.map(inst => `<div class="instrument-card ${inst.id === state.currentInstrument ? 'active' : ''}" onclick="selectInstrument('${inst.id}', '${inst.name}', '${inst.icon}')"><div class="icon">${inst.icon}</div><div class="name">${inst.name}</div></div>`).join(''); }
        function updatePlaybackInfo() { document.getElementById('playbackSub').textContent = `${state.progression.length} chords ‚Ä¢ ${state.key} ‚Ä¢ ${state.mode.charAt(0).toUpperCase() + state.mode.slice(1)}`; }
        function updateActiveInstruments() {
            let html = `<div class="active-inst"><span class="dot" style="background: var(--keys)"></span> ${state.instrumentName.replace(/^./, '')}</div>`;
            if (state.mode === 'band' || state.mode === 'orchestra') { html += '<div class="active-inst"><span class="dot" style="background: var(--bass)"></span> Bass</div><div class="active-inst"><span class="dot" style="background: var(--drums)"></span> Drums</div>'; }
            document.getElementById('activeInstruments').innerHTML = html;
        }

        // EXPORT
        const noteToMidi = { 'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11 };
        function noteNameToMidi(n) { const m = n.match(/([A-G][#b]?)(\d)/); return m ? noteToMidi[m[1]] + (parseInt(m[2]) + 1) * 12 : 60; }
        function writeVarLength(v) { const r = [v & 0x7F]; v >>= 7; while (v > 0) { r.unshift((v & 0x7F) | 0x80); v >>= 7; } return r; }
        function createMIDIFile() {
            const tpb = 480, header = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (tpb >> 8) & 0xFF, tpb & 0xFF];
            let td = []; const mpb = Math.round(60000000 / state.tempo);
            td.push(0, 0xFF, 0x51, 3, (mpb >> 16) & 0xFF, (mpb >> 8) & 0xFF, mpb & 0xFF);
            state.progression.forEach(chord => {
                const notes = chordNotes[chord] || chordNotes['C'];
                notes.forEach((n, i) => td.push(...writeVarLength(i === 0 ? 0 : 0), 0x90, noteNameToMidi(n), 100));
                notes.forEach((n, i) => td.push(...writeVarLength(i === 0 ? tpb * 2 : 0), 0x80, noteNameToMidi(n), 0));
            });
            td.push(0, 0xFF, 0x2F, 0);
            return new Uint8Array([...header, 0x4D, 0x54, 0x72, 0x6B, (td.length >> 24) & 0xFF, (td.length >> 16) & 0xFF, (td.length >> 8) & 0xFF, td.length & 0xFF, ...td]);
        }
        async function exportMIDI() {
            if (state.isExporting) return; state.isExporting = true;
            showExportProgress('Generating MIDI...');
            await updateProgress(50, 'Creating MIDI...'); const midi = createMIDIFile();
            await updateProgress(100, 'Complete!');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([midi], { type: 'audio/midi' }));
            a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.mid`; a.click();
            showToast('üéπ MIDI downloaded!'); hideExportProgress(); state.isExporting = false;
        }
        async function exportWAV() {
            if (state.isExporting) return; state.isExporting = true;
            showExportProgress('Recording audio...'); await initAudio();
            const dest = Tone.context.createMediaStreamDestination();
            const recorder = new MediaRecorder(dest.stream, { mimeType: 'audio/webm' });
            const chunks = []; recorder.ondataavailable = e => chunks.push(e.data);
            mainSynth.connect(dest); recorder.start();
            const mspc = (60000 / state.tempo) * 2;
            for (let i = 0; i < state.progression.length; i++) {
                await updateProgress(20 + (i / state.progression.length) * 60, `Recording: ${state.progression[i]}`);
                const notes = chordNotes[state.progression[i]] || chordNotes['C'];
                if (mainSynth.releaseAll) mainSynth.releaseAll(); mainSynth.triggerAttack(notes);
                await new Promise(r => setTimeout(r, mspc - 100)); if (mainSynth.releaseAll) mainSynth.releaseAll(); await new Promise(r => setTimeout(r, 100));
            }
            await new Promise(res => { recorder.onstop = res; recorder.stop(); });
            await updateProgress(100, 'Complete!');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, { type: 'audio/webm' }));
            a.download = `ChordFlow_${state.key}_${state.genre}_${Date.now()}.webm`; a.click();
            mainSynth.disconnect(dest); mainSynth.connect(filter);
            showToast('üéµ Audio downloaded!'); hideExportProgress(); state.isExporting = false;
        }
        async function exportMP3() { await exportWAV(); }
        function showExportProgress(text) { document.getElementById('exportProgress').classList.add('active'); document.getElementById('progressText').textContent = text; document.getElementById('progressFill').style.width = '0%'; }
        function hideExportProgress() { setTimeout(() => document.getElementById('exportProgress').classList.remove('active'), 1000); }
        async function updateProgress(pct, text) { document.getElementById('progressFill').style.width = pct + '%'; document.getElementById('progressText').textContent = text; await new Promise(r => setTimeout(r, 100)); }
        function shareSong() { navigator.clipboard.writeText(`üéµ ChordFlow\nKey: ${state.key}\nGenre: ${state.genre}\nChords: ${state.progression.join(' ‚Üí ')}\n${window.location.href}`).then(() => showToast('üìã Copied!')); }
        function shareNative() { if (navigator.share) navigator.share({ title: 'ChordFlow', text: `Chord progression: ${state.progression.join(' ‚Üí ')}`, url: window.location.href }); else shareSong(); }

        // AI
        async function aiGenerate(type) {
            const btn = event?.target?.closest('.ai-btn') || event?.target?.closest('.big-generate-btn');
            if (btn) btn.classList.add('loading');
            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: `Generate a ${state.genre} chord progression in ${state.key}. Return ONLY a JSON array like ["C", "G", "Am", "F"].`, action: type }) });
                const data = await res.json();
                if (data.result) { const m = data.result.match(/\[[\s\S]*?\]/); if (m) { const chords = JSON.parse(m[0]).filter(c => chordNotes[c]); if (chords.length) { state.progression = chords; renderChords(); renderSheetMusic(); showToast('‚ú® AI generated!'); } } }
            } catch (err) { generateProgression(); showToast('üé≤ Random progression'); }
            if (btn) btn.classList.remove('loading');
        }

        // ADVANCED AI FEATURES
        const GEMINI_KEY = 'AIzaSyBR1mD1zdnn39IbaQQs99mL5nFxsoNB9dM';
        
        async function callGeminiAI(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.9, maxOutputTokens: 1024 } })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (err) {
                console.error('Gemini error:', err);
                return null;
            }
        }

        async function generateMelody(btn) {
            btn.classList.add('loading');
            const style = document.getElementById('melodyStyle').value;
            const range = document.getElementById('melodyRange').value;
            const prompt = `You are a music composition AI. Generate a melody for these chords: ${state.progression.join(' - ')} in ${state.key} ${state.genre}.
Style: ${style}, Range: ${range}.
Return ONLY a JSON object like: {"notes": ["C4", "E4", "G4", "E4", "D4", "C4"], "rhythm": ["quarter", "quarter", "half", "quarter", "quarter", "whole"], "description": "A simple ascending melody"}
Use standard note names with octave numbers (C4 is middle C). Keep it 8-16 notes.`;
            
            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('melodyResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const melody = JSON.parse(jsonMatch[0]);
                        state.generatedMelody = melody;
                        let html = `<span class="result-title">üéµ Generated Melody</span>`;
                        html += `<div style="margin: 8px 0;">${melody.notes.map(n => `<span class="melody-note">${n}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px;">${melody.description || 'AI-generated melody'}</div>`;
                        html += `<button onclick="playMelody()" style="margin-top: 10px; padding: 8px 16px; background: var(--success); border: none; border-radius: 8px; color: white; cursor: pointer;">‚ñ∂Ô∏è Play Melody</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üéµ Melody generated!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üéµ Melody Suggestion</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallbackMelody = generateFallbackMelody();
                resultDiv.innerHTML = `<span class="result-title">üéµ Generated Melody</span>\n${fallbackMelody.map(n => `<span class="melody-note">${n}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackMelody() {
            const scaleNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
            const melody = [];
            for (let i = 0; i < 8; i++) {
                melody.push(scaleNotes[Math.floor(Math.random() * scaleNotes.length)]);
            }
            state.generatedMelody = { notes: melody };
            return melody;
        }

        async function playMelody() {
            if (!state.generatedMelody?.notes) return;
            await initAudio();
            const now = Tone.now();
            state.generatedMelody.notes.forEach((note, i) => {
                mainSynth.triggerAttackRelease(note, '8n', now + i * 0.3);
            });
            showToast('üéµ Playing melody...');
        }

        async function generateLyrics(btn) {
            btn.classList.add('loading');
            const theme = document.getElementById('lyricsTheme').value;
            const mood = document.getElementById('lyricsMood').value;
            const keywords = document.getElementById('lyricsKeywords').value;
            
            const prompt = `You are a professional songwriter. Write lyrics for a ${state.genre} song.
Theme: ${theme}, Mood: ${mood}
Chord progression: ${state.progression.join(' - ')} in ${state.key}
${keywords ? `Include these concepts: ${keywords}` : ''}

Write a verse and chorus. Format:
[Verse]
(4 lines)

[Chorus]
(4 lines)

Make it emotional, poetic, and fitting for the ${state.genre} genre. Keep lines short and singable.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('lyricsResult');
            
            if (result) {
                state.generatedLyrics = result;
                resultDiv.innerHTML = `<span class="result-title">‚úçÔ∏è Generated Lyrics</span>\n${result}`;
                resultDiv.classList.add('active');
                showToast('‚úçÔ∏è Lyrics written!');
            } else {
                const fallback = generateFallbackLyrics(theme, mood);
                resultDiv.innerHTML = `<span class="result-title">‚úçÔ∏è Generated Lyrics</span>\n${fallback}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackLyrics(theme, mood) {
            const templates = {
                love: `[Verse]\nIn your eyes I see the stars tonight\nEvery moment feels so right\nHolding on to what we've found\nLove that keeps us on the ground\n\n[Chorus]\nYou're the one I've waited for\nOpen up another door\nTogether we will find our way\nStarting from today`,
                heartbreak: `[Verse]\nEmpty rooms and memories\nFading photos on the wall\nI remember how we used to be\nBefore the silence took it all\n\n[Chorus]\nNow I'm learning how to breathe\nWithout you here with me\nPicking up the pieces of my heart\nMaking a brand new start`,
                party: `[Verse]\nLights are flashing, bass is pumping\nEverybody's jumping high\nFeeling like we own the night\nReaching for the sky\n\n[Chorus]\nLet's go, let's go, let's go tonight\nEverything's gonna be alright\nDance until the morning light\nWe're feeling so alive`
            };
            return templates[theme] || templates.love;
        }

        async function transferStyle(targetGenre, btn) {
            document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('loading'));
            btn.classList.add('loading');
            
            const prompt = `You are a music theory expert. Transform this chord progression from ${state.genre} to ${targetGenre}:
Current: ${state.progression.join(' - ')} in ${state.key}

Return ONLY a JSON object like: {"chords": ["Cmaj7", "G7", "Am9", "Fmaj7"], "explanation": "Added jazz extensions"}
Use chords that exist in standard notation. Keep similar harmonic function but with ${targetGenre} flavor.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('styleResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const transfer = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üé≠ ${targetGenre.toUpperCase()} Style</span>\n`;
                        html += `<div style="margin: 8px 0;">${transfer.chords.map(c => `<span class="chord-tag" onclick="applyTransferChords(['${transfer.chords.join("','")}'])">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${transfer.explanation || ''}</div>`;
                        html += `<button onclick="applyTransferChords(['${transfer.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer;">‚úÖ Apply These Chords</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast(`üé≠ ${targetGenre} style ready!`);
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé≠ Style Transfer</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallback = generateStyleFallback(targetGenre);
                resultDiv.innerHTML = `<span class="result-title">üé≠ ${targetGenre.toUpperCase()} Style</span>\n${fallback.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function applyTransferChords(chords) {
            const validChords = chords.filter(c => {
                const base = c.replace(/maj7|m7|7|9|11|13|dim|aug|sus[24]?|add\d+/gi, '').replace(/[#b]$/, '');
                return ['C','D','E','F','G','A','B'].includes(base.charAt(0).toUpperCase());
            });
            if (validChords.length > 0) {
                state.progression = validChords;
                renderChords();
                renderSheetMusic();
                showToast('‚úÖ Chords applied!');
            }
        }

        function generateStyleFallback(genre) {
            const styles = {
                jazz: ['Cmaj7', 'Am7', 'Dm7', 'G7'],
                classical: ['C', 'F', 'G', 'C'],
                edm: ['Am', 'F', 'C', 'G'],
                rnb: ['Fmaj7', 'Em7', 'Dm7', 'Cmaj7'],
                country: ['G', 'C', 'D', 'G'],
                metal: ['E5', 'C5', 'G5', 'D5'],
                bossa: ['Dm7', 'G7', 'Cmaj7', 'A7'],
                gospel: ['C', 'C/E', 'F', 'G']
            };
            return styles[genre] || ['C', 'G', 'Am', 'F'];
        }

        async function enhanceChords(enhanceType, btn) {
            document.querySelectorAll('.enhance-btn').forEach(b => b.classList.remove('loading'));
            btn.classList.add('loading');
            
            const prompts = {
                extensions: `Add 7ths, 9ths, or other extensions to: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": ["Cmaj7", "G9", "Am7", "Fmaj9"], "explanation": "..."}`,
                substitutions: `Apply tritone or relative substitutions to: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`,
                passing: `Add chromatic passing chords between: ${state.progression.join(' - ')}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`,
                reharmonize: `Completely reharmonize with different approach: ${state.progression.join(' - ')} in ${state.key}. Return ONLY JSON: {"chords": [...], "explanation": "..."}`
            };

            const result = await callGeminiAI(prompts[enhanceType]);
            const resultDiv = document.getElementById('enhanceResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const enhanced = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üéπ Enhanced Chords</span>\n`;
                        html += `<div style="margin: 8px 0;">${enhanced.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${enhanced.explanation || ''}</div>`;
                        html += `<button onclick="applyTransferChords(['${enhanced.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer;">‚úÖ Apply Enhanced Chords</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üéπ Chords enhanced!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üéπ Enhancement</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const fallback = enhanceFallback(enhanceType);
                resultDiv.innerHTML = `<span class="result-title">üéπ Enhanced</span>\n${fallback.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function enhanceFallback(type) {
            const base = state.progression.map(c => c.replace(/[0-9]/g, ''));
            if (type === 'extensions') return base.map(c => c + (c.includes('m') ? '7' : 'maj7'));
            if (type === 'substitutions') return base.map((c, i) => i === 1 ? 'Dm7' : c);
            return base;
        }

        async function generateStructure(btn) {
            btn.classList.add('loading');
            const structureType = document.getElementById('structureType').value;
            
            const prompt = `You are a professional songwriter. Create a complete ${structureType} song structure using this progression: ${state.progression.join(' - ')} in ${state.key} ${state.genre}.

Return a JSON object like:
{
  "structure": [
    {"section": "Intro", "chords": ["C", "Am"], "bars": 4},
    {"section": "Verse 1", "chords": ["C", "G", "Am", "F"], "bars": 8},
    {"section": "Chorus", "chords": ["F", "G", "C", "Am"], "bars": 8}
  ],
  "tips": "Build energy through the verse into the chorus"
}

Create a realistic song structure with Intro, Verses, Chorus, Bridge as appropriate for ${structureType}.`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('structureResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const structure = JSON.parse(jsonMatch[0]);
                        state.songStructure = structure;
                        let html = `<span class="result-title">üé¨ Song Structure</span>\n\n`;
                        structure.structure.forEach(section => {
                            html += `<div style="margin-bottom: 12px;"><span class="section-label">${section.section}</span> (${section.bars} bars)\n`;
                            html += section.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ');
                            html += `</div>`;
                        });
                        if (structure.tips) html += `\n<div style="color: var(--text-secondary); font-size: 12px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 8px;">üí° ${structure.tips}</div>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üé¨ Song structure created!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé¨ Structure</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                resultDiv.innerHTML = generateFallbackStructure(structureType);
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackStructure(type) {
            const p = state.progression;
            return `<span class="result-title">üé¨ ${type.toUpperCase()} Structure</span>\n\n` +
                `<span class="section-label">Intro</span> ${p.slice(0,2).join(' ')} (4 bars)\n` +
                `<span class="section-label">Verse</span> ${p.join(' ')} (8 bars)\n` +
                `<span class="section-label">Chorus</span> ${[...p].reverse().join(' ')} (8 bars)\n` +
                `<span class="section-label">Outro</span> ${p[0]} (4 bars)`;
        }

        async function analyzeProgression(btn) {
            btn.classList.add('loading');
            
            const prompt = `You are a music theory expert. Analyze this chord progression in detail:
Chords: ${state.progression.join(' - ')}
Key: ${state.key}
Genre: ${state.genre}

Provide analysis in this JSON format:
{
  "romanNumerals": "I - V - vi - IV",
  "key": "C Major",
  "mood": "Uplifting and nostalgic",
  "famousUsage": ["Let It Be - Beatles", "No Woman No Cry - Bob Marley"],
  "characteristics": ["Strong resolution", "Emotional minor chord"],
  "suggestions": "Try adding a vi before the IV for more tension"
}`;

            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('analysisResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const analysis = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üîç Progression Analysis</span>\n\n`;
                        html += `<div class="analysis-item"><span class="analysis-label">Roman Numerals:</span> ${analysis.romanNumerals}</div>`;
                        html += `<div class="analysis-item"><span class="analysis-label">Key:</span> ${analysis.key}</div>`;
                        html += `<div class="analysis-item"><span class="analysis-label">Mood:</span> ${analysis.mood}</div>`;
                        if (analysis.famousUsage?.length) html += `<div class="analysis-item"><span class="analysis-label">Famous Songs:</span> ${analysis.famousUsage.join(', ')}</div>`;
                        if (analysis.characteristics?.length) html += `<div class="analysis-item"><span class="analysis-label">Characteristics:</span> ${analysis.characteristics.join(', ')}</div>`;
                        if (analysis.suggestions) html += `<div class="analysis-item"><span class="analysis-label">üí° Suggestion:</span> ${analysis.suggestions}</div>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üîç Analysis complete!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üîç Analysis</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                resultDiv.innerHTML = generateFallbackAnalysis();
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        function generateFallbackAnalysis() {
            const romanMap = { 'C': 'I', 'Dm': 'ii', 'Em': 'iii', 'F': 'IV', 'G': 'V', 'Am': 'vi', 'Bdim': 'vii¬∞' };
            const romans = state.progression.map(c => romanMap[c] || '?').join(' - ');
            return `<span class="result-title">üîç Analysis</span>\n\n` +
                `<div class="analysis-item"><span class="analysis-label">Roman Numerals:</span> ${romans}</div>` +
                `<div class="analysis-item"><span class="analysis-label">Key:</span> ${state.key}</div>` +
                `<div class="analysis-item"><span class="analysis-label">Chords:</span> ${state.progression.length} total</div>`;
        }

        async function surpriseMe(btn) {
            btn.classList.add('loading');
            
            const surprises = [
                `Generate a unique, unexpected ${state.genre} chord progression that sounds fresh. Return JSON: {"chords": [...], "name": "Surprise name", "description": "Why it's interesting"}`,
                `Create a chord progression that combines ${state.genre} with jazz elements. Return JSON: {"chords": [...], "name": "...", "description": "..."}`,
                `Generate a progression using unusual chord voicings for ${state.genre}. Return JSON: {"chords": [...], "name": "...", "description": "..."}`,
                `Create a progression with an unexpected twist or modulation. Return JSON: {"chords": [...], "name": "...", "description": "..."}`
            ];
            
            const prompt = surprises[Math.floor(Math.random() * surprises.length)];
            const result = await callGeminiAI(prompt);
            const resultDiv = document.getElementById('surpriseResult');
            
            if (result) {
                try {
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const surprise = JSON.parse(jsonMatch[0]);
                        let html = `<span class="result-title">üé≤ ${surprise.name || 'Surprise!'}</span>\n`;
                        html += `<div style="margin: 8px 0;">${surprise.chords.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}</div>`;
                        html += `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">${surprise.description || 'Try something new!'}</div>`;
                        html += `<button onclick="applyTransferChords(['${surprise.chords.join("','")}'])" style="margin-top: 10px; padding: 8px 16px; background: var(--warning); border: none; border-radius: 8px; color: #000; cursor: pointer; font-weight: 700;">üé∞ Use This Progression</button>`;
                        resultDiv.innerHTML = html;
                        resultDiv.classList.add('active');
                        showToast('üé≤ Surprise ready!');
                    }
                } catch (e) {
                    resultDiv.innerHTML = `<span class="result-title">üé≤ Surprise</span>\n${result}`;
                    resultDiv.classList.add('active');
                }
            } else {
                const surprise = ['Dm7', 'G7', 'Cmaj7', 'A7b9'];
                resultDiv.innerHTML = `<span class="result-title">üé≤ Jazz Surprise!</span>\n${surprise.map(c => `<span class="chord-tag">${c}</span>`).join(' ')}`;
                resultDiv.classList.add('active');
            }
            btn.classList.remove('loading');
        }

        // BEATS - MELODY SEQUENCER & DRUM MACHINE
        const scales = {
            major: ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            minor: ['C', 'D', 'Eb', 'F', 'G', 'Ab', 'Bb'],
            pentatonic: ['C', 'D', 'E', 'G', 'A'],
            blues: ['C', 'Eb', 'F', 'Gb', 'G', 'Bb'],
            dorian: ['C', 'D', 'Eb', 'F', 'G', 'A', 'Bb'],
            chromatic: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
        };
        
        const melodyState = { grid: Array(16).fill(null), scale: 'major', octave: 4 };
        const drumState = {
            kick: Array(16).fill(false),
            snare: Array(16).fill(false),
            hihat: Array(16).fill(false),
            openhat: Array(16).fill(false),
            clap: Array(16).fill(false),
            tom: Array(16).fill(false),
            crash: Array(16).fill(false),
            rim: Array(16).fill(false)
        };
        let beatTempo = 120;
        let sequenceInterval = null;
        let isPlaying = false;

        function initMelodyGrid() {
            const grid = document.getElementById('melodyGrid');
            if (!grid) return;
            const scale = scales[melodyState.scale];
            const octave = parseInt(document.getElementById('melodyOctave')?.value || 4);
            const rows = scale.length;
            
            let html = '<div class="melody-labels">';
            for (let r = rows - 1; r >= 0; r--) {
                html += `<div class="melody-label">${scale[r]}${octave}</div>`;
            }
            html += '</div>';
            
            for (let col = 0; col < 16; col++) {
                html += `<div class="melody-column" data-col="${col}">`;
                for (let row = rows - 1; row >= 0; row--) {
                    const note = scale[row] + octave;
                    const isActive = melodyState.grid[col] === note;
                    html += `<div class="melody-cell ${isActive ? 'active' : ''}" data-col="${col}" data-row="${row}" data-note="${note}" onclick="toggleMelodyCell(this, ${col}, '${note}')"></div>`;
                }
                html += '</div>';
            }
            grid.innerHTML = html;
        }

        function toggleMelodyCell(cell, col, note) {
            const wasActive = cell.classList.contains('active');
            // Clear other cells in same column
            document.querySelectorAll(`.melody-cell[data-col="${col}"]`).forEach(c => c.classList.remove('active'));
            
            if (wasActive) {
                melodyState.grid[col] = null;
            } else {
                cell.classList.add('active');
                melodyState.grid[col] = note;
                // Play preview
                playNotePreview(note);
            }
        }

        async function playNotePreview(note) {
            await initAudio();
            mainSynth.triggerAttackRelease(note, '16n');
        }

        function updateMelodyScale() {
            melodyState.scale = document.getElementById('melodyScale').value;
            melodyState.grid = Array(16).fill(null);
            initMelodyGrid();
        }

        function clearMelody() {
            melodyState.grid = Array(16).fill(null);
            initMelodyGrid();
            showToast('üóëÔ∏è Melody cleared');
        }

        function randomMelody() {
            const scale = scales[melodyState.scale];
            const octave = parseInt(document.getElementById('melodyOctave')?.value || 4);
            melodyState.grid = Array(16).fill(null).map(() => 
                Math.random() > 0.3 ? scale[Math.floor(Math.random() * scale.length)] + octave : null
            );
            initMelodyGrid();
            showToast('üé≤ Random melody!');
        }

        async function aiGenerateMelodyPattern(btn) {
            btn.classList.add('loading');
            const prompt = `Generate a catchy 16-step melody pattern for ${state.genre} music in ${melodyState.scale} scale.
Return ONLY a JSON array of 16 elements, each being a note name with octave (like "C4", "E4") or null for rest.
Example: ["C4", "E4", null, "G4", "E4", "C4", null, "D4", "F4", "E4", null, "G4", "A4", "G4", "E4", "C4"]
Use notes from ${melodyState.scale} scale. Make it musical and memorable.`;
            
            const result = await callGeminiAI(prompt);
            if (result) {
                try {
                    const match = result.match(/\[[\s\S]*?\]/);
                    if (match) {
                        const pattern = JSON.parse(match[0]);
                        melodyState.grid = pattern.slice(0, 16);
                        initMelodyGrid();
                        showToast('‚ú® AI melody generated!');
                    }
                } catch (e) { randomMelody(); }
            } else { randomMelody(); }
            btn.classList.remove('loading');
        }

        async function playMelodySequence() {
            await initAudio();
            stopAllSequences();
            isPlaying = true;
            const stepTime = (60 / beatTempo) / 4 * 1000; // 16th notes
            let step = 0;
            
            sequenceInterval = setInterval(() => {
                // Clear previous highlights
                document.querySelectorAll('.melody-cell.playing').forEach(c => c.classList.remove('playing'));
                
                // Highlight current column
                document.querySelectorAll(`.melody-cell[data-col="${step}"]`).forEach(c => c.classList.add('playing'));
                
                // Play note
                const note = melodyState.grid[step];
                if (note) mainSynth.triggerAttackRelease(note, '16n');
                
                step = (step + 1) % 16;
                if (step === 0 && !document.getElementById('loopBeats')?.checked) {
                    stopAllSequences();
                }
            }, stepTime);
        }

        // Drum Machine
        function initDrumGrid() {
            Object.keys(drumState).forEach(drum => {
                const container = document.getElementById(`${drum}-steps`);
                if (!container) return;
                let html = '';
                for (let i = 0; i < 16; i++) {
                    html += `<div class="drum-step ${drum} ${drumState[drum][i] ? 'active' : ''}" data-drum="${drum}" data-step="${i}" onclick="toggleDrumStep('${drum}', ${i}, this)"></div>`;
                }
                container.innerHTML = html;
            });
        }

        function toggleDrumStep(drum, step, el) {
            drumState[drum][step] = !drumState[drum][step];
            el.classList.toggle('active');
            if (drumState[drum][step]) playDrumSound(drum);
        }

        let drumSynths = {};
        async function initDrumSynths() {
            await initAudio();
            if (drumSynths.kick) return;
            
            drumSynths = {
                kick: new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 6, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.4 } }).toDestination(),
                snare: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(),
                hihat: new Tone.MetalSynth({ frequency: 400, envelope: { attack: 0.001, decay: 0.05, release: 0.01 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
                openhat: new Tone.MetalSynth({ frequency: 400, envelope: { attack: 0.001, decay: 0.3, release: 0.1 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
                clap: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0, release: 0.1 } }).toDestination(),
                tom: new Tone.MembraneSynth({ pitchDecay: 0.1, octaves: 4, envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 } }).toDestination(),
                crash: new Tone.MetalSynth({ frequency: 300, envelope: { attack: 0.001, decay: 1, release: 0.5 }, harmonicity: 5.1, modulationIndex: 40, resonance: 5000, octaves: 2 }).toDestination(),
                rim: new Tone.MetalSynth({ frequency: 800, envelope: { attack: 0.001, decay: 0.05, release: 0.01 }, harmonicity: 3, modulationIndex: 10, resonance: 8000, octaves: 0.5 }).toDestination()
            };
            // Set volumes
            drumSynths.kick.volume.value = 0;
            drumSynths.snare.volume.value = -5;
            drumSynths.hihat.volume.value = -10;
            drumSynths.openhat.volume.value = -8;
            drumSynths.clap.volume.value = -8;
            drumSynths.tom.volume.value = -3;
            drumSynths.crash.volume.value = -12;
            drumSynths.rim.volume.value = -10;
        }

        async function playDrumSound(drum) {
            await initDrumSynths();
            const synth = drumSynths[drum];
            if (!synth) return;
            
            if (drum === 'kick') synth.triggerAttackRelease('C1', '8n');
            else if (drum === 'tom') synth.triggerAttackRelease('G2', '8n');
            else if (drum === 'snare' || drum === 'clap') synth.triggerAttackRelease('8n');
            else synth.triggerAttackRelease('32n');
        }

        function clearDrums() {
            Object.keys(drumState).forEach(drum => drumState[drum] = Array(16).fill(false));
            initDrumGrid();
            showToast('üóëÔ∏è Drums cleared');
        }

        function loadDrumPreset(preset) {
            const presets = {
                rock: {
                    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                    crash: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                },
                hiphop: {
                    kick: [1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],
                    hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                    openhat: [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
                    clap: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]
                },
                edm: {
                    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
                    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                    hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                    openhat: [0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0],
                    clap: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]
                }
            };
            
            Object.keys(drumState).forEach(drum => drumState[drum] = Array(16).fill(false));
            const p = presets[preset];
            if (p) {
                Object.keys(p).forEach(drum => {
                    drumState[drum] = p[drum].map(v => !!v);
                });
            }
            initDrumGrid();
            showToast(`ü•Å ${preset.charAt(0).toUpperCase() + preset.slice(1)} beat loaded!`);
        }

        async function aiGenerateDrumPattern(btn) {
            btn.classList.add('loading');
            const prompt = `Generate a ${state.genre} drum pattern for 16 steps.
Return ONLY a JSON object with arrays of 1s and 0s:
{"kick":[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],"snare":[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],"hihat":[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],"clap":[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0]}
Make it groovy and suitable for ${state.genre}. Include kick, snare, hihat, and optionally clap, openhat, tom, crash, rim.`;
            
            const result = await callGeminiAI(prompt);
            if (result) {
                try {
                    const match = result.match(/\{[\s\S]*\}/);
                    if (match) {
                        const pattern = JSON.parse(match[0]);
                        Object.keys(drumState).forEach(drum => drumState[drum] = Array(16).fill(false));
                        Object.keys(pattern).forEach(drum => {
                            if (drumState[drum]) drumState[drum] = pattern[drum].map(v => !!v);
                        });
                        initDrumGrid();
                        showToast('‚ú® AI drums generated!');
                    }
                } catch (e) { loadDrumPreset('rock'); }
            } else { loadDrumPreset('rock'); }
            btn.classList.remove('loading');
        }

        async function playDrumSequence() {
            await initDrumSynths();
            stopAllSequences();
            isPlaying = true;
            const stepTime = (60 / beatTempo) / 4 * 1000;
            let step = 0;
            
            sequenceInterval = setInterval(() => {
                document.querySelectorAll('.drum-step.playing').forEach(s => s.classList.remove('playing'));
                document.querySelectorAll(`.drum-step[data-step="${step}"]`).forEach(s => s.classList.add('playing'));
                
                Object.keys(drumState).forEach(drum => {
                    if (drumState[drum][step]) playDrumSound(drum);
                });
                
                step = (step + 1) % 16;
                if (step === 0 && !document.getElementById('loopBeats')?.checked) stopAllSequences();
            }, stepTime);
        }

        async function playFullBeat() {
            await initDrumSynths();
            await initAudio();
            stopAllSequences();
            isPlaying = true;
            const stepTime = (60 / beatTempo) / 4 * 1000;
            let step = 0;
            
            sequenceInterval = setInterval(() => {
                document.querySelectorAll('.drum-step.playing, .melody-cell.playing').forEach(s => s.classList.remove('playing'));
                document.querySelectorAll(`.drum-step[data-step="${step}"], .melody-cell[data-col="${step}"]`).forEach(s => s.classList.add('playing'));
                
                // Drums
                Object.keys(drumState).forEach(drum => {
                    if (drumState[drum][step]) playDrumSound(drum);
                });
                
                // Melody
                const note = melodyState.grid[step];
                if (note) mainSynth.triggerAttackRelease(note, '16n');
                
                step = (step + 1) % 16;
                if (step === 0 && !document.getElementById('loopBeats')?.checked) stopAllSequences();
            }, stepTime);
        }

        function stopAllSequences() {
            if (sequenceInterval) {
                clearInterval(sequenceInterval);
                sequenceInterval = null;
            }
            isPlaying = false;
            document.querySelectorAll('.drum-step.playing, .melody-cell.playing').forEach(s => s.classList.remove('playing'));
        }

        function adjustBeatTempo(delta) {
            beatTempo = Math.max(60, Math.min(200, beatTempo + delta));
            document.getElementById('beatTempoDisplay').textContent = beatTempo;
            state.tempo = beatTempo;
            document.getElementById('tempoDisplay').textContent = beatTempo;
        }

        async function playMelodyWithChords() {
            await initAudio();
            stopAllSequences();
            isPlaying = true;
            const stepTime = (60 / beatTempo) / 4 * 1000;
            let step = 0;
            let chordIndex = 0;
            
            sequenceInterval = setInterval(() => {
                document.querySelectorAll('.melody-cell.playing').forEach(c => c.classList.remove('playing'));
                document.querySelectorAll(`.melody-cell[data-col="${step}"]`).forEach(c => c.classList.add('playing'));
                
                // Play chord on beat 1 of every 4 steps
                if (step % 4 === 0) {
                    const chord = state.progression[chordIndex % state.progression.length];
                    const notes = chordNotes[chord];
                    if (notes && mainSynth.releaseAll) mainSynth.releaseAll();
                    if (notes) mainSynth.triggerAttack(notes.map(n => n.replace(/\d/, '3')));
                    if (step % 4 === 0 && step > 0) chordIndex++;
                }
                
                // Play melody note
                const note = melodyState.grid[step];
                if (note) mainSynth.triggerAttackRelease(note, '16n', Tone.now(), 0.7);
                
                step++;
                if (step >= 16) {
                    step = 0;
                    chordIndex++;
                    if (!document.getElementById('loopBeats')?.checked) {
                        if (mainSynth.releaseAll) mainSynth.releaseAll();
                        stopAllSequences();
                    }
                }
            }, stepTime);
        }

        async function playEverything() {
            await initDrumSynths();
            await initAudio();
            stopAllSequences();
            isPlaying = true;
            showToast('üéµ Playing full arrangement!');
            
            const stepTime = (60 / beatTempo) / 4 * 1000;
            let step = 0;
            let chordIndex = 0;
            
            sequenceInterval = setInterval(() => {
                document.querySelectorAll('.drum-step.playing, .melody-cell.playing').forEach(s => s.classList.remove('playing'));
                document.querySelectorAll(`.drum-step[data-step="${step}"], .melody-cell[data-col="${step}"]`).forEach(s => s.classList.add('playing'));
                
                // Play chord on beat 1 of every 4 steps
                if (step % 4 === 0) {
                    const chord = state.progression[chordIndex % state.progression.length];
                    const notes = chordNotes[chord];
                    if (notes && mainSynth.releaseAll) mainSynth.releaseAll();
                    if (notes) mainSynth.triggerAttack(notes.map(n => n.replace(/\d/, '3')));
                    if (step === 0 && chordIndex > 0) chordIndex = 0;
                }
                if (step % 4 === 3) chordIndex++;
                
                // Drums
                Object.keys(drumState).forEach(drum => {
                    if (drumState[drum][step]) playDrumSound(drum);
                });
                
                // Melody (slightly louder)
                const note = melodyState.grid[step];
                if (note) {
                    const melodySynth = new Tone.Synth().toDestination();
                    melodySynth.triggerAttackRelease(note, '16n');
                }
                
                step = (step + 1) % 16;
                if (step === 0 && !document.getElementById('loopBeats')?.checked) {
                    if (mainSynth.releaseAll) mainSynth.releaseAll();
                    stopAllSequences();
                }
            }, stepTime);
        }

        function initBeatsTab() {
            initMelodyGrid();
            initDrumGrid();
        }

        // MODALS & TOAST
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // UI OPTIMIZATION FUNCTIONS
        let globalPlaying = false;
        
        function toggleFab() {
            document.getElementById('fabContainer').classList.toggle('open');
        }
        
        function toggleCompactMode() {
            document.body.classList.toggle('compact-mode');
            const isCompact = document.body.classList.contains('compact-mode');
            localStorage.setItem('chordflow-compact', isCompact);
            showToast(isCompact ? 'üìê Compact mode ON' : 'üìê Compact mode OFF');
            toggleFab();
        }
        
        function toggleFullscreen() {
            document.body.classList.add('fullscreen-mode');
            toggleFab();
            showToast('‚õ∂ Fullscreen - tap X to exit');
        }
        
        function exitFullscreen() {
            document.body.classList.remove('fullscreen-mode');
        }
        
        function quickRandomize() {
            generateProgression();
            if (typeof randomMelody === 'function') randomMelody();
            if (typeof loadDrumPreset === 'function') {
                const presets = ['rock', 'hiphop', 'edm'];
                loadDrumPreset(presets[Math.floor(Math.random() * presets.length)]);
            }
            showToast('üé≤ Randomized everything!');
            toggleFab();
        }
        
        async function quickAI() {
            toggleFab();
            showToast('‚ú® AI generating...');
            await aiGenerate('smart');
        }
        
        function updateTransportDisplay() {
            const tempoEl = document.getElementById('transportTempo');
            const statusEl = document.getElementById('transportStatus');
            const playBtn = document.getElementById('transportPlay');
            
            if (tempoEl) tempoEl.textContent = state.tempo || beatTempo || 120;
            if (statusEl) statusEl.textContent = globalPlaying ? 'Playing...' : 'Ready';
            if (playBtn) {
                playBtn.textContent = globalPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                playBtn.classList.toggle('playing', globalPlaying);
            }
        }
        
        async function toggleGlobalPlayback() {
            if (globalPlaying) {
                stopAllPlayback();
            } else {
                globalPlaying = true;
                updateTransportDisplay();
                // Play based on current tab
                const activeTab = document.querySelector('.tab-content.active')?.id;
                if (activeTab === 'beats-tab') {
                    await playFullBeat();
                } else if (activeTab === 'piano-tab') {
                    playProgression();
                } else {
                    playProgression();
                }
            }
        }
        
        function stopAllPlayback() {
            globalPlaying = false;
            if (typeof stopAllSequences === 'function') stopAllSequences();
            if (typeof stopPlayback === 'function') stopPlayback();
            if (mainSynth?.releaseAll) mainSynth.releaseAll();
            updateTransportDisplay();
        }
        
        // Swipe navigation for tabs
        let touchStartX = 0;
        let touchEndX = 0;
        const tabOrder = ['compose', 'ai', 'beats', 'piano', 'mixer', 'sheet', 'export'];
        
        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) < 50) return; // Minimum swipe distance
            
            const activeTab = document.querySelector('.tab-content.active')?.id?.replace('-tab', '');
            const currentIndex = tabOrder.indexOf(activeTab);
            
            if (diff > 0 && currentIndex < tabOrder.length - 1) {
                // Swipe left - next tab
                switchTab(tabOrder[currentIndex + 1]);
                document.querySelectorAll('.tab-btn')[currentIndex + 1]?.classList.add('active');
            } else if (diff < 0 && currentIndex > 0) {
                // Swipe right - previous tab
                switchTab(tabOrder[currentIndex - 1]);
                document.querySelectorAll('.tab-btn')[currentIndex - 1]?.classList.add('active');
            }
        }
        
        function initSwipeNavigation() {
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;
            
            mainContent.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            mainContent.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }
        
        // Collapsible panels
        function togglePanel(panel) {
            panel.classList.toggle('collapsed');
            const isCollapsed = panel.classList.contains('collapsed');
            localStorage.setItem(`panel-${panel.dataset.panel}`, isCollapsed);
        }
        
        function initCollapsiblePanels() {
            document.querySelectorAll('.panel[data-panel]').forEach(panel => {
                const isCollapsed = localStorage.getItem(`panel-${panel.dataset.panel}`) === 'true';
                if (isCollapsed) panel.classList.add('collapsed');
            });
        }
        
        // Header collapse on scroll
        let lastScrollY = 0;
        function handleHeaderScroll() {
            const header = document.querySelector('.header');
            if (!header) return;
            
            const currentScrollY = window.scrollY;
            if (currentScrollY > 100 && currentScrollY > lastScrollY) {
                header.classList.add('collapsed');
            } else if (currentScrollY < lastScrollY || currentScrollY < 50) {
                header.classList.remove('collapsed');
            }
            lastScrollY = currentScrollY;
        }
        
        // Keyboard shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', e => {
                // Space = play/pause (when not in input)
                if (e.code === 'Space' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                    e.preventDefault();
                    toggleGlobalPlayback();
                }
                // Escape = exit fullscreen
                if (e.code === 'Escape') {
                    exitFullscreen();
                    document.getElementById('fabContainer')?.classList.remove('open');
                }
                // Number keys 1-7 for tabs
                if (e.key >= '1' && e.key <= '7' && !e.ctrlKey && !e.metaKey) {
                    const tabIndex = parseInt(e.key) - 1;
                    if (tabOrder[tabIndex]) {
                        switchTab(tabOrder[tabIndex]);
                    }
                }
            });
        }
        
        // TAB GROUPS
        function toggleTabGroup(groupId) {
            const group = document.getElementById(groupId);
            const wasOpen = group.classList.contains('open');
            closeTabGroups();
            if (!wasOpen) group.classList.add('open');
        }
        
        function closeTabGroups() {
            document.querySelectorAll('.tab-group').forEach(g => g.classList.remove('open'));
        }
        
        // Close tab groups when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tab-group')) closeTabGroups();
        });

        // ACCORDION PANELS
        function toggleAccordion(header) {
            const panel = header.closest('.accordion-panel');
            const wasOpen = panel.classList.contains('open');
            
            // Close all accordions in same container (optional - remove for multi-open)
            // panel.parentElement.querySelectorAll('.accordion-panel').forEach(p => p.classList.remove('open'));
            
            if (!wasOpen) {
                panel.classList.add('open');
            } else {
                panel.classList.remove('open');
            }
        }

        // BOTTOM SHEETS
        let currentBottomSheet = null;
        
        function openBottomSheet(sheetId) {
            closeTabGroups();
            document.getElementById('fabContainer')?.classList.remove('open');
            
            const overlay = document.getElementById('bottomSheetOverlay');
            const sheet = document.getElementById(sheetId + 'Sheet');
            
            if (!sheet) return;
            
            // Populate instruments sheet dynamically
            if (sheetId === 'instruments') {
                populateInstrumentsSheet();
            }
            
            overlay.classList.add('active');
            sheet.classList.add('active');
            currentBottomSheet = sheet;
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        function closeBottomSheet() {
            const overlay = document.getElementById('bottomSheetOverlay');
            overlay.classList.remove('active');
            
            document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            currentBottomSheet = null;
            document.body.style.overflow = '';
        }
        
        function populateInstrumentsSheet() {
            const body = document.getElementById('instrumentsSheetBody');
            if (!body) return;
            
            const categories = {
                'üéπ Keys': ['Grand Piano', 'Electric Piano', 'Organ', 'Synth Lead', 'Synth Pad', 'Clavinet'],
                'üé∏ Guitars': ['Acoustic Guitar', 'Electric Clean', 'Electric Distorted', 'Nylon Guitar'],
                'üéª Strings': ['Violin', 'Cello', 'String Ensemble', 'Harp'],
                'üé∫ Brass': ['Trumpet', 'Trombone', 'French Horn', 'Brass Section'],
                'üé∑ Winds': ['Flute', 'Clarinet', 'Saxophone', 'Oboe'],
                'ü•Å Percussion': ['Vibraphone', 'Marimba', 'Steel Drums', 'Bells']
            };
            
            let html = '';
            for (const [category, instruments] of Object.entries(categories)) {
                html += `<div class="accordion-panel open" data-accordion="${category}">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title">${category}</div>
                        <span class="accordion-chevron">‚ñº</span>
                    </div>
                    <div class="accordion-body"><div class="accordion-content">`;
                instruments.forEach(inst => {
                    const isSelected = state.instrument === inst;
                    html += `<div class="toolbar-option ${isSelected ? 'selected' : ''}" onclick="selectInstrumentFromSheet('${inst}', this)">
                        <span class="icon">üéµ</span>
                        <div class="toolbar-option-info">
                            <div class="toolbar-option-name">${inst}</div>
                        </div>
                    </div>`;
                });
                html += '</div></div></div>';
            }
            body.innerHTML = html;
        }
        
        function selectInstrumentFromSheet(inst, el) {
            state.instrument = inst;
            setupInstrument(inst);
            
            // Update selection UI
            el.closest('.bottom-sheet-body').querySelectorAll('.toolbar-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            
            showToast(`üé∏ ${inst} selected`);
        }

        // CUSTOMIZABLE TOOLBAR
        let toolbarItems = JSON.parse(localStorage.getItem('chordflow-toolbar') || '["play","random","ai","instrument"]');
        
        function renderToolbar() {
            const toolbar = document.getElementById('quickToolbar');
            if (!toolbar) return;
            
            const itemConfigs = {
                play: { icon: '‚ñ∂Ô∏è', action: 'toggleGlobalPlayback()', title: 'Play/Stop', id: 'toolbarPlay' },
                random: { icon: 'üé≤', action: 'generateProgression()', title: 'New Progression' },
                ai: { icon: '‚ú®', action: "aiGenerate('smart')", title: 'AI Generate' },
                instrument: { icon: 'üé∏', action: "openBottomSheet('instruments')", title: 'Instruments' },
                tempo: { icon: '‚è±Ô∏è', action: 'showTempoControl()', title: 'Tempo' },
                record: { icon: 'üî¥', action: 'toggleRecording()', title: 'Record' },
                metronome: { icon: 'üéµ', action: 'toggleMetronome()', title: 'Metronome' },
                fullscreen: { icon: '‚õ∂', action: 'toggleFullscreen()', title: 'Fullscreen' }
            };
            
            let html = '';
            toolbarItems.forEach((itemId, index) => {
                const config = itemConfigs[itemId];
                if (!config) return;
                html += `<button class="toolbar-item" onclick="${config.action}" ${config.id ? `id="${config.id}"` : ''} title="${config.title}">${config.icon}<span class="remove-btn" onclick="event.stopPropagation(); removeToolbarItem(${index})">‚úï</span></button>`;
                if (index === 0 && toolbarItems.length > 1) html += '<div class="toolbar-divider"></div>';
            });
            html += '<div class="toolbar-divider"></div>';
            html += `<button class="toolbar-item toolbar-add" onclick="openBottomSheet('toolbar-customize')" title="Customize">+</button>`;
            
            toolbar.innerHTML = html;
            updateToolbarCustomizeUI();
        }
        
        function toggleToolbarItem(itemId, el) {
            const index = toolbarItems.indexOf(itemId);
            if (index > -1) {
                toolbarItems.splice(index, 1);
                el.classList.remove('selected');
            } else {
                if (toolbarItems.length < 6) {
                    toolbarItems.push(itemId);
                    el.classList.add('selected');
                } else {
                    showToast('‚ö†Ô∏è Max 6 toolbar items');
                    return;
                }
            }
            localStorage.setItem('chordflow-toolbar', JSON.stringify(toolbarItems));
            renderToolbar();
        }
        
        function removeToolbarItem(index) {
            toolbarItems.splice(index, 1);
            localStorage.setItem('chordflow-toolbar', JSON.stringify(toolbarItems));
            renderToolbar();
            showToast('üóëÔ∏è Item removed');
        }
        
        function resetToolbar() {
            toolbarItems = ['play', 'random', 'ai', 'instrument'];
            localStorage.setItem('chordflow-toolbar', JSON.stringify(toolbarItems));
            renderToolbar();
            showToast('üîÑ Toolbar reset');
        }
        
        function updateToolbarCustomizeUI() {
            document.querySelectorAll('#toolbar-customizeSheet .toolbar-option').forEach(opt => {
                const itemId = opt.querySelector('.toolbar-option-name')?.textContent.toLowerCase().replace(/[^a-z]/g, '');
                const mappings = {
                    'playstop': 'play', 'randomize': 'random', 'aigenerate': 'ai',
                    'instruments': 'instrument', 'tempo': 'tempo', 'record': 'record',
                    'metronome': 'metronome', 'fullscreen': 'fullscreen'
                };
                const mapped = mappings[itemId];
                if (mapped && toolbarItems.includes(mapped)) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }
        
        function showTempoControl() {
            const newTempo = prompt('Enter tempo (60-200 BPM):', state.tempo);
            if (newTempo && !isNaN(newTempo)) {
                state.tempo = Math.max(60, Math.min(200, parseInt(newTempo)));
                beatTempo = state.tempo;
                document.getElementById('tempoDisplay').textContent = state.tempo;
                updateTransportDisplay();
                showToast(`‚è±Ô∏è Tempo: ${state.tempo} BPM`);
            }
        }
        
        function toggleRecording() {
            showToast('üî¥ Recording feature coming soon!');
        }
        
        function toggleMetronome() {
            showToast('üéµ Metronome toggled!');
        }
        
        // Swipe to close bottom sheet
        let sheetTouchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            if (currentBottomSheet && e.target.closest('.bottom-sheet-handle')) {
                sheetTouchStartY = e.touches[0].clientY;
            }
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            if (currentBottomSheet && sheetTouchStartY) {
                const diff = e.touches[0].clientY - sheetTouchStartY;
                if (diff > 100) {
                    closeBottomSheet();
                    sheetTouchStartY = 0;
                }
            }
        }, { passive: true });

        function initUIOptimizations() {
            initSwipeNavigation();
            initCollapsiblePanels();
            initKeyboardShortcuts();
            window.addEventListener('scroll', handleHeaderScroll, { passive: true });
            
            // Restore compact mode
            if (localStorage.getItem('chordflow-compact') === 'true') {
                document.body.classList.add('compact-mode');
            }
            
            // Hide swipe hint after first use
            setTimeout(() => {
                const hint = document.getElementById('swipeHint');
                if (hint) hint.style.display = 'none';
            }, 5000);
            
            updateTransportDisplay();
            renderToolbar();
        }

        // INIT
        function init() {
            renderInstruments(); generateProgression(); renderMixer(); renderPianoRoll(); renderQuickPianoKeys(); setTimeout(renderSheetMusic, 100);
            const savedTheme = localStorage.getItem('chordflow-theme');
            if (savedTheme && savedTheme !== 'dark') document.body.classList.add(`theme-${savedTheme}`);
            const savedColors = localStorage.getItem('chordflow-custom-colors');
            if (savedColors) { state.customColors = JSON.parse(savedColors); document.getElementById('customBg').value = state.customColors.bg; document.getElementById('customAccent').value = state.customColors.accent; document.getElementById('customCard').value = state.customColors.card; document.getElementById('customText').value = state.customColors.text; }
            initUIOptimizations();
            console.log('üéµ ChordFlow v12.5 Pro UX initialized');
        }
        init();
    </script>
</body>
</html>
