Panel').classList.add('active')}
function toggleDrawer(){haptic('light');state.drawerOpen=!state.drawerOpen;document.getElementById('bottomDrawer').classList.toggle('open',state.drawerOpen)}

function updateKey(k){haptic('light');state.key=k;updateAllDisplays();trackAnalytics('key',k)}
function updateScale(s){haptic('light');state.scale=s;updateAllDisplays()}
function setGenre(g){haptic('light');state.genre=g;document.querySelectorAll('.genre-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');trackAnalytics('genre',g)}
function updateTempo(t){state.tempo=parseInt(t);document.getElementById('tempoValue').textContent=t+' BPM'}
function setVoicing(v){haptic('light');state.voicing=v;document.querySelectorAll('.voicing-card').forEach(c=>c.classList.remove('active'));event.target.closest('.voicing-card').classList.add('active');updateAllDisplays();showToast(`üéØ ${VOICINGS[v].name}`)}

async function initAudio(){if(state.synth)return;await Tone.start();
state.synth=new Tone.PolySynth(Tone.Synth,{oscillator:{type:state.waveType},envelope:{attack:.02,decay:.4,sustain:.3,release:1.2}}).toDestination();
state.bass=new Tone.MonoSynth({oscillator:{type:'sawtooth'},envelope:{attack:.02,decay:.3,sustain:.5,release:.8}}).toDestination();state.bass.volume.value=-6;
state.strings=new Tone.PolySynth(Tone.Synth,{oscillator:{type:'sine'},envelope:{attack:.3,decay:.5,sustain:.6,release:2}}).toDestination();state.strings.volume.value=-10;
state.effects.reverb=new Tone.Reverb({decay:2.5,wet:.3}).toDestination();
state.effects.delay=new Tone.FeedbackDelay({delayTime:'8n',feedback:.3,wet:.2}).toDestination();
state.synth.connect(state.effects.reverb);state.synth.connect(state.effects.delay)}

function buildChord(root,quality,voicing='root'){
const r=NOTES.indexOf(root);const intervals=quality.includes('m')?[0,3,7]:quality.includes('dim')?[0,3,6]:[0,4,7];
const v=VOICINGS[voicing]||VOICINGS.root;
const notes=v.intervals.map(i=>{const ni=(r+intervals[i%intervals.length]+Math.floor(i/12)*12)%12;const oct=4+Math.floor(i/12);return NOTES[ni]+oct});
return notes}

function generateChord(degree){
const si=SCALES[state.scale];const ri=(NOTES.indexOf(state.key)+si[degree])%12;const root=NOTES[ri];
const quality=state.scale==='major'?CHORD_QUALITIES.major[degree]:CHORD_QUALITIES.minor[degree];
const numeral=state.scale==='major'?NUMERALS.major[degree]:NUMERALS.minor[degree];
const symbol=root+quality;const notes=buildChord(root,quality,state.voicing);const func=FUNCTIONS[degree];
return{root,quality,symbol,numeral,notes,function:func,degree,voicing:state.voicing}}

function generateProgression(){haptic('medium');saveToHistory();
const g=GENRE_PROGRESSIONS[state.genre]||GENRE_PROGRESSIONS.pop;
const pattern=g.patterns[Math.floor(Math.random()*g.patterns.length)];
const chords=pattern.map(d=>generateChord(d));
state.song.sections[state.song.activeSection].chords=chords;
updateAllDisplays();showToast('üéµ Progression generated!');trackAnalytics('chords',chords.length)}

function generateFullSong(){haptic('medium');saveToHistory();
state.song.sections=[{type:'intro',chords:[],bars:2},{type:'verse',chords:[],bars:4},{type:'chorus',chords:[],bars:4},{type:'verse',chords:[],bars:4},{type:'chorus',chords:[],bars:4},{type:'bridge',chords:[],bars:4},{type:'chorus',chords:[],bars:4},{type:'outro',chords:[],bars:2}];
state.song.sections.forEach((s,i)=>{state.song.activeSection=i;generateProgression()});
state.song.activeSection=0;updateAllDisplays();showToast('üé¨ Full song created!')}

function clearProgression(){haptic('light');saveToHistory();state.song.sections[state.song.activeSection].chords=[];updateAllDisplays();showToast('üóëÔ∏è Cleared')}

async function playChordAtIndex(i){await Tone.start();initAudio();
const s=state.song.sections[state.song.activeSection];if(!s.chords[i])return;
const ch=s.chords[i];haptic('light');state.synth.triggerAttackRelease(ch.notes,'2n');
document.querySelectorAll('.chord-card').forEach((c,idx)=>{c.classList.remove('playing');if(idx===i)c.classList.add('playing');setTimeout(()=>c.classList.remove('playing'),500)})}

async function playProgression(){if(state.playing){stopPlayback();return}
await Tone.start();initAudio();state.playing=true;
document.getElementById('playBtn').textContent='‚è∏Ô∏è';haptic('medium');
const s=state.song.sections[state.song.activeSection];if(!s.chords.length){stopPlayback();showToast('Generate chords first!');return}
const bd=(60/state.tempo)*2*1000;let i=0;
const play=()=>{if(!state.playing)return;
const ch=s.chords[i];state.synth.triggerAttackRelease(ch.notes,'2n');
if(state.backingTracks.bass)state.bass.triggerAttackRelease(ch.root+'2','2n');
if(state.backingTracks.strings)state.strings.triggerAttackRelease(ch.notes.map(n=>n.replace(/\d/,'5')),'2n');
document.querySelectorAll('.chord-card').forEach((c,idx)=>{c.classList.remove('playing');if(idx===i)c.classList.add('playing')});
document.getElementById('metronomeLight').classList.add('beat');setTimeout(()=>document.getElementById('metronomeLight').classList.remove('beat'),100);
updateVisualizer();i++;
if(i>=s.chords.length){if(state.looping){i=0;setTimeout(play,bd)}else stopPlayback()}else setTimeout(play,bd)};play()}

function stopPlayback(){state.playing=false;document.getElementById('playBtn').textContent='‚ñ∂Ô∏è';document.querySelectorAll('.chord-card').forEach(c=>c.classList.remove('playing'))}
function toggleLoop(){haptic('light');state.looping=!state.looping;document.getElementById('loopBtn').classList.toggle('active',state.looping);showToast(state.looping?'üîÅ Loop on':'üîÅ Loop off')}
function toggleBacking(t){haptic('light');state.backingTracks[t]=!state.backingTracks[t];document.getElementById(t+'Btn').classList.toggle('active',state.backingTracks[t])}

function updateVisualizer(){const v=document.getElementById('visualizer');if(!v)return;let bars='';for(let i=0;i<12;i++){const h=Math.floor(Math.random()*35)+10;bars+=`<div class="viz-bar" style="height:${h}px"></div>`}v.innerHTML=bars}

function updateAllDisplays(){const s=state.song.sections[state.song.activeSection];const g=GENRE_PROGRESSIONS[state.genre]||GENRE_PROGRESSIONS.pop;
updateChordDisplay();updateStructureTimeline();updateGuitarDiagrams();updatePianoRoll();updateMidiKeyboard();
document.getElementById('patternName').textContent=s.chords.map(c=>c.numeral).join(' - ')||'‚Äî';
document.getElementById('moodName').textContent=g.mood;
document.getElementById('famousSongs').innerHTML=g.songs.map(x=>`<span class="tag">${x}</span>`).join('');
const b=document.getElementById('currentSectionBadge');b.textContent=s.type.charAt(0).toUpperCase()+s.type.slice(1)}

function updateChordDisplay(){const s=state.song.sections[state.song.activeSection];const c=document.getElementById('chordDisplay');
if(!s.chords.length){c.innerHTML='<div class="chord-card"><div class="chord-name">‚Äî</div><div class="chord-numeral">‚Äî</div></div>';return}
c.innerHTML=s.chords.map((ch,i)=>`<div class="chord-card" onclick="playChordAtIndex(${i})"><div class="chord-name">${ch.symbol}</div><div class="chord-numeral">${ch.numeral}</div><div class="chord-function">${ch.function}</div><div class="chord-voicing">${VOICINGS[ch.voicing]?.name||'Root'}</div><div class="chord-delete" onclick="event.stopPropagation();deleteChord(${i})">√ó</div></div>`).join('')}

function updateStructureTimeline(){const c=document.getElementById('structureTimeline');
c.innerHTML=state.song.sections.map((s,i)=>`<div class="section-block ${s.type} ${i===state.song.activeSection?'active':''}" onclick="selectSection(${i})"><div class="section-name">${s.type.charAt(0).toUpperCase()+s.type.slice(1)}</div><div class="section-bars">${s.bars} bars</div><div class="section-chords">${s.chords.map(ch=>ch.symbol).join(' ')||'‚Äî'}</div><div class="delete-section" onclick="event.stopPropagation();deleteSection(${i})">√ó</div></div>`).join('')+'<div class="add-section-btn" onclick="showAddSectionModal()">+</div>'}

function updateGuitarDiagrams(){const s=state.song.sections[state.song.activeSection];const c=document.getElementById('guitarDiagrams');
c.innerHTML=s.chords.map(ch=>{const bc=ch.root+(ch.quality.includes('m')?'m':'');const f=GUITAR_CHORDS[bc]||GUITAR_CHORDS[ch.root]||[-1,-1,-1,-1,-1,-1];
return`<div class="instrument-chord" onclick="playChordAtIndex(${s.chords.indexOf(ch)})"><div class="instrument-chord-name">${ch.symbol}</div><svg class="chord-diagram" viewBox="0 0 50 60">${[0,1,2,3,4].map(x=>`<line x1="5" y1="${12+x*12}" x2="45" y2="${12+x*12}" stroke="#333" stroke-width="1"/>`).join('')}${[0,1,2,3,4,5].map(x=>`<line x1="${5+x*8}" y1="12" x2="${5+x*8}" y2="60" stroke="#666" stroke-width="${x===0||x===5?2:1}"/>`).join('')}${f.map((v,x)=>v>=0?`<circle cx="${5+x*8}" cy="${v===0?8:6+v*12}" r="3.5" fill="${v===0?'none':'var(--accent-primary)'}" stroke="var(--accent-primary)" stroke-width="1.5"/>`:`<text x="${5+x*8}" y="8" text-anchor="middle" fill="var(--text-secondary)" font-size="8">√ó</text>`).join('')}</svg><div class="fret-info">${f.filter(v=>v>0).length?'Fret '+Math.min(...f.filter(v=>v>0)):'Open'}</div></div>`}).join('')||'<div style="text-align:center;color:var(--text-secondary);padding:2rem">Generate chords to see diagrams</div>'}

function updatePianoRoll(){const c=document.getElementById('pianoRoll');const s=state.song.sections[state.song.activeSection];
const h=s.chords.length?s.chords[0].notes.map(n=>n.replace(/\d/g,'')):[];const k=[];
[3,4,5].forEach(o=>{['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'].forEach(n=>{const b=n.includes('#');const hi=h.includes(n);k.push(`<div class="piano-key ${b?'black':''} ${hi?'highlighted':''}" onclick="playNote('${n+o}')"><span class="key-label">${n==='C'?'C'+o:''}</span></div>`)})});c.innerHTML=k.join('')}

function updateMidiKeyboard(){const c=document.getElementById('midiKeyboard');if(!c)return;let k='';
[3,4].forEach(o=>{['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'].forEach(n=>{const b=n.includes('#');k+=`<div class="midi-key ${b?'black':''}" data-note="${n+o}" onclick="playMidiNote('${n+o}')"></div>`})});c.innerHTML=k}

async function playNote(n){await Tone.start();initAudio();state.synth.triggerAttackRelease(n,'8n');haptic('light')}
async function playMidiNote(n){await Tone.start();initAudio();state.synth.triggerAttackRelease(n,'8n');haptic('light');
const k=document.querySelector(`[data-note="${n}"]`);if(k){k.classList.add('pressed');setTimeout(()=>k.classList.remove('pressed'),200)}}

function selectSection(i){haptic('light');state.song.activeSection=i;updateAllDisplays()}
function addSection(t){haptic('medium');state.song.sections.push({type:t,chords:[],bars:t==='intro'||t==='outro'?2:4});state.song.activeSection=state.song.sections.length-1;closeModal('addSectionModal');generateProgression();updateStructureTimeline()}
function deleteSection(i){if(state.song.sections.length<=1){showToast('Need at least one section');return}haptic('light');state.song.sections.splice(i,1);if(state.song.activeSection>=state.song.sections.length)state.song.activeSection=state.song.sections.length-1;updateAllDisplays()}
function deleteChord(i){haptic('light');state.song.sections[state.song.activeSection].chords.splice(i,1);updateAllDisplays()}
function saveToHistory(){state.history.push(JSON.stringify(state.song));if(state.history.length>20)state.history.shift()}

// MIDI Functions
async function scanMidiDevices(){haptic('light');showToast('üîç Scanning for MIDI devices...');
try{state.midiAccess=await navigator.requestMIDIAccess();
state.midiInputs=Array.from(state.midiAccess.inputs.values());
state.midiOutputs=Array.from(state.midiAccess.outputs.values());
if(state.midiInputs.length||state.midiOutputs.length){
document.getElementById('midiStatusDot').classList.add('connected');
document.getElementById('midiStatusText').textContent=`${state.midiInputs.length} input(s), ${state.midiOutputs.length} output(s)`;
updateMidiDevicesList();state.midiConnected=true;
state.midiInputs.forEach(input=>{input.onmidimessage=handleMidiMessage})}
else{document.getElementById('midiStatusText').textContent='No MIDI devices found'}}
catch(e){document.getElementById('midiStatusText').textContent='MIDI not supported';console.error(e)}}

function updateMidiDevicesList(){const c=document.getElementById('midiDevices');
let h='';state.midiInputs.forEach((d,i)=>{h+=`<div class="midi-device" onclick="selectMidiInput(${i})"><span>üéπ ${d.name||'Unknown Input'}</span><span style="color:var(--success)">Input</span></div>`});
state.midiOutputs.forEach((d,i)=>{h+=`<div class="midi-device" onclick="selectMidiOutput(${i})"><span>üîä ${d.name||'Unknown Output'}</span><span style="color:var(--info)">Output</span></div>`});
c.innerHTML=h||'<div style="text-align:center;color:var(--text-secondary);padding:1rem">No devices found</div>'}

function handleMidiMessage(m){const[cmd,note,vel]=m.data;
if(cmd===144&&vel>0){const n=NOTES[note%12];const o=Math.floor(note/12)-1;playMidiNote(n+o)}
if(cmd===128||(cmd===144&&vel===0)){const k=document.querySelector('.midi-key.pressed');if(k)k.classList.remove('pressed')}}

function toggleMidiInput(){haptic('light');if(!state.midiConnected)scanMidiDevices();document.getElementById('midiBtn').classList.toggle('active',state.midiConnected)}
function setMidiExportType(t){haptic('light');state.midiExportType=t;document.querySelectorAll('#midiPanel .effect-card').forEach(c=>c.classList.remove('active'));event.target.closest('.effect-card').classList.add('active')}

function exportMIDIFile(){haptic('medium');
const s=state.song.sections[state.song.activeSection];if(!s.chords.length){showToast('Generate chords first!');return}
const midi=generateMIDIData();const blob=new Blob([midi],{type:'audio/midi'});
const url=URL.createObjectURL(blob);const a=document.createElement('a');
a.href=url;a.download='chordflow-progression.mid';a.click();
closeModal('exportModal');showToast('üéπ MIDI exported!')}

function generateMIDIData(){
const header=[0x4D,0x54,0x68,0x64,0,0,0,6,0,1,0,2,0,96];
const s=state.song.sections[state.song.activeSection];
let trackData=[0x4D,0x54,0x72,0x6B];
let events=[];events.push(0,0xFF,0x03,8,...'ChordFlow'.split('').map(c=>c.charCodeAt(0)));
const ticksPerBeat=96;const ticksPerChord=ticksPerBeat*2;
s.chords.forEach((ch,i)=>{const delta=i===0?0:ticksPerChord;
ch.notes.forEach((n,j)=>{const noteNum=noteToMidi(n);events.push(j===0?delta:0,0x90,noteNum,100)});
ch.notes.forEach((n,j)=>{const noteNum=noteToMidi(n);events.push(j===0?ticksPerChord:0,0x80,noteNum,0)})});
events.push(0,0xFF,0x2F,0);
const len=events.length;trackData.push((len>>24)&0xFF,(len>>16)&0xFF,(len>>8)&0xFF,len&0xFF,...events);
return new Uint8Array([...header,...trackData])}

function noteToMidi(n){const note=n.replace(/\d/,'');const oct=parseInt(n.match(/\d/)[0]);return NOTES.indexOf(note)+12*(oct+1)}
function handleMIDIImport(files){if(!files.length)return;showToast('üì• MIDI import coming soon!')}
function copyMIDIToClipboard(){const s=state.song.sections[state.song.activeSection];const data=JSON.stringify(s.chords.map(c=>({symbol:c.symbol,notes:c.notes})));navigator.clipboard?.writeText(data);showToast('üìã MIDI data copied!')}
function exportFullMIDI(){haptic('medium');exportMIDIFile()}
function recordMIDI(){haptic('light');document.getElementById('recordBtn').classList.toggle('active');showToast('‚è∫Ô∏è Recording coming soon!')}

// Collaboration Functions
function generateRoomCode(){return Array.from({length:4},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('')}
function createCollabRoom(){haptic('medium');state.collabRoom=generateRoomCode();state.collabUsers=[{name:'You',color:'#ff6b35'}];
document.getElementById('collabRoomCode').textContent=state.collabRoom;updateCollabUsers();addCollabActivity('You created the room');showToast('üë• Room created!')}
function joinCollabRoom(){const code=document.getElementById('joinRoomInput').value.toUpperCase();if(code.length!==4){showToast('Enter 4-character code');return}
haptic('medium');state.collabRoom=code;state.collabUsers=[{name:'You',color:'#ff6b35'},{name:'Host',color:'#8b5cf6'}];
document.getElementById('collabRoomCode').textContent=code;updateCollabUsers();closeModal('joinRoomModal');addCollabActivity('You joined the room');showToast('üîó Joined room!')}
function copyRoomCode(){if(!state.collabRoom){showToast('Create a room first');return}navigator.clipboard?.writeText(state.collabRoom);showToast('üìã Room code copied!')}
function updateCollabUsers(){const c=document.getElementById('collabUsers');c.innerHTML=state.collabUsers.map(u=>`<div class="collab-user" style="background:${u.color}">${u.name[0]}</div>`).join('')}
function addCollabActivity(msg){const c=document.getElementById('collabActivity');const time=new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
c.innerHTML=`<div class="activity-item"><div class="activity-dot" style="background:var(--success)"></div><span>${msg}</span><span style="margin-left:auto;color:var(--text-secondary)">${time}</span></div>`+c.innerHTML}
function sendChatMessage(){const input=document.getElementById('chatInput');const msg=input.value.trim();if(!msg)return;
const chat=document.getElementById('collabChat');chat.innerHTML+=`<div style="margin-bottom:.5rem"><span style="color:var(--accent-primary);font-weight:600">You:</span> ${msg}</div>`;
input.value='';chat.scrollTop=chat.scrollHeight;haptic('light')}

// Share Functions
function shareNative(){if(navigator.share){navigator.share({title:'ChordFlow Progression',text:`Check out my chord progression in ${state.key} ${state.scale}: ${state.song.sections[state.song.activeSection].chords.map(c=>c.symbol).join(' - ')}`,url:window.location.href})}else{shareLink()}}
function shareToTwitter(){const text=encodeURIComponent(`üéµ Just created a ${state.genre} chord progression: ${state.song.sections[state.song.activeSection].chords.map(c=>c.symbol).join(' - ')} #ChordFlow #Music`);window.open(`https://twitter.com/intent/tweet?text=${text}`,'_blank')}
function shareToFacebook(){window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`,'_blank')}
function shareToWhatsApp(){const text=encodeURIComponent(`üéµ Check out my chord progression: ${state.song.sections[state.song.activeSection].chords.map(c=>c.symbol).join(' - ')}`);window.open(`https://wa.me/?text=${text}`,'_blank')}
function shareLink(){const d=btoa(JSON.stringify({key:state.key,scale:state.scale,genre:state.genre,chords:state.song.sections[0].chords.map(c=>c.symbol)}));const u=window.location.origin+'?s='+d;navigator.clipboard?.writeText(u);showToast('üîó Link copied!')}

// Theme Functions
function toggleTheme(){const themes=['dark','light','sunset','ocean','forest'];const i=(themes.indexOf(state.currentTheme)+1)%themes.length;setTheme(themes[i])}
function setTheme(t){haptic('light');state.currentTheme=t;document.documentElement.setAttribute('data-theme',t);document.querySelectorAll('.theme-preset').forEach(p=>p.classList.remove('active'));document.querySelector(`.theme-preset-${t}`)?.classList.add('active');showToast(`üé® ${t.charAt(0).toUpperCase()+t.slice(1)} theme`)}
function setCustomAccent(color){document.documentElement.style.setProperty('--accent-primary',color);showToast('üé® Accent updated')}

// AI Functions
function quickSoundLike(a){document.getElementById('soundLikeInput').value=a;applySoundLike()}
async function applySoundLike(){const a=document.getElementById('soundLikeInput').value.toLowerCase().trim();if(!a){showToast('Enter an artist name');return}
haptic('medium');showAILoading('Analyzing '+a+' style...');await new Promise(r=>setTimeout(r,1500));
const p=ARTIST_PROFILES[a]||{scale:Math.random()>0.5?'major':'minor',genre:Object.keys(GENRE_PROGRESSIONS)[Math.floor(Math.random()*Object.keys(GENRE_PROGRESSIONS).length)],tempo:80+Math.floor(Math.random()*60)};
state.scale=p.scale;state.genre=p.genre;state.tempo=p.tempo;
document.getElementById('scaleSelect').value=p.scale;document.getElementById('tempoSlider').value=p.tempo;document.getElementById('tempoValue').textContent=p.tempo+' BPM';
generateProgression();hideAILoading();showToast(`‚ú® ${a} vibes applied!`)}
function showAILoading(t){document.getElementById('aiLoading').style.display='block';document.getElementById('aiLoadingText').textContent=t}
function hideAILoading(){document.getElementById('aiLoading').style.display='none'}

async function aiContinueProgression(){haptic('medium');showAILoading('AI analyzing progression...');await new Promise(r=>setTimeout(r,1500));
const s=state.song.sections[state.song.activeSection];if(!s.chords.length){generateProgression();hideAILoading();return}
const last=s.chords[s.chords.length-1].degree;const next=(last+4)%7;s.chords.push(generateChord(next));
updateAllDisplays();hideAILoading();showToast('ü§ñ AI added chord!')}

async function generateMelody(){haptic('medium');showAILoading('Creating melody...');await new Promise(r=>setTimeout(r,2000));
const sn=SCALES[state.scale].map(i=>NOTES[(NOTES.indexOf(state.key)+i)%12]);state.generatedMelody=[];
for(let i=0;i<16;i++){const n=sn[Math.floor(Math.random()*sn.length)];const o=Math.random()>0.3?'4':'5';state.generatedMelody.push(n+o)}
const c=document.getElementById('melodyNotes');c.innerHTML=state.generatedMelody.map((n,i)=>`<div class="melody-note" onclick="playMelodyNote(${i})">${n.replace(/\d/,'')}</div>`).join('');
document.getElementById('melodySection').style.display='block';hideAILoading();showToast('üé§ Melody generated!')}
async function playMelodyNote(i){await Tone.start();initAudio();state.synth.triggerAttackRelease(state.generatedMelody[i],'8n');haptic('light')}
async function playMelody(){await Tone.start();initAudio();haptic('medium');
const bd=(60/state.tempo/2)*1000;for(let i=0;i<state.generatedMelody.length;i++){setTimeout(()=>{state.synth.triggerAttackRelease(state.generatedMelody[i],'8n');document.querySelectorAll('.melody-note')[i]?.classList.add('playing');setTimeout(()=>document.querySelectorAll('.melody-note')[i]?.classList.remove('playing'),bd-50)},i*bd)}}
async function generateBassLine(){haptic('medium');showAILoading('Creating bass line...');await new Promise(r=>setTimeout(r,1500));hideAILoading();showToast('üé∏ Bass line coming soon!')}
async function generateFullArrangement(){haptic('medium');showAILoading('Creating full arrangement...');await new Promise(r=>setTimeout(r,3000));generateFullSong();hideAILoading();showToast('üé¨ Full arrangement created!')}
async function generateLyrics(){haptic('medium');showAILoading('Writing lyrics...');await new Promise(r=>setTimeout(r,2000));
const s=state.song.sections[state.song.activeSection];const t=['love','dreams','freedom','night','journey','hope'][Math.floor(Math.random()*6)];
const l=[{chord:s.chords[0]?.symbol||'C',text:`In the ${t} of the night, I see your light`},{chord:s.chords[1]?.symbol||'Am',text:'Shadows dancing, hearts are racing'},{chord:s.chords[2]?.symbol||'F',text:`Chasing ${t}s that we found`},{chord:s.chords[3]?.symbol||'G',text:'Never letting our feet touch the ground'}];
const c=document.getElementById('lyricsDisplay');c.innerHTML=l.map(x=>`<div class="lyrics-line"><span class="lyrics-chord">[${x.chord}]</span><span class="lyrics-text">${x.text}</span></div>`).join('');
document.getElementById('lyricsSection').style.display='block';hideAILoading();showToast('üìù Lyrics generated!')}
function regenerateLyrics(){generateLyrics()}

// Sound Functions
function setWaveType(t){haptic('light');state.waveType=t;document.querySelectorAll('.wave-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');if(state.synth)state.synth.set({oscillator:{type:t}});showToast(`üîä ${t} wave`)}
function toggleEffect(e){haptic('light');state.effectsEnabled[e]=!state.effectsEnabled[e];event.target.closest('.effect-card').classList.toggle('active',state.effectsEnabled[e])}
function updateEffect(e,v){if(!state.effects[e])return;const n=v/100;if(e==='reverb'&&state.effects.reverb)state.effects.reverb.wet.value=n;if(e==='delay'&&state.effects.delay)state.effects.delay.wet.value=n}
function resetSynth(){haptic('light');state.waveType='sine';document.querySelectorAll('.wave-btn').forEach(b=>b.classList.remove('active'));document.querySelector('.wave-btn').classList.add('active');showToast('üîÑ Synth reset')}

// Analytics Functions
function trackAnalytics(type,value){
if(type==='key'){state.analytics.keys[value]=(state.analytics.keys[value]||0)+1}
if(type==='genre'){state.analytics.genres[value]=(state.analytics.genres[value]||0)+1}
if(type==='chords'){state.analytics.chords+=value;state.analytics.songs++}
updateAnalyticsDisplay()}

function updateAnalyticsDisplay(){
document.getElementById('totalSongs').textContent=state.analytics.songs;
document.getElementById('totalChords').textContent=state.analytics.chords;
const topKey=Object.entries(state.analytics.keys).sort((a,b)=>b[1]-a[1])[0];
const topGenre=Object.entries(state.analytics.genres).sort((a,b)=>b[1]-a[1])[0];
document.getElementById('favoriteKey').textContent=topKey?topKey[0]:'C';
document.getElementById('favoriteGenre').textContent=topGenre?topGenre[0].charAt(0).toUpperCase()+topGenre[0].slice(1):'Pop';
updateChordUsageChart()}

function updateChordUsageChart(){const c=document.getElementById('chordUsageChart');
const chordCounts={I:0,ii:0,iii:0,IV:0,V:0,vi:0};
state.song.sections.forEach(s=>{s.chords.forEach(ch=>{const n=ch.numeral.replace('¬∞','');if(chordCounts[n]!==undefined)chordCounts[n]++})});
const max=Math.max(...Object.values(chordCounts),1);
c.innerHTML=Object.entries(chordCounts).map(([k,v])=>`<div style="display:flex;flex-direction:column;align-items:center;flex:1"><div class="chart-bar" style="height:${(v/max)*80}px"></div><div style="font-size:.7rem;margin-top:.25rem;color:var(--text-secondary)">${k}</div></div>`).join('')}

// Export Functions
function exportPDF(){haptic('medium');const{jsPDF}=window.jspdf;const d=new jsPDF();
d.setFontSize(24);d.text('ChordFlow Pro',20,20);d.setFontSize(12);
d.text(`Key: ${state.key} ${state.scale}`,20,35);d.text(`Genre: ${state.genre}`,20,45);d.text(`Tempo: ${state.tempo} BPM`,20,55);
let y=75;state.song.sections.forEach(s=>{d.setFontSize(14);d.text(s.type.toUpperCase(),20,y);y+=10;d.setFontSize(12);d.text(s.chords.map(c=>c.symbol).join(' - ')||'(no chords)',20,y);y+=15});
d.save('chordflow-song.pdf');closeModal('exportModal');showToast('üìÑ PDF exported!')}
function exportJSON(){haptic('medium');const d=JSON.stringify(state,null,2);const b=new Blob([d],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='chordflow-project.json';a.click();closeModal('exportModal');showToast('üíæ Project saved!')}
function toggleSidebar(){haptic('light');showToast('Menu coming soon!')}

// Initialize
document.addEventListener('DOMContentLoaded',()=>{
const p=new URLSearchParams(window.location.search);
if(p.get('s')){try{const d=JSON.parse(atob(p.get('s')));state.key=d.key||'C';state.scale=d.scale||'major';state.genre=d.genre||'pop'}catch(e){}}
updateAllDisplays();updateMidiKeyboard();updateAnalyticsDisplay();
if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{})});

let touchStartY=0;
document.getElementById('bottomDrawer').addEventListener('touchstart',e=>{touchStartY=e.touches[0].clientY});
document.getElementById('bottomDrawer').addEventListener('touchmove',e=>{const diff=touchStartY-e.touches[0].clientY;if(diff>50&&!state.drawerOpen)toggleDrawer();if(diff<-50&&state.drawerOpen)toggleDrawer()});
</script>
</body>
</html>
